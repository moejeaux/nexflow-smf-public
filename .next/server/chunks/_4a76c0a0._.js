module.exports=[62604,e=>{"use strict";var t=e.i(66680);let a=t.default.webcrypto?.subtle||{},r=e=>t.default.webcrypto.getRandomValues(e);e.s(["getRandomValues",()=>r,"subtle",()=>a])},87545,46747,e=>{"use strict";var t=e.i(28066),a=e.i(20230),r=e.i(2409),s=e.i(17081);async function o(e){let{domain:t,message:a,primaryType:o,signature:n,types:i}=e;return(0,s.recoverAddress)({hash:(0,r.hashTypedData)({domain:t,message:a,primaryType:o,types:i}),signature:n})}async function n(e){let{address:r,domain:s,message:n,primaryType:i,signature:c,types:l}=e;return(0,a.isAddressEqual)((0,t.getAddress)(r),await o({domain:s,message:n,primaryType:i,signature:c,types:l}))}e.s(["recoverTypedDataAddress",()=>o],46747),e.s(["verifyTypedData",()=>n],87545)},60827,e=>e.a(async(t,a)=>{try{var r=e.i(24924),s=e.i(50377),o=t([r]);[r]=o.then?(await o)():o;let f=(0,s.createLogger)({component:"SMFDatabase"});async function n(e){let t=(0,r.getDb)(),a=crypto.randomUUID(),s=new Date().toISOString();return"pool"in t||"function"==typeof t.pool?.query?(await t.pool.query(`INSERT INTO routes (
        id, request_id, correlation_id, client_id, agent_id, network, token, amount,
        selected_facilitator_id, status, created_at, updated_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12)
      RETURNING *`,[a,e.request_id,e.correlation_id,e.client_id,e.agent_id,e.network,e.token,e.amount,e.selected_facilitator_id,e.status,s,s])).rows[0]:(t.prepare(`
      INSERT INTO routes (
        id, request_id, correlation_id, client_id, agent_id, network, token, amount,
        selected_facilitator_id, status, created_at, updated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(a,e.request_id,e.correlation_id,e.client_id,e.agent_id,e.network,e.token,e.amount,e.selected_facilitator_id,e.status,s,s),{id:a,...e,created_at:s,updated_at:s,completed_at:null})}async function i(e,t,a){let s=(0,r.getDb)(),o=new Date().toISOString();"pool"in s||"function"==typeof s.pool?.query?await s.pool.query("UPDATE routes SET status = $1, updated_at = $2, completed_at = $3 WHERE id = $4",[t,o,a||null,e]):s.prepare("UPDATE routes SET status = ?, updated_at = ?, completed_at = ? WHERE id = ?").run(t,o,a||null,e)}async function c(e){let t=(0,r.getDb)(),a=crypto.randomUUID(),s=new Date().toISOString();return"pool"in t||"function"==typeof t.pool?.query?(await t.pool.query(`INSERT INTO route_attempts (
        id, route_id, facilitator_id, phase, result, latency_ms, error_code, raw_status, is_probe, created_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)
      RETURNING *`,[a,e.route_id,e.facilitator_id,e.phase,e.result,e.latency_ms,e.error_code,e.raw_status,e.is_probe??!1,s])).rows[0]:(t.prepare(`
      INSERT INTO route_attempts (
        id, route_id, facilitator_id, phase, result, latency_ms, error_code, raw_status, is_probe, created_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(a,e.route_id,e.facilitator_id,e.phase,e.result,e.latency_ms,e.error_code,e.raw_status,e.is_probe??!1,s),{id:a,...e,created_at:s})}async function l(e,t,a){let s=(0,r.getDb)(),o="pool"in s||"function"==typeof s.pool?.query,n="SELECT * FROM facilitator_capabilities WHERE 1=1",i=[],c=1;return(e&&(o?n+=` AND facilitator_id = $${c++}`:n+=" AND facilitator_id = ?",i.push(e)),t&&(o?n+=` AND network = $${c++}`:n+=" AND network = ?",i.push(t)),a&&(o?n+=` AND token = $${c++}`:n+=" AND token = ?",i.push(a)),o)?(await s.pool.query(n,i)).rows:s.prepare(n).all(...i)}async function d(e,t,a){let s=(0,r.getDb)();return"pool"in s||"function"==typeof s.pool?.query?(await s.pool.query(`SELECT * FROM facilitator_health_snapshots
       WHERE facilitator_id = $1 AND network = $2 AND token = $3
       ORDER BY window_end DESC
       LIMIT 1`,[e,t,a])).rows[0]||null:s.prepare(`SELECT * FROM facilitator_health_snapshots
       WHERE facilitator_id = ? AND network = ? AND token = ?
       ORDER BY window_end DESC
       LIMIT 1`).get(e,t,a)||null}async function u(e,t,a,s,o,n=!0){let i=(0,r.getDb)(),c="pool"in i||"function"==typeof i.pool?.query,l=`probe-${e}-${t}-${a}%`;return c?(await i.pool.query(`SELECT ra.* FROM route_attempts ra
       LEFT JOIN routes r ON (ra.route_id::text = r.id::text AND ra.is_probe = false)
       WHERE ra.facilitator_id = $1
         AND (
           (ra.is_probe = true AND ra.route_id::text LIKE $2)
           OR (ra.is_probe = false AND r.network = $3 AND r.token = $4)
         )
         AND ra.created_at >= $5
         AND ra.created_at < $6
       ORDER BY ra.created_at`,[e,l,t,a,s,o])).rows:i.prepare(`SELECT ra.* FROM route_attempts ra
       LEFT JOIN routes r ON (ra.route_id = r.id AND ra.is_probe = 0)
       WHERE ra.facilitator_id = ?
         AND (
           (ra.is_probe = 1 AND ra.route_id LIKE ?)
           OR (ra.is_probe = 0 AND r.network = ? AND r.token = ?)
         )
         AND ra.created_at >= ?
         AND ra.created_at < ?
       ORDER BY ra.created_at`).all(e,l,t,a,s,o)}async function p(e){let t=(0,r.getDb)(),a=crypto.randomUUID(),s=new Date().toISOString();return"pool"in t||"function"==typeof t.pool?.query?(await t.pool.query(`INSERT INTO facilitator_health_snapshots (
        id, facilitator_id, network, token, window_start, window_end,
        success_rate, p50_latency_ms, p95_latency_ms, p99_latency_ms,
        error_rate, last_error_type, status, created_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14)
      ON CONFLICT (facilitator_id, network, token, window_end)
      DO UPDATE SET
        success_rate = EXCLUDED.success_rate,
        p50_latency_ms = EXCLUDED.p50_latency_ms,
        p95_latency_ms = EXCLUDED.p95_latency_ms,
        p99_latency_ms = EXCLUDED.p99_latency_ms,
        error_rate = EXCLUDED.error_rate,
        last_error_type = EXCLUDED.last_error_type,
        status = EXCLUDED.status
      RETURNING *`,[a,e.facilitator_id,e.network,e.token,e.window_start,e.window_end,e.success_rate,e.p50_latency_ms,e.p95_latency_ms,e.p99_latency_ms,e.error_rate,e.last_error_type,e.status,s])).rows[0]:(t.prepare(`
      INSERT INTO facilitator_health_snapshots (
        id, facilitator_id, network, token, window_start, window_end,
        success_rate, p50_latency_ms, p95_latency_ms, p99_latency_ms,
        error_rate, last_error_type, status, created_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(a,e.facilitator_id,e.network,e.token,e.window_start,e.window_end,e.success_rate,e.p50_latency_ms,e.p95_latency_ms,e.p99_latency_ms,e.error_rate,e.last_error_type,e.status,s),{id:a,...e,created_at:s})}async function _(e){let t=(0,r.getDb)();"pool"in t||"function"==typeof t.pool?.query?await t.pool.query(`INSERT INTO facilitator_probe_events (
        probe_config_id, facilitator_id, network, token, result,
        error_code, facilitator_status, facilitator_error_code, latency_ms
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)`,[e.probe_config_id,e.facilitator_id,e.network,e.token,e.result,e.error_code,e.facilitator_status,e.facilitator_error_code,e.latency_ms]):f.warn("facilitator_probe_events table not available in SQLite")}e.s(["createRoute",()=>n,"createRouteAttempt",()=>c,"getFacilitatorCapabilities",()=>l,"getLatestHealthSnapshot",()=>d,"getRouteAttemptsForHealth",()=>u,"recordFacilitatorProbeEvent",()=>_,"updateRouteStatus",()=>i,"upsertHealthSnapshot",()=>p]),a()}catch(e){a(e)}},!1),22444,e=>{"use strict";let t=(0,e.i(50377).createLogger)({component:"BaseFacilitator"});class a{getLogger(){return t.child({facilitator:this.constructor.name})}async getPricing(e,t){return null}supports(e,t,a,r){return!!this.config.enabled&&!!this.config.schemes.includes(a)&&(!r||!this.config.settlementModes||!!this.config.settlementModes.includes(r))&&!!(this.config.networks.includes(e)||this.config.networksCAIP&&this.config.networksCAIP.includes(e))&&(this.config.assets.includes(t)||this.config.assetsCAIP&&this.config.assetsCAIP.includes(t))}supportsCAIPNetwork(e){return!!this.config.enabled&&(this.config.networksCAIP?.includes(e)||!1)}supportsCAIPAsset(e){return!!this.config.enabled&&(this.config.assetsCAIP?.includes(e)||!1)}validateRequirements(e){if(!(e.network||e.networks&&e.networks.length>0))return{valid:!1,error:"Network is required"};if(!(e.asset||e.assets&&e.assets.length>0))return{valid:!1,error:"Asset is required"};if(!e.payTo)return{valid:!1,error:"Recipient address (payTo) is required"};if(!e.maxAmountRequired)return{valid:!1,error:"Amount is required"};let t=e.network||e.networks?.[0]||"",a=e.asset||e.assets?.[0]||"";return e.networks&&e.networks.length>0&&!e.networks.some(e=>this.supportsCAIPNetwork(e)||this.config.networks.includes(e))?{valid:!1,error:`Facilitator ${this.id} does not support any of the requested networks: ${e.networks.join(", ")}`}:e.assets&&e.assets.length>0&&!e.assets.some(e=>this.supportsCAIPAsset(e)||this.config.assets.includes(e))?{valid:!1,error:`Facilitator ${this.id} does not support any of the requested assets: ${e.assets.join(", ")}`}:this.supports(t,a,e.scheme,e.settlementMode)?{valid:!0}:{valid:!1,error:`Facilitator ${this.id} does not support ${t}/${a}/${e.scheme}`}}}e.s(["BaseFacilitator",()=>a])},41500,e=>e.a(async(t,a)=>{try{var r=e.i(50377),s=e.i(87768),o=e.i(3004),n=t([s,o]);[s,o]=n.then?(await n)():n;let u=(0,r.createLogger)({component:"FacilitatorMetricsReader"}),p={maxDataAgeHours:parseFloat(process.env.METRICS_MAX_AGE_HOURS??"4"),minInvocationsHighConfidence:parseInt(process.env.METRICS_MIN_INVOCATIONS_HIGH??"1000",10),minInvocationsMinimum:parseInt(process.env.METRICS_MIN_INVOCATIONS??"100",10),lowConfidencePenalty:parseFloat(process.env.METRICS_LOW_CONFIDENCE_PENALTY??"0.5")},_=parseFloat(process.env.SCATTERING_SCORE_WEIGHT??"0.2"),f=parseInt(process.env.SCATTERING_MIN_TX_COUNT??"100",10),m=parseFloat(process.env.SCATTERING_MIN_VOLUME??"100"),h=1-_;async function i(e){let t=e.timeframe??"1d",a=[];try{let r,n,i,c,l,d,p=await (0,s.getSummary)(e.facilitatorId,t),y=50,w=0,$=1/0,g=0,E=!1;if(p){E=!0;let e=50*(w=1-p.overallErrorRate);a.push(`success-rate:${(100*w).toFixed(1)}%`);let t=30,s=p.avgP90LatencyMs??p.avgP99LatencyMs;if(void 0!==s){let e=Math.min(s,2e3)/2e3;t=(1-e)*30,a.push(`p95-latency:${s.toFixed(0)}ms`),n=p.avgP90LatencyMs}else t=15,a.push("latency:unknown");let o=Math.min(p.totalInvocations/1e3,1);g=p.totalInvocations,a.push(`x402scan:${p.totalInvocations}/${p.totalInvocations>=1e3?"high":p.totalInvocations>=100?"medium":"low"}-confidence`);let i=new Date(p.fetchedAt);$=(Date.now()-i.getTime())/36e5;let c=Math.max(0,1-$/24);y=e+t+10*o+10*c,r=p.avgP50LatencyMs}else a.push("x402scan:no-data");let I=0,D=!1,A=!1;try{let t=await (0,o.getScatteringMetricsForFacilitator)(e.facilitatorId);t?(A=!0,i=t.volumeUsd3d,c=t.txCount3d,l=t.uniqueBuyers3d,t.txCount3d<f&&t.volumeUsd3d<m?(D=!0,I=.1,a.push(`scattering-low-activity:${t.txCount3d}tx/$${t.volumeUsd3d.toFixed(0)}`)):(I=(0,o.computeActivityScore)(t),a.push(`scattering-activity:${I.toFixed(2)}`))):a.push("scattering:no-data")}catch(t){u.debug({error:t instanceof Error?t.message:"Unknown",facilitatorId:e.facilitatorId,msg:"Failed to fetch Scattering metrics for scoring"}),a.push("scattering:error")}d=E&&A?h*y+_*I*100:E?y:A?100*I:50;let N="none";return E?N=g>=1e3&&$<6?"high":g>=100&&$<24?"medium":"low":A&&!D&&(N=I>.5?"medium":"low"),{facilitatorId:e.facilitatorId,score:Math.round(d),successRate:w,avgLatencyMs:r,p95LatencyMs:n,totalInvocations:g,dataFreshness:$,confidence:N,reasons:a,scatteringActivityScore:A?I:void 0,scatteringVolume3d:i,scatteringTxCount3d:c,scatteringUniqueBuyers3d:l,scatteringLowActivity:D||void 0}}catch(t){return u.error({error:t instanceof Error?t.message:"Unknown error",facilitatorId:e.facilitatorId,msg:"Failed to get facilitator score"}),null}}async function c(e,t="1d",a=p){let r=[],s=[];for(let o of e){let e=await i({facilitatorId:o,timeframe:t});if(!e){s.push({id:o,reason:"no-data"});continue}let n=function(e,t,a=p){return e>a.maxDataAgeHours?{trust:!1,confidence:"none",reason:`data-stale:${e.toFixed(1)}h-old`}:t<a.minInvocationsMinimum?{trust:!1,confidence:"none",reason:`insufficient-data:${t}-invocations`}:t>=a.minInvocationsHighConfidence?{trust:!0,confidence:"high",reason:`high-confidence:${t}-invocations`}:{trust:!0,confidence:"medium",reason:`medium-confidence:${t}-invocations`}}(e.dataFreshness,e.totalInvocations,a);if(!n.trust){s.push({id:o,reason:n.reason}),r.push({...e,score:e.score*a.lowConfidencePenalty,confidence:"low",reasons:[...e.reasons,`untrusted:${n.reason}`]});continue}"medium"===n.confidence?r.push({...e,score:.9*e.score,confidence:"medium",reasons:[...e.reasons,n.reason]}):r.push({...e,reasons:[...e.reasons,n.reason]})}return s.length>0&&u.debug({untrusted:s,trusted:r.filter(e=>"low"!==e.confidence).map(e=>e.facilitatorId),msg:"Facilitator metrics trust check results"}),r.sort((e,t)=>t.score-e.score),{rankings:r,timestamp:new Date().toISOString(),timeframe:t}}async function l(e,t){let a,r=t?.timeframe??"1d",s=t?.trustConfig??p,o=await c(e,r,s),n=o.rankings.filter(e=>"low"!==e.confidence);if(0===n.length)return u.warn({candidates:e,rankings:o.rankings.map(e=>({id:e.facilitatorId,confidence:e.confidence,reasons:e.reasons})),msg:"No trusted x402scan data available, using fallback"}),{recommended:e[0]??null,ranking:o,reason:"No trusted x402scan data (stale or insufficient), using default order",usedFallback:!0};switch(t?.prioritize??"balanced"){case"latency":a=n.filter(e=>void 0!==e.p95LatencyMs).sort((e,t)=>(e.p95LatencyMs??1/0)-(t.p95LatencyMs??1/0))[0]??n[0];break;case"reliability":a=[...n].sort((e,t)=>t.successRate-e.successRate)[0];break;default:a=n[0]}return{recommended:a.facilitatorId,ranking:o,reason:`Selected ${a.facilitatorId} with score ${a.score} (${a.confidence} confidence, ${a.reasons.slice(0,3).join(", ")})`,usedFallback:!1}}async function d(e,t){let a=t?.timeframe??"1d",r=t?.wasSelected??!1,s=await i({facilitatorId:e,timeframe:a});if(!s)return{facilitatorId:e,selected:r,score:50,confidence:"low",shortReason:`${e}: no x402scan data available`,detailedReasons:["No observability data from x402scan"],metrics:{}};let o=(100*s.successRate).toFixed(1),n=s.p95LatencyMs?`${s.p95LatencyMs.toFixed(0)}ms p95`:"latency unknown",c=s.totalInvocations>=1e3?`${(s.totalInvocations/1e3).toFixed(1)}K invocations`:`${s.totalInvocations} invocations`,l=`${e}: ${o}% success, ${n}, ${s.confidence} confidence (${c})`,d=[];return s.successRate>=.99?d.push(`Excellent success rate: ${o}%`):s.successRate>=.95?d.push(`Good success rate: ${o}%`):s.successRate>=.9?d.push(`Acceptable success rate: ${o}%`):d.push(`⚠️ Low success rate: ${o}%`),void 0!==s.p95LatencyMs&&(s.p95LatencyMs<200?d.push(`Fast response times: ${s.p95LatencyMs.toFixed(0)}ms p95`):s.p95LatencyMs<500?d.push(`Moderate latency: ${s.p95LatencyMs.toFixed(0)}ms p95`):d.push(`⚠️ High latency: ${s.p95LatencyMs.toFixed(0)}ms p95`)),"high"===s.confidence?d.push(`High confidence: ${c}, data ${s.dataFreshness.toFixed(1)}h old`):"medium"===s.confidence?d.push(`Medium confidence: ${c}`):d.push(`Low confidence: limited data (${c})`),s.dataFreshness>12&&d.push(`⚠️ Data is ${s.dataFreshness.toFixed(1)} hours old`),{facilitatorId:e,selected:r,score:s.score,confidence:s.confidence,shortReason:l,detailedReasons:d,metrics:{successRate:s.successRate,errorRate:1-s.successRate,p95LatencyMs:s.p95LatencyMs,invocations:s.totalInvocations,dataAgeHours:s.dataFreshness}}}e.s(["getFacilitatorExplainer",()=>d,"getFacilitatorScore",()=>i,"getRecommendedFacilitator",()=>l,"rankFacilitators",()=>c]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=_4a76c0a0._.js.map
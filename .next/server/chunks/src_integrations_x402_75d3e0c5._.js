module.exports=[92688,e=>{"use strict";function t(e,r=6){let a=parseFloat(e.trim());if(isNaN(a)||a<0)throw Error(`Invalid amount: ${e}`);return BigInt(Math.floor(a*Math.pow(10,r))).toString()}function r(e){if(e.includes(":"))return e;let t={base:"eip155:8453",ethereum:"eip155:1",polygon:"eip155:137",arbitrum:"eip155:42161",optimism:"eip155:10",avalanche:"eip155:43114",bnb:"eip155:56"}[e.toLowerCase()];return t||e}e.s(["normalizeNetwork",()=>r,"toAtomicUnits",()=>t])},56036,e=>{"use strict";var t,r=e.i(33298);class a{apiKeyId;apiKeySecret;constructor(e,t){this.apiKeyId=e,this.apiKeySecret=t}async generateToken(e=null,t=null,a=null){return await (0,r.generateJwt)({apiKeyId:this.apiKeyId,apiKeySecret:this.apiKeySecret,requestMethod:e||null,requestHost:t||null,requestPath:a||null,expiresIn:120})}isTokenValid(e){return!0}}let i=null;var o=e.i(87545);async function n(e,t,r,a=8453,i){try{return await (0,o.verifyTypedData)({address:r,domain:{name:"USD Coin",version:"2",chainId:a,verifyingContract:i||"0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"},types:{TransferWithAuthorization:[{name:"from",type:"address"},{name:"to",type:"address"},{name:"value",type:"uint256"},{name:"validAfter",type:"uint256"},{name:"validBefore",type:"uint256"},{name:"nonce",type:"bytes32"}]},primaryType:"TransferWithAuthorization",message:t,signature:e})}catch(e){return console.error("[SignatureVerifier] Verification error:",e),!1}}var s=e.i(50377),l=e.i(92688);(0,s.createLogger)({component:"CDPClient"}),(t={}).CDP_TIMEOUT="CDP_TIMEOUT",t.CDP_4XX="CDP_4XX",t.CDP_5XX="CDP_5XX",t.CDP_INVALID_RESPONSE="CDP_INVALID_RESPONSE",t.CDP_NETWORK_ERROR="CDP_NETWORK_ERROR",t.CDP_AUTH_ERROR="CDP_AUTH_ERROR",t.CDP_RATE_LIMIT="CDP_RATE_LIMIT",t.CDP_UNKNOWN_ERROR="CDP_UNKNOWN_ERROR";let u=(0,s.createLogger)({component:"CDPFacilitator"});class m{apiKeyId;facilitatorUrl;jwtGenerator;cachedToken=null;tokenExpiry=0;constructor(e,t="https://api.cdp.coinbase.com/platform/v2/x402"){this.apiKeyId=e,this.facilitatorUrl=t,this.jwtGenerator=function(){if(!i){let e=process.env.CDP_API_KEY_ID,t=process.env.CDP_API_KEY_SECRET;if(!e||!t)throw Error("CDP_API_KEY_ID and CDP_API_KEY_SECRET must be set");i=new a(e,t)}return i}()}async generateJWT(e=null,t=null){let r=Date.now();if(e&&t){let r=new URL(this.facilitatorUrl);return await this.jwtGenerator.generateToken(e,r.host,t)}if(this.cachedToken&&this.tokenExpiry>r+1e4)return this.cachedToken;let a=await this.jwtGenerator.generateToken(null,null,null);return this.cachedToken=a,this.tokenExpiry=r+12e4,a}async callCdpVerifyWithRetries(e,t,r){let a=new URL("https://api.cdp.coinbase.com/platform/v2/x402/verify"),i=[429,500,502,503,504],o=Date.now();for(let n=0;n<3;n++)try{let s=await fetch(a.toString(),{method:"POST",headers:r,body:JSON.stringify(e),signal:AbortSignal.timeout(1e4)}),l=await s.text(),m=l?JSON.parse(l):{},c=Date.now()-o;if(s.ok&&m.isValid)return{success:!0,valid:!0,status:s.status,isRateLimited:!1,isNetworkError:!1,latencyMs:c,data:m};let d=i.includes(s.status),p=429===s.status;if(!d||2===n){let e=m.errorMessage||m.error||m.invalidReason||`HTTP ${s.status}`,t=m.errorType||m.code||(p?"rate_limit":"CDP_VERIFY_FAILED");return{success:!1,valid:!1,status:s.status,errorType:t,errorMessage:e,isRateLimited:p,isNetworkError:!1,latencyMs:c,data:m}}let y=100*Math.pow(2,n);u.info({component:"CDPFacilitator",attempt:n+1,maxRetries:3,status:s.status,delay:y,isProbe:t,msg:"Retrying CDP verification after transient error"}),await new Promise(e=>setTimeout(e,y))}catch(i){let e=Date.now()-o,r=i?.name==="AbortError"||i?.message?.toLowerCase().includes("timeout"),a=i?.message?.toLowerCase().includes("network")||i?.message?.toLowerCase().includes("fetch")||i?.message?.toLowerCase().includes("econnrefused");if((r||a)&&n<2){let e=100*Math.pow(2,n);u.info({component:"CDPFacilitator",attempt:n+1,maxRetries:3,error:i?.message,delay:e,isProbe:t,msg:"Retrying CDP verification after network error"}),await new Promise(t=>setTimeout(t,e));continue}return{success:!1,valid:!1,status:0,errorType:r?"timeout":a?"network_error":"CDP_VERIFY_FAILED",errorMessage:i?.message||"CDP verification failed",isRateLimited:!1,isNetworkError:r||a,latencyMs:e}}return{success:!1,valid:!1,status:0,errorType:"CDP_VERIFY_FAILED",errorMessage:"Max retries exceeded",isRateLimited:!1,isNetworkError:!1,latencyMs:Date.now()-o}}async verifyPayment(t){Date.now();try{var r;let a,i,o,s,m,c,d,p,y,f;try{let{parseX402Header:r}=await e.A(5371),o=r(t.payment);if(o.valid&&o.parsed){let e=(i=o.parsed).network||t.paymentPayload.network,r=(0,l.normalizeNetwork)(e);a={x402Version:1,scheme:"x402",network:r,payload:{signature:i.signature,authorization:i.authorization}}}else a=t.paymentPayload}catch(e){u.warn({error:e},"Failed to parse payment header, using request.paymentPayload"),a=t.paymentPayload}let h=(r=a.payload.authorization,d=Math.floor(Date.now()/1e3),p=parseInt(r.validAfter),y=parseInt(r.validBefore),d<p?{valid:!1,error:"Payment not yet valid"}:d>=y?{valid:!1,error:"Payment has expired"}:r.from&&r.to?!r.value||BigInt(r.value)<=BigInt(0)?{valid:!1,error:"Invalid payment amount"}:r.nonce?{valid:!0}:{valid:!1,error:"Missing nonce"}:{valid:!1,error:"Missing from or to address"});if(!h.valid)return{success:!1,valid:!1,error:h.error||"Invalid payment authorization"};let P=a.payload.authorization,v=a.payload.signature,w="0x0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"===v||v==="0x"+"0".repeat(128)||"0x0000000000000000000000000000000000000000"===P.from;if(w)u.warn({component:"CDPFacilitator",isProbe:!0,msg:"Skipping local signature verification for probe payload"});else try{await n(v,P,P.from)||u.warn("Local signature verification failed, but continuing to CDP")}catch(e){u.warn({error:e},"Signature verification error, continuing to CDP")}let R=t.paymentRequirements;if(!R||!R.to&&!R?.payTo)if(!w)return u.error({hasPaymentRequirements:!!t.paymentRequirements,paymentRequirements:t.paymentRequirements,isProbe:!1},"Missing paymentRequirements"),{success:!1,valid:!1,error:"paymentRequirements must be provided for CDP verification"};else{u.info({component:"CDPFacilitator",isProbe:!0,msg:"Building minimal paymentRequirements for probe mode"});let e=(0,l.normalizeNetwork)(a.network||"eip155:8453"),t="0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913",r="0x0000000000000000000000000000000000000001",i=Math.floor(Date.now()/1e3);R={scheme:"exact",network:e,to:r,payTo:r,value:"1000000",maxAmountRequired:"1000000",resource:`https://probe.nexflow.dev/health/cdp/${e}/USDC`,asset:t,description:"Health probe for CDP",mimeType:"application/json",validAfter:i.toString(),validBefore:(i+300).toString(),maxTimeoutSeconds:300,extra:{name:"USD Coin",version:"2"}},u.info({component:"CDPFacilitator",isProbe:!0,hasPaymentRequirements:!0,network:e,asset:t,msg:"Built probe paymentRequirements"})}let g=(0,l.normalizeNetwork)(R?.network||a.network||"eip155:8453"),D={scheme:R?.scheme||"exact",network:g,to:R?.to||R?.payTo||P.to,value:R?.value||R?.maxAmountRequired||P.value,validAfter:R?.validAfter||P.validAfter,validBefore:R?.validBefore||P.validBefore,resource:R?.resource,asset:R?.asset,...R?.description&&{description:R.description},...R?.mimeType&&{mimeType:R.mimeType},...R?.maxTimeoutSeconds&&{maxTimeoutSeconds:R.maxTimeoutSeconds},...R?.extra&&{extra:R.extra}};if(!D.resource||!D.asset)if(!w)return u.error({hasResource:!!D.resource,hasAsset:!!D.asset,paymentRequirements:t.paymentRequirements,isProbe:!1},"Missing required paymentRequirements fields (resource or asset)"),{success:!1,valid:!1,error:"paymentRequirements must include resource and asset"};else{let e=(0,l.normalizeNetwork)(a.network||"eip155:8453");D.resource||(D.resource=`https://probe.nexflow.dev/health/cdp/${e}/USDC`),D.asset||(D.asset="0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"),D.network&&D.network.includes(":")||(D.network=e),u.info({component:"CDPFacilitator",isProbe:!0,msg:"Completed missing resource/asset fields for probe mode"})}try{let{parseX402Header:r}=await e.A(5371),a=r(t.payment);a.valid&&a.parsed?.txHash&&(o=a.parsed.txHash,u.debug({txHash:o},"Found transaction hash in payment header"))}catch(e){u.warn({error:e},"Failed to parse payment header for txHash")}let C=(0,l.normalizeNetwork)(a.network||D.network||"base"),T=String(P.value),x=parseFloat(T);x<1e3&&x>0?(s=(0,l.toAtomicUnits)(T,6),u.debug({original:T,converted:s},"Converted human amount to atomic units")):s=T;let k=D.value||D.maxAmountRequired||s,E=String(k),I=parseFloat(E);if(I<1e3&&I>0?(m=(0,l.toAtomicUnits)(E,6),u.debug({original:E,converted:m},"Converted maxAmountRequired to atomic units")):m=E,!/^[0-9]+$/.test(s)||!/^[0-9]+$/.test(m)){let e=Error("Amount fields must be digit-only strings in atomic units");throw u.error({authorizationValue:s,maxAmountRequired:m,authorizationValueType:typeof s,maxAmountRequiredType:typeof m},"Amount validation failed"),e}u.debug({network:C,authorizationValue:s,maxAmountRequired:m,payTo:D.to||D.payTo},"CDP verify request payload (amounts in atomic units)");let S={scheme:D.scheme||"exact",network:C,payTo:D.to||D.payTo||"",maxAmountRequired:m,resource:D.resource||"",asset:D.asset||"",description:D.description||"x402 Payment Verification",mimeType:D.mimeType||"application/json",maxTimeoutSeconds:D.maxTimeoutSeconds||300};D.validAfter&&(S.validAfter=D.validAfter),D.validBefore&&(S.validBefore=D.validBefore),D.outputSchema&&(S.outputSchema=D.outputSchema),D.extra&&(S.extra=D.extra);let b=t.payment;b.startsWith("x402 ")&&(b=b.slice(5));try{let e=Buffer.from(b,"base64").toString("utf-8");c=JSON.parse(e)}catch(e){return u.error({error:e},"Failed to parse payment header for CDP request"),{success:!1,valid:!1,error:"Invalid payment header format"}}let A={"eip155:8453":"base","eip155:84532":"base-sepolia","solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp":"solana","solana:EtWTRABZaYq6iMfeYKouRu166VU2xqa1":"solana-devnet"}[C]||C.replace("eip155:",""),q={x402Version:1,paymentPayload:{x402Version:1,scheme:"exact",network:A,payload:{signature:c.signature,authorization:c.authorization}},paymentRequirements:{scheme:S.scheme||"exact",network:A,maxAmountRequired:S.maxAmountRequired||S.amount,resource:S.resource,description:S.description||"x402 payment verification",mimeType:S.mimeType||"application/json",payTo:S.payTo||S.recipient,maxTimeoutSeconds:S.maxTimeoutSeconds||300,asset:S.asset,...S.extra&&{extra:S.extra}}};u.info({component:"CDPFacilitator",isProbe:w,network:S.network,asset:S.asset,hasPaymentHeader:"string"==typeof b&&b.length>0,paymentHeaderPreview:b.slice(0,60),msg:"Sending CDP /verify request"}),u.info({component:"CDPFacilitator",debug:!0,fullPaymentPayload:{x402Version:q.paymentPayload.x402Version,scheme:q.paymentPayload.scheme,network:q.paymentPayload.network,hasSignature:!!q.paymentPayload.payload.signature,signaturePreview:q.paymentPayload.payload.signature?.slice(0,20),authorization:q.paymentPayload.payload.authorization},fullPaymentRequirements:q.paymentRequirements,parsedPayloadKeys:Object.keys(c||{}),msg:"CDP verify request full payload"}),o&&u.debug({txHash:o},"Transaction hash is included in paymentHeader");let _=new URL("https://api.cdp.coinbase.com/platform/v2/x402/verify"),N=await this.generateJWT("POST",_.pathname);u.debug({url:_.toString(),x402Version:q.x402Version,paymentPayload:{x402Version:q.paymentPayload.x402Version,scheme:q.paymentPayload.scheme,network:q.paymentPayload.network,hasSignature:!!q.paymentPayload.payload.signature,hasAuthorization:!!q.paymentPayload.payload.authorization},paymentRequirements:q.paymentRequirements,isProbe:w},"Sending verification request to CDP");let L=t.requestId,M={"Content-Type":"application/json",Authorization:`Bearer ${N}`,"X-CDP-API-Key":this.apiKeyId};L&&Object.assign(M,(f=M instanceof Headers?Object.fromEntries(M.entries()):Array.isArray(M)?Object.fromEntries(M):M,L?{...f,"x-request-id":L}:f));let O=await this.callCdpVerifyWithRetries(q,w,M);if(u.debug({status:O.status,success:O.success,valid:O.valid,errorType:O.errorType,errorMessage:O.errorMessage,isRateLimited:O.isRateLimited,isNetworkError:O.isNetworkError,latencyMs:O.latencyMs},"CDP verification response"),O.success&&O.valid)return u.info({latencyMs:O.latencyMs},"Payment verified successfully"),{success:!0,valid:!0,transactionHash:void 0,kytStatus:"passed",ofacStatus:"passed"};{let e=O.errorType||"CDP_VERIFY_FAILED",t=O.errorMessage||"CDP verification failed",r="facilitator_error";O.isRateLimited||"rate_limit"===e?r="rate_limited":O.isNetworkError?r="network_error":"invalid_request"===e||400===O.status?r="invalid_request":401===O.status&&(r="unauthorized"),u.error({status:O.status,errorType:e,errorMessage:t,errorCode:r,isRateLimited:O.isRateLimited,isNetworkError:O.isNetworkError,cdpResponse:O.data,requestBody:{x402Version:q.x402Version,paymentPayload:{x402Version:q.paymentPayload.x402Version,scheme:q.paymentPayload.scheme,network:q.paymentPayload.network},paymentRequirements:q.paymentRequirements}},"Payment verification failed");let a="UNKNOWN",o="UNKNOWN",n="NOT PROVIDED";i&&(a=i.authorization.from,o=i.authorization.to,n=i.txHash||"NOT PROVIDED");let s={error:t,errorType:e,cdpResponse:O.data,httpStatus:O.status,errorCode:r,isRateLimited:O.isRateLimited,isNetworkError:O.isNetworkError,requestDetails:{scheme:q.paymentRequirements?.scheme||"MISSING",network:q.paymentRequirements?.network||"MISSING",payTo:q.paymentRequirements?.payTo||"MISSING",maxAmountRequired:q.paymentRequirements?.maxAmountRequired||"MISSING",validAfter:q.paymentRequirements?.validAfter||"MISSING",validBefore:q.paymentRequirements?.validBefore||"MISSING",resource:q.paymentRequirements?.resource||"MISSING",asset:q.paymentRequirements?.asset||"MISSING",fullPaymentRequirements:q.paymentRequirements,authorizationFrom:a,authorizationTo:o,transactionHash:n}};return{success:!1,valid:!1,error:t,errorDetails:{...s,errorType:e},kytStatus:void 0,ofacStatus:void 0}}}catch(i){let e=i?.message||"CDP_VERIFY_FAILED",r=i?.name==="AbortError"||e.toLowerCase().includes("timeout"),a=e.toLowerCase().includes("network")||e.toLowerCase().includes("fetch")||e.toLowerCase().includes("econnrefused");return u.error({error:i,errorMessage:e,isTimeout:r,isNetworkError:a,component:"cdp-facilitator",operation:"verifyPayment",requestId:t.requestId},"CDP API request error"),{success:!1,valid:!1,error:e,errorDetails:{error:e,cdpResponse:void 0,httpStatus:500,errorType:r?"timeout":a?"network":"unknown"}}}}async verifyPaymentWithRetry(e,t=3){let r=null;for(let a=0;a<t;a++){try{let t=await this.verifyPayment(e);if(t.success&&t.valid||t.error&&!t.error.includes("timeout")&&!t.error.includes("network")&&!t.error.includes("Unable to reach")||"blocked"===t.kytStatus||"blocked"===t.ofacStatus)return t;r=Error(t.error||"Verification failed")}catch(e){r=e instanceof Error?e:Error(String(e))}if(a<t-1){let e=100*Math.pow(2,a);u.info({attempt:a+1,maxRetries:t,delay:e},"Retrying CDP verification"),await new Promise(t=>setTimeout(t,e))}}return{success:!1,valid:!1,error:r?.message||"Max retries exceeded"}}async healthCheck(){try{let e=new URL(`${this.facilitatorUrl}/health`),t=await this.generateJWT("GET",e.pathname),r=await fetch(e.toString(),{method:"GET",headers:{Authorization:`Bearer ${t}`,"X-CDP-API-Key":this.apiKeyId},signal:AbortSignal.timeout(5e3)});if(r.ok)return{healthy:!0};{if(404===r.status)return{healthy:!0,error:"Health endpoint not found, but CDP is reachable"};let e=`Health check failed: ${r.status} ${r.statusText}`;try{let t=await r.text();t&&(e+=` - ${t.substring(0,200)}`)}catch{}return{healthy:!1,error:e}}}catch(t){let e=t instanceof Error?t.message:"Unknown error";if(e.includes("fetch failed")||e.includes("ENOTFOUND")||e.includes("getaddrinfo"))return{healthy:!1,error:`Facilitator URL not reachable (${e}). Payment verification may use a different endpoint.`};return{healthy:!1,error:e}}}}let c=null;function d(){if(!c){let e=process.env.CDP_API_KEY_ID,t=process.env.CDP_FACILITATOR_URL||"https://api.cdp.coinbase.com/platform/v2/x402";if(!e)throw Error("CDP_API_KEY_ID must be set in environment variables");c=new m(e,t)}return c}e.s(["getCDPFacilitator",()=>d],56036)}];

//# sourceMappingURL=src_integrations_x402_75d3e0c5._.js.map
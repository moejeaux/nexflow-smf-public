{"version":3,"sources":["../../../src/db/batch-settlement.ts"],"sourcesContent":["// =============================================================================\r\n// BATCH SETTLEMENT DATABASE OPERATIONS\r\n// =============================================================================\r\n// CRUD operations for batch settlement tables\r\n// Supports both PostgreSQL and SQLite adapters\r\n\r\nimport { getDb } from './client';\r\nimport { createLogger } from '@/lib/logger';\r\nimport type {\r\n  BatchSettlement,\r\n  BatchPayment,\r\n  BatchQueueItem,\r\n  SettlementProof,\r\n  EscrowAccount,\r\n  SettlementAuditLog,\r\n  PlatformFee,\r\n  BatchStatus,\r\n  PaymentStatus,\r\n  ProofVerificationStatus,\r\n  EscrowStatus,\r\n  PlatformFeeStatus,\r\n  CreateBatchSettlementInput,\r\n  AddPaymentToBatchInput,\r\n  EnqueuePaymentInput,\r\n  CreateSettlementProofInput,\r\n  UpsertEscrowAccountInput,\r\n  CreateAuditLogInput,\r\n  RecordPlatformFeeInput,\r\n  MerkleProofNode,\r\n} from '@/types/batch-settlement';\r\n\r\nconst logger = createLogger({ component: 'BatchSettlementDB' });\r\n\r\n// =============================================================================\r\n// HELPER FUNCTIONS\r\n// =============================================================================\r\n\r\nfunction isPostgres(db: any): boolean {\r\n  return 'pool' in db || typeof db?.pool?.query === 'function';\r\n}\r\n\r\nfunction generateBatchId(facilitatorId: string, network: string, tokenAddress: string): string {\r\n  const timestamp = Date.now();\r\n  const random = Math.random().toString(36).substring(2, 8);\r\n  return `batch_${facilitatorId}_${network}_${timestamp}_${random}`;\r\n}\r\n\r\n// Convert bigint to string for database storage\r\nfunction bigintToString(value: bigint | null | undefined): string | null {\r\n  if (value === null || value === undefined) return null;\r\n  return value.toString();\r\n}\r\n\r\n// Convert string from database to bigint\r\nfunction stringToBigint(value: string | null | undefined): bigint | null {\r\n  if (value === null || value === undefined) return null;\r\n  return BigInt(value);\r\n}\r\n\r\n// Convert database row to BatchSettlement\r\nfunction rowToBatchSettlement(row: any): BatchSettlement {\r\n  return {\r\n    id: row.id,\r\n    batch_id: row.batch_id,\r\n    created_at: new Date(row.created_at),\r\n    submitted_at: row.submitted_at ? new Date(row.submitted_at) : null,\r\n    settled_at: row.settled_at ? new Date(row.settled_at) : null,\r\n    status: row.status as BatchStatus,\r\n    payment_count: Number(row.payment_count),\r\n    total_amount_wei: BigInt(row.total_amount_wei || '0'),\r\n    total_fees_wei: BigInt(row.total_fees_wei || '0'),\r\n    merkle_root: row.merkle_root,\r\n    transaction_hash: row.transaction_hash,\r\n    block_number: row.block_number ? BigInt(row.block_number) : null,\r\n    error_message: row.error_message,\r\n    retry_count: Number(row.retry_count),\r\n    max_retries: Number(row.max_retries),\r\n    network: row.network,\r\n    token_address: row.token_address,\r\n    facilitator_id: row.facilitator_id,\r\n    settlement_contract: row.settlement_contract,\r\n    gas_used: row.gas_used ? BigInt(row.gas_used) : null,\r\n    gas_price_wei: row.gas_price_wei ? BigInt(row.gas_price_wei) : null,\r\n    updated_at: new Date(row.updated_at),\r\n  };\r\n}\r\n\r\n// Convert database row to BatchPayment\r\nfunction rowToBatchPayment(row: any): BatchPayment {\r\n  return {\r\n    id: row.id,\r\n    batch_id: row.batch_id,\r\n    payment_id: row.payment_id,\r\n    order_index: Number(row.order_index),\r\n    recipient_address: row.recipient_address,\r\n    amount_wei: BigInt(row.amount_wei || '0'),\r\n    fee_wei: BigInt(row.fee_wei || '0'),\r\n    status: row.status as PaymentStatus,\r\n    merkle_leaf: row.merkle_leaf,\r\n    proof_path: row.proof_path as MerkleProofNode[] | null,\r\n    route_id: row.route_id,\r\n    metadata: row.metadata,\r\n    created_at: new Date(row.created_at),\r\n    updated_at: new Date(row.updated_at),\r\n  };\r\n}\r\n\r\n// Convert database row to BatchQueueItem\r\nfunction rowToBatchQueueItem(row: any): BatchQueueItem {\r\n  return {\r\n    id: row.id,\r\n    payment_id: row.payment_id,\r\n    facilitator_id: row.facilitator_id,\r\n    network: row.network,\r\n    token_address: row.token_address,\r\n    recipient_address: row.recipient_address,\r\n    amount_wei: BigInt(row.amount_wei || '0'),\r\n    fee_wei: BigInt(row.fee_wei || '0'),\r\n    priority: Number(row.priority),\r\n    route_id: row.route_id,\r\n    metadata: row.metadata,\r\n    expires_at: row.expires_at ? new Date(row.expires_at) : null,\r\n    created_at: new Date(row.created_at),\r\n  };\r\n}\r\n\r\n// Convert database row to EscrowAccount\r\nfunction rowToEscrowAccount(row: any): EscrowAccount {\r\n  return {\r\n    id: row.id,\r\n    facilitator_id: row.facilitator_id,\r\n    token_address: row.token_address,\r\n    chain_id: row.chain_id,\r\n    escrow_address: row.escrow_address,\r\n    balance_wei: BigInt(row.balance_wei || '0'),\r\n    pending_settlement_wei: BigInt(row.pending_settlement_wei || '0'),\r\n    minimum_balance_wei: BigInt(row.minimum_balance_wei || '0'),\r\n    status: row.status as EscrowStatus,\r\n    last_on_chain_sync: row.last_on_chain_sync ? new Date(row.last_on_chain_sync) : null,\r\n    last_audit_at: row.last_audit_at ? new Date(row.last_audit_at) : null,\r\n    audit_block_number: row.audit_block_number ? BigInt(row.audit_block_number) : null,\r\n    created_at: new Date(row.created_at),\r\n    updated_at: new Date(row.updated_at),\r\n  };\r\n}\r\n\r\n// Convert database row to SettlementProof\r\nfunction rowToSettlementProof(row: any): SettlementProof {\r\n  return {\r\n    id: row.id,\r\n    batch_id: row.batch_id,\r\n    merkle_root: row.merkle_root,\r\n    merkle_depth: Number(row.merkle_depth),\r\n    total_leaves: Number(row.total_leaves),\r\n    leaves_hash: row.leaves_hash,\r\n    custody_proof_hash: row.custody_proof_hash,\r\n    solvency_verified: Boolean(row.solvency_verified),\r\n    solvency_check_at: row.solvency_check_at ? new Date(row.solvency_check_at) : null,\r\n    verification_status: row.verification_status as ProofVerificationStatus,\r\n    verified_at: row.verified_at ? new Date(row.verified_at) : null,\r\n    verifier_signature: row.verifier_signature,\r\n    created_at: new Date(row.created_at),\r\n  };\r\n}\r\n\r\n// Convert database row to PlatformFee\r\nfunction rowToPlatformFee(row: any): PlatformFee {\r\n  return {\r\n    id: row.id,\r\n    batch_id: row.batch_id,\r\n    payment_id: row.payment_id,\r\n    facilitator_id: row.facilitator_id,\r\n    network: row.network,\r\n    token_address: row.token_address,\r\n    fee_amount_wei: BigInt(row.fee_amount_wei || '0'),\r\n    fee_bps: Number(row.fee_bps),\r\n    payment_amount_wei: BigInt(row.payment_amount_wei || '0'),\r\n    status: row.status as PlatformFeeStatus,\r\n    captured_at: row.captured_at ? new Date(row.captured_at) : null,\r\n    withdrawal_tx: row.withdrawal_tx,\r\n    withdrawn_at: row.withdrawn_at ? new Date(row.withdrawn_at) : null,\r\n    created_at: new Date(row.created_at),\r\n  };\r\n}\r\n\r\n// =============================================================================\r\n// BATCH SETTLEMENTS\r\n// =============================================================================\r\n\r\n/**\r\n * Create a new batch settlement\r\n */\r\nexport async function createBatchSettlement(\r\n  input: CreateBatchSettlementInput\r\n): Promise<BatchSettlement> {\r\n  const db = getDb();\r\n  const id = crypto.randomUUID();\r\n  const batchId = generateBatchId(input.facilitator_id, input.network, input.token_address);\r\n  const now = new Date().toISOString();\r\n\r\n  if (isPostgres(db)) {\r\n    const result = await (db as any).pool.query(\r\n      `INSERT INTO batch_settlements (\r\n        id, batch_id, facilitator_id, network, token_address, \r\n        settlement_contract, max_retries, created_at, updated_at\r\n      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)\r\n      RETURNING *`,\r\n      [\r\n        id,\r\n        batchId,\r\n        input.facilitator_id,\r\n        input.network,\r\n        input.token_address,\r\n        input.settlement_contract || null,\r\n        input.max_retries || 3,\r\n        now,\r\n        now,\r\n      ]\r\n    );\r\n    return rowToBatchSettlement(result.rows[0]);\r\n  } else {\r\n    const stmt = (db as any).prepare(`\r\n      INSERT INTO batch_settlements (\r\n        id, batch_id, facilitator_id, network, token_address,\r\n        settlement_contract, max_retries, created_at, updated_at\r\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n    `);\r\n    stmt.run(\r\n      id, batchId, input.facilitator_id, input.network, input.token_address,\r\n      input.settlement_contract || null, input.max_retries || 3, now, now\r\n    );\r\n    const row = (db as any).prepare('SELECT * FROM batch_settlements WHERE id = ?').get(id);\r\n    return rowToBatchSettlement(row);\r\n  }\r\n}\r\n\r\n/**\r\n * Get batch settlement by ID\r\n */\r\nexport async function getBatchSettlement(id: string): Promise<BatchSettlement | null> {\r\n  const db = getDb();\r\n\r\n  if (isPostgres(db)) {\r\n    const result = await (db as any).pool.query(\r\n      'SELECT * FROM batch_settlements WHERE id = $1',\r\n      [id]\r\n    );\r\n    return result.rows[0] ? rowToBatchSettlement(result.rows[0]) : null;\r\n  } else {\r\n    const row = (db as any).prepare('SELECT * FROM batch_settlements WHERE id = ?').get(id);\r\n    return row ? rowToBatchSettlement(row) : null;\r\n  }\r\n}\r\n\r\n/**\r\n * Get batch settlement by batch_id\r\n */\r\nexport async function getBatchSettlementByBatchId(batchId: string): Promise<BatchSettlement | null> {\r\n  const db = getDb();\r\n\r\n  if (isPostgres(db)) {\r\n    const result = await (db as any).pool.query(\r\n      'SELECT * FROM batch_settlements WHERE batch_id = $1',\r\n      [batchId]\r\n    );\r\n    return result.rows[0] ? rowToBatchSettlement(result.rows[0]) : null;\r\n  } else {\r\n    const row = (db as any).prepare('SELECT * FROM batch_settlements WHERE batch_id = ?').get(batchId);\r\n    return row ? rowToBatchSettlement(row) : null;\r\n  }\r\n}\r\n\r\n/**\r\n * Get pending batches ready for submission\r\n */\r\nexport async function getPendingBatches(\r\n  facilitatorId?: string,\r\n  limit: number = 10\r\n): Promise<BatchSettlement[]> {\r\n  const db = getDb();\r\n\r\n  if (isPostgres(db)) {\r\n    let query = `\r\n      SELECT * FROM batch_settlements \r\n      WHERE status = 'pending' AND payment_count > 0\r\n    `;\r\n    const params: any[] = [];\r\n    \r\n    if (facilitatorId) {\r\n      query += ` AND facilitator_id = $1`;\r\n      params.push(facilitatorId);\r\n    }\r\n    \r\n    query += ` ORDER BY created_at ASC LIMIT $${params.length + 1}`;\r\n    params.push(limit);\r\n\r\n    const result = await (db as any).pool.query(query, params);\r\n    return result.rows.map(rowToBatchSettlement);\r\n  } else {\r\n    let query = `\r\n      SELECT * FROM batch_settlements \r\n      WHERE status = 'pending' AND payment_count > 0\r\n    `;\r\n    const params: any[] = [];\r\n    \r\n    if (facilitatorId) {\r\n      query += ` AND facilitator_id = ?`;\r\n      params.push(facilitatorId);\r\n    }\r\n    \r\n    query += ` ORDER BY created_at ASC LIMIT ?`;\r\n    params.push(limit);\r\n\r\n    const rows = (db as any).prepare(query).all(...params);\r\n    return rows.map(rowToBatchSettlement);\r\n  }\r\n}\r\n\r\n/**\r\n * Update batch settlement status\r\n */\r\nexport async function updateBatchStatus(\r\n  id: string,\r\n  status: BatchStatus,\r\n  updates?: {\r\n    merkle_root?: string;\r\n    transaction_hash?: string;\r\n    block_number?: bigint;\r\n    error_message?: string;\r\n    gas_used?: bigint;\r\n    gas_price_wei?: bigint;\r\n  }\r\n): Promise<void> {\r\n  const db = getDb();\r\n  const now = new Date().toISOString();\r\n\r\n  const setFields: string[] = ['status = $2', 'updated_at = $3'];\r\n  const params: any[] = [id, status, now];\r\n  let paramIndex = 4;\r\n\r\n  if (status === 'submitted') {\r\n    setFields.push(`submitted_at = $${paramIndex++}`);\r\n    params.push(now);\r\n  }\r\n\r\n  if (status === 'confirmed') {\r\n    setFields.push(`settled_at = $${paramIndex++}`);\r\n    params.push(now);\r\n  }\r\n\r\n  if (updates?.merkle_root) {\r\n    setFields.push(`merkle_root = $${paramIndex++}`);\r\n    params.push(updates.merkle_root);\r\n  }\r\n\r\n  if (updates?.transaction_hash) {\r\n    setFields.push(`transaction_hash = $${paramIndex++}`);\r\n    params.push(updates.transaction_hash);\r\n  }\r\n\r\n  if (updates?.block_number !== undefined) {\r\n    setFields.push(`block_number = $${paramIndex++}`);\r\n    params.push(bigintToString(updates.block_number));\r\n  }\r\n\r\n  if (updates?.error_message) {\r\n    setFields.push(`error_message = $${paramIndex++}`);\r\n    params.push(updates.error_message);\r\n  }\r\n\r\n  if (updates?.gas_used !== undefined) {\r\n    setFields.push(`gas_used = $${paramIndex++}`);\r\n    params.push(bigintToString(updates.gas_used));\r\n  }\r\n\r\n  if (updates?.gas_price_wei !== undefined) {\r\n    setFields.push(`gas_price_wei = $${paramIndex++}`);\r\n    params.push(bigintToString(updates.gas_price_wei));\r\n  }\r\n\r\n  if (isPostgres(db)) {\r\n    await (db as any).pool.query(\r\n      `UPDATE batch_settlements SET ${setFields.join(', ')} WHERE id = $1`,\r\n      params\r\n    );\r\n  } else {\r\n    // Convert PostgreSQL placeholders to SQLite\r\n    const sqliteQuery = `UPDATE batch_settlements SET ${setFields.map((f, i) => f.replace(/\\$\\d+/g, '?')).join(', ')} WHERE id = ?`;\r\n    (db as any).prepare(sqliteQuery).run(...params);\r\n  }\r\n}\r\n\r\n/**\r\n * Increment retry count for a batch\r\n */\r\nexport async function incrementBatchRetry(id: string): Promise<number> {\r\n  const db = getDb();\r\n  const now = new Date().toISOString();\r\n\r\n  if (isPostgres(db)) {\r\n    const result = await (db as any).pool.query(\r\n      `UPDATE batch_settlements \r\n       SET retry_count = retry_count + 1, updated_at = $2 \r\n       WHERE id = $1 \r\n       RETURNING retry_count`,\r\n      [id, now]\r\n    );\r\n    return Number(result.rows[0]?.retry_count || 0);\r\n  } else {\r\n    (db as any).prepare(\r\n      `UPDATE batch_settlements SET retry_count = retry_count + 1, updated_at = ? WHERE id = ?`\r\n    ).run(now, id);\r\n    const row = (db as any).prepare('SELECT retry_count FROM batch_settlements WHERE id = ?').get(id);\r\n    return Number(row?.retry_count || 0);\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// BATCH PAYMENTS\r\n// =============================================================================\r\n\r\n/**\r\n * Add a payment to a batch\r\n */\r\nexport async function addPaymentToBatch(\r\n  batchId: string,\r\n  input: AddPaymentToBatchInput\r\n): Promise<BatchPayment> {\r\n  const db = getDb();\r\n  const id = crypto.randomUUID();\r\n  const now = new Date().toISOString();\r\n\r\n  // Get next order_index for this batch\r\n  let orderIndex = 0;\r\n  if (isPostgres(db)) {\r\n    const countResult = await (db as any).pool.query(\r\n      'SELECT COUNT(*) as count FROM batch_payments WHERE batch_id = $1',\r\n      [batchId]\r\n    );\r\n    orderIndex = Number(countResult.rows[0].count);\r\n  } else {\r\n    const row = (db as any).prepare('SELECT COUNT(*) as count FROM batch_payments WHERE batch_id = ?').get(batchId);\r\n    orderIndex = Number(row?.count || 0);\r\n  }\r\n\r\n  if (isPostgres(db)) {\r\n    const result = await (db as any).pool.query(\r\n      `INSERT INTO batch_payments (\r\n        id, batch_id, payment_id, order_index, recipient_address,\r\n        amount_wei, fee_wei, route_id, metadata, created_at, updated_at\r\n      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11)\r\n      RETURNING *`,\r\n      [\r\n        id,\r\n        batchId,\r\n        input.payment_id,\r\n        orderIndex,\r\n        input.recipient_address,\r\n        bigintToString(input.amount_wei),\r\n        bigintToString(input.fee_wei || BigInt(0)),\r\n        input.route_id || null,\r\n        input.metadata ? JSON.stringify(input.metadata) : null,\r\n        now,\r\n        now,\r\n      ]\r\n    );\r\n\r\n    // Update batch payment count and totals\r\n    await (db as any).pool.query(\r\n      `UPDATE batch_settlements SET \r\n        payment_count = payment_count + 1,\r\n        total_amount_wei = total_amount_wei + $2,\r\n        total_fees_wei = total_fees_wei + $3,\r\n        updated_at = $4\r\n       WHERE id = $1`,\r\n      [batchId, bigintToString(input.amount_wei), bigintToString(input.fee_wei || BigInt(0)), now]\r\n    );\r\n\r\n    return rowToBatchPayment(result.rows[0]);\r\n  } else {\r\n    const stmt = (db as any).prepare(`\r\n      INSERT INTO batch_payments (\r\n        id, batch_id, payment_id, order_index, recipient_address,\r\n        amount_wei, fee_wei, route_id, metadata, created_at, updated_at\r\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n    `);\r\n    stmt.run(\r\n      id, batchId, input.payment_id, orderIndex, input.recipient_address,\r\n      bigintToString(input.amount_wei), bigintToString(input.fee_wei || BigInt(0)),\r\n      input.route_id || null, input.metadata ? JSON.stringify(input.metadata) : null,\r\n      now, now\r\n    );\r\n\r\n    // Update batch totals\r\n    (db as any).prepare(`\r\n      UPDATE batch_settlements SET \r\n        payment_count = payment_count + 1,\r\n        total_amount_wei = total_amount_wei + ?,\r\n        total_fees_wei = total_fees_wei + ?,\r\n        updated_at = ?\r\n       WHERE id = ?\r\n    `).run(bigintToString(input.amount_wei), bigintToString(input.fee_wei || BigInt(0)), now, batchId);\r\n\r\n    const row = (db as any).prepare('SELECT * FROM batch_payments WHERE id = ?').get(id);\r\n    return rowToBatchPayment(row);\r\n  }\r\n}\r\n\r\n/**\r\n * Get payments for a batch\r\n */\r\nexport async function getBatchPayments(batchId: string): Promise<BatchPayment[]> {\r\n  const db = getDb();\r\n\r\n  if (isPostgres(db)) {\r\n    const result = await (db as any).pool.query(\r\n      'SELECT * FROM batch_payments WHERE batch_id = $1 ORDER BY order_index',\r\n      [batchId]\r\n    );\r\n    return result.rows.map(rowToBatchPayment);\r\n  } else {\r\n    const rows = (db as any).prepare(\r\n      'SELECT * FROM batch_payments WHERE batch_id = ? ORDER BY order_index'\r\n    ).all(batchId);\r\n    return rows.map(rowToBatchPayment);\r\n  }\r\n}\r\n\r\n/**\r\n * Update payment Merkle data\r\n */\r\nexport async function updatePaymentMerkleData(\r\n  paymentId: string,\r\n  merkleLeaf: string,\r\n  proofPath: MerkleProofNode[]\r\n): Promise<void> {\r\n  const db = getDb();\r\n  const now = new Date().toISOString();\r\n\r\n  if (isPostgres(db)) {\r\n    await (db as any).pool.query(\r\n      `UPDATE batch_payments SET \r\n        merkle_leaf = $2, \r\n        proof_path = $3,\r\n        status = 'included',\r\n        updated_at = $4\r\n       WHERE payment_id = $1`,\r\n      [paymentId, merkleLeaf, JSON.stringify(proofPath), now]\r\n    );\r\n  } else {\r\n    (db as any).prepare(`\r\n      UPDATE batch_payments SET \r\n        merkle_leaf = ?, \r\n        proof_path = ?,\r\n        status = 'included',\r\n        updated_at = ?\r\n       WHERE payment_id = ?\r\n    `).run(merkleLeaf, JSON.stringify(proofPath), now, paymentId);\r\n  }\r\n}\r\n\r\n/**\r\n * Update payment status\r\n */\r\nexport async function updatePaymentStatus(\r\n  paymentId: string,\r\n  status: PaymentStatus\r\n): Promise<void> {\r\n  const db = getDb();\r\n  const now = new Date().toISOString();\r\n\r\n  if (isPostgres(db)) {\r\n    await (db as any).pool.query(\r\n      `UPDATE batch_payments SET status = $2, updated_at = $3 WHERE payment_id = $1`,\r\n      [paymentId, status, now]\r\n    );\r\n  } else {\r\n    (db as any).prepare(\r\n      `UPDATE batch_payments SET status = ?, updated_at = ? WHERE payment_id = ?`\r\n    ).run(status, now, paymentId);\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// BATCH QUEUE\r\n// =============================================================================\r\n\r\n/**\r\n * Enqueue a payment for batch processing\r\n */\r\nexport async function enqueuePayment(input: EnqueuePaymentInput): Promise<BatchQueueItem> {\r\n  const db = getDb();\r\n  const id = crypto.randomUUID();\r\n  const now = new Date().toISOString();\r\n\r\n  if (isPostgres(db)) {\r\n    const result = await (db as any).pool.query(\r\n      `INSERT INTO batch_queue (\r\n        id, payment_id, facilitator_id, network, token_address,\r\n        recipient_address, amount_wei, fee_wei, priority,\r\n        route_id, metadata, expires_at, created_at\r\n      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13)\r\n      RETURNING *`,\r\n      [\r\n        id,\r\n        input.payment_id,\r\n        input.facilitator_id,\r\n        input.network,\r\n        input.token_address,\r\n        input.recipient_address,\r\n        bigintToString(input.amount_wei),\r\n        bigintToString(input.fee_wei || BigInt(0)),\r\n        input.priority || 0,\r\n        input.route_id || null,\r\n        input.metadata ? JSON.stringify(input.metadata) : null,\r\n        input.expires_at?.toISOString() || null,\r\n        now,\r\n      ]\r\n    );\r\n    return rowToBatchQueueItem(result.rows[0]);\r\n  } else {\r\n    const stmt = (db as any).prepare(`\r\n      INSERT INTO batch_queue (\r\n        id, payment_id, facilitator_id, network, token_address,\r\n        recipient_address, amount_wei, fee_wei, priority,\r\n        route_id, metadata, expires_at, created_at\r\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n    `);\r\n    stmt.run(\r\n      id, input.payment_id, input.facilitator_id, input.network, input.token_address,\r\n      input.recipient_address, bigintToString(input.amount_wei),\r\n      bigintToString(input.fee_wei || BigInt(0)), input.priority || 0,\r\n      input.route_id || null, input.metadata ? JSON.stringify(input.metadata) : null,\r\n      input.expires_at?.toISOString() || null, now\r\n    );\r\n    const row = (db as any).prepare('SELECT * FROM batch_queue WHERE id = ?').get(id);\r\n    return rowToBatchQueueItem(row);\r\n  }\r\n}\r\n\r\n/**\r\n * Get queued payments ready for batching\r\n * Groups by facilitator/network/token for efficient batching\r\n */\r\nexport async function getQueuedPayments(\r\n  facilitatorId: string,\r\n  network: string,\r\n  tokenAddress: string,\r\n  limit: number = 100\r\n): Promise<BatchQueueItem[]> {\r\n  const db = getDb();\r\n\r\n  if (isPostgres(db)) {\r\n    const result = await (db as any).pool.query(\r\n      `SELECT * FROM batch_queue \r\n       WHERE facilitator_id = $1 AND network = $2 AND token_address = $3\r\n         AND (expires_at IS NULL OR expires_at > NOW())\r\n       ORDER BY priority DESC, created_at ASC\r\n       LIMIT $4`,\r\n      [facilitatorId, network, tokenAddress, limit]\r\n    );\r\n    return result.rows.map(rowToBatchQueueItem);\r\n  } else {\r\n    const rows = (db as any).prepare(\r\n      `SELECT * FROM batch_queue \r\n       WHERE facilitator_id = ? AND network = ? AND token_address = ?\r\n         AND (expires_at IS NULL OR expires_at > datetime('now'))\r\n       ORDER BY priority DESC, created_at ASC\r\n       LIMIT ?`\r\n    ).all(facilitatorId, network, tokenAddress, limit);\r\n    return rows.map(rowToBatchQueueItem);\r\n  }\r\n}\r\n\r\n/**\r\n * Remove payments from queue (after adding to batch)\r\n */\r\nexport async function dequeuePayments(paymentIds: string[]): Promise<void> {\r\n  if (paymentIds.length === 0) return;\r\n  \r\n  const db = getDb();\r\n\r\n  if (isPostgres(db)) {\r\n    await (db as any).pool.query(\r\n      `DELETE FROM batch_queue WHERE payment_id = ANY($1)`,\r\n      [paymentIds]\r\n    );\r\n  } else {\r\n    const placeholders = paymentIds.map(() => '?').join(',');\r\n    (db as any).prepare(\r\n      `DELETE FROM batch_queue WHERE payment_id IN (${placeholders})`\r\n    ).run(...paymentIds);\r\n  }\r\n}\r\n\r\n/**\r\n * Remove expired payments from queue\r\n */\r\nexport async function cleanupExpiredQueueItems(): Promise<number> {\r\n  const db = getDb();\r\n\r\n  if (isPostgres(db)) {\r\n    const result = await (db as any).pool.query(\r\n      `DELETE FROM batch_queue WHERE expires_at IS NOT NULL AND expires_at < NOW() RETURNING id`\r\n    );\r\n    return result.rowCount || 0;\r\n  } else {\r\n    const info = (db as any).prepare(\r\n      `DELETE FROM batch_queue WHERE expires_at IS NOT NULL AND expires_at < datetime('now')`\r\n    ).run();\r\n    return info.changes || 0;\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// ESCROW ACCOUNTS\r\n// =============================================================================\r\n\r\n/**\r\n * Create or update an escrow account\r\n */\r\nexport async function upsertEscrowAccount(input: UpsertEscrowAccountInput): Promise<EscrowAccount> {\r\n  const db = getDb();\r\n  const id = crypto.randomUUID();\r\n  const now = new Date().toISOString();\r\n\r\n  if (isPostgres(db)) {\r\n    const result = await (db as any).pool.query(\r\n      `INSERT INTO escrow_accounts (\r\n        id, facilitator_id, token_address, chain_id, escrow_address,\r\n        minimum_balance_wei, created_at, updated_at\r\n      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8)\r\n      ON CONFLICT (facilitator_id, token_address, chain_id)\r\n      DO UPDATE SET\r\n        escrow_address = EXCLUDED.escrow_address,\r\n        minimum_balance_wei = COALESCE(EXCLUDED.minimum_balance_wei, escrow_accounts.minimum_balance_wei),\r\n        updated_at = EXCLUDED.updated_at\r\n      RETURNING *`,\r\n      [\r\n        id,\r\n        input.facilitator_id,\r\n        input.token_address,\r\n        input.chain_id,\r\n        input.escrow_address,\r\n        bigintToString(input.minimum_balance_wei || BigInt(0)),\r\n        now,\r\n        now,\r\n      ]\r\n    );\r\n    return rowToEscrowAccount(result.rows[0]);\r\n  } else {\r\n    // SQLite: Try update first, then insert\r\n    const existing = (db as any).prepare(\r\n      `SELECT * FROM escrow_accounts WHERE facilitator_id = ? AND token_address = ? AND chain_id = ?`\r\n    ).get(input.facilitator_id, input.token_address, input.chain_id);\r\n\r\n    if (existing) {\r\n      (db as any).prepare(`\r\n        UPDATE escrow_accounts SET\r\n          escrow_address = ?,\r\n          minimum_balance_wei = COALESCE(?, minimum_balance_wei),\r\n          updated_at = ?\r\n        WHERE id = ?\r\n      `).run(input.escrow_address, bigintToString(input.minimum_balance_wei), now, existing.id);\r\n      const row = (db as any).prepare('SELECT * FROM escrow_accounts WHERE id = ?').get(existing.id);\r\n      return rowToEscrowAccount(row);\r\n    } else {\r\n      (db as any).prepare(`\r\n        INSERT INTO escrow_accounts (\r\n          id, facilitator_id, token_address, chain_id, escrow_address,\r\n          minimum_balance_wei, created_at, updated_at\r\n        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)\r\n      `).run(\r\n        id, input.facilitator_id, input.token_address, input.chain_id,\r\n        input.escrow_address, bigintToString(input.minimum_balance_wei || BigInt(0)), now, now\r\n      );\r\n      const row = (db as any).prepare('SELECT * FROM escrow_accounts WHERE id = ?').get(id);\r\n      return rowToEscrowAccount(row);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Get escrow account\r\n */\r\nexport async function getEscrowAccount(\r\n  facilitatorId: string,\r\n  tokenAddress: string,\r\n  chainId: string\r\n): Promise<EscrowAccount | null> {\r\n  const db = getDb();\r\n\r\n  if (isPostgres(db)) {\r\n    const result = await (db as any).pool.query(\r\n      `SELECT * FROM escrow_accounts \r\n       WHERE facilitator_id = $1 AND token_address = $2 AND chain_id = $3`,\r\n      [facilitatorId, tokenAddress, chainId]\r\n    );\r\n    return result.rows[0] ? rowToEscrowAccount(result.rows[0]) : null;\r\n  } else {\r\n    const row = (db as any).prepare(\r\n      `SELECT * FROM escrow_accounts \r\n       WHERE facilitator_id = ? AND token_address = ? AND chain_id = ?`\r\n    ).get(facilitatorId, tokenAddress, chainId);\r\n    return row ? rowToEscrowAccount(row) : null;\r\n  }\r\n}\r\n\r\n/**\r\n * Update escrow balance\r\n */\r\nexport async function updateEscrowBalance(\r\n  escrowId: string,\r\n  balanceWei: bigint,\r\n  status?: EscrowStatus\r\n): Promise<void> {\r\n  const db = getDb();\r\n  const now = new Date().toISOString();\r\n\r\n  if (isPostgres(db)) {\r\n    await (db as any).pool.query(\r\n      `UPDATE escrow_accounts SET\r\n        balance_wei = $2,\r\n        status = COALESCE($3, status),\r\n        last_on_chain_sync = $4,\r\n        updated_at = $4\r\n       WHERE id = $1`,\r\n      [escrowId, bigintToString(balanceWei), status || null, now]\r\n    );\r\n  } else {\r\n    if (status) {\r\n      (db as any).prepare(`\r\n        UPDATE escrow_accounts SET\r\n          balance_wei = ?,\r\n          status = ?,\r\n          last_on_chain_sync = ?,\r\n          updated_at = ?\r\n         WHERE id = ?\r\n      `).run(bigintToString(balanceWei), status, now, now, escrowId);\r\n    } else {\r\n      (db as any).prepare(`\r\n        UPDATE escrow_accounts SET\r\n          balance_wei = ?,\r\n          last_on_chain_sync = ?,\r\n          updated_at = ?\r\n         WHERE id = ?\r\n      `).run(bigintToString(balanceWei), now, now, escrowId);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Update pending settlement amount for escrow\r\n */\r\nexport async function updatePendingSettlement(\r\n  escrowId: string,\r\n  pendingWei: bigint\r\n): Promise<void> {\r\n  const db = getDb();\r\n  const now = new Date().toISOString();\r\n\r\n  if (isPostgres(db)) {\r\n    await (db as any).pool.query(\r\n      `UPDATE escrow_accounts SET pending_settlement_wei = $2, updated_at = $3 WHERE id = $1`,\r\n      [escrowId, bigintToString(pendingWei), now]\r\n    );\r\n  } else {\r\n    (db as any).prepare(\r\n      `UPDATE escrow_accounts SET pending_settlement_wei = ?, updated_at = ? WHERE id = ?`\r\n    ).run(bigintToString(pendingWei), now, escrowId);\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// SETTLEMENT PROOFS\r\n// =============================================================================\r\n\r\n/**\r\n * Create a settlement proof\r\n */\r\nexport async function createSettlementProof(\r\n  input: CreateSettlementProofInput\r\n): Promise<SettlementProof> {\r\n  const db = getDb();\r\n  const id = crypto.randomUUID();\r\n  const now = new Date().toISOString();\r\n\r\n  if (isPostgres(db)) {\r\n    const result = await (db as any).pool.query(\r\n      `INSERT INTO settlement_proofs (\r\n        id, batch_id, merkle_root, merkle_depth, total_leaves,\r\n        leaves_hash, custody_proof_hash, created_at\r\n      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8)\r\n      RETURNING *`,\r\n      [\r\n        id,\r\n        input.batch_id,\r\n        input.merkle_root,\r\n        input.merkle_depth,\r\n        input.total_leaves,\r\n        input.leaves_hash,\r\n        input.custody_proof_hash || null,\r\n        now,\r\n      ]\r\n    );\r\n    return rowToSettlementProof(result.rows[0]);\r\n  } else {\r\n    (db as any).prepare(`\r\n      INSERT INTO settlement_proofs (\r\n        id, batch_id, merkle_root, merkle_depth, total_leaves,\r\n        leaves_hash, custody_proof_hash, created_at\r\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)\r\n    `).run(\r\n      id, input.batch_id, input.merkle_root, input.merkle_depth, input.total_leaves,\r\n      input.leaves_hash, input.custody_proof_hash || null, now\r\n    );\r\n    const row = (db as any).prepare('SELECT * FROM settlement_proofs WHERE id = ?').get(id);\r\n    return rowToSettlementProof(row);\r\n  }\r\n}\r\n\r\n/**\r\n * Get settlement proof for a batch\r\n */\r\nexport async function getSettlementProof(batchId: string): Promise<SettlementProof | null> {\r\n  const db = getDb();\r\n\r\n  if (isPostgres(db)) {\r\n    const result = await (db as any).pool.query(\r\n      'SELECT * FROM settlement_proofs WHERE batch_id = $1',\r\n      [batchId]\r\n    );\r\n    return result.rows[0] ? rowToSettlementProof(result.rows[0]) : null;\r\n  } else {\r\n    const row = (db as any).prepare('SELECT * FROM settlement_proofs WHERE batch_id = ?').get(batchId);\r\n    return row ? rowToSettlementProof(row) : null;\r\n  }\r\n}\r\n\r\n/**\r\n * Update proof verification status\r\n */\r\nexport async function updateProofVerificationStatus(\r\n  proofId: string,\r\n  status: ProofVerificationStatus,\r\n  verifierSignature?: string\r\n): Promise<void> {\r\n  const db = getDb();\r\n  const now = new Date().toISOString();\r\n\r\n  if (isPostgres(db)) {\r\n    await (db as any).pool.query(\r\n      `UPDATE settlement_proofs SET \r\n        verification_status = $2,\r\n        verified_at = CASE WHEN $2 = 'verified' THEN $3 ELSE verified_at END,\r\n        verifier_signature = COALESCE($4, verifier_signature)\r\n       WHERE id = $1`,\r\n      [proofId, status, now, verifierSignature || null]\r\n    );\r\n  } else {\r\n    if (status === 'verified') {\r\n      (db as any).prepare(`\r\n        UPDATE settlement_proofs SET \r\n          verification_status = ?,\r\n          verified_at = ?,\r\n          verifier_signature = COALESCE(?, verifier_signature)\r\n         WHERE id = ?\r\n      `).run(status, now, verifierSignature || null, proofId);\r\n    } else {\r\n      (db as any).prepare(`\r\n        UPDATE settlement_proofs SET verification_status = ? WHERE id = ?\r\n      `).run(status, proofId);\r\n    }\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// AUDIT LOGS\r\n// =============================================================================\r\n\r\n/**\r\n * Create an audit log entry\r\n */\r\nexport async function createAuditLog(input: CreateAuditLogInput): Promise<SettlementAuditLog> {\r\n  const db = getDb();\r\n  const id = crypto.randomUUID();\r\n  const now = new Date().toISOString();\r\n\r\n  if (isPostgres(db)) {\r\n    const result = await (db as any).pool.query(\r\n      `INSERT INTO settlement_audit_logs (\r\n        id, batch_id, escrow_id, action, amount_wei,\r\n        previous_balance_wei, new_balance_wei, actor,\r\n        transaction_hash, details, created_at\r\n      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11)\r\n      RETURNING *`,\r\n      [\r\n        id,\r\n        input.batch_id || null,\r\n        input.escrow_id || null,\r\n        input.action,\r\n        bigintToString(input.amount_wei),\r\n        bigintToString(input.previous_balance_wei),\r\n        bigintToString(input.new_balance_wei),\r\n        input.actor,\r\n        input.transaction_hash || null,\r\n        input.details ? JSON.stringify(input.details) : null,\r\n        now,\r\n      ]\r\n    );\r\n    return {\r\n      ...result.rows[0],\r\n      amount_wei: stringToBigint(result.rows[0].amount_wei),\r\n      previous_balance_wei: stringToBigint(result.rows[0].previous_balance_wei),\r\n      new_balance_wei: stringToBigint(result.rows[0].new_balance_wei),\r\n      created_at: new Date(result.rows[0].created_at),\r\n    };\r\n  } else {\r\n    (db as any).prepare(`\r\n      INSERT INTO settlement_audit_logs (\r\n        id, batch_id, escrow_id, action, amount_wei,\r\n        previous_balance_wei, new_balance_wei, actor,\r\n        transaction_hash, details, created_at\r\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n    `).run(\r\n      id, input.batch_id || null, input.escrow_id || null, input.action,\r\n      bigintToString(input.amount_wei), bigintToString(input.previous_balance_wei),\r\n      bigintToString(input.new_balance_wei), input.actor,\r\n      input.transaction_hash || null, input.details ? JSON.stringify(input.details) : null, now\r\n    );\r\n    const row = (db as any).prepare('SELECT * FROM settlement_audit_logs WHERE id = ?').get(id);\r\n    return {\r\n      ...row,\r\n      amount_wei: stringToBigint(row.amount_wei),\r\n      previous_balance_wei: stringToBigint(row.previous_balance_wei),\r\n      new_balance_wei: stringToBigint(row.new_balance_wei),\r\n      created_at: new Date(row.created_at),\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Get audit logs for a batch\r\n */\r\nexport async function getBatchAuditLogs(batchId: string): Promise<SettlementAuditLog[]> {\r\n  const db = getDb();\r\n\r\n  if (isPostgres(db)) {\r\n    const result = await (db as any).pool.query(\r\n      'SELECT * FROM settlement_audit_logs WHERE batch_id = $1 ORDER BY created_at',\r\n      [batchId]\r\n    );\r\n    return result.rows.map((row: any) => ({\r\n      ...row,\r\n      amount_wei: stringToBigint(row.amount_wei),\r\n      previous_balance_wei: stringToBigint(row.previous_balance_wei),\r\n      new_balance_wei: stringToBigint(row.new_balance_wei),\r\n      created_at: new Date(row.created_at),\r\n    }));\r\n  } else {\r\n    const rows = (db as any).prepare(\r\n      'SELECT * FROM settlement_audit_logs WHERE batch_id = ? ORDER BY created_at'\r\n    ).all(batchId);\r\n    return rows.map((row: any) => ({\r\n      ...row,\r\n      amount_wei: stringToBigint(row.amount_wei),\r\n      previous_balance_wei: stringToBigint(row.previous_balance_wei),\r\n      new_balance_wei: stringToBigint(row.new_balance_wei),\r\n      created_at: new Date(row.created_at),\r\n    }));\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// PLATFORM FEES\r\n// =============================================================================\r\n\r\n/**\r\n * Record a platform fee\r\n */\r\nexport async function recordPlatformFee(input: RecordPlatformFeeInput): Promise<PlatformFee> {\r\n  const db = getDb();\r\n  const id = crypto.randomUUID();\r\n  const now = new Date().toISOString();\r\n\r\n  if (isPostgres(db)) {\r\n    const result = await (db as any).pool.query(\r\n      `INSERT INTO platform_fees (\r\n        id, batch_id, payment_id, facilitator_id, network, token_address,\r\n        fee_amount_wei, fee_bps, payment_amount_wei, created_at\r\n      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)\r\n      RETURNING *`,\r\n      [\r\n        id,\r\n        input.batch_id || null,\r\n        input.payment_id || null,\r\n        input.facilitator_id,\r\n        input.network,\r\n        input.token_address,\r\n        bigintToString(input.fee_amount_wei),\r\n        input.fee_bps,\r\n        bigintToString(input.payment_amount_wei),\r\n        now,\r\n      ]\r\n    );\r\n    return rowToPlatformFee(result.rows[0]);\r\n  } else {\r\n    (db as any).prepare(`\r\n      INSERT INTO platform_fees (\r\n        id, batch_id, payment_id, facilitator_id, network, token_address,\r\n        fee_amount_wei, fee_bps, payment_amount_wei, created_at\r\n      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n    `).run(\r\n      id, input.batch_id || null, input.payment_id || null, input.facilitator_id,\r\n      input.network, input.token_address, bigintToString(input.fee_amount_wei),\r\n      input.fee_bps, bigintToString(input.payment_amount_wei), now\r\n    );\r\n    const row = (db as any).prepare('SELECT * FROM platform_fees WHERE id = ?').get(id);\r\n    return rowToPlatformFee(row);\r\n  }\r\n}\r\n\r\n/**\r\n * Update platform fee status to captured\r\n */\r\nexport async function capturePlatformFee(feeId: string): Promise<void> {\r\n  const db = getDb();\r\n  const now = new Date().toISOString();\r\n\r\n  if (isPostgres(db)) {\r\n    await (db as any).pool.query(\r\n      `UPDATE platform_fees SET status = 'captured', captured_at = $2 WHERE id = $1`,\r\n      [feeId, now]\r\n    );\r\n  } else {\r\n    (db as any).prepare(\r\n      `UPDATE platform_fees SET status = 'captured', captured_at = ? WHERE id = ?`\r\n    ).run(now, feeId);\r\n  }\r\n}\r\n\r\n/**\r\n * Get total uncaptured fees\r\n */\r\nexport async function getTotalPendingFees(\r\n  facilitatorId?: string,\r\n  network?: string,\r\n  tokenAddress?: string\r\n): Promise<bigint> {\r\n  const db = getDb();\r\n\r\n  let query = `SELECT COALESCE(SUM(fee_amount_wei), 0) as total FROM platform_fees WHERE status = 'pending'`;\r\n  const params: any[] = [];\r\n\r\n  if (isPostgres(db)) {\r\n    let paramIndex = 1;\r\n    if (facilitatorId) {\r\n      query += ` AND facilitator_id = $${paramIndex++}`;\r\n      params.push(facilitatorId);\r\n    }\r\n    if (network) {\r\n      query += ` AND network = $${paramIndex++}`;\r\n      params.push(network);\r\n    }\r\n    if (tokenAddress) {\r\n      query += ` AND token_address = $${paramIndex++}`;\r\n      params.push(tokenAddress);\r\n    }\r\n\r\n    const result = await (db as any).pool.query(query, params);\r\n    return BigInt(result.rows[0]?.total || '0');\r\n  } else {\r\n    if (facilitatorId) {\r\n      query += ` AND facilitator_id = ?`;\r\n      params.push(facilitatorId);\r\n    }\r\n    if (network) {\r\n      query += ` AND network = ?`;\r\n      params.push(network);\r\n    }\r\n    if (tokenAddress) {\r\n      query += ` AND token_address = ?`;\r\n      params.push(tokenAddress);\r\n    }\r\n\r\n    const row = (db as any).prepare(query).get(...params);\r\n    return BigInt(row?.total || '0');\r\n  }\r\n}\r\n\r\n// Aliases for fee manager compatibility\r\nexport const createPlatformFee = recordPlatformFee;\r\n\r\n/**\r\n * Get a platform fee by ID\r\n */\r\nexport async function getPlatformFee(feeId: string): Promise<PlatformFee | null> {\r\n  const db = getDb();\r\n\r\n  if (isPostgres(db)) {\r\n    const result = await (db as any).pool.query(\r\n      'SELECT * FROM platform_fees WHERE id = $1',\r\n      [feeId]\r\n    );\r\n    return result.rows[0] ? rowToPlatformFee(result.rows[0]) : null;\r\n  } else {\r\n    const row = (db as any).prepare('SELECT * FROM platform_fees WHERE id = ?').get(feeId);\r\n    return row ? rowToPlatformFee(row) : null;\r\n  }\r\n}\r\n\r\n/**\r\n * Get platform fees by batch ID\r\n */\r\nexport async function getPlatformFeesByBatch(batchId: string): Promise<PlatformFee[]> {\r\n  const db = getDb();\r\n\r\n  if (isPostgres(db)) {\r\n    const result = await (db as any).pool.query(\r\n      'SELECT * FROM platform_fees WHERE batch_id = $1 ORDER BY created_at',\r\n      [batchId]\r\n    );\r\n    return result.rows.map(rowToPlatformFee);\r\n  } else {\r\n    const rows = (db as any).prepare(\r\n      'SELECT * FROM platform_fees WHERE batch_id = ? ORDER BY created_at'\r\n    ).all(batchId);\r\n    return rows.map(rowToPlatformFee);\r\n  }\r\n}\r\n\r\n/**\r\n * Get platform fees by facilitator\r\n */\r\nexport async function getPlatformFeesByFacilitator(\r\n  facilitatorId: string,\r\n  options?: {\r\n    status?: PlatformFeeStatus;\r\n    tokenAddress?: string;\r\n    network?: string;\r\n    limit?: number;\r\n    offset?: number;\r\n  }\r\n): Promise<PlatformFee[]> {\r\n  const db = getDb();\r\n  const limit = options?.limit ?? 100;\r\n  const offset = options?.offset ?? 0;\r\n\r\n  if (isPostgres(db)) {\r\n    let query = 'SELECT * FROM platform_fees WHERE facilitator_id = $1';\r\n    const params: any[] = [facilitatorId];\r\n    let paramIndex = 2;\r\n\r\n    if (options?.status) {\r\n      query += ` AND status = $${paramIndex++}`;\r\n      params.push(options.status);\r\n    }\r\n    if (options?.tokenAddress) {\r\n      query += ` AND token_address = $${paramIndex++}`;\r\n      params.push(options.tokenAddress);\r\n    }\r\n    if (options?.network) {\r\n      query += ` AND network = $${paramIndex++}`;\r\n      params.push(options.network);\r\n    }\r\n\r\n    query += ` ORDER BY created_at DESC LIMIT $${paramIndex++} OFFSET $${paramIndex}`;\r\n    params.push(limit, offset);\r\n\r\n    const result = await (db as any).pool.query(query, params);\r\n    return result.rows.map(rowToPlatformFee);\r\n  } else {\r\n    let query = 'SELECT * FROM platform_fees WHERE facilitator_id = ?';\r\n    const params: any[] = [facilitatorId];\r\n\r\n    if (options?.status) {\r\n      query += ' AND status = ?';\r\n      params.push(options.status);\r\n    }\r\n    if (options?.tokenAddress) {\r\n      query += ' AND token_address = ?';\r\n      params.push(options.tokenAddress);\r\n    }\r\n    if (options?.network) {\r\n      query += ' AND network = ?';\r\n      params.push(options.network);\r\n    }\r\n\r\n    query += ' ORDER BY created_at DESC LIMIT ? OFFSET ?';\r\n    params.push(limit, offset);\r\n\r\n    const rows = (db as any).prepare(query).all(...params);\r\n    return rows.map(rowToPlatformFee);\r\n  }\r\n}\r\n\r\n/**\r\n * Get total fees by token with breakdown by status\r\n */\r\nexport async function getTotalFeesByToken(tokenAddress: string): Promise<{\r\n  total: bigint;\r\n  pending: bigint;\r\n  captured: bigint;\r\n  withdrawn: bigint;\r\n}> {\r\n  const db = getDb();\r\n\r\n  if (isPostgres(db)) {\r\n    const result = await (db as any).pool.query(\r\n      `SELECT \r\n        COALESCE(SUM(fee_amount_wei), 0) as total,\r\n        COALESCE(SUM(CASE WHEN status = 'pending' THEN fee_amount_wei ELSE 0 END), 0) as pending,\r\n        COALESCE(SUM(CASE WHEN status = 'captured' THEN fee_amount_wei ELSE 0 END), 0) as captured,\r\n        COALESCE(SUM(CASE WHEN status = 'withdrawn' THEN fee_amount_wei ELSE 0 END), 0) as withdrawn\r\n       FROM platform_fees WHERE token_address = $1`,\r\n      [tokenAddress]\r\n    );\r\n    const row = result.rows[0];\r\n    return {\r\n      total: BigInt(row.total || '0'),\r\n      pending: BigInt(row.pending || '0'),\r\n      captured: BigInt(row.captured || '0'),\r\n      withdrawn: BigInt(row.withdrawn || '0'),\r\n    };\r\n  } else {\r\n    const row = (db as any).prepare(\r\n      `SELECT \r\n        COALESCE(SUM(fee_amount_wei), 0) as total,\r\n        COALESCE(SUM(CASE WHEN status = 'pending' THEN fee_amount_wei ELSE 0 END), 0) as pending,\r\n        COALESCE(SUM(CASE WHEN status = 'captured' THEN fee_amount_wei ELSE 0 END), 0) as captured,\r\n        COALESCE(SUM(CASE WHEN status = 'withdrawn' THEN fee_amount_wei ELSE 0 END), 0) as withdrawn\r\n       FROM platform_fees WHERE token_address = ?`\r\n    ).get(tokenAddress);\r\n    return {\r\n      total: BigInt(row?.total || '0'),\r\n      pending: BigInt(row?.pending || '0'),\r\n      captured: BigInt(row?.captured || '0'),\r\n      withdrawn: BigInt(row?.withdrawn || '0'),\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Update platform fee status\r\n */\r\nexport async function updatePlatformFeeStatus(\r\n  feeId: string,\r\n  status: PlatformFeeStatus,\r\n  withdrawalTxHash?: string\r\n): Promise<void> {\r\n  const db = getDb();\r\n  const now = new Date().toISOString();\r\n\r\n  if (isPostgres(db)) {\r\n    if (status === 'captured') {\r\n      await (db as any).pool.query(\r\n        `UPDATE platform_fees SET status = $2, captured_at = $3 WHERE id = $1`,\r\n        [feeId, status, now]\r\n      );\r\n    } else if (status === 'withdrawn' && withdrawalTxHash) {\r\n      await (db as any).pool.query(\r\n        `UPDATE platform_fees SET status = $2, withdrawal_tx = $3, withdrawn_at = $4 WHERE id = $1`,\r\n        [feeId, status, withdrawalTxHash, now]\r\n      );\r\n    } else {\r\n      await (db as any).pool.query(\r\n        `UPDATE platform_fees SET status = $2 WHERE id = $1`,\r\n        [feeId, status]\r\n      );\r\n    }\r\n  } else {\r\n    if (status === 'captured') {\r\n      (db as any).prepare(\r\n        `UPDATE platform_fees SET status = ?, captured_at = ? WHERE id = ?`\r\n      ).run(status, now, feeId);\r\n    } else if (status === 'withdrawn' && withdrawalTxHash) {\r\n      (db as any).prepare(\r\n        `UPDATE platform_fees SET status = ?, withdrawal_tx = ?, withdrawn_at = ? WHERE id = ?`\r\n      ).run(status, withdrawalTxHash, now, feeId);\r\n    } else {\r\n      (db as any).prepare(\r\n        `UPDATE platform_fees SET status = ? WHERE id = ?`\r\n      ).run(status, feeId);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Get audit logs by action type\r\n */\r\nexport async function getAuditLogsByAction(\r\n  action: AuditAction,\r\n  options?: {\r\n    batchId?: string;\r\n    escrowId?: string;\r\n    startDate?: Date;\r\n    endDate?: Date;\r\n    limit?: number;\r\n  }\r\n): Promise<SettlementAuditLog[]> {\r\n  const db = getDb();\r\n  const limit = options?.limit ?? 100;\r\n\r\n  if (isPostgres(db)) {\r\n    let query = 'SELECT * FROM settlement_audit_logs WHERE action = $1';\r\n    const params: any[] = [action];\r\n    let paramIndex = 2;\r\n\r\n    if (options?.batchId) {\r\n      query += ` AND batch_id = $${paramIndex++}`;\r\n      params.push(options.batchId);\r\n    }\r\n    if (options?.escrowId) {\r\n      query += ` AND escrow_id = $${paramIndex++}`;\r\n      params.push(options.escrowId);\r\n    }\r\n    if (options?.startDate) {\r\n      query += ` AND created_at >= $${paramIndex++}`;\r\n      params.push(options.startDate.toISOString());\r\n    }\r\n    if (options?.endDate) {\r\n      query += ` AND created_at <= $${paramIndex++}`;\r\n      params.push(options.endDate.toISOString());\r\n    }\r\n\r\n    query += ` ORDER BY created_at DESC LIMIT $${paramIndex}`;\r\n    params.push(limit);\r\n\r\n    const result = await (db as any).pool.query(query, params);\r\n    return result.rows.map((row: any) => ({\r\n      ...row,\r\n      amount_wei: stringToBigint(row.amount_wei),\r\n      previous_balance_wei: stringToBigint(row.previous_balance_wei),\r\n      new_balance_wei: stringToBigint(row.new_balance_wei),\r\n      created_at: new Date(row.created_at),\r\n    }));\r\n  } else {\r\n    let query = 'SELECT * FROM settlement_audit_logs WHERE action = ?';\r\n    const params: any[] = [action];\r\n\r\n    if (options?.batchId) {\r\n      query += ' AND batch_id = ?';\r\n      params.push(options.batchId);\r\n    }\r\n    if (options?.escrowId) {\r\n      query += ' AND escrow_id = ?';\r\n      params.push(options.escrowId);\r\n    }\r\n    if (options?.startDate) {\r\n      query += ' AND created_at >= ?';\r\n      params.push(options.startDate.toISOString());\r\n    }\r\n    if (options?.endDate) {\r\n      query += ' AND created_at <= ?';\r\n      params.push(options.endDate.toISOString());\r\n    }\r\n\r\n    query += ' ORDER BY created_at DESC LIMIT ?';\r\n    params.push(limit);\r\n\r\n    const rows = (db as any).prepare(query).all(...params);\r\n    return rows.map((row: any) => ({\r\n      ...row,\r\n      amount_wei: stringToBigint(row.amount_wei),\r\n      previous_balance_wei: stringToBigint(row.previous_balance_wei),\r\n      new_balance_wei: stringToBigint(row.new_balance_wei),\r\n      created_at: new Date(row.created_at),\r\n    }));\r\n  }\r\n}\r\n\r\n/**\r\n * Get all audit logs with pagination\r\n */\r\nexport async function getAllAuditLogs(options?: {\r\n  startDate?: Date;\r\n  endDate?: Date;\r\n  action?: AuditAction;\r\n  limit?: number;\r\n  offset?: number;\r\n}): Promise<SettlementAuditLog[]> {\r\n  const db = getDb();\r\n  const limit = options?.limit ?? 100;\r\n  const offset = options?.offset ?? 0;\r\n\r\n  if (isPostgres(db)) {\r\n    let query = 'SELECT * FROM settlement_audit_logs WHERE 1=1';\r\n    const params: any[] = [];\r\n    let paramIndex = 1;\r\n\r\n    if (options?.action) {\r\n      query += ` AND action = $${paramIndex++}`;\r\n      params.push(options.action);\r\n    }\r\n    if (options?.startDate) {\r\n      query += ` AND created_at >= $${paramIndex++}`;\r\n      params.push(options.startDate.toISOString());\r\n    }\r\n    if (options?.endDate) {\r\n      query += ` AND created_at <= $${paramIndex++}`;\r\n      params.push(options.endDate.toISOString());\r\n    }\r\n\r\n    query += ` ORDER BY created_at DESC LIMIT $${paramIndex++} OFFSET $${paramIndex}`;\r\n    params.push(limit, offset);\r\n\r\n    const result = await (db as any).pool.query(query, params);\r\n    return result.rows.map((row: any) => ({\r\n      ...row,\r\n      amount_wei: stringToBigint(row.amount_wei),\r\n      previous_balance_wei: stringToBigint(row.previous_balance_wei),\r\n      new_balance_wei: stringToBigint(row.new_balance_wei),\r\n      created_at: new Date(row.created_at),\r\n    }));\r\n  } else {\r\n    let query = 'SELECT * FROM settlement_audit_logs WHERE 1=1';\r\n    const params: any[] = [];\r\n\r\n    if (options?.action) {\r\n      query += ' AND action = ?';\r\n      params.push(options.action);\r\n    }\r\n    if (options?.startDate) {\r\n      query += ' AND created_at >= ?';\r\n      params.push(options.startDate.toISOString());\r\n    }\r\n    if (options?.endDate) {\r\n      query += ' AND created_at <= ?';\r\n      params.push(options.endDate.toISOString());\r\n    }\r\n\r\n    query += ' ORDER BY created_at DESC LIMIT ? OFFSET ?';\r\n    params.push(limit, offset);\r\n\r\n    const rows = (db as any).prepare(query).all(...params);\r\n    return rows.map((row: any) => ({\r\n      ...row,\r\n      amount_wei: stringToBigint(row.amount_wei),\r\n      previous_balance_wei: stringToBigint(row.previous_balance_wei),\r\n      new_balance_wei: stringToBigint(row.new_balance_wei),\r\n      created_at: new Date(row.created_at),\r\n    }));\r\n  }\r\n}\r\n\r\n\r\n"],"names":[],"mappings":"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"}
module.exports=[71601,e=>{"use strict";function t(e,a=5){let r=e.getTime(),i=60*a*1e3;return new Date(Math.floor(r/i)*i)}function a(e,t=new Date){return(t.getTime()-e.getTime())/6e4}e.s(["getWindowStart",()=>t,"minutesSince",()=>a])},16114,e=>e.a(async(t,a)=>{try{var r=e.i(24924),i=e.i(71601),n=t([r]);async function o(e){let t=(0,r.getDb)(),a=(0,i.getWindowStart)(new Date);(0,r.isPostgres)(t)?await t.pool.query(`INSERT INTO anomaly_metric_buffer 
       (facilitator_id, chain_id, window_start, request_count, error_count, 
        latency_sum, latency_count, max_gas_price, last_updated_at)
       VALUES ($1, $2, $3, 1, $4, $5, 1, $6, current_timestamp)
       ON CONFLICT (facilitator_id, chain_id) DO UPDATE SET
         request_count = anomaly_metric_buffer.request_count + 1,
         error_count = anomaly_metric_buffer.error_count + $4,
         latency_sum = anomaly_metric_buffer.latency_sum + $5,
         latency_count = anomaly_metric_buffer.latency_count + 1,
         max_gas_price = GREATEST(anomaly_metric_buffer.max_gas_price, COALESCE($6, 0)),
         last_updated_at = current_timestamp`,[e.facilitator_id,e.chain_id,a,+!e.success,e.latency_ms,e.gas_price_gwei||0]):t.prepare(`SELECT * FROM anomaly_metric_buffer 
       WHERE facilitator_id = ? AND chain_id = ?`).get(e.facilitator_id,e.chain_id)?t.prepare(`UPDATE anomaly_metric_buffer SET
         request_count = request_count + 1,
         error_count = error_count + ?,
         latency_sum = latency_sum + ?,
         latency_count = latency_count + 1,
         max_gas_price = MAX(max_gas_price, ?),
         last_updated_at = datetime('now')
         WHERE facilitator_id = ? AND chain_id = ?`).run(+!e.success,e.latency_ms,e.gas_price_gwei||0,e.facilitator_id,e.chain_id):t.prepare(`INSERT INTO anomaly_metric_buffer 
         (facilitator_id, chain_id, window_start, request_count, error_count,
          latency_sum, latency_count, max_gas_price, last_updated_at)
         VALUES (?, ?, ?, 1, ?, ?, 1, ?, datetime('now'))`).run(e.facilitator_id,e.chain_id,a.toISOString(),+!e.success,e.latency_ms,e.gas_price_gwei||0)}async function c(e,t){let a=(0,r.getDb)();if((0,r.isPostgres)(a)){let r=await a.pool.query(`SELECT * FROM anomaly_metric_buffer 
       WHERE facilitator_id = $1 AND chain_id = $2`,[e,t]);return 0===r.rows.length?null:h(r.rows[0])}{let r=a.prepare(`SELECT * FROM anomaly_metric_buffer 
       WHERE facilitator_id = ? AND chain_id = ?`).get(e,t);return r?h(r):null}}async function s(e=10){let t=(0,r.getDb)();if((0,r.isPostgres)(t))return(await t.pool.query(`SELECT * FROM anomaly_metric_buffer 
       WHERE last_updated_at > current_timestamp - interval '${e} minutes'`)).rows.map(h);{let a=new Date(Date.now()-6e4*e).toISOString();return t.prepare(`SELECT * FROM anomaly_metric_buffer 
       WHERE last_updated_at > ?`).all(a).map(h)}}async function _(e,t){let a=(0,r.getDb)();(0,r.isPostgres)(a)?await a.pool.query(`DELETE FROM anomaly_metric_buffer 
       WHERE facilitator_id = $1 AND chain_id = $2`,[e,t]):a.prepare(`DELETE FROM anomaly_metric_buffer 
       WHERE facilitator_id = ? AND chain_id = ?`).run(e,t)}async function l(e){let t=(0,r.getDb)(),a=crypto.randomUUID();if((0,r.isPostgres)(t)){let r=await t.pool.query(`INSERT INTO facilitator_anomalies 
       (id, facilitator_id, chain_id, window_start, window_end, request_count, 
        error_count, avg_latency_ms, max_gas_price_gwei, status, created_at)
       VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, current_timestamp)
       RETURNING *`,[a,e.facilitator_id,e.chain_id,e.window_start,e.window_end,e.request_count,e.error_count,e.avg_latency_ms,e.max_gas_price_gwei||null,e.status]);return w(r.rows[0])}{t.prepare(`INSERT INTO facilitator_anomalies 
       (id, facilitator_id, chain_id, window_start, window_end, request_count,
        error_count, avg_latency_ms, max_gas_price_gwei, status, created_at)
       VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now'))`).run(a,e.facilitator_id,e.chain_id,e.window_start.toISOString(),e.window_end.toISOString(),e.request_count,e.error_count,e.avg_latency_ms,e.max_gas_price_gwei||null,e.status);let r=t.prepare("SELECT * FROM facilitator_anomalies WHERE id = ?").get(a);return w(r)}}async function u(e,t,a=5){let i=(0,r.getDb)();return(0,r.isPostgres)(i)?(await i.pool.query(`SELECT * FROM facilitator_anomalies 
       WHERE facilitator_id = $1 AND chain_id = $2
       ORDER BY window_end DESC LIMIT $3`,[e,t,a])).rows.map(w):i.prepare(`SELECT * FROM facilitator_anomalies 
       WHERE facilitator_id = ? AND chain_id = ?
       ORDER BY window_end DESC LIMIT ?`).all(e,t,a).map(w)}async function d(e,t){let a=(0,r.getDb)();if((0,r.isPostgres)(a)){let r=await a.pool.query(`SELECT * FROM facilitator_circuit_breakers 
       WHERE facilitator_id = $1 AND chain_id = $2`,[e,t]);if(r.rows.length>0)return E(r.rows[0]);let i=crypto.randomUUID(),n=await a.pool.query(`INSERT INTO facilitator_circuit_breakers 
       (id, facilitator_id, chain_id, state, last_changed_at)
       VALUES ($1, $2, $3, 'CLOSED', current_timestamp)
       RETURNING *`,[i,e,t]);return E(n.rows[0])}{let r=a.prepare(`SELECT * FROM facilitator_circuit_breakers 
       WHERE facilitator_id = ? AND chain_id = ?`).get(e,t);if(r)return E(r);let i=crypto.randomUUID();a.prepare(`INSERT INTO facilitator_circuit_breakers 
       (id, facilitator_id, chain_id, state, last_changed_at)
       VALUES (?, ?, ?, 'CLOSED', datetime('now'))`).run(i,e,t);let n=a.prepare("SELECT * FROM facilitator_circuit_breakers WHERE id = ?").get(i);return E(n)}}async function f(e){let t=(0,r.getDb)();(0,r.isPostgres)(t)?await t.pool.query(`UPDATE facilitator_circuit_breakers 
       SET state = $1, opened_at = $2, half_opened_at = $3, last_changed_at = current_timestamp
       WHERE facilitator_id = $4 AND chain_id = $5`,[e.state,e.opened_at||null,e.half_opened_at||null,e.facilitator_id,e.chain_id]):t.prepare(`UPDATE facilitator_circuit_breakers 
       SET state = ?, opened_at = ?, half_opened_at = ?, last_changed_at = datetime('now')
       WHERE facilitator_id = ? AND chain_id = ?`).run(e.state,e.opened_at?.toISOString()||null,e.half_opened_at?.toISOString()||null,e.facilitator_id,e.chain_id)}async function p(e){let t=(0,r.getDb)(),a=crypto.randomUUID(),i=JSON.stringify(e.metrics_snapshot);if((0,r.isPostgres)(t)){let r=await t.pool.query(`INSERT INTO circuit_breaker_events 
       (id, facilitator_id, chain_id, old_state, new_state, reason, 
        metrics_snapshot, created_at)
       VALUES ($1, $2, $3, $4, $5, $6, $7, current_timestamp)
       RETURNING *`,[a,e.facilitator_id,e.chain_id,e.old_state,e.new_state,e.reason,i]);return y(r.rows[0])}{t.prepare(`INSERT INTO circuit_breaker_events 
       (id, facilitator_id, chain_id, old_state, new_state, reason,
        metrics_snapshot, created_at)
       VALUES (?, ?, ?, ?, ?, ?, ?, datetime('now'))`).run(a,e.facilitator_id,e.chain_id,e.old_state,e.new_state,e.reason,i);let r=t.prepare("SELECT * FROM circuit_breaker_events WHERE id = ?").get(a);return y(r)}}async function m(e,t){let a=(0,r.getDb)();(0,r.isPostgres)(a)?await a.pool.query(`UPDATE circuit_breaker_events 
       SET notification_sent = 1, notification_error = $1
       WHERE id = $2`,[t||null,e]):a.prepare(`UPDATE circuit_breaker_events 
       SET notification_sent = 1, notification_error = ?
       WHERE id = ?`).run(t||null,e)}async function g(e){let t=(0,r.getDb)();if((0,r.isPostgres)(t)){let a=await t.pool.query("SELECT callback_url FROM facilitators WHERE id = $1",[e]);return a.rows[0]?.callback_url||null}{let a=t.prepare("SELECT callback_url FROM facilitators WHERE id = ?").get(e);return a?.callback_url||null}}function h(e){return{facilitator_id:e.facilitator_id,chain_id:e.chain_id,window_start:new Date(e.window_start),request_count:e.request_count,error_count:e.error_count,latency_sum:e.latency_sum,latency_count:e.latency_count,max_gas_price:e.max_gas_price||0,last_updated_at:new Date(e.last_updated_at)}}function w(e){return{id:e.id,facilitator_id:e.facilitator_id,chain_id:e.chain_id,window_start:new Date(e.window_start),window_end:new Date(e.window_end),request_count:e.request_count,error_count:e.error_count,avg_latency_ms:e.avg_latency_ms,max_gas_price_gwei:e.max_gas_price_gwei,status:e.status,created_at:new Date(e.created_at)}}function E(e){return{id:e.id,facilitator_id:e.facilitator_id,chain_id:e.chain_id,state:e.state,opened_at:e.opened_at?new Date(e.opened_at):null,half_opened_at:e.half_opened_at?new Date(e.half_opened_at):null,last_changed_at:new Date(e.last_changed_at)}}function y(e){return{id:e.id,facilitator_id:e.facilitator_id,chain_id:e.chain_id,old_state:e.old_state,new_state:e.new_state,reason:e.reason,metrics_snapshot:e.metrics_snapshot,notification_sent:e.notification_sent,notification_error:e.notification_error,created_at:new Date(e.created_at)}}[r]=n.then?(await n)():n,e.s(["clearBufferMetrics",()=>_,"getActiveBuffers",()=>s,"getBufferMetrics",()=>c,"getFacilitatorCallbackUrl",()=>g,"getOrCreateCircuitBreaker",()=>d,"getRecentAnomalyWindows",()=>u,"markNotificationSent",()=>m,"recordCircuitBreakerEvent",()=>p,"recordMetricInBuffer",()=>o,"recordWindowMetrics",()=>l,"updateCircuitBreakerState",()=>f]),a()}catch(e){a(e)}},!1),18517,e=>{"use strict";function t(e){switch(e){case"OPEN":return"Investigate facilitator health; receiving 0% traffic until recovery";case"HALF_OPEN":return"Testing recovery; receiving 5% probe traffic";case"CLOSED":return"Recovered to normal; back to full routing";default:return"Unknown state"}}e.s(["DEFAULT_ANOMALY_THRESHOLDS",0,{error_rate_anomalous:.5,error_rate_suspect:.3,latency_ms_anomalous:2e3,latency_ms_suspect:1500,gas_price_gwei_anomalous:150,gas_price_gwei_suspect:100,min_request_threshold:50},"DEFAULT_CB_CONFIG",0,{cooldown_minutes:5,half_open_recovery_window_minutes:10,recovery_success_threshold:2,half_open_probe_share:.05},"getActionRequired",()=>t])},91670,e=>e.a(async(t,a)=>{try{var r=e.i(50377),i=e.i(71601),n=e.i(16114),o=e.i(18517),c=t([n]);[n]=c.then?(await c)():c;let _=(0,r.createLogger)({component:"AnomalyDetector"});class l{thresholds;cbConfig;constructor(e,t){this.thresholds={...o.DEFAULT_ANOMALY_THRESHOLDS,...e},this.cbConfig={...o.DEFAULT_CB_CONFIG,...t}}async recordMetric(e){try{await (0,n.recordMetricInBuffer)(e)}catch(t){_.warn({error:t,facilitator_id:e.facilitator_id,chain_id:e.chain_id},"Failed to record metric")}}async closeAndEvaluateWindow(e,t){let a=await (0,n.getBufferMetrics)(e,t);if(!a||0===a.request_count)return null;let r=new Date,i=a.window_start,o=a.latency_count>0?a.latency_sum/a.latency_count:0,c=this.classifyWindow({request_count:a.request_count,error_count:a.error_count,avg_latency_ms:o,max_gas_price_gwei:a.max_gas_price}),s={facilitator_id:e,chain_id:t,window_start:i,window_end:r,request_count:a.request_count,error_count:a.error_count,avg_latency_ms:o,max_gas_price_gwei:a.max_gas_price,status:c};await (0,n.recordWindowMetrics)(s),_.info({facilitator_id:e,chain_id:t,status:c,request_count:a.request_count,error_rate:a.error_count/a.request_count,avg_latency_ms:o},"Window evaluated");let l=await this.updateCircuitBreakerState(e,t,c,s);return await (0,n.clearBufferMetrics)(e,t),l}classifyWindow(e){if(e.request_count<this.thresholds.min_request_threshold)return"normal";let t=e.error_count/e.request_count;return t>this.thresholds.error_rate_anomalous||e.avg_latency_ms>this.thresholds.latency_ms_anomalous||e.max_gas_price_gwei>this.thresholds.gas_price_gwei_anomalous?"anomalous":t>this.thresholds.error_rate_suspect||e.avg_latency_ms>this.thresholds.latency_ms_suspect||e.max_gas_price_gwei>this.thresholds.gas_price_gwei_suspect?"suspect":"normal"}async updateCircuitBreakerState(e,t,a,r){let o=await (0,n.getOrCreateCircuitBreaker)(e,t),c=new Date,s=o.state,l="";if("CLOSED"===o.state)"anomalous"===a&&(s="OPEN",l="anomalous_metrics_detected",_.warn({facilitator_id:e,chain_id:t,metrics:{error_rate:r.error_count/r.request_count,avg_latency_ms:r.avg_latency_ms,max_gas_price_gwei:r.max_gas_price_gwei}},"Opening circuit breaker"));else if("OPEN"===o.state){if(o.opened_at){let a=(0,i.minutesSince)(o.opened_at,c);a>=this.cbConfig.cooldown_minutes&&(s="HALF_OPEN",l="cooldown_expired_attempting_recovery",_.info({facilitator_id:e,chain_id:t,minutes_in_open:a},"Circuit breaker moving to HALF_OPEN"))}}else if("HALF_OPEN"===o.state){if("anomalous"===a)s="OPEN",l="recovery_failed_anomalous_metrics",_.warn({facilitator_id:e,chain_id:t},"Recovery failed, reopening circuit");else if("normal"===a){let a=(await (0,n.getRecentAnomalyWindows)(e,t,this.cbConfig.recovery_success_threshold)).filter(e=>"normal"===e.status).length;a>=this.cbConfig.recovery_success_threshold?(s="CLOSED",l="recovery_succeeded",_.info({facilitator_id:e,chain_id:t,consecutive_normal:a},"Circuit breaker recovered to CLOSED")):o.half_opened_at&&(0,i.minutesSince)(o.half_opened_at,c)>=this.cbConfig.half_open_recovery_window_minutes&&(s="OPEN",l="recovery_window_expired_insufficient_successes",_.warn({facilitator_id:e,chain_id:t,consecutive_normal:a,required:this.cbConfig.recovery_success_threshold},"Recovery window expired"))}}if(s!==o.state){await (0,n.updateCircuitBreakerState)({facilitator_id:e,chain_id:t,state:s,opened_at:"OPEN"===s?c:"OPEN"===o.state?o.opened_at:null,half_opened_at:"HALF_OPEN"===s?c:null});let i=await (0,n.recordCircuitBreakerEvent)({facilitator_id:e,chain_id:t,old_state:o.state,new_state:s,reason:l,metrics_snapshot:{status:a,request_count:r.request_count,error_count:r.error_count,error_rate:r.request_count>0?r.error_count/r.request_count:0,avg_latency_ms:r.avg_latency_ms,max_gas_price_gwei:r.max_gas_price_gwei,time:c.toISOString()}});return this.notifyFacilitatorOfStateChange(e,t,o.state,s,l,i.id,r).catch(t=>{_.warn({err:t,facilitator_id:e},"Failed to send webhook notification")}),i}return null}async notifyFacilitatorOfStateChange(e,t,a,r,i,c,s){try{let l=await (0,n.getFacilitatorCallbackUrl)(e);if(!l)return;let u={event:"circuit_breaker_state_changed",timestamp:new Date().toISOString(),facilitator_id:e,chain_id:t,old_state:a,new_state:r,reason:i,action_required:(0,o.getActionRequired)(r),metrics:{error_rate:s.request_count>0?s.error_count/s.request_count:0,avg_latency_ms:s.avg_latency_ms,max_gas_price_gwei:s.max_gas_price_gwei}},d=new AbortController,f=setTimeout(()=>d.abort(),5e3),p=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u),signal:d.signal});if(clearTimeout(f),!p.ok)throw Error(`Callback returned ${p.status}`);await (0,n.markNotificationSent)(c),_.info({facilitator_id:e,chain_id:t,old_state:a,new_state:r},"Webhook notification sent")}catch(r){let a=r instanceof Error?r.message:"Unknown error";_.warn({facilitator_id:e,chain_id:t,error:a},"Failed to notify facilitator"),await (0,n.markNotificationSent)(c,a)}}async getCircuitBreakerState(e,t){return(await (0,n.getOrCreateCircuitBreaker)(e,t)).state}async getCircuitBreaker(e,t){return(0,n.getOrCreateCircuitBreaker)(e,t)}getConfig(){return{thresholds:this.thresholds,cbConfig:this.cbConfig}}}let u=null;function s(){return u||(u=new l),u}e.s(["getAnomalyDetector",()=>s]),a()}catch(e){a(e)}},!1),26872,e=>e.a(async(t,a)=>{try{var r=e.i(50377),i=e.i(7484),n=e.i(91670),o=e.i(16114),c=t([i,n,o]);[i,n,o]=c.then?(await c)():c;let _=(0,r.createLogger)({component:"AnomalyEvaluationCron"});async function s(e,t){let{runId:a,requestId:r}=t;_.info({runId:a,requestId:r},"Starting anomaly evaluation job");let i=(0,n.getAnomalyDetector)(),c=[];try{let e=await (0,o.getActiveBuffers)(10);if(0===e.length)return _.info({runId:a,requestId:r},"No active metric buffers to evaluate"),{success:!0,facilitators_evaluated:0,cb_events_triggered:0,timestamp:new Date().toISOString()};let t=0,n=0;for(let r of e)try{let e=await i.closeAndEvaluateWindow(r.facilitator_id,r.chain_id);t++,e&&(n++,_.info({runId:a,facilitator_id:r.facilitator_id,chain_id:r.chain_id,old_state:e.old_state,new_state:e.new_state,reason:e.reason},"Circuit breaker state changed"))}catch(t){let e=`${r.facilitator_id}/${r.chain_id}: ${t instanceof Error?t.message:"Unknown error"}`;c.push(e),_.error({runId:a,facilitator_id:r.facilitator_id,chain_id:r.chain_id,error:t},"Failed to evaluate anomaly window")}return _.info({runId:a,requestId:r,facilitators_evaluated:t,cb_events_triggered:n,errors_count:c.length},"Anomaly evaluation job completed"),{success:0===c.length,facilitators_evaluated:t,cb_events_triggered:n,timestamp:new Date().toISOString(),errors:c.length>0?c:void 0}}catch(t){let e=t instanceof Error?t.message:"Unknown error";return _.error({runId:a,requestId:r,error:t},"Anomaly evaluation job failed"),{success:!1,facilitators_evaluated:0,cb_events_triggered:0,timestamp:new Date().toISOString(),errors:[e]}}}let l=(0,i.withCronJobTracking)(s,{jobId:"evaluate-anomalies",enabledEnvVar:"ANOMALY_EVALUATION_ENABLED",timeout:55e3,minInterval:24e4});e.s(["GET",0,l,"dynamic",0,"force-dynamic","maxDuration",0,60]),a()}catch(e){a(e)}},!1),5825,e=>e.a(async(t,a)=>{try{var r=e.i(47909),i=e.i(74017),n=e.i(96250),o=e.i(59756),c=e.i(61916),s=e.i(14444),_=e.i(37092),l=e.i(69741),u=e.i(16795),d=e.i(87718),f=e.i(95169),p=e.i(47587),m=e.i(66012),g=e.i(70101),h=e.i(26937),w=e.i(10372),E=e.i(93695);e.i(52474);var y=e.i(220),R=e.i(26872),v=t([R]);[R]=v.then?(await v)():v;let b=new r.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/cron/evaluate-anomalies/route",pathname:"/api/cron/evaluate-anomalies",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/cron/evaluate-anomalies/route.ts",nextConfigOutput:"standalone",userland:R}),{workAsyncStorage:O,workUnitAsyncStorage:T,serverHooks:A}=b;function S(){return(0,n.patchFetch)({workAsyncStorage:O,workUnitAsyncStorage:T})}async function C(e,t,a){b.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/cron/evaluate-anomalies/route";r=r.replace(/\/index$/,"")||"/";let n=await b.prepare(e,t,{srcPage:r,multiZoneDraftMode:!1});if(!n)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:R,params:v,nextConfig:S,parsedUrl:C,isDraftMode:O,prerenderManifest:T,routerServerContext:A,isOnDemandRevalidate:D,revalidateOnlyGenerated:N,resolvedPathname:q,clientReferenceManifest:I,serverActionsManifest:k}=n,x=(0,l.normalizeAppPath)(r),$=!!(T.dynamicRoutes[x]||T.routes[q]),L=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,C,!1):t.end("This page could not be found"),null);if($&&!O){let e=!!T.routes[q],t=T.dynamicRoutes[x];if(t&&!1===t.fallback&&!e){if(S.experimental.adapterPath)return await L();throw new E.NoFallbackError}}let P=null;!$||b.isDev||O||(P=q,P="/index"===P?"/":P);let U=!0===b.isDev||!$,M=$&&!U;k&&I&&(0,s.setReferenceManifestsSingleton)({page:r,clientReferenceManifest:I,serverActionsManifest:k,serverModuleMap:(0,_.createServerModuleMap)({serverActionsManifest:k})});let H=e.method||"GET",F=(0,c.getTracer)(),W=F.getActiveScopeSpan(),B={params:v,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!S.experimental.authInterrupts},cacheComponents:!!S.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:S.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>b.onRequestError(e,t,r,A)},sharedContext:{buildId:R}},V=new u.NodeNextRequest(e),j=new u.NodeNextResponse(t),G=d.NextRequestAdapter.fromNodeNextRequest(V,(0,d.signalFromNodeResponse)(t));try{let n=async e=>b.handle(G,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=F.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==f.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=a.get("next.route");if(i){let t=`${H} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${r}`)}),s=!!(0,o.getRequestMeta)(e,"minimalMode"),_=async o=>{var c,_;let l=async({previousCacheEntry:i})=>{try{if(!s&&D&&N&&!i)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await n(o);e.fetchMetrics=B.renderOpts.fetchMetrics;let c=B.renderOpts.pendingWaitUntil;c&&a.waitUntil&&(a.waitUntil(c),c=void 0);let _=B.renderOpts.collectedTags;if(!$)return await (0,m.sendResponse)(V,j,r,B.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(r.headers);_&&(t[w.NEXT_CACHE_TAGS_HEADER]=_),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,i=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:i}}}}catch(t){throw(null==i?void 0:i.isStale)&&await b.onRequestError(e,t,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:D})},A),t}},u=await b.handleResponse({req:e,nextConfig:S,cacheKey:P,routeKind:i.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:D,revalidateOnlyGenerated:N,responseGenerator:l,waitUntil:a.waitUntil,isMinimalMode:s});if(!$)return null;if((null==u||null==(c=u.value)?void 0:c.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(_=u.value)?void 0:_.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",D?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),O&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,g.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&$||d.delete(w.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,h.getCacheControlHeader)(u.cacheControl)),await (0,m.sendResponse)(V,j,new Response(u.value.body,{headers:d,status:u.value.status||200})),null};W?await _(W):await F.withPropagatedContext(e.headers,()=>F.trace(f.BaseServerSpan.handleRequest,{spanName:`${H} ${r}`,kind:c.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},_))}catch(t){if(t instanceof E.NoFallbackError||await b.onRequestError(e,t,{routerKind:"App Router",routePath:x,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:D})}),$)throw t;return await (0,m.sendResponse)(V,j,new Response(null,{status:500})),null}}e.s(["handler",()=>C,"patchFetch",()=>S,"routeModule",()=>b,"serverHooks",()=>A,"workAsyncStorage",()=>O,"workUnitAsyncStorage",()=>T]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=_2b9ba9c9._.js.map
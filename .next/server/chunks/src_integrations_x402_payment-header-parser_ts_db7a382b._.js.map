{"version":3,"sources":["../../../src/integrations/x402/payment-header-parser.ts"],"sourcesContent":["import { getCDPFacilitator, type CDPVerifyRequest } from './cdp-facilitator';\r\nimport type { PaymentAuthorization } from './signature-verifier';\r\n\r\n/**\r\n * Parsed x402 payment header structure\r\n */\r\nexport interface ParsedPaymentHeader {\r\n  invoiceId: string;\r\n  txHash?: string;\r\n  signature: string;\r\n  authorization: PaymentAuthorization;\r\n  network?: string;\r\n}\r\n\r\n/**\r\n * Parse x402 payment header from HTTP header value\r\n * \r\n * x402 payment headers are typically base64-encoded JSON containing:\r\n * - signature: EIP-712 signature\r\n * - authorization: Payment authorization object\r\n * - network: Blockchain network identifier\r\n * \r\n * Format: x402 <base64-encoded-json>\r\n */\r\nexport function parseX402Header(headerValue: string): {\r\n  valid: boolean;\r\n  parsed?: ParsedPaymentHeader;\r\n  error?: string;\r\n} {\r\n  try {\r\n    // Validate header is not empty\r\n    if (!headerValue || headerValue.trim().length === 0) {\r\n      return { valid: false, error: 'Payment header is empty' };\r\n    }\r\n\r\n    // Check for placeholder values\r\n    if (headerValue.includes('<your_payment_header>') || headerValue.includes('<placeholder>')) {\r\n      return { valid: false, error: 'Payment header contains placeholder value. Please provide a real x402 payment header.' };\r\n    }\r\n\r\n    // Remove 'x402 ' prefix if present\r\n    const cleanHeader = headerValue.startsWith('x402 ')\r\n      ? headerValue.slice(5).trim()\r\n      : headerValue.trim();\r\n\r\n    if (cleanHeader.length === 0) {\r\n      return { valid: false, error: 'Payment header value is empty after removing prefix' };\r\n    }\r\n\r\n    // Decode base64 (works in both Node.js and browser environments)\r\n    let decoded: string;\r\n    try {\r\n      decoded = typeof window === 'undefined'\r\n        ? Buffer.from(cleanHeader, 'base64').toString('utf-8')\r\n        : atob(cleanHeader);\r\n    } catch (base64Error) {\r\n      return { \r\n        valid: false, \r\n        error: `Invalid base64 encoding: ${base64Error instanceof Error ? base64Error.message : 'Failed to decode base64'}` \r\n      };\r\n    }\r\n\r\n    // Parse JSON\r\n    let payload: {\r\n      signature?: string;\r\n      authorization?: {\r\n        from?: string;\r\n        to?: string;\r\n        value?: string;\r\n        validAfter?: string;\r\n        validBefore?: string;\r\n        nonce?: string;\r\n      };\r\n      network?: string;\r\n      invoiceId?: string;\r\n      txHash?: string;\r\n    };\r\n    \r\n    try {\r\n      payload = JSON.parse(decoded);\r\n    } catch (jsonError) {\r\n      return { \r\n        valid: false, \r\n        error: `Invalid JSON in payment header: ${jsonError instanceof Error ? jsonError.message : 'Failed to parse JSON'}. Decoded value: ${decoded.substring(0, 100)}` \r\n      };\r\n    }\r\n\r\n    // Validate required fields\r\n    if (!payload.signature) {\r\n      return { valid: false, error: 'Missing signature in payment header' };\r\n    }\r\n\r\n    if (!payload.authorization) {\r\n      return { valid: false, error: 'Missing authorization in payment header' };\r\n    }\r\n\r\n    const auth = payload.authorization;\r\n    if (!auth.from || !auth.to || !auth.value || !auth.nonce) {\r\n      return { valid: false, error: 'Incomplete authorization fields' };\r\n    }\r\n\r\n    return {\r\n      valid: true,\r\n      parsed: {\r\n        invoiceId: payload.invoiceId || auth.nonce,\r\n        txHash: payload.txHash,\r\n        signature: payload.signature,\r\n        authorization: {\r\n          from: auth.from as `0x${string}`,\r\n          to: auth.to as `0x${string}`,\r\n          value: auth.value,\r\n          validAfter: auth.validAfter || Math.floor(Date.now() / 1000).toString(),\r\n          validBefore: auth.validBefore || (Math.floor(Date.now() / 1000) + 300).toString(),\r\n          nonce: auth.nonce,\r\n        },\r\n        network: payload.network || 'base',\r\n      },\r\n    };\r\n  } catch (error) {\r\n    return {\r\n      valid: false,\r\n      error: error instanceof Error ? error.message : 'Failed to parse payment header',\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Parse and verify x402 payment header with CDP facilitator\r\n * \r\n * This function:\r\n * 1. Parses the payment header\r\n * 2. Verifies the payment with CDP\r\n * 3. Returns the verification result\r\n */\r\nexport async function parseAndVerifyPaymentHeader(\r\n  headerValue: string\r\n): Promise<{\r\n  valid: boolean;\r\n  payment?: ParsedPaymentHeader;\r\n  transactionHash?: string;\r\n  error?: string;\r\n}> {\r\n  try {\r\n    // Parse the header\r\n    const parseResult = parseX402Header(headerValue);\r\n    if (!parseResult.valid || !parseResult.parsed) {\r\n      return {\r\n        valid: false,\r\n        error: parseResult.error || 'Invalid payment header format',\r\n      };\r\n    }\r\n\r\n    const parsed = parseResult.parsed;\r\n\r\n    // Create CDP verify request\r\n    const verifyRequest: CDPVerifyRequest = {\r\n      payment: headerValue,\r\n      paymentPayload: {\r\n        x402Version: 1,\r\n        scheme: 'x402',\r\n        network: parsed.network || 'base',\r\n        payload: {\r\n          signature: parsed.signature,\r\n          authorization: parsed.authorization,\r\n        },\r\n      },\r\n    };\r\n\r\n    // Verify with CDP\r\n    const cdp = getCDPFacilitator();\r\n    const verifyResult = await cdp.verifyPayment(verifyRequest);\r\n\r\n    if (!verifyResult.valid || !verifyResult.success) {\r\n      return {\r\n        valid: false,\r\n        error: verifyResult.error || 'Payment verification failed',\r\n      };\r\n    }\r\n\r\n    return {\r\n      valid: true,\r\n      payment: parsed,\r\n      transactionHash: verifyResult.transactionHash,\r\n    };\r\n  } catch (error) {\r\n    return {\r\n      valid: false,\r\n      error: error instanceof Error ? error.message : 'Unknown error',\r\n    };\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":"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"}
module.exports=[93695,(e,t,a)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},22734,(e,t,a)=>{t.exports=e.x("fs",()=>require("fs"))},30056,e=>e.a(async(t,a)=>{try{let t=await e.y("pg");e.n(t),a()}catch(e){a(e)}},!0),14747,(e,t,a)=>{t.exports=e.x("path",()=>require("path"))},70406,(e,t,a)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},18622,(e,t,a)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},24361,(e,t,a)=>{t.exports=e.x("util",()=>require("util"))},87769,(e,t,a)=>{t.exports=e.x("node:events",()=>require("node:events"))},49719,(e,t,a)=>{t.exports=e.x("assert",()=>require("assert"))},27699,(e,t,a)=>{t.exports=e.x("events",()=>require("events"))},92509,(e,t,a)=>{t.exports=e.x("url",()=>require("url"))},874,(e,t,a)=>{t.exports=e.x("buffer",()=>require("buffer"))},62562,(e,t,a)=>{t.exports=e.x("module",()=>require("module"))},50227,(e,t,a)=>{t.exports=e.x("node:path",()=>require("node:path"))},94346,e=>{e.v({name:"thread-stream",version:"3.1.0",description:"A streaming way to send data to a Node.js Worker Thread",main:"index.js",types:"index.d.ts",dependencies:{"real-require":"^0.2.0"},devDependencies:{"@types/node":"^20.1.0","@types/tap":"^15.0.0","@yao-pkg/pkg":"^5.11.5",desm:"^1.3.0",fastbench:"^1.0.1",husky:"^9.0.6","pino-elasticsearch":"^8.0.0","sonic-boom":"^4.0.1",standard:"^17.0.0",tap:"^16.2.0","ts-node":"^10.8.0",typescript:"^5.3.2","why-is-node-running":"^2.2.2"},scripts:{build:"tsc --noEmit",test:'standard && npm run build && npm run transpile && tap "test/**/*.test.*js" && tap --ts test/*.test.*ts',"test:ci":"standard && npm run transpile && npm run test:ci:js && npm run test:ci:ts","test:ci:js":'tap --no-check-coverage --timeout=120 --coverage-report=lcovonly "test/**/*.test.*js"',"test:ci:ts":'tap --ts --no-check-coverage --coverage-report=lcovonly "test/**/*.test.*ts"',"test:yarn":'npm run transpile && tap "test/**/*.test.js" --no-check-coverage',transpile:"sh ./test/ts/transpile.sh",prepare:"husky install"},standard:{ignore:["test/ts/**/*","test/syntax-error.mjs"]},repository:{type:"git",url:"git+https://github.com/mcollina/thread-stream.git"},keywords:["worker","thread","threads","stream"],author:"Matteo Collina <hello@matteocollina.com>",license:"MIT",bugs:{url:"https://github.com/mcollina/thread-stream/issues"},homepage:"https://github.com/mcollina/thread-stream#readme"})},37702,(e,t,a)=>{t.exports=e.x("worker_threads",()=>require("worker_threads"))},60526,(e,t,a)=>{t.exports=e.x("node:os",()=>require("node:os"))},77652,(e,t,a)=>{t.exports=e.x("node:diagnostics_channel",()=>require("node:diagnostics_channel"))},49565,e=>{"use strict";let t=(0,e.i(50377).createLogger)({component:"ValidateApiKey"}),a="nf_live_",r="nf_test_";async function i(e){if(!e||"string"!=typeof e)return t.debug({reason:"empty"},"API key validation failed"),null;let i=e.startsWith(a),s=e.startsWith(r);if(!i&&!s)return t.debug({reason:"invalid_prefix"},"API key validation failed"),null;let n=i?a:r;if(e.slice(n.length).length<16)return t.debug({reason:"too_short"},"API key validation failed"),null;let o=e.substring(0,20);return t.debug({id:o,isLive:i},"API key validated"),{id:o,isLive:i,valid:!0}}e.s(["validateApiKey",()=>i])},33785,e=>{"use strict";function t(e){if(!e||"object"!=typeof e||"string"!=typeof e.amount_wei||!e.amount_wei||"string"!=typeof e.token_address||!e.token_address||"string"!=typeof e.chain_id||!e.chain_id)return!1;try{if(0n>=BigInt(e.amount_wei))return!1}catch{return!1}return!0}function a(e){return!!e&&"object"==typeof e&&"string"==typeof e.payment_intent&&!!e.payment_intent&&"string"==typeof e.recipient_address&&!!e.recipient_address}function r(e){return!!e&&"object"==typeof e&&"string"==typeof e.batch_id&&!!e.batch_id&&"string"==typeof e.facilitator_id&&!!e.facilitator_id}e.s(["isValidRouteRequest",()=>t,"isValidSettleRequest",()=>r,"isValidVerifyRequest",()=>a])},42665,e=>{"use strict";var t=e.i(50377);let a={high_pending_batches:250,critical_pending_batches:500,high_pending_payments:25e3,critical_pending_payments:5e4,high_in_flight:10,critical_in_flight:25},r={normal_batch_size:100,high_batch_size_min:25,high_batch_size_max:75,critical_batch_size:0},i=(0,t.createLogger)({component:"LoadMonitor"});class s{db;thresholds;batchConfig;facilitatorMetrics;changeHandlers;constructor(e,t,i){this.db=e,this.thresholds={...a,...t},this.batchConfig={...r,...i},this.facilitatorMetrics=new Map,this.changeHandlers=[]}async getLoadMetrics(e){let t=this.facilitatorMetrics.get(e);if(t&&Date.now()-t.last_updated_at.getTime()<5e3)return t;let a=await this.queryFacilitatorMetrics(e);return t&&t.load_level!==a.load_level&&await this.notifyLevelChange({facilitator_id:e,previous_level:t.load_level,new_level:a.load_level,metrics:a,timestamp:new Date}),this.facilitatorMetrics.set(e,a),a}async queryFacilitatorMetrics(e){let t=0,a=0,r=0;try{let a=await this.db.query(`SELECT COUNT(*) as count FROM batch_settlements 
         WHERE facilitator_id = $1 AND status IN ('pending', 'queued')`,[e]);t=parseInt(a.rows[0]?.count||"0",10)}catch(t){i.debug({facilitator_id:e,error:t},"Failed to query pending batches (table may not exist)")}try{let t=await this.db.query(`SELECT COUNT(*) as count FROM batch_queue 
         WHERE facilitator_id = $1`,[e]);a=parseInt(t.rows[0]?.count||"0",10)}catch(t){i.debug({facilitator_id:e,error:t},"Failed to query pending payments (table may not exist)")}try{let t=await this.db.query(`SELECT COUNT(*) as count FROM batch_settlements 
         WHERE facilitator_id = $1 AND status = 'submitted'`,[e]);r=parseInt(t.rows[0]?.count||"0",10)}catch(t){i.debug({facilitator_id:e,error:t},"Failed to query in-flight settlements (table may not exist)")}let s=this.calculateLoadLevel(t,a,r),n=this.calculateLoadPercentage(t,a,r);return{facilitator_id:e,pending_batches:t,pending_payments:a,in_flight_settlements:r,load_level:s,load_percentage:n,last_updated_at:new Date}}async getSystemMetrics(){let e=0,t=0,a=0;try{let t=await this.db.query("SELECT COUNT(*) as count FROM batch_settlements WHERE status IN ('pending', 'queued')");e=parseInt(t.rows[0]?.count||"0",10)}catch{}try{let e=await this.db.query("SELECT COUNT(*) as count FROM batch_queue");t=parseInt(e.rows[0]?.count||"0",10)}catch{}try{let e=await this.db.query("SELECT COUNT(*) as count FROM batch_settlements WHERE status = 'submitted'");a=parseInt(e.rows[0]?.count||"0",10)}catch{}let r={normal:0,high:0,critical:0};for(let e of this.facilitatorMetrics.values()){let t=e.load_level.toLowerCase();r[t]++}let i="NORMAL";return r.critical>0?i="CRITICAL":r.high>0&&(i="HIGH"),{total_pending_batches:e,total_pending_payments:t,total_in_flight:a,facilitators_by_level:r,system_level:i,last_updated_at:new Date}}calculateLoadLevel(e,t,a){return e>=this.thresholds.critical_pending_batches||t>=this.thresholds.critical_pending_payments||a>=this.thresholds.critical_in_flight?"CRITICAL":e>=this.thresholds.high_pending_batches||t>=this.thresholds.high_pending_payments||a>=this.thresholds.high_in_flight?"HIGH":"NORMAL"}calculateLoadPercentage(e,t,a){return Math.min(100,Math.max(e/this.thresholds.critical_pending_batches*100,t/this.thresholds.critical_pending_payments*100,a/this.thresholds.critical_in_flight*100))}getAdaptiveBatchSize(e,t){if("CRITICAL"===e)return this.batchConfig.critical_batch_size;if("HIGH"===e){let e=this.batchConfig.high_batch_size_max-this.batchConfig.high_batch_size_min,a=Math.min(1,Math.max(0,(t-50)/50)),r=this.batchConfig.high_batch_size_max-a*e;return Math.max(this.batchConfig.high_batch_size_min,Math.floor(r))}return this.batchConfig.normal_batch_size}async getQueuePosition(e,t){try{let a=await this.db.query(`SELECT COUNT(*) as position FROM batch_queue 
         WHERE facilitator_id = $1 
         AND created_at < (SELECT created_at FROM batch_queue WHERE payment_id = $2)`,[e,t]);return parseInt(a.rows[0]?.position||"0",10)}catch{return 0}}async estimateWaitTime(e,t){let a=await this.getQueuePosition(e,t),r=await this.getLoadMetrics(e),i=this.getAdaptiveBatchSize(r.load_level,r.load_percentage);return i<=0?3600:30*Math.ceil((a+1)/i)}async generateBackpressureHeaders(e,t){let a=await this.getLoadMetrics(e),r=t?await this.getQueuePosition(e,t):a.pending_payments,i=t?await this.estimateWaitTime(e,t):30*Math.ceil(a.pending_payments/Math.max(1,this.getAdaptiveBatchSize(a.load_level,a.load_percentage))),s={"X-NexFlow-Load":a.load_level,"X-NexFlow-Queue-Position":r.toString(),"X-NexFlow-Estimated-Wait":i.toString()};return"HIGH"===a.load_level&&(s["X-NexFlow-Batch-Size-Reduced"]="true"),"CRITICAL"===a.load_level&&(s["X-NexFlow-Retry-After"]="60"),s}headersToRecord(e){let t={};for(let[a,r]of Object.entries(e))void 0!==r&&(t[a]=r);return t}shouldAcceptRoute(e){return"CRITICAL"===e?{accepted:!1,reason:"Facilitator at capacity. Please retry after the suggested delay.",retry_after_seconds:60}:{accepted:!0}}shouldAcceptSettlement(e){return"CRITICAL"===e?{accepted:!1,reason:"System overloaded. Settlement temporarily paused.",retry_after_seconds:60}:{accepted:!0}}onLevelChange(e){this.changeHandlers.push(e)}async notifyLevelChange(e){for(let t of(i.info({facilitator_id:e.facilitator_id,previous_level:e.previous_level,new_level:e.new_level,load_percentage:e.metrics.load_percentage},"Load level changed"),this.changeHandlers))try{await t(e)}catch(t){i.error({error:t,facilitator_id:e.facilitator_id},"Load change handler failed")}}clearCache(e){e?this.facilitatorMetrics.delete(e):this.facilitatorMetrics.clear()}getCacheState(){return new Map(this.facilitatorMetrics)}getThresholds(){return{...this.thresholds}}getBatchConfig(){return{...this.batchConfig}}updateThresholds(e){this.thresholds={...this.thresholds,...e},i.info({thresholds:this.thresholds},"Load thresholds updated")}updateBatchConfig(e){this.batchConfig={...this.batchConfig,...e},i.info({batchConfig:this.batchConfig},"Batch config updated")}}let n=null;function o(t){if(!n){if(!t){let{getDb:a}=e.r(24924);t=a()}n=new s(t)}return n}e.s(["getLoadMonitor",()=>o],42665)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__e85ca3a9._.js.map
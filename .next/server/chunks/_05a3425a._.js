module.exports=[62604,e=>{"use strict";var t=e.i(66680);let s=t.default.webcrypto?.subtle||{},n=e=>t.default.webcrypto.getRandomValues(e);e.s(["getRandomValues",()=>n,"subtle",()=>s])},87545,46747,e=>{"use strict";var t=e.i(28066),s=e.i(20230),n=e.i(2409),a=e.i(17081);async function o(e){let{domain:t,message:s,primaryType:o,signature:i,types:r}=e;return(0,a.recoverAddress)({hash:(0,n.hashTypedData)({domain:t,message:s,primaryType:o,types:r}),signature:i})}async function i(e){let{address:n,domain:a,message:i,primaryType:r,signature:c,types:d}=e;return(0,s.isAddressEqual)((0,t.getAddress)(n),await o({domain:a,message:i,primaryType:r,signature:c,types:d}))}e.s(["recoverTypedDataAddress",()=>o],46747),e.s(["verifyTypedData",()=>i],87545)},22444,e=>{"use strict";let t=(0,e.i(50377).createLogger)({component:"BaseFacilitator"});class s{getLogger(){return t.child({facilitator:this.constructor.name})}async getPricing(e,t){return null}supports(e,t,s,n){return!!this.config.enabled&&!!this.config.schemes.includes(s)&&(!n||!this.config.settlementModes||!!this.config.settlementModes.includes(n))&&!!(this.config.networks.includes(e)||this.config.networksCAIP&&this.config.networksCAIP.includes(e))&&(this.config.assets.includes(t)||this.config.assetsCAIP&&this.config.assetsCAIP.includes(t))}supportsCAIPNetwork(e){return!!this.config.enabled&&(this.config.networksCAIP?.includes(e)||!1)}supportsCAIPAsset(e){return!!this.config.enabled&&(this.config.assetsCAIP?.includes(e)||!1)}validateRequirements(e){if(!(e.network||e.networks&&e.networks.length>0))return{valid:!1,error:"Network is required"};if(!(e.asset||e.assets&&e.assets.length>0))return{valid:!1,error:"Asset is required"};if(!e.payTo)return{valid:!1,error:"Recipient address (payTo) is required"};if(!e.maxAmountRequired)return{valid:!1,error:"Amount is required"};let t=e.network||e.networks?.[0]||"",s=e.asset||e.assets?.[0]||"";return e.networks&&e.networks.length>0&&!e.networks.some(e=>this.supportsCAIPNetwork(e)||this.config.networks.includes(e))?{valid:!1,error:`Facilitator ${this.id} does not support any of the requested networks: ${e.networks.join(", ")}`}:e.assets&&e.assets.length>0&&!e.assets.some(e=>this.supportsCAIPAsset(e)||this.config.assets.includes(e))?{valid:!1,error:`Facilitator ${this.id} does not support any of the requested assets: ${e.assets.join(", ")}`}:this.supports(t,s,e.scheme,e.settlementMode)?{valid:!0}:{valid:!1,error:`Facilitator ${this.id} does not support ${t}/${s}/${e.scheme}`}}}e.s(["BaseFacilitator",()=>s])},41500,e=>e.a(async(t,s)=>{try{var n=e.i(50377),a=e.i(87768),o=e.i(3004),i=t([a,o]);[a,o]=i.then?(await i)():i;let u=(0,n.createLogger)({component:"FacilitatorMetricsReader"}),f={maxDataAgeHours:parseFloat(process.env.METRICS_MAX_AGE_HOURS??"4"),minInvocationsHighConfidence:parseInt(process.env.METRICS_MIN_INVOCATIONS_HIGH??"1000",10),minInvocationsMinimum:parseInt(process.env.METRICS_MIN_INVOCATIONS??"100",10),lowConfidencePenalty:parseFloat(process.env.METRICS_LOW_CONFIDENCE_PENALTY??"0.5")},h=parseFloat(process.env.SCATTERING_SCORE_WEIGHT??"0.2"),p=parseInt(process.env.SCATTERING_MIN_TX_COUNT??"100",10),m=parseFloat(process.env.SCATTERING_MIN_VOLUME??"100"),g=1-h;async function r(e){let t=e.timeframe??"1d",s=[];try{let n,i,r,c,d,l,f=await (0,a.getSummary)(e.facilitatorId,t),v=50,I=0,y=1/0,w=0,$=!1;if(f){$=!0;let e=50*(I=1-f.overallErrorRate);s.push(`success-rate:${(100*I).toFixed(1)}%`);let t=30,a=f.avgP90LatencyMs??f.avgP99LatencyMs;if(void 0!==a){let e=Math.min(a,2e3)/2e3;t=(1-e)*30,s.push(`p95-latency:${a.toFixed(0)}ms`),i=f.avgP90LatencyMs}else t=15,s.push("latency:unknown");let o=Math.min(f.totalInvocations/1e3,1);w=f.totalInvocations,s.push(`x402scan:${f.totalInvocations}/${f.totalInvocations>=1e3?"high":f.totalInvocations>=100?"medium":"low"}-confidence`);let r=new Date(f.fetchedAt);y=(Date.now()-r.getTime())/36e5;let c=Math.max(0,1-y/24);v=e+t+10*o+10*c,n=f.avgP50LatencyMs}else s.push("x402scan:no-data");let F=0,M=!1,A=!1;try{let t=await (0,o.getScatteringMetricsForFacilitator)(e.facilitatorId);t?(A=!0,r=t.volumeUsd3d,c=t.txCount3d,d=t.uniqueBuyers3d,t.txCount3d<p&&t.volumeUsd3d<m?(M=!0,F=.1,s.push(`scattering-low-activity:${t.txCount3d}tx/$${t.volumeUsd3d.toFixed(0)}`)):(F=(0,o.computeActivityScore)(t),s.push(`scattering-activity:${F.toFixed(2)}`))):s.push("scattering:no-data")}catch(t){u.debug({error:t instanceof Error?t.message:"Unknown",facilitatorId:e.facilitatorId,msg:"Failed to fetch Scattering metrics for scoring"}),s.push("scattering:error")}l=$&&A?g*v+h*F*100:$?v:A?100*F:50;let k="none";return $?k=w>=1e3&&y<6?"high":w>=100&&y<24?"medium":"low":A&&!M&&(k=F>.5?"medium":"low"),{facilitatorId:e.facilitatorId,score:Math.round(l),successRate:I,avgLatencyMs:n,p95LatencyMs:i,totalInvocations:w,dataFreshness:y,confidence:k,reasons:s,scatteringActivityScore:A?F:void 0,scatteringVolume3d:r,scatteringTxCount3d:c,scatteringUniqueBuyers3d:d,scatteringLowActivity:M||void 0}}catch(t){return u.error({error:t instanceof Error?t.message:"Unknown error",facilitatorId:e.facilitatorId,msg:"Failed to get facilitator score"}),null}}async function c(e,t="1d",s=f){let n=[],a=[];for(let o of e){let e=await r({facilitatorId:o,timeframe:t});if(!e){a.push({id:o,reason:"no-data"});continue}let i=function(e,t,s=f){return e>s.maxDataAgeHours?{trust:!1,confidence:"none",reason:`data-stale:${e.toFixed(1)}h-old`}:t<s.minInvocationsMinimum?{trust:!1,confidence:"none",reason:`insufficient-data:${t}-invocations`}:t>=s.minInvocationsHighConfidence?{trust:!0,confidence:"high",reason:`high-confidence:${t}-invocations`}:{trust:!0,confidence:"medium",reason:`medium-confidence:${t}-invocations`}}(e.dataFreshness,e.totalInvocations,s);if(!i.trust){a.push({id:o,reason:i.reason}),n.push({...e,score:e.score*s.lowConfidencePenalty,confidence:"low",reasons:[...e.reasons,`untrusted:${i.reason}`]});continue}"medium"===i.confidence?n.push({...e,score:.9*e.score,confidence:"medium",reasons:[...e.reasons,i.reason]}):n.push({...e,reasons:[...e.reasons,i.reason]})}return a.length>0&&u.debug({untrusted:a,trusted:n.filter(e=>"low"!==e.confidence).map(e=>e.facilitatorId),msg:"Facilitator metrics trust check results"}),n.sort((e,t)=>t.score-e.score),{rankings:n,timestamp:new Date().toISOString(),timeframe:t}}async function d(e,t){let s,n=t?.timeframe??"1d",a=t?.trustConfig??f,o=await c(e,n,a),i=o.rankings.filter(e=>"low"!==e.confidence);if(0===i.length)return u.warn({candidates:e,rankings:o.rankings.map(e=>({id:e.facilitatorId,confidence:e.confidence,reasons:e.reasons})),msg:"No trusted x402scan data available, using fallback"}),{recommended:e[0]??null,ranking:o,reason:"No trusted x402scan data (stale or insufficient), using default order",usedFallback:!0};switch(t?.prioritize??"balanced"){case"latency":s=i.filter(e=>void 0!==e.p95LatencyMs).sort((e,t)=>(e.p95LatencyMs??1/0)-(t.p95LatencyMs??1/0))[0]??i[0];break;case"reliability":s=[...i].sort((e,t)=>t.successRate-e.successRate)[0];break;default:s=i[0]}return{recommended:s.facilitatorId,ranking:o,reason:`Selected ${s.facilitatorId} with score ${s.score} (${s.confidence} confidence, ${s.reasons.slice(0,3).join(", ")})`,usedFallback:!1}}async function l(e,t){let s=t?.timeframe??"1d",n=t?.wasSelected??!1,a=await r({facilitatorId:e,timeframe:s});if(!a)return{facilitatorId:e,selected:n,score:50,confidence:"low",shortReason:`${e}: no x402scan data available`,detailedReasons:["No observability data from x402scan"],metrics:{}};let o=(100*a.successRate).toFixed(1),i=a.p95LatencyMs?`${a.p95LatencyMs.toFixed(0)}ms p95`:"latency unknown",c=a.totalInvocations>=1e3?`${(a.totalInvocations/1e3).toFixed(1)}K invocations`:`${a.totalInvocations} invocations`,d=`${e}: ${o}% success, ${i}, ${a.confidence} confidence (${c})`,l=[];return a.successRate>=.99?l.push(`Excellent success rate: ${o}%`):a.successRate>=.95?l.push(`Good success rate: ${o}%`):a.successRate>=.9?l.push(`Acceptable success rate: ${o}%`):l.push(`⚠️ Low success rate: ${o}%`),void 0!==a.p95LatencyMs&&(a.p95LatencyMs<200?l.push(`Fast response times: ${a.p95LatencyMs.toFixed(0)}ms p95`):a.p95LatencyMs<500?l.push(`Moderate latency: ${a.p95LatencyMs.toFixed(0)}ms p95`):l.push(`⚠️ High latency: ${a.p95LatencyMs.toFixed(0)}ms p95`)),"high"===a.confidence?l.push(`High confidence: ${c}, data ${a.dataFreshness.toFixed(1)}h old`):"medium"===a.confidence?l.push(`Medium confidence: ${c}`):l.push(`Low confidence: limited data (${c})`),a.dataFreshness>12&&l.push(`⚠️ Data is ${a.dataFreshness.toFixed(1)} hours old`),{facilitatorId:e,selected:n,score:a.score,confidence:a.confidence,shortReason:d,detailedReasons:l,metrics:{successRate:a.successRate,errorRate:1-a.successRate,p95LatencyMs:a.p95LatencyMs,invocations:a.totalInvocations,dataAgeHours:a.dataFreshness}}}e.s(["getFacilitatorExplainer",()=>l,"getFacilitatorScore",()=>r,"getRecommendedFacilitator",()=>d,"rankFacilitators",()=>c]),s()}catch(e){s(e)}},!1)];

//# sourceMappingURL=_05a3425a._.js.map
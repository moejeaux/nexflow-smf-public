{"version":3,"sources":["../../../src/db/webhook-configs.ts","../../../src/lib/webhook-config-store.ts"],"sourcesContent":["// =============================================================================\r\n// WEBHOOK CONFIGURATIONS DATABASE\r\n// =============================================================================\r\n// Database operations for webhook configurations\r\n\r\nimport { executeQuery, executeQueryOne, executeUpdate } from './query-helper';\r\nimport type { WebhookConfig } from '@/lib/webhook-delivery';\r\n\r\nexport interface WebhookConfigRow {\r\n  id: string;\r\n  api_key_id: string;\r\n  endpoint_id: string | null;\r\n  url: string;\r\n  secret: string;\r\n  events: string[]; // JSON array\r\n  enabled: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\n/**\r\n * Convert database row to WebhookConfig\r\n */\r\nfunction rowToConfig(row: WebhookConfigRow): WebhookConfig {\r\n  return {\r\n    id: row.id,\r\n    endpointId: row.endpoint_id || undefined,\r\n    url: row.url,\r\n    secret: row.secret,\r\n    events: row.events as any,\r\n    enabled: row.enabled,\r\n    createdAt: row.created_at,\r\n    updatedAt: row.updated_at,\r\n  };\r\n}\r\n\r\n/**\r\n * Get all webhook configurations\r\n */\r\nexport async function getWebhookConfigs(filters?: {\r\n  apiKeyId?: string;\r\n  endpointId?: string;\r\n  enabled?: boolean;\r\n}): Promise<WebhookConfig[]> {\r\n  // Determine if we're using PostgreSQL (uses $1, $2) or SQLite (uses ?)\r\n  const { getDb } = await import('./client');\r\n  const db = getDb();\r\n  const isPostgres = 'pool' in db || typeof (db as any).pool?.query === 'function';\r\n  \r\n  let query = 'SELECT * FROM webhook_configs WHERE 1=1';\r\n  const params: any[] = [];\r\n  let paramIndex = 1;\r\n\r\n  if (filters?.apiKeyId) {\r\n    if (isPostgres) {\r\n      query += ` AND api_key_id = $${paramIndex++}`;\r\n    } else {\r\n      query += ' AND api_key_id = ?';\r\n    }\r\n    params.push(filters.apiKeyId);\r\n  }\r\n  if (filters?.endpointId) {\r\n    if (isPostgres) {\r\n      query += ` AND endpoint_id = $${paramIndex++}`;\r\n    } else {\r\n      query += ' AND endpoint_id = ?';\r\n    }\r\n    params.push(filters.endpointId);\r\n  }\r\n  if (filters?.enabled !== undefined) {\r\n    if (isPostgres) {\r\n      query += ` AND enabled = $${paramIndex++}`;\r\n    } else {\r\n      query += ' AND enabled = ?';\r\n    }\r\n    params.push(filters.enabled ? (isPostgres ? true : 1) : (isPostgres ? false : 0));\r\n  }\r\n\r\n  query += ' ORDER BY created_at DESC';\r\n\r\n  const rows = await executeQuery<WebhookConfigRow>(query, params);\r\n  return rows.map(row => ({\r\n    ...rowToConfig(row),\r\n    events: typeof row.events === 'string' ? JSON.parse(row.events) : (Array.isArray(row.events) ? row.events : []),\r\n  }));\r\n}\r\n\r\n/**\r\n * Get webhook configuration by ID\r\n */\r\nexport async function getWebhookConfig(id: string): Promise<WebhookConfig | null> {\r\n  const { getDb } = await import('./client');\r\n  const db = getDb();\r\n  const isPostgres = 'pool' in db || typeof (db as any).pool?.query === 'function';\r\n  const query = isPostgres \r\n    ? 'SELECT * FROM webhook_configs WHERE id = $1'\r\n    : 'SELECT * FROM webhook_configs WHERE id = ?';\r\n  \r\n  const row = await executeQueryOne<WebhookConfigRow>(query, [id]);\r\n  if (!row) return null;\r\n  \r\n  return {\r\n    ...rowToConfig(row),\r\n    events: typeof row.events === 'string' ? JSON.parse(row.events) : (Array.isArray(row.events) ? row.events : []),\r\n  };\r\n}\r\n\r\n/**\r\n * Create webhook configuration\r\n */\r\nexport async function createWebhookConfig(config: Omit<WebhookConfig, 'id' | 'createdAt' | 'updatedAt'> & {\r\n  id?: string;\r\n  apiKeyId: string;\r\n}): Promise<WebhookConfig> {\r\n  const id = config.id || `wh_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;\r\n  const now = new Date().toISOString();\r\n\r\n  const { getDb } = await import('./client');\r\n  const db = getDb();\r\n  const isPostgres = 'pool' in db || typeof (db as any).pool?.query === 'function';\r\n  \r\n  const query = isPostgres\r\n    ? `INSERT INTO webhook_configs (id, api_key_id, endpoint_id, url, secret, events, enabled, created_at, updated_at)\r\n       VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)`\r\n    : `INSERT INTO webhook_configs (id, api_key_id, endpoint_id, url, secret, events, enabled, created_at, updated_at)\r\n       VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`;\r\n  \r\n  const params = isPostgres\r\n    ? [\r\n        id,\r\n        config.apiKeyId,\r\n        config.endpointId || null,\r\n        config.url,\r\n        config.secret,\r\n        JSON.stringify(config.events),\r\n        config.enabled !== false,\r\n        now,\r\n        now,\r\n      ]\r\n    : [\r\n        id,\r\n        config.apiKeyId,\r\n        config.endpointId || null,\r\n        config.url,\r\n        config.secret,\r\n        JSON.stringify(config.events),\r\n        config.enabled !== false ? 1 : 0,\r\n        now,\r\n        now,\r\n      ];\r\n\r\n  await executeUpdate(query, params);\r\n\r\n  return {\r\n    id,\r\n    endpointId: config.endpointId,\r\n    url: config.url,\r\n    secret: config.secret,\r\n    events: config.events,\r\n    enabled: config.enabled !== false,\r\n    createdAt: now,\r\n    updatedAt: now,\r\n  };\r\n}\r\n\r\n/**\r\n * Update webhook configuration\r\n */\r\nexport async function updateWebhookConfig(\r\n  id: string,\r\n  updates: Partial<Pick<WebhookConfig, 'url' | 'events' | 'enabled'>>\r\n): Promise<WebhookConfig | null> {\r\n  const { getDb } = await import('./client');\r\n  const db = getDb();\r\n  const isPostgres = 'pool' in db || typeof (db as any).pool?.query === 'function';\r\n  const now = new Date().toISOString();\r\n\r\n  const setClauses: string[] = [];\r\n  const params: any[] = [];\r\n  let paramIndex = 1;\r\n\r\n  setClauses.push(isPostgres ? `updated_at = $${paramIndex++}` : 'updated_at = ?');\r\n  params.push(now);\r\n\r\n  if (updates.url !== undefined) {\r\n    setClauses.push(isPostgres ? `url = $${paramIndex++}` : 'url = ?');\r\n    params.push(updates.url);\r\n  }\r\n  if (updates.events !== undefined) {\r\n    setClauses.push(isPostgres ? `events = $${paramIndex++}` : 'events = ?');\r\n    params.push(JSON.stringify(updates.events));\r\n  }\r\n  if (updates.enabled !== undefined) {\r\n    setClauses.push(isPostgres ? `enabled = $${paramIndex++}` : 'enabled = ?');\r\n    params.push(updates.enabled ? (isPostgres ? true : 1) : (isPostgres ? false : 0));\r\n  }\r\n\r\n  params.push(id);\r\n  const whereClause = isPostgres ? `$${paramIndex}` : '?';\r\n  const query = `UPDATE webhook_configs SET ${setClauses.join(', ')} WHERE id = ${whereClause}`;\r\n\r\n  await executeUpdate(query, params);\r\n\r\n  return getWebhookConfig(id);\r\n}\r\n\r\n/**\r\n * Delete webhook configuration\r\n */\r\nexport async function deleteWebhookConfig(id: string): Promise<boolean> {\r\n  const { getDb } = await import('./client');\r\n  const db = getDb();\r\n  const isPostgres = 'pool' in db || typeof (db as any).pool?.query === 'function';\r\n  const query = isPostgres\r\n    ? 'DELETE FROM webhook_configs WHERE id = $1'\r\n    : 'DELETE FROM webhook_configs WHERE id = ?';\r\n  \r\n  const result = await executeUpdate(query, [id]);\r\n  return (result.rowCount ?? result.changes ?? 0) > 0;\r\n}\r\n\r\n","// =============================================================================\r\n// Webhook Config Store\r\n// =============================================================================\r\n// Database-backed store for webhook configurations\r\n// Migrated from in-memory to database for production readiness\r\n\r\nimport type { WebhookConfig } from './webhook-delivery';\r\nimport * as webhookDb from '@/db/webhook-configs';\r\n\r\n/**\r\n * Get all webhook configurations\r\n */\r\nexport async function getWebhookConfigs(filters?: {\r\n  apiKeyId?: string;\r\n  endpointId?: string;\r\n  enabled?: boolean;\r\n}): Promise<WebhookConfig[]> {\r\n  return webhookDb.getWebhookConfigs(filters);\r\n}\r\n\r\n/**\r\n * Get webhook configuration by ID\r\n */\r\nexport async function getWebhookConfig(id: string): Promise<WebhookConfig | undefined> {\r\n  const config = await webhookDb.getWebhookConfig(id);\r\n  return config || undefined;\r\n}\r\n\r\n/**\r\n * Create or update webhook configuration\r\n */\r\nexport async function setWebhookConfig(config: WebhookConfig & { apiKeyId: string }): Promise<WebhookConfig> {\r\n  const existing = await webhookDb.getWebhookConfig(config.id);\r\n  if (existing) {\r\n    const updated = await webhookDb.updateWebhookConfig(config.id, {\r\n      url: config.url,\r\n      events: config.events,\r\n      enabled: config.enabled,\r\n    });\r\n    return updated || config;\r\n  } else {\r\n    return webhookDb.createWebhookConfig(config);\r\n  }\r\n}\r\n\r\n/**\r\n * Delete webhook configuration\r\n */\r\nexport async function deleteWebhookConfig(id: string): Promise<boolean> {\r\n  return webhookDb.deleteWebhookConfig(id);\r\n}\r\n\r\n"],"names":[],"mappings":"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"}
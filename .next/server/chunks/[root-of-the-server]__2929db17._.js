module.exports=[93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},22734,(e,t,r)=>{t.exports=e.x("fs",()=>require("fs"))},30056,e=>e.a(async(t,r)=>{try{let t=await e.y("pg");e.n(t),r()}catch(e){r(e)}},!0),14747,(e,t,r)=>{t.exports=e.x("path",()=>require("path"))},70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},24361,(e,t,r)=>{t.exports=e.x("util",()=>require("util"))},87769,(e,t,r)=>{t.exports=e.x("node:events",()=>require("node:events"))},874,(e,t,r)=>{t.exports=e.x("buffer",()=>require("buffer"))},27699,(e,t,r)=>{t.exports=e.x("events",()=>require("events"))},92509,(e,t,r)=>{t.exports=e.x("url",()=>require("url"))},49719,(e,t,r)=>{t.exports=e.x("assert",()=>require("assert"))},62562,(e,t,r)=>{t.exports=e.x("module",()=>require("module"))},50227,(e,t,r)=>{t.exports=e.x("node:path",()=>require("node:path"))},94346,e=>{e.v({name:"thread-stream",version:"3.1.0",description:"A streaming way to send data to a Node.js Worker Thread",main:"index.js",types:"index.d.ts",dependencies:{"real-require":"^0.2.0"},devDependencies:{"@types/node":"^20.1.0","@types/tap":"^15.0.0","@yao-pkg/pkg":"^5.11.5",desm:"^1.3.0",fastbench:"^1.0.1",husky:"^9.0.6","pino-elasticsearch":"^8.0.0","sonic-boom":"^4.0.1",standard:"^17.0.0",tap:"^16.2.0","ts-node":"^10.8.0",typescript:"^5.3.2","why-is-node-running":"^2.2.2"},scripts:{build:"tsc --noEmit",test:'standard && npm run build && npm run transpile && tap "test/**/*.test.*js" && tap --ts test/*.test.*ts',"test:ci":"standard && npm run transpile && npm run test:ci:js && npm run test:ci:ts","test:ci:js":'tap --no-check-coverage --timeout=120 --coverage-report=lcovonly "test/**/*.test.*js"',"test:ci:ts":'tap --ts --no-check-coverage --coverage-report=lcovonly "test/**/*.test.*ts"',"test:yarn":'npm run transpile && tap "test/**/*.test.js" --no-check-coverage',transpile:"sh ./test/ts/transpile.sh",prepare:"husky install"},standard:{ignore:["test/ts/**/*","test/syntax-error.mjs"]},repository:{type:"git",url:"git+https://github.com/mcollina/thread-stream.git"},keywords:["worker","thread","threads","stream"],author:"Matteo Collina <hello@matteocollina.com>",license:"MIT",bugs:{url:"https://github.com/mcollina/thread-stream/issues"},homepage:"https://github.com/mcollina/thread-stream#readme"})},37702,(e,t,r)=>{t.exports=e.x("worker_threads",()=>require("worker_threads"))},60526,(e,t,r)=>{t.exports=e.x("node:os",()=>require("node:os"))},77652,(e,t,r)=>{t.exports=e.x("node:diagnostics_channel",()=>require("node:diagnostics_channel"))},62556,e=>{"use strict";let t=(0,e.i(50377).createLogger)({component:"CircuitBreaker"});class r{config;state;failures;successes;lastFailure;lastSuccess;openedAt;totalRequests;failedRequests;constructor(e){this.config=e,this.state="CLOSED",this.failures=[],this.successes=0,this.totalRequests=0,this.failedRequests=0}async execute(e){if(this.totalRequests++,"OPEN"===this.state)if(this.shouldAttemptReset())this.transitionTo("HALF_OPEN");else{if(this.failedRequests++,t.warn({circuit:this.config.name,state:this.state,openedAt:this.openedAt},"Circuit breaker is OPEN - failing fast"),this.config.fallback)return this.config.fallback();throw new s(`Circuit breaker ${this.config.name} is OPEN`,this.config.name)}try{let t=await this.executeWithTimeout(e);return this.onSuccess(),t}catch(e){throw this.onFailure(e),e}}async executeWithTimeout(e){return this.config.requestTimeout?Promise.race([e(),new Promise((e,t)=>setTimeout(()=>t(Error(`Request timeout after ${this.config.requestTimeout}ms`)),this.config.requestTimeout))]):e()}onSuccess(){this.lastSuccess=new Date,"HALF_OPEN"===this.state?(this.successes++,this.successes>=this.config.successThreshold&&this.transitionTo("CLOSED")):"CLOSED"===this.state&&this.pruneOldFailures()}onFailure(e){this.failedRequests++,this.lastFailure=new Date,this.failures.push({timestamp:Date.now()}),t.warn({circuit:this.config.name,state:this.state,error:e instanceof Error?e.message:"Unknown error",failureCount:this.failures.length},"Circuit breaker recorded failure"),"HALF_OPEN"===this.state?this.transitionTo("OPEN"):"CLOSED"===this.state&&(this.pruneOldFailures(),this.failures.length>=this.config.failureThreshold&&this.transitionTo("OPEN"))}shouldAttemptReset(){return!this.openedAt||Date.now()-this.openedAt.getTime()>=this.config.resetTimeout}pruneOldFailures(){let e=Date.now()-this.config.failureWindow;this.failures=this.failures.filter(t=>t.timestamp>e)}transitionTo(e){let r=this.state;this.state=e,t.info({circuit:this.config.name,from:r,to:e,failures:this.failures.length,successes:this.successes},"Circuit breaker state transition"),"OPEN"===e?this.openedAt=new Date:"CLOSED"===e?(this.failures=[],this.successes=0,this.openedAt=void 0):"HALF_OPEN"===e&&(this.successes=0)}getStats(){return{name:this.config.name,state:this.state,failures:this.failures.length,successes:this.successes,lastFailure:this.lastFailure,lastSuccess:this.lastSuccess,openedAt:this.openedAt,totalRequests:this.totalRequests,failedRequests:this.failedRequests,successRate:this.totalRequests>0?(this.totalRequests-this.failedRequests)/this.totalRequests:1}}reset(){this.transitionTo("CLOSED"),this.totalRequests=0,this.failedRequests=0,t.info({circuit:this.config.name},"Circuit breaker manually reset")}isAllowingRequests(){return"CLOSED"===this.state||"HALF_OPEN"===this.state||this.shouldAttemptReset()}}class s extends Error{circuitName;constructor(e,t){super(e),this.circuitName=t,this.name="CircuitBreakerError"}}let i=new Map;function a(e){let s=i.get(e.name);return s||(s=new r(e),i.set(e.name,s),t.info({circuit:e.name},"Created new circuit breaker")),s}function o(){return Array.from(i.values()).map(e=>e.getStats())}a({name:"x402scan",failureThreshold:3,successThreshold:2,resetTimeout:6e4,failureWindow:3e5,requestTimeout:3e4}),a({name:"scattering",failureThreshold:3,successThreshold:2,resetTimeout:6e4,failureWindow:3e5,requestTimeout:3e4}),a({name:"facilitator-probes",failureThreshold:5,successThreshold:3,resetTimeout:3e4,failureWindow:12e4,requestTimeout:1e4}),e.s(["getAllCircuitBreakerStats",()=>o,"getCircuitBreaker",()=>a])},83101,e=>{"use strict";function t(e,t){let r=e.network||e.networks?.[0]||"",s=e.networks?.[0]?.startsWith("eip155:")?e.networks[0]:void 0,i=e.asset||e.assets?.[0]||"",a=e.assets?.[0]?.includes("/")?e.assets[0]:void 0;return{network:r,token:i,amount:e.maxAmountRequired||"0",networkCAIP:s,tokenCAIP:a,x402Version:t?.x402Version||1,callerId:t?.callerId,clientId:t?.clientId,region:t?.region,riskLevel:t?.riskLevel,watchLevel:t?.watchLevel,requirements:e}}e.s(["createRouteContext",()=>t])},84170,e=>e.a(async(t,r)=>{try{var s=e.i(57729),i=e.i(50377),a=e.i(60827),o=e.i(83101),n=t([s,a]);[s,a]=n.then?(await n)():n;let c=(0,i.createLogger)({component:"MetaFacilitator"});class u{router=(0,s.getFacilitatorRouter)();async verifyPayment(e,t,r,s,i){let n=Date.now(),l=null;try{let u,d=(0,o.createRouteContext)(t,{callerId:i?.clientId||i?.agentId,clientId:i?.clientId,x402Version:1}),p=await this.router.routePayment(t,r,s);l=(await (0,a.createRoute)({request_id:i?.requestId||null,correlation_id:i?.correlationId||null,client_id:i?.clientId||null,agent_id:i?.agentId||null,network:d.network,token:d.token,amount:d.amount,selected_facilitator_id:p.id,status:"verifying"})).id,c.info({routeId:l,facilitatorId:p.id,network:t.network,asset:t.asset,settlementMode:t.settlementMode,preferences:r?{priority:r.priority,jurisdiction:r.jurisdiction}:void 0},"Routing payment to facilitator");let h=Date.now(),f="success",m=null,g=null;try{u=await p.verify(e,t);let r=Date.now()-h;u.success&&u.valid||(f="failure",m=u.error||"verification_failed"),await (0,a.createRouteAttempt)({route_id:l,facilitator_id:p.id,phase:"verify",result:f,latency_ms:r,error_code:m,raw_status:g,is_probe:!1})}catch(r){let e=Date.now()-h,t=r instanceof Error?r.message:"Unknown error";t.includes("timeout")||t.includes("TIMEOUT")?f="timeout":t.includes("rate")||t.includes("429")?(f="rate_limited",g=429):f=t.includes("network")||t.includes("ECONNREFUSED")?"network_error":"failure",m=t,await (0,a.createRouteAttempt)({route_id:l,facilitator_id:p.id,phase:"verify",result:f,latency_ms:e,error_code:m,raw_status:g,is_probe:!1}),u={success:!1,valid:!1,error:t,facilitatorId:p.id,verifiedAt:new Date().toISOString()}}let y=this.applyBusinessLogic(u,t,s);y.success&&y.valid?await (0,a.updateRouteStatus)(l,"settled",new Date().toISOString()):await (0,a.updateRouteStatus)(l,"failed",new Date().toISOString());let _={latency:Date.now()-n,complianceScore:this.calculateComplianceScore(u)},w=this.router.getFacilitators().filter(e=>e.supports(t.network,t.asset,t.scheme,t.settlementMode)&&e.config.enabled),x=await this.buildDecisionTrace(p,w,t,r,s);return{...y,facilitatorUsed:p.id,routingReason:this.getRoutingReason(p,r,s),alternativesConsidered:w.length-1,decisionTrace:x,orchestrationMetadata:_}}catch(i){if(c.error({error:i,requirements:t,routeId:l},"Orchestration error"),l&&await (0,a.updateRouteStatus)(l,"failed",new Date().toISOString()),s?.requireHealthCheck!==!1)return await this.handleFailover(e,t,r,s,i,l);throw i}}applyBusinessLogic(e,t,r){if(r?.riskThreshold!==void 0){let t=this.calculateRiskScore(e);if(t>r.riskThreshold)return{...e,valid:!1,error:`Risk score ${t} exceeds threshold ${r.riskThreshold}`}}if(r?.requireKYC){let r=BigInt(t.maxAmountRequired),s=BigInt("1000000000");if(r>s&&"passed"!==e.kytStatus)return{...e,valid:!1,error:"KYC required for this amount"}}return r?.jurisdictionRules,e}calculateRiskScore(e){let t=0;return"blocked"===e.kytStatus?t+=50:"flagged"===e.kytStatus&&(t+=25),"blocked"===e.ofacStatus?t+=50:"flagged"===e.ofacStatus&&(t+=25),e.success&&e.valid||(t+=30),Math.min(100,t)}calculateComplianceScore(e){let t=100;return"blocked"===e.kytStatus?t-=50:"flagged"===e.kytStatus&&(t-=25),"blocked"===e.ofacStatus?t-=50:"flagged"===e.ofacStatus&&(t-=25),Math.max(0,t)}async buildDecisionTrace(e,t,r,i,a){let o=(0,s.getFacilitatorRouter)(),n=await o.scoreFacilitators(t,r,i,a),l=t.map(e=>{let t=n.find(t=>t.facilitator.id===e.id),r=t?.score||0,s=t?.reasons||[];return{facilitatorId:e.id,facilitatorName:e.name,score:r,eligible:!0,reasons:s}});return{timestamp:new Date().toISOString(),reason:this.getRoutingReason(e,i,a),constraints:{preferences:i,policy:a?{requireHealthCheck:a.requireHealthCheck,preferCheapest:a.preferCheapest,requireKYC:a.requireKYC}:void 0,requirements:r},candidates:l,selected:{facilitatorId:e.id,score:n.find(t=>t.facilitator.id===e.id)?.score||100,alternativesConsidered:t.length-1}}}getRoutingReason(e,t,r){let s=[];return t?.priority==="cost"&&s.push("cost-optimized"),t?.priority==="speed"&&s.push("speed-optimized"),t?.priority==="compliance"&&s.push("compliance-optimized"),t?.priority==="reliability"&&s.push("reliability-optimized"),t?.preferredNetworks&&s.push("network-preference"),r?.preferCheapest&&s.push("cheapest-selected"),1===e.config.priority&&s.push("primary-facilitator"),s.join(", ")||"default-routing"}async handleFailover(e,t,r,s,i,o){c.warn({originalError:i,requirements:t},"Attempting failover");let n=this.router.getFacilitators().filter(e=>e.supports(t.network,t.asset,t.scheme,t.settlementMode)&&e.config.enabled);for(let r of n.sort((e,t)=>e.config.priority-t.config.priority)){let s=Date.now();try{let i=await r.verify(e,t),l=Date.now()-s;if(o&&await (0,a.createRouteAttempt)({route_id:o,facilitator_id:r.id,phase:"verify",result:i.success&&i.valid?"success":"failure",latency_ms:l,is_probe:!1,error_code:i.error||null,raw_status:null}),i.success&&i.valid)return c.info({facilitatorId:r.id,routeId:o},"Failover successful"),o&&await (0,a.updateRouteStatus)(o,"settled",new Date().toISOString()),{...i,facilitatorUsed:r.id,routingReason:"failover",alternativesConsidered:n.length-1}}catch(i){let e=Date.now()-s,t=i instanceof Error?i.message:"Unknown error";if(o){let s="failure";t.includes("timeout")?s="timeout":t.includes("rate")||t.includes("429")?s="rate_limited":(t.includes("network")||t.includes("ECONNREFUSED"))&&(s="network_error"),await (0,a.createRouteAttempt)({route_id:o,facilitator_id:r.id,phase:"verify",result:s,latency_ms:e,is_probe:!1,error_code:t,raw_status:null})}c.warn({facilitatorId:r.id,error:i,routeId:o},"Failover attempt failed");continue}}throw Error(`All facilitators failed. Original error: ${i instanceof Error?i.message:"Unknown error"}`)}async getStatus(){let e=this.router.getFacilitators(),t=await Promise.all(e.map(async e=>{try{let t=await e.getHealth();return{id:e.id,name:e.name,healthy:t.healthy,lastChecked:t.lastChecked}}catch(t){return{id:e.id,name:e.name,healthy:!1,lastChecked:new Date().toISOString()}}})),r=t.filter(e=>e.healthy),s=new Set,i=new Set;return e.forEach(e=>{e.config.networks.forEach(e=>s.add(e)),e.config.assets.forEach(e=>i.add(e))}),{facilitators:e.length,healthy:r.length,networks:Array.from(s),assets:Array.from(i),facilitatorDetails:t}}}let d=null;function l(){return d||(d=new u),d}e.s(["MetaFacilitator",()=>u,"getMetaFacilitator",()=>l]),r()}catch(e){r(e)}},!1),24297,e=>e.a(async(t,r)=>{try{var s=e.i(24924),i=e.i(50377),a=t([s]);async function o(e){let t=(0,s.getDb)(),r="pool"in t||"function"==typeof t.pool?.query,i="SELECT * FROM x402_watchlist WHERE status = 'active'",a=[];if(void 0!==e&&(r?i+=" AND priority >= $1":i+=" AND priority >= ?",a.push(e)),i+=" ORDER BY priority DESC, last_checked_at ASC NULLS FIRST",r)return(await t.pool.query(i,a)).rows;{let e=t.prepare(i);return a.length>0?e.all(...a):e.all()}}async function n(e,t,r,i){let a=(0,s.getDb)(),o=new Date().toISOString();"pool"in a||"function"==typeof a.pool?.query?i?await a.pool.query(`UPDATE x402_watchlist 
         SET last_checked_at = $1, last_http_status = $2, last_etag = $3, last_change_at = $4, updated_at = $5
         WHERE id = $6`,[o,t,r,o,o,e]):await a.pool.query(`UPDATE x402_watchlist 
         SET last_checked_at = $1, last_http_status = $2, last_etag = $3, updated_at = $4
         WHERE id = $5`,[o,t,r,o,e]):i?a.prepare(`UPDATE x402_watchlist 
         SET last_checked_at = ?, last_http_status = ?, last_etag = ?, last_change_at = ?, updated_at = ?
         WHERE id = ?`).run(o,t,r,o,o,e):a.prepare(`UPDATE x402_watchlist 
         SET last_checked_at = ?, last_http_status = ?, last_etag = ?, updated_at = ?
         WHERE id = ?`).run(o,t,r,o,e)}[s]=a.then?(await a)():a,(0,i.createLogger)({component:"X402WatchlistDB"}),e.s(["getActiveWatchlistItems",()=>o,"updateWatchlistItemAfterCheck",()=>n]),r()}catch(e){r(e)}},!1),59670,e=>e.a(async(t,r)=>{try{var s=e.i(24924),i=e.i(50377),a=t([s]);[s]=a.then?(await a)():a;let p=(0,i.createLogger)({component:"AgentRecommendationsDB"});async function o(e){let t=(0,s.getDb)(),r=crypto.randomUUID(),i=new Date,a="pool"in t||"function"==typeof t.pool?.query,o={id:r,createdAt:i,agent:e.agent,type:e.type,facilitatorId:e.facilitatorId,resourceId:e.resourceId,priority:e.priority,confidence:e.confidence,details:e.details,reasoning:e.reasoning,status:"PENDING",expiresAt:e.expiresAt};return a?await t.pool.query(`INSERT INTO agent_recommendations (
        id, created_at, agent, type, facilitator_id, resource_id,
        priority, confidence, details, reasoning, status, expires_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12)`,[r,i.toISOString(),e.agent,e.type,e.facilitatorId||null,e.resourceId||null,e.priority,e.confidence,JSON.stringify(e.details),e.reasoning,"PENDING",e.expiresAt?.toISOString()||null]):t.prepare(`
      INSERT INTO agent_recommendations (
        id, created_at, agent, type, facilitator_id, resource_id,
        priority, confidence, details, reasoning, status, expires_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(r,i.toISOString(),e.agent,e.type,e.facilitatorId||null,e.resourceId||null,e.priority,e.confidence,JSON.stringify(e.details),e.reasoning,"PENDING",e.expiresAt?.toISOString()||null),p.info({recommendationId:r,agent:e.agent,type:e.type,priority:e.priority,msg:"Created agent recommendation"}),o}async function n(e){let t=[];for(let r of e){let e=await o(r);t.push(e)}return t}async function l(e={}){let t=(0,s.getDb)(),r="pool"in t||"function"==typeof t.pool?.query,i="SELECT * FROM agent_recommendations WHERE 1=1",a=[],o=1;return e.agent&&(i+=r?` AND agent = $${o++}`:" AND agent = ?",a.push(e.agent)),e.type&&(i+=r?` AND type = $${o++}`:" AND type = ?",a.push(e.type)),e.status&&(i+=r?` AND status = $${o++}`:" AND status = ?",a.push(e.status)),e.facilitatorId&&(i+=r?` AND facilitator_id = $${o++}`:" AND facilitator_id = ?",a.push(e.facilitatorId)),e.priority&&(i+=r?` AND priority = $${o++}`:" AND priority = ?",a.push(e.priority)),e.since&&(i+=r?` AND created_at >= $${o++}`:" AND created_at >= ?",a.push(e.since.toISOString())),i+=" ORDER BY created_at DESC",e.limit&&(i+=r?` LIMIT $${o++}`:" LIMIT ?",a.push(e.limit)),(r?(await t.pool.query(i,a)).rows:t.prepare(i).all(...a)).map(d)}async function c(e,t,r){let i=(0,s.getDb)(),a=new Date().toISOString();"pool"in i||"function"==typeof i.pool?.query?await i.pool.query(`UPDATE agent_recommendations
       SET status = 'APPLIED', reviewed_by = $1, reviewed_at = $2,
           details = details || $3
       WHERE id = $4`,[t,a,JSON.stringify(r||{}),e]):i.prepare(`
      UPDATE agent_recommendations
      SET status = 'APPLIED', reviewed_by = ?, reviewed_at = ?
      WHERE id = ?
    `).run(t,a,e),p.info({recommendationId:e,reviewedBy:t,msg:"Recommendation applied"})}async function u(){let e=(0,s.getDb)(),t=new Date().toISOString();return"pool"in e||"function"==typeof e.pool?.query?(await e.pool.query(`UPDATE agent_recommendations
       SET status = 'EXPIRED'
       WHERE status = 'PENDING' AND expires_at IS NOT NULL AND expires_at < $1`,[t])).rowCount||0:e.prepare(`
      UPDATE agent_recommendations
      SET status = 'EXPIRED'
      WHERE status = 'PENDING' AND expires_at IS NOT NULL AND expires_at < ?
    `).run(t).changes||0}function d(e){return{id:e.id,createdAt:new Date(e.created_at),agent:e.agent,type:e.type,facilitatorId:e.facilitator_id||void 0,resourceId:e.resource_id||void 0,priority:e.priority,confidence:parseFloat(e.confidence),details:"string"==typeof e.details?JSON.parse(e.details):e.details,reasoning:e.reasoning,status:e.status,reviewedBy:e.reviewed_by||void 0,reviewedAt:e.reviewed_at?new Date(e.reviewed_at):void 0,expiresAt:e.expires_at?new Date(e.expires_at):void 0}}e.s(["createRecommendations",()=>n,"expirePendingRecommendations",()=>u,"listRecommendations",()=>l,"markRecommendationApplied",()=>c]),r()}catch(e){r(e)}},!1),2759,e=>{e.v(t=>Promise.all(["server/chunks/node_modules_@upstash_redis_nodejs_mjs_bca9da2d._.js","server/chunks/node_modules_@upstash_redis_nodejs_mjs_85cd95da._.js"].map(t=>e.l(t))).then(()=>t(58119)))},6538,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__bc7866ad._.js","server/chunks/[root-of-the-server]__bbbc7a9e._.js","server/chunks/node_modules_@ioredis_commands_built_commands_json_862661ff._.js"].map(t=>e.l(t))).then(()=>t(42512)))},455,e=>{e.v(t=>Promise.all(["server/chunks/node_modules_bc74a3ae._.js"].map(t=>e.l(t))).then(()=>t(1805)))},5371,e=>{e.v(t=>Promise.all(["server/chunks/src_integrations_x402_payment-header-parser_ts_db7a382b._.js"].map(t=>e.l(t))).then(()=>t(71556)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__2929db17._.js.map
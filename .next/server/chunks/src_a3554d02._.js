module.exports=[60827,t=>t.a(async(e,a)=>{try{var o=t.i(24924),r=t.i(50377),s=e([o]);[o]=s.then?(await s)():s;let f=(0,r.createLogger)({component:"SMFDatabase"});async function n(t){let e=(0,o.getDb)(),a=crypto.randomUUID(),r=new Date().toISOString();return"pool"in e||"function"==typeof e.pool?.query?(await e.pool.query(`INSERT INTO routes (
        id, request_id, correlation_id, client_id, agent_id, network, token, amount,
        selected_facilitator_id, status, created_at, updated_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12)
      RETURNING *`,[a,t.request_id,t.correlation_id,t.client_id,t.agent_id,t.network,t.token,t.amount,t.selected_facilitator_id,t.status,r,r])).rows[0]:(e.prepare(`
      INSERT INTO routes (
        id, request_id, correlation_id, client_id, agent_id, network, token, amount,
        selected_facilitator_id, status, created_at, updated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(a,t.request_id,t.correlation_id,t.client_id,t.agent_id,t.network,t.token,t.amount,t.selected_facilitator_id,t.status,r,r),{id:a,...t,created_at:r,updated_at:r,completed_at:null})}async function i(t,e,a){let r=(0,o.getDb)(),s=new Date().toISOString();"pool"in r||"function"==typeof r.pool?.query?await r.pool.query("UPDATE routes SET status = $1, updated_at = $2, completed_at = $3 WHERE id = $4",[e,s,a||null,t]):r.prepare("UPDATE routes SET status = ?, updated_at = ?, completed_at = ? WHERE id = ?").run(e,s,a||null,t)}async function c(t){let e=(0,o.getDb)(),a=crypto.randomUUID(),r=new Date().toISOString();return"pool"in e||"function"==typeof e.pool?.query?(await e.pool.query(`INSERT INTO route_attempts (
        id, route_id, facilitator_id, phase, result, latency_ms, error_code, raw_status, is_probe, created_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)
      RETURNING *`,[a,t.route_id,t.facilitator_id,t.phase,t.result,t.latency_ms,t.error_code,t.raw_status,t.is_probe??!1,r])).rows[0]:(e.prepare(`
      INSERT INTO route_attempts (
        id, route_id, facilitator_id, phase, result, latency_ms, error_code, raw_status, is_probe, created_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(a,t.route_id,t.facilitator_id,t.phase,t.result,t.latency_ms,t.error_code,t.raw_status,t.is_probe??!1,r),{id:a,...t,created_at:r})}async function l(t,e,a){let r=(0,o.getDb)(),s="pool"in r||"function"==typeof r.pool?.query,n="SELECT * FROM facilitator_capabilities WHERE 1=1",i=[],c=1;return(t&&(s?n+=` AND facilitator_id = $${c++}`:n+=" AND facilitator_id = ?",i.push(t)),e&&(s?n+=` AND network = $${c++}`:n+=" AND network = ?",i.push(e)),a&&(s?n+=` AND token = $${c++}`:n+=" AND token = ?",i.push(a)),s)?(await r.pool.query(n,i)).rows:r.prepare(n).all(...i)}async function d(t,e,a){let r=(0,o.getDb)();return"pool"in r||"function"==typeof r.pool?.query?(await r.pool.query(`SELECT * FROM facilitator_health_snapshots
       WHERE facilitator_id = $1 AND network = $2 AND token = $3
       ORDER BY window_end DESC
       LIMIT 1`,[t,e,a])).rows[0]||null:r.prepare(`SELECT * FROM facilitator_health_snapshots
       WHERE facilitator_id = ? AND network = ? AND token = ?
       ORDER BY window_end DESC
       LIMIT 1`).get(t,e,a)||null}async function u(t,e,a,r,s,n=!0){let i=(0,o.getDb)(),c="pool"in i||"function"==typeof i.pool?.query,l=`probe-${t}-${e}-${a}%`;return c?(await i.pool.query(`SELECT ra.* FROM route_attempts ra
       LEFT JOIN routes r ON (ra.route_id::text = r.id::text AND ra.is_probe = false)
       WHERE ra.facilitator_id = $1
         AND (
           (ra.is_probe = true AND ra.route_id::text LIKE $2)
           OR (ra.is_probe = false AND r.network = $3 AND r.token = $4)
         )
         AND ra.created_at >= $5
         AND ra.created_at < $6
       ORDER BY ra.created_at`,[t,l,e,a,r,s])).rows:i.prepare(`SELECT ra.* FROM route_attempts ra
       LEFT JOIN routes r ON (ra.route_id = r.id AND ra.is_probe = 0)
       WHERE ra.facilitator_id = ?
         AND (
           (ra.is_probe = 1 AND ra.route_id LIKE ?)
           OR (ra.is_probe = 0 AND r.network = ? AND r.token = ?)
         )
         AND ra.created_at >= ?
         AND ra.created_at < ?
       ORDER BY ra.created_at`).all(t,l,e,a,r,s)}async function _(t){let e=(0,o.getDb)(),a=crypto.randomUUID(),r=new Date().toISOString();return"pool"in e||"function"==typeof e.pool?.query?(await e.pool.query(`INSERT INTO facilitator_health_snapshots (
        id, facilitator_id, network, token, window_start, window_end,
        success_rate, p50_latency_ms, p95_latency_ms, p99_latency_ms,
        error_rate, last_error_type, status, created_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14)
      ON CONFLICT (facilitator_id, network, token, window_end)
      DO UPDATE SET
        success_rate = EXCLUDED.success_rate,
        p50_latency_ms = EXCLUDED.p50_latency_ms,
        p95_latency_ms = EXCLUDED.p95_latency_ms,
        p99_latency_ms = EXCLUDED.p99_latency_ms,
        error_rate = EXCLUDED.error_rate,
        last_error_type = EXCLUDED.last_error_type,
        status = EXCLUDED.status
      RETURNING *`,[a,t.facilitator_id,t.network,t.token,t.window_start,t.window_end,t.success_rate,t.p50_latency_ms,t.p95_latency_ms,t.p99_latency_ms,t.error_rate,t.last_error_type,t.status,r])).rows[0]:(e.prepare(`
      INSERT INTO facilitator_health_snapshots (
        id, facilitator_id, network, token, window_start, window_end,
        success_rate, p50_latency_ms, p95_latency_ms, p99_latency_ms,
        error_rate, last_error_type, status, created_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(a,t.facilitator_id,t.network,t.token,t.window_start,t.window_end,t.success_rate,t.p50_latency_ms,t.p95_latency_ms,t.p99_latency_ms,t.error_rate,t.last_error_type,t.status,r),{id:a,...t,created_at:r})}async function p(t){let e=(0,o.getDb)();"pool"in e||"function"==typeof e.pool?.query?await e.pool.query(`INSERT INTO facilitator_probe_events (
        probe_config_id, facilitator_id, network, token, result,
        error_code, facilitator_status, facilitator_error_code, latency_ms
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)`,[t.probe_config_id,t.facilitator_id,t.network,t.token,t.result,t.error_code,t.facilitator_status,t.facilitator_error_code,t.latency_ms]):f.warn("facilitator_probe_events table not available in SQLite")}t.s(["createRoute",()=>n,"createRouteAttempt",()=>c,"getFacilitatorCapabilities",()=>l,"getLatestHealthSnapshot",()=>d,"getRouteAttemptsForHealth",()=>u,"recordFacilitatorProbeEvent",()=>p,"updateRouteStatus",()=>i,"upsertHealthSnapshot",()=>_]),a()}catch(t){a(t)}},!1),22444,t=>{"use strict";let e=(0,t.i(50377).createLogger)({component:"BaseFacilitator"});class a{getLogger(){return e.child({facilitator:this.constructor.name})}async getPricing(t,e){return null}supports(t,e,a,o){return!!this.config.enabled&&!!this.config.schemes.includes(a)&&(!o||!this.config.settlementModes||!!this.config.settlementModes.includes(o))&&!!(this.config.networks.includes(t)||this.config.networksCAIP&&this.config.networksCAIP.includes(t))&&(this.config.assets.includes(e)||this.config.assetsCAIP&&this.config.assetsCAIP.includes(e))}supportsCAIPNetwork(t){return!!this.config.enabled&&(this.config.networksCAIP?.includes(t)||!1)}supportsCAIPAsset(t){return!!this.config.enabled&&(this.config.assetsCAIP?.includes(t)||!1)}validateRequirements(t){if(!(t.network||t.networks&&t.networks.length>0))return{valid:!1,error:"Network is required"};if(!(t.asset||t.assets&&t.assets.length>0))return{valid:!1,error:"Asset is required"};if(!t.payTo)return{valid:!1,error:"Recipient address (payTo) is required"};if(!t.maxAmountRequired)return{valid:!1,error:"Amount is required"};let e=t.network||t.networks?.[0]||"",a=t.asset||t.assets?.[0]||"";return t.networks&&t.networks.length>0&&!t.networks.some(t=>this.supportsCAIPNetwork(t)||this.config.networks.includes(t))?{valid:!1,error:`Facilitator ${this.id} does not support any of the requested networks: ${t.networks.join(", ")}`}:t.assets&&t.assets.length>0&&!t.assets.some(t=>this.supportsCAIPAsset(t)||this.config.assets.includes(t))?{valid:!1,error:`Facilitator ${this.id} does not support any of the requested assets: ${t.assets.join(", ")}`}:this.supports(e,a,t.scheme,t.settlementMode)?{valid:!0}:{valid:!1,error:`Facilitator ${this.id} does not support ${e}/${a}/${t.scheme}`}}}t.s(["BaseFacilitator",()=>a])},41500,t=>t.a(async(e,a)=>{try{var o=t.i(50377),r=t.i(87768),s=t.i(3004),n=e([r,s]);[r,s]=n.then?(await n)():n;let u=(0,o.createLogger)({component:"FacilitatorMetricsReader"}),_={maxDataAgeHours:parseFloat(process.env.METRICS_MAX_AGE_HOURS??"4"),minInvocationsHighConfidence:parseInt(process.env.METRICS_MIN_INVOCATIONS_HIGH??"1000",10),minInvocationsMinimum:parseInt(process.env.METRICS_MIN_INVOCATIONS??"100",10),lowConfidencePenalty:parseFloat(process.env.METRICS_LOW_CONFIDENCE_PENALTY??"0.5")},p=parseFloat(process.env.SCATTERING_SCORE_WEIGHT??"0.2"),f=parseInt(process.env.SCATTERING_MIN_TX_COUNT??"100",10),m=parseFloat(process.env.SCATTERING_MIN_VOLUME??"100"),h=1-p;async function i(t){let e=t.timeframe??"1d",a=[];try{let o,n,i,c,l,d,_=await (0,r.getSummary)(t.facilitatorId,e),y=50,$=0,w=1/0,g=0,I=!1;if(_){I=!0;let t=50*($=1-_.overallErrorRate);a.push(`success-rate:${(100*$).toFixed(1)}%`);let e=30,r=_.avgP90LatencyMs??_.avgP99LatencyMs;if(void 0!==r){let t=Math.min(r,2e3)/2e3;e=(1-t)*30,a.push(`p95-latency:${r.toFixed(0)}ms`),n=_.avgP90LatencyMs}else e=15,a.push("latency:unknown");let s=Math.min(_.totalInvocations/1e3,1);g=_.totalInvocations,a.push(`x402scan:${_.totalInvocations}/${_.totalInvocations>=1e3?"high":_.totalInvocations>=100?"medium":"low"}-confidence`);let i=new Date(_.fetchedAt);w=(Date.now()-i.getTime())/36e5;let c=Math.max(0,1-w/24);y=t+e+10*s+10*c,o=_.avgP50LatencyMs}else a.push("x402scan:no-data");let E=0,D=!1,N=!1;try{let e=await (0,s.getScatteringMetricsForFacilitator)(t.facilitatorId);e?(N=!0,i=e.volumeUsd3d,c=e.txCount3d,l=e.uniqueBuyers3d,e.txCount3d<f&&e.volumeUsd3d<m?(D=!0,E=.1,a.push(`scattering-low-activity:${e.txCount3d}tx/$${e.volumeUsd3d.toFixed(0)}`)):(E=(0,s.computeActivityScore)(e),a.push(`scattering-activity:${E.toFixed(2)}`))):a.push("scattering:no-data")}catch(e){u.debug({error:e instanceof Error?e.message:"Unknown",facilitatorId:t.facilitatorId,msg:"Failed to fetch Scattering metrics for scoring"}),a.push("scattering:error")}d=I&&N?h*y+p*E*100:I?y:N?100*E:50;let k="none";return I?k=g>=1e3&&w<6?"high":g>=100&&w<24?"medium":"low":N&&!D&&(k=E>.5?"medium":"low"),{facilitatorId:t.facilitatorId,score:Math.round(d),successRate:$,avgLatencyMs:o,p95LatencyMs:n,totalInvocations:g,dataFreshness:w,confidence:k,reasons:a,scatteringActivityScore:N?E:void 0,scatteringVolume3d:i,scatteringTxCount3d:c,scatteringUniqueBuyers3d:l,scatteringLowActivity:D||void 0}}catch(e){return u.error({error:e instanceof Error?e.message:"Unknown error",facilitatorId:t.facilitatorId,msg:"Failed to get facilitator score"}),null}}async function c(t,e="1d",a=_){let o=[],r=[];for(let s of t){let t=await i({facilitatorId:s,timeframe:e});if(!t){r.push({id:s,reason:"no-data"});continue}let n=function(t,e,a=_){return t>a.maxDataAgeHours?{trust:!1,confidence:"none",reason:`data-stale:${t.toFixed(1)}h-old`}:e<a.minInvocationsMinimum?{trust:!1,confidence:"none",reason:`insufficient-data:${e}-invocations`}:e>=a.minInvocationsHighConfidence?{trust:!0,confidence:"high",reason:`high-confidence:${e}-invocations`}:{trust:!0,confidence:"medium",reason:`medium-confidence:${e}-invocations`}}(t.dataFreshness,t.totalInvocations,a);if(!n.trust){r.push({id:s,reason:n.reason}),o.push({...t,score:t.score*a.lowConfidencePenalty,confidence:"low",reasons:[...t.reasons,`untrusted:${n.reason}`]});continue}"medium"===n.confidence?o.push({...t,score:.9*t.score,confidence:"medium",reasons:[...t.reasons,n.reason]}):o.push({...t,reasons:[...t.reasons,n.reason]})}return r.length>0&&u.debug({untrusted:r,trusted:o.filter(t=>"low"!==t.confidence).map(t=>t.facilitatorId),msg:"Facilitator metrics trust check results"}),o.sort((t,e)=>e.score-t.score),{rankings:o,timestamp:new Date().toISOString(),timeframe:e}}async function l(t,e){let a,o=e?.timeframe??"1d",r=e?.trustConfig??_,s=await c(t,o,r),n=s.rankings.filter(t=>"low"!==t.confidence);if(0===n.length)return u.warn({candidates:t,rankings:s.rankings.map(t=>({id:t.facilitatorId,confidence:t.confidence,reasons:t.reasons})),msg:"No trusted x402scan data available, using fallback"}),{recommended:t[0]??null,ranking:s,reason:"No trusted x402scan data (stale or insufficient), using default order",usedFallback:!0};switch(e?.prioritize??"balanced"){case"latency":a=n.filter(t=>void 0!==t.p95LatencyMs).sort((t,e)=>(t.p95LatencyMs??1/0)-(e.p95LatencyMs??1/0))[0]??n[0];break;case"reliability":a=[...n].sort((t,e)=>e.successRate-t.successRate)[0];break;default:a=n[0]}return{recommended:a.facilitatorId,ranking:s,reason:`Selected ${a.facilitatorId} with score ${a.score} (${a.confidence} confidence, ${a.reasons.slice(0,3).join(", ")})`,usedFallback:!1}}async function d(t,e){let a=e?.timeframe??"1d",o=e?.wasSelected??!1,r=await i({facilitatorId:t,timeframe:a});if(!r)return{facilitatorId:t,selected:o,score:50,confidence:"low",shortReason:`${t}: no x402scan data available`,detailedReasons:["No observability data from x402scan"],metrics:{}};let s=(100*r.successRate).toFixed(1),n=r.p95LatencyMs?`${r.p95LatencyMs.toFixed(0)}ms p95`:"latency unknown",c=r.totalInvocations>=1e3?`${(r.totalInvocations/1e3).toFixed(1)}K invocations`:`${r.totalInvocations} invocations`,l=`${t}: ${s}% success, ${n}, ${r.confidence} confidence (${c})`,d=[];return r.successRate>=.99?d.push(`Excellent success rate: ${s}%`):r.successRate>=.95?d.push(`Good success rate: ${s}%`):r.successRate>=.9?d.push(`Acceptable success rate: ${s}%`):d.push(`⚠️ Low success rate: ${s}%`),void 0!==r.p95LatencyMs&&(r.p95LatencyMs<200?d.push(`Fast response times: ${r.p95LatencyMs.toFixed(0)}ms p95`):r.p95LatencyMs<500?d.push(`Moderate latency: ${r.p95LatencyMs.toFixed(0)}ms p95`):d.push(`⚠️ High latency: ${r.p95LatencyMs.toFixed(0)}ms p95`)),"high"===r.confidence?d.push(`High confidence: ${c}, data ${r.dataFreshness.toFixed(1)}h old`):"medium"===r.confidence?d.push(`Medium confidence: ${c}`):d.push(`Low confidence: limited data (${c})`),r.dataFreshness>12&&d.push(`⚠️ Data is ${r.dataFreshness.toFixed(1)} hours old`),{facilitatorId:t,selected:o,score:r.score,confidence:r.confidence,shortReason:l,detailedReasons:d,metrics:{successRate:r.successRate,errorRate:1-r.successRate,p95LatencyMs:r.p95LatencyMs,invocations:r.totalInvocations,dataAgeHours:r.dataFreshness}}}t.s(["getFacilitatorExplainer",()=>d,"getFacilitatorScore",()=>i,"getRecommendedFacilitator",()=>l,"rankFacilitators",()=>c]),a()}catch(t){a(t)}},!1)];

//# sourceMappingURL=src_a3554d02._.js.map
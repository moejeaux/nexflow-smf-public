module.exports=[93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},22734,(e,t,r)=>{t.exports=e.x("fs",()=>require("fs"))},30056,e=>e.a(async(t,r)=>{try{let t=await e.y("pg");e.n(t),r()}catch(e){r(e)}},!0),14747,(e,t,r)=>{t.exports=e.x("path",()=>require("path"))},70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},24361,(e,t,r)=>{t.exports=e.x("util",()=>require("util"))},87769,(e,t,r)=>{t.exports=e.x("node:events",()=>require("node:events"))},874,(e,t,r)=>{t.exports=e.x("buffer",()=>require("buffer"))},27699,(e,t,r)=>{t.exports=e.x("events",()=>require("events"))},92509,(e,t,r)=>{t.exports=e.x("url",()=>require("url"))},49719,(e,t,r)=>{t.exports=e.x("assert",()=>require("assert"))},62562,(e,t,r)=>{t.exports=e.x("module",()=>require("module"))},50227,(e,t,r)=>{t.exports=e.x("node:path",()=>require("node:path"))},94346,e=>{e.v({name:"thread-stream",version:"3.1.0",description:"A streaming way to send data to a Node.js Worker Thread",main:"index.js",types:"index.d.ts",dependencies:{"real-require":"^0.2.0"},devDependencies:{"@types/node":"^20.1.0","@types/tap":"^15.0.0","@yao-pkg/pkg":"^5.11.5",desm:"^1.3.0",fastbench:"^1.0.1",husky:"^9.0.6","pino-elasticsearch":"^8.0.0","sonic-boom":"^4.0.1",standard:"^17.0.0",tap:"^16.2.0","ts-node":"^10.8.0",typescript:"^5.3.2","why-is-node-running":"^2.2.2"},scripts:{build:"tsc --noEmit",test:'standard && npm run build && npm run transpile && tap "test/**/*.test.*js" && tap --ts test/*.test.*ts',"test:ci":"standard && npm run transpile && npm run test:ci:js && npm run test:ci:ts","test:ci:js":'tap --no-check-coverage --timeout=120 --coverage-report=lcovonly "test/**/*.test.*js"',"test:ci:ts":'tap --ts --no-check-coverage --coverage-report=lcovonly "test/**/*.test.*ts"',"test:yarn":'npm run transpile && tap "test/**/*.test.js" --no-check-coverage',transpile:"sh ./test/ts/transpile.sh",prepare:"husky install"},standard:{ignore:["test/ts/**/*","test/syntax-error.mjs"]},repository:{type:"git",url:"git+https://github.com/mcollina/thread-stream.git"},keywords:["worker","thread","threads","stream"],author:"Matteo Collina <hello@matteocollina.com>",license:"MIT",bugs:{url:"https://github.com/mcollina/thread-stream/issues"},homepage:"https://github.com/mcollina/thread-stream#readme"})},37702,(e,t,r)=>{t.exports=e.x("worker_threads",()=>require("worker_threads"))},60526,(e,t,r)=>{t.exports=e.x("node:os",()=>require("node:os"))},77652,(e,t,r)=>{t.exports=e.x("node:diagnostics_channel",()=>require("node:diagnostics_channel"))},60827,e=>e.a(async(t,r)=>{try{var o=e.i(24924),a=e.i(50377),s=t([o]);[o]=s.then?(await s)():s;let m=(0,a.createLogger)({component:"SMFDatabase"});async function n(e){let t=(0,o.getDb)(),r=crypto.randomUUID(),a=new Date().toISOString();return"pool"in t||"function"==typeof t.pool?.query?(await t.pool.query(`INSERT INTO routes (
        id, request_id, correlation_id, client_id, agent_id, network, token, amount,
        selected_facilitator_id, status, created_at, updated_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12)
      RETURNING *`,[r,e.request_id,e.correlation_id,e.client_id,e.agent_id,e.network,e.token,e.amount,e.selected_facilitator_id,e.status,a,a])).rows[0]:(t.prepare(`
      INSERT INTO routes (
        id, request_id, correlation_id, client_id, agent_id, network, token, amount,
        selected_facilitator_id, status, created_at, updated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(r,e.request_id,e.correlation_id,e.client_id,e.agent_id,e.network,e.token,e.amount,e.selected_facilitator_id,e.status,a,a),{id:r,...e,created_at:a,updated_at:a,completed_at:null})}async function i(e,t,r){let a=(0,o.getDb)(),s=new Date().toISOString();"pool"in a||"function"==typeof a.pool?.query?await a.pool.query("UPDATE routes SET status = $1, updated_at = $2, completed_at = $3 WHERE id = $4",[t,s,r||null,e]):a.prepare("UPDATE routes SET status = ?, updated_at = ?, completed_at = ? WHERE id = ?").run(t,s,r||null,e)}async function l(e){let t=(0,o.getDb)(),r=crypto.randomUUID(),a=new Date().toISOString();return"pool"in t||"function"==typeof t.pool?.query?(await t.pool.query(`INSERT INTO route_attempts (
        id, route_id, facilitator_id, phase, result, latency_ms, error_code, raw_status, is_probe, created_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)
      RETURNING *`,[r,e.route_id,e.facilitator_id,e.phase,e.result,e.latency_ms,e.error_code,e.raw_status,e.is_probe??!1,a])).rows[0]:(t.prepare(`
      INSERT INTO route_attempts (
        id, route_id, facilitator_id, phase, result, latency_ms, error_code, raw_status, is_probe, created_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(r,e.route_id,e.facilitator_id,e.phase,e.result,e.latency_ms,e.error_code,e.raw_status,e.is_probe??!1,a),{id:r,...e,created_at:a})}async function c(e,t,r){let a=(0,o.getDb)(),s="pool"in a||"function"==typeof a.pool?.query,n="SELECT * FROM facilitator_capabilities WHERE 1=1",i=[],l=1;return(e&&(s?n+=` AND facilitator_id = $${l++}`:n+=" AND facilitator_id = ?",i.push(e)),t&&(s?n+=` AND network = $${l++}`:n+=" AND network = ?",i.push(t)),r&&(s?n+=` AND token = $${l++}`:n+=" AND token = ?",i.push(r)),s)?(await a.pool.query(n,i)).rows:a.prepare(n).all(...i)}async function d(e,t,r){let a=(0,o.getDb)();return"pool"in a||"function"==typeof a.pool?.query?(await a.pool.query(`SELECT * FROM facilitator_health_snapshots
       WHERE facilitator_id = $1 AND network = $2 AND token = $3
       ORDER BY window_end DESC
       LIMIT 1`,[e,t,r])).rows[0]||null:a.prepare(`SELECT * FROM facilitator_health_snapshots
       WHERE facilitator_id = ? AND network = ? AND token = ?
       ORDER BY window_end DESC
       LIMIT 1`).get(e,t,r)||null}async function u(e,t,r,a,s,n=!0){let i=(0,o.getDb)(),l="pool"in i||"function"==typeof i.pool?.query,c=`probe-${e}-${t}-${r}%`;return l?(await i.pool.query(`SELECT ra.* FROM route_attempts ra
       LEFT JOIN routes r ON (ra.route_id::text = r.id::text AND ra.is_probe = false)
       WHERE ra.facilitator_id = $1
         AND (
           (ra.is_probe = true AND ra.route_id::text LIKE $2)
           OR (ra.is_probe = false AND r.network = $3 AND r.token = $4)
         )
         AND ra.created_at >= $5
         AND ra.created_at < $6
       ORDER BY ra.created_at`,[e,c,t,r,a,s])).rows:i.prepare(`SELECT ra.* FROM route_attempts ra
       LEFT JOIN routes r ON (ra.route_id = r.id AND ra.is_probe = 0)
       WHERE ra.facilitator_id = ?
         AND (
           (ra.is_probe = 1 AND ra.route_id LIKE ?)
           OR (ra.is_probe = 0 AND r.network = ? AND r.token = ?)
         )
         AND ra.created_at >= ?
         AND ra.created_at < ?
       ORDER BY ra.created_at`).all(e,c,t,r,a,s)}async function _(e){let t=(0,o.getDb)(),r=crypto.randomUUID(),a=new Date().toISOString();return"pool"in t||"function"==typeof t.pool?.query?(await t.pool.query(`INSERT INTO facilitator_health_snapshots (
        id, facilitator_id, network, token, window_start, window_end,
        success_rate, p50_latency_ms, p95_latency_ms, p99_latency_ms,
        error_rate, last_error_type, status, created_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14)
      ON CONFLICT (facilitator_id, network, token, window_end)
      DO UPDATE SET
        success_rate = EXCLUDED.success_rate,
        p50_latency_ms = EXCLUDED.p50_latency_ms,
        p95_latency_ms = EXCLUDED.p95_latency_ms,
        p99_latency_ms = EXCLUDED.p99_latency_ms,
        error_rate = EXCLUDED.error_rate,
        last_error_type = EXCLUDED.last_error_type,
        status = EXCLUDED.status
      RETURNING *`,[r,e.facilitator_id,e.network,e.token,e.window_start,e.window_end,e.success_rate,e.p50_latency_ms,e.p95_latency_ms,e.p99_latency_ms,e.error_rate,e.last_error_type,e.status,a])).rows[0]:(t.prepare(`
      INSERT INTO facilitator_health_snapshots (
        id, facilitator_id, network, token, window_start, window_end,
        success_rate, p50_latency_ms, p95_latency_ms, p99_latency_ms,
        error_rate, last_error_type, status, created_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(r,e.facilitator_id,e.network,e.token,e.window_start,e.window_end,e.success_rate,e.p50_latency_ms,e.p95_latency_ms,e.p99_latency_ms,e.error_rate,e.last_error_type,e.status,a),{id:r,...e,created_at:a})}async function p(e){let t=(0,o.getDb)();"pool"in t||"function"==typeof t.pool?.query?await t.pool.query(`INSERT INTO facilitator_probe_events (
        probe_config_id, facilitator_id, network, token, result,
        error_code, facilitator_status, facilitator_error_code, latency_ms
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)`,[e.probe_config_id,e.facilitator_id,e.network,e.token,e.result,e.error_code,e.facilitator_status,e.facilitator_error_code,e.latency_ms]):m.warn("facilitator_probe_events table not available in SQLite")}e.s(["createRoute",()=>n,"createRouteAttempt",()=>l,"getFacilitatorCapabilities",()=>c,"getLatestHealthSnapshot",()=>d,"getRouteAttemptsForHealth",()=>u,"recordFacilitatorProbeEvent",()=>p,"updateRouteStatus",()=>i,"upsertHealthSnapshot",()=>_]),r()}catch(e){r(e)}},!1),30344,e=>{"use strict";let t={cdp:{id:"cdp",name:"CDP x402 Facilitator",baseUrl:process.env.CDP_FACILITATOR_URL||"https://api.cdp.coinbase.com/platform/v2/x402",networks:["eip155:8453","solana:mainnet","eip155:84532","solana:devnet"],tokens:["USDC"],feeBps:0,priority:100},payai:{id:"payai",name:"PayAI Facilitator",baseUrl:process.env.PAYAI_FACILITATOR_URL||"https://facilitator.payai.network",networks:["eip155:1","eip155:8453","eip155:56","eip155:137","solana:mainnet"],tokens:["USDC"],feeBps:10,priority:200},x402rs:{id:"x402rs",name:"X402rs Facilitator",baseUrl:process.env.X402RS_FACILITATOR_URL||"https://facilitator.x402.rs",networks:["eip155:84532","eip155:8453","xdc:50"],tokens:["USDC"],feeBps:0,priority:150},dexter:{id:"dexter",name:"Dexter Facilitator",baseUrl:process.env.DEXTER_FACILITATOR_URL||"https://facilitator.dexter.cash",networks:["solana:101","solana:mainnet","solana:102","solana:devnet"],tokens:["USDC"],feeBps:0,priority:120},cronos:{id:"cronos",name:"Cronos x402 Facilitator",baseUrl:process.env.CRONOS_FACILITATOR_URL||"https://facilitator.cronoslabs.org",networks:["eip155:25","cronos","eip155:338","cronos-testnet"],tokens:["USDC","USDX"],feeBps:0,priority:130}};function r(){return Object.values(t)}function o(e){return Object.values(t).filter(t=>t.networks.includes(e))}e.s(["FACILITATORS",0,t,"getAllFacilitators",()=>r,"getFacilitatorsForNetwork",()=>o])},26436,e=>e.a(async(t,r)=>{try{var o=e.i(60827),a=e.i(24924),s=e.i(50377),n=e.i(30344),i=t([o,a]);[o,a]=i.then?(await i)():i;let f=(0,s.createLogger)({component:"FacilitatorProbes"}),h=new Map;async function l(e,t,r){let s=`${e}-${t}-${r}`;if(h.has(s))return h.get(s);try{let a=await (0,o.createRoute)({request_id:`probe-${s}`,correlation_id:null,client_id:"smf-probe-system",agent_id:null,network:t,token:r,amount:"1",selected_facilitator_id:e,status:"planned"});return h.set(s,a.id),a.id}catch(o){f.warn({error:o,facilitatorId:e,network:t,token:r},"Failed to create probe route, trying to find existing");try{let e=(0,a.getDb)();if("pool"in e||"function"==typeof e.pool?.query){let t=await e.pool.query("SELECT id FROM routes WHERE request_id = $1 LIMIT 1",[`probe-${s}`]);if(t.rows.length>0){let e=t.rows[0].id;return h.set(s,e),e}}}catch(e){f.error({queryError:e},"Failed to query for existing probe route")}throw Error(`Failed to create or find probe route for ${s}: ${o instanceof Error?o.message:"Unknown error"}`)}}let w=[{facilitatorId:"cdp",network:"eip155:8453",token:"USDC",intervalMs:3e4}],y=new Map;function c(e,t){return`${e}:${t}`}function d(e,t){let r=c(e,t),o=y.get(r);return!!o&&Date.now()<o.cooldownUntil}function u(e,t,r){let o=n.FACILITATORS[e];if(!o)throw Error(`Facilitator ${e} not found in registry`);let a=t;"eip155:8453"===t?a="base":t.startsWith("solana:")&&(a="solana");let s=r;return"eip155:8453"===t&&"USDC"===r&&(s="0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"),{scheme:"x402",network:a,asset:s,maxAmountRequired:"1",resource:`https://probe.nexflow.dev/health/${e}/${t}/${r}`,description:`Health probe for ${e} on ${t}`,mimeType:"application/json",payTo:o.baseUrl,maxTimeoutSeconds:10,settlementMode:"immediate"}}async function _(t){let{facilitatorId:r,network:a,token:s,intervalMs:n}=t;if(d(r,a))return void f.debug({facilitatorId:r,network:a},"Skipping probe - in rate limit cooldown");try{let{getFacilitatorRouter:t}=await e.A(89416),i=t().getFacilitators().find(e=>e.id===r);if(!i)return void f.warn({facilitatorId:r},"Facilitator not found in router, skipping probe");let d=u(r,a,s),_=`x402: version=2, scheme=x402, network=${a}, token=${s}, amount=1`,p=Date.now(),m="success",h=null,w=null;try{let e=await i.verify(_,d),t=Date.now()-p;if(e.success&&e.valid){m="success";let e=c(r,a),t=y.get(e);if(t&&t.currentInterval>n){let o=Math.max(n,Math.floor(.75*t.currentInterval));y.set(e,{facilitatorId:r,network:a,cooldownUntil:0,currentInterval:o})}else y.set(e,{facilitatorId:r,network:a,cooldownUntil:0,currentInterval:n})}else{let t=(e.error||"").toLowerCase();m=t.includes("timeout")||t.includes("network")||t.includes("econnrefused")?"network_error":t.includes("invalid json")||t.includes("invalid payment")||t.includes("malformed")||t.includes("parse error")||t.includes("does not support")||t.includes("unsupported")||t.includes("not supported")?"invalid_request":"failure",h=e.error||null}let u=await l(r,a,s);await (0,o.createRouteAttempt)({route_id:u,facilitator_id:r,phase:"verify",result:m,latency_ms:t,error_code:h,raw_status:w,is_probe:!0}),f.debug({facilitatorId:r,network:a,token:s,result:m,latency:t},"Probe completed")}catch(u){let e=Date.now()-p,t=u instanceof Error?u.message:"Unknown error",i=t.toLowerCase();if(i.includes("timeout")||i.includes("timed out"))m="timeout";else if(i.includes("rate")||i.includes("429")||i.includes("too many requests")){let e,t;m="rate_limited",w=429,e=c(r,a),t=2*n,y.set(e,{facilitatorId:r,network:a,cooldownUntil:Date.now()+3e5,currentInterval:t}),f.warn({facilitatorId:r,network:a,cooldownMs:3e5,newInterval:t},"Rate limit detected, entering cooldown period")}else m=i.includes("network")||i.includes("econnrefused")||i.includes("connection")?"network_error":i.includes("invalid json")||i.includes("invalid payment")||i.includes("malformed")||i.includes("parse error")||i.includes("does not support")||i.includes("unsupported")||i.includes("not supported")?"invalid_request":"failure";h=t;let d=await l(r,a,s);await (0,o.createRouteAttempt)({route_id:d,facilitator_id:r,phase:"verify",result:m,latency_ms:e,error_code:h,raw_status:w,is_probe:!0}),f.warn({facilitatorId:r,network:a,token:s,result:m,error:t},"Probe failed")}}catch(e){f.error({error:e,facilitatorId:r,network:a,token:s},"Probe execution error")}}async function p(){f.info({env:"production",probeCount:w.length,probes:w.map(e=>({facilitator:e.facilitatorId,network:e.network,token:e.token,intervalSeconds:e.intervalMs/1e3}))},"Starting facilitator probes");try{await e.A(87548),await e.A(6885),f.info("Required dependencies (@coinbase/cdp-sdk/auth, viem) are available")}catch(e){return f.warn({error:e instanceof Error?e.message:"Unknown error"},"Facilitator probes disabled - required dependencies (@coinbase/cdp-sdk/auth, viem) not available"),[]}let t=w.map(e=>{try{return function e(t){let{facilitatorId:r,network:o,token:a,intervalMs:s}=t;f.info({facilitatorId:r,network:o,token:a,intervalMs:s},"Starting facilitator probe"),_(t).catch(e=>{f.error({error:e,facilitatorId:r,network:o,token:a},"Initial probe failed")});let n=setInterval(()=>{let i,l,u=(i=c(r,o),(l=y.get(i))&&l.currentInterval>s?l.currentInterval:s);if(d(r,o))return void f.debug({facilitatorId:r,network:o},"Skipping probe - in cooldown");if(u!==s){clearInterval(n),e({...t,intervalMs:u});return}_(t).catch(e=>{f.error({error:e,facilitatorId:r,network:o,token:a},"Scheduled probe failed")})},s);return n}(e)}catch(t){return f.error({error:t,config:e},"Failed to start probe scheduler for config"),null}}).filter(e=>null!==e);return f.info({started:t.length,total:w.length},"Facilitator probes started"),t}function m(e){e.forEach(e=>clearInterval(e)),f.info("Stopped all facilitator probes")}e.s(["PROBE_CONFIG",0,w,"buildProbeRequirements",()=>u,"getOrCreateProbeRoute",()=>l,"startFacilitatorProbes",()=>p,"stopFacilitatorProbes",()=>m]),r()}catch(e){r(e)}},!1),89416,e=>{e.v(t=>Promise.all(["server/chunks/_fc530d32._.js","server/chunks/[root-of-the-server]__a765e8f6._.js","server/chunks/_05a3425a._.js","server/chunks/src_integrations_x402_75d3e0c5._.js","server/chunks/node_modules_viem__esm_6afb56d2._.js","server/chunks/node_modules_@coinbase_cdp-sdk__esm_auth_utils_jwt_83481f05.js","server/chunks/src_services_b76bdbea._.js","server/chunks/src_ab5eb711._.js"].map(t=>e.l(t))).then(()=>t(57729)))},87548,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__f95ab0e5._.js","server/chunks/[root-of-the-server]__d6352941._.js","server/chunks/node_modules_@coinbase_cdp-sdk__esm_auth_utils_jwt_83481f05.js"].map(t=>e.l(t))).then(()=>t(87111)))},6885,e=>{e.v(t=>Promise.all(["server/chunks/node_modules_cbdd5cab._.js","server/chunks/[root-of-the-server]__0322765b._.js","server/chunks/node_modules_viem__esm_fc430adf._.js","server/chunks/node_modules_viem__esm_fa025007._.js","server/chunks/node_modules_viem__esm_7be986f3._.js","server/chunks/node_modules_viem__esm_index_2539e189.js","server/chunks/node_modules_073df2c7._.js","server/chunks/node_modules_viem_1d205ba3._.js","server/chunks/node_modules_bc74a3ae._.js","server/chunks/node_modules_viem__esm_fa967896._.js"].map(t=>e.l(t))).then(()=>t(56030)))},87838,e=>{e.v(e=>Promise.resolve().then(()=>e(26436)))},2759,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__7ebfd264._.js","server/chunks/node_modules_@upstash_redis_nodejs_mjs_85cd95da._.js"].map(t=>e.l(t))).then(()=>t(58119)))},6538,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__bc7866ad._.js","server/chunks/[root-of-the-server]__bbbc7a9e._.js","server/chunks/node_modules_@ioredis_commands_built_commands_json_862661ff._.js"].map(t=>e.l(t))).then(()=>t(42512)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__a3d402a6._.js.map
{"version":3,"sources":["turbopack:///[project]/node_modules/thread-stream/package.json","../../../src/lib/circuit-breaker.ts"],"sourcesContent":["{\"name\":\"thread-stream\",\"version\":\"3.1.0\",\"description\":\"A streaming way to send data to a Node.js Worker Thread\",\"main\":\"index.js\",\"types\":\"index.d.ts\",\"dependencies\":{\"real-require\":\"^0.2.0\"},\"devDependencies\":{\"@types/node\":\"^20.1.0\",\"@types/tap\":\"^15.0.0\",\"@yao-pkg/pkg\":\"^5.11.5\",\"desm\":\"^1.3.0\",\"fastbench\":\"^1.0.1\",\"husky\":\"^9.0.6\",\"pino-elasticsearch\":\"^8.0.0\",\"sonic-boom\":\"^4.0.1\",\"standard\":\"^17.0.0\",\"tap\":\"^16.2.0\",\"ts-node\":\"^10.8.0\",\"typescript\":\"^5.3.2\",\"why-is-node-running\":\"^2.2.2\"},\"scripts\":{\"build\":\"tsc --noEmit\",\"test\":\"standard && npm run build && npm run transpile && tap \\\"test/**/*.test.*js\\\" && tap --ts test/*.test.*ts\",\"test:ci\":\"standard && npm run transpile && npm run test:ci:js && npm run test:ci:ts\",\"test:ci:js\":\"tap --no-check-coverage --timeout=120 --coverage-report=lcovonly \\\"test/**/*.test.*js\\\"\",\"test:ci:ts\":\"tap --ts --no-check-coverage --coverage-report=lcovonly \\\"test/**/*.test.*ts\\\"\",\"test:yarn\":\"npm run transpile && tap \\\"test/**/*.test.js\\\" --no-check-coverage\",\"transpile\":\"sh ./test/ts/transpile.sh\",\"prepare\":\"husky install\"},\"standard\":{\"ignore\":[\"test/ts/**/*\",\"test/syntax-error.mjs\"]},\"repository\":{\"type\":\"git\",\"url\":\"git+https://github.com/mcollina/thread-stream.git\"},\"keywords\":[\"worker\",\"thread\",\"threads\",\"stream\"],\"author\":\"Matteo Collina <hello@matteocollina.com>\",\"license\":\"MIT\",\"bugs\":{\"url\":\"https://github.com/mcollina/thread-stream/issues\"},\"homepage\":\"https://github.com/mcollina/thread-stream#readme\"}","// =============================================================================\r\n// CIRCUIT BREAKER\r\n// =============================================================================\r\n// Protects against cascading failures from external services.\r\n// Implements the circuit breaker pattern with three states:\r\n// - CLOSED: Normal operation, requests pass through\r\n// - OPEN: Failure threshold exceeded, requests fail fast\r\n// - HALF_OPEN: Testing if service recovered\r\n\r\nimport { createLogger } from './logger';\r\n\r\nconst logger = createLogger({ component: 'CircuitBreaker' });\r\n\r\n// =============================================================================\r\n// TYPES\r\n// =============================================================================\r\n\r\nexport type CircuitState = 'CLOSED' | 'OPEN' | 'HALF_OPEN';\r\n\r\nexport interface CircuitBreakerConfig {\r\n  /** Name for logging and metrics */\r\n  name: string;\r\n  \r\n  /** Number of failures before opening circuit */\r\n  failureThreshold: number;\r\n  \r\n  /** Number of successes in HALF_OPEN to close circuit */\r\n  successThreshold: number;\r\n  \r\n  /** Time in ms to wait before trying HALF_OPEN */\r\n  resetTimeout: number;\r\n  \r\n  /** Time window in ms to count failures */\r\n  failureWindow: number;\r\n  \r\n  /** Timeout for individual requests in ms */\r\n  requestTimeout?: number;\r\n  \r\n  /** Optional fallback function when circuit is open */\r\n  fallback?: <T>() => T | Promise<T>;\r\n}\r\n\r\nexport interface CircuitBreakerStats {\r\n  name: string;\r\n  state: CircuitState;\r\n  failures: number;\r\n  successes: number;\r\n  lastFailure?: Date;\r\n  lastSuccess?: Date;\r\n  openedAt?: Date;\r\n  totalRequests: number;\r\n  failedRequests: number;\r\n  successRate: number;\r\n}\r\n\r\n// =============================================================================\r\n// CIRCUIT BREAKER IMPLEMENTATION\r\n// =============================================================================\r\n\r\nexport class CircuitBreaker {\r\n  private state: CircuitState = 'CLOSED';\r\n  private failures: { timestamp: number }[] = [];\r\n  private successes = 0;\r\n  private lastFailure?: Date;\r\n  private lastSuccess?: Date;\r\n  private openedAt?: Date;\r\n  private totalRequests = 0;\r\n  private failedRequests = 0;\r\n\r\n  constructor(private config: CircuitBreakerConfig) {}\r\n\r\n  /**\r\n   * Execute a function with circuit breaker protection\r\n   */\r\n  async execute<T>(fn: () => Promise<T>): Promise<T> {\r\n    this.totalRequests++;\r\n\r\n    // Check if circuit is open\r\n    if (this.state === 'OPEN') {\r\n      if (this.shouldAttemptReset()) {\r\n        this.transitionTo('HALF_OPEN');\r\n      } else {\r\n        this.failedRequests++;\r\n        logger.warn({\r\n          circuit: this.config.name,\r\n          state: this.state,\r\n          openedAt: this.openedAt,\r\n        }, 'Circuit breaker is OPEN - failing fast');\r\n\r\n        if (this.config.fallback) {\r\n          return this.config.fallback<T>();\r\n        }\r\n        throw new CircuitBreakerError(\r\n          `Circuit breaker ${this.config.name} is OPEN`,\r\n          this.config.name\r\n        );\r\n      }\r\n    }\r\n\r\n    // Execute the function\r\n    try {\r\n      const result = await this.executeWithTimeout(fn);\r\n      this.onSuccess();\r\n      return result;\r\n    } catch (error) {\r\n      this.onFailure(error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Execute function with optional timeout\r\n   */\r\n  private async executeWithTimeout<T>(fn: () => Promise<T>): Promise<T> {\r\n    if (!this.config.requestTimeout) {\r\n      return fn();\r\n    }\r\n\r\n    return Promise.race([\r\n      fn(),\r\n      new Promise<never>((_, reject) =>\r\n        setTimeout(\r\n          () => reject(new Error(`Request timeout after ${this.config.requestTimeout}ms`)),\r\n          this.config.requestTimeout\r\n        )\r\n      ),\r\n    ]);\r\n  }\r\n\r\n  /**\r\n   * Handle successful execution\r\n   */\r\n  private onSuccess(): void {\r\n    this.lastSuccess = new Date();\r\n\r\n    if (this.state === 'HALF_OPEN') {\r\n      this.successes++;\r\n      if (this.successes >= this.config.successThreshold) {\r\n        this.transitionTo('CLOSED');\r\n      }\r\n    } else if (this.state === 'CLOSED') {\r\n      // Clear old failures outside the window\r\n      this.pruneOldFailures();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Handle failed execution\r\n   */\r\n  private onFailure(error: unknown): void {\r\n    this.failedRequests++;\r\n    this.lastFailure = new Date();\r\n    this.failures.push({ timestamp: Date.now() });\r\n\r\n    logger.warn({\r\n      circuit: this.config.name,\r\n      state: this.state,\r\n      error: error instanceof Error ? error.message : 'Unknown error',\r\n      failureCount: this.failures.length,\r\n    }, 'Circuit breaker recorded failure');\r\n\r\n    if (this.state === 'HALF_OPEN') {\r\n      // Any failure in HALF_OPEN reopens the circuit\r\n      this.transitionTo('OPEN');\r\n    } else if (this.state === 'CLOSED') {\r\n      this.pruneOldFailures();\r\n      if (this.failures.length >= this.config.failureThreshold) {\r\n        this.transitionTo('OPEN');\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if we should attempt to reset from OPEN to HALF_OPEN\r\n   */\r\n  private shouldAttemptReset(): boolean {\r\n    if (!this.openedAt) return true;\r\n    return Date.now() - this.openedAt.getTime() >= this.config.resetTimeout;\r\n  }\r\n\r\n  /**\r\n   * Remove failures outside the failure window\r\n   */\r\n  private pruneOldFailures(): void {\r\n    const cutoff = Date.now() - this.config.failureWindow;\r\n    this.failures = this.failures.filter(f => f.timestamp > cutoff);\r\n  }\r\n\r\n  /**\r\n   * Transition to a new state\r\n   */\r\n  private transitionTo(newState: CircuitState): void {\r\n    const oldState = this.state;\r\n    this.state = newState;\r\n\r\n    logger.info({\r\n      circuit: this.config.name,\r\n      from: oldState,\r\n      to: newState,\r\n      failures: this.failures.length,\r\n      successes: this.successes,\r\n    }, 'Circuit breaker state transition');\r\n\r\n    if (newState === 'OPEN') {\r\n      this.openedAt = new Date();\r\n    } else if (newState === 'CLOSED') {\r\n      this.failures = [];\r\n      this.successes = 0;\r\n      this.openedAt = undefined;\r\n    } else if (newState === 'HALF_OPEN') {\r\n      this.successes = 0;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get current statistics\r\n   */\r\n  getStats(): CircuitBreakerStats {\r\n    return {\r\n      name: this.config.name,\r\n      state: this.state,\r\n      failures: this.failures.length,\r\n      successes: this.successes,\r\n      lastFailure: this.lastFailure,\r\n      lastSuccess: this.lastSuccess,\r\n      openedAt: this.openedAt,\r\n      totalRequests: this.totalRequests,\r\n      failedRequests: this.failedRequests,\r\n      successRate: this.totalRequests > 0\r\n        ? (this.totalRequests - this.failedRequests) / this.totalRequests\r\n        : 1,\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Manually reset the circuit breaker\r\n   */\r\n  reset(): void {\r\n    this.transitionTo('CLOSED');\r\n    this.totalRequests = 0;\r\n    this.failedRequests = 0;\r\n    logger.info({ circuit: this.config.name }, 'Circuit breaker manually reset');\r\n  }\r\n\r\n  /**\r\n   * Check if circuit is allowing requests\r\n   */\r\n  isAllowingRequests(): boolean {\r\n    if (this.state === 'CLOSED') return true;\r\n    if (this.state === 'HALF_OPEN') return true;\r\n    return this.shouldAttemptReset();\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// CIRCUIT BREAKER ERROR\r\n// =============================================================================\r\n\r\nexport class CircuitBreakerError extends Error {\r\n  constructor(\r\n    message: string,\r\n    public readonly circuitName: string\r\n  ) {\r\n    super(message);\r\n    this.name = 'CircuitBreakerError';\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// CIRCUIT BREAKER REGISTRY\r\n// =============================================================================\r\n\r\nconst circuitBreakers = new Map<string, CircuitBreaker>();\r\n\r\n/**\r\n * Get or create a circuit breaker\r\n */\r\nexport function getCircuitBreaker(config: CircuitBreakerConfig): CircuitBreaker {\r\n  let breaker = circuitBreakers.get(config.name);\r\n  if (!breaker) {\r\n    breaker = new CircuitBreaker(config);\r\n    circuitBreakers.set(config.name, breaker);\r\n    logger.info({ circuit: config.name }, 'Created new circuit breaker');\r\n  }\r\n  return breaker;\r\n}\r\n\r\n/**\r\n * Get all circuit breaker stats\r\n */\r\nexport function getAllCircuitBreakerStats(): CircuitBreakerStats[] {\r\n  return Array.from(circuitBreakers.values()).map(cb => cb.getStats());\r\n}\r\n\r\n/**\r\n * Reset all circuit breakers\r\n */\r\nexport function resetAllCircuitBreakers(): void {\r\n  circuitBreakers.forEach(cb => cb.reset());\r\n  logger.info({ count: circuitBreakers.size }, 'Reset all circuit breakers');\r\n}\r\n\r\n// =============================================================================\r\n// PRE-CONFIGURED CIRCUIT BREAKERS\r\n// =============================================================================\r\n\r\n/**\r\n * Circuit breaker for x402scan API\r\n */\r\nexport const x402scanCircuitBreaker = getCircuitBreaker({\r\n  name: 'x402scan',\r\n  failureThreshold: 3,\r\n  successThreshold: 2,\r\n  resetTimeout: 60000, // 1 minute\r\n  failureWindow: 300000, // 5 minutes\r\n  requestTimeout: 30000, // 30 seconds\r\n});\r\n\r\n/**\r\n * Circuit breaker for Scattering/Dune API\r\n */\r\nexport const scatteringCircuitBreaker = getCircuitBreaker({\r\n  name: 'scattering',\r\n  failureThreshold: 3,\r\n  successThreshold: 2,\r\n  resetTimeout: 60000,\r\n  failureWindow: 300000,\r\n  requestTimeout: 30000,\r\n});\r\n\r\n/**\r\n * Circuit breaker for facilitator health probes\r\n */\r\nexport const facilitatorProbeCircuitBreaker = getCircuitBreaker({\r\n  name: 'facilitator-probes',\r\n  failureThreshold: 5,\r\n  successThreshold: 3,\r\n  resetTimeout: 30000, // 30 seconds (more aggressive retry)\r\n  failureWindow: 120000, // 2 minutes\r\n  requestTimeout: 10000, // 10 seconds\r\n});\r\n\r\n"],"names":[],"mappings":"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"}
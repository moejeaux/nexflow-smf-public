module.exports=[93695,(e,t,a)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},22734,(e,t,a)=>{t.exports=e.x("fs",()=>require("fs"))},30056,e=>e.a(async(t,a)=>{try{let t=await e.y("pg");e.n(t),a()}catch(e){a(e)}},!0),14747,(e,t,a)=>{t.exports=e.x("path",()=>require("path"))},70406,(e,t,a)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},18622,(e,t,a)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},24361,(e,t,a)=>{t.exports=e.x("util",()=>require("util"))},87769,(e,t,a)=>{t.exports=e.x("node:events",()=>require("node:events"))},49719,(e,t,a)=>{t.exports=e.x("assert",()=>require("assert"))},27699,(e,t,a)=>{t.exports=e.x("events",()=>require("events"))},92509,(e,t,a)=>{t.exports=e.x("url",()=>require("url"))},874,(e,t,a)=>{t.exports=e.x("buffer",()=>require("buffer"))},62562,(e,t,a)=>{t.exports=e.x("module",()=>require("module"))},50227,(e,t,a)=>{t.exports=e.x("node:path",()=>require("node:path"))},94346,e=>{e.v({name:"thread-stream",version:"3.1.0",description:"A streaming way to send data to a Node.js Worker Thread",main:"index.js",types:"index.d.ts",dependencies:{"real-require":"^0.2.0"},devDependencies:{"@types/node":"^20.1.0","@types/tap":"^15.0.0","@yao-pkg/pkg":"^5.11.5",desm:"^1.3.0",fastbench:"^1.0.1",husky:"^9.0.6","pino-elasticsearch":"^8.0.0","sonic-boom":"^4.0.1",standard:"^17.0.0",tap:"^16.2.0","ts-node":"^10.8.0",typescript:"^5.3.2","why-is-node-running":"^2.2.2"},scripts:{build:"tsc --noEmit",test:'standard && npm run build && npm run transpile && tap "test/**/*.test.*js" && tap --ts test/*.test.*ts',"test:ci":"standard && npm run transpile && npm run test:ci:js && npm run test:ci:ts","test:ci:js":'tap --no-check-coverage --timeout=120 --coverage-report=lcovonly "test/**/*.test.*js"',"test:ci:ts":'tap --ts --no-check-coverage --coverage-report=lcovonly "test/**/*.test.*ts"',"test:yarn":'npm run transpile && tap "test/**/*.test.js" --no-check-coverage',transpile:"sh ./test/ts/transpile.sh",prepare:"husky install"},standard:{ignore:["test/ts/**/*","test/syntax-error.mjs"]},repository:{type:"git",url:"git+https://github.com/mcollina/thread-stream.git"},keywords:["worker","thread","threads","stream"],author:"Matteo Collina <hello@matteocollina.com>",license:"MIT",bugs:{url:"https://github.com/mcollina/thread-stream/issues"},homepage:"https://github.com/mcollina/thread-stream#readme"})},37702,(e,t,a)=>{t.exports=e.x("worker_threads",()=>require("worker_threads"))},60526,(e,t,a)=>{t.exports=e.x("node:os",()=>require("node:os"))},77652,(e,t,a)=>{t.exports=e.x("node:diagnostics_channel",()=>require("node:diagnostics_channel"))},54799,(e,t,a)=>{t.exports=e.x("crypto",()=>require("crypto"))},68237,e=>e.a(async(t,a)=>{try{var r=e.i(54799),n=e.i(24924),i=t([n]);function s(e){return r.default.createHash("sha256").update(e).digest("hex")}async function o(e){let t,a=(0,n.getDb)(),i=`key_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,o=(t=r.default.randomBytes(32).toString("base64url"),`nf_live_${t}`),l=s(o),d=new Date().toISOString(),u={id:i,keyHash:l,name:e.name,role:e.role||"user",userId:e.userId,rateLimit:e.rateLimit||1e3,expiresAt:e.expiresAt,createdAt:d,updatedAt:d};return await a.createApiKey(u),{...u,token:o}}async function l(e){let t=(0,n.getDb)();return await t.findApiKeyByHash(e)}async function d(e){let t=s(e);return await l(t)}async function u(e,t){let a=(0,n.getDb)();await a.updateApiKeyLastUsed(e,t)}async function c(e){let t=(0,n.getDb)();return await t.revokeApiKey(e)}async function p(e){let t=(0,n.getDb)();return await t.listApiKeys(e)}async function m(e,t,a){let r=(0,n.getDb)();await r.updateApiKeyX402DemoAllowance(e,t,a)}function y(e){let t=e.x402DemoCallsUsed||0,a=e.x402DemoCallsLimit||200,r=BigInt(e.x402DemoAmountUsed||"0"),n=BigInt(e.x402DemoAmountLimit||"1000000");return t>=a?{hasAllowance:!1,callsRemaining:0,amountRemaining:"0",reason:"Calls limit reached"}:r>=n?{hasAllowance:!1,callsRemaining:a-t,amountRemaining:"0",reason:"Amount limit reached"}:{hasAllowance:!0,callsRemaining:a-t,amountRemaining:(n-r).toString()}}async function h(e,t,a){let r=(0,n.getDb)();await r.updateApiKeyX402DemoLimits(e,t,a)}async function g(e){return(await p()).find(t=>t.id===e)||null}[n]=i.then?(await i)():i,e.s(["createApiKey",()=>o,"findApiKeyById",()=>g,"findApiKeyByToken",()=>d,"hasX402DemoAllowance",()=>y,"listApiKeys",()=>p,"revokeApiKey",()=>c,"updateApiKeyLastUsed",()=>u,"updateApiKeyX402DemoAllowance",()=>m,"updateApiKeyX402DemoLimits",()=>h]),a()}catch(e){a(e)}},!1),79832,e=>e.a(async(t,a)=>{try{var r=e.i(89171),n=e.i(68237),i=t([n]);function s(e){let t=e.headers.get("x-api-key");if(t)return t.trim();let a=e.headers.get("authorization");return a?a.startsWith("Bearer ")?a.substring(7).trim():a.trim():null}async function o(e){let t=s(e);if(!t)return{error:"Authentication required",status:401};if(!t.startsWith("nf_live_")&&!t.startsWith("nf_test_"))return{error:"Invalid API key format",status:401};let a=await (0,n.findApiKeyByToken)(t);if(!a)return{error:"Invalid API key",status:401};if(a.expiresAt&&new Date(a.expiresAt)<new Date)return{error:"API key has expired",status:401};let r=e.ip||e.headers.get("x-forwarded-for")?.split(",")[0]?.trim()||e.headers.get("x-real-ip")||void 0;return(0,n.updateApiKeyLastUsed)(a.id,r).catch(e=>{console.error("[auth] Failed to update last used:",e)}),{apiKey:a}}async function l(e,t="user"){var a;let n,i=await o(e);return"error"in i?{response:r.NextResponse.json({error:i.error,code:"UNAUTHORIZED"},{status:i.status})}:(a=i.apiKey,(n={"read-only":1,user:2,admin:3})[a.role]>=n[t])?{apiKey:i.apiKey}:{response:r.NextResponse.json({error:"Insufficient permissions",code:"FORBIDDEN",details:`Required role: ${t}, your role: ${i.apiKey.role}`},{status:403})}}[n]=i.then?(await i)():i,e.s(["authenticateRequest",()=>o,"extractApiKey",()=>s,"requireAuth",()=>l]),a()}catch(e){a(e)}},!1),49741,e=>e.a(async(t,a)=>{try{var r=e.i(54799),n=e.i(24924),i=t([n]);async function s(e){var t;let a,i,s=(0,n.getDb)(),o=new Date().toISOString(),l=r.default.randomUUID(),d=(t=e.password,a=r.default.randomBytes(16).toString("hex"),i=r.default.pbkdf2Sync(t,a,1e5,64,"sha512").toString("hex"),`${a}:${i}`);await s.query(`
    INSERT INTO accounts (id, email, password_hash, name, status, email_verified, created_at, updated_at)
    VALUES ($1, $2, $3, $4, 'active', false, $5, $5)
  `,[l,e.email.toLowerCase(),d,e.name||null,o]);let u=(await s.query("SELECT daily_limit, monthly_limit FROM plans WHERE id = 'free'")).rows[0]||{daily_limit:1e3,monthly_limit:1e4};return await s.query(`
    INSERT INTO account_plans (account_id, plan_id, daily_limit, monthly_limit, started_at, is_current)
    VALUES ($1, 'free', $2, $3, $4, true)
  `,[l,u.daily_limit,u.monthly_limit,o]),{id:l,email:e.email.toLowerCase(),passwordHash:d,name:e.name,status:"active",emailVerified:!1,createdAt:o,updatedAt:o,plan:{name:"free",dailyLimit:u.daily_limit,monthlyLimit:u.monthly_limit}}}async function o(e){let t=(0,n.getDb)(),a=await t.query("SELECT * FROM accounts WHERE email = $1",[e.toLowerCase()]);if(0===a.rows.length)return null;let r=a.rows[0];return{id:r.id,email:r.email,passwordHash:r.password_hash,name:r.name||void 0,status:r.status,emailVerified:r.email_verified,createdAt:r.created_at,updatedAt:r.updated_at}}async function l(e){let t=(0,n.getDb)(),a=await t.query(`
    SELECT a.*, ap.plan_id, p.name as plan_name, ap.daily_limit, ap.monthly_limit
    FROM accounts a
    JOIN account_plans ap ON a.id = ap.account_id AND ap.is_current = true
    JOIN plans p ON ap.plan_id = p.id
    WHERE a.id = $1
  `,[e]);if(0===a.rows.length)return null;let r=a.rows[0];return{id:r.id,email:r.email,passwordHash:r.password_hash,name:r.name||void 0,status:r.status,emailVerified:r.email_verified,createdAt:r.created_at,updatedAt:r.updated_at,plan:{name:r.plan_name,dailyLimit:r.daily_limit,monthlyLimit:r.monthly_limit}}}async function d(e){let t=(0,n.getDb)(),a=r.default.randomUUID(),i=new Date().toISOString();return await t.query(`
    INSERT INTO usage_events (id, account_id, api_key_id, endpoint, method, status_code, billable_units, response_time_ms, ip_address, user_agent, timestamp)
    VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11)
  `,[a,e.accountId,e.apiKeyId,e.endpoint,e.method,e.statusCode,e.billableUnits,e.responseTimeMs||null,e.ipAddress||null,e.userAgent||null,i]),{...e,id:a,timestamp:i}}async function u(e){let t=(0,n.getDb)(),a=await t.query(`
    SELECT p.name as plan_name, ap.daily_limit, ap.monthly_limit
    FROM account_plans ap
    JOIN plans p ON ap.plan_id = p.id
    WHERE ap.account_id = $1 AND ap.is_current = true
  `,[e]);if(0===a.rows.length)throw Error("Account plan not found");let r=a.rows[0],i=await t.query(`
    SELECT COALESCE(SUM(billable_units), 0) as count
    FROM usage_events
    WHERE account_id = $1 AND timestamp >= CURRENT_DATE
  `,[e]),s=await t.query(`
    SELECT COALESCE(SUM(billable_units), 0) as count
    FROM usage_events
    WHERE account_id = $1 AND timestamp >= DATE_TRUNC('month', CURRENT_DATE)
  `,[e]),o=parseInt(i.rows[0]?.count||"0",10),l=parseInt(s.rows[0]?.count||"0",10);return{today:{used:o,remaining:Math.max(0,r.daily_limit-o)},month:{used:l,remaining:Math.max(0,r.monthly_limit-l)},plan:{name:r.plan_name,dailyLimit:r.daily_limit,monthlyLimit:r.monthly_limit}}}[n]=i.then?(await i)():i,e.s(["createAccount",()=>s,"findAccountByEmail",()=>o,"getAccountWithPlan",()=>l,"getUsageSummary",()=>u,"logUsageEvent",()=>d]),a()}catch(e){a(e)}},!1),19166,e=>e.a(async(t,a)=>{try{var r=e.i(89171),n=e.i(49741),i=e.i(50377),s=t([n]);[n]=s.then?(await s)():s;let g=(0,i.createLogger)({component:"UsageLimits"}),f=null;async function o(){if(f)return f;let t=process.env.UPSTASH_REDIS_REST_URL,a=process.env.UPSTASH_REDIS_REST_TOKEN;if(t&&a)try{let{Redis:r}=await e.A(2759);return f=new r({url:t,token:a}),await f.ping(),g.info("Redis client connected (Upstash)"),f}catch(e){g.warn({error:e},"Upstash Redis connection failed")}let r=process.env.REDIS_URL;if(r)try{let{Redis:t}=await e.A(6538);return f=new t(r,{maxRetriesPerRequest:3,connectTimeout:5e3,lazyConnect:!0}),await f.connect(),g.info("Redis client connected (ioredis)"),f}catch(e){g.warn({error:e},"ioredis connection failed")}return null}function l(e){let t=new Date().toISOString().split("T")[0];return`usage:${e}:${t}`}function d(e){let t=new Date().toISOString().substring(0,7);return`usage:${e}:${t}`}async function u(e,t,a){let r=await o();if(!r)return g.warn({accountId:e},"Redis not available, skipping usage limit check"),{allowed:!0,daily:0,monthly:0};let n=l(e),i=d(e);try{let e,s=`
      local dailyKey = KEYS[1]
      local monthlyKey = KEYS[2]
      local dailyLimit = tonumber(ARGV[1])
      local monthlyLimit = tonumber(ARGV[2])
      local dailyTTL = tonumber(ARGV[3])
      local monthlyTTL = tonumber(ARGV[4])
      
      -- Get current values
      local dailyCurrent = tonumber(redis.call('GET', dailyKey) or '0')
      local monthlyCurrent = tonumber(redis.call('GET', monthlyKey) or '0')
      
      -- Check limits before incrementing
      if dailyCurrent >= dailyLimit then
        return {0, dailyCurrent, monthlyCurrent, 'daily'}
      end
      
      if monthlyCurrent >= monthlyLimit then
        return {0, dailyCurrent, monthlyCurrent, 'monthly'}
      end
      
      -- Increment both counters
      local newDaily = redis.call('INCR', dailyKey)
      local newMonthly = redis.call('INCR', monthlyKey)
      
      -- Set TTLs if keys are new
      if newDaily == 1 then
        redis.call('EXPIRE', dailyKey, dailyTTL)
      end
      if newMonthly == 1 then
        redis.call('EXPIRE', monthlyKey, monthlyTTL)
      end
      
      return {1, newDaily, newMonthly, 'ok'}
    `;if(r.eval)e=await r.eval(s,2,n,i,t,a,172800,3456e3);else{let e=parseInt(await r.get(n)||"0",10),s=parseInt(await r.get(i)||"0",10);if(e>=t||s>=a)return{allowed:!1,daily:e,monthly:s};let o=r.pipeline();o.incr(n),o.expire(n,172800),o.incr(i),o.expire(i,3456e3);let l=await o.exec(),d=l[0]||e+1,u=l[2]||s+1;return{allowed:!0,daily:d,monthly:u}}let[o,l,d]=e;return{allowed:1===o,daily:l,monthly:d}}catch(t){return g.error({error:t,accountId:e},"Usage check failed"),{allowed:!0,daily:0,monthly:0}}}async function c(e){let t=await o();if(!t)return;let a=l(e),r=d(e);try{if(t.pipeline){let e=t.pipeline();e.decr(a),e.decr(r),await e.exec()}else await Promise.all([t.decr(a),t.decr(r)])}catch(t){g.error({error:t,accountId:e},"Failed to decrement usage")}}async function p(e){let t=await o();if(!t)return{daily:0,monthly:0};let a=l(e),r=d(e);try{let e,n;if(t.mget){let[i,s]=await t.mget(a,r);e=parseInt(i||"0",10),n=parseInt(s||"0",10)}else e=parseInt(await t.get(a)||"0",10),n=parseInt(await t.get(r)||"0",10);return{daily:e,monthly:n}}catch(t){return g.error({error:t,accountId:e},"Failed to get current usage"),{daily:0,monthly:0}}}async function m(e,t,a={}){let{billableUnits:r=1}=a,i=t.userId;if(!i)return g.warn({apiKeyId:t.id},"API key has no associated account"),{allowed:!0};let s=await (0,n.getAccountWithPlan)(i);if(!s)return{allowed:!1,error:{code:"ACCOUNT_NOT_FOUND",message:"Account not found"}};if("active"!==s.status)return{allowed:!1,error:{code:"ACCOUNT_SUSPENDED",message:"Your account has been suspended. Please contact support."}};let{dailyLimit:o,monthlyLimit:l}=s.plan,{allowed:d,daily:c,monthly:p}=await u(i,o,l);if(!d){let e=c>=o;return{allowed:!1,account:s,usage:{daily:{used:c,limit:o,remaining:0},monthly:{used:p,limit:l,remaining:0}},error:{code:"QUOTA_EXCEEDED",message:e?`You have exceeded your daily NexFlow quota (${o} calls/day). Contact support or upgrade your plan.`:`You have exceeded your monthly NexFlow quota (${l} calls/month). Contact support or upgrade your plan.`,limits:{dailyLimit:o,monthlyLimit:l}}}}return{allowed:!0,account:s,usage:{daily:{used:c,limit:o,remaining:Math.max(0,o-c)},monthly:{used:p,limit:l,remaining:Math.max(0,l-p)}}}}async function y(e,t,a,r,i=1){let s=t.userId;if(s)try{await (0,n.logUsageEvent)({accountId:s,apiKeyId:t.id,endpoint:new URL(e.url).pathname,method:e.method,statusCode:a,billableUnits:i,responseTimeMs:r,ipAddress:e.ip||e.headers.get("x-forwarded-for")?.split(",")[0]?.trim()||void 0,userAgent:e.headers.get("user-agent")||void 0})}catch(e){g.error({error:e,accountId:s,apiKeyId:t.id},"Failed to log usage event")}}function h(e){return r.NextResponse.json({error:"quota_exceeded",code:e.error?.code,message:e.error?.message,limits:e.error?.limits,usage:e.usage?{daily:{used:e.usage.daily.used,limit:e.usage.daily.limit},monthly:{used:e.usage.monthly.used,limit:e.usage.monthly.limit}}:void 0},{status:429,headers:{"Retry-After":"3600","X-RateLimit-Limit-Daily":String(e.error?.limits?.dailyLimit||0),"X-RateLimit-Limit-Monthly":String(e.error?.limits?.monthlyLimit||0),"X-RateLimit-Remaining-Daily":"0","X-RateLimit-Remaining-Monthly":"0"}})}e.s(["createQuotaExceededResponse",()=>h,"decrementUsage",()=>c,"enforceUsageLimits",()=>m,"getCurrentUsage",()=>p,"logBillableUsage",()=>y]),a()}catch(e){a(e)}},!1),79928,e=>e.a(async(t,a)=>{try{var r=e.i(89171),n=e.i(79832),i=e.i(49741),s=e.i(19166),o=t([n,i,s]);async function l(e){let t=await (0,n.requireAuth)(e);if(t.response)return t.response;let{apiKey:a}=t,o=a.userId;if(!o)return r.NextResponse.json({error:"No account associated with this API key",code:"NO_ACCOUNT",details:"This API key was created before account-based billing was enabled."},{status:400});try{let e=await (0,i.getAccountWithPlan)(o);if(!e)return r.NextResponse.json({error:"Account not found",code:"ACCOUNT_NOT_FOUND"},{status:404});let t=await (0,s.getCurrentUsage)(o),a=await (0,i.getUsageSummary)(o),n=t.daily||a.today.used,l=t.monthly||a.month.used,{dailyLimit:d,monthlyLimit:u}=e.plan,c={plan:{name:e.plan.name,dailyLimit:d,monthlyLimit:u},today:{used:n,remaining:Math.max(0,d-n)},month:{used:l,remaining:Math.max(0,u-l)},account:{id:e.id,email:e.email,status:e.status}};return r.NextResponse.json(c,{headers:{"X-RateLimit-Limit-Daily":String(d),"X-RateLimit-Limit-Monthly":String(u),"X-RateLimit-Remaining-Daily":String(c.today.remaining),"X-RateLimit-Remaining-Monthly":String(c.month.remaining),"Cache-Control":"private, max-age=60"}})}catch(e){return console.error("[me/usage-summary] Error:",e),r.NextResponse.json({error:"Failed to retrieve usage summary",code:"INTERNAL_ERROR",details:void 0},{status:500})}}[n,i,s]=o.then?(await o)():o,e.s(["GET",()=>l]),a()}catch(e){a(e)}},!1),55330,e=>e.a(async(t,a)=>{try{var r=e.i(47909),n=e.i(74017),i=e.i(96250),s=e.i(59756),o=e.i(61916),l=e.i(14444),d=e.i(37092),u=e.i(69741),c=e.i(16795),p=e.i(87718),m=e.i(95169),y=e.i(47587),h=e.i(66012),g=e.i(70101),f=e.i(26937),w=e.i(10372),_=e.i(93695);e.i(52474);var x=e.i(220),R=e.i(79928),v=t([R]);[R]=v.then?(await v)():v;let b=new r.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/v1/me/usage-summary/route",pathname:"/api/v1/me/usage-summary",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/v1/me/usage-summary/route.ts",nextConfigOutput:"standalone",userland:R}),{workAsyncStorage:C,workUnitAsyncStorage:T,serverHooks:S}=b;function A(){return(0,i.patchFetch)({workAsyncStorage:C,workUnitAsyncStorage:T})}async function E(e,t,a){b.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/v1/me/usage-summary/route";r=r.replace(/\/index$/,"")||"/";let i=await b.prepare(e,t,{srcPage:r,multiZoneDraftMode:!1});if(!i)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:R,params:v,nextConfig:A,parsedUrl:E,isDraftMode:C,prerenderManifest:T,routerServerContext:S,isOnDemandRevalidate:I,revalidateOnlyGenerated:D,resolvedPathname:N,clientReferenceManifest:L,serverActionsManifest:U}=i,k=(0,u.normalizeAppPath)(r),O=!!(T.dynamicRoutes[k]||T.routes[N]),q=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,E,!1):t.end("This page could not be found"),null);if(O&&!C){let e=!!T.routes[N],t=T.dynamicRoutes[k];if(t&&!1===t.fallback&&!e){if(A.experimental.adapterPath)return await q();throw new _.NoFallbackError}}let $=null;!O||b.isDev||C||($=N,$="/index"===$?"/":$);let K=!0===b.isDev||!O,P=O&&!K;U&&L&&(0,l.setReferenceManifestsSingleton)({page:r,clientReferenceManifest:L,serverActionsManifest:U,serverModuleMap:(0,d.createServerModuleMap)({serverActionsManifest:U})});let M=e.method||"GET",j=(0,o.getTracer)(),H=j.getActiveScopeSpan(),F={params:v,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!A.experimental.authInterrupts},cacheComponents:!!A.cacheComponents,supportsDynamicResponse:K,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:A.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>b.onRequestError(e,t,r,S)},sharedContext:{buildId:R}},X=new c.NodeNextRequest(e),B=new c.NodeNextResponse(t),W=p.NextRequestAdapter.fromNodeNextRequest(X,(0,p.signalFromNodeResponse)(t));try{let i=async e=>b.handle(W,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=j.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=a.get("next.route");if(n){let t=`${M} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${M} ${r}`)}),l=!!(0,s.getRequestMeta)(e,"minimalMode"),d=async s=>{var o,d;let u=async({previousCacheEntry:n})=>{try{if(!l&&I&&D&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await i(s);e.fetchMetrics=F.renderOpts.fetchMetrics;let o=F.renderOpts.pendingWaitUntil;o&&a.waitUntil&&(a.waitUntil(o),o=void 0);let d=F.renderOpts.collectedTags;if(!O)return await (0,h.sendResponse)(X,B,r,F.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(r.headers);d&&(t[w.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,n=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:x.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:n}}}}catch(t){throw(null==n?void 0:n.isStale)&&await b.onRequestError(e,t,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,y.getRevalidateReason)({isStaticGeneration:P,isOnDemandRevalidate:I})},S),t}},c=await b.handleResponse({req:e,nextConfig:A,cacheKey:$,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:I,revalidateOnlyGenerated:D,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:l});if(!O)return null;if((null==c||null==(o=c.value)?void 0:o.kind)!==x.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(d=c.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",I?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,g.fromNodeOutgoingHttpHeaders)(c.value.headers);return l&&O||p.delete(w.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,f.getCacheControlHeader)(c.cacheControl)),await (0,h.sendResponse)(X,B,new Response(c.value.body,{headers:p,status:c.value.status||200})),null};H?await d(H):await j.withPropagatedContext(e.headers,()=>j.trace(m.BaseServerSpan.handleRequest,{spanName:`${M} ${r}`,kind:o.SpanKind.SERVER,attributes:{"http.method":M,"http.target":e.url}},d))}catch(t){if(t instanceof _.NoFallbackError||await b.onRequestError(e,t,{routerKind:"App Router",routePath:k,routeType:"route",revalidateReason:(0,y.getRevalidateReason)({isStaticGeneration:P,isOnDemandRevalidate:I})}),O)throw t;return await (0,h.sendResponse)(X,B,new Response(null,{status:500})),null}}e.s(["handler",()=>E,"patchFetch",()=>A,"routeModule",()=>b,"serverHooks",()=>S,"workAsyncStorage",()=>C,"workUnitAsyncStorage",()=>T]),a()}catch(e){a(e)}},!1),2759,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__7ebfd264._.js","server/chunks/node_modules_@upstash_redis_nodejs_mjs_85cd95da._.js"].map(t=>e.l(t))).then(()=>t(58119)))},6538,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__2b5537a8._.js","server/chunks/[root-of-the-server]__bbbc7a9e._.js","server/chunks/node_modules_@ioredis_commands_built_commands_json_862661ff._.js"].map(t=>e.l(t))).then(()=>t(42512)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__62d7775d._.js.map
{"version":3,"sources":["../../../src/db/governance.ts","../../../src/services/governance/config-service.ts","../../../src/services/governance/contract-admin.ts","../../../node_modules/viem/chains/definitions/baseSepolia.ts","../../../src/app/api/v1/governance/proposals/route.ts","../../../node_modules/next/src/build/templates/app-route.ts"],"sourcesContent":["// =============================================================================\r\n// GOVERNANCE DATABASE QUERIES\r\n// =============================================================================\r\n// Query helpers for governance configuration and proposal management.\r\n// Provides CRUD operations for config values and proposals.\r\n\r\nimport { getDb } from './client';\r\nimport type {\r\n  GovernanceProposal,\r\n  ProposalStatus,\r\n  ConfigEntry,\r\n  GovernanceConfig,\r\n  DEFAULT_GOVERNANCE_CONFIG,\r\n} from '@/types/governance';\r\n\r\n// =============================================================================\r\n// HELPER FUNCTIONS\r\n// =============================================================================\r\n\r\n/**\r\n * Check if database is PostgreSQL\r\n */\r\nfunction isPostgres(db: any): boolean {\r\n  return db && ('pool' in db || typeof db?.pool?.query === 'function');\r\n}\r\n\r\n/**\r\n * Generate a UUID\r\n */\r\nfunction generateId(): string {\r\n  return crypto.randomUUID();\r\n}\r\n\r\n// =============================================================================\r\n// CONFIGURATION QUERIES\r\n// =============================================================================\r\n\r\n/**\r\n * Get a single configuration value by key.\r\n */\r\nexport async function getConfigValue(key: string): Promise<ConfigEntry | null> {\r\n  const db = getDb();\r\n\r\n  if (isPostgres(db)) {\r\n    const result = await (db as any).pool.query(\r\n      `SELECT key, value, updated_at, updated_by FROM governance_config WHERE key = $1`,\r\n      [key]\r\n    );\r\n    if (result.rows.length === 0) return null;\r\n    const row = result.rows[0];\r\n    return {\r\n      key: row.key,\r\n      value: JSON.parse(row.value),\r\n      updated_at: new Date(row.updated_at),\r\n      updated_by: row.updated_by,\r\n    };\r\n  }\r\n\r\n  const result = await db.query(\r\n    `SELECT key, value, updated_at, updated_by FROM governance_config WHERE key = ?`,\r\n    [key]\r\n  );\r\n  if (result.rows.length === 0) return null;\r\n  const row = result.rows[0];\r\n  return {\r\n    key: row.key,\r\n    value: JSON.parse(row.value),\r\n    updated_at: new Date(row.updated_at),\r\n    updated_by: row.updated_by,\r\n  };\r\n}\r\n\r\n/**\r\n * Get all configuration values.\r\n */\r\nexport async function getAllConfigValues(): Promise<ConfigEntry[]> {\r\n  const db = getDb();\r\n\r\n  if (isPostgres(db)) {\r\n    const result = await (db as any).pool.query(\r\n      `SELECT key, value, updated_at, updated_by FROM governance_config ORDER BY key`\r\n    );\r\n    return result.rows.map((row: any) => ({\r\n      key: row.key,\r\n      value: JSON.parse(row.value),\r\n      updated_at: new Date(row.updated_at),\r\n      updated_by: row.updated_by,\r\n    }));\r\n  }\r\n\r\n  const result = await db.query(\r\n    `SELECT key, value, updated_at, updated_by FROM governance_config ORDER BY key`\r\n  );\r\n  return result.rows.map((row: any) => ({\r\n    key: row.key,\r\n    value: JSON.parse(row.value),\r\n    updated_at: new Date(row.updated_at),\r\n    updated_by: row.updated_by,\r\n  }));\r\n}\r\n\r\n/**\r\n * Set a configuration value.\r\n */\r\nexport async function setConfigValue(\r\n  key: string,\r\n  value: unknown,\r\n  updated_by: string\r\n): Promise<void> {\r\n  const db = getDb();\r\n  const now = new Date().toISOString();\r\n  const valueJson = JSON.stringify(value);\r\n\r\n  if (isPostgres(db)) {\r\n    await (db as any).pool.query(\r\n      `INSERT INTO governance_config (key, value, updated_at, updated_by)\r\n       VALUES ($1, $2, $3, $4)\r\n       ON CONFLICT (key) DO UPDATE SET value = $2, updated_at = $3, updated_by = $4`,\r\n      [key, valueJson, now, updated_by]\r\n    );\r\n    return;\r\n  }\r\n\r\n  await db.exec(\r\n    `INSERT OR REPLACE INTO governance_config (key, value, updated_at, updated_by)\r\n     VALUES (?, ?, ?, ?)`,\r\n    [key, valueJson, now, updated_by]\r\n  );\r\n}\r\n\r\n/**\r\n * Build full GovernanceConfig from stored values.\r\n */\r\nexport async function getFullConfig(): Promise<GovernanceConfig> {\r\n  const entries = await getAllConfigValues();\r\n  const configMap = new Map(entries.map((e) => [e.key, e.value]));\r\n\r\n  // Import defaults\r\n  const { DEFAULT_GOVERNANCE_CONFIG } = await import('@/types/governance');\r\n\r\n  return {\r\n    platform_fee_percentage:\r\n      (configMap.get('platform_fee_percentage') as number) ??\r\n      DEFAULT_GOVERNANCE_CONFIG.platform_fee_percentage,\r\n    min_fee_wei:\r\n      (configMap.get('min_fee_wei') as string) ??\r\n      DEFAULT_GOVERNANCE_CONFIG.min_fee_wei,\r\n    max_fee_percentage:\r\n      (configMap.get('max_fee_percentage') as number) ??\r\n      DEFAULT_GOVERNANCE_CONFIG.max_fee_percentage,\r\n    anomaly_thresholds:\r\n      (configMap.get('anomaly_thresholds') as any) ??\r\n      DEFAULT_GOVERNANCE_CONFIG.anomaly_thresholds,\r\n    load_thresholds:\r\n      (configMap.get('load_thresholds') as any) ??\r\n      DEFAULT_GOVERNANCE_CONFIG.load_thresholds,\r\n    circuit_breaker:\r\n      (configMap.get('circuit_breaker') as any) ??\r\n      DEFAULT_GOVERNANCE_CONFIG.circuit_breaker,\r\n    batch_max_size:\r\n      (configMap.get('batch_max_size') as number) ??\r\n      DEFAULT_GOVERNANCE_CONFIG.batch_max_size,\r\n    batch_min_size:\r\n      (configMap.get('batch_min_size') as number) ??\r\n      DEFAULT_GOVERNANCE_CONFIG.batch_min_size,\r\n    batch_timeout_minutes:\r\n      (configMap.get('batch_timeout_minutes') as number) ??\r\n      DEFAULT_GOVERNANCE_CONFIG.batch_timeout_minutes,\r\n    default_canary_share:\r\n      (configMap.get('default_canary_share') as number) ??\r\n      DEFAULT_GOVERNANCE_CONFIG.default_canary_share,\r\n    max_canary_share:\r\n      (configMap.get('max_canary_share') as number) ??\r\n      DEFAULT_GOVERNANCE_CONFIG.max_canary_share,\r\n    promotion_success_threshold:\r\n      (configMap.get('promotion_success_threshold') as number) ??\r\n      DEFAULT_GOVERNANCE_CONFIG.promotion_success_threshold,\r\n  };\r\n}\r\n\r\n// =============================================================================\r\n// PROPOSAL QUERIES\r\n// =============================================================================\r\n\r\n/**\r\n * Create a new governance proposal.\r\n */\r\nexport async function createProposal(params: {\r\n  key: string;\r\n  old_value: unknown;\r\n  new_value: unknown;\r\n  created_by: string;\r\n  ready_at: Date;\r\n}): Promise<GovernanceProposal> {\r\n  const db = getDb();\r\n  const id = generateId();\r\n  const now = new Date().toISOString();\r\n  const oldValueJson = JSON.stringify(params.old_value);\r\n  const newValueJson = JSON.stringify(params.new_value);\r\n  const readyAtStr = params.ready_at.toISOString();\r\n\r\n  if (isPostgres(db)) {\r\n    await (db as any).pool.query(\r\n      `INSERT INTO governance_proposals \r\n       (id, key, old_value, new_value, status, created_by, created_at, ready_at)\r\n       VALUES ($1, $2, $3, $4, 'pending', $5, $6, $7)`,\r\n      [id, params.key, oldValueJson, newValueJson, params.created_by, now, readyAtStr]\r\n    );\r\n  } else {\r\n    await db.exec(\r\n      `INSERT INTO governance_proposals \r\n       (id, key, old_value, new_value, status, created_by, created_at, ready_at)\r\n       VALUES (?, ?, ?, ?, 'pending', ?, ?, ?)`,\r\n      [id, params.key, oldValueJson, newValueJson, params.created_by, now, readyAtStr]\r\n    );\r\n  }\r\n\r\n  return {\r\n    id,\r\n    key: params.key,\r\n    old_value: params.old_value,\r\n    new_value: params.new_value,\r\n    status: 'pending',\r\n    created_by: params.created_by,\r\n    created_at: new Date(now),\r\n    ready_at: params.ready_at,\r\n    applied_at: null,\r\n  };\r\n}\r\n\r\n/**\r\n * Get a proposal by ID.\r\n */\r\nexport async function getProposalById(id: string): Promise<GovernanceProposal | null> {\r\n  const db = getDb();\r\n\r\n  let row: any;\r\n  if (isPostgres(db)) {\r\n    const result = await (db as any).pool.query(\r\n      `SELECT * FROM governance_proposals WHERE id = $1`,\r\n      [id]\r\n    );\r\n    if (result.rows.length === 0) return null;\r\n    row = result.rows[0];\r\n  } else {\r\n    const result = await db.query(\r\n      `SELECT * FROM governance_proposals WHERE id = ?`,\r\n      [id]\r\n    );\r\n    if (result.rows.length === 0) return null;\r\n    row = result.rows[0];\r\n  }\r\n\r\n  return {\r\n    id: row.id,\r\n    key: row.key,\r\n    old_value: row.old_value ? JSON.parse(row.old_value) : null,\r\n    new_value: JSON.parse(row.new_value),\r\n    status: row.status as ProposalStatus,\r\n    created_by: row.created_by,\r\n    created_at: new Date(row.created_at),\r\n    ready_at: new Date(row.ready_at),\r\n    applied_at: row.applied_at ? new Date(row.applied_at) : null,\r\n    rejection_reason: row.rejection_reason,\r\n  };\r\n}\r\n\r\n/**\r\n * List all pending proposals.\r\n */\r\nexport async function listPendingProposals(): Promise<GovernanceProposal[]> {\r\n  const db = getDb();\r\n\r\n  let rows: any[];\r\n  if (isPostgres(db)) {\r\n    const result = await (db as any).pool.query(\r\n      `SELECT * FROM governance_proposals WHERE status = 'pending' ORDER BY ready_at ASC`\r\n    );\r\n    rows = result.rows;\r\n  } else {\r\n    const result = await db.query(\r\n      `SELECT * FROM governance_proposals WHERE status = 'pending' ORDER BY ready_at ASC`\r\n    );\r\n    rows = result.rows;\r\n  }\r\n\r\n  return rows.map((row: any) => ({\r\n    id: row.id,\r\n    key: row.key,\r\n    old_value: row.old_value ? JSON.parse(row.old_value) : null,\r\n    new_value: JSON.parse(row.new_value),\r\n    status: row.status as ProposalStatus,\r\n    created_by: row.created_by,\r\n    created_at: new Date(row.created_at),\r\n    ready_at: new Date(row.ready_at),\r\n    applied_at: row.applied_at ? new Date(row.applied_at) : null,\r\n    rejection_reason: row.rejection_reason,\r\n  }));\r\n}\r\n\r\n/**\r\n * List proposals with optional filters.\r\n */\r\nexport async function listProposals(params?: {\r\n  status?: ProposalStatus;\r\n  key?: string;\r\n  limit?: number;\r\n  offset?: number;\r\n}): Promise<GovernanceProposal[]> {\r\n  const db = getDb();\r\n  const { status, key, limit = 100, offset = 0 } = params || {};\r\n\r\n  const conditions: string[] = [];\r\n  const values: any[] = [];\r\n  let paramIndex = 1;\r\n\r\n  if (status) {\r\n    conditions.push(isPostgres(db) ? `status = $${paramIndex++}` : 'status = ?');\r\n    values.push(status);\r\n  }\r\n  if (key) {\r\n    conditions.push(isPostgres(db) ? `key = $${paramIndex++}` : 'key = ?');\r\n    values.push(key);\r\n  }\r\n\r\n  const whereClause = conditions.length > 0 ? `WHERE ${conditions.join(' AND ')}` : '';\r\n\r\n  let rows: any[];\r\n  if (isPostgres(db)) {\r\n    const result = await (db as any).pool.query(\r\n      `SELECT * FROM governance_proposals ${whereClause} \r\n       ORDER BY created_at DESC LIMIT $${paramIndex++} OFFSET $${paramIndex++}`,\r\n      [...values, limit, offset]\r\n    );\r\n    rows = result.rows;\r\n  } else {\r\n    const result = await db.query(\r\n      `SELECT * FROM governance_proposals ${whereClause} \r\n       ORDER BY created_at DESC LIMIT ? OFFSET ?`,\r\n      [...values, limit, offset]\r\n    );\r\n    rows = result.rows;\r\n  }\r\n\r\n  return rows.map((row: any) => ({\r\n    id: row.id,\r\n    key: row.key,\r\n    old_value: row.old_value ? JSON.parse(row.old_value) : null,\r\n    new_value: JSON.parse(row.new_value),\r\n    status: row.status as ProposalStatus,\r\n    created_by: row.created_by,\r\n    created_at: new Date(row.created_at),\r\n    ready_at: new Date(row.ready_at),\r\n    applied_at: row.applied_at ? new Date(row.applied_at) : null,\r\n    rejection_reason: row.rejection_reason,\r\n  }));\r\n}\r\n\r\n/**\r\n * List proposals that are ready to be applied.\r\n */\r\nexport async function listDueProposals(): Promise<GovernanceProposal[]> {\r\n  const db = getDb();\r\n  const now = new Date().toISOString();\r\n\r\n  let rows: any[];\r\n  if (isPostgres(db)) {\r\n    const result = await (db as any).pool.query(\r\n      `SELECT * FROM governance_proposals \r\n       WHERE status = 'pending' AND ready_at <= $1 \r\n       ORDER BY ready_at ASC`,\r\n      [now]\r\n    );\r\n    rows = result.rows;\r\n  } else {\r\n    const result = await db.query(\r\n      `SELECT * FROM governance_proposals \r\n       WHERE status = 'pending' AND ready_at <= ? \r\n       ORDER BY ready_at ASC`,\r\n      [now]\r\n    );\r\n    rows = result.rows;\r\n  }\r\n\r\n  return rows.map((row: any) => ({\r\n    id: row.id,\r\n    key: row.key,\r\n    old_value: row.old_value ? JSON.parse(row.old_value) : null,\r\n    new_value: JSON.parse(row.new_value),\r\n    status: row.status as ProposalStatus,\r\n    created_by: row.created_by,\r\n    created_at: new Date(row.created_at),\r\n    ready_at: new Date(row.ready_at),\r\n    applied_at: row.applied_at ? new Date(row.applied_at) : null,\r\n    rejection_reason: row.rejection_reason,\r\n  }));\r\n}\r\n\r\n/**\r\n * Mark a proposal as applied.\r\n */\r\nexport async function markProposalApplied(id: string, appliedAt: Date): Promise<void> {\r\n  const db = getDb();\r\n  const appliedAtStr = appliedAt.toISOString();\r\n\r\n  if (isPostgres(db)) {\r\n    await (db as any).pool.query(\r\n      `UPDATE governance_proposals SET status = 'applied', applied_at = $2 WHERE id = $1`,\r\n      [id, appliedAtStr]\r\n    );\r\n  } else {\r\n    await db.exec(\r\n      `UPDATE governance_proposals SET status = 'applied', applied_at = ? WHERE id = ?`,\r\n      [appliedAtStr, id]\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * Mark a proposal as rejected.\r\n */\r\nexport async function markProposalRejected(id: string, reason?: string): Promise<void> {\r\n  const db = getDb();\r\n\r\n  if (isPostgres(db)) {\r\n    await (db as any).pool.query(\r\n      `UPDATE governance_proposals SET status = 'rejected', rejection_reason = $2 WHERE id = $1`,\r\n      [id, reason || null]\r\n    );\r\n  } else {\r\n    await db.exec(\r\n      `UPDATE governance_proposals SET status = 'rejected', rejection_reason = ? WHERE id = ?`,\r\n      [reason || null, id]\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * Count proposals by status.\r\n */\r\nexport async function countProposalsByStatus(): Promise<Record<ProposalStatus, number>> {\r\n  const db = getDb();\r\n\r\n  let rows: any[];\r\n  if (isPostgres(db)) {\r\n    const result = await (db as any).pool.query(\r\n      `SELECT status, COUNT(*) as count FROM governance_proposals GROUP BY status`\r\n    );\r\n    rows = result.rows;\r\n  } else {\r\n    const result = await db.query(\r\n      `SELECT status, COUNT(*) as count FROM governance_proposals GROUP BY status`\r\n    );\r\n    rows = result.rows;\r\n  }\r\n\r\n  const counts: Record<ProposalStatus, number> = {\r\n    draft: 0,\r\n    pending: 0,\r\n    applied: 0,\r\n    rejected: 0,\r\n  };\r\n\r\n  for (const row of rows) {\r\n    counts[row.status as ProposalStatus] = parseInt(row.count, 10);\r\n  }\r\n\r\n  return counts;\r\n}\r\n\r\n\r\n","// =============================================================================\r\n// GOVERNANCE CONFIG SERVICE\r\n// =============================================================================\r\n// Manages governance configuration and proposal lifecycle.\r\n// Provides:\r\n// - Configuration retrieval (with caching)\r\n// - Proposal creation with timelock\r\n// - Due proposal application\r\n// - Audit trail\r\n\r\nimport { createLogger } from '@/lib/logger';\r\nimport {\r\n  getConfigValue,\r\n  setConfigValue,\r\n  getFullConfig,\r\n  createProposal,\r\n  listPendingProposals,\r\n  listDueProposals,\r\n  markProposalApplied,\r\n  markProposalRejected,\r\n  getProposalById,\r\n  listProposals,\r\n  countProposalsByStatus,\r\n} from '@/db/governance';\r\nimport type {\r\n  GovernanceConfig,\r\n  GovernanceProposal,\r\n  CreateProposalParams,\r\n  ApplyProposalsResult,\r\n  ConfigKey,\r\n  ProposalStatus,\r\n} from '@/types/governance';\r\nimport {\r\n  DEFAULT_GOVERNANCE_CONFIG,\r\n  DEFAULT_TIMELOCK_HOURS,\r\n  isValidConfigKey,\r\n} from '@/types/governance';\r\n\r\nconst logger = createLogger({ component: 'GovernanceConfigService' });\r\n\r\n// =============================================================================\r\n// CONSTANTS\r\n// =============================================================================\r\n\r\n/** Cache TTL for config (5 minutes) */\r\nconst CONFIG_CACHE_TTL_MS = 5 * 60 * 1000;\r\n\r\n// =============================================================================\r\n// CONFIG SERVICE CLASS\r\n// =============================================================================\r\n\r\n/**\r\n * Service for managing governance configuration and proposals.\r\n */\r\nexport class GovernanceConfigService {\r\n  private configCache: GovernanceConfig | null = null;\r\n  private configCacheTime: number = 0;\r\n  private changeListeners: Array<(key: string, oldValue: unknown, newValue: unknown) => void> = [];\r\n\r\n  constructor() {}\r\n\r\n  // ===========================================================================\r\n  // CONFIGURATION METHODS\r\n  // ===========================================================================\r\n\r\n  /**\r\n   * Get the current governance configuration.\r\n   * Results are cached for 5 minutes.\r\n   */\r\n  async getConfig(): Promise<GovernanceConfig> {\r\n    // Check cache\r\n    if (this.configCache && Date.now() - this.configCacheTime < CONFIG_CACHE_TTL_MS) {\r\n      return this.configCache;\r\n    }\r\n\r\n    try {\r\n      // Load from database\r\n      this.configCache = await getFullConfig();\r\n      this.configCacheTime = Date.now();\r\n      return this.configCache;\r\n    } catch (error) {\r\n      logger.warn({ error }, 'Failed to load config from DB, using defaults');\r\n      return DEFAULT_GOVERNANCE_CONFIG;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get a specific configuration value.\r\n   */\r\n  async getConfigValue<K extends keyof GovernanceConfig>(\r\n    key: K\r\n  ): Promise<GovernanceConfig[K]> {\r\n    const config = await this.getConfig();\r\n    return config[key];\r\n  }\r\n\r\n  /**\r\n   * Get a nested configuration value using dot notation.\r\n   * Example: getNestedValue('anomaly_thresholds.max_error_rate')\r\n   */\r\n  async getNestedValue(key: string): Promise<unknown> {\r\n    const config = await this.getConfig();\r\n    const parts = key.split('.');\r\n    let value: any = config;\r\n\r\n    for (const part of parts) {\r\n      if (value === undefined || value === null) return undefined;\r\n      value = value[part];\r\n    }\r\n\r\n    return value;\r\n  }\r\n\r\n  /**\r\n   * Clear the config cache (forces reload on next access).\r\n   */\r\n  clearCache(): void {\r\n    this.configCache = null;\r\n    this.configCacheTime = 0;\r\n  }\r\n\r\n  // ===========================================================================\r\n  // PROPOSAL METHODS\r\n  // ===========================================================================\r\n\r\n  /**\r\n   * Propose a configuration change.\r\n   * Creates a pending proposal with a timelock (default 48 hours).\r\n   */\r\n  async proposeChange(params: CreateProposalParams): Promise<GovernanceProposal> {\r\n    const { key, new_value, created_by, timelock_hours = DEFAULT_TIMELOCK_HOURS } = params;\r\n\r\n    // Validate key\r\n    if (!isValidConfigKey(key)) {\r\n      throw new Error(`Invalid configuration key: ${key}. Valid keys: ${this.getValidKeys().join(', ')}`);\r\n    }\r\n\r\n    // Get current value\r\n    const old_value = await this.getNestedValue(key);\r\n\r\n    // Calculate ready_at (timelock)\r\n    const ready_at = new Date(Date.now() + timelock_hours * 60 * 60 * 1000);\r\n\r\n    // Create proposal\r\n    const proposal = await createProposal({\r\n      key,\r\n      old_value,\r\n      new_value,\r\n      created_by,\r\n      ready_at,\r\n    });\r\n\r\n    logger.info({\r\n      proposal_id: proposal.id,\r\n      key,\r\n      old_value,\r\n      new_value,\r\n      ready_at: ready_at.toISOString(),\r\n      created_by,\r\n    }, 'Governance proposal created');\r\n\r\n    return proposal;\r\n  }\r\n\r\n  /**\r\n   * Get a proposal by ID.\r\n   */\r\n  async getProposal(id: string): Promise<GovernanceProposal | null> {\r\n    return getProposalById(id);\r\n  }\r\n\r\n  /**\r\n   * List proposals with optional filters.\r\n   */\r\n  async listProposals(params?: {\r\n    status?: ProposalStatus;\r\n    key?: string;\r\n    limit?: number;\r\n    offset?: number;\r\n  }): Promise<GovernanceProposal[]> {\r\n    return listProposals(params);\r\n  }\r\n\r\n  /**\r\n   * List pending proposals.\r\n   */\r\n  async listPending(): Promise<GovernanceProposal[]> {\r\n    return listPendingProposals();\r\n  }\r\n\r\n  /**\r\n   * Get proposal statistics.\r\n   */\r\n  async getProposalStats(): Promise<Record<ProposalStatus, number>> {\r\n    return countProposalsByStatus();\r\n  }\r\n\r\n  /**\r\n   * Reject a pending proposal.\r\n   */\r\n  async rejectProposal(id: string, reason?: string): Promise<void> {\r\n    const proposal = await getProposalById(id);\r\n    if (!proposal) {\r\n      throw new Error(`Proposal not found: ${id}`);\r\n    }\r\n    if (proposal.status !== 'pending') {\r\n      throw new Error(`Cannot reject proposal with status: ${proposal.status}`);\r\n    }\r\n\r\n    await markProposalRejected(id, reason);\r\n\r\n    logger.info({\r\n      proposal_id: id,\r\n      key: proposal.key,\r\n      reason,\r\n    }, 'Governance proposal rejected');\r\n  }\r\n\r\n  // ===========================================================================\r\n  // APPLICATION METHODS\r\n  // ===========================================================================\r\n\r\n  /**\r\n   * Apply all proposals that are past their timelock.\r\n   */\r\n  async applyDueProposals(): Promise<ApplyProposalsResult> {\r\n    const dueProposals = await listDueProposals();\r\n    const result: ApplyProposalsResult = {\r\n      applied: [],\r\n      failed: [],\r\n    };\r\n\r\n    if (dueProposals.length === 0) {\r\n      logger.debug('No due proposals to apply');\r\n      return result;\r\n    }\r\n\r\n    logger.info({ count: dueProposals.length }, 'Applying due governance proposals');\r\n\r\n    for (const proposal of dueProposals) {\r\n      try {\r\n        await this.applyProposal(proposal);\r\n        result.applied.push(proposal);\r\n      } catch (error) {\r\n        const errorMessage = error instanceof Error ? error.message : String(error);\r\n        logger.error({\r\n          proposal_id: proposal.id,\r\n          key: proposal.key,\r\n          error: errorMessage,\r\n        }, 'Failed to apply governance proposal');\r\n        result.failed.push({ proposal, error: errorMessage });\r\n      }\r\n    }\r\n\r\n    logger.info({\r\n      applied: result.applied.length,\r\n      failed: result.failed.length,\r\n    }, 'Finished applying governance proposals');\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Apply a single proposal immediately (bypass timelock).\r\n   * Use with caution - only for admin override.\r\n   */\r\n  async forceApplyProposal(id: string): Promise<void> {\r\n    const proposal = await getProposalById(id);\r\n    if (!proposal) {\r\n      throw new Error(`Proposal not found: ${id}`);\r\n    }\r\n    if (proposal.status !== 'pending') {\r\n      throw new Error(`Cannot apply proposal with status: ${proposal.status}`);\r\n    }\r\n\r\n    await this.applyProposal(proposal);\r\n\r\n    logger.warn({\r\n      proposal_id: id,\r\n      key: proposal.key,\r\n    }, 'Governance proposal force-applied (timelock bypassed)');\r\n  }\r\n\r\n  /**\r\n   * Apply a single proposal.\r\n   */\r\n  private async applyProposal(proposal: GovernanceProposal): Promise<void> {\r\n    const { id, key, new_value, created_by } = proposal;\r\n\r\n    // Apply to config store\r\n    await this.applyConfigChange(key, new_value, created_by);\r\n\r\n    // Mark as applied\r\n    await markProposalApplied(id, new Date());\r\n\r\n    // Clear cache\r\n    this.clearCache();\r\n\r\n    // Notify listeners\r\n    this.notifyListeners(key, proposal.old_value, new_value);\r\n\r\n    logger.info({\r\n      proposal_id: id,\r\n      key,\r\n      new_value,\r\n    }, 'Governance proposal applied');\r\n\r\n    // Special handling for on-chain parameters\r\n    if (key === 'platform_fee_percentage') {\r\n      logger.warn({\r\n        key,\r\n        new_value,\r\n      }, 'Platform fee changed - ON-CHAIN UPDATE REQUIRED. Use contract-admin to update AtomicBatchSettlement.');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Apply a configuration change to the store.\r\n   */\r\n  private async applyConfigChange(key: string, value: unknown, updated_by: string): Promise<void> {\r\n    // Handle nested keys (e.g., 'anomaly_thresholds.max_error_rate')\r\n    const parts = key.split('.');\r\n\r\n    if (parts.length === 1) {\r\n      // Top-level key\r\n      await setConfigValue(key, value, updated_by);\r\n    } else {\r\n      // Nested key - need to merge\r\n      const topKey = parts[0];\r\n      const nestedPath = parts.slice(1);\r\n\r\n      // Get current value\r\n      const entry = await getConfigValue(topKey);\r\n      const currentValue = entry?.value ?? (DEFAULT_GOVERNANCE_CONFIG as any)[topKey] ?? {};\r\n\r\n      // Deep merge the new value\r\n      const updatedValue = this.setNestedValue({ ...currentValue }, nestedPath, value);\r\n\r\n      await setConfigValue(topKey, updatedValue, updated_by);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set a nested value in an object.\r\n   */\r\n  private setNestedValue(obj: any, path: string[], value: unknown): any {\r\n    if (path.length === 0) return value;\r\n\r\n    const [head, ...rest] = path;\r\n    if (rest.length === 0) {\r\n      obj[head] = value;\r\n    } else {\r\n      if (!obj[head] || typeof obj[head] !== 'object') {\r\n        obj[head] = {};\r\n      }\r\n      this.setNestedValue(obj[head], rest, value);\r\n    }\r\n\r\n    return obj;\r\n  }\r\n\r\n  // ===========================================================================\r\n  // CHANGE LISTENERS\r\n  // ===========================================================================\r\n\r\n  /**\r\n   * Register a listener for configuration changes.\r\n   */\r\n  onConfigChange(listener: (key: string, oldValue: unknown, newValue: unknown) => void): void {\r\n    this.changeListeners.push(listener);\r\n  }\r\n\r\n  /**\r\n   * Notify all listeners of a configuration change.\r\n   */\r\n  private notifyListeners(key: string, oldValue: unknown, newValue: unknown): void {\r\n    for (const listener of this.changeListeners) {\r\n      try {\r\n        listener(key, oldValue, newValue);\r\n      } catch (error) {\r\n        logger.error({ error, key }, 'Config change listener failed');\r\n      }\r\n    }\r\n  }\r\n\r\n  // ===========================================================================\r\n  // UTILITY METHODS\r\n  // ===========================================================================\r\n\r\n  /**\r\n   * Get list of valid configuration keys.\r\n   */\r\n  getValidKeys(): string[] {\r\n    const { VALID_CONFIG_KEYS } = require('@/types/governance');\r\n    return [...VALID_CONFIG_KEYS];\r\n  }\r\n\r\n  /**\r\n   * Validate a configuration value.\r\n   */\r\n  validateValue(key: string, value: unknown): { valid: boolean; error?: string } {\r\n    // Type-specific validation\r\n    switch (key) {\r\n      case 'platform_fee_percentage':\r\n      case 'max_fee_percentage':\r\n        if (typeof value !== 'number' || value < 0 || value > 10000) {\r\n          return { valid: false, error: 'Fee must be a number between 0 and 10000 basis points' };\r\n        }\r\n        break;\r\n\r\n      case 'min_fee_wei':\r\n        if (typeof value !== 'string' || !/^\\d+$/.test(value)) {\r\n          return { valid: false, error: 'min_fee_wei must be a numeric string' };\r\n        }\r\n        break;\r\n\r\n      case 'batch_max_size':\r\n      case 'batch_min_size':\r\n      case 'batch_timeout_minutes':\r\n        if (typeof value !== 'number' || value < 1) {\r\n          return { valid: false, error: 'Must be a positive integer' };\r\n        }\r\n        break;\r\n\r\n      case 'default_canary_share':\r\n      case 'max_canary_share':\r\n      case 'promotion_success_threshold':\r\n        if (typeof value !== 'number' || value < 0 || value > 1) {\r\n          return { valid: false, error: 'Must be a number between 0 and 1' };\r\n        }\r\n        break;\r\n\r\n      // Nested object keys - basic validation\r\n      default:\r\n        if (key.startsWith('anomaly_thresholds.') || \r\n            key.startsWith('load_thresholds.') || \r\n            key.startsWith('circuit_breaker.')) {\r\n          if (typeof value !== 'number') {\r\n            return { valid: false, error: 'Threshold values must be numbers' };\r\n          }\r\n        }\r\n    }\r\n\r\n    return { valid: true };\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// SINGLETON\r\n// =============================================================================\r\n\r\nlet instance: GovernanceConfigService | null = null;\r\n\r\n/**\r\n * Get the singleton GovernanceConfigService instance.\r\n */\r\nexport function getGovernanceConfigService(): GovernanceConfigService {\r\n  if (!instance) {\r\n    instance = new GovernanceConfigService();\r\n  }\r\n  return instance;\r\n}\r\n\r\n/**\r\n * Reset the singleton (for testing).\r\n */\r\nexport function resetGovernanceConfigService(): void {\r\n  instance = null;\r\n}\r\n\r\n\r\n","// =============================================================================\n// CONTRACT ADMIN SERVICE\n// =============================================================================\n// Handles on-chain governance operations for the AtomicBatchSettlement contract.\n// Encapsulates fee updates and other admin operations.\n//\n// Note: On-chain operations require manual execution by authorized operators.\n// This service provides the interface and logging for these operations.\n\nimport { createLogger } from '@/lib/logger';\nimport { createPublicClient, http, encodeFunctionData, parseAbi } from 'viem';\nimport { base, baseSepolia } from 'viem/chains';\n\nconst logger = createLogger({ component: 'ContractAdmin' });\n\n// =============================================================================\n// TYPES\n// =============================================================================\n\n/**\n * Result of a pending on-chain update.\n */\nexport interface PendingOnChainUpdate {\n  type: 'fee_update' | 'admin_update';\n  current_value: unknown;\n  new_value: unknown;\n  proposal_id?: string;\n  requires_multisig: boolean;\n  instructions: string;\n}\n\n/**\n * Status of on-chain governance.\n */\nexport interface OnChainGovernanceStatus {\n  contract_address: string;\n  chain_id: string;\n  current_fee_percentage: number;\n  admin_address: string;\n  pending_updates: PendingOnChainUpdate[];\n}\n\n// =============================================================================\n// CONTRACT ABI (minimal)\n// =============================================================================\n\nconst BATCH_SETTLEMENT_ABI = parseAbi([\n  'function platformFeePercentage() view returns (uint256)',\n  'function admin() view returns (address)',\n  'function proposeFeeUpdate(uint256 newFee)',\n  'function executeFeeUpdate()',\n]);\n\n// =============================================================================\n// CONTRACT ADMIN SERVICE\n// =============================================================================\n\n/**\n * Service for managing on-chain governance operations.\n */\nexport class ContractAdminService {\n  private contractAddress: `0x${string}` | null;\n  private chainId: string;\n\n  constructor(contractAddress?: string, chainId?: string) {\n    const addr = contractAddress || process.env.ATOMIC_BATCH_SETTLEMENT_ADDRESS || '';\n    this.contractAddress = addr && addr.startsWith('0x') ? addr as `0x${string}` : null;\n    this.chainId = chainId || process.env.DEFAULT_CHAIN_ID || 'base:mainnet';\n  }\n\n  // ===========================================================================\n  // FEE MANAGEMENT\n  // ===========================================================================\n\n  /**\n   * Get the current platform fee from the contract.\n   * Returns the fee in basis points.\n   */\n  async getCurrentFeePercentage(): Promise<number> {\n    if (!this.contractAddress) {\n      logger.warn('Contract address not configured, returning default fee');\n      return 25; // Default 0.25%\n    }\n\n    try {\n      const client = this.getClient();\n      if (!client) {\n        return 25;\n      }\n\n      const fee = await client.readContract({\n        address: this.contractAddress,\n        abi: BATCH_SETTLEMENT_ABI,\n        functionName: 'platformFeePercentage',\n      });\n\n      return Number(fee);\n    } catch (error) {\n      logger.error({ error }, 'Failed to get current fee from contract');\n      return 25;\n    }\n  }\n\n  /**\n   * Generate instructions for updating the platform fee on-chain.\n   * \n   * The AtomicBatchSettlement contract requires:\n   * 1. proposeFeeUpdate(newFee) - called by admin\n   * 2. Wait for timelock (e.g., 24 hours)\n   * 3. executeFeeUpdate() - called by admin\n   * \n   * This method returns the transaction data and instructions.\n   */\n  async prepareFeeUpdate(newFeePercentage: number): Promise<PendingOnChainUpdate> {\n    const currentFee = await this.getCurrentFeePercentage();\n\n    // Validate\n    if (newFeePercentage < 0 || newFeePercentage > 10000) {\n      throw new Error('Fee must be between 0 and 10000 basis points');\n    }\n\n    const proposeTxData = encodeFunctionData({\n      abi: BATCH_SETTLEMENT_ABI,\n      functionName: 'proposeFeeUpdate',\n      args: [BigInt(newFeePercentage)],\n    });\n\n    const executeTxData = encodeFunctionData({\n      abi: BATCH_SETTLEMENT_ABI,\n      functionName: 'executeFeeUpdate',\n    });\n\n    logger.info({\n      current_fee: currentFee,\n      new_fee: newFeePercentage,\n      contract: this.contractAddress,\n    }, 'Fee update prepared');\n\n    return {\n      type: 'fee_update',\n      current_value: currentFee,\n      new_value: newFeePercentage,\n      requires_multisig: true,\n      instructions: `\nON-CHAIN FEE UPDATE REQUIRED\n=============================\n\nContract: ${this.contractAddress || 'NOT CONFIGURED'}\nChain: ${this.chainId}\nCurrent Fee: ${currentFee} basis points (${currentFee / 100}%)\nNew Fee: ${newFeePercentage} basis points (${newFeePercentage / 100}%)\n\nSteps:\n1. Call proposeFeeUpdate(${newFeePercentage}) on the contract\n   TX Data: ${proposeTxData}\n\n2. Wait for the timelock period (typically 24-48 hours)\n\n3. Call executeFeeUpdate() to finalize\n   TX Data: ${executeTxData}\n\nUse your multisig wallet (e.g., Gnosis Safe) to execute these transactions.\n`.trim(),\n    };\n  }\n\n  /**\n   * Log that a fee update is required.\n   * Called when governance applies a platform_fee_percentage change.\n   */\n  logFeeUpdateRequired(newFeePercentage: number, proposalId?: string): void {\n    logger.warn({\n      new_fee: newFeePercentage,\n      proposal_id: proposalId,\n      contract: this.contractAddress,\n      chain: this.chainId,\n    }, 'ON-CHAIN ACTION REQUIRED: Platform fee update must be applied to AtomicBatchSettlement contract');\n  }\n\n  // ===========================================================================\n  // STATUS\n  // ===========================================================================\n\n  /**\n   * Get the current on-chain governance status.\n   */\n  async getStatus(): Promise<OnChainGovernanceStatus> {\n    const currentFee = await this.getCurrentFeePercentage();\n    const adminAddress = await this.getAdminAddress();\n\n    return {\n      contract_address: this.contractAddress || '',\n      chain_id: this.chainId,\n      current_fee_percentage: currentFee,\n      admin_address: adminAddress,\n      pending_updates: [], // Would need to query contract for pending proposals\n    };\n  }\n\n  /**\n   * Get the admin address from the contract.\n   */\n  async getAdminAddress(): Promise<string> {\n    if (!this.contractAddress) {\n      return '';\n    }\n\n    try {\n      const client = this.getClient();\n      if (!client) {\n        return '';\n      }\n\n      const admin = await client.readContract({\n        address: this.contractAddress,\n        abi: BATCH_SETTLEMENT_ABI,\n        functionName: 'admin',\n      });\n\n      return admin as string;\n    } catch (error) {\n      logger.debug({ error }, 'Failed to get admin address (may not be available)');\n      return process.env.ADMIN_MULTISIG_ADDRESS || '';\n    }\n  }\n\n  // ===========================================================================\n  // CLIENT\n  // ===========================================================================\n\n  /**\n   * Get the viem client for the configured chain.\n   */\n  private getClient() {\n    const rpcUrl = this.getRpcUrl();\n    \n    // Determine chain\n    const chain = this.chainId.includes('sepolia') ? baseSepolia : base;\n\n    try {\n      return createPublicClient({\n        chain,\n        transport: rpcUrl ? http(rpcUrl) : http(),\n      });\n    } catch (error) {\n      logger.debug({ error }, 'Failed to create client');\n      return null;\n    }\n  }\n\n  /**\n   * Get the RPC URL for the configured chain.\n   */\n  private getRpcUrl(): string {\n    const chainRpcEnvVar = `${this.chainId.replace(':', '_').toUpperCase()}_RPC_URL`;\n    const rpcUrl = process.env[chainRpcEnvVar] || process.env.RPC_URL || '';\n\n    if (!rpcUrl) {\n      logger.debug({ chain: this.chainId }, 'No RPC URL configured for chain');\n    }\n\n    return rpcUrl;\n  }\n}\n\n// =============================================================================\n// SINGLETON\n// =============================================================================\n\nlet instance: ContractAdminService | null = null;\n\n/**\n * Get the singleton ContractAdminService instance.\n */\nexport function getContractAdminService(): ContractAdminService {\n  if (!instance) {\n    instance = new ContractAdminService();\n  }\n  return instance;\n}\n\n/**\n * Reset the singleton (for testing).\n */\nexport function resetContractAdminService(): void {\n  instance = null;\n}\n","import { chainConfig } from '../../op-stack/chainConfig.js'\nimport { defineChain } from '../../utils/chain/defineChain.js'\n\nconst sourceId = 11_155_111 // sepolia\n\nexport const baseSepolia = /*#__PURE__*/ defineChain({\n  ...chainConfig,\n  id: 84532,\n  network: 'base-sepolia',\n  name: 'Base Sepolia',\n  nativeCurrency: { name: 'Sepolia Ether', symbol: 'ETH', decimals: 18 },\n  rpcUrls: {\n    default: {\n      http: ['https://sepolia.base.org'],\n    },\n  },\n  blockExplorers: {\n    default: {\n      name: 'Basescan',\n      url: 'https://sepolia.basescan.org',\n      apiUrl: 'https://api-sepolia.basescan.org/api',\n    },\n  },\n  contracts: {\n    ...chainConfig.contracts,\n    disputeGameFactory: {\n      [sourceId]: {\n        address: '0xd6E6dBf4F7EA0ac412fD8b65ED297e64BB7a06E1',\n      },\n    },\n    l2OutputOracle: {\n      [sourceId]: {\n        address: '0x84457ca9D0163FbC4bbfe4Dfbb20ba46e48DF254',\n      },\n    },\n    portal: {\n      [sourceId]: {\n        address: '0x49f53e41452c74589e85ca1677426ba426459e85',\n        blockCreated: 4446677,\n      },\n    },\n    l1StandardBridge: {\n      [sourceId]: {\n        address: '0xfd0Bf71F60660E2f608ed56e1659C450eB113120',\n        blockCreated: 4446677,\n      },\n    },\n    multicall3: {\n      address: '0xca11bde05977b3631167028862be2a173976ca11',\n      blockCreated: 1059647,\n    },\n  },\n  testnet: true,\n  sourceId,\n})\n\nexport const baseSepoliaPreconf = /*#__PURE__*/ defineChain({\n  ...baseSepolia,\n  experimental_preconfirmationTime: 200,\n  rpcUrls: {\n    default: {\n      http: ['https://sepolia-preconf.base.org'],\n    },\n  },\n})\n","// =============================================================================\r\n// GOVERNANCE PROPOSALS API\r\n// =============================================================================\r\n// API endpoints for governance proposal management.\r\n// Supports creating, listing, and applying configuration change proposals.\r\n//\r\n// Endpoints:\r\n// - GET  /api/v1/governance/proposals - List proposals\r\n// - POST /api/v1/governance/proposals - Create new proposal\r\n// - POST /api/v1/governance/proposals?action=apply - Apply due proposals\r\n\r\nimport { NextRequest, NextResponse } from 'next/server';\r\nimport { createLogger } from '@/lib/logger';\r\nimport { getGovernanceConfigService } from '@/services/governance/config-service';\r\nimport { getContractAdminService } from '@/services/governance/contract-admin';\r\nimport type {\r\n  CreateProposalRequest,\r\n  CreateProposalResponse,\r\n  ListProposalsResponse,\r\n  ApplyProposalsResponse,\r\n  GetConfigResponse,\r\n  ProposalStatus,\r\n} from '@/types/governance';\r\n\r\nconst logger = createLogger({ component: 'GovernanceAPI' });\r\n\r\n// =============================================================================\r\n// AUTHENTICATION HELPER\r\n// =============================================================================\r\n\r\n/**\r\n * Validate admin authentication.\r\n * In production, this should use proper auth (e.g., JWT, API key with admin scope).\r\n */\r\nasync function validateAdminAuth(req: NextRequest): Promise<{ valid: boolean; user?: string; error?: string }> {\r\n  // Check for API key\r\n  const authHeader = req.headers.get('authorization');\r\n  if (!authHeader) {\r\n    return { valid: false, error: 'Missing authorization header' };\r\n  }\r\n\r\n  const apiKey = authHeader.replace('Bearer ', '');\r\n  \r\n  // In production, validate against database\r\n  // For now, check against env var for admin key\r\n  const adminKey = process.env.GOVERNANCE_ADMIN_API_KEY;\r\n  if (!adminKey) {\r\n    logger.warn('GOVERNANCE_ADMIN_API_KEY not configured');\r\n    return { valid: false, error: 'Governance API not configured' };\r\n  }\r\n\r\n  if (apiKey !== adminKey) {\r\n    return { valid: false, error: 'Invalid API key' };\r\n  }\r\n\r\n  // Extract user from key (in production, look up from database)\r\n  return { valid: true, user: 'admin' };\r\n}\r\n\r\n// =============================================================================\r\n// GET /api/v1/governance/proposals\r\n// =============================================================================\r\n\r\n/**\r\n * List governance proposals.\r\n * \r\n * Query params:\r\n * - status: Filter by status (draft, pending, applied, rejected)\r\n * - key: Filter by configuration key\r\n * - limit: Max results (default 100)\r\n * - offset: Pagination offset\r\n * - config: If 'true', also return current config\r\n */\r\nexport async function GET(req: NextRequest) {\r\n  const startTime = Date.now();\r\n\r\n  try {\r\n    // Validate auth\r\n    const auth = await validateAdminAuth(req);\r\n    if (!auth.valid) {\r\n      return NextResponse.json(\r\n        { error: 'UNAUTHORIZED', message: auth.error },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    const searchParams = req.nextUrl.searchParams;\r\n    const status = searchParams.get('status') as ProposalStatus | null;\r\n    const key = searchParams.get('key');\r\n    const limit = parseInt(searchParams.get('limit') || '100', 10);\r\n    const offset = parseInt(searchParams.get('offset') || '0', 10);\r\n    const includeConfig = searchParams.get('config') === 'true';\r\n\r\n    const service = getGovernanceConfigService();\r\n\r\n    // Get proposals\r\n    const proposals = await service.listProposals({\r\n      status: status || undefined,\r\n      key: key || undefined,\r\n      limit,\r\n      offset,\r\n    });\r\n\r\n    const response: ListProposalsResponse & { config?: any } = {\r\n      proposals,\r\n      total: proposals.length,\r\n    };\r\n\r\n    // Optionally include current config\r\n    if (includeConfig) {\r\n      const config = await service.getConfig();\r\n      (response as any).config = config;\r\n      (response as any).config_last_updated = new Date();\r\n    }\r\n\r\n    logger.debug({\r\n      count: proposals.length,\r\n      status,\r\n      key,\r\n      duration_ms: Date.now() - startTime,\r\n    }, 'Listed governance proposals');\r\n\r\n    return NextResponse.json(response);\r\n  } catch (error) {\r\n    logger.error({ error, duration_ms: Date.now() - startTime }, 'Failed to list proposals');\r\n    return NextResponse.json(\r\n      { error: 'INTERNAL_ERROR', message: 'Failed to list proposals' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// POST /api/v1/governance/proposals\r\n// =============================================================================\r\n\r\n/**\r\n * Create a new governance proposal or apply due proposals.\r\n * \r\n * Query params:\r\n * - action: 'apply' to apply due proposals, otherwise create new proposal\r\n * \r\n * Body (for create):\r\n * {\r\n *   key: string,\r\n *   new_value: unknown,\r\n *   timelock_hours?: number (default 48)\r\n * }\r\n */\r\nexport async function POST(req: NextRequest) {\r\n  const startTime = Date.now();\r\n\r\n  try {\r\n    // Validate auth\r\n    const auth = await validateAdminAuth(req);\r\n    if (!auth.valid) {\r\n      return NextResponse.json(\r\n        { error: 'UNAUTHORIZED', message: auth.error },\r\n        { status: 401 }\r\n      );\r\n    }\r\n\r\n    const action = req.nextUrl.searchParams.get('action');\r\n    const service = getGovernanceConfigService();\r\n\r\n    // Handle apply action\r\n    if (action === 'apply') {\r\n      return await handleApplyProposals(service, startTime);\r\n    }\r\n\r\n    // Handle reject action\r\n    if (action === 'reject') {\r\n      const body = await req.json();\r\n      const { id, reason } = body;\r\n\r\n      if (!id) {\r\n        return NextResponse.json(\r\n          { error: 'INVALID_REQUEST', message: 'Missing proposal id' },\r\n          { status: 400 }\r\n        );\r\n      }\r\n\r\n      await service.rejectProposal(id, reason);\r\n\r\n      logger.info({\r\n        proposal_id: id,\r\n        reason,\r\n        user: auth.user,\r\n        duration_ms: Date.now() - startTime,\r\n      }, 'Governance proposal rejected via API');\r\n\r\n      return NextResponse.json({\r\n        success: true,\r\n        message: 'Proposal rejected',\r\n      });\r\n    }\r\n\r\n    // Handle force-apply action (bypass timelock)\r\n    if (action === 'force-apply') {\r\n      const body = await req.json();\r\n      const { id } = body;\r\n\r\n      if (!id) {\r\n        return NextResponse.json(\r\n          { error: 'INVALID_REQUEST', message: 'Missing proposal id' },\r\n          { status: 400 }\r\n        );\r\n      }\r\n\r\n      await service.forceApplyProposal(id);\r\n\r\n      logger.warn({\r\n        proposal_id: id,\r\n        user: auth.user,\r\n        duration_ms: Date.now() - startTime,\r\n      }, 'Governance proposal force-applied via API');\r\n\r\n      return NextResponse.json({\r\n        success: true,\r\n        message: 'Proposal force-applied (timelock bypassed)',\r\n      });\r\n    }\r\n\r\n    // Create new proposal\r\n    return await handleCreateProposal(req, service, auth.user!, startTime);\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : 'Unknown error';\r\n    logger.error({ error, duration_ms: Date.now() - startTime }, 'Governance API error');\r\n    return NextResponse.json(\r\n      { error: 'INTERNAL_ERROR', message },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n// =============================================================================\r\n// HANDLERS\r\n// =============================================================================\r\n\r\n/**\r\n * Handle proposal creation.\r\n */\r\nasync function handleCreateProposal(\r\n  req: NextRequest,\r\n  service: ReturnType<typeof getGovernanceConfigService>,\r\n  user: string,\r\n  startTime: number\r\n) {\r\n  const body = await req.json() as CreateProposalRequest;\r\n\r\n  // Validate request\r\n  if (!body.key || body.new_value === undefined) {\r\n    return NextResponse.json(\r\n      { error: 'INVALID_REQUEST', message: 'Missing required fields: key, new_value' },\r\n      { status: 400 }\r\n    );\r\n  }\r\n\r\n  // Validate the value\r\n  const validation = service.validateValue(body.key, body.new_value);\r\n  if (!validation.valid) {\r\n    return NextResponse.json(\r\n      { error: 'INVALID_VALUE', message: validation.error },\r\n      { status: 400 }\r\n    );\r\n  }\r\n\r\n  // Create proposal\r\n  const proposal = await service.proposeChange({\r\n    key: body.key,\r\n    new_value: body.new_value,\r\n    created_by: user,\r\n    timelock_hours: body.timelock_hours,\r\n  });\r\n\r\n  const response: CreateProposalResponse = {\r\n    proposal,\r\n    message: `Proposal created. Will be ready for application at ${proposal.ready_at.toISOString()}`,\r\n  };\r\n\r\n  logger.info({\r\n    proposal_id: proposal.id,\r\n    key: proposal.key,\r\n    user,\r\n    ready_at: proposal.ready_at.toISOString(),\r\n    duration_ms: Date.now() - startTime,\r\n  }, 'Governance proposal created via API');\r\n\r\n  return NextResponse.json(response, { status: 201 });\r\n}\r\n\r\n/**\r\n * Handle applying due proposals.\r\n */\r\nasync function handleApplyProposals(\r\n  service: ReturnType<typeof getGovernanceConfigService>,\r\n  startTime: number\r\n) {\r\n  const result = await service.applyDueProposals();\r\n\r\n  // Check if any applied proposals require on-chain updates\r\n  const contractAdmin = getContractAdminService();\r\n  for (const proposal of result.applied) {\r\n    if (proposal.key === 'platform_fee_percentage') {\r\n      contractAdmin.logFeeUpdateRequired(proposal.new_value as number, proposal.id);\r\n    }\r\n  }\r\n\r\n  const response: ApplyProposalsResponse = {\r\n    applied_count: result.applied.length,\r\n    applied: result.applied,\r\n    failed_count: result.failed.length,\r\n    failed: result.failed.map((f) => ({ id: f.proposal.id, error: f.error })),\r\n  };\r\n\r\n  logger.info({\r\n    applied: result.applied.length,\r\n    failed: result.failed.length,\r\n    duration_ms: Date.now() - startTime,\r\n  }, 'Applied due governance proposals via API');\r\n\r\n  return NextResponse.json(response);\r\n}\r\n\r\n\r\n","import {\n  AppRouteRouteModule,\n  type AppRouteRouteHandlerContext,\n  type AppRouteRouteModuleOptions,\n} from '../../server/route-modules/app-route/module.compiled'\nimport { RouteKind } from '../../server/route-kind'\nimport { patchFetch as _patchFetch } from '../../server/lib/patch-fetch'\nimport type { IncomingMessage, ServerResponse } from 'node:http'\nimport { addRequestMeta, getRequestMeta } from '../../server/request-meta'\nimport { getTracer, type Span, SpanKind } from '../../server/lib/trace/tracer'\nimport { setReferenceManifestsSingleton } from '../../server/app-render/encryption-utils'\nimport { createServerModuleMap } from '../../server/app-render/action-utils'\nimport { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\nimport { NodeNextRequest, NodeNextResponse } from '../../server/base-http/node'\nimport {\n  NextRequestAdapter,\n  signalFromNodeResponse,\n} from '../../server/web/spec-extension/adapters/next-request'\nimport { BaseServerSpan } from '../../server/lib/trace/constants'\nimport { getRevalidateReason } from '../../server/instrumentation/utils'\nimport { sendResponse } from '../../server/send-response'\nimport {\n  fromNodeOutgoingHttpHeaders,\n  toNodeOutgoingHttpHeaders,\n} from '../../server/web/utils'\nimport { getCacheControlHeader } from '../../server/lib/cache-control'\nimport { INFINITE_CACHE, NEXT_CACHE_TAGS_HEADER } from '../../lib/constants'\nimport { NoFallbackError } from '../../shared/lib/no-fallback-error.external'\nimport {\n  CachedRouteKind,\n  type ResponseCacheEntry,\n  type ResponseGenerator,\n} from '../../server/response-cache'\n\nimport * as userland from 'VAR_USERLAND'\n\n// These are injected by the loader afterwards. This is injected as a variable\n// instead of a replacement because this could also be `undefined` instead of\n// an empty string.\ndeclare const nextConfigOutput: AppRouteRouteModuleOptions['nextConfigOutput']\n\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\n// INJECT:nextConfigOutput\n\nconst routeModule = new AppRouteRouteModule({\n  definition: {\n    kind: RouteKind.APP_ROUTE,\n    page: 'VAR_DEFINITION_PAGE',\n    pathname: 'VAR_DEFINITION_PATHNAME',\n    filename: 'VAR_DEFINITION_FILENAME',\n    bundlePath: 'VAR_DEFINITION_BUNDLE_PATH',\n  },\n  distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n  relativeProjectDir: process.env.__NEXT_RELATIVE_PROJECT_DIR || '',\n  resolvedPagePath: 'VAR_RESOLVED_PAGE_PATH',\n  nextConfigOutput,\n  userland,\n})\n\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { workAsyncStorage, workUnitAsyncStorage, serverHooks } = routeModule\n\nfunction patchFetch() {\n  return _patchFetch({\n    workAsyncStorage,\n    workUnitAsyncStorage,\n  })\n}\n\nexport {\n  routeModule,\n  workAsyncStorage,\n  workUnitAsyncStorage,\n  serverHooks,\n  patchFetch,\n}\n\nexport async function handler(\n  req: IncomingMessage,\n  res: ServerResponse,\n  ctx: {\n    waitUntil: (prom: Promise<void>) => void\n  }\n) {\n  if (routeModule.isDev) {\n    addRequestMeta(req, 'devRequestTimingInternalsEnd', process.hrtime.bigint())\n  }\n  let srcPage = 'VAR_DEFINITION_PAGE'\n\n  // turbopack doesn't normalize `/index` in the page name\n  // so we need to to process dynamic routes properly\n  // TODO: fix turbopack providing differing value from webpack\n  if (process.env.TURBOPACK) {\n    srcPage = srcPage.replace(/\\/index$/, '') || '/'\n  } else if (srcPage === '/index') {\n    // we always normalize /index specifically\n    srcPage = '/'\n  }\n  const multiZoneDraftMode = process.env\n    .__NEXT_MULTI_ZONE_DRAFT_MODE as any as boolean\n\n  const prepareResult = await routeModule.prepare(req, res, {\n    srcPage,\n    multiZoneDraftMode,\n  })\n\n  if (!prepareResult) {\n    res.statusCode = 400\n    res.end('Bad Request')\n    ctx.waitUntil?.(Promise.resolve())\n    return null\n  }\n\n  const {\n    buildId,\n    params,\n    nextConfig,\n    parsedUrl,\n    isDraftMode,\n    prerenderManifest,\n    routerServerContext,\n    isOnDemandRevalidate,\n    revalidateOnlyGenerated,\n    resolvedPathname,\n    clientReferenceManifest,\n    serverActionsManifest,\n  } = prepareResult\n\n  const normalizedSrcPage = normalizeAppPath(srcPage)\n\n  let isIsr = Boolean(\n    prerenderManifest.dynamicRoutes[normalizedSrcPage] ||\n      prerenderManifest.routes[resolvedPathname]\n  )\n\n  const render404 = async () => {\n    // TODO: should route-module itself handle rendering the 404\n    if (routerServerContext?.render404) {\n      await routerServerContext.render404(req, res, parsedUrl, false)\n    } else {\n      res.end('This page could not be found')\n    }\n    return null\n  }\n\n  if (isIsr && !isDraftMode) {\n    const isPrerendered = Boolean(prerenderManifest.routes[resolvedPathname])\n    const prerenderInfo = prerenderManifest.dynamicRoutes[normalizedSrcPage]\n\n    if (prerenderInfo) {\n      if (prerenderInfo.fallback === false && !isPrerendered) {\n        if (nextConfig.experimental.adapterPath) {\n          return await render404()\n        }\n        throw new NoFallbackError()\n      }\n    }\n  }\n\n  let cacheKey: string | null = null\n\n  if (isIsr && !routeModule.isDev && !isDraftMode) {\n    cacheKey = resolvedPathname\n    // ensure /index and / is normalized to one key\n    cacheKey = cacheKey === '/index' ? '/' : cacheKey\n  }\n\n  const supportsDynamicResponse: boolean =\n    // If we're in development, we always support dynamic HTML\n    routeModule.isDev === true ||\n    // If this is not SSG or does not have static paths, then it supports\n    // dynamic HTML.\n    !isIsr\n\n  // This is a revalidation request if the request is for a static\n  // page and it is not being resumed from a postponed render and\n  // it is not a dynamic RSC request then it is a revalidation\n  // request.\n  const isStaticGeneration = isIsr && !supportsDynamicResponse\n\n  // Before rendering (which initializes component tree modules), we have to\n  // set the reference manifests to our global store so Server Action's\n  // encryption util can access to them at the top level of the page module.\n  if (serverActionsManifest && clientReferenceManifest) {\n    setReferenceManifestsSingleton({\n      page: srcPage,\n      clientReferenceManifest,\n      serverActionsManifest,\n      serverModuleMap: createServerModuleMap({\n        serverActionsManifest,\n      }),\n    })\n  }\n\n  const method = req.method || 'GET'\n  const tracer = getTracer()\n  const activeSpan = tracer.getActiveScopeSpan()\n\n  const context: AppRouteRouteHandlerContext = {\n    params,\n    prerenderManifest,\n    renderOpts: {\n      experimental: {\n        authInterrupts: Boolean(nextConfig.experimental.authInterrupts),\n      },\n      cacheComponents: Boolean(nextConfig.cacheComponents),\n      supportsDynamicResponse,\n      incrementalCache: getRequestMeta(req, 'incrementalCache'),\n      cacheLifeProfiles: nextConfig.cacheLife,\n      waitUntil: ctx.waitUntil,\n      onClose: (cb) => {\n        res.on('close', cb)\n      },\n      onAfterTaskError: undefined,\n      onInstrumentationRequestError: (error, _request, errorContext) =>\n        routeModule.onRequestError(\n          req,\n          error,\n          errorContext,\n          routerServerContext\n        ),\n    },\n    sharedContext: {\n      buildId,\n    },\n  }\n  const nodeNextReq = new NodeNextRequest(req)\n  const nodeNextRes = new NodeNextResponse(res)\n\n  const nextReq = NextRequestAdapter.fromNodeNextRequest(\n    nodeNextReq,\n    signalFromNodeResponse(res)\n  )\n\n  try {\n    const invokeRouteModule = async (span?: Span) => {\n      return routeModule.handle(nextReq, context).finally(() => {\n        if (!span) return\n\n        span.setAttributes({\n          'http.status_code': res.statusCode,\n          'next.rsc': false,\n        })\n\n        const rootSpanAttributes = tracer.getRootSpanAttributes()\n        // We were unable to get attributes, probably OTEL is not enabled\n        if (!rootSpanAttributes) {\n          return\n        }\n\n        if (\n          rootSpanAttributes.get('next.span_type') !==\n          BaseServerSpan.handleRequest\n        ) {\n          console.warn(\n            `Unexpected root span type '${rootSpanAttributes.get(\n              'next.span_type'\n            )}'. Please report this Next.js issue https://github.com/vercel/next.js`\n          )\n          return\n        }\n\n        const route = rootSpanAttributes.get('next.route')\n        if (route) {\n          const name = `${method} ${route}`\n\n          span.setAttributes({\n            'next.route': route,\n            'http.route': route,\n            'next.span_name': name,\n          })\n          span.updateName(name)\n        } else {\n          span.updateName(`${method} ${srcPage}`)\n        }\n      })\n    }\n    const isMinimalMode = Boolean(\n      process.env.MINIMAL_MODE || getRequestMeta(req, 'minimalMode')\n    )\n\n    const handleResponse = async (currentSpan?: Span) => {\n      const responseGenerator: ResponseGenerator = async ({\n        previousCacheEntry,\n      }) => {\n        try {\n          if (\n            !isMinimalMode &&\n            isOnDemandRevalidate &&\n            revalidateOnlyGenerated &&\n            !previousCacheEntry\n          ) {\n            res.statusCode = 404\n            // on-demand revalidate always sets this header\n            res.setHeader('x-nextjs-cache', 'REVALIDATED')\n            res.end('This page could not be found')\n            return null\n          }\n\n          const response = await invokeRouteModule(currentSpan)\n\n          ;(req as any).fetchMetrics = (context.renderOpts as any).fetchMetrics\n          let pendingWaitUntil = context.renderOpts.pendingWaitUntil\n\n          // Attempt using provided waitUntil if available\n          // if it's not we fallback to sendResponse's handling\n          if (pendingWaitUntil) {\n            if (ctx.waitUntil) {\n              ctx.waitUntil(pendingWaitUntil)\n              pendingWaitUntil = undefined\n            }\n          }\n          const cacheTags = context.renderOpts.collectedTags\n\n          // If the request is for a static response, we can cache it so long\n          // as it's not edge.\n          if (isIsr) {\n            const blob = await response.blob()\n\n            // Copy the headers from the response.\n            const headers = toNodeOutgoingHttpHeaders(response.headers)\n\n            if (cacheTags) {\n              headers[NEXT_CACHE_TAGS_HEADER] = cacheTags\n            }\n\n            if (!headers['content-type'] && blob.type) {\n              headers['content-type'] = blob.type\n            }\n\n            const revalidate =\n              typeof context.renderOpts.collectedRevalidate === 'undefined' ||\n              context.renderOpts.collectedRevalidate >= INFINITE_CACHE\n                ? false\n                : context.renderOpts.collectedRevalidate\n\n            const expire =\n              typeof context.renderOpts.collectedExpire === 'undefined' ||\n              context.renderOpts.collectedExpire >= INFINITE_CACHE\n                ? undefined\n                : context.renderOpts.collectedExpire\n\n            // Create the cache entry for the response.\n            const cacheEntry: ResponseCacheEntry = {\n              value: {\n                kind: CachedRouteKind.APP_ROUTE,\n                status: response.status,\n                body: Buffer.from(await blob.arrayBuffer()),\n                headers,\n              },\n              cacheControl: { revalidate, expire },\n            }\n\n            return cacheEntry\n          } else {\n            // send response without caching if not ISR\n            await sendResponse(\n              nodeNextReq,\n              nodeNextRes,\n              response,\n              context.renderOpts.pendingWaitUntil\n            )\n            return null\n          }\n        } catch (err) {\n          // if this is a background revalidate we need to report\n          // the request error here as it won't be bubbled\n          if (previousCacheEntry?.isStale) {\n            await routeModule.onRequestError(\n              req,\n              err,\n              {\n                routerKind: 'App Router',\n                routePath: srcPage,\n                routeType: 'route',\n                revalidateReason: getRevalidateReason({\n                  isStaticGeneration,\n                  isOnDemandRevalidate,\n                }),\n              },\n              routerServerContext\n            )\n          }\n          throw err\n        }\n      }\n\n      const cacheEntry = await routeModule.handleResponse({\n        req,\n        nextConfig,\n        cacheKey,\n        routeKind: RouteKind.APP_ROUTE,\n        isFallback: false,\n        prerenderManifest,\n        isRoutePPREnabled: false,\n        isOnDemandRevalidate,\n        revalidateOnlyGenerated,\n        responseGenerator,\n        waitUntil: ctx.waitUntil,\n        isMinimalMode,\n      })\n\n      // we don't create a cacheEntry for ISR\n      if (!isIsr) {\n        return null\n      }\n\n      if (cacheEntry?.value?.kind !== CachedRouteKind.APP_ROUTE) {\n        throw new Error(\n          `Invariant: app-route received invalid cache entry ${cacheEntry?.value?.kind}`\n        )\n      }\n\n      if (!isMinimalMode) {\n        res.setHeader(\n          'x-nextjs-cache',\n          isOnDemandRevalidate\n            ? 'REVALIDATED'\n            : cacheEntry.isMiss\n              ? 'MISS'\n              : cacheEntry.isStale\n                ? 'STALE'\n                : 'HIT'\n        )\n      }\n\n      // Draft mode should never be cached\n      if (isDraftMode) {\n        res.setHeader(\n          'Cache-Control',\n          'private, no-cache, no-store, max-age=0, must-revalidate'\n        )\n      }\n\n      const headers = fromNodeOutgoingHttpHeaders(cacheEntry.value.headers)\n\n      if (!(isMinimalMode && isIsr)) {\n        headers.delete(NEXT_CACHE_TAGS_HEADER)\n      }\n\n      // If cache control is already set on the response we don't\n      // override it to allow users to customize it via next.config\n      if (\n        cacheEntry.cacheControl &&\n        !res.getHeader('Cache-Control') &&\n        !headers.get('Cache-Control')\n      ) {\n        headers.set(\n          'Cache-Control',\n          getCacheControlHeader(cacheEntry.cacheControl)\n        )\n      }\n\n      await sendResponse(\n        nodeNextReq,\n        nodeNextRes,\n        // @ts-expect-error - Argument of type 'Buffer<ArrayBufferLike>' is not assignable to parameter of type 'BodyInit | null | undefined'.\n        new Response(cacheEntry.value.body, {\n          headers,\n          status: cacheEntry.value.status || 200,\n        })\n      )\n      return null\n    }\n\n    // TODO: activeSpan code path is for when wrapped by\n    // next-server can be removed when this is no longer used\n    if (activeSpan) {\n      await handleResponse(activeSpan)\n    } else {\n      await tracer.withPropagatedContext(req.headers, () =>\n        tracer.trace(\n          BaseServerSpan.handleRequest,\n          {\n            spanName: `${method} ${srcPage}`,\n            kind: SpanKind.SERVER,\n            attributes: {\n              'http.method': method,\n              'http.target': req.url,\n            },\n          },\n          handleResponse\n        )\n      )\n    }\n  } catch (err) {\n    if (!(err instanceof NoFallbackError)) {\n      await routeModule.onRequestError(req, err, {\n        routerKind: 'App Router',\n        routePath: normalizedSrcPage,\n        routeType: 'route',\n        revalidateReason: getRevalidateReason({\n          isStaticGeneration,\n          isOnDemandRevalidate,\n        }),\n      })\n    }\n\n    // rethrow so that we can handle serving error page\n\n    // If this is during static generation, throw the error again.\n    if (isIsr) throw err\n\n    // Otherwise, send a 500 response.\n    await sendResponse(\n      nodeNextReq,\n      nodeNextRes,\n      new Response(null, { status: 500 })\n    )\n    return null\n  }\n}\n"],"names":["AppRouteRouteModule","RouteKind","patchFetch","_patchFetch","addRequestMeta","getRequestMeta","getTracer","SpanKind","setReferenceManifestsSingleton","createServerModuleMap","normalizeAppPath","NodeNextRequest","NodeNextResponse","NextRequestAdapter","signalFromNodeResponse","BaseServerSpan","getRevalidateReason","sendResponse","fromNodeOutgoingHttpHeaders","toNodeOutgoingHttpHeaders","getCacheControlHeader","INFINITE_CACHE","NEXT_CACHE_TAGS_HEADER","NoFallbackError","CachedRouteKind","userland","routeModule","definition","kind","APP_ROUTE","page","pathname","filename","bundlePath","distDir","process","env","__NEXT_RELATIVE_DIST_DIR","relativeProjectDir","__NEXT_RELATIVE_PROJECT_DIR","resolvedPagePath","nextConfigOutput","workAsyncStorage","workUnitAsyncStorage","serverHooks","handler","req","res","ctx","isDev","hrtime","bigint","srcPage","TURBOPACK","replace","multiZoneDraftMode","__NEXT_MULTI_ZONE_DRAFT_MODE","prepareResult","prepare","statusCode","end","waitUntil","Promise","resolve","buildId","params","nextConfig","parsedUrl","isDraftMode","prerenderManifest","routerServerContext","isOnDemandRevalidate","revalidateOnlyGenerated","resolvedPathname","clientReferenceManifest","serverActionsManifest","normalizedSrcPage","isIsr","Boolean","dynamicRoutes","routes","render404","isPrerendered","prerenderInfo","fallback","experimental","adapterPath","cacheKey","supportsDynamicResponse","isStaticGeneration","serverModuleMap","method","tracer","activeSpan","getActiveScopeSpan","context","renderOpts","authInterrupts","cacheComponents","incrementalCache","cacheLifeProfiles","cacheLife","onClose","cb","on","onAfterTaskError","undefined","onInstrumentationRequestError","error","_request","errorContext","onRequestError","sharedContext","nodeNextReq","nodeNextRes","nextReq","fromNodeNextRequest","invokeRouteModule","span","handle","finally","setAttributes","rootSpanAttributes","getRootSpanAttributes","get","handleRequest","console","warn","route","name","updateName","isMinimalMode","MINIMAL_MODE","handleResponse","currentSpan","cacheEntry","responseGenerator","previousCacheEntry","setHeader","response","fetchMetrics","pendingWaitUntil","cacheTags","collectedTags","blob","headers","type","revalidate","collectedRevalidate","expire","collectedExpire","value","status","body","Buffer","from","arrayBuffer","cacheControl","err","isStale","routerKind","routePath","routeType","revalidateReason","routeKind","isFallback","isRoutePPREnabled","Error","isMiss","delete","getHeader","set","Response","withPropagatedContext","trace","spanName","SERVER","attributes","url"],"mappings":"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","ignoreList":[3,5]}
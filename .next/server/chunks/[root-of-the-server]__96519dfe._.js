module.exports=[93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},22734,(e,t,r)=>{t.exports=e.x("fs",()=>require("fs"))},30056,e=>e.a(async(t,r)=>{try{let t=await e.y("pg");e.n(t),r()}catch(e){r(e)}},!0),14747,(e,t,r)=>{t.exports=e.x("path",()=>require("path"))},70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},24361,(e,t,r)=>{t.exports=e.x("util",()=>require("util"))},87769,(e,t,r)=>{t.exports=e.x("node:events",()=>require("node:events"))},49719,(e,t,r)=>{t.exports=e.x("assert",()=>require("assert"))},27699,(e,t,r)=>{t.exports=e.x("events",()=>require("events"))},92509,(e,t,r)=>{t.exports=e.x("url",()=>require("url"))},874,(e,t,r)=>{t.exports=e.x("buffer",()=>require("buffer"))},62562,(e,t,r)=>{t.exports=e.x("module",()=>require("module"))},50227,(e,t,r)=>{t.exports=e.x("node:path",()=>require("node:path"))},94346,e=>{e.v({name:"thread-stream",version:"3.1.0",description:"A streaming way to send data to a Node.js Worker Thread",main:"index.js",types:"index.d.ts",dependencies:{"real-require":"^0.2.0"},devDependencies:{"@types/node":"^20.1.0","@types/tap":"^15.0.0","@yao-pkg/pkg":"^5.11.5",desm:"^1.3.0",fastbench:"^1.0.1",husky:"^9.0.6","pino-elasticsearch":"^8.0.0","sonic-boom":"^4.0.1",standard:"^17.0.0",tap:"^16.2.0","ts-node":"^10.8.0",typescript:"^5.3.2","why-is-node-running":"^2.2.2"},scripts:{build:"tsc --noEmit",test:'standard && npm run build && npm run transpile && tap "test/**/*.test.*js" && tap --ts test/*.test.*ts',"test:ci":"standard && npm run transpile && npm run test:ci:js && npm run test:ci:ts","test:ci:js":'tap --no-check-coverage --timeout=120 --coverage-report=lcovonly "test/**/*.test.*js"',"test:ci:ts":'tap --ts --no-check-coverage --coverage-report=lcovonly "test/**/*.test.*ts"',"test:yarn":'npm run transpile && tap "test/**/*.test.js" --no-check-coverage',transpile:"sh ./test/ts/transpile.sh",prepare:"husky install"},standard:{ignore:["test/ts/**/*","test/syntax-error.mjs"]},repository:{type:"git",url:"git+https://github.com/mcollina/thread-stream.git"},keywords:["worker","thread","threads","stream"],author:"Matteo Collina <hello@matteocollina.com>",license:"MIT",bugs:{url:"https://github.com/mcollina/thread-stream/issues"},homepage:"https://github.com/mcollina/thread-stream#readme"})},37702,(e,t,r)=>{t.exports=e.x("worker_threads",()=>require("worker_threads"))},60526,(e,t,r)=>{t.exports=e.x("node:os",()=>require("node:os"))},77652,(e,t,r)=>{t.exports=e.x("node:diagnostics_channel",()=>require("node:diagnostics_channel"))},54799,(e,t,r)=>{t.exports=e.x("crypto",()=>require("crypto"))},97697,e=>{"use strict";var t=e.i(50377);let r="x-request-id";function a(e){let t,a,n=e.headers.get(r);if(n){let t=process.env.TRUSTED_REQUEST_ID_SOURCES?.split(",")||[];if(0===t.length||t.some(t=>{let r=e.headers.get("origin")||"",a=e.headers.get("referer")||"";return r.includes(t)||a.includes(t)}))return n}return t=new Uint8Array(16),crypto.getRandomValues(t),t[6]=15&t[6]|64,t[8]=63&t[8]|128,[(a=Array.from(t).map(e=>e.toString(16).padStart(2,"0")).join("")).substring(0,8),a.substring(8,12),a.substring(12,16),a.substring(16,20),a.substring(20,32)].join("-")}function n(e,t){return e.headers.set(r,t),e}function i(e,r){let a={requestId:e,...r},n=(0,t.createLogger)(a);return{info:(e,t)=>{n.info({...a,...t},e)},warn:(e,t)=>{n.warn({...a,...t},e)},error:(e,t)=>{n.error({...a,...t},e)},debug:(e,t)=>{n.debug({...a,...t},e)}}}e.s(["addRequestIdToResponse",()=>n,"createRequestLogger",()=>i,"getOrCreateRequestId",()=>a])},34006,e=>{"use strict";var t=e.i(89171);let r=(0,e.i(50377).createLogger)({component:"RateLimitStore"});class a{store=new Map;cleanupInterval=null;constructor(){"undefined"!=typeof setInterval&&(this.cleanupInterval=setInterval(()=>this.cleanup(),3e5))}cleanup(){let e=Date.now(),t=[];this.store.forEach((r,a)=>{r.resetAt<e&&t.push(a)}),t.forEach(e=>this.store.delete(e))}async get(e){let t=this.store.get(e);return!t||t.resetAt<Date.now()?null:t}async set(e,t){this.store.set(e,t)}async increment(e,t){let r=Date.now(),a=this.store.get(e);if(!a||a.resetAt<r){let a={count:1,resetAt:r+t};return this.store.set(e,a),a}return a.count++,this.store.set(e,a),a}}class n{redis;constructor(e){this.redis=e}async get(e){try{let t=await this.redis.get(`ratelimit:${e}`);if(!t)return null;let r="string"==typeof t?JSON.parse(t):t;if(r.resetAt<Date.now())return null;return r}catch(t){return r.error({error:t,key:e},"Upstash Redis GET failed"),null}}async set(e,t){try{let r=Math.max(t.resetAt-Date.now(),1e3),a=Math.ceil(r/1e3);await this.redis.set(`ratelimit:${e}`,JSON.stringify(t),{ex:a})}catch(t){r.error({error:t,key:e},"Upstash Redis SET failed")}}async increment(e,t){try{let r=`ratelimit:${e}`,a=Date.now(),n=await this.redis.get(r),i=1,s=a+t;if(n){let e="string"==typeof n?JSON.parse(n):n;e.resetAt>a&&(i=e.count+1,s=e.resetAt)}let o={count:i,resetAt:s},l=s-a,c=Math.ceil(l/1e3);return await this.redis.set(r,JSON.stringify(o),{ex:c}),o}catch(a){return r.error({error:a,key:e},"Upstash Redis INCR failed"),{count:1,resetAt:Date.now()+t}}}}let i=null;async function s(){if(i)return i;let t=process.env.UPSTASH_REDIS_REST_URL,s=process.env.UPSTASH_REDIS_REST_TOKEN;if(t&&s)try{let{Redis:a}=await e.A(2759),o=new a({url:t,token:s});return await o.ping(),r.info("Rate limit store using Upstash Redis"),i=new n(o)}catch(e){r.warn({error:e},"Upstash Redis connection failed, falling back to in-memory")}let o=process.env.REDIS_URL;if(o)try{let{Redis:t}=await e.A(6538),a=new t(o,{maxRetriesPerRequest:3,enableReadyCheck:!0,connectTimeout:5e3,lazyConnect:!0});return await a.connect(),r.info("Rate limit store using Redis (ioredis)"),i={async get(e){let t=await a.get(`ratelimit:${e}`);if(!t)return null;let r=JSON.parse(t);return r.resetAt<Date.now()?null:r},async set(e,t){let r=Math.max(t.resetAt-Date.now(),1e3);await a.set(`ratelimit:${e}`,JSON.stringify(t),"PX",r)},async increment(e,t){let r=Date.now(),n=`ratelimit:${e}`,i=await a.get(n),s=1,o=r+t;if(i){let e=JSON.parse(i);e.resetAt>r&&(s=e.count+1,o=e.resetAt)}let l={count:s,resetAt:o},c=o-r;return await a.set(n,JSON.stringify(l),"PX",c),l}}}catch(e){r.warn({error:e},"Redis connection failed, falling back to in-memory")}return r.info("Rate limit store using in-memory (non-distributed)"),i=new a}let o=36e5,l=1e3,c=6e4,u=100,d=36e5,p=1e3,m=6e4,h=1,g={requests:new Map,blocked:new Map,latencies:new Map,lastReset:Date.now()};function f(e,t){if(0===e.length)return 0;let r=Math.ceil(e.length*t)-1;return e[Math.max(0,Math.min(r,e.length-1))]}function y(){let e={},t=0,r=0;for(let a of new Set([...g.requests.keys(),...g.blocked.keys()])){let n=g.requests.get(a)||0,i=g.blocked.get(a)||0,s=g.latencies.get(a)||[];t+=n,r+=i;let o=[...s].sort((e,t)=>e-t);e[a]={total:n,blocked:i,blockRate:n>0?(i/n*100).toFixed(2)+"%":"0%",latency:{p50:Math.round(f(o,.5)),p95:Math.round(f(o,.95)),p99:Math.round(f(o,.99))}}}return{byType:e,totals:{requests:t,blocked:r,blockRate:t>0?(r/t*100).toFixed(2)+"%":"0%"},lastReset:new Date(g.lastReset).toISOString()}}function w(e){return e.ip||e.headers.get("x-forwarded-for")?.split(",")[0]?.trim()||e.headers.get("x-real-ip")||"unknown"}async function v(e,t,r){var a;let n,i,s=Date.now(),o=await e.increment(t.identifier,t.windowMs),l=o.count<=t.maxRequests,c=Math.max(0,t.maxRequests-o.count);return r&&(a=Date.now()-s,(n=Date.now())-g.lastReset>36e5&&(g.requests.clear(),g.blocked.clear(),g.latencies.clear(),g.lastReset=n),g.requests.set(r,(g.requests.get(r)||0)+1),l||g.blocked.set(r,(g.blocked.get(r)||0)+1),(i=g.latencies.get(r))||(i=[],g.latencies.set(r,i)),i.push(a),i.length>100&&i.shift()),{allowed:l,remaining:c,resetAt:o.resetAt,limit:t.maxRequests}}async function _(e,t){let r,a=(r=e.headers.get("authorization"))?r.startsWith("Bearer ")?r.substring(7).trim():r.trim():null;return a?v(await s(),{windowMs:d,maxRequests:t||p,identifier:`api_key:${a.substring(0,16)}`},"api_key"):null}async function b(e,t,r){let a=await s(),n=w(e);return v(a,{windowMs:c,maxRequests:r||u,identifier:`endpoint:${t}:${n}`},`endpoint:${t}`)}async function E(e,t){let r=await s(),a=w(e);return v(r,{windowMs:o,maxRequests:t||l,identifier:`global:${a}`},"global")}async function I(e,t){return v(await s(),{windowMs:t||m,maxRequests:h,identifier:`cron:${e}`},`cron:${e}`)}function S(e,t){return e.headers.set("X-RateLimit-Limit",t.limit.toString()),e.headers.set("X-RateLimit-Remaining",t.remaining.toString()),e.headers.set("X-RateLimit-Reset",new Date(t.resetAt).toISOString()),e}function k(e){let r=new Date(e.resetAt).toISOString(),a=Math.ceil((e.resetAt-Date.now())/1e3),n=t.NextResponse.json({error:"Rate limit exceeded",code:"RATE_LIMIT_EXCEEDED",message:`Too many requests. Limit: ${e.limit} per hour. Try again after ${r}`,retryAfter:a},{status:429});return n.headers.set("Retry-After",a.toString()),S(n,e)}async function x(e,t){let r=[],a=await E(e);r.push(a);let n=await _(e);if(n&&r.push(n),t){let a=await b(e,t);r.push(a)}return 0===r.length?null:r.reduce((e,t)=>t.remaining<e.remaining?t:e)}e.s(["addRateLimitHeaders",()=>S,"createRateLimitResponse",()=>k,"getRateLimitHeaders",()=>x,"getRateLimitMetrics",()=>y,"rateLimitByApiKey",()=>_,"rateLimitCronJob",()=>I],34006)},50848,e=>e.a(async(t,r)=>{try{var a=e.i(24924),n=t([a]);async function i(e,t=[]){let r=(0,a.getDb)();if("pool"in r&&"function"==typeof r.pool?.query){let a=r.pool;return(await a.query(e,t)).rows}if("db"in r&&"function"==typeof r.db?.prepare)return r.db.prepare(e).all(...t);if("function"==typeof r.query){let a=await r.query(e,t);return a.rows||a}if("function"==typeof r.prepare)return r.prepare(e).all(...t);throw Error("Unable to execute query: database adapter not recognized")}async function s(e,t=[]){let r=await i(e,t);return r.length>0?r[0]:null}async function o(e,t=[]){let r=(0,a.getDb)();if("pool"in r&&"function"==typeof r.pool?.query){let a=r.pool;return{rowCount:(await a.query(e,t)).rowCount}}if("db"in r&&"function"==typeof r.db?.prepare)return{changes:r.db.prepare(e).run(...t).changes};if("function"==typeof r.query)return{rowCount:(await r.query(e,t)).rowCount};if("function"==typeof r.prepare)return{changes:r.prepare(e).run(...t).changes};throw Error("Unable to execute update: database adapter not recognized")}[a]=n.then?(await n)():n,e.s(["executeQuery",()=>i,"executeQueryOne",()=>s,"executeUpdate",()=>o]),r()}catch(e){r(e)}},!1),64001,e=>e.a(async(t,r)=>{try{var a=e.i(24924),n=t([a]);async function i(e){let t=(0,a.getDb)();return await t.createEndpoint(e)}async function s(e){let t=(0,a.getDb)();return await t.getEndpoint(e)}async function o(e){let t=(0,a.getDb)();return await t.listEndpoints(e)}async function l(e,t){let r=(0,a.getDb)();return await r.updateEndpoint(e,t)}async function c(e){let t=(0,a.getDb)();return await t.deleteEndpoint(e)}async function u(e){let t=(0,a.getDb)();return await t.createPayment(e)}async function d(e){let t=(0,a.getDb)();return await t.getPayment(e)}async function p(e){let t=(0,a.getDb)();return await t.getPaymentByTxHash(e)}async function m(e){let t=(0,a.getDb)();return await t.listPayments(e)}async function h(e,t=100){let r=(0,a.getDb)();return await r.getPaymentsForEndpoint(e,t)}async function g(e){let t=(0,a.getDb)();return await t.createUsageLog(e)}async function f(e){let t=(0,a.getDb)();return await t.listUsageLogs(e)}async function y(e,t,r){let n=(0,a.getDb)();return await n.getUsageStats(e,t,r)}[a]=n.then?(await n)():n,e.s(["createEndpoint",()=>i,"createPayment",()=>u,"createUsageLog",()=>g,"deleteEndpoint",()=>c,"getEndpoint",()=>s,"getPayment",()=>d,"getPaymentByTxHash",()=>p,"getPaymentsForEndpoint",()=>h,"getUsageStats",()=>y,"listEndpoints",()=>o,"listPayments",()=>m,"listUsageLogs",()=>f,"updateEndpoint",()=>l]),r()}catch(e){r(e)}},!1),19585,e=>e.a(async(t,r)=>{try{var a=e.i(64001),n=e.i(50377),i=t([a]);[a]=i.then?(await i)():i;let l=(0,n.createLogger)({component:"X402CallLog"});async function s(e,t){try{let r=await (0,a.listUsageLogs)({endpointId:e});r.sort((e,t)=>new Date(t.timestamp).getTime()-new Date(e.timestamp).getTime());let n=r;t?.startDate&&(n=n.filter(e=>e.timestamp>=t.startDate)),t?.endDate&&(n=n.filter(e=>e.timestamp<=t.endDate)),t?.limit&&(n=n.slice(0,t.limit));let i=process.env.X402_VERIFY_MODE?.toLowerCase();return n.map(e=>{let t,r;return"cdp"===i?t="CDP":"test"===i&&(t="TEST_FACILITATOR"),!t&&e.x402TxHash&&(e.x402TxHash.startsWith("TEST_")?t="TEST_FACILITATOR":e.x402TxHash.startsWith("0x")&&(t="CDP")),function(e,t){let r=200!==e.statusCode||e.failureCode?"failed":"success",a=e.path.startsWith("/")?e.path:`/${e.path.replace(/^\d+\//,"")}`,n=t?.resource||`https://nexflowapp.app${a}`,i=t?.facilitator;if(!i){let e=process.env.X402_VERIFY_MODE?.toLowerCase();i="cdp"===e?"CDP":"test"===e?"TEST_FACILITATOR":"UNKNOWN"}return{id:e.id,timestamp:e.timestamp,customerId:e.conversationId||null,endpointId:e.endpointId,agentId:e.agentId||null,facilitator:i,chainId:t?.chainId||"eip155:8453",asset:t?.asset||"USDC_TEST",amount:t?.amount||"10000",status:r,errorCode:e.failureCode,x402TxHash:e.x402TxHash,latencyMs:e.responseTime,resource:n}}(e,{facilitator:t,chainId:"eip155:8453",asset:"USDC_TEST",amount:"10000",resource:(r=e.path.startsWith("/")?e.path:`/${e.path.replace(/^\d+\//,"")}`,`https://nexflowapp.app${r}`)})})}catch(t){throw l.error("Error querying x402 call logs",{error:t,endpointId:e}),t}}async function o(e){let t=new Date().toISOString();l.info("x402 call",{endpointId:e.endpointId,facilitator:e.facilitator,chainId:e.chainId,asset:e.asset,amount:e.amount,status:e.status,errorCode:e.errorCode,x402TxHash:e.x402TxHash,latencyMs:e.latencyMs,resource:e.resource,customerId:e.customerId,agentId:e.agentId});try{let t={endpointId:e.endpointId,method:"POST",path:new URL(e.resource).pathname,statusCode:"success"===e.status?200:"PAYMENT_REQUIRED"===e.errorCode?402:400,responseTime:e.latencyMs,units:1,conversationId:e.customerId||void 0,agentId:e.agentId||void 0,x402TxHash:e.x402TxHash||void 0,failureCode:"failed"===e.status?e.errorCode||"UNKNOWN_ERROR":void 0};console.log("X402_LOG_DEBUG",JSON.stringify(t,null,2));let r=await (0,a.createUsageLog)(t);return{id:r.id,timestamp:r.timestamp,customerId:e.customerId,endpointId:e.endpointId,agentId:e.agentId,facilitator:e.facilitator,chainId:e.chainId,asset:e.asset,amount:e.amount,status:e.status,errorCode:e.errorCode,x402TxHash:e.x402TxHash,latencyMs:e.latencyMs,resource:e.resource}}catch(n){let r=n instanceof Error?n.message:String(n),a=n instanceof Error?{message:n.message,stack:n.stack,name:n.name}:{error:n};return console.error("X402_LOG_DB_ERROR",{error:r,errorDetails:a,x402Log:{endpointId:e.endpointId,status:e.status,facilitator:e.facilitator}}),l.error("Failed to persist x402 call log",{error:r,errorDetails:a,x402Log:{endpointId:e.endpointId,status:e.status,facilitator:e.facilitator}}),{id:`temp-${Date.now()}`,timestamp:t,...e}}}e.s(["getX402CallLogs",()=>s,"logX402Call",()=>o]),r()}catch(e){r(e)}},!1),37411,e=>e.a(async(t,r)=>{try{var a=e.i(50848),n=t([a]);function i(e){return{name:e.name,value:parseFloat(e.value),timestamp:parseInt(e.timestamp),tags:"string"==typeof e.tags?JSON.parse(e.tags):e.tags}}async function s(t){let r=t.id||`m_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,n=e.r(24924).getDb(),i="pool"in n||"function"==typeof n.pool?.query?`INSERT INTO metrics (id, name, value, timestamp, tags, created_at)
       VALUES ($1, $2, $3, $4, $5, $6)`:`INSERT INTO metrics (id, name, value, timestamp, tags, created_at)
       VALUES (?, ?, ?, ?, ?, ?)`,s=[r,t.name,t.value.toString(),t.timestamp.toString(),JSON.stringify(t.tags||{}),new Date().toISOString()];await (0,a.executeUpdate)(i,s)}async function o(e){for(let t of e)await s(t)}async function l(t,r,n,s){let o=e.r(24924).getDb(),l="pool"in o||"function"==typeof o.pool?.query,c="SELECT * FROM metrics WHERE name = ",u=[],d=1;return l?c+=`$${d++}`:c+="?",u.push(t),void 0!==r&&(l?c+=` AND timestamp >= $${d++}`:c+=" AND timestamp >= ?",u.push(r.toString())),void 0!==n&&(l?c+=` AND timestamp <= $${d++}`:c+=" AND timestamp <= ?",u.push(n.toString())),s&&Object.keys(s).length>0&&(c+=" AND tags IS NOT NULL"),c+=" ORDER BY timestamp DESC LIMIT 10000",(await (0,a.executeQuery)(c,u)).map(i)}async function c(e,t,r,a){let n=await l(e,t,r,a);if(0===n.length)return null;let i=n;if(a&&(i=n.filter(e=>!!e.tags&&Object.entries(a).every(([t,r])=>e.tags[t]===r))),0===i.length)return null;let s=i.map(e=>e.value).sort((e,t)=>e-t),o=s.length,c=s.reduce((e,t)=>e+t,0),u=s[0],d=s[s.length-1],p=c/o,m=Math.floor(.5*o),h=Math.floor(.95*o),g=Math.floor(.99*o);return{name:e,count:o,sum:c,min:u,max:d,average:p,p50:s[m]||p,p95:s[h]||d,p99:s[g]||d,tags:a||i[0]?.tags}}[a]=n.then?(await n)():n,e.s(["getAggregatedMetrics",()=>c,"getMetrics",()=>l,"recordMetric",()=>s,"recordMetrics",()=>o]),r()}catch(e){r(e)}},!1),19561,e=>e.a(async(t,r)=>{try{var a=e.i(50377),n=e.i(37411),i=t([n]);[n]=i.then?(await i)():i;let d=(0,a.createLogger)({component:"MetricsCollector"});async function s(e){try{await n.recordMetric(e)}catch(t){d.error("Failed to record metric",{metric:e,error:t})}}async function o(e,t,r,a){return n.getAggregatedMetrics(e,t,r,a)}async function l(e,t,r,a,n){await s({name:"http.request",value:a,timestamp:Date.now(),tags:{endpoint:e,method:t,statusCode:r.toString(),...n}}),await s({name:"http.request.count",value:1,timestamp:Date.now(),tags:{endpoint:e,method:t,statusCode:r.toString(),...n}})}async function c(e,t,r,a,n){await s({name:"payment.verification",value:n,timestamp:Date.now(),tags:{endpointId:e,facilitator:t,success:a.toString()}}),a&&await s({name:"payment.amount",value:parseFloat(r)/1e6,timestamp:Date.now(),tags:{endpointId:e,facilitator:t}})}async function u(e,t,r){await s({name:"error.count",value:1,timestamp:Date.now(),tags:{errorCode:e,endpoint:t||"unknown",...r}})}e.s(["getAggregatedMetrics",()=>o,"recordErrorMetric",()=>u,"recordPaymentMetric",()=>c,"recordRequestMetric",()=>l]),r()}catch(e){r(e)}},!1),81784,e=>{"use strict";function t(e){try{let t,[r,a]=e.split(":");if(!r||!a||"eip155"===r&&(t=parseInt(a,10),isNaN(t)))return null;return{namespace:r,reference:a,chainId:t}}catch{return null}}function r(e){try{let r=e.split("/");if(2!==r.length)return null;let a=r[0],n=r[1],i=t(a);if(!i)return null;let[s,o]=n.split(":");if(!s||!o)return null;return{network:i,assetNamespace:s,assetReference:o,address:"erc20"===s?o:void 0}}catch{return null}}function a(e){return({ethereum:"eip155:1",mainnet:"eip155:1",base:"eip155:8453","base-mainnet":"eip155:8453",bnb:"eip155:56","bnb-chain":"eip155:56",bsc:"eip155:56",polygon:"eip155:137","polygon-mainnet":"eip155:137",arbitrum:"eip155:42161","arbitrum-one":"eip155:42161",optimism:"eip155:10","optimism-mainnet":"eip155:10",avalanche:"eip155:43114","avalanche-mainnet":"eip155:43114",solana:"solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp","solana-mainnet":"solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp",cronos:"eip155:25","cronos-mainnet":"eip155:25","cronos-testnet":"eip155:338"})[e.toLowerCase().replace(/_/g,"-")]||null}function n(e){return null!==t(e)}function i(e){return null!==r(e)}function s(e,t){let r=a(e);return r?`${r}/erc20:${t}`:null}e.s(["CAIP_ASSETS",0,{USDC_ETHEREUM:"eip155:1/erc20:0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48",USDC_BASE:"eip155:8453/erc20:0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913",USDC_POLYGON:"eip155:137/erc20:0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174",USDC_ARBITRUM:"eip155:42161/erc20:0xaf88d065e77c8cC2239327C5EDb3A432268e5831",USDC_OPTIMISM:"eip155:10/erc20:0x0b2C639c533813f4Aa9D7837CAf62653d097Ff85",ETH_ETHEREUM:"eip155:1/slip44:60"},"CAIP_NETWORKS",0,{ETHEREUM:"eip155:1",BASE:"eip155:8453",BNB_CHAIN:"eip155:56",POLYGON:"eip155:137",ARBITRUM:"eip155:42161",OPTIMISM:"eip155:10",AVALANCHE:"eip155:43114",SOLANA:"solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp",CRONOS:"eip155:25",CRONOS_TESTNET:"eip155:338"},"networkToCAIP",()=>a,"parseCAIPAsset",()=>r,"parseCAIPNetwork",()=>t,"tokenToCAIP",()=>s,"validateCAIPAsset",()=>i,"validateCAIPNetwork",()=>n])},98696,e=>{"use strict";var t=e.i(81784);class r{networks=new Map;constructor(){this.registerDefaultNetworks()}register(e){this.networks.set(e.caip,e)}get(e){return this.networks.get(e)}getByLegacyName(e){for(let t of this.networks.values())if(t.name.toLowerCase()===e.toLowerCase())return t}getAll(){return Array.from(this.networks.values())}getEVMs(){return Array.from(this.networks.values()).filter(e=>e.isEVM)}getSolanas(){return Array.from(this.networks.values()).filter(e=>e.isSolana)}has(e){return this.networks.has(e)}registerDefaultNetworks(){this.register({caip:t.CAIP_NETWORKS.ETHEREUM,name:"ethereum",displayName:"Ethereum",chainId:1,nativeCurrency:{name:"Ether",symbol:"ETH",decimals:18},rpcUrls:["https://eth.llamarpc.com"],blockExplorers:[{name:"Etherscan",url:"https://etherscan.io"}],isTestnet:!1,isEVM:!0,isSolana:!1,supportsEIP1559:!0,averageGasPrice:"30000000000",averageBlockTime:12}),this.register({caip:t.CAIP_NETWORKS.BASE,name:"base",displayName:"Base",chainId:8453,nativeCurrency:{name:"Ether",symbol:"ETH",decimals:18},rpcUrls:["https://mainnet.base.org"],blockExplorers:[{name:"BaseScan",url:"https://basescan.org"}],isTestnet:!1,isEVM:!0,isSolana:!1,supportsEIP1559:!0,averageGasPrice:"1000000",averageBlockTime:2}),this.register({caip:t.CAIP_NETWORKS.BNB_CHAIN,name:"bnb",displayName:"BNB Chain",chainId:56,nativeCurrency:{name:"BNB",symbol:"BNB",decimals:18},rpcUrls:["https://bsc-dataseed.binance.org"],blockExplorers:[{name:"BscScan",url:"https://bscscan.com"}],isTestnet:!1,isEVM:!0,isSolana:!1,supportsEIP1559:!1,averageGasPrice:"3000000000",averageBlockTime:3}),this.register({caip:t.CAIP_NETWORKS.POLYGON,name:"polygon",displayName:"Polygon",chainId:137,nativeCurrency:{name:"MATIC",symbol:"MATIC",decimals:18},rpcUrls:["https://polygon-rpc.com"],blockExplorers:[{name:"PolygonScan",url:"https://polygonscan.com"}],isTestnet:!1,isEVM:!0,isSolana:!1,supportsEIP1559:!0,averageGasPrice:"30000000000",averageBlockTime:2}),this.register({caip:t.CAIP_NETWORKS.ARBITRUM,name:"arbitrum",displayName:"Arbitrum One",chainId:42161,nativeCurrency:{name:"Ether",symbol:"ETH",decimals:18},rpcUrls:["https://arb1.arbitrum.io/rpc"],blockExplorers:[{name:"Arbiscan",url:"https://arbiscan.io"}],isTestnet:!1,isEVM:!0,isSolana:!1,supportsEIP1559:!0,averageGasPrice:"100000000",averageBlockTime:.25}),this.register({caip:t.CAIP_NETWORKS.OPTIMISM,name:"optimism",displayName:"Optimism",chainId:10,nativeCurrency:{name:"Ether",symbol:"ETH",decimals:18},rpcUrls:["https://mainnet.optimism.io"],blockExplorers:[{name:"Optimistic Etherscan",url:"https://optimistic.etherscan.io"}],isTestnet:!1,isEVM:!0,isSolana:!1,supportsEIP1559:!0,averageGasPrice:"1000000",averageBlockTime:2}),this.register({caip:t.CAIP_NETWORKS.AVALANCHE,name:"avalanche",displayName:"Avalanche",chainId:43114,nativeCurrency:{name:"AVAX",symbol:"AVAX",decimals:18},rpcUrls:["https://api.avax.network/ext/bc/C/rpc"],blockExplorers:[{name:"Snowtrace",url:"https://snowtrace.io"}],isTestnet:!1,isEVM:!0,isSolana:!1,supportsEIP1559:!0,averageGasPrice:"25000000000",averageBlockTime:2}),this.register({caip:t.CAIP_NETWORKS.SOLANA,name:"solana",displayName:"Solana",chainId:null,nativeCurrency:{name:"SOL",symbol:"SOL",decimals:9},rpcUrls:["https://api.mainnet-beta.solana.com"],blockExplorers:[{name:"Solana Explorer",url:"https://explorer.solana.com"}],isTestnet:!1,isEVM:!1,isSolana:!0,averageBlockTime:.4}),this.register({caip:t.CAIP_NETWORKS.CRONOS,name:"cronos",displayName:"Cronos",chainId:25,nativeCurrency:{name:"CRO",symbol:"CRO",decimals:18},rpcUrls:["https://evm.cronos.org"],blockExplorers:[{name:"Cronoscan",url:"https://cronoscan.com"}],isTestnet:!1,isEVM:!0,isSolana:!1,supportsEIP1559:!0,averageGasPrice:"5000000000000",averageBlockTime:6}),this.register({caip:t.CAIP_NETWORKS.CRONOS_TESTNET,name:"cronos-testnet",displayName:"Cronos Testnet",chainId:338,nativeCurrency:{name:"Test CRO",symbol:"TCRO",decimals:18},rpcUrls:["https://evm-t3.cronos.org"],blockExplorers:[{name:"Cronos Testnet Explorer",url:"https://testnet.cronoscan.com"}],isTestnet:!0,isEVM:!0,isSolana:!1,supportsEIP1559:!0,averageGasPrice:"5000000000000",averageBlockTime:6})}}let a=null;function n(){return a||(a=new r),a}e.s(["ChainRegistry",()=>r,"getChainRegistry",()=>n])},83101,e=>{"use strict";function t(e,t){let r=e.network||e.networks?.[0]||"",a=e.networks?.[0]?.startsWith("eip155:")?e.networks[0]:void 0,n=e.asset||e.assets?.[0]||"",i=e.assets?.[0]?.includes("/")?e.assets[0]:void 0;return{network:r,token:n,amount:e.maxAmountRequired||"0",networkCAIP:a,tokenCAIP:i,x402Version:t?.x402Version||1,callerId:t?.callerId,clientId:t?.clientId,region:t?.region,riskLevel:t?.riskLevel,watchLevel:t?.watchLevel,requirements:e}}e.s(["createRouteContext",()=>t])},84170,e=>e.a(async(t,r)=>{try{var a=e.i(57729),n=e.i(50377),i=e.i(60827),s=e.i(83101),o=t([a,i]);[a,i]=o.then?(await o)():o;let c=(0,n.createLogger)({component:"MetaFacilitator"});class u{router=(0,a.getFacilitatorRouter)();async verifyPayment(e,t,r,a,n){let o=Date.now(),l=null;try{let u,d=(0,s.createRouteContext)(t,{callerId:n?.clientId||n?.agentId,clientId:n?.clientId,x402Version:1}),p=await this.router.routePayment(t,r,a);l=(await (0,i.createRoute)({request_id:n?.requestId||null,correlation_id:n?.correlationId||null,client_id:n?.clientId||null,agent_id:n?.agentId||null,network:d.network,token:d.token,amount:d.amount,selected_facilitator_id:p.id,status:"verifying"})).id,c.info({routeId:l,facilitatorId:p.id,network:t.network,asset:t.asset,settlementMode:t.settlementMode,preferences:r?{priority:r.priority,jurisdiction:r.jurisdiction}:void 0},"Routing payment to facilitator");let m=Date.now(),h="success",g=null,f=null;try{u=await p.verify(e,t);let r=Date.now()-m;u.success&&u.valid||(h="failure",g=u.error||"verification_failed"),await (0,i.createRouteAttempt)({route_id:l,facilitator_id:p.id,phase:"verify",result:h,latency_ms:r,error_code:g,raw_status:f,is_probe:!1})}catch(r){let e=Date.now()-m,t=r instanceof Error?r.message:"Unknown error";t.includes("timeout")||t.includes("TIMEOUT")?h="timeout":t.includes("rate")||t.includes("429")?(h="rate_limited",f=429):h=t.includes("network")||t.includes("ECONNREFUSED")?"network_error":"failure",g=t,await (0,i.createRouteAttempt)({route_id:l,facilitator_id:p.id,phase:"verify",result:h,latency_ms:e,error_code:g,raw_status:f,is_probe:!1}),u={success:!1,valid:!1,error:t,facilitatorId:p.id,verifiedAt:new Date().toISOString()}}let y=this.applyBusinessLogic(u,t,a);y.success&&y.valid?await (0,i.updateRouteStatus)(l,"settled",new Date().toISOString()):await (0,i.updateRouteStatus)(l,"failed",new Date().toISOString());let w={latency:Date.now()-o,complianceScore:this.calculateComplianceScore(u)},v=this.router.getFacilitators().filter(e=>e.supports(t.network,t.asset,t.scheme,t.settlementMode)&&e.config.enabled),_=await this.buildDecisionTrace(p,v,t,r,a);return{...y,facilitatorUsed:p.id,routingReason:this.getRoutingReason(p,r,a),alternativesConsidered:v.length-1,decisionTrace:_,orchestrationMetadata:w}}catch(n){if(c.error({error:n,requirements:t,routeId:l},"Orchestration error"),l&&await (0,i.updateRouteStatus)(l,"failed",new Date().toISOString()),a?.requireHealthCheck!==!1)return await this.handleFailover(e,t,r,a,n,l);throw n}}applyBusinessLogic(e,t,r){if(r?.riskThreshold!==void 0){let t=this.calculateRiskScore(e);if(t>r.riskThreshold)return{...e,valid:!1,error:`Risk score ${t} exceeds threshold ${r.riskThreshold}`}}if(r?.requireKYC){let r=BigInt(t.maxAmountRequired),a=BigInt("1000000000");if(r>a&&"passed"!==e.kytStatus)return{...e,valid:!1,error:"KYC required for this amount"}}return r?.jurisdictionRules,e}calculateRiskScore(e){let t=0;return"blocked"===e.kytStatus?t+=50:"flagged"===e.kytStatus&&(t+=25),"blocked"===e.ofacStatus?t+=50:"flagged"===e.ofacStatus&&(t+=25),e.success&&e.valid||(t+=30),Math.min(100,t)}calculateComplianceScore(e){let t=100;return"blocked"===e.kytStatus?t-=50:"flagged"===e.kytStatus&&(t-=25),"blocked"===e.ofacStatus?t-=50:"flagged"===e.ofacStatus&&(t-=25),Math.max(0,t)}async buildDecisionTrace(e,t,r,n,i){let s=(0,a.getFacilitatorRouter)(),o=await s.scoreFacilitators(t,r,n,i),l=t.map(e=>{let t=o.find(t=>t.facilitator.id===e.id),r=t?.score||0,a=t?.reasons||[];return{facilitatorId:e.id,facilitatorName:e.name,score:r,eligible:!0,reasons:a}});return{timestamp:new Date().toISOString(),reason:this.getRoutingReason(e,n,i),constraints:{preferences:n,policy:i?{requireHealthCheck:i.requireHealthCheck,preferCheapest:i.preferCheapest,requireKYC:i.requireKYC}:void 0,requirements:r},candidates:l,selected:{facilitatorId:e.id,score:o.find(t=>t.facilitator.id===e.id)?.score||100,alternativesConsidered:t.length-1}}}getRoutingReason(e,t,r){let a=[];return t?.priority==="cost"&&a.push("cost-optimized"),t?.priority==="speed"&&a.push("speed-optimized"),t?.priority==="compliance"&&a.push("compliance-optimized"),t?.priority==="reliability"&&a.push("reliability-optimized"),t?.preferredNetworks&&a.push("network-preference"),r?.preferCheapest&&a.push("cheapest-selected"),1===e.config.priority&&a.push("primary-facilitator"),a.join(", ")||"default-routing"}async handleFailover(e,t,r,a,n,s){c.warn({originalError:n,requirements:t},"Attempting failover");let o=this.router.getFacilitators().filter(e=>e.supports(t.network,t.asset,t.scheme,t.settlementMode)&&e.config.enabled);for(let r of o.sort((e,t)=>e.config.priority-t.config.priority)){let a=Date.now();try{let n=await r.verify(e,t),l=Date.now()-a;if(s&&await (0,i.createRouteAttempt)({route_id:s,facilitator_id:r.id,phase:"verify",result:n.success&&n.valid?"success":"failure",latency_ms:l,is_probe:!1,error_code:n.error||null,raw_status:null}),n.success&&n.valid)return c.info({facilitatorId:r.id,routeId:s},"Failover successful"),s&&await (0,i.updateRouteStatus)(s,"settled",new Date().toISOString()),{...n,facilitatorUsed:r.id,routingReason:"failover",alternativesConsidered:o.length-1}}catch(n){let e=Date.now()-a,t=n instanceof Error?n.message:"Unknown error";if(s){let a="failure";t.includes("timeout")?a="timeout":t.includes("rate")||t.includes("429")?a="rate_limited":(t.includes("network")||t.includes("ECONNREFUSED"))&&(a="network_error"),await (0,i.createRouteAttempt)({route_id:s,facilitator_id:r.id,phase:"verify",result:a,latency_ms:e,is_probe:!1,error_code:t,raw_status:null})}c.warn({facilitatorId:r.id,error:n,routeId:s},"Failover attempt failed");continue}}throw Error(`All facilitators failed. Original error: ${n instanceof Error?n.message:"Unknown error"}`)}async getStatus(){let e=this.router.getFacilitators(),t=await Promise.all(e.map(async e=>{try{let t=await e.getHealth();return{id:e.id,name:e.name,healthy:t.healthy,lastChecked:t.lastChecked}}catch(t){return{id:e.id,name:e.name,healthy:!1,lastChecked:new Date().toISOString()}}})),r=t.filter(e=>e.healthy),a=new Set,n=new Set;return e.forEach(e=>{e.config.networks.forEach(e=>a.add(e)),e.config.assets.forEach(e=>n.add(e))}),{facilitators:e.length,healthy:r.length,networks:Array.from(a),assets:Array.from(n),facilitatorDetails:t}}}let d=null;function l(){return d||(d=new u),d}e.s(["MetaFacilitator",()=>u,"getMetaFacilitator",()=>l]),r()}catch(e){r(e)}},!1),91086,e=>{"use strict";let t=(0,e.i(50377).createLogger)({component:"TestX402Verification"}),r="x-easepay-test-token",a="demo-ok";function n(e){let n=e.headers.get(r)||e.headers.get(r.toUpperCase()),i="true"===process.env.X402_TEST_MODE||"true"===process.env.EASEPAY_TEST_MODE;return n===a||i?(t.info("Test payment verification passed",{testToken:n===a?"present":"missing",testModeEnabled:i}),{success:!0,x402TxHash:"TEST_TX_HASH",facilitator:"TEST_FACILITATOR"}):(t.info("Test payment verification failed - no test token",{testToken:n||"missing",testModeEnabled:i}),{success:!1,errorCode:"PAYMENT_REQUIRED"})}e.s(["TEST_TOKEN_HEADER",0,r,"TEST_TOKEN_VALUE",0,a,"verifyPaymentTestOnly",()=>n])},31081,e=>{"use strict";let t=(0,e.i(50377).createLogger)({component:"InputValidator"});function r(e){let t=[];if(!e||"string"!=typeof e)return t.push("Endpoint ID must be a string"),{valid:!1,errors:t};/^ep_[a-z0-9_]+$/i.test(e)||t.push("Invalid endpoint ID format"),e.length>100&&t.push("Endpoint ID too long");let r=e.replace(/[^a-z0-9_-]/gi,"");return{valid:0===t.length,errors:t,sanitized:0===t.length?r:void 0}}function a(e){let r=[];if(!e||"string"!=typeof e)return r.push("Payment header must be a string"),{valid:!1,errors:r};if(e.length>1e4)return r.push("Payment header too long"),{valid:!1,errors:r};if(e.length<10)return r.push("Payment header too short"),{valid:!1,errors:r};if(e.includes("<script")||e.includes("javascript:"))return r.push("Suspicious content in payment header"),{valid:!1,errors:r};let a=/^x402\s+/i.test(e),n=a?e.replace(/^x402\s+/i,"").trim():e.trim();if(n.length>0&&!/^[A-Za-z0-9+/=_-]+$/.test(n)){let i=n.split("").filter(e=>!/[A-Za-z0-9+/=_-]/.test(e));return t.warn("Invalid characters in payment header base64",{invalidChars:[...new Set(i)].slice(0,10),headerLength:e.length,hasX402Prefix:a}),r.push("Invalid base64 format in payment header"),{valid:!1,errors:r}}try{if(n.length>0){let e=Buffer.from(n,"base64").toString("utf-8");JSON.parse(e)}}catch(e){t.debug("Payment header base64 decode check failed (non-blocking)",{error:e instanceof Error?e.message:"Unknown"})}return{valid:0===r.length,errors:r,sanitized:e}}e.s(["validateEndpointId",()=>r,"validatePaymentHeader",()=>a])},34597,e=>{"use strict";let t,r,a,n;var i=e.i(56036);let s=(0,e.i(50377).createLogger)({component:"X402ResourceServer"});async function o(){if(!t)try{let i=await e.A(83788),s=await e.A(76810),o=await e.A(76900),l=await e.A(80831);t=i.x402ResourceServer,r=s.HTTPFacilitatorClient,a=o.bazaarResourceServerExtension,n=l.registerExactEvmScheme}catch(e){throw s.warn({error:e},"x402 packages not available - discovery features will be limited"),Error("x402 packages not installed")}return{x402ResourceServer:t,HTTPFacilitatorClient:r,bazaarResourceServerExtension:a,registerExactEvmScheme:n}}class l{cdpFacilitator;baseClient;constructor(){this.cdpFacilitator=(0,i.getCDPFacilitator)()}async initialize(e){this.baseClient=new e({url:process.env.CDP_FACILITATOR_URL||"https://api.cdp.coinbase.com/platform/v2/x402"}),Object.setPrototypeOf(this,this.baseClient.constructor.prototype)}async verify(e,t,r){try{let a=await this.cdpFacilitator.verifyPaymentWithRetry({payment:e,paymentPayload:t,paymentRequirements:r});if(a.success&&a.valid)return{isValid:!0,transactionHash:a.transactionHash,kytStatus:a.kytStatus,ofacStatus:a.ofacStatus};return{isValid:!1,invalidReason:a.error,errorMessage:a.error}}catch(e){return s.error({error:e},"CDP facilitator verification error"),{isValid:!1,invalidReason:e instanceof Error?e.message:"Verification failed"}}}}let c=null;async function u(){try{let{x402ResourceServer:t,HTTPFacilitatorClient:r,bazaarResourceServerExtension:a,registerExactEvmScheme:n}=await o();if(!c){let i=new l;await i.initialize(r),c=new t(i),n(c),c.registerExtension(a),e.A(33218).then(({getChainRegistry:e})=>{let t=e().getEVMs();s.info({supportedNetworks:t.map(e=>({caip:e.caip,name:e.name,chainId:e.chainId}))},"x402 Resource Server initialized with Bazaar extension and multi-chain support")}).catch(()=>{s.info("x402 Resource Server initialized with Bazaar extension")})}return c}catch(e){return s.warn({error:e},"x402 resource server not available - discovery endpoint may not function"),null}}e.s(["getX402ResourceServer",()=>u])},20525,e=>{"use strict";async function t(){try{let{declareDiscoveryExtension:t}=await e.A(76900);return t}catch(e){return e=>({...e,_stub:!0})}}async function r(e){let r={data:{},timestamp:new Date().toISOString()};return e.description?.toLowerCase().includes("revenue")?r.data={revenue:.01,currency:"USDC",period:"daily"}:e.description?.toLowerCase().includes("health")&&(r.data={status:"healthy",uptime:99.9}),(await t())({inputSchema:{type:"object",properties:{},additionalProperties:!0},bodyType:"json",output:{example:r,schema:{type:"object",properties:{data:{type:"object",description:"Response data from upstream service"},timestamp:{type:"string",format:"date-time",description:"Response timestamp"}}}}})}function a(e){let t=`https://nexflowapp.app/api/v1/metered/${e.id}`;return{url:t,type:"http",method:"POST",x402Version:1,accepts:[{scheme:"exact",network:e.network,maxAmountRequired:e.price,asset:e.tokenAddress,payTo:e.recipientAddress,resource:t,description:e.description||e.name||"Metered API endpoint",mimeType:"application/json",maxTimeoutSeconds:300}],metadata:{name:e.name,description:e.description,category:"api",provider:"NexFlow"},lastUpdated:new Date(e.updatedAt).getTime()/1e3}}e.s(["createDiscoveryMetadata",()=>r,"getEndpointDiscoveryInfo",()=>a])},193,e=>e.a(async(t,r)=>{try{var a=e.i(50848),n=t([a]);async function i(t){let r=`wd_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,{getDb:n}=await e.A(36784),i=n(),s="pool"in i||"function"==typeof i.pool?.query?`INSERT INTO webhook_deliveries (id, webhook_config_id, event_id, event_type, url, payload, signature, status, attempts, max_attempts, created_at)
       VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11)`:`INSERT INTO webhook_deliveries (id, webhook_config_id, event_id, event_type, url, payload, signature, status, attempts, max_attempts, created_at)
       VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,o=[r,t.webhookConfigId,t.eventId,t.eventType,t.url,t.payload,t.signature,"pending",0,t.maxAttempts||3,new Date().toISOString()];return await (0,a.executeUpdate)(s,o),r}async function s(t,r,n){let{getDb:i}=await e.A(36784),s=i(),o="pool"in s||"function"==typeof s.pool?.query,l=n.nextRetryAt?"pending":"failed",c=o?`UPDATE webhook_deliveries 
       SET status = $1, attempts = $2, last_response_code = $3, last_response_body = $4, 
           error_message = $5, next_retry_at = $6, last_attempt_at = $7
       WHERE webhook_config_id = $8 AND event_id = $9`:`UPDATE webhook_deliveries 
       SET status = ?, attempts = ?, last_response_code = ?, last_response_body = ?, 
           error_message = ?, next_retry_at = ?, last_attempt_at = ?
       WHERE webhook_config_id = ? AND event_id = ?`;await (0,a.executeUpdate)(c,[l,n.attempt,n.statusCode||null,n.responseBody||null,n.errorMessage||null,n.nextRetryAt||null,new Date().toISOString(),t,r])}async function o(t){let{getDb:r}=await e.A(36784),n=r(),i="pool"in n||"function"==typeof n.pool?.query,s="SELECT * FROM webhook_deliveries WHERE 1=1",o=[],l=1;return t?.webhookConfigId&&(i?s+=` AND webhook_config_id = $${l++}`:s+=" AND webhook_config_id = ?",o.push(t.webhookConfigId)),t?.eventType&&(i?s+=` AND event_type = $${l++}`:s+=" AND event_type = ?",o.push(t.eventType)),t?.status&&(i?s+=` AND status = $${l++}`:s+=" AND status = ?",o.push(t.status)),s+=" ORDER BY created_at DESC",t?.limit?s+=` LIMIT ${t.limit}`:s+=" LIMIT 100",(0,a.executeQuery)(s,o)}async function l(e,t){return o({webhookConfigId:e,...t})}[a]=n.then?(await n)():n,e.s(["createDeliveryRecord",()=>i,"getDeliveryRecords",()=>l,"markDeliveryFailed",()=>s]),r()}catch(e){r(e)}},!1),21198,e=>e.a(async(t,r)=>{try{var a=e.i(54799),n=e.i(50377),i=e.i(193),s=t([i]);async function o(){try{let{enqueueWebhookDelivery:t}=await e.A(3441);return t}catch(e){return w.warn("Webhook queue not available (bullmq may not be installed)",{error:e}),null}}[i]=s.then?(await s)():s;let w=(0,n.createLogger)({component:"WebhookDelivery"}),v={maxAttempts:parseInt(process.env.WEBHOOK_MAX_ATTEMPTS||"5",10),baseDelay:parseInt(process.env.WEBHOOK_BASE_DELAY_MS||"1000",10),maxDelay:parseInt(process.env.WEBHOOK_MAX_DELAY_MS||"300000",10),requestTimeout:parseInt(process.env.WEBHOOK_TIMEOUT_MS||"10000",10),enableDLQ:"false"!==process.env.WEBHOOK_ENABLE_DLQ,jitterFactor:parseFloat(process.env.WEBHOOK_JITTER_FACTOR||"0.2")},_={delivered:0,failed:0,retried:0,dlqCount:0,byEndpoint:new Map,lastReset:Date.now()};function l(e,t,r=!1){Date.now()-_.lastReset>36e5&&(_.delivered=0,_.failed=0,_.retried=0,_.byEndpoint.clear(),_.lastReset=Date.now()),t?_.delivered++:_.failed++,r&&_.retried++;try{let r=new URL(e).hostname,a=_.byEndpoint.get(r)||{delivered:0,failed:0};t?a.delivered++:a.failed++,_.byEndpoint.set(r,a)}catch{}}function c(){let e=_.delivered+_.failed,t={};return _.byEndpoint.forEach((e,r)=>{let a=e.delivered+e.failed;t[r]={...e,successRate:a>0?(e.delivered/a*100).toFixed(2)+"%":"0%"}}),{delivered:_.delivered,failed:_.failed,retried:_.retried,dlqCount:_.dlqCount,successRate:e>0?(_.delivered/e*100).toFixed(2)+"%":"0%",byEndpoint:t,lastReset:new Date(_.lastReset).toISOString()}}function u(e,t){return a.default.createHmac("sha256",t).update(e).digest("hex")}async function d(e,t,r=1){let a=JSON.stringify(t),n=u(a,e.secret),i=r>1,s=Date.now();try{let c=await fetch(e.url,{method:"POST",headers:{"Content-Type":"application/json","X-Webhook-Signature":n,"X-Webhook-Event":t.event,"X-Webhook-Timestamp":t.timestamp,"X-Webhook-Delivery-Id":t.id,"X-Webhook-Attempt":r.toString(),"User-Agent":"NexFlow-Webhooks/1.0"},body:a,signal:AbortSignal.timeout(v.requestTimeout)}),u=await c.text().catch(()=>""),d=Date.now()-s;if(c.ok)return l(e.url,!0,i),w.info({webhookConfigId:e.id,eventId:t.id,eventType:t.event,statusCode:c.status,latencyMs:d,attempt:r},"Webhook delivered successfully"),{success:!0,statusCode:c.status};{var o;let a=!!((o=c.status)>=500)&&!!(o<600)||408===o||429===o,n=a?p(r-1):void 0;return l(e.url,!1,i),w.warn({webhookConfigId:e.id,eventId:t.id,eventType:t.event,statusCode:c.status,responseBody:u.substring(0,200),latencyMs:d,attempt:r,retryable:a,retryDelay:n},"Webhook delivery failed"),{success:!1,statusCode:c.status,error:`HTTP ${c.status}: ${u.substring(0,100)}`,retryable:a,retryDelay:n}}}catch(d){let a,n=d instanceof Error?d.message:"Unknown error",o=d instanceof Error&&((a=d.message.toLowerCase()).includes("timeout")||a.includes("econnrefused")||a.includes("econnreset")||a.includes("enotfound")||a.includes("socket hang up")||a.includes("network")),c=o?p(r-1):void 0,u=Date.now()-s;return l(e.url,!1,i),w.error({webhookConfigId:e.id,eventId:t.id,eventType:t.event,error:n,latencyMs:u,attempt:r,retryable:o,retryDelay:c},"Webhook delivery error"),{success:!1,error:n,retryable:o,retryDelay:c}}}function p(e){let{baseDelay:t,maxDelay:r,jitterFactor:a}=v,n=t*Math.pow(2,e),i=Math.min(n,r),s=1+(Math.random()*a*2-a);return Math.round(i*s)}async function m(e,t){try{let r=JSON.stringify(t),a=u(r,e.secret);await i.createDeliveryRecord({webhookConfigId:e.id,eventId:t.id,eventType:t.event,url:e.url,payload:r,signature:a,maxAttempts:v.maxAttempts});let n=await o();n?(await n({webhookConfigId:e.id,eventId:t.id,eventType:t.event,url:e.url,payload:r,signature:a}),w.info({webhookConfigId:e.id,eventId:t.id,eventType:t.event,url:e.url,maxAttempts:v.maxAttempts},"Webhook queued for delivery")):(w.warn({webhookConfigId:e.id,eventId:t.id},"Webhook queue not available, delivering with inline retry"),await h(e,t))}catch(r){throw w.error({webhookConfigId:e.id,eventId:t.id,error:r},"Failed to queue webhook delivery"),r}}async function h(e,t){let r=1;for(;r<=v.maxAttempts;){let a=await d(e,t,r);if(a.success)return;if(!a.retryable||r>=v.maxAttempts){v.enableDLQ&&await g(e,t,a.error||"Unknown error",r),w.error({webhookConfigId:e.id,eventId:t.id,eventType:t.event,attempts:r,error:a.error,sentToDLQ:v.enableDLQ},"Webhook delivery failed permanently");return}let n=a.retryDelay||p(r-1);w.info({webhookConfigId:e.id,eventId:t.id,attempt:r,nextAttempt:r+1,delayMs:n},"Scheduling webhook retry"),await new Promise(e=>setTimeout(e,n)),r++}}async function g(e,t,r,a){_.dlqCount++;try{await i.markDeliveryFailed({eventId:t.id,webhookConfigId:e.id,error:r,attempts:a,sentToDLQ:!0}),w.warn({webhookConfigId:e.id,eventId:t.id,eventType:t.event,error:r,attempts:a},"Webhook sent to dead letter queue")}catch(r){w.error({webhookConfigId:e.id,eventId:t.id,dlqError:r},"Failed to send webhook to dead letter queue")}}async function f(t,r){try{let{getWebhookConfigs:a}=await e.A(97932);return(await a({endpointId:r||void 0,enabled:!0})).filter(e=>!!e.enabled&&!!e.events.includes(t)&&(!r||!e.endpointId||e.endpointId===r))}catch(e){return w.error("Failed to get webhook configs",{eventType:t,endpointId:r,error:e}),[]}}async function y(e,t,r){try{let a={id:`evt_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,event:e,timestamp:new Date().toISOString(),data:t},n=(await f(e,r)).filter(e=>e.enabled),i=r?n.filter(e=>!e.endpointId||e.endpointId===r):n.filter(e=>!e.endpointId);for(let e of i)await m(e,a);w.info("Webhooks triggered",{eventType:e,endpointId:r,configCount:i.length})}catch(t){w.error("Failed to trigger webhook",{eventType:e,endpointId:r,error:t})}}e.s(["WEBHOOK_CONFIG",0,v,"getWebhookMetrics",()=>c,"triggerWebhook",()=>y]),r()}catch(e){r(e)}},!1),2759,e=>{e.v(t=>Promise.all(["server/chunks/node_modules_@upstash_redis_nodejs_mjs_bca9da2d._.js","server/chunks/node_modules_@upstash_redis_nodejs_mjs_85cd95da._.js"].map(t=>e.l(t))).then(()=>t(58119)))},6538,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__2b5537a8._.js","server/chunks/[root-of-the-server]__bbbc7a9e._.js","server/chunks/node_modules_@ioredis_commands_built_commands_json_862661ff._.js"].map(t=>e.l(t))).then(()=>t(42512)))},76900,e=>{e.v(t=>Promise.all(["server/chunks/node_modules_688c3c10._.js"].map(t=>e.l(t))).then(()=>t(43614)))},455,e=>{e.v(t=>Promise.all(["server/chunks/node_modules_bc74a3ae._.js"].map(t=>e.l(t))).then(()=>t(1805)))},5371,e=>{e.v(t=>Promise.all(["server/chunks/src_integrations_x402_payment-header-parser_ts_db7a382b._.js"].map(t=>e.l(t))).then(()=>t(71556)))},83788,e=>{e.v(t=>Promise.all(["server/chunks/node_modules_@x402_core_dist_esm_server_index_mjs_fb9fdec2._.js","server/chunks/node_modules_@x402_core_dist_esm_chunk-XT4E3FX4_mjs_48e49267._.js"].map(t=>e.l(t))).then(()=>t(81315)))},76810,e=>{e.v(t=>Promise.all(["server/chunks/node_modules_@x402_core_dist_esm_http_index_mjs_a9c19016._.js","server/chunks/node_modules_@x402_core_dist_esm_chunk-XT4E3FX4_mjs_48e49267._.js"].map(t=>e.l(t))).then(()=>t(63027)))},80831,e=>{e.v(t=>Promise.all(["server/chunks/node_modules_@x402_evm_dist_esm_exact_server_index_mjs_58cd597c._.js"].map(t=>e.l(t))).then(()=>t(46917)))},33218,e=>{e.v(e=>Promise.resolve().then(()=>e(98696)))},36784,e=>{e.v(e=>Promise.resolve().then(()=>e(24924)))},3441,e=>{e.v(t=>Promise.all(["server/chunks/src_lib_webhook-queue_ts_cdea9e52._.js"].map(t=>e.l(t))).then(()=>t(29507)))},97932,e=>{e.v(t=>Promise.all(["server/chunks/src_bbbd1911._.js"].map(t=>e.l(t))).then(()=>t(18770)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__96519dfe._.js.map
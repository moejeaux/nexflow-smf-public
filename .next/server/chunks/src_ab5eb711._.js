module.exports=[83032,e=>{"use strict";var t=e.i(22444),r=e.i(56036);class a extends t.BaseFacilitator{id="cdp";name="Coinbase Developer Platform";config={id:"cdp",name:"Coinbase Developer Platform",enabled:!0,priority:1,networks:["base"],networksCAIP:["eip155:8453"],assets:["0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"],assetsCAIP:["eip155:8453/erc20:0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"],schemes:["exact","x402"],settlementModes:["immediate"],healthCheckUrl:process.env.CDP_FACILITATOR_URL||"https://api.cdp.coinbase.com/platform/v2/x402",metadata:{provider:"Coinbase",kytEnabled:!0,ofacEnabled:!0,complianceLevel:"enterprise"}};cdpFacilitator=(0,r.getCDPFacilitator)();async verify(t,r){let a=this.validateRequirements(r);if(!a.valid)return{success:!1,valid:!1,error:a.error,facilitatorId:this.id,verifiedAt:new Date().toISOString()};try{let a,{parseAndVerifyPaymentHeader:i}=await e.A(5371),s=await i(t);if(!s.valid||!s.payment)return{success:!1,valid:!1,error:s.error||"Failed to parse payment header",facilitatorId:this.id,verifiedAt:new Date().toISOString()};if(r.resource?.startsWith("https://probe.nexflow.dev/health/")){let e=r.resource.match(/\/health\/([^/]+)\/([^/]+)\/([^/]+)/);if(e){let t,r,[,i,s,o]=e,n={id:`${i}-${s}-${o.toLowerCase()}`,facilitatorId:i,network:s,token:o,desiredIntervalSeconds:30,enabled:!0};t=n.network,r=Math.floor(Date.now()/1e3),a={scheme:"exact",network:t,to:"0x0000000000000000000000000000000000000001",payTo:"0x0000000000000000000000000000000000000001",value:"1000000",maxAmountRequired:"1000000",resource:`https://probe.nexflow.dev/health/${n.facilitatorId}/${n.network}/${n.token}`,asset:"0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913",description:`Health probe for ${n.facilitatorId} on ${n.network}`,mimeType:"application/json",maxTimeoutSeconds:10,validAfter:r.toString(),validBefore:(r+300).toString()},this.getLogger().info({component:"CDPFacilitatorAdapter",isProbe:!0,probeConfigId:n.id,hasPaymentRequirements:!0,msg:"Using probe-specific paymentRequirements for CDP"})}else a={scheme:r.scheme,network:r.network,maxAmountRequired:r.maxAmountRequired,resource:r.resource,description:r.description||"",mimeType:r.mimeType||"application/json",payTo:r.payTo,maxTimeoutSeconds:r.maxTimeoutSeconds||300,asset:r.asset}}else a={scheme:r.scheme,network:r.network,maxAmountRequired:r.maxAmountRequired,resource:r.resource,description:r.description||"",mimeType:r.mimeType||"application/json",payTo:r.payTo,maxTimeoutSeconds:r.maxTimeoutSeconds||300,asset:r.asset};let o={payment:t,paymentPayload:{x402Version:1,scheme:"x402",network:s.payment.network||r.network,payload:{signature:s.payment.signature,authorization:s.payment.authorization}},paymentRequirements:a},n=await this.cdpFacilitator.verifyPaymentWithRetry(o);return{success:n.success,valid:n.valid,transactionHash:n.transactionHash,kytStatus:n.kytStatus,ofacStatus:n.ofacStatus,error:n.error,errorDetails:n.errorDetails,facilitatorId:this.id,verifiedAt:new Date().toISOString()}}catch(e){return this.getLogger().error({error:e,requirements:r},"CDP verification error"),{success:!1,valid:!1,error:e instanceof Error?e.message:"Verification failed",facilitatorId:this.id,verifiedAt:new Date().toISOString()}}}async getHealth(){try{let e=Date.now(),t=await this.cdpFacilitator.healthCheck(),r=Date.now()-e;return{healthy:t.healthy,latency:r,lastChecked:new Date().toISOString(),capabilities:{networks:this.config.networks,assets:this.config.assets,schemes:this.config.schemes}}}catch(e){return{healthy:!1,lastChecked:new Date().toISOString(),error:e instanceof Error?e.message:"Health check failed",capabilities:{networks:this.config.networks,assets:this.config.assets,schemes:this.config.schemes}}}}async getPricing(e,t){return"base"===e&&"0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913"===t?{network:"base",asset:"0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913",baseFee:"0",percentageFee:0,estimatedGas:"21000",currency:"USDC"}:null}}let i=null;function s(){return i||(i=new a),i}e.s(["getCDPFacilitatorAdapter",()=>s])},16334,e=>{"use strict";var t=e.i(22444);let r=(0,e.i(50377).createLogger)({component:"PayAIFacilitator"});class a extends t.BaseFacilitator{id="payai";name="PayAI Facilitator";config={id:"payai",name:"PayAI Facilitator",enabled:"false"!==process.env.PAYAI_ENABLED,priority:2,networks:["base","ethereum","solana","bnb","polygon"],networksCAIP:["eip155:1","eip155:8453","eip155:56","eip155:137","solana:5eykt4UsFv8P8NJdTREpY1vzqKqZKvdp"],assets:["0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913","0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48"],assetsCAIP:["eip155:1/erc20:0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48","eip155:8453/erc20:0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913","eip155:56/erc20:0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d","eip155:137/erc20:0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174"],schemes:["exact","x402"],settlementModes:["immediate"],healthCheckUrl:process.env.PAYAI_FACILITATOR_URL||"https://facilitator.payai.network",metadata:{provider:"PayAI",multiChain:!0,complianceLevel:"standard",website:"https://payai.network"}};baseUrl;constructor(e){super(),this.baseUrl=e||process.env.PAYAI_FACILITATOR_URL||"https://facilitator.payai.network"}async callPayAIVerifyWithRetries(e,t,a){let i=[429,500,502,503,504],s=Date.now();for(let o=0;o<3;o++)try{let n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(1e4)}),c=await n.text(),l=c?JSON.parse(c):{},d=Date.now()-s;if(n.ok&&!0===l.valid)return{success:!0,valid:!0,status:n.status,isRateLimited:!1,isNetworkError:!1,latencyMs:d,data:l};let u=i.includes(n.status),h=429===n.status;if(!u||2===o){let e=l.message||l.reason||l.error||`HTTP ${n.status}`,t=l.errorType||l.code||(h?"rate_limit":"PAYAI_VERIFY_FAILED");return{success:!1,valid:!1,status:n.status,errorType:t,errorMessage:e,isRateLimited:h,isNetworkError:!1,latencyMs:d,data:l}}let m=100*Math.pow(2,o);r.info({component:"PayAIFacilitator",attempt:o+1,maxRetries:3,status:n.status,delay:m,isProbe:a,msg:"Retrying PayAI verification after transient error"}),await new Promise(e=>setTimeout(e,m))}catch(n){let e=Date.now()-s,t=n?.name==="AbortError"||n?.message?.toLowerCase().includes("timeout"),i=n?.message?.toLowerCase().includes("network")||n?.message?.toLowerCase().includes("fetch")||n?.message?.toLowerCase().includes("econnrefused");if((t||i)&&o<2){let e=100*Math.pow(2,o);r.info({component:"PayAIFacilitator",attempt:o+1,maxRetries:3,error:n?.message,delay:e,isProbe:a,msg:"Retrying PayAI verification after network error"}),await new Promise(t=>setTimeout(t,e));continue}return{success:!1,valid:!1,status:0,errorType:t?"timeout":i?"network_error":"PAYAI_VERIFY_FAILED",errorMessage:n?.message||"PayAI verification failed",isRateLimited:!1,isNetworkError:t||i,latencyMs:e}}return{success:!1,valid:!1,status:0,errorType:"PAYAI_VERIFY_FAILED",errorMessage:"Max retries exceeded",isRateLimited:!1,isNetworkError:!1,latencyMs:Date.now()-s}}async verify(t,a){let i=Date.now(),s=this.validateRequirements(a);if(!s.valid)return{success:!1,valid:!1,error:s.error,facilitatorId:this.id,verifiedAt:new Date().toISOString()};try{let i,{parseX402Header:s}=await e.A(5371),o=s(t);if(!o.valid||!o.parsed)return{success:!1,valid:!1,error:o.error||"Failed to parse payment header",facilitatorId:this.id,verifiedAt:new Date().toISOString()};let n=o.parsed,c=a.resource?.startsWith("https://probe.nexflow.dev/health/")??!1;if(c){let e=a.resource.match(/\/health\/([^/]+)\/([^/]+)\/([^/]+)/);if(e){let t,[,a,s,o]=e,n={id:`${a}-${s}-${o.toLowerCase()}`,facilitatorId:a,network:s,token:o,desiredIntervalSeconds:120,enabled:!0};t=n.network,"eip155:8453"===n.network&&(t="base"),i={scheme:"x402",network:t,asset:"0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913",maxAmountRequired:"1",resource:`https://probe.nexflow.dev/health/${n.facilitatorId}/${n.network}/${n.token}`,description:`Health probe for ${n.facilitatorId} on ${n.network}`,mimeType:"application/json",payTo:"0x0000000000000000000000000000000000000001",maxTimeoutSeconds:10,settlementMode:"immediate"},r.info({component:"PayAIFacilitator",isProbe:!0,probeConfigId:n.id,hasPaymentRequirements:!0,msg:"Using probe-specific paymentRequirements for PayAI"})}else i=a}else i=a;let l={x402Version:2,scheme:i.scheme||"x402",network:n.network||i.network,payload:{signature:n.signature,authorization:{from:n.authorization.from,to:n.authorization.to,value:n.authorization.value,validAfter:n.authorization.validAfter,validBefore:n.authorization.validBefore,nonce:n.authorization.nonce}}},d={scheme:i.scheme,network:i.network,maxAmountRequired:i.maxAmountRequired,resource:i.resource,description:i.description||"",mimeType:i.mimeType||"application/json",payTo:i.payTo,maxTimeoutSeconds:i.maxTimeoutSeconds||300,asset:i.asset},u=`${this.baseUrl}/verify`;r.info({component:"PayAIFacilitator",isProbe:c,network:d.network,asset:d.asset,url:u,msg:"Sending PayAI /verify request"});let h=await this.callPayAIVerifyWithRetries(u,{paymentPayload:l,paymentRequirements:d},c);if(h.latencyMs,h.success&&h.valid)return r.info({latencyMs:h.latencyMs},"Payment verified successfully by PayAI"),{success:!0,valid:!0,transactionHash:h.data?.transactionHash||h.data?.txHash,facilitatorId:this.id,verifiedAt:new Date().toISOString()};let m=h.errorType||"PAYAI_VERIFY_FAILED",f=h.errorMessage||"PayAI verification failed",p="facilitator_error";return h.isRateLimited||"rate_limit"===m?p="rate_limited":h.isNetworkError?p="network_error":"invalid_request"===m||400===h.status?p="invalid_request":401===h.status&&(p="unauthorized"),r.debug({status:h.status,errorType:m,errorMessage:f,errorCode:p,isRateLimited:h.isRateLimited,isNetworkError:h.isNetworkError,latencyMs:h.latencyMs},"PayAI verification failed"),{success:!1,valid:!1,error:f,errorDetails:{error:f,errorType:m,httpStatus:h.status,errorCode:p,isRateLimited:h.isRateLimited,isNetworkError:h.isNetworkError,payaiResponse:h.data},facilitatorId:this.id,verifiedAt:new Date().toISOString()}}catch(s){let e=Date.now()-i,t=s instanceof Error?s.message:"Verification failed",r=s instanceof Error&&("AbortError"===s.name||t.toLowerCase().includes("timeout"));return this.getLogger().error({error:s,requirements:a,latency:e,isTimeout:r},"PayAI verification error"),{success:!1,valid:!1,error:r?"PayAI_REQUEST_TIMEOUT":t,facilitatorId:this.id,verifiedAt:new Date().toISOString()}}}async getHealth(){let e=Date.now();try{let t=`${this.baseUrl}/discovery/resources`,r=await fetch(t,{method:"GET",headers:{"Content-Type":"application/json"},signal:AbortSignal.timeout(5e3)}),a=Date.now()-e;if(r.ok){let e=await r.json(),t=e.networks&&Array.isArray(e.networks)&&e.networks.length>0,i=e.assets&&Array.isArray(e.assets)&&e.assets.length>0;if(t||i)return{healthy:!0,latency:a,lastChecked:new Date().toISOString(),capabilities:{networks:e.networks||this.config.networks,assets:e.assets||this.config.assets,schemes:e.schemes||this.config.schemes}};return{healthy:!1,latency:a,lastChecked:new Date().toISOString(),error:"Health check returned empty networks/assets",capabilities:{networks:this.config.networks,assets:this.config.assets,schemes:this.config.schemes}}}let i=await r.text().catch(()=>`HTTP ${r.status}`);return{healthy:!1,latency:a,lastChecked:new Date().toISOString(),error:i,capabilities:{networks:this.config.networks,assets:this.config.assets,schemes:this.config.schemes}}}catch(i){let t=Date.now()-e,r=i instanceof Error?i.message:"Health check failed",a=i instanceof Error&&("AbortError"===i.name||r.toLowerCase().includes("timeout"));return{healthy:!1,latency:t,lastChecked:new Date().toISOString(),error:a?"Health check timeout":r,capabilities:{networks:this.config.networks,assets:this.config.assets,schemes:this.config.schemes}}}}async getPricing(e,t){return null}supports(e,t,r,a){return super.supports(e,t,r,a)}}let i=null;function s(){return i||(i=new a),i}e.s(["getPayAIFacilitator",()=>s])},95656,e=>{"use strict";var t=e.i(22444);let r=(0,e.i(50377).createLogger)({component:"X402rsFacilitator"});class a extends t.BaseFacilitator{id="x402rs";name="X402rs Facilitator";config={id:"x402rs",name:"X402rs Facilitator",enabled:"false"!==process.env.X402RS_ENABLED,priority:2,networks:["base","base-sepolia","xdc"],networksCAIP:["eip155:84532","eip155:8453","xdc:50"],assets:["USDC","0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913","0x036CbD53842c5426634e7929541eC2318f3dCF7e"],assetsCAIP:["eip155:8453/erc20:0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913","eip155:84532/erc20:0x036CbD53842c5426634e7929541eC2318f3dCF7e"],schemes:["exact","x402"],settlementModes:["immediate"],healthCheckUrl:process.env.X402RS_FACILITATOR_URL||"https://facilitator.x402.rs",metadata:{provider:"x402 Community",label:"X402rs Facilitator",url:"https://facilitator.x402.rs",website:"https://x402.org",rustBased:!0,openSource:!0,complianceLevel:"community"}};baseUrl;constructor(e){super(),this.baseUrl=e||process.env.X402RS_FACILITATOR_URL||"https://facilitator.x402.rs"}getUrl(){return this.baseUrl}async callX402rsVerifyWithRetries(e,t,a){let i=[429,500,502,503,504],s=Date.now();for(let o=0;o<3;o++)try{let n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(1e4)}),c=await n.text(),l=c?JSON.parse(c):{},d=Date.now()-s;if(n.ok&&!0===l.valid)return{success:!0,valid:!0,status:n.status,isRateLimited:!1,isNetworkError:!1,latencyMs:d,data:l};let u=i.includes(n.status),h=429===n.status;if(!u||2===o){let e=l.message||l.reason||l.error||`HTTP ${n.status}`,t=l.errorType||l.code||(h?"rate_limit":"X402RS_VERIFY_FAILED");return{success:!1,valid:!1,status:n.status,errorType:t,errorMessage:e,isRateLimited:h,isNetworkError:!1,latencyMs:d,data:l}}let m=100*Math.pow(2,o);r.info({component:"X402rsFacilitator",attempt:o+1,maxRetries:3,status:n.status,delay:m,isProbe:a,msg:"Retrying X402rs verification after transient error"}),await new Promise(e=>setTimeout(e,m))}catch(n){let e=Date.now()-s,t=n?.name==="AbortError"||n?.message?.toLowerCase().includes("timeout"),i=n?.message?.toLowerCase().includes("network")||n?.message?.toLowerCase().includes("fetch")||n?.message?.toLowerCase().includes("econnrefused");if((t||i)&&o<2){let e=100*Math.pow(2,o);r.info({component:"X402rsFacilitator",attempt:o+1,maxRetries:3,error:n?.message,delay:e,isProbe:a,msg:"Retrying X402rs verification after network error"}),await new Promise(t=>setTimeout(t,e));continue}return{success:!1,valid:!1,status:0,errorType:t?"timeout":i?"network_error":"X402RS_VERIFY_FAILED",errorMessage:n?.message||"X402rs verification failed",isRateLimited:!1,isNetworkError:t||i,latencyMs:e}}return{success:!1,valid:!1,status:0,errorType:"X402RS_VERIFY_FAILED",errorMessage:"Max retries exceeded",isRateLimited:!1,isNetworkError:!1,latencyMs:Date.now()-s}}async verify(t,a){let i=Date.now(),s=this.validateRequirements(a);if(!s.valid)return{success:!1,valid:!1,error:s.error,facilitatorId:this.id,verifiedAt:new Date().toISOString()};try{let{parseX402Header:i}=await e.A(5371),s=i(t);if(!s.valid||!s.parsed)return{success:!1,valid:!1,error:s.error||"Failed to parse payment header",facilitatorId:this.id,verifiedAt:new Date().toISOString()};let o=s.parsed,n=a.resource?.startsWith("https://probe.nexflow.dev/health/")??!1,c={x402Version:2,scheme:a.scheme||"x402",network:o.network||a.network,payload:{signature:o.signature,authorization:{from:o.authorization.from,to:o.authorization.to,value:o.authorization.value,validAfter:o.authorization.validAfter,validBefore:o.authorization.validBefore,nonce:o.authorization.nonce}}},l={scheme:a.scheme,network:a.network,maxAmountRequired:a.maxAmountRequired,resource:a.resource,description:a.description||"",mimeType:a.mimeType||"application/json",payTo:a.payTo,maxTimeoutSeconds:a.maxTimeoutSeconds||300,asset:a.asset},d=`${this.baseUrl}/verify`;r.info({component:"X402rsFacilitator",isProbe:n,network:l.network,asset:l.asset,url:d,facilitatorId:this.id,facilitatorUrl:this.baseUrl,msg:"Sending X402rs /verify request"});let u=await this.callX402rsVerifyWithRetries(d,{paymentPayload:c,paymentRequirements:l},n);if(u.success&&u.valid)return r.info({component:"X402rsFacilitator",facilitatorId:this.id,facilitatorUrl:this.baseUrl,latencyMs:u.latencyMs,network:a.network,msg:"Payment verified successfully by X402rs"}),{success:!0,valid:!0,transactionHash:u.data?.transactionHash||u.data?.txHash,facilitatorId:this.id,verifiedAt:new Date().toISOString()};let h=u.errorType||"X402RS_VERIFY_FAILED",m=u.errorMessage||"X402rs verification failed",f="facilitator_error";return u.isRateLimited||"rate_limit"===h?f="rate_limited":u.isNetworkError?f="network_error":("invalid_request"===h||400===u.status)&&(f="invalid_request"),r.debug({component:"X402rsFacilitator",facilitatorId:this.id,status:u.status,errorType:h,errorMessage:m,errorCode:f,isRateLimited:u.isRateLimited,isNetworkError:u.isNetworkError,latencyMs:u.latencyMs,msg:"X402rs verification failed"}),{success:!1,valid:!1,error:m,errorDetails:{error:m,errorType:h,httpStatus:u.status,errorCode:f,isRateLimited:u.isRateLimited,isNetworkError:u.isNetworkError,x402rsResponse:u.data},facilitatorId:this.id,verifiedAt:new Date().toISOString()}}catch(s){let e=Date.now()-i,t=s instanceof Error?s.message:"Verification failed",r=s instanceof Error&&("AbortError"===s.name||t.toLowerCase().includes("timeout"));return this.getLogger().error({error:s,requirements:a,latency:e,isTimeout:r},"X402rs verification error"),{success:!1,valid:!1,error:r?"X402RS_REQUEST_TIMEOUT":t,facilitatorId:this.id,verifiedAt:new Date().toISOString()}}}async getHealth(){let e=Date.now();try{let t=`${this.baseUrl}/health`,r=await fetch(t,{method:"GET",headers:{"Content-Type":"application/json"},signal:AbortSignal.timeout(5e3)}),a=Date.now()-e;if(r.ok){let e={};try{e=await r.json()}catch{}return{healthy:!0,latency:a,lastChecked:new Date().toISOString(),capabilities:{networks:e.networks||this.config.networks,assets:e.assets||this.config.assets,schemes:e.schemes||this.config.schemes}}}let i=await r.text().catch(()=>`HTTP ${r.status}`);return{healthy:!1,latency:a,lastChecked:new Date().toISOString(),error:i,capabilities:{networks:this.config.networks,assets:this.config.assets,schemes:this.config.schemes}}}catch(i){let t=Date.now()-e,r=i instanceof Error?i.message:"Health check failed",a=i instanceof Error&&("AbortError"===i.name||r.toLowerCase().includes("timeout"));return{healthy:!1,latency:t,lastChecked:new Date().toISOString(),error:a?"Health check timeout":r,capabilities:{networks:this.config.networks,assets:this.config.assets,schemes:this.config.schemes}}}}async getPricing(e,t){return null}supports(e,t,r,a){return super.supports(e,t,r,a)}}let i=null;function s(){return i||(i=new a),i}e.s(["getX402rsFacilitator",()=>s])},47348,e=>{"use strict";var t=e.i(22444);let r=(0,e.i(50377).createLogger)({component:"DexterFacilitator"});class a extends t.BaseFacilitator{id="dexter";name="Dexter Facilitator";config={id:"dexter",name:"Dexter Facilitator",enabled:"false"!==process.env.DEXTER_ENABLED,priority:2,networks:["solana","solana-mainnet","solana-devnet"],networksCAIP:["solana:101","solana:102","solana:mainnet","solana:devnet"],assets:["USDC","EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v","4zMMC9srt5Ri5X14GAgXhaHii3GnPAEERYPJgZJDncDU"],assetsCAIP:["solana:101/spl:EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v","solana:102/spl:4zMMC9srt5Ri5X14GAgXhaHii3GnPAEERYPJgZJDncDU"],schemes:["exact","x402"],settlementModes:["immediate"],healthCheckUrl:process.env.DEXTER_FACILITATOR_URL||"https://facilitator.dexter.cash",metadata:{provider:"Dexter",label:"Dexter Facilitator",url:"https://facilitator.dexter.cash",website:"https://dexter.cash",solanaNative:!0,complianceLevel:"community",notes:"Solana-native x402 facilitator"}};baseUrl;constructor(e){super(),this.baseUrl=e||process.env.DEXTER_FACILITATOR_URL||"https://facilitator.dexter.cash"}getUrl(){return this.baseUrl}async callDexterVerifyWithRetries(e,t,a){let i=[429,500,502,503,504],s=Date.now();for(let o=0;o<3;o++)try{let n=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(1e4)}),c=await n.text(),l=c?JSON.parse(c):{},d=Date.now()-s;if(n.ok&&!0===l.valid)return{success:!0,valid:!0,status:n.status,isRateLimited:!1,isNetworkError:!1,latencyMs:d,data:l};let u=i.includes(n.status),h=429===n.status;if(!u||2===o){let e=l.message||l.reason||l.error||`HTTP ${n.status}`,t=l.errorType||l.code||(h?"rate_limit":"DEXTER_VERIFY_FAILED");return{success:!1,valid:!1,status:n.status,errorType:t,errorMessage:e,isRateLimited:h,isNetworkError:!1,latencyMs:d,data:l}}let m=100*Math.pow(2,o);r.info({component:"DexterFacilitator",attempt:o+1,maxRetries:3,status:n.status,delay:m,isProbe:a,msg:"Retrying Dexter verification after transient error"}),await new Promise(e=>setTimeout(e,m))}catch(n){let e=Date.now()-s,t=n?.name==="AbortError"||n?.message?.toLowerCase().includes("timeout"),i=n?.message?.toLowerCase().includes("network")||n?.message?.toLowerCase().includes("fetch")||n?.message?.toLowerCase().includes("econnrefused");if((t||i)&&o<2){let e=100*Math.pow(2,o);r.info({component:"DexterFacilitator",attempt:o+1,maxRetries:3,error:n?.message,delay:e,isProbe:a,msg:"Retrying Dexter verification after network error"}),await new Promise(t=>setTimeout(t,e));continue}return{success:!1,valid:!1,status:0,errorType:t?"timeout":i?"network_error":"DEXTER_VERIFY_FAILED",errorMessage:n?.message||"Dexter verification failed",isRateLimited:!1,isNetworkError:t||i,latencyMs:e}}return{success:!1,valid:!1,status:0,errorType:"DEXTER_VERIFY_FAILED",errorMessage:"Max retries exceeded",isRateLimited:!1,isNetworkError:!1,latencyMs:Date.now()-s}}async verify(t,a){let i=Date.now(),s=this.validateRequirements(a);if(!s.valid)return{success:!1,valid:!1,error:s.error,facilitatorId:this.id,verifiedAt:new Date().toISOString()};try{let{parseX402Header:i}=await e.A(5371),s=i(t);if(!s.valid||!s.parsed)return{success:!1,valid:!1,error:s.error||"Failed to parse payment header",facilitatorId:this.id,verifiedAt:new Date().toISOString()};let o=s.parsed,n=a.resource?.startsWith("https://probe.nexflow.dev/health/")??!1,c={x402Version:2,scheme:a.scheme||"x402",network:o.network||a.network,payload:{signature:o.signature,authorization:{from:o.authorization.from,to:o.authorization.to,value:o.authorization.value,validAfter:o.authorization.validAfter,validBefore:o.authorization.validBefore,nonce:o.authorization.nonce}}},l={scheme:a.scheme,network:a.network,maxAmountRequired:a.maxAmountRequired,resource:a.resource,description:a.description||"",mimeType:a.mimeType||"application/json",payTo:a.payTo,maxTimeoutSeconds:a.maxTimeoutSeconds||300,asset:a.asset},d=`${this.baseUrl}/verify`;r.info({component:"DexterFacilitator",isProbe:n,network:l.network,asset:l.asset,url:d,facilitatorId:this.id,facilitatorUrl:this.baseUrl,msg:"Sending Dexter /verify request"});let u=await this.callDexterVerifyWithRetries(d,{paymentPayload:c,paymentRequirements:l},n);if(u.success&&u.valid)return r.info({component:"DexterFacilitator",facilitatorId:this.id,facilitatorUrl:this.baseUrl,latencyMs:u.latencyMs,network:a.network,msg:"Payment verified successfully by Dexter"}),{success:!0,valid:!0,transactionHash:u.data?.transactionHash||u.data?.txHash,facilitatorId:this.id,verifiedAt:new Date().toISOString()};let h=u.errorType||"DEXTER_VERIFY_FAILED",m=u.errorMessage||"Dexter verification failed",f="facilitator_error";return u.isRateLimited||"rate_limit"===h?f="rate_limited":u.isNetworkError?f="network_error":("invalid_request"===h||400===u.status)&&(f="invalid_request"),r.debug({component:"DexterFacilitator",facilitatorId:this.id,status:u.status,errorType:h,errorMessage:m,errorCode:f,isRateLimited:u.isRateLimited,isNetworkError:u.isNetworkError,latencyMs:u.latencyMs,msg:"Dexter verification failed"}),{success:!1,valid:!1,error:m,errorDetails:{error:m,errorType:h,httpStatus:u.status,errorCode:f,isRateLimited:u.isRateLimited,isNetworkError:u.isNetworkError,dexterResponse:u.data},facilitatorId:this.id,verifiedAt:new Date().toISOString()}}catch(s){let e=Date.now()-i,t=s instanceof Error?s.message:"Verification failed",r=s instanceof Error&&("AbortError"===s.name||t.toLowerCase().includes("timeout"));return this.getLogger().error({error:s,requirements:a,latency:e,isTimeout:r},"Dexter verification error"),{success:!1,valid:!1,error:r?"DEXTER_REQUEST_TIMEOUT":t,facilitatorId:this.id,verifiedAt:new Date().toISOString()}}}async settle(t,a){let i=Date.now();try{let{parseX402Header:s}=await e.A(5371),o=s(t);if(!o.valid||!o.parsed)return{success:!1,settled:!1,error:o.error||"Failed to parse payment header",facilitatorId:this.id,settledAt:new Date().toISOString()};let n=o.parsed,c={x402Version:2,scheme:a.scheme||"x402",network:n.network||a.network,payload:{signature:n.signature,authorization:{from:n.authorization.from,to:n.authorization.to,value:n.authorization.value,validAfter:n.authorization.validAfter,validBefore:n.authorization.validBefore,nonce:n.authorization.nonce}}},l={scheme:a.scheme,network:a.network,maxAmountRequired:a.maxAmountRequired,resource:a.resource,description:a.description||"",mimeType:a.mimeType||"application/json",payTo:a.payTo,maxTimeoutSeconds:a.maxTimeoutSeconds||300,asset:a.asset},d=`${this.baseUrl}/settle`;r.info({component:"DexterFacilitator",network:l.network,asset:l.asset,url:d,facilitatorId:this.id,facilitatorUrl:this.baseUrl,msg:"Sending Dexter /settle request"});let u=await fetch(d,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentPayload:c,paymentRequirements:l}),signal:AbortSignal.timeout(3e4)}),h=Date.now()-i,m=await u.text(),f=m?JSON.parse(m):{};if(u.ok&&(!0===f.settled||!0===f.success))return r.info({component:"DexterFacilitator",facilitatorId:this.id,facilitatorUrl:this.baseUrl,latencyMs:h,network:a.network,transactionHash:f.transactionHash||f.txHash,msg:"Payment settled successfully by Dexter"}),{success:!0,settled:!0,transactionHash:f.transactionHash||f.txHash,facilitatorId:this.id,settledAt:new Date().toISOString()};let p=f.message||f.reason||f.error||`HTTP ${u.status}`;return r.error({component:"DexterFacilitator",facilitatorId:this.id,status:u.status,errorMessage:p,latencyMs:h,msg:"Dexter settlement failed"}),{success:!1,settled:!1,error:p,errorDetails:{httpStatus:u.status,dexterResponse:f},facilitatorId:this.id,settledAt:new Date().toISOString()}}catch(s){let e=Date.now()-i,t=s instanceof Error?s.message:"Settlement failed",r=s instanceof Error&&("AbortError"===s.name||t.toLowerCase().includes("timeout"));return this.getLogger().error({error:s,requirements:a,latency:e,isTimeout:r},"Dexter settlement error"),{success:!1,settled:!1,error:r?"DEXTER_REQUEST_TIMEOUT":t,facilitatorId:this.id,settledAt:new Date().toISOString()}}}async getHealth(){let e=Date.now();try{let t=`${this.baseUrl}/health`,r=await fetch(t,{method:"GET",headers:{"Content-Type":"application/json"},signal:AbortSignal.timeout(5e3)}),a=Date.now()-e;if(r.ok){let e={};try{e=await r.json()}catch{}return{healthy:!0,latency:a,lastChecked:new Date().toISOString(),capabilities:{networks:e.networks||this.config.networks,assets:e.assets||this.config.assets,schemes:e.schemes||this.config.schemes}}}let i=await r.text().catch(()=>`HTTP ${r.status}`);return{healthy:!1,latency:a,lastChecked:new Date().toISOString(),error:i,capabilities:{networks:this.config.networks,assets:this.config.assets,schemes:this.config.schemes}}}catch(i){let t=Date.now()-e,r=i instanceof Error?i.message:"Health check failed",a=i instanceof Error&&("AbortError"===i.name||r.toLowerCase().includes("timeout"));return{healthy:!1,latency:t,lastChecked:new Date().toISOString(),error:a?"Health check timeout":r,capabilities:{networks:this.config.networks,assets:this.config.assets,schemes:this.config.schemes}}}}async getPricing(e,t){return null}supports(e,t,r,a){return super.supports(e,t,r,a)}}let i=null;function s(){return i||(i=new a),i}e.s(["getDexterFacilitator",()=>s])},3794,e=>{"use strict";var t=e.i(22444);let r=(0,e.i(50377).createLogger)({component:"CronosFacilitator"}),a="rate_limited",i="network_error",s="timeout";function o(e){return({"eip155:25":"cronos","eip155:338":"cronos-testnet",cronos:"cronos","cronos-testnet":"cronos-testnet","cronos-mainnet":"cronos"})[e]||e}class n extends t.BaseFacilitator{id="cronos";name="Cronos x402 Facilitator";config={id:"cronos",name:"Cronos x402 Facilitator",enabled:"false"!==process.env.CRONOS_ENABLED,priority:2,networks:["cronos","cronos-testnet"],networksCAIP:["eip155:25","eip155:338"],assets:["USDC","USDX"],assetsCAIP:[],schemes:["exact","x402"],settlementModes:["immediate"],healthCheckUrl:process.env.CRONOS_FACILITATOR_URL||"https://facilitator.cronoslabs.org",metadata:{provider:"Cronos Labs",label:"Cronos x402 Facilitator",url:"https://facilitator.cronoslabs.org",website:"https://cronos.org",documentation:"https://docs.cronos.org/cronos-x402-facilitator",complianceLevel:"standard",rateLimits:{requestsPerMinute:5}}};baseUrl;cachedSupported=null;lastSupportedFetch=0;SUPPORTED_CACHE_TTL_MS=3e5;constructor(e){super(),this.baseUrl=e||process.env.CRONOS_FACILITATOR_URL||"https://facilitator.cronoslabs.org"}getUrl(){return this.baseUrl}async getHealth(){let e=Date.now();try{let t=`${this.baseUrl}/healthcheck`,r=await fetch(t,{method:"GET",headers:{"Content-Type":"application/json"},signal:AbortSignal.timeout(5e3)}),a=Date.now()-e;if(r.ok){let e={status:"OK"};try{e=await r.json()}catch{}let t="OK"===e.status,i=await this.fetchSupported();return{healthy:t,latency:a,lastChecked:new Date().toISOString(),capabilities:{networks:i?.networks||this.config.networks,assets:i?.assets?.map(e=>e.symbol)||this.config.assets,schemes:this.config.schemes}}}let i=await r.text().catch(()=>`HTTP ${r.status}`);return{healthy:!1,latency:a,lastChecked:new Date().toISOString(),error:i,capabilities:{networks:this.config.networks,assets:this.config.assets,schemes:this.config.schemes}}}catch(i){let t=Date.now()-e,r=i instanceof Error?i.message:"Health check failed",a=i instanceof Error&&("AbortError"===i.name||r.toLowerCase().includes("timeout"));return{healthy:!1,latency:t,lastChecked:new Date().toISOString(),error:a?"Health check timeout":r,capabilities:{networks:this.config.networks,assets:this.config.assets,schemes:this.config.schemes}}}}async fetchSupported(){if(this.cachedSupported&&Date.now()-this.lastSupportedFetch<this.SUPPORTED_CACHE_TTL_MS)return this.cachedSupported;try{let e=`${this.baseUrl}/v2/x402/supported`,t=await fetch(e,{method:"GET",headers:{"Content-Type":"application/json"},signal:AbortSignal.timeout(5e3)});if(t.ok){let e=await t.json();return this.cachedSupported=e,this.lastSupportedFetch=Date.now(),r.info({component:"CronosFacilitator",networks:e.networks,assetsCount:e.assets?.length,msg:"Cronos supported assets refreshed"}),e}return r.warn({component:"CronosFacilitator",status:t.status,msg:"Failed to fetch Cronos supported assets"}),null}catch(e){return r.warn({component:"CronosFacilitator",error:e instanceof Error?e.message:"Unknown error",msg:"Error fetching Cronos supported assets"}),null}}async callCronosVerifyWithRetries(e,t,o){let n=[429,500,502,503,504],c=Date.now();for(let l=0;l<3;l++)try{let i=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(1e4)}),s=await i.text(),d=s?JSON.parse(s):{},u=Date.now()-c;if(i.ok&&!0===d.valid)return{success:!0,valid:!0,status:i.status,isRateLimited:!1,isNetworkError:!1,latencyMs:u,data:d};let h=n.includes(i.status),m=429===i.status;if(!h||2===l){let e=d.error||`HTTP ${i.status}`,t=d.errorCode||(m?a:"CRONOS_VERIFY_FAILED");return{success:!1,valid:!1,status:i.status,errorType:t,errorMessage:e,isRateLimited:m,isNetworkError:!1,latencyMs:u,data:d}}let f=100*Math.pow(2,l);r.info({component:"CronosFacilitator",attempt:l+1,maxRetries:3,status:i.status,delay:f,isProbe:o,msg:"Retrying Cronos verification after transient error"}),await new Promise(e=>setTimeout(e,f))}catch(n){let e=Date.now()-c,t=n?.name==="AbortError"||n?.message?.toLowerCase().includes("timeout"),a=n?.message?.toLowerCase().includes("network")||n?.message?.toLowerCase().includes("fetch")||n?.message?.toLowerCase().includes("econnrefused");if((t||a)&&l<2){let e=100*Math.pow(2,l);r.info({component:"CronosFacilitator",attempt:l+1,maxRetries:3,error:n?.message,delay:e,isProbe:o,msg:"Retrying Cronos verification after network error"}),await new Promise(t=>setTimeout(t,e));continue}return{success:!1,valid:!1,status:0,errorType:t?s:a?i:"CRONOS_VERIFY_FAILED",errorMessage:n?.message||"Cronos verification failed",isRateLimited:!1,isNetworkError:t||a,latencyMs:e}}return{success:!1,valid:!1,status:0,errorType:"CRONOS_VERIFY_FAILED",errorMessage:"Max retries exceeded",isRateLimited:!1,isNetworkError:!1,latencyMs:Date.now()-c}}async verify(t,i){let s=Date.now(),n=this.validateRequirements(i);if(!n.valid)return{success:!1,valid:!1,error:n.error,facilitatorId:this.id,verifiedAt:new Date().toISOString()};try{let{parseX402Header:s}=await e.A(5371),n=s(t);if(!n.valid||!n.parsed)return{success:!1,valid:!1,error:n.error||"Failed to parse payment header",facilitatorId:this.id,verifiedAt:new Date().toISOString()};let c=n.parsed,l=i.resource?.startsWith("https://probe.nexflow.dev/health/")??!1,d=o(i.network),u={paymentPayload:{x402Version:2,scheme:i.scheme||"x402",network:d,payload:{signature:c.signature,authorization:{from:c.authorization.from,to:c.authorization.to,value:c.authorization.value,validAfter:c.authorization.validAfter,validBefore:c.authorization.validBefore,nonce:c.authorization.nonce}}},paymentRequirements:{scheme:i.scheme,network:d,maxAmountRequired:i.maxAmountRequired,resource:i.resource,description:i.description||"",mimeType:i.mimeType||"application/json",payTo:i.payTo,maxTimeoutSeconds:i.maxTimeoutSeconds||300,asset:i.asset}},h=`${this.baseUrl}/v2/x402/verify`;r.info({component:"CronosFacilitator",isProbe:l,network:d,asset:i.asset,url:h,facilitatorId:this.id,facilitatorUrl:this.baseUrl,msg:"Sending Cronos /v2/x402/verify request"});let m=await this.callCronosVerifyWithRetries(h,u,l);if(m.success&&m.valid)return r.info({component:"CronosFacilitator",facilitatorId:this.id,facilitatorUrl:this.baseUrl,latencyMs:m.latencyMs,network:d,transactionHash:m.data?.transactionHash,msg:"Payment verified successfully by Cronos"}),{success:!0,valid:!0,transactionHash:m.data?.transactionHash,facilitatorId:this.id,verifiedAt:new Date().toISOString()};let f=m.errorType||"CRONOS_VERIFY_FAILED",p=m.errorMessage||"Cronos verification failed",g="facilitator_error";return m.isRateLimited||f===a?g="rate_limited":m.isNetworkError?g="network_error":"authorization_already_used"===f?g="authorization_already_used":"invalid_signature"===f||"invalid_authorization"===f?g="invalid_authorization":400===m.status&&(g="invalid_request"),r.debug({component:"CronosFacilitator",facilitatorId:this.id,status:m.status,errorType:f,errorMessage:p,errorCode:g,isRateLimited:m.isRateLimited,isNetworkError:m.isNetworkError,latencyMs:m.latencyMs,msg:"Cronos verification failed"}),{success:!1,valid:!1,error:p,errorDetails:{error:p,errorType:f,httpStatus:m.status,errorCode:g,isRateLimited:m.isRateLimited,isNetworkError:m.isNetworkError,cronosResponse:m.data},facilitatorId:this.id,verifiedAt:new Date().toISOString()}}catch(a){let e=Date.now()-s,t=a instanceof Error?a.message:"Verification failed",r=a instanceof Error&&("AbortError"===a.name||t.toLowerCase().includes("timeout"));return this.getLogger().error({error:a,requirements:i,latency:e,isTimeout:r},"Cronos verification error"),{success:!1,valid:!1,error:r?"CRONOS_REQUEST_TIMEOUT":t,facilitatorId:this.id,verifiedAt:new Date().toISOString()}}}async settle(e){let t=Date.now();try{let a=o(e.network),i={paymentIntent:{...e,network:a}},s=`${this.baseUrl}/v2/x402/settle`;r.info({component:"CronosFacilitator",network:a,url:s,facilitatorId:this.id,msg:"Sending Cronos /v2/x402/settle request"});let n=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(3e4)}),c=Date.now()-t,l=await n.text(),d=l?JSON.parse(l):{};if(n.ok&&d.success)return r.info({component:"CronosFacilitator",facilitatorId:this.id,latencyMs:c,transactionHash:d.transactionHash,blockNumber:d.blockNumber,msg:"Payment settled successfully by Cronos"}),{success:!0,transactionHash:d.transactionHash,blockNumber:d.blockNumber,timestamp:d.timestamp};let u=d.errorCode||"CRONOS_SETTLE_FAILED",h=d.error||`HTTP ${n.status}`;return r.warn({component:"CronosFacilitator",facilitatorId:this.id,status:n.status,errorCode:u,errorMessage:h,latencyMs:c,msg:"Cronos settlement failed"}),{success:!1,error:h,errorCode:u}}catch(n){let e=Date.now()-t,a=n instanceof Error?n.message:"Settlement failed",o=n instanceof Error&&("AbortError"===n.name||a.toLowerCase().includes("timeout"));return r.error({component:"CronosFacilitator",error:a,latencyMs:e,isTimeout:o,msg:"Cronos settlement error"}),{success:!1,error:o?"CRONOS_SETTLE_TIMEOUT":a,errorCode:o?s:i}}}async getPricing(e,t){return null}supports(e,t,r,a){let i=o(e),s=["cronos","cronos-testnet","eip155:25","eip155:338"];return(!!s.includes(e)||!!s.includes(i))&&super.supports(i,t,r,a)}}let c=null;function l(){return c||(c=new n),c}e.s(["getCronosFacilitator",()=>l])},63260,e=>e.a(async(t,r)=>{try{var a=e.i(60827),i=e.i(50377),s=t([a]);[a]=s.then?(await s)():s;let l=(0,i.createLogger)({component:"HealthAggregator"});function o(e,t){if(0===e.length)return 0;let r=Math.ceil(t/100*e.length)-1;return e[Math.max(0,r)]}async function n(e,t,r,i,s){try{let n=await (0,a.getRouteAttemptsForHealth)(e,t,r,i.toISOString(),s.toISOString());if(0===n.length)return l.debug({facilitatorId:e,network:t,token:r},"No attempts found for health aggregation"),null;let c=n.filter(e=>"success"===e.result).length/n.length,d=n.map(e=>e.latency_ms).filter(e=>e>0).sort((e,t)=>e-t),u=d.length>0?o(d,50):null,h=d.length>0?o(d,95):null,m=d.length>0?o(d,99):null,f=n.filter(e=>"success"!==e.result).length/n.length,p=n.filter(e=>"success"!==e.result),g=p.length>0?p[p.length-1].result:null,w="healthy";c<.5?w="down":(c<.9||h&&h>5e3)&&(w="degraded");let y={facilitator_id:e,network:t,token:r,window_start:i.toISOString(),window_end:s.toISOString(),success_rate:c,p50_latency_ms:u,p95_latency_ms:h,p99_latency_ms:m,error_rate:f,last_error_type:g,status:w},_=await (0,a.upsertHealthSnapshot)(y);return l.info({facilitatorId:e,network:t,token:r,successRate:c,p95Latency:h,status:w,attempts:n.length},"Health snapshot created"),_}catch(a){return l.error({error:a,facilitatorId:e,network:t,token:r},"Failed to aggregate health metrics"),null}}async function c(e,t,r,i=15){let s=await (0,a.getLatestHealthSnapshot)(e,t,r);if(s&&Date.now()-new Date(s.window_end).getTime()<60*i*1e3)return{successRate:Number(s.success_rate),p50LatencyMs:s.p50_latency_ms,p95LatencyMs:s.p95_latency_ms,p99LatencyMs:s.p99_latency_ms,errorRate:Number(s.error_rate),lastErrorType:s.last_error_type,status:s.status};let o=new Date,l=new Date(o.getTime()-60*i*1e3),d=await n(e,t,r,l,o);return d?{successRate:Number(d.success_rate),p50LatencyMs:d.p50_latency_ms,p95LatencyMs:d.p95_latency_ms,p99LatencyMs:d.p99_latency_ms,errorRate:Number(d.error_rate),lastErrorType:d.last_error_type,status:d.status}:{successRate:1,p50LatencyMs:null,p95LatencyMs:null,p99LatencyMs:null,errorRate:0,lastErrorType:null,status:"healthy"}}e.s(["getCurrentHealth",()=>c]),r()}catch(e){r(e)}},!1),82717,e=>{"use strict";e.s(["DEFAULT_DECAY_CONFIG",0,{halfLifeMs:36e5},"DEFAULT_SCORE_DELTA_CONFIG",0,{successBase:75,failureBase:25,lowLatencyBonus:15,mediumLatencyBonus:5,highLatencyPenalty:10,serverErrorPenalty:15}])},77950,e=>e.a(async(t,r)=>{try{var a=e.i(24924),i=e.i(50377),s=e.i(82717),o=t([a]);[a]=o.then?(await o)():o;let g=(0,i.createLogger)({component:"FacilitatorScoresDB"});function n(e){return"pool"in e||"function"==typeof e?.pool?.query}function c(e,t,r=s.DEFAULT_DECAY_CONFIG.halfLifeMs){let a=t.getTime()-e.getTime();return a<=0?1:Math.pow(2,-a/r)}function l(e){return{id:e.id,facilitator_id:e.facilitator_id,chain_id:e.chain_id,score:Number(e.score),confidence:Number(e.confidence),decay_factor:Number(e.decay_factor),sample_size:Number(e.sample_size),last_updated_at:new Date(e.last_updated_at),created_at:new Date(e.created_at)}}function d(e){return{id:e.id,name:e.name,variant:e.variant,facilitator_id:e.facilitator_id,chain_id:e.chain_id,traffic_share:Number(e.traffic_share),status:e.status,metrics_tracked:"string"==typeof e.metrics_tracked?JSON.parse(e.metrics_tracked):e.metrics_tracked||{},started_at:e.started_at?new Date(e.started_at):null,ended_at:e.ended_at?new Date(e.ended_at):null,completed_at:e.completed_at?new Date(e.completed_at):null,created_at:new Date(e.created_at)}}function u(e){return{id:e.id,payment_id:e.payment_id,experiment_id:e.experiment_id,assigned_at:new Date(e.assigned_at),outcome:e.outcome,latency_ms:e.latency_ms?Number(e.latency_ms):null,created_at:new Date(e.created_at)}}async function h(e,t=s.DEFAULT_DECAY_CONFIG){let r=(0,a.getDb)(),i=e.now||new Date,o=i.toISOString();if(n(r)){let a=await r.pool.query(`SELECT id, score, confidence, sample_size, last_updated_at 
       FROM facilitator_scores 
       WHERE facilitator_id = $1 AND chain_id = $2`,[e.facilitator_id,e.chain_id]);if(0===a.rows.length){let t=crypto.randomUUID(),a=await r.pool.query(`INSERT INTO facilitator_scores 
         (id, facilitator_id, chain_id, score, confidence, decay_factor, 
          sample_size, last_updated_at, created_at)
         VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
         RETURNING *`,[t,e.facilitator_id,e.chain_id,e.score,e.confidence,.9,e.sample_size,o,o]);return g.debug({facilitator_id:e.facilitator_id,chain_id:e.chain_id,score:e.score,action:"insert"},"Facilitator score inserted"),l(a.rows[0])}{let s=a.rows[0],n=new Date(s.last_updated_at),d=c(n,i,t.halfLifeMs),u=Number(s.score)*d+e.score*(1-d),h=Number(s.confidence)*d+e.confidence*(1-d),m=Number(s.sample_size)+e.sample_size,f=await r.pool.query(`UPDATE facilitator_scores 
         SET score = $1, confidence = $2, sample_size = $3, last_updated_at = $4
         WHERE id = $5
         RETURNING *`,[u,h,m,o,s.id]);return g.debug({facilitator_id:e.facilitator_id,chain_id:e.chain_id,old_score:Number(s.score),new_observation:e.score,decay_factor:d,blended_score:u,action:"update"},"Facilitator score updated with decay"),l(f.rows[0])}}{let a=r.prepare(`SELECT id, score, confidence, sample_size, last_updated_at 
       FROM facilitator_scores 
       WHERE facilitator_id = ? AND chain_id = ?`).get(e.facilitator_id,e.chain_id);if(a){let s=new Date(a.last_updated_at),n=c(s,i,t.halfLifeMs),d=a.score*n+e.score*(1-n),u=a.confidence*n+e.confidence*(1-n),h=a.sample_size+e.sample_size;r.prepare(`UPDATE facilitator_scores 
         SET score = ?, confidence = ?, sample_size = ?, last_updated_at = ?
         WHERE id = ?`).run(d,u,h,o,a.id);let m=r.prepare("SELECT * FROM facilitator_scores WHERE id = ?").get(a.id);return l(m)}{let t=crypto.randomUUID();r.prepare(`INSERT INTO facilitator_scores 
         (id, facilitator_id, chain_id, score, confidence, decay_factor, 
          sample_size, last_updated_at, created_at)
         VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`).run(t,e.facilitator_id,e.chain_id,e.score,e.confidence,.9,e.sample_size,o,o);let a=r.prepare("SELECT * FROM facilitator_scores WHERE id = ?").get(t);return l(a)}}}async function m(e,t){let r=(0,a.getDb)();if(n(r)){let a=await r.pool.query(`SELECT * FROM facilitator_scores 
       WHERE facilitator_id = $1 AND chain_id = $2`,[e,t]);return a.rows[0]?l(a.rows[0]):null}{let a=r.prepare(`SELECT * FROM facilitator_scores 
       WHERE facilitator_id = ? AND chain_id = ?`).get(e,t);return a?l(a):null}}async function f(e,t){let r=(0,a.getDb)();if(n(r)){let a=await r.pool.query(`SELECT * FROM routing_experiments 
       WHERE facilitator_id = $1 AND chain_id = $2 AND status = 'running'
       LIMIT 1`,[e,t]);return a.rows.length>0||(a=await r.pool.query(`SELECT * FROM routing_experiments 
       WHERE facilitator_id = $1 AND chain_id IS NULL AND status = 'running'
       LIMIT 1`,[e])).rows.length>0||(a=await r.pool.query(`SELECT * FROM routing_experiments 
       WHERE facilitator_id IS NULL AND chain_id = $1 AND status = 'running'
       LIMIT 1`,[t])).rows.length>0?d(a.rows[0]):null}{let a=r.prepare(`SELECT * FROM routing_experiments 
       WHERE facilitator_id = ? AND chain_id = ? AND status = 'running'
       LIMIT 1`).get(e,t);return a||(a=r.prepare(`SELECT * FROM routing_experiments 
       WHERE facilitator_id = ? AND chain_id IS NULL AND status = 'running'
       LIMIT 1`).get(e))||(a=r.prepare(`SELECT * FROM routing_experiments 
       WHERE facilitator_id IS NULL AND chain_id = ? AND status = 'running'
       LIMIT 1`).get(t))?d(a):null}}async function p(e){let t=(0,a.getDb)(),r=crypto.randomUUID(),i=new Date().toISOString();if(n(t)){let a=await t.pool.query(`INSERT INTO payment_experiment_assignments 
       (id, payment_id, experiment_id, assigned_at, outcome, latency_ms, created_at)
       VALUES ($1, $2, $3, $4, $5, $6, $7)
       ON CONFLICT (payment_id) DO UPDATE SET
         outcome = COALESCE(EXCLUDED.outcome, payment_experiment_assignments.outcome),
         latency_ms = COALESCE(EXCLUDED.latency_ms, payment_experiment_assignments.latency_ms)
       RETURNING *`,[r,e.payment_id,e.experiment_id,i,e.outcome||null,e.latency_ms||null,i]);return u(a.rows[0])}if(t.prepare("SELECT id FROM payment_experiment_assignments WHERE payment_id = ?").get(e.payment_id)){t.prepare(`UPDATE payment_experiment_assignments 
         SET outcome = COALESCE(?, outcome), latency_ms = COALESCE(?, latency_ms)
         WHERE payment_id = ?`).run(e.outcome||null,e.latency_ms||null,e.payment_id);let r=t.prepare("SELECT * FROM payment_experiment_assignments WHERE payment_id = ?").get(e.payment_id);return u(r)}{t.prepare(`INSERT INTO payment_experiment_assignments 
         (id, payment_id, experiment_id, assigned_at, outcome, latency_ms, created_at)
         VALUES (?, ?, ?, ?, ?, ?, ?)`).run(r,e.payment_id,e.experiment_id,i,e.outcome||null,e.latency_ms||null,i);let a=t.prepare("SELECT * FROM payment_experiment_assignments WHERE id = ?").get(r);return u(a)}}e.s(["getFacilitatorScore",()=>m,"getRunningExperiment",()=>f,"recordPaymentExperimentAssignment",()=>p,"upsertFacilitatorScore",()=>h]),r()}catch(e){r(e)}},!1),97487,e=>e.a(async(t,r)=>{try{var a=e.i(50377),i=e.i(77950);e.i(82717);var s=t([i]);async function o(e){let{facilitator_id:t,chain_id:r}=e,a=await (0,i.getFacilitatorScore)(t,r);return a?{score:a.score,confidence:a.confidence}:null}async function n(e,t){let r=await (0,i.getRunningExperiment)(e,t);return r&&"running"===r.status?{adjustment:10*r.traffic_share,experiment_name:r.name}:{adjustment:0,experiment_name:null}}[i]=s.then?(await s)():s,(0,a.createLogger)({component:"SMFScoring"}),e.s(["getEffectiveScore",()=>o,"getExperimentTrafficAdjustment",()=>n]),r()}catch(e){r(e)}},!1),57729,e=>e.a(async(t,r)=>{try{var a=e.i(83032),i=e.i(16334),s=e.i(95656),o=e.i(47348),n=e.i(3794),c=e.i(50377),l=e.i(63260),d=e.i(60827),u=e.i(41500),h=e.i(3004),m=e.i(97487),f=t([l,d,u,h,m]);[l,d,u,h,m]=f.then?(await f)():f;let g=(0,c.createLogger)({component:"FacilitatorRouter"}),w={maxDataAgeHours:parseFloat(process.env.X402SCAN_MAX_DATA_AGE_HOURS??"4"),minInvocationsHighConfidence:parseInt(process.env.X402SCAN_MIN_INVOCATIONS_HIGH??"1000",10),minInvocationsMediumConfidence:parseInt(process.env.X402SCAN_MIN_INVOCATIONS_MEDIUM??"100",10),x402scanScoreWeight:parseFloat(process.env.X402SCAN_SCORE_WEIGHT??"0.3"),timeframe:process.env.X402SCAN_TIMEFRAME??"1d",logExplanations:"false"!==process.env.X402SCAN_LOG_EXPLANATIONS},y={scatteringScoreWeight:parseFloat(process.env.SCATTERING_SCORE_WEIGHT??"0.2"),minTxCount3d:parseInt(process.env.SCATTERING_MIN_TX_3D??"100",10),maxDataAgeHours:parseFloat(process.env.SCATTERING_MAX_DATA_AGE_HOURS??"24"),logScatteringMetrics:"false"!==process.env.SCATTERING_LOG_METRICS},_={persistedScoreWeight:parseFloat(process.env.PERSISTED_SCORE_WEIGHT??"0.3"),minConfidence:parseFloat(process.env.PERSISTED_SCORE_MIN_CONFIDENCE??"0.5"),enableExperimentAdjustments:"false"!==process.env.ENABLE_EXPERIMENT_ADJUSTMENTS,logPersistedScore:"false"!==process.env.LOG_PERSISTED_SCORE};class E{facilitators=new Map;facilitatorHealth=new Map;healthCheckInterval=null;constructor(){this.registerFacilitator((0,a.getCDPFacilitatorAdapter)()),this.registerFacilitator((0,i.getPayAIFacilitator)()),"false"!==process.env.X402RS_ENABLED&&(this.registerFacilitator((0,s.getX402rsFacilitator)()),g.info({facilitatorId:"x402rs",url:"https://facilitator.x402.rs"},"X402rs facilitator registered")),"false"!==process.env.DEXTER_ENABLED&&(this.registerFacilitator((0,o.getDexterFacilitator)()),g.info({facilitatorId:"dexter",url:"https://facilitator.dexter.cash"},"Dexter facilitator registered")),"false"!==process.env.CRONOS_ENABLED&&(this.registerFacilitator((0,n.getCronosFacilitator)()),g.info({facilitatorId:"cronos",url:"https://facilitator.cronoslabs.org"},"Cronos x402 facilitator registered")),"true"===process.env.ENABLE_DUMMY_FACILITATOR&&g.error("ENABLE_DUMMY_FACILITATOR is set but ignored in production environment"),this.startHealthChecks()}registerFacilitator(e){this.facilitators.set(e.id,e),g.info({facilitatorId:e.id,name:e.name},"Facilitator registered")}unregisterFacilitator(e){this.facilitators.delete(e),this.facilitatorHealth.delete(e),g.info({facilitatorId:e},"Facilitator unregistered")}getFacilitators(){return Array.from(this.facilitators.values())}async routePayment(e,t,r){if(t?.facilitatorStrategy&&"auto"!==t.facilitatorStrategy){let r=this.facilitators.get(t.facilitatorStrategy);if(r&&r.config.enabled)if(r.supports(e.network,e.asset,e.scheme,e.settlementMode))return g.info({facilitatorId:r.id,facilitatorUrl:r.config.healthCheckUrl,strategy:t.facilitatorStrategy,network:e.network,asset:e.asset,mode:"explicit",msg:"Facilitator selected via explicit strategy"}),r;else g.warn({facilitatorId:t.facilitatorStrategy,network:e.network,asset:e.asset,msg:"Explicit facilitator does not support requested network/asset, falling back to auto"});else g.warn({facilitatorId:t.facilitatorStrategy,enabled:r?.config.enabled,msg:"Explicit facilitator not found or disabled, falling back to auto"})}let a=this.getEligibleFacilitators(e,t,r);if(0===a.length)throw Error(`No eligible facilitator found for ${e.network}/${e.asset}/${e.scheme}`);let i=await this.scoreFacilitators(a,e,t,r),s=i[0].facilitator,o=i[0].x402scanExplanation;if(o&&w.logExplanations&&g.info({facilitatorId:s.id,x402scan:{selected:!0,score:o.score,confidence:o.confidence,shortReason:o.shortReason,metrics:o.metrics},msg:"x402scan routing explanation"}),i.length>1&&w.logExplanations){let e=i.slice(1,4).map(e=>({id:e.facilitator.id,score:e.score,x402scan:e.x402scanExplanation?{score:e.x402scanExplanation.score,confidence:e.x402scanExplanation.confidence,shortReason:e.x402scanExplanation.shortReason}:null}));g.debug({alternatives:e,msg:"Alternative facilitators considered"})}return g.info({facilitatorId:s.id,facilitatorUrl:s.config.healthCheckUrl,score:i[0].score,x402scanScore:o?.score,x402scanConfidence:o?.confidence,alternatives:i.length-1,reasons:i[0].reasons,strategy:t?.facilitatorStrategy||"auto",mode:"auto",constraints:{preferences:t?{priority:t.priority,preferredNetworks:t.preferredNetworks,preferredAssets:t.preferredAssets,facilitatorStrategy:t.facilitatorStrategy}:void 0,settlementMode:e.settlementMode},candidates:i.map(e=>({id:e.facilitator.id,url:e.facilitator.config.healthCheckUrl,score:e.score,reasons:e.reasons})),msg:"Facilitator selected"}),s}getEligibleFacilitators(e,t,r){return Array.from(this.facilitators.values()).filter(a=>{let i=!1,s=!1;if(i=e.networks&&e.networks.length>0?e.networks.some(e=>a.supportsCAIPNetwork(e)):a.config.networks.includes(e.network),s=e.assets&&e.assets.length>0?e.assets.some(e=>a.supportsCAIPAsset(e)):a.config.assets.includes(e.asset),!i||!s||!a.supports(e.network,e.asset,e.scheme,e.settlementMode)||!a.config.enabled)return!1;let o=[...t?.preferredNetworks||[],...t?.preferredNetworksCAIP||[]];if(o.length>0){let e=[...a.config.networks,...a.config.networksCAIP||[]];if(!o.some(t=>e.some(e=>e.includes(t)||t.includes(e))))return!1}let n=[...t?.avoidNetworks||[],...t?.avoidNetworksCAIP||[]];if(n.length>0){let e=[...a.config.networks,...a.config.networksCAIP||[]];if(n.some(t=>e.some(e=>e.includes(t)||t.includes(e))))return!1}let c=[...t?.preferredAssets||[],...t?.preferredAssetsCAIP||[]];if(c.length>0){let e=[...a.config.assets,...a.config.assetsCAIP||[]];if(!c.some(t=>e.some(e=>e.includes(t)||t.includes(e))))return!1}if(t?.jurisdiction,t?.settlementMode&&a.config.settlementModes&&!a.config.settlementModes.includes(t.settlementMode))return!1;if(r?.requireHealthCheck){let e=this.facilitatorHealth.get(a.id);if(!e||!e.healthy)return!1}if(r?.customRules&&!r.customRules(a,e))return!1;if(t?.requireCompliance||r?.requireKYC){let e=a.config.metadata;if(!e?.kytEnabled&&!e?.ofacEnabled)return!1}return!0})}async scoreFacilitators(e,t,r,a){let i=(await Promise.all(e.map(async e=>{let i,s,o=100,n=[],c=e.config.priority;o+=10*c,n.push(`priority:${c}`);let f=t.network,p=t.asset;try{s=await (0,l.getCurrentHealth)(e.id,f,p,15)}catch(t){g.warn({error:t,facilitatorId:e.id,network:f,token:p},"Failed to get health metrics, using defaults"),s={successRate:1,p95LatencyMs:null,errorRate:0,status:"healthy"}}let E=null,S={trust:!1,reason:"not-fetched"};try{E=await (0,u.getFacilitatorScore)({facilitatorId:e.id,timeframe:w.timeframe}),S=function(e,t=w){return e?e.dataFreshness>t.maxDataAgeHours?{trust:!1,reason:`data-too-old:${e.dataFreshness.toFixed(1)}h`}:e.totalInvocations<t.minInvocationsMediumConfidence?{trust:!1,reason:`insufficient-data:${e.totalInvocations}-invocations`}:e.totalInvocations>=t.minInvocationsHighConfidence?{trust:!0,reason:"high-confidence"}:{trust:!0,reason:"medium-confidence"}:{trust:!1,reason:"no-x402scan-data"}}(E,w),w.logExplanations&&(i=await (0,u.getFacilitatorExplainer)(e.id,{timeframe:w.timeframe}))}catch(t){g.debug({error:t,facilitatorId:e.id},"Failed to get x402scan metrics"),S={trust:!1,reason:"fetch-error"}}let A=50*s.successRate;if(o+=A,n.push(`success-rate:${(100*s.successRate).toFixed(1)}%`),null!==s.p95LatencyMs){let e=.1*s.p95LatencyMs;o-=e,n.push(`p95-latency:${s.p95LatencyMs}ms`)}try{let t=(await (0,d.getFacilitatorCapabilities)(e.id,f,p))[0];if(t){let e=.5*t.fee_bps;o-=e,n.push(`fee:${t.fee_bps}bps`)}}catch(t){g.debug({error:t,facilitatorId:e.id},"Failed to get capabilities for fee scoring")}let I=30*s.errorRate;o-=I,"down"===s.status?(o=-1e3,n.push("status:down"),g.warn({facilitatorId:e.id,network:t.network,token:t.asset},"Refusing to route - facilitator is down")):"degraded"===s.status&&(o-=25,n.push("status:degraded"),g.warn({facilitatorId:e.id,network:t.network,token:t.asset},"Facilitator is degraded - routing with caution"));let v=this.facilitatorHealth.get(e.id);if(v&&!v.healthy&&(o-=30,n.push("cache-unhealthy")),S.trust&&E){let e=(E.score-50)/50,t=30*e*w.x402scanScoreWeight;o+=t,n.push(`x402scan:${E.score}/${S.reason}`),E.successRate>=.99?(o+=10*w.x402scanScoreWeight,n.push("x402scan-excellent")):E.successRate<.9&&(o-=15*w.x402scanScoreWeight,n.push("x402scan-degraded")),void 0!==E.p95LatencyMs&&(E.p95LatencyMs<200?(o+=5*w.x402scanScoreWeight,n.push(`x402scan-fast:${E.p95LatencyMs.toFixed(0)}ms`)):E.p95LatencyMs>1e3&&(o-=10*w.x402scanScoreWeight,n.push(`x402scan-slow:${E.p95LatencyMs.toFixed(0)}ms`)))}else n.push(`x402scan-skipped:${S.reason}`);let D=null,C={trust:!1,reason:"not-fetched"};try{D=await (0,h.getScatteringMetricsForFacilitator)(e.id),C=function(e,t=y){if(!e)return{trust:!1,reason:"no-scattering-data"};let r=(Date.now()-new Date(e.fetchedAt).getTime())/36e5;return r>t.maxDataAgeHours?{trust:!1,reason:`data-too-old:${r.toFixed(1)}h`}:e.txCount3d<t.minTxCount3d?{trust:!1,reason:`low-activity:${e.txCount3d}-txns`}:{trust:!0,reason:"active"}}(D,y)}catch(t){g.debug({error:t,facilitatorId:e.id},"Failed to get Scattering metrics"),C={trust:!1,reason:"fetch-error"}}if(C.trust&&D){let t=(0,h.computeActivityScore)(D),r=(t-.3)*100*y.scatteringScoreWeight;o+=r,n.push(`scattering-activity:${(100*t).toFixed(1)}%`),D.volumeUsd3d>=1e5&&(o+=10*y.scatteringScoreWeight,n.push(`scattering-high-volume:$${(D.volumeUsd3d/1e3).toFixed(1)}K`)),D.uniqueBuyers3d>=1e3&&(o+=5*y.scatteringScoreWeight,n.push(`scattering-high-adoption:${D.uniqueBuyers3d}-buyers`)),void 0!==D.volumeChangeRate&&(D.volumeChangeRate>20?(o+=5*y.scatteringScoreWeight,n.push(`scattering-growing:+${D.volumeChangeRate.toFixed(0)}%`)):D.volumeChangeRate<-50&&(o-=10*y.scatteringScoreWeight,n.push(`scattering-declining:${D.volumeChangeRate.toFixed(0)}%`))),y.logScatteringMetrics&&g.debug({facilitatorId:e.id,scattering:{volumeUsd3d:D.volumeUsd3d,txCount3d:D.txCount3d,uniqueBuyers3d:D.uniqueBuyers3d,activityScore:t.toFixed(3),volumeChangeRate:D.volumeChangeRate},msg:"Scattering metrics applied"})}else n.push(`scattering-skipped:${C.reason}`);try{let t=await (0,m.getEffectiveScore)({facilitator_id:e.id,chain_id:f});if(t&&t.confidence>=_.minConfidence){let r=(t.score-50)*_.persistedScoreWeight;o+=r,n.push(`persisted:${t.score.toFixed(0)}/${t.confidence.toFixed(2)}`),_.logPersistedScore&&g.debug({facilitatorId:e.id,chain_id:f,persisted:{score:t.score,confidence:t.confidence,contribution:r},msg:"Persisted score applied"})}else t?n.push(`persisted-low-confidence:${t.confidence.toFixed(2)}`):n.push("persisted-none");if(_.enableExperimentAdjustments){let t=await (0,m.getExperimentTrafficAdjustment)(e.id,f);t.adjustment>0&&(o+=t.adjustment,n.push(`experiment:${t.experiment_name}:+${t.adjustment.toFixed(1)}`),_.logPersistedScore&&g.debug({facilitatorId:e.id,experiment:t.experiment_name,adjustment:t.adjustment,msg:"Experiment traffic adjustment applied"}))}}catch(t){g.debug({error:t,facilitatorId:e.id},"Failed to get persisted score"),n.push("persisted-error")}if((a?.preferCheapest||r?.priority==="cost")&&await e.getPricing(t.network,t.asset)&&(o+=20,n.push("has-pricing")),r?.priority==="speed"){if(null!==s.p95LatencyMs){let e=Math.max(0,30-s.p95LatencyMs/10);o+=e,n.push(`speed-optimized:${s.p95LatencyMs}ms`)}if(S.trust&&E?.p95LatencyMs!==void 0){let e=Math.max(0,20-E.p95LatencyMs/25);o+=e*w.x402scanScoreWeight}}if(r?.priority==="compliance"||a?.requireKYC){let t=e.config.metadata;t?.kytEnabled&&t?.ofacEnabled&&(o+=30,n.push("compliance-enabled"))}return r?.priority==="reliability"&&("healthy"===s.status&&s.successRate>.95&&(o+=25,n.push("high-reliability")),S.trust&&E&&E.successRate>=.98&&"high"===E.confidence&&(o+=20,n.push("x402scan-proven-reliable"))),t.settlementMode&&e.config.settlementModes?.includes(t.settlementMode)&&(o+=15,n.push(`settlement:${t.settlementMode}`)),{facilitator:e,score:o,reasons:n,x402scanExplanation:i}}))).sort((e,t)=>t.score-e.score);if(i.length>1){let e=i[0].score,t=i.filter(t=>5>=Math.abs(t.score-e));if(t.length>1){for(let e=t.length-1;e>0;e--){let r=Math.floor(Math.random()*(e+1));[t[e],t[r]]=[t[r],t[e]]}let r=i.filter(t=>Math.abs(t.score-e)>5);return[...t,...r]}}return i}startHealthChecks(){this.healthCheckInterval=setInterval(async()=>{await this.checkAllFacilitators()},3e5),this.checkAllFacilitators()}async checkAllFacilitators(){let e=Array.from(this.facilitators.values());await Promise.all(e.map(async e=>{try{let t=await e.getHealth();this.facilitatorHealth.set(e.id,{healthy:t.healthy,lastChecked:Date.now()})}catch(t){g.error({facilitatorId:e.id,error:t},"Health check failed"),this.facilitatorHealth.set(e.id,{healthy:!1,lastChecked:Date.now()})}}))}getFacilitator(e){return this.facilitators.get(e)}getFacilitatorHealth(e){return this.facilitatorHealth.get(e)}destroy(){this.healthCheckInterval&&clearInterval(this.healthCheckInterval)}}let S=null;function p(){return S||(S=new E),S}e.s(["FacilitatorRouter",()=>E,"getFacilitatorRouter",()=>p]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=src_ab5eb711._.js.map
module.exports=[48660,e=>e.a(async(t,r)=>{try{var a=e.i(89171),n=e.i(22632),i=e.i(79832),o=e.i(5522),s=e.i(7087),d=e.i(34006),c=e.i(42137),l=e.i(72847),u=e.i(46868),p=e.i(50377),h=t([i,s,u]);[i,s,u]=h.then?(await h)():h;let y=(0,p.createLogger)({component:"PayAPI"}),f=n.z.object({type:n.z.enum(["card","bank_account","wallet","crypto"]),token:n.z.string().min(1,"Payment method token is required")}),g=n.z.object({merchantId:n.z.string().min(1,"merchantId is required"),amount:n.z.number().int().positive("Amount must be a positive integer (minor units)"),currency:n.z.string().length(3,"Currency must be a 3-letter ISO code").default("USD"),paymentMethod:f,platformId:n.z.string().optional(),orderId:n.z.string().optional(),idempotencyKey:n.z.string().optional(),metadata:n.z.record(n.z.unknown()).optional()});async function m(e){let t=await (0,s.extractRequestContext)(e,"/api/pay");try{if(!(0,c.isSmfConfigured)())return(0,s.createErrorResponse)(t,"Payment service is not configured. Please set SMF_API_KEY.",503,"SERVICE_UNAVAILABLE");let r=await (0,d.rateLimitByApiKey)(e);if(r&&!r.allowed)return y.warn({apiKeyId:t.apiKeyId,limit:r.limit},"Rate limit exceeded"),(0,s.wrapResponse)((0,d.createRateLimitResponse)(r),t);let n=await (0,i.requireAuth)(e,"user");if("response"in n)return(0,s.wrapResponse)(n.response,t);let{apiKey:l}=n;t.apiKeyId=l.id;let p=await (0,o.validateRequestBody)(e,g);if(!p.valid)return(0,o.createValidationErrorResponse)(p);let{merchantId:h,amount:m,currency:f,paymentMethod:R,platformId:E,orderId:w,idempotencyKey:v,metadata:_}=p.data,A=v||(w?`order_${w}`:void 0),I=null;if(A&&(I=await (0,u.getChargeByIdempotencyKey)(A)),!I&&w&&(I=await (0,u.getChargeByOrderId)(w)),I&&"succeeded"===I.status)return y.info({orderId:w,idempotencyKey:A,chargeId:I.id},"Returning existing successful charge (idempotent)"),a.NextResponse.json({success:!0,charge:{id:I.smf_charge_id,status:I.status,amount:I.amount,currency:I.currency,orderId:I.order_id,createdAt:I.created_at},cached:!0});if(I&&["pending","requires_action"].includes(I.status))return y.info({orderId:w,idempotencyKey:A,chargeId:I.id,status:I.status},"Returning existing in-progress charge (idempotent)"),a.NextResponse.json({success:!0,charge:{id:I.smf_charge_id,status:I.status,amount:I.amount,currency:I.currency,orderId:I.order_id,createdAt:I.created_at},cached:!0});let C=E||l.platformId||"plt_default";y.info({merchantId:h,amount:m,currency:f,orderId:w,platformId:C,hasIdempotencyKey:!!A},"Creating SMF charge");let x=await (0,c.withSmfCorrelation)(t.requestId,e=>e.charge({platformId:C,merchantId:h,amount:m,currency:f,paymentMethod:{type:R.type,token:R.token},idempotencyKey:A,metadata:{order_id:w,user_id:l.userId,api_key_id:l.id,..._}}));try{await (0,u.createCharge)({smf_charge_id:x.id,platform_id:C,merchant_id:h,amount:m,currency:f,status:x.status,order_id:w,user_id:l.userId,idempotency_key:A,fees:x.fees,payment_method_type:R.type,metadata:{order_id:w,..._},correlation_id:t.requestId})}catch(e){y.error({smfChargeId:x.id,orderId:w,merchantId:h,amount:m,currency:f,status:x.status,idempotencyKey:A,correlationId:t.requestId,dbError:e instanceof Error?e.message:"Unknown DB error"},"ORPHANED_CHARGE: SMF charge created but DB record failed - requires reconciliation")}y.info({chargeId:x.id,status:x.status,orderId:w},"SMF charge created successfully");let S=a.NextResponse.json({success:!0,charge:{id:x.id,status:x.status,amount:x.amount,currency:x.currency,fees:x.fees,orderId:w,createdAt:x.createdAt,...x.nextAction&&{nextAction:x.nextAction}}});return r&&(0,d.addRateLimitHeaders)(S,r),(0,s.wrapResponse)(S,t)}catch(e){if(e instanceof l.SmfError){let r=(0,c.classifySmfError)(e);y.warn({code:r.code,type:r.type,message:r.message,retryAfter:r.retryAfterSeconds},"SMF charge failed");let n={success:!1,error:{code:r.code,message:(0,c.getUserFriendlyErrorMessage)(r.code),type:r.type},requestId:t.requestId};"temporary"===r.type&&r.retryAfterSeconds&&(n.retryAfter=r.retryAfterSeconds),"validation_error"===r.code&&e.field&&(n.error.field=e.field);let i=a.NextResponse.json(n,{status:r.httpStatus});return(0,s.wrapResponse)(i,t)}return(0,s.createErrorResponse)(t,e instanceof Error?e:Error("Failed to create charge"),500,"INTERNAL_ERROR")}}e.s(["POST",()=>m]),r()}catch(e){r(e)}},!1),94987,e=>e.a(async(t,r)=>{try{var a=e.i(47909),n=e.i(74017),i=e.i(96250),o=e.i(59756),s=e.i(61916),d=e.i(14444),c=e.i(37092),l=e.i(69741),u=e.i(16795),p=e.i(87718),h=e.i(95169),m=e.i(47587),y=e.i(66012),f=e.i(70101),g=e.i(26937),R=e.i(10372),E=e.i(93695);e.i(52474);var w=e.i(220),v=e.i(48660),_=t([v]);[v]=_.then?(await _)():_;let C=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/pay/route",pathname:"/api/pay",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/pay/route.ts",nextConfigOutput:"standalone",userland:v}),{workAsyncStorage:x,workUnitAsyncStorage:S,serverHooks:N}=C;function A(){return(0,i.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:S})}async function I(e,t,r){C.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/pay/route";a=a.replace(/\/index$/,"")||"/";let i=await C.prepare(e,t,{srcPage:a,multiZoneDraftMode:!1});if(!i)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:v,params:_,nextConfig:A,parsedUrl:I,isDraftMode:x,prerenderManifest:S,routerServerContext:N,isOnDemandRevalidate:P,revalidateOnlyGenerated:b,resolvedPathname:q,clientReferenceManifest:O,serverActionsManifest:T}=i,M=(0,l.normalizeAppPath)(a),k=!!(S.dynamicRoutes[M]||S.routes[q]),H=async()=>((null==N?void 0:N.render404)?await N.render404(e,t,I,!1):t.end("This page could not be found"),null);if(k&&!x){let e=!!S.routes[q],t=S.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(A.experimental.adapterPath)return await H();throw new E.NoFallbackError}}let K=null;!k||C.isDev||x||(K=q,K="/index"===K?"/":K);let U=!0===C.isDev||!k,D=k&&!U;T&&O&&(0,d.setReferenceManifestsSingleton)({page:a,clientReferenceManifest:O,serverActionsManifest:T,serverModuleMap:(0,c.createServerModuleMap)({serverActionsManifest:T})});let F=e.method||"GET",j=(0,s.getTracer)(),z=j.getActiveScopeSpan(),B={params:_,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!A.experimental.authInterrupts},cacheComponents:!!A.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:A.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>C.onRequestError(e,t,a,N)},sharedContext:{buildId:v}},L=new u.NodeNextRequest(e),$=new u.NodeNextResponse(t),V=p.NextRequestAdapter.fromNodeNextRequest(L,(0,p.signalFromNodeResponse)(t));try{let i=async e=>C.handle(V,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=j.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==h.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${F} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${F} ${a}`)}),d=!!(0,o.getRequestMeta)(e,"minimalMode"),c=async o=>{var s,c;let l=async({previousCacheEntry:n})=>{try{if(!d&&P&&b&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await i(o);e.fetchMetrics=B.renderOpts.fetchMetrics;let s=B.renderOpts.pendingWaitUntil;s&&r.waitUntil&&(r.waitUntil(s),s=void 0);let c=B.renderOpts.collectedTags;if(!k)return await (0,y.sendResponse)(L,$,a,B.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(a.headers);c&&(t[R.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,n=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==n?void 0:n.isStale)&&await C.onRequestError(e,t,{routerKind:"App Router",routePath:a,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:P})},N),t}},u=await C.handleResponse({req:e,nextConfig:A,cacheKey:K,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:P,revalidateOnlyGenerated:b,responseGenerator:l,waitUntil:r.waitUntil,isMinimalMode:d});if(!k)return null;if((null==u||null==(s=u.value)?void 0:s.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(c=u.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});d||t.setHeader("x-nextjs-cache",P?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,f.fromNodeOutgoingHttpHeaders)(u.value.headers);return d&&k||p.delete(R.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,g.getCacheControlHeader)(u.cacheControl)),await (0,y.sendResponse)(L,$,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};z?await c(z):await j.withPropagatedContext(e.headers,()=>j.trace(h.BaseServerSpan.handleRequest,{spanName:`${F} ${a}`,kind:s.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},c))}catch(t){if(t instanceof E.NoFallbackError||await C.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:P})}),k)throw t;return await (0,y.sendResponse)(L,$,new Response(null,{status:500})),null}}e.s(["handler",()=>I,"patchFetch",()=>A,"routeModule",()=>C,"serverHooks",()=>N,"workAsyncStorage",()=>x,"workUnitAsyncStorage",()=>S]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=_75d28263._.js.map
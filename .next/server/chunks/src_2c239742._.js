module.exports=[85910,t=>t.a(async(e,a)=>{try{var r=t.i(24924),i=t.i(50377),o=e([r]);function s(t){return t&&void 0!==t.pool}[r]=o.then?(await o)():o;let h=(0,i.createLogger)({component:"FacilitatorRegistrationDB"});async function n(t){let e=(0,r.getDb)(),a=`fac_${crypto.randomUUID().replace(/-/g,"").substring(0,16)}`,i=new Date().toISOString();if(s(e)){if((await e.pool.query("SELECT id FROM facilitators WHERE domain = $1",[t.domain])).rows.length>0)throw Error("DOMAIN_ALREADY_REGISTERED");return(await e.pool.query(`INSERT INTO facilitators (
        id, name, status, base_url, priority, domain, dns_txt_proof, callback_url,
        registration_status, canary_traffic_share, max_traffic_share,
        supported_chains, supported_tokens, registered_by, created_at, updated_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16)
      RETURNING *`,[a,t.name,"testing",t.callback_url,100,t.domain,t.dns_txt_proof,t.callback_url,"pending",.01,.2,JSON.stringify(t.supported_chains),JSON.stringify(t.supported_tokens),t.registered_by,i,i])).rows[0]}if(e.prepare("SELECT id FROM facilitators WHERE domain = ?").get(t.domain))throw Error("DOMAIN_ALREADY_REGISTERED");return e.prepare(`
      INSERT INTO facilitators (
        id, name, status, base_url, priority, domain, dns_txt_proof, callback_url,
        registration_status, canary_traffic_share, max_traffic_share,
        supported_chains, supported_tokens, registered_by, created_at, updated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(a,t.name,"testing",t.callback_url,100,t.domain,t.dns_txt_proof,t.callback_url,"pending",.01,.2,JSON.stringify(t.supported_chains),JSON.stringify(t.supported_tokens),t.registered_by,i,i),e.prepare("SELECT * FROM facilitators WHERE id = ?").get(a)}async function _(t){let e=(0,r.getDb)();return s(e)?(await e.pool.query("SELECT * FROM facilitators WHERE id = $1",[t])).rows[0]||null:e.prepare("SELECT * FROM facilitators WHERE id = ?").get(t)||null}async function c(t){let e=(0,r.getDb)();return s(e)?(await e.pool.query("SELECT * FROM facilitators WHERE domain = $1",[t])).rows[0]||null:e.prepare("SELECT * FROM facilitators WHERE domain = ?").get(t)||null}async function d(t,e,a){let i=(0,r.getDb)(),o=new Date().toISOString();s(i)?await i.pool.query(`UPDATE facilitators 
       SET registration_status = $1, verified_at = $2, updated_at = $3
       WHERE id = $4`,[e,a?.toISOString()||null,o,t]):i.prepare(`
      UPDATE facilitators 
      SET registration_status = ?, verified_at = ?, updated_at = ?
      WHERE id = ?
    `).run(e,a?.toISOString()||null,o,t),h.info({facilitator_id:t,registration_status:e},"Facilitator status updated")}async function l(t,e,a){let i=(0,r.getDb)(),o=new Date().toISOString();s(i)?void 0!==a?await i.pool.query(`UPDATE facilitators 
         SET canary_traffic_share = $1, max_traffic_share = $2, updated_at = $3
         WHERE id = $4`,[e,a,o,t]):await i.pool.query(`UPDATE facilitators 
         SET canary_traffic_share = $1, updated_at = $2
         WHERE id = $3`,[e,o,t]):void 0!==a?i.prepare(`
        UPDATE facilitators 
        SET canary_traffic_share = ?, max_traffic_share = ?, updated_at = ?
        WHERE id = ?
      `).run(e,a,o,t):i.prepare(`
        UPDATE facilitators 
        SET canary_traffic_share = ?, updated_at = ?
        WHERE id = ?
      `).run(e,o,t),h.info({facilitator_id:t,canary_traffic_share:e,max_traffic_share:a},"Canary share updated")}async function u(t){let e=(0,r.getDb)(),a=crypto.randomUUID(),i=new Date().toISOString();s(e)?await e.pool.query(`INSERT INTO facilitator_verification_attempts 
       (id, facilitator_id, attempt_type, status, ip_address, details, created_at)
       VALUES ($1, $2, $3, $4, $5, $6, $7)`,[a,t.facilitator_id,t.attempt_type,t.status,t.ip_address,JSON.stringify(t.details||{}),i]):e.prepare(`
      INSERT INTO facilitator_verification_attempts 
      (id, facilitator_id, attempt_type, status, ip_address, details, created_at)
      VALUES (?, ?, ?, ?, ?, ?, ?)
    `).run(a,t.facilitator_id,t.attempt_type,t.status,t.ip_address,JSON.stringify(t.details||{}),i)}async function f(t,e,a=60){let i=(0,r.getDb)(),o=new Date(Date.now()-60*a*1e3).toISOString();return s(i)?(await i.pool.query(`SELECT * FROM facilitator_verification_attempts 
       WHERE facilitator_id = $1 
         AND attempt_type = $2 
         AND created_at > $3
       ORDER BY created_at DESC`,[t,e,o])).rows.map(p):i.prepare(`
      SELECT * FROM facilitator_verification_attempts 
      WHERE facilitator_id = ? 
        AND attempt_type = ? 
        AND created_at > ?
      ORDER BY created_at DESC
    `).all(t,e,o).map(p)}function p(t){return{id:t.id,facilitator_id:t.facilitator_id,attempt_type:t.attempt_type,status:t.status,ip_address:t.ip_address,details:"string"==typeof t.details?JSON.parse(t.details):t.details,created_at:new Date(t.created_at)}}async function m(t,e=7){let a=(0,r.getDb)(),i=new Date(Date.now()-86400*e*1e3).toISOString();return s(a)?(await a.pool.query(`SELECT * FROM canary_metrics 
       WHERE facilitator_id = $1 AND period_start >= $2
       ORDER BY period_start DESC`,[t,i])).rows.map(E):a.prepare(`
      SELECT * FROM canary_metrics 
      WHERE facilitator_id = ? AND period_start >= ?
      ORDER BY period_start DESC
    `).all(t,i).map(E)}function E(t){return{id:t.id,facilitator_id:t.facilitator_id,period_start:new Date(t.period_start),period_end:new Date(t.period_end),requests:t.requests,success_rate:t.success_rate,avg_latency_ms:t.avg_latency_ms,error_rate:t.error_rate,created_at:new Date(t.created_at)}}async function g(t){let e=(0,r.getDb)(),a=crypto.randomUUID(),i=new Date().toISOString();if(s(e)){let r=await e.pool.query(`INSERT INTO facilitator_promotions 
       (id, facilitator_id, from_share, to_share, reason, metrics_snapshot, promoted_at)
       VALUES ($1, $2, $3, $4, $5, $6, $7)
       RETURNING *`,[a,t.facilitator_id,t.from_share,t.to_share,t.reason,JSON.stringify(t.metrics_snapshot),i]);return y(r.rows[0])}{e.prepare(`
      INSERT INTO facilitator_promotions 
      (id, facilitator_id, from_share, to_share, reason, metrics_snapshot, promoted_at)
      VALUES (?, ?, ?, ?, ?, ?, ?)
    `).run(a,t.facilitator_id,t.from_share,t.to_share,t.reason,JSON.stringify(t.metrics_snapshot),i);let r=e.prepare("SELECT * FROM facilitator_promotions WHERE id = ?").get(a);return y(r)}}function y(t){return{id:t.id,facilitator_id:t.facilitator_id,from_share:t.from_share,to_share:t.to_share,reason:t.reason,metrics_snapshot:"string"==typeof t.metrics_snapshot?JSON.parse(t.metrics_snapshot):t.metrics_snapshot,promoted_at:new Date(t.promoted_at)}}async function T(t){let e=(0,r.getDb)(),a=crypto.randomUUID(),i=new Date().toISOString();s(e)?await e.pool.query(`INSERT INTO facilitator_callback_tests 
       (id, facilitator_id, status, response_code, response_time_ms, error_message, created_at)
       VALUES ($1, $2, $3, $4, $5, $6, $7)`,[a,t.facilitator_id,t.status,t.response_code||null,t.response_time_ms||null,t.error_message||null,i]):e.prepare(`
      INSERT INTO facilitator_callback_tests 
      (id, facilitator_id, status, response_code, response_time_ms, error_message, created_at)
      VALUES (?, ?, ?, ?, ?, ?, ?)
    `).run(a,t.facilitator_id,t.status,t.response_code||null,t.response_time_ms||null,t.error_message||null,i)}t.s(["createFacilitatorRegistration",()=>n,"getCanaryMetricsForPeriod",()=>m,"getFacilitatorByDomain",()=>c,"getFacilitatorById",()=>_,"getRecentVerificationAttempts",()=>f,"recordCallbackTest",()=>T,"recordPromotion",()=>g,"recordVerificationAttempt",()=>u,"updateCanaryShare",()=>l,"updateFacilitatorStatus",()=>d]),a()}catch(t){a(t)}},!1),49858,t=>{"use strict";function e(t){if(!t||"object"!=typeof t||"string"!=typeof t.name||!t.name.trim()||"string"!=typeof t.domain||!t.domain.trim()||"string"!=typeof t.dns_txt_proof||!t.dns_txt_proof.trim()||"string"!=typeof t.callback_url||!t.callback_url.trim()||!/^[a-z0-9]([a-z0-9-]*[a-z0-9])?(\.[a-z0-9]([a-z0-9-]*[a-z0-9])?)*$/i.test(t.domain))return!1;try{let e=new URL(t.callback_url);if("https:"!==e.protocol)return!1}catch{return!1}return!!t.dns_txt_proof.startsWith("nexflow-verify=")&&!!Array.isArray(t.supported_chains)&&0!==t.supported_chains.length&&!!Array.isArray(t.supported_tokens)&&0!==t.supported_tokens.length&&!!t.supported_chains.every(t=>"string"==typeof t)&&!!t.supported_tokens.every(t=>"string"==typeof t)&&!0}t.s(["DEFAULT_PROMOTION_THRESHOLDS",0,{min_days:7,min_success_rate:.95,max_error_rate:.05,min_requests:100},"DEFAULT_RATE_LIMIT",0,{max_attempts:5,window_minutes:60,cooldown_minutes:10},"PROMOTION_LEVELS",0,[{share:.01,min_requests:0},{share:.05,min_requests:100},{share:.2,min_requests:500}],"isValidRegistrationRequest",()=>e])},52751,t=>t.a(async(e,a)=>{try{var r=t.i(50377),i=t.i(85910),o=t.i(49858),s=e([i]);[i]=s.then?(await s)():s;let c=(0,r.createLogger)({component:"FacilitatorRegistry"}),d={resolveTxt:async e=>(await t.A(57408).then(t=>t.promises)).resolveTxt(e)};class l{dnsProvider;constructor(t=d){this.dnsProvider=t}async register(t,e){if(c.info({domain:t.domain,name:t.name},"Registering new facilitator"),await (0,i.getFacilitatorByDomain)(t.domain))throw Error("DOMAIN_ALREADY_REGISTERED");let a=await (0,i.createFacilitatorRegistration)({name:t.name,domain:t.domain,dns_txt_proof:t.dns_txt_proof,callback_url:t.callback_url,supported_chains:t.supported_chains,supported_tokens:t.supported_tokens,registered_by:e});return c.info({facilitator_id:a.id,domain:t.domain},"Facilitator registered"),{facilitator_id:a.id,status:"pending",dns_verification_required:!0,dns_record:{type:"TXT",name:`_nexflow.${t.domain}`,value:t.dns_txt_proof}}}async verifyDNS(t,e){let a;c.info({facilitator_id:t,ipAddress:e},"Starting DNS verification");let r=await (0,i.getFacilitatorById)(t);if(!r)throw Error("FACILITATOR_NOT_FOUND");if("verified"===r.registration_status)return{facilitator_id:t,status:"verified",verified_at:r.verified_at?new Date(r.verified_at):void 0,canary_traffic_share:r.canary_traffic_share,max_traffic_share:r.max_traffic_share};let o=await this.checkRateLimit(t,"dns_lookup",e);if(o.limited)return{facilitator_id:t,status:"pending",canary_traffic_share:r.canary_traffic_share,max_traffic_share:r.max_traffic_share,error:o.error,next_attempt_at:o.next_attempt_at};let s=!1;try{let t=`_nexflow.${r.domain}`;c.debug({dnsName:t},"Looking up DNS TXT record");let e=await this.dnsProvider.resolveTxt(t);(s=e.some(t=>t.join("").includes(r.dns_txt_proof||"")))||(a="DNS TXT record does not match expected proof",c.debug({dnsName:t,expected:r.dns_txt_proof,found:e},"DNS proof mismatch"))}catch(t){a=`DNS lookup failed: ${t instanceof Error?t.message:"Unknown error"}`,c.debug({error:t,domain:r.domain},"DNS lookup failed")}if(!s)return await (0,i.recordVerificationAttempt)({facilitator_id:t,attempt_type:"dns_lookup",status:"failed",ip_address:e,details:{error:a}}),{facilitator_id:t,status:"pending",canary_traffic_share:r.canary_traffic_share,max_traffic_share:r.max_traffic_share,error:a};let n=await this.validateCallback(t,r.callback_url||"");if(!n.valid)return{facilitator_id:t,status:"pending",canary_traffic_share:r.canary_traffic_share,max_traffic_share:r.max_traffic_share,error:n.error};await (0,i.recordVerificationAttempt)({facilitator_id:t,attempt_type:"dns_lookup",status:"success",ip_address:e});let _=new Date;return await (0,i.updateFacilitatorStatus)(t,"verified",_),c.info({facilitator_id:t,domain:r.domain},"Facilitator verified"),{facilitator_id:t,status:"verified",verified_at:_,canary_traffic_share:r.canary_traffic_share,max_traffic_share:r.max_traffic_share}}async checkRateLimit(t,e,a){let r=await (0,i.getRecentVerificationAttempts)(t,e,o.DEFAULT_RATE_LIMIT.window_minutes);if(r.length>=o.DEFAULT_RATE_LIMIT.max_attempts)return await (0,i.recordVerificationAttempt)({facilitator_id:t,attempt_type:e,status:"rate_limited",ip_address:a}),c.warn({facilitator_id:t,attempts:r.length},"Rate limit exceeded"),{limited:!0,error:`Rate limit exceeded: max ${o.DEFAULT_RATE_LIMIT.max_attempts} attempts per hour`};if(r.length>0){let s=r[0].created_at,n=(Date.now()-s.getTime())/6e4;if(n<o.DEFAULT_RATE_LIMIT.cooldown_minutes){let r=new Date(s.getTime()+6e4*o.DEFAULT_RATE_LIMIT.cooldown_minutes);return await (0,i.recordVerificationAttempt)({facilitator_id:t,attempt_type:e,status:"cooldown",ip_address:a,details:{next_attempt_at:r.toISOString()}}),c.debug({facilitator_id:t,nextAttemptAt:r},"Cooldown active"),{limited:!0,error:`Cooldown active: wait ${Math.ceil(o.DEFAULT_RATE_LIMIT.cooldown_minutes-n)} minutes`,next_attempt_at:r}}}return{limited:!1}}async validateCallback(t,e){if(!e)return{valid:!1,error:"No callback URL configured"};c.debug({facilitator_id:t,callback_url:e},"Testing callback URL");try{let a={event:"test_ping",timestamp:new Date().toISOString(),facilitator_id:t,test:!0},r=new AbortController,o=setTimeout(()=>r.abort(),5e3),s=Date.now();try{let o=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","User-Agent":"NexFlow-Verification/1.0"},body:JSON.stringify(a),signal:r.signal}),n=Date.now()-s;if(!o.ok)return await (0,i.recordCallbackTest)({facilitator_id:t,status:"failed",response_code:o.status,response_time_ms:n,error_message:`HTTP ${o.status}`}),{valid:!1,error:`Callback returned HTTP ${o.status}`};return await (0,i.recordCallbackTest)({facilitator_id:t,status:"success",response_code:o.status,response_time_ms:n}),c.debug({facilitator_id:t,responseTime:n},"Callback test successful"),{valid:!0}}finally{clearTimeout(o)}}catch(r){let e=r instanceof Error?r.message:"Unknown error",a=r instanceof DOMException&&"AbortError"===r.name;return await (0,i.recordCallbackTest)({facilitator_id:t,status:a?"timeout":"failed",error_message:e}),c.debug({facilitator_id:t,error:e},"Callback test failed"),{valid:!1,error:a?"Callback request timed out (5s)":`Callback error: ${e}`}}}async evaluateCanaryPromotion(t){c.debug({facilitator_id:t},"Evaluating canary promotion");let e=await (0,i.getFacilitatorById)(t);if(!e)return c.warn({facilitator_id:t},"Facilitator not found for promotion evaluation"),!1;if("verified"!==e.registration_status)return!1;let a=await (0,i.getCanaryMetricsForPeriod)(t,o.DEFAULT_PROMOTION_THRESHOLDS.min_days);if(a.length<o.DEFAULT_PROMOTION_THRESHOLDS.min_days)return c.debug({facilitator_id:t,days:a.length},"Not enough data for promotion"),!1;let r=a.reduce((t,e)=>t+e.success_rate,0)/a.length,s=a.reduce((t,e)=>t+e.error_rate,0)/a.length,n=a.reduce((t,e)=>t+e.requests,0);if(!(r>=o.DEFAULT_PROMOTION_THRESHOLDS.min_success_rate&&s<=o.DEFAULT_PROMOTION_THRESHOLDS.max_error_rate&&n>=o.DEFAULT_PROMOTION_THRESHOLDS.min_requests))return c.debug({facilitator_id:t,avgSuccessRate:r,avgErrorRate:s,totalRequests:n},"Not eligible for promotion"),!1;let _=e.canary_traffic_share,d=_;for(let t=0;t<o.PROMOTION_LEVELS.length-1;t++)if(_<=o.PROMOTION_LEVELS[t].share&&n>=o.PROMOTION_LEVELS[t+1].min_requests){d=Math.min(o.PROMOTION_LEVELS[t+1].share,e.max_traffic_share);break}return d<=_?(c.debug({facilitator_id:t,currentShare:_},"Already at max promotion level"),!1):(await (0,i.recordPromotion)({facilitator_id:t,from_share:_,to_share:d,reason:"auto_promotion",metrics_snapshot:{avg_success_rate:r,avg_error_rate:s,total_requests:n,days_running:a.length}}),await (0,i.updateCanaryShare)(t,d),c.info({facilitator_id:t,from_share:_,to_share:d},"Facilitator promoted"),!0)}async getFacilitatorStatus(t){let e,a=await (0,i.getFacilitatorById)(t);if(!a)throw Error("FACILITATOR_NOT_FOUND");let r=await (0,i.getCanaryMetricsForPeriod)(t,7);if(r.length>0){let t=r.reduce((t,e)=>t+e.success_rate,0)/r.length,a=r.reduce((t,e)=>t+e.error_rate,0)/r.length,i=r.reduce((t,e)=>t+e.avg_latency_ms,0)/r.length,s=r.reduce((t,e)=>t+e.requests,0),n=t>=o.DEFAULT_PROMOTION_THRESHOLDS.min_success_rate&&a<=o.DEFAULT_PROMOTION_THRESHOLDS.max_error_rate&&s>=o.DEFAULT_PROMOTION_THRESHOLDS.min_requests&&r.length>=o.DEFAULT_PROMOTION_THRESHOLDS.min_days;e={days_running:r.length,success_rate:t,avg_latency_ms:i,requests_processed:s,error_rate:a,next_review_at:new Date(Date.now()+864e5),eligible_for_promotion:n,promotion_reason:n?`Consistent ${Math.round(100*t)}% success over ${r.length} days`:void 0}}return{facilitator_id:t,name:a.name,domain:a.domain||"",base_url:a.base_url,registration_status:a.registration_status,verified_at:a.verified_at?new Date(a.verified_at):void 0,canary_traffic_share:a.canary_traffic_share,max_traffic_share:a.max_traffic_share,canary_metrics:e,supported_chains:n(a.supported_chains),supported_tokens:n(a.supported_tokens),created_at:new Date(a.created_at)}}async pause(t){if(!await (0,i.getFacilitatorById)(t))throw Error("FACILITATOR_NOT_FOUND");await (0,i.updateFacilitatorStatus)(t,"paused"),c.info({facilitator_id:t},"Facilitator paused")}async resume(t){let e=await (0,i.getFacilitatorById)(t);if(!e)throw Error("FACILITATOR_NOT_FOUND");if("paused"!==e.registration_status)throw Error("FACILITATOR_NOT_PAUSED");await (0,i.updateFacilitatorStatus)(t,"verified",new Date(e.verified_at||Date.now())),c.info({facilitator_id:t},"Facilitator resumed")}async reject(t,e){if(!await (0,i.getFacilitatorById)(t))throw Error("FACILITATOR_NOT_FOUND");await (0,i.updateFacilitatorStatus)(t,"rejected"),c.info({facilitator_id:t,reason:e},"Facilitator rejected")}}function n(t){if(!t)return[];try{let e="string"==typeof t?JSON.parse(t):t;return Array.isArray(e)?e:[]}catch{return[]}}let u=null;function _(){return u||(u=new l),u}t.s(["getFacilitatorRegistry",()=>_]),a()}catch(t){a(t)}},!1)];

//# sourceMappingURL=src_2c239742._.js.map
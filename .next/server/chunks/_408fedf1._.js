module.exports=[73798,e=>e.a(async(t,a)=>{try{var r=e.i(50377),n=e.i(30056),o=t([n]);[n]=o.then?(await o)():o;let i=(0,r.createLogger)({component:"NexflowMetricsService"}),l=null;async function s(e){let t=e.timeframe??"1d",a=function(e){switch(e){case"1h":return"1 hour";case"6h":return"6 hours";case"1d":default:return"1 day";case"7d":return"7 days"}}(t),r=function(){if(l)return l;let e=process.env.DATABASE_URL;return e&&e.startsWith("postgresql://")?l=new n.Pool({connectionString:e,max:5,idleTimeoutMillis:3e4,connectionTimeoutMillis:5e3}):null}();if(!r)return i.warn("Database not available for NexFlow metrics"),{ok:!0,timeframe:t,metrics:[],timestamp:new Date().toISOString()};try{let n=`
      WITH attempts AS (
        SELECT 
          ra.facilitator_id,
          r.network,
          COALESCE(
            CASE 
              WHEN r.correlation_id LIKE 'agent:%' THEN 
                CASE 
                  WHEN r.correlation_id LIKE '%dogfood%' THEN 'dogfood'
                  WHEN r.correlation_id LIKE '%scout%' THEN 'scout'
                  ELSE 'external'
                END
              ELSE 'external'
            END,
            'unknown'
          ) as agent_type,
          ra.result,
          ra.latency_ms,
          ra.created_at
        FROM smf_route_attempts ra
        JOIN smf_routes r ON ra.route_id = r.id
        WHERE ra.created_at > NOW() - INTERVAL '${a}'
          AND ra.is_probe = false
    `,o=[],s=1;e.facilitatorId&&(n+=` AND ra.facilitator_id = $${s}`,o.push(e.facilitatorId),s++),e.network&&(n+=` AND r.network = $${s}`,o.push(e.network),s++),n+=`
      ),
      aggregated AS (
        SELECT 
          facilitator_id,
          network,
          agent_type,
          COUNT(*) as total_attempts,
          SUM(CASE WHEN result = 'success' THEN 1 ELSE 0 END) as success_count,
          AVG(latency_ms) as avg_latency,
          PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY latency_ms) as p95_latency,
          MAX(created_at) as last_updated
        FROM attempts
        GROUP BY facilitator_id, network, agent_type
      )
      SELECT 
        facilitator_id,
        network,
        agent_type,
        total_attempts,
        success_count,
        avg_latency,
        p95_latency,
        last_updated
      FROM aggregated
      ORDER BY facilitator_id, network, agent_type
    `;let l=await r.query(n,o),c=new Map;for(let e of l.rows){let t=`${e.facilitator_id}:${e.network}`;c.has(t)||c.set(t,{facilitatorId:e.facilitator_id,network:e.network,successRateNexflow:0,invocationsNexflow:0,byAgentType:{},lastUpdated:e.last_updated?.toISOString()??new Date().toISOString()});let a=c.get(t),r=e.agent_type,n=parseInt(e.total_attempts)||0,o=parseInt(e.success_count)||0,s=n>0?o/n:0;a.byAgentType[r]={invocations:n,successRate:Math.round(1e3*s)/1e3,avgLatencyMs:e.avg_latency?Math.round(e.avg_latency):void 0},a.invocationsNexflow+=n,e.p95_latency&&(!a.p95LatencyNexflow||e.p95_latency>a.p95LatencyNexflow)&&(a.p95LatencyNexflow=Math.round(e.p95_latency))}for(let e of c.values()){let t=0,a=0;for(let r of Object.values(e.byAgentType))r&&(a+=r.invocations,t+=r.invocations*r.successRate);e.successRateNexflow=a>0?Math.round(t/a*1e3)/1e3:0}let u=Array.from(c.values());return i.info({timeframe:t,facilitatorCount:u.length,totalInvocations:u.reduce((e,t)=>e+t.invocationsNexflow,0),msg:"NexFlow metrics aggregated"}),{ok:!0,timeframe:t,metrics:u,timestamp:new Date().toISOString()}}catch(e){return i.error({error:e instanceof Error?e.message:"Unknown error",msg:"Failed to get NexFlow metrics"}),{ok:!0,timeframe:t,metrics:[],timestamp:new Date().toISOString()}}}e.s(["getNexflowMetrics",()=>s]),a()}catch(e){a(e)}},!1),2332,e=>e.a(async(t,a)=>{try{var r=e.i(89171),n=e.i(50377),o=e.i(73798),s=t([o]);[o]=s.then?(await s)():s;let c=(0,n.createLogger)({component:"PublicSmfNexflowMetrics"}),u=["1h","6h","1d","7d"];async function i(e){try{let{searchParams:t}=new URL(e.url),a=t.get("facilitatorId")??void 0,n=t.get("network")??void 0,s=t.get("timeframe")??"1d";if(!u.includes(s))return r.NextResponse.json({error:`Invalid timeframe: ${s}. Must be one of: ${u.join(", ")}`},{status:400});let i=await (0,o.getNexflowMetrics)({facilitatorId:a,network:n,timeframe:s});return c.info({facilitatorId:a,network:n,timeframe:s,metricsCount:i.metrics.length,totalInvocations:i.metrics.reduce((e,t)=>e+t.invocationsNexflow,0),msg:"Public SMF NexFlow metrics request"}),r.NextResponse.json(i,{status:200,headers:{"Content-Type":"application/json","Cache-Control":"public, max-age=60, s-maxage=60","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, OPTIONS","Access-Control-Allow-Headers":"Content-Type"}})}catch(t){let e=t instanceof Error?t.message:"Unknown error";return c.error({error:e,stack:t instanceof Error?t.stack:void 0,msg:"Public SMF NexFlow metrics error"}),r.NextResponse.json({error:e},{status:500})}}async function l(){return new r.NextResponse(null,{status:204,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, OPTIONS","Access-Control-Allow-Headers":"Content-Type","Access-Control-Max-Age":"86400"}})}e.s(["GET",()=>i,"OPTIONS",()=>l]),a()}catch(e){a(e)}},!1),64016,e=>e.a(async(t,a)=>{try{var r=e.i(47909),n=e.i(74017),o=e.i(96250),s=e.i(59756),i=e.i(61916),l=e.i(14444),c=e.i(37092),u=e.i(69741),d=e.i(16795),p=e.i(87718),f=e.i(95169),m=e.i(47587),w=e.i(66012),g=e.i(70101),h=e.i(26937),E=e.i(10372),R=e.i(93695);e.i(52474);var v=e.i(220),y=e.i(2332),N=t([y]);[y]=N.then?(await N)():N;let A=new r.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/public/smf-nexflow-metrics/route",pathname:"/api/public/smf-nexflow-metrics",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/public/smf-nexflow-metrics/route.ts",nextConfigOutput:"standalone",userland:y}),{workAsyncStorage:C,workUnitAsyncStorage:S,serverHooks:T}=A;function _(){return(0,o.patchFetch)({workAsyncStorage:C,workUnitAsyncStorage:S})}async function x(e,t,a){A.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/public/smf-nexflow-metrics/route";r=r.replace(/\/index$/,"")||"/";let o=await A.prepare(e,t,{srcPage:r,multiZoneDraftMode:!1});if(!o)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:y,params:N,nextConfig:_,parsedUrl:x,isDraftMode:C,prerenderManifest:S,routerServerContext:T,isOnDemandRevalidate:O,revalidateOnlyGenerated:I,resolvedPathname:M,clientReferenceManifest:b,serverActionsManifest:k}=o,P=(0,u.normalizeAppPath)(r),H=!!(S.dynamicRoutes[P]||S.routes[M]),D=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,x,!1):t.end("This page could not be found"),null);if(H&&!C){let e=!!S.routes[M],t=S.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(_.experimental.adapterPath)return await D();throw new R.NoFallbackError}}let L=null;!H||A.isDev||C||(L=M,L="/index"===L?"/":L);let U=!0===A.isDev||!H,F=H&&!U;k&&b&&(0,l.setReferenceManifestsSingleton)({page:r,clientReferenceManifest:b,serverActionsManifest:k,serverModuleMap:(0,c.createServerModuleMap)({serverActionsManifest:k})});let $=e.method||"GET",q=(0,i.getTracer)(),j=q.getActiveScopeSpan(),K={params:N,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!_.experimental.authInterrupts},cacheComponents:!!_.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:_.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>A.onRequestError(e,t,r,T)},sharedContext:{buildId:y}},W=new d.NodeNextRequest(e),B=new d.NodeNextResponse(t),G=p.NextRequestAdapter.fromNodeNextRequest(W,(0,p.signalFromNodeResponse)(t));try{let o=async e=>A.handle(G,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=q.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==f.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=a.get("next.route");if(n){let t=`${$} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${r}`)}),l=!!(0,s.getRequestMeta)(e,"minimalMode"),c=async s=>{var i,c;let u=async({previousCacheEntry:n})=>{try{if(!l&&O&&I&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await o(s);e.fetchMetrics=K.renderOpts.fetchMetrics;let i=K.renderOpts.pendingWaitUntil;i&&a.waitUntil&&(a.waitUntil(i),i=void 0);let c=K.renderOpts.collectedTags;if(!H)return await (0,w.sendResponse)(W,B,r,K.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(r.headers);c&&(t[E.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=E.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,n=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=E.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:n}}}}catch(t){throw(null==n?void 0:n.isStale)&&await A.onRequestError(e,t,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:O})},T),t}},d=await A.handleResponse({req:e,nextConfig:_,cacheKey:L,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:O,revalidateOnlyGenerated:I,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:l});if(!H)return null;if((null==d||null==(i=d.value)?void 0:i.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(c=d.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",O?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,g.fromNodeOutgoingHttpHeaders)(d.value.headers);return l&&H||p.delete(E.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,h.getCacheControlHeader)(d.cacheControl)),await (0,w.sendResponse)(W,B,new Response(d.value.body,{headers:p,status:d.value.status||200})),null};j?await c(j):await q.withPropagatedContext(e.headers,()=>q.trace(f.BaseServerSpan.handleRequest,{spanName:`${$} ${r}`,kind:i.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},c))}catch(t){if(t instanceof R.NoFallbackError||await A.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:O})}),H)throw t;return await (0,w.sendResponse)(W,B,new Response(null,{status:500})),null}}e.s(["handler",()=>x,"patchFetch",()=>_,"routeModule",()=>A,"serverHooks",()=>T,"workAsyncStorage",()=>C,"workUnitAsyncStorage",()=>S]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=_408fedf1._.js.map
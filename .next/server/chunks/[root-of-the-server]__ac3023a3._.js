module.exports=[93695,(e,t,s)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},22734,(e,t,s)=>{t.exports=e.x("fs",()=>require("fs"))},30056,e=>e.a(async(t,s)=>{try{let t=await e.y("pg");e.n(t),s()}catch(e){s(e)}},!0),14747,(e,t,s)=>{t.exports=e.x("path",()=>require("path"))},70406,(e,t,s)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},18622,(e,t,s)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,s)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,s)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,s)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},24361,(e,t,s)=>{t.exports=e.x("util",()=>require("util"))},87769,(e,t,s)=>{t.exports=e.x("node:events",()=>require("node:events"))},874,(e,t,s)=>{t.exports=e.x("buffer",()=>require("buffer"))},27699,(e,t,s)=>{t.exports=e.x("events",()=>require("events"))},92509,(e,t,s)=>{t.exports=e.x("url",()=>require("url"))},49719,(e,t,s)=>{t.exports=e.x("assert",()=>require("assert"))},62562,(e,t,s)=>{t.exports=e.x("module",()=>require("module"))},50227,(e,t,s)=>{t.exports=e.x("node:path",()=>require("node:path"))},94346,e=>{e.v({name:"thread-stream",version:"3.1.0",description:"A streaming way to send data to a Node.js Worker Thread",main:"index.js",types:"index.d.ts",dependencies:{"real-require":"^0.2.0"},devDependencies:{"@types/node":"^20.1.0","@types/tap":"^15.0.0","@yao-pkg/pkg":"^5.11.5",desm:"^1.3.0",fastbench:"^1.0.1",husky:"^9.0.6","pino-elasticsearch":"^8.0.0","sonic-boom":"^4.0.1",standard:"^17.0.0",tap:"^16.2.0","ts-node":"^10.8.0",typescript:"^5.3.2","why-is-node-running":"^2.2.2"},scripts:{build:"tsc --noEmit",test:'standard && npm run build && npm run transpile && tap "test/**/*.test.*js" && tap --ts test/*.test.*ts',"test:ci":"standard && npm run transpile && npm run test:ci:js && npm run test:ci:ts","test:ci:js":'tap --no-check-coverage --timeout=120 --coverage-report=lcovonly "test/**/*.test.*js"',"test:ci:ts":'tap --ts --no-check-coverage --coverage-report=lcovonly "test/**/*.test.*ts"',"test:yarn":'npm run transpile && tap "test/**/*.test.js" --no-check-coverage',transpile:"sh ./test/ts/transpile.sh",prepare:"husky install"},standard:{ignore:["test/ts/**/*","test/syntax-error.mjs"]},repository:{type:"git",url:"git+https://github.com/mcollina/thread-stream.git"},keywords:["worker","thread","threads","stream"],author:"Matteo Collina <hello@matteocollina.com>",license:"MIT",bugs:{url:"https://github.com/mcollina/thread-stream/issues"},homepage:"https://github.com/mcollina/thread-stream#readme"})},37702,(e,t,s)=>{t.exports=e.x("worker_threads",()=>require("worker_threads"))},60526,(e,t,s)=>{t.exports=e.x("node:os",()=>require("node:os"))},77652,(e,t,s)=>{t.exports=e.x("node:diagnostics_channel",()=>require("node:diagnostics_channel"))},62556,e=>{"use strict";let t=(0,e.i(50377).createLogger)({component:"CircuitBreaker"});class s{config;state;failures;successes;lastFailure;lastSuccess;openedAt;totalRequests;failedRequests;constructor(e){this.config=e,this.state="CLOSED",this.failures=[],this.successes=0,this.totalRequests=0,this.failedRequests=0}async execute(e){if(this.totalRequests++,"OPEN"===this.state)if(this.shouldAttemptReset())this.transitionTo("HALF_OPEN");else{if(this.failedRequests++,t.warn({circuit:this.config.name,state:this.state,openedAt:this.openedAt},"Circuit breaker is OPEN - failing fast"),this.config.fallback)return this.config.fallback();throw new r(`Circuit breaker ${this.config.name} is OPEN`,this.config.name)}try{let t=await this.executeWithTimeout(e);return this.onSuccess(),t}catch(e){throw this.onFailure(e),e}}async executeWithTimeout(e){return this.config.requestTimeout?Promise.race([e(),new Promise((e,t)=>setTimeout(()=>t(Error(`Request timeout after ${this.config.requestTimeout}ms`)),this.config.requestTimeout))]):e()}onSuccess(){this.lastSuccess=new Date,"HALF_OPEN"===this.state?(this.successes++,this.successes>=this.config.successThreshold&&this.transitionTo("CLOSED")):"CLOSED"===this.state&&this.pruneOldFailures()}onFailure(e){this.failedRequests++,this.lastFailure=new Date,this.failures.push({timestamp:Date.now()}),t.warn({circuit:this.config.name,state:this.state,error:e instanceof Error?e.message:"Unknown error",failureCount:this.failures.length},"Circuit breaker recorded failure"),"HALF_OPEN"===this.state?this.transitionTo("OPEN"):"CLOSED"===this.state&&(this.pruneOldFailures(),this.failures.length>=this.config.failureThreshold&&this.transitionTo("OPEN"))}shouldAttemptReset(){return!this.openedAt||Date.now()-this.openedAt.getTime()>=this.config.resetTimeout}pruneOldFailures(){let e=Date.now()-this.config.failureWindow;this.failures=this.failures.filter(t=>t.timestamp>e)}transitionTo(e){let s=this.state;this.state=e,t.info({circuit:this.config.name,from:s,to:e,failures:this.failures.length,successes:this.successes},"Circuit breaker state transition"),"OPEN"===e?this.openedAt=new Date:"CLOSED"===e?(this.failures=[],this.successes=0,this.openedAt=void 0):"HALF_OPEN"===e&&(this.successes=0)}getStats(){return{name:this.config.name,state:this.state,failures:this.failures.length,successes:this.successes,lastFailure:this.lastFailure,lastSuccess:this.lastSuccess,openedAt:this.openedAt,totalRequests:this.totalRequests,failedRequests:this.failedRequests,successRate:this.totalRequests>0?(this.totalRequests-this.failedRequests)/this.totalRequests:1}}reset(){this.transitionTo("CLOSED"),this.totalRequests=0,this.failedRequests=0,t.info({circuit:this.config.name},"Circuit breaker manually reset")}isAllowingRequests(){return"CLOSED"===this.state||"HALF_OPEN"===this.state||this.shouldAttemptReset()}}class r extends Error{circuitName;constructor(e,t){super(e),this.circuitName=t,this.name="CircuitBreakerError"}}let a=new Map;function i(e){let r=a.get(e.name);return r||(r=new s(e),a.set(e.name,r),t.info({circuit:e.name},"Created new circuit breaker")),r}function n(){return Array.from(a.values()).map(e=>e.getStats())}i({name:"x402scan",failureThreshold:3,successThreshold:2,resetTimeout:6e4,failureWindow:3e5,requestTimeout:3e4}),i({name:"scattering",failureThreshold:3,successThreshold:2,resetTimeout:6e4,failureWindow:3e5,requestTimeout:3e4}),i({name:"facilitator-probes",failureThreshold:5,successThreshold:3,resetTimeout:3e4,failureWindow:12e4,requestTimeout:1e4}),e.s(["getAllCircuitBreakerStats",()=>n,"getCircuitBreaker",()=>i])},31233,e=>e.a(async(t,s)=>{try{var r=e.i(89171),a=e.i(24924),i=e.i(62556),n=e.i(36011),o=e.i(50377),l=t([a]);[a]=l.then?(await l)():l;let p=(0,o.createLogger)({component:"HealthCheck"});async function u(){let e=Date.now();try{let t=(0,a.getDb)(),s=await t.healthCheck(),r=Date.now()-e,i=(0,a.getPoolStats)();if(!s)return{status:"unhealthy",latencyMs:r,message:"Database health check failed"};if(r>500)return{status:"degraded",latencyMs:r,message:"Database responding slowly",details:i?{pool:i}:void 0};return{status:"healthy",latencyMs:r,details:i?{pool:i}:void 0}}catch(t){return{status:"unhealthy",latencyMs:Date.now()-e,message:t instanceof Error?t.message:"Database connection failed"}}}async function c(){let t=Date.now();try{let s=!!(process.env.UPSTASH_REDIS_REST_URL&&process.env.UPSTASH_REDIS_REST_TOKEN),r=!!process.env.REDIS_URL;if(!s&&!r)return{status:"healthy",message:"Using in-memory store (no Redis configured)",details:{type:"in-memory"}};if(s){let{Redis:s}=await e.A(2759),r=new s({url:process.env.UPSTASH_REDIS_REST_URL,token:process.env.UPSTASH_REDIS_REST_TOKEN});await r.ping();let a=Date.now()-t;return{status:a>200?"degraded":"healthy",latencyMs:a,details:{type:"upstash"},message:a>200?"Redis responding slowly":void 0}}return{status:"healthy",message:"Redis configured but not checked",details:{type:"ioredis"}}}catch(e){return{status:"degraded",latencyMs:Date.now()-t,message:e instanceof Error?e.message:"Redis check failed",details:{fallback:"in-memory"}}}}async function d(e){let t=Date.now(),[s,a]=await Promise.all([u(),c()]),o=function(){try{let e=(0,n.getSecurityMetrics)(),t=(0,n.getSecurityConfig)();return{status:"healthy",details:{shadowMode:t.shadowMode,totalScanned:e.shadowModeStats.totalScanned,wouldHaveBlocked:e.shadowModeStats.wouldHaveBlocked,ipsRateLimited:e.violationRateLimiting.ipsRateLimited}}}catch(e){return{status:"degraded",message:"Security metrics unavailable"}}}(),l=function(){let e=(0,i.getAllCircuitBreakerStats)(),t={};for(let s of e)t[s.name]={state:s.state,failures:s.failures,successRate:Math.round(100*s.successRate)+"%"};return t}(),d={database:s,redis:a,security:o},h="healthy";for(let e of Object.values(d)){if("unhealthy"===e.status){h="unhealthy";break}"degraded"===e.status&&"healthy"===h&&(h="degraded")}Object.values(l).some(e=>"OPEN"===e.state)&&"healthy"===h&&(h="degraded");let m={status:h,timestamp:new Date().toISOString(),version:process.env.npm_package_version||"0.0.0",environment:"production",uptime:Math.round(process.uptime()),services:d,circuitBreakers:Object.keys(l).length>0?l:void 0,memory:{heapUsed:Math.round(process.memoryUsage().heapUsed/1024/1024),heapTotal:Math.round(process.memoryUsage().heapTotal/1024/1024),rss:Math.round(process.memoryUsage().rss/1024/1024)}},f=Date.now()-t;p.info({status:h,latencyMs:f,services:Object.fromEntries(Object.entries(d).map(([e,t])=>[e,t.status]))},"Health check completed");let g="unhealthy"===h?503:200;return r.NextResponse.json(m,{status:g,headers:{"Cache-Control":"no-cache, no-store, must-revalidate","X-Health-Check-Latency":`${f}ms`}})}async function h(){try{let e=(0,a.getDb)(),t=await e.healthCheck();return new r.NextResponse(null,{status:t?200:503})}catch{return new r.NextResponse(null,{status:503})}}e.s(["GET",()=>d,"HEAD",()=>h]),s()}catch(e){s(e)}},!1),43007,e=>e.a(async(t,s)=>{try{var r=e.i(47909),a=e.i(74017),i=e.i(96250),n=e.i(59756),o=e.i(61916),l=e.i(14444),u=e.i(37092),c=e.i(69741),d=e.i(16795),h=e.i(87718),p=e.i(95169),m=e.i(47587),f=e.i(66012),g=e.i(70101),y=e.i(26937),R=e.i(10372),x=e.i(93695);e.i(52474);var v=e.i(220),w=e.i(31233),E=t([w]);[w]=E.then?(await E)():E;let S=new r.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/health/route",pathname:"/api/health",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/health/route.ts",nextConfigOutput:"standalone",userland:w}),{workAsyncStorage:b,workUnitAsyncStorage:C,serverHooks:q}=S;function T(){return(0,i.patchFetch)({workAsyncStorage:b,workUnitAsyncStorage:C})}async function k(e,t,s){S.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/health/route";r=r.replace(/\/index$/,"")||"/";let i=await S.prepare(e,t,{srcPage:r,multiZoneDraftMode:!1});if(!i)return t.statusCode=400,t.end("Bad Request"),null==s.waitUntil||s.waitUntil.call(s,Promise.resolve()),null;let{buildId:w,params:E,nextConfig:T,parsedUrl:k,isDraftMode:b,prerenderManifest:C,routerServerContext:q,isOnDemandRevalidate:A,revalidateOnlyGenerated:_,resolvedPathname:O,clientReferenceManifest:D,serverActionsManifest:P}=i,N=(0,c.normalizeAppPath)(r),M=!!(C.dynamicRoutes[N]||C.routes[O]),j=async()=>((null==q?void 0:q.render404)?await q.render404(e,t,k,!1):t.end("This page could not be found"),null);if(M&&!b){let e=!!C.routes[O],t=C.dynamicRoutes[N];if(t&&!1===t.fallback&&!e){if(T.experimental.adapterPath)return await j();throw new x.NoFallbackError}}let H=null;!M||S.isDev||b||(H=O,H="/index"===H?"/":H);let U=!0===S.isDev||!M,L=M&&!U;P&&D&&(0,l.setReferenceManifestsSingleton)({page:r,clientReferenceManifest:D,serverActionsManifest:P,serverModuleMap:(0,u.createServerModuleMap)({serverActionsManifest:P})});let F=e.method||"GET",I=(0,o.getTracer)(),B=I.getActiveScopeSpan(),$={params:E,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!T.experimental.authInterrupts},cacheComponents:!!T.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:T.cacheLife,waitUntil:s.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,s,r)=>S.onRequestError(e,t,r,q)},sharedContext:{buildId:w}},K=new d.NodeNextRequest(e),W=new d.NodeNextResponse(t),G=h.NextRequestAdapter.fromNodeNextRequest(K,(0,h.signalFromNodeResponse)(t));try{let i=async e=>S.handle(G,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let s=I.getRootSpanAttributes();if(!s)return;if(s.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${s.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=s.get("next.route");if(a){let t=`${F} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${F} ${r}`)}),l=!!(0,n.getRequestMeta)(e,"minimalMode"),u=async n=>{var o,u;let c=async({previousCacheEntry:a})=>{try{if(!l&&A&&_&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await i(n);e.fetchMetrics=$.renderOpts.fetchMetrics;let o=$.renderOpts.pendingWaitUntil;o&&s.waitUntil&&(s.waitUntil(o),o=void 0);let u=$.renderOpts.collectedTags;if(!M)return await (0,f.sendResponse)(K,W,r,$.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(r.headers);u&&(t[R.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let s=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,a=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:s,expire:a}}}}catch(t){throw(null==a?void 0:a.isStale)&&await S.onRequestError(e,t,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:A})},q),t}},d=await S.handleResponse({req:e,nextConfig:T,cacheKey:H,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:_,responseGenerator:c,waitUntil:s.waitUntil,isMinimalMode:l});if(!M)return null;if((null==d||null==(o=d.value)?void 0:o.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(u=d.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",A?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),b&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let h=(0,g.fromNodeOutgoingHttpHeaders)(d.value.headers);return l&&M||h.delete(R.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||h.get("Cache-Control")||h.set("Cache-Control",(0,y.getCacheControlHeader)(d.cacheControl)),await (0,f.sendResponse)(K,W,new Response(d.value.body,{headers:h,status:d.value.status||200})),null};B?await u(B):await I.withPropagatedContext(e.headers,()=>I.trace(p.BaseServerSpan.handleRequest,{spanName:`${F} ${r}`,kind:o.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},u))}catch(t){if(t instanceof x.NoFallbackError||await S.onRequestError(e,t,{routerKind:"App Router",routePath:N,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:A})}),M)throw t;return await (0,f.sendResponse)(K,W,new Response(null,{status:500})),null}}e.s(["handler",()=>k,"patchFetch",()=>T,"routeModule",()=>S,"serverHooks",()=>q,"workAsyncStorage",()=>b,"workUnitAsyncStorage",()=>C]),s()}catch(e){s(e)}},!1),2759,e=>{e.v(t=>Promise.all(["server/chunks/[root-of-the-server]__7ebfd264._.js","server/chunks/node_modules_@upstash_redis_nodejs_mjs_85cd95da._.js"].map(t=>e.l(t))).then(()=>t(58119)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__ac3023a3._.js.map
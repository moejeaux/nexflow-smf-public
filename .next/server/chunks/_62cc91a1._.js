module.exports=[7720,e=>{"use strict";var t=e.i(89171),r=e.i(50377),a=e.i(97697);async function n(e,n){let o=(0,a.getOrCreateRequestId)(e),s=(0,r.createLogger)({component:n});try{let r=await e.text();if(!r||""===r.trim())return s.warn({requestId:o},"Empty webhook body received"),{success:!1,error:"Empty request body",requestId:o,response:t.NextResponse.json({error:"Empty request body",code:"EMPTY_BODY",requestId:o},{status:400})};return{success:!0,rawBody:r,requestId:o}}catch(r){let e=r instanceof Error?r.message:"Failed to read body";return s.error({requestId:o,error:e},"Failed to read webhook body"),{success:!1,error:e,requestId:o,response:t.NextResponse.json({error:"Failed to read request body",code:"BODY_READ_ERROR",requestId:o},{status:400})}}}function o(e,a,n,o,s){let i=(0,r.createLogger)({component:s}),d=e.get(a),c=e.get(n);if(!d)return i.warn({requestId:o,header:a},"Missing signature header"),{success:!1,error:`Missing ${a} header`,response:t.NextResponse.json({error:"Missing signature header",code:"MISSING_SIGNATURE",requestId:o},{status:401})};if(!c)return i.warn({requestId:o,header:n},"Missing timestamp header"),{success:!1,error:`Missing ${n} header`,response:t.NextResponse.json({error:"Missing timestamp header",code:"MISSING_TIMESTAMP",requestId:o},{status:401})};let u=parseInt(c,10);return isNaN(u)?(i.warn({requestId:o,timestampStr:c},"Invalid timestamp header value"),{success:!1,error:"Invalid timestamp header",response:t.NextResponse.json({error:"Invalid timestamp header",code:"INVALID_TIMESTAMP",requestId:o},{status:400})}):{success:!0,signature:d,timestamp:u}}async function s(e){let{eventId:a,isProcessed:n,requestId:o,component:s}=e,i=(0,r.createLogger)({component:s});try{if(await n(a))return i.info({requestId:o,eventId:a},"Webhook event already processed, acknowledging duplicate"),{success:!0,isNewEvent:!1,response:t.NextResponse.json({received:!0,duplicate:!0,requestId:o})};return{success:!0,isNewEvent:!0}}catch(r){let e=r instanceof Error?r.message:"Idempotency check failed";return i.error({requestId:o,eventId:a,error:e},"Idempotency check failed"),{success:!1,error:e,response:t.NextResponse.json({error:"Idempotency check failed",code:"IDEMPOTENCY_ERROR",requestId:o},{status:500})}}}function i(e,r,a){return t.NextResponse.json({received:!0,requestId:e,...r&&{eventId:r},...a})}function d(e,r,a,n=500,o){return t.NextResponse.json({error:r,code:e,requestId:a,...o},{status:n})}function c(e,r,a){return t.NextResponse.json({received:!0,processed:!1,error:r,requestId:e,...a&&{eventId:a}})}function u(e,t,a,n,o){(0,r.createLogger)({component:e}).info({requestId:t,eventId:n,eventType:a,...o},"Webhook received and verified")}function l(e,t,a,n,o){(0,r.createLogger)({component:e}).info({requestId:t,eventId:n,eventType:a,...o},"Webhook processed successfully")}function p(e,t,a,n,o,s){(0,r.createLogger)({component:e}).error({requestId:t,eventId:n,eventType:a,error:o,...s},"Webhook processing failed")}function f(e,t,a,n){(0,r.createLogger)({component:e}).info({requestId:t,eventId:n,eventType:a},"Received unhandled webhook event type")}(0,r.createLogger)({component:"WebhookHandler"}),e.s(["checkIdempotency",()=>s,"createWebhookErrorResponse",()=>d,"createWebhookPartialResponse",()=>c,"createWebhookSuccessResponse",()=>i,"extractSignatureHeaders",()=>o,"logUnhandledEventType",()=>f,"logWebhookFailed",()=>p,"logWebhookProcessed",()=>l,"logWebhookReceived",()=>u,"readRawBody",()=>n])},92859,e=>e.a(async(t,r)=>{try{e.i(46235);var a=e.i(40735),n=e.i(72847),o=e.i(42137),s=e.i(46868),i=e.i(50377),d=e.i(7720),c=t([s]);[s]=c.then?(await c)():c;let y="SMFWebhook",v=(0,i.createLogger)({component:y});async function u(e,t){let r=e.data.id;v.info({requestId:t,chargeId:r,eventId:e.id},"Processing payment.succeeded event");let a=await (0,s.getChargeBySmfId)(r);a?"succeeded"!==a.status?(await (0,s.updateChargeStatus)(a.id,"succeeded"),v.info({requestId:t,chargeId:r,orderId:a.order_id},"Charge marked as succeeded")):v.debug({requestId:t,chargeId:r},"Charge already succeeded, skipping update"):v.warn({requestId:t,chargeId:r,eventId:e.id},"Received payment.succeeded for unknown charge")}async function l(e,t){let r=e.data.id,a=e.data.error?.code,n=e.data.error?.message;v.info({requestId:t,chargeId:r,eventId:e.id,errorCode:a},"Processing payment.failed event");let o=await (0,s.getChargeBySmfId)(r);o?"failed"!==o.status?(await (0,s.updateChargeStatus)(o.id,"failed",a,n),v.info({requestId:t,chargeId:r,orderId:o.order_id,errorCode:a},"Charge marked as failed")):v.debug({requestId:t,chargeId:r},"Charge already failed, skipping update"):v.warn({requestId:t,chargeId:r,eventId:e.id},"Received payment.failed for unknown charge")}async function p(e,t){let r=e.data.id;v.info({requestId:t,refundId:r,eventId:e.id},"Processing refund.succeeded event");let a=await (0,s.getRefundBySmfId)(r);a?"succeeded"!==a.status?(await (0,s.updateRefundStatus)(a.id,"succeeded"),v.info({requestId:t,refundId:r,chargeId:a.smf_charge_id},"Refund marked as succeeded")):v.debug({requestId:t,refundId:r},"Refund already succeeded, skipping update"):v.warn({requestId:t,refundId:r,eventId:e.id},"Received refund.succeeded for unknown refund")}async function f(e,t){let r=e.data.id,a=e.data.error?.code,n=e.data.error?.message;v.info({requestId:t,refundId:r,eventId:e.id,errorCode:a},"Processing refund.failed event");let o=await (0,s.getRefundBySmfId)(r);o?"failed"!==o.status?(await (0,s.updateRefundStatus)(o.id,"failed",a,n),v.info({requestId:t,refundId:r,chargeId:o.smf_charge_id,errorCode:a},"Refund marked as failed")):v.debug({requestId:t,refundId:r},"Refund already failed, skipping update"):v.warn({requestId:t,refundId:r,eventId:e.id},"Received refund.failed for unknown refund")}async function h(e,t){let r=e.data.id;v.info({requestId:t,payoutId:r,eventId:e.id},"Processing payout.paid event");let a=await (0,s.getPayoutBySmfId)(r);a?"paid"!==a.status?(await (0,s.updatePayoutStatus)(a.id,"paid"),v.info({requestId:t,payoutId:r,merchantId:a.merchant_id},"Payout marked as paid")):v.debug({requestId:t,payoutId:r},"Payout already paid, skipping update"):v.warn({requestId:t,payoutId:r,eventId:e.id},"Received payout.paid for unknown payout")}async function g(e,t){let r=e.data.id,a=e.data.error?.code,n=e.data.error?.message;v.info({requestId:t,payoutId:r,eventId:e.id,errorCode:a},"Processing payout.failed event");let o=await (0,s.getPayoutBySmfId)(r);o?"failed"!==o.status?(await (0,s.updatePayoutStatus)(o.id,"failed",a,n),v.info({requestId:t,payoutId:r,merchantId:o.merchant_id,errorCode:a},"Payout marked as failed")):v.debug({requestId:t,payoutId:r},"Payout already failed, skipping update"):v.warn({requestId:t,payoutId:r,eventId:e.id},"Received payout.failed for unknown payout")}async function R(e){let t=await (0,d.readRawBody)(e,y);if(!t.success)return t.response;let{rawBody:r,requestId:i}=t;try{let t,c=(0,o.getWebhookSecret)();if(!c)return v.error({requestId:i},"SMF_WEBHOOK_SECRET is not configured"),(0,d.createWebhookErrorResponse)("CONFIG_ERROR","Webhook secret not configured",i,500);let R=(0,d.extractSignatureHeaders)(e.headers,"smf-signature","smf-timestamp",i,y);if(!R.success)return R.response;let{signature:m,timestamp:w}=R;try{t=(0,a.verifyWebhookSignature)({payload:r,signature:m,timestamp:w,secret:c,toleranceSeconds:300})}catch(e){if(e instanceof n.InvalidSignatureError)return v.warn({requestId:i,error:e.message},"Invalid webhook signature"),(0,d.createWebhookErrorResponse)("INVALID_SIGNATURE","Invalid signature",i,401);throw e}(0,d.logWebhookReceived)(y,i,t.type,t.id);let k=await (0,d.checkIdempotency)({eventId:t.id,isProcessed:s.isWebhookEventProcessed,requestId:i,component:y});if(!k.success||!k.isNewEvent)return k.response;await (0,s.createWebhookEvent)({smf_event_id:t.id,event_type:t.type,payload:t,status:"processing"});try{switch(t.type){case"payment.succeeded":await u(t,i);break;case"payment.failed":await l(t,i);break;case"refund.succeeded":await p(t,i);break;case"refund.failed":await f(t,i);break;case"payout.paid":await h(t,i);break;case"payout.failed":await g(t,i);break;default:(0,d.logUnhandledEventType)(y,i,t.type,t.id)}return await (0,s.markWebhookEventProcessed)(t.id),(0,d.logWebhookProcessed)(y,i,t.type,t.id),(0,d.createWebhookSuccessResponse)(i,t.id)}catch(r){let e=r instanceof Error?r.message:"Unknown processing error";return await (0,s.markWebhookEventProcessed)(t.id,e),(0,d.logWebhookFailed)(y,i,t.type,t.id,e),(0,d.createWebhookPartialResponse)(i,e,t.id)}}catch(t){let e=t instanceof Error?t.message:"Unknown error";return v.error({requestId:i,error:e},"Webhook handler error"),(0,d.createWebhookErrorResponse)("INTERNAL_ERROR","Webhook processing failed",i,500)}}e.s(["POST",()=>R]),r()}catch(e){r(e)}},!1),68822,e=>e.a(async(t,r)=>{try{var a=e.i(47909),n=e.i(74017),o=e.i(96250),s=e.i(59756),i=e.i(61916),d=e.i(14444),c=e.i(37092),u=e.i(69741),l=e.i(16795),p=e.i(87718),f=e.i(95169),h=e.i(47587),g=e.i(66012),R=e.i(70101),y=e.i(26937),v=e.i(10372),m=e.i(93695);e.i(52474);var w=e.i(220),k=e.i(92859),E=t([k]);[k]=E.then?(await E)():E;let S=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/webhooks/smf/route",pathname:"/api/webhooks/smf",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/webhooks/smf/route.ts",nextConfigOutput:"standalone",userland:k}),{workAsyncStorage:P,workUnitAsyncStorage:N,serverHooks:C}=S;function b(){return(0,o.patchFetch)({workAsyncStorage:P,workUnitAsyncStorage:N})}async function I(e,t,r){S.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/webhooks/smf/route";a=a.replace(/\/index$/,"")||"/";let o=await S.prepare(e,t,{srcPage:a,multiZoneDraftMode:!1});if(!o)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:k,params:E,nextConfig:b,parsedUrl:I,isDraftMode:P,prerenderManifest:N,routerServerContext:C,isOnDemandRevalidate:x,revalidateOnlyGenerated:_,resolvedPathname:A,clientReferenceManifest:T,serverActionsManifest:O}=o,M=(0,u.normalizeAppPath)(a),W=!!(N.dynamicRoutes[M]||N.routes[A]),U=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,I,!1):t.end("This page could not be found"),null);if(W&&!P){let e=!!N.routes[A],t=N.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(b.experimental.adapterPath)return await U();throw new m.NoFallbackError}}let H=null;!W||S.isDev||P||(H=A,H="/index"===H?"/":H);let D=!0===S.isDev||!W,q=W&&!D;O&&T&&(0,d.setReferenceManifestsSingleton)({page:a,clientReferenceManifest:T,serverActionsManifest:O,serverModuleMap:(0,c.createServerModuleMap)({serverActionsManifest:O})});let j=e.method||"GET",L=(0,i.getTracer)(),B=L.getActiveScopeSpan(),F={params:E,prerenderManifest:N,renderOpts:{experimental:{authInterrupts:!!b.experimental.authInterrupts},cacheComponents:!!b.cacheComponents,supportsDynamicResponse:D,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:b.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>S.onRequestError(e,t,a,C)},sharedContext:{buildId:k}},$=new l.NodeNextRequest(e),K=new l.NodeNextResponse(t),G=p.NextRequestAdapter.fromNodeNextRequest($,(0,p.signalFromNodeResponse)(t));try{let o=async e=>S.handle(G,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=L.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==f.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${j} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${a}`)}),d=!!(0,s.getRequestMeta)(e,"minimalMode"),c=async s=>{var i,c;let u=async({previousCacheEntry:n})=>{try{if(!d&&x&&_&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await o(s);e.fetchMetrics=F.renderOpts.fetchMetrics;let i=F.renderOpts.pendingWaitUntil;i&&r.waitUntil&&(r.waitUntil(i),i=void 0);let c=F.renderOpts.collectedTags;if(!W)return await (0,g.sendResponse)($,K,a,F.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,R.toNodeOutgoingHttpHeaders)(a.headers);c&&(t[v.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=v.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,n=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=v.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==n?void 0:n.isStale)&&await S.onRequestError(e,t,{routerKind:"App Router",routePath:a,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:x})},C),t}},l=await S.handleResponse({req:e,nextConfig:b,cacheKey:H,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:N,isRoutePPREnabled:!1,isOnDemandRevalidate:x,revalidateOnlyGenerated:_,responseGenerator:u,waitUntil:r.waitUntil,isMinimalMode:d});if(!W)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(c=l.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});d||t.setHeader("x-nextjs-cache",x?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),P&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,R.fromNodeOutgoingHttpHeaders)(l.value.headers);return d&&W||p.delete(v.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,y.getCacheControlHeader)(l.cacheControl)),await (0,g.sendResponse)($,K,new Response(l.value.body,{headers:p,status:l.value.status||200})),null};B?await c(B):await L.withPropagatedContext(e.headers,()=>L.trace(f.BaseServerSpan.handleRequest,{spanName:`${j} ${a}`,kind:i.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},c))}catch(t){if(t instanceof m.NoFallbackError||await S.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:x})}),W)throw t;return await (0,g.sendResponse)($,K,new Response(null,{status:500})),null}}e.s(["handler",()=>I,"patchFetch",()=>b,"routeModule",()=>S,"serverHooks",()=>C,"workAsyncStorage",()=>P,"workUnitAsyncStorage",()=>N]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=_62cc91a1._.js.map
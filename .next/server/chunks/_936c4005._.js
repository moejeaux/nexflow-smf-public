module.exports=[29083,e=>{"use strict";var t=e.i(91086),r=e.i(71556),a=e.i(56036),n=e.i(92688);let o=(0,e.i(50377).createLogger)({component:"X402Verification"});async function i(e){try{let t=e.paymentHeader||e.request.headers.get("x-payment")||e.request.headers.get("X-Payment")||"",i={};if(e.request.headers.forEach((e,t)=>{"x-payment"===t.toLowerCase()||"authorization"===t.toLowerCase()?i[t]=e?`${e.substring(0,20)}... (length: ${e.length})`:"EMPTY":t.toLowerCase().includes("cookie")||(i[t]=e)}),o.debug("CDP verification - checking payment header",{hasPaymentHeader:!!t,paymentHeaderLength:t?.length||0,paymentHeaderPreview:t?`${t.substring(0,30)}...`:"NONE",contextHasPaymentHeader:!!e.paymentHeader,requestHeaderKeys:Object.keys(i)}),!t)return o.warn("No payment header provided for CDP verification",{contextPaymentHeader:e.paymentHeader?"provided":"missing",requestXPayment:e.request.headers.get("x-payment")?"present":"missing",requestXPaymentUpper:e.request.headers.get("X-Payment")?"present":"missing",allHeaderKeys:Object.keys(i)}),{success:!1,facilitator:"CDP",errorCode:"PAYMENT_HEADER_MISSING"};let s=(0,r.parseX402Header)(t);if(!s.valid||!s.parsed)return o.warn("Invalid payment header format",{error:s.error}),{success:!1,facilitator:"CDP",errorCode:"INVALID_PAYMENT_HEADER"};let l=s.parsed;if(!e.paymentRequirements)return o.error("Payment requirements must be provided for CDP verification"),{success:!1,facilitator:"CDP",errorCode:"MISSING_PAYMENT_REQUIREMENTS"};let d=e.paymentRequirements;if(!d.resource)return o.error("Missing resource in payment requirements"),{success:!1,facilitator:"CDP",errorCode:"MISSING_RESOURCE"};if(!d.asset)return o.error("Missing asset in payment requirements"),{success:!1,facilitator:"CDP",errorCode:"MISSING_ASSET"};let u=(0,n.normalizeNetwork)(l.network||d.network||"base"),c={payment:t,paymentPayload:{x402Version:2,scheme:"exact",network:u,payload:{signature:l.signature,authorization:{from:l.authorization.from,to:l.authorization.to,value:l.authorization.value,validAfter:l.authorization.validAfter,validBefore:l.authorization.validBefore,nonce:l.authorization.nonce}}},paymentRequirements:{scheme:d.scheme||"exact",network:u,to:d.payTo,payTo:d.payTo,value:d.maxAmountRequired,maxAmountRequired:d.maxAmountRequired,resource:d.resource,asset:d.asset,description:d.description,mimeType:d.mimeType,maxTimeoutSeconds:d.maxTimeoutSeconds,validAfter:d.validAfter,validBefore:d.validBefore,extra:d.extra}};o.info("Calling CDP verifyPaymentWithRetry",{hasPaymentHeader:!!t,hasPaymentRequirements:!!c.paymentRequirements,network:c.paymentPayload.network,resource:d.resource});let p=(0,a.getCDPFacilitator)(),m=await p.verifyPaymentWithRetry(c);if(m.success&&m.valid)return o.info("CDP verification succeeded",{transactionHash:m.transactionHash,kytStatus:m.kytStatus,ofacStatus:m.ofacStatus}),{success:!0,x402TxHash:m.transactionHash||l.txHash,facilitator:"CDP"};return m.error,o.warn("CDP verification failed",{error:m.error,errorDetails:m.errorDetails,kytStatus:m.kytStatus,ofacStatus:m.ofacStatus}),{success:!1,facilitator:"CDP",errorCode:m.error||"CDP_VERIFICATION_FAILED"}}catch(e){return o.error("CDP verification error",{error:e}),{success:!1,facilitator:"CDP",errorCode:e instanceof Error?e.message:"CDP_VERIFICATION_ERROR"}}}async function s(e){let r=process.env.X402_VERIFY_MODE?.toLowerCase();if(o.debug("Verification mode",{verifyMode:r}),"cdp"===r)return o.debug("Using CDP verification mode"),await i(e);if("test"===r){o.debug("Using test verification mode");let r=(0,t.verifyPaymentTestOnly)(e.request);return{success:r.success,x402TxHash:r.x402TxHash,facilitator:r.facilitator||"TEST_FACILITATOR",errorCode:r.errorCode}}return o.debug("Payment verification is disabled (default mode)"),o.warn("Payment verification is disabled",{hasPaymentHeader:!!e.paymentHeader}),{success:!1,facilitator:"DISABLED",errorCode:"PAYMENT_DISABLED"}}e.s(["verifyPayment",()=>s])},14484,e=>e.a(async(t,r)=>{try{let p;var a=e.i(89171),n=e.i(29083),o=e.i(91086),i=e.i(19585),s=e.i(97697),l=e.i(50377),d=e.i(92688),u=t([i]);[i]=u.then?(await u)():u;let m=(0,l.createLogger)({component:"UrlEnrichMetered"}),h="ep_url_enrich_demo_v1",f="10000",R="eip155:8453",y=(p=process.env.X402_VERIFY_MODE?.toLowerCase(),"cdp"===p?"0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913":"USDC_TEST"),E="TEST_FACILITATOR";async function c(e){let t=(0,s.getOrCreateRequestId)(e),r=(0,s.createRequestLogger)(t),l=Date.now();e.headers.get("x-conversation-id")||e.headers.get("x-request-id");let u=e.headers.get("x-agent-id")||void 0,c=e.headers.get("x-customer-id")||null,p="https://nexflowapp.app";p.includes("nexflowapp.app")&&!p.includes("www.")&&(p=p.replace("://nexflowapp.app","://www.nexflowapp.app"));let x=`${p}/api/v1/metered/url-enrich`;try{let m,g,v;try{m=await e.json()}catch(r){let e=Date.now()-l;return await (0,i.logX402Call)({customerId:c,endpointId:h,agentId:u||null,facilitator:E,chainId:R,asset:y,amount:f,status:"failed",errorCode:"INVALID_JSON",latencyMs:e,resource:x}),a.NextResponse.json({error:"Invalid JSON",code:"INVALID_JSON",message:"Request body must be valid JSON",requestId:t},{status:400})}let{url:C}=m;if(!C||"string"!=typeof C){let e=Date.now()-l;return await (0,i.logX402Call)({customerId:c,endpointId:h,agentId:u||null,facilitator:E,chainId:R,asset:y,amount:f,status:"failed",errorCode:"INVALID_URL",latencyMs:e,resource:x}),a.NextResponse.json({error:"Invalid request",code:"INVALID_URL",message:"url field is required and must be a string",requestId:t},{status:400})}let I=await (0,n.verifyPayment)({request:e,paymentHeader:e.headers.get("x-payment")||void 0,paymentRequirements:{scheme:"exact",network:(0,d.normalizeNetwork)("base"),maxAmountRequired:f,resource:x,payTo:process.env.X402_RECIPIENT_ADDRESS||"0x0000000000000000000000000000000000000000",asset:y,description:"URL Enrichment Demo Endpoint",mimeType:"application/json",maxTimeoutSeconds:300,extra:{name:"USD Coin",version:"2"}}});if(!I.success){let e=Date.now()-l;return await (0,i.logX402Call)({customerId:c,endpointId:h,agentId:u||null,facilitator:I.facilitator||E,chainId:R,asset:y,amount:f,status:"failed",errorCode:I.errorCode||"PAYMENT_REQUIRED",latencyMs:e,resource:x}),a.NextResponse.json({error:"Payment Required",code:"PAYMENT_REQUIRED",message:`This endpoint requires x402 payment verification. Include ${o.TEST_TOKEN_HEADER}: demo-ok header for test mode.`,paymentDetails:{scheme:"exact",network:(0,d.normalizeNetwork)("base"),chainId:R,asset:y,amount:f,recipient:process.env.X402_RECIPIENT_ADDRESS||"0x0000000000000000000000000000000000000000",resource:x,description:"URL Enrichment Demo Endpoint"},requestId:t},{status:402})}r.info("Payment verified, forwarding to internal handler",{x402TxHash:I.x402TxHash,facilitator:I.facilitator});let w=`${p}/api/demo/url-enrich-internal`;try{g=await fetch(w,{method:"POST",headers:{"Content-Type":"application/json","x-request-id":t},body:JSON.stringify({url:C})})}catch(n){let e=Date.now()-l;return await (0,i.logX402Call)({customerId:c,endpointId:h,agentId:u||null,facilitator:E,chainId:R,asset:y,amount:f,status:"failed",errorCode:"INTERNAL_HANDLER_ERROR",x402TxHash:I.x402TxHash,latencyMs:e,resource:x}),r.error("Internal handler error",{error:n}),a.NextResponse.json({error:"Internal server error",code:"INTERNAL_HANDLER_ERROR",message:n instanceof Error?n.message:"Failed to call internal handler",requestId:t},{status:500})}try{v=await g.json()}catch(n){let e=Date.now()-l;return await (0,i.logX402Call)({customerId:c,endpointId:h,agentId:u||null,facilitator:E,chainId:R,asset:y,amount:f,status:"failed",errorCode:"INTERNAL_RESPONSE_ERROR",x402TxHash:I.x402TxHash,latencyMs:e,resource:x}),r.error("Internal response parse error",{error:n}),a.NextResponse.json({error:"Internal server error",code:"INTERNAL_RESPONSE_ERROR",message:"Failed to parse internal handler response",requestId:t},{status:500})}if(!g.ok){let e=Date.now()-l;return await (0,i.logX402Call)({customerId:c,endpointId:h,agentId:u||null,facilitator:E,chainId:R,asset:y,amount:f,status:"failed",errorCode:v.code||"INTERNAL_HANDLER_FAILED",x402TxHash:I.x402TxHash,latencyMs:e,resource:x}),a.NextResponse.json({...v,requestId:t},{status:g.status})}let T=Date.now()-l;await (0,i.logX402Call)({customerId:c,endpointId:h,agentId:u||null,facilitator:I.facilitator,chainId:R,asset:y,amount:f,status:"success",x402TxHash:I.x402TxHash,latencyMs:T,resource:x});let N=a.NextResponse.json({...v,requestId:t,x402:{verified:!0,transactionHash:I.x402TxHash,facilitator:I.facilitator}},{status:200,headers:{"X-x402-Verified":"true","X-x402-TxHash":I.x402TxHash||"","X-x402-Facilitator":I.facilitator}});return(0,s.addRequestIdToResponse)(N,t),N}catch(d){let e=Date.now()-l,r="INTERNAL_ERROR",n=d instanceof Error?d.message:"Unknown error";try{await (0,i.logX402Call)({customerId:c,endpointId:h,agentId:u||null,facilitator:E,chainId:R,asset:y,amount:f,status:"failed",errorCode:r,latencyMs:e,resource:x})}catch(e){}m.error("URL enrich metered endpoint error",{error:d,responseTime:e,failureCode:r});let o=a.NextResponse.json({error:"Internal server error",code:r,details:n,requestId:t},{status:500});return(0,s.addRequestIdToResponse)(o,t),o}}e.s(["POST",()=>c]),r()}catch(e){r(e)}},!1),16695,e=>e.a(async(t,r)=>{try{var a=e.i(47909),n=e.i(74017),o=e.i(96250),i=e.i(59756),s=e.i(61916),l=e.i(14444),d=e.i(37092),u=e.i(69741),c=e.i(16795),p=e.i(87718),m=e.i(95169),h=e.i(47587),f=e.i(66012),R=e.i(70101),y=e.i(26937),E=e.i(10372),x=e.i(93695);e.i(52474);var g=e.i(220),v=e.i(14484),C=t([v]);[v]=C.then?(await C)():C;let T=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/v1/metered/url-enrich/route",pathname:"/api/v1/metered/url-enrich",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/v1/metered/url-enrich/route.ts",nextConfigOutput:"standalone",userland:v}),{workAsyncStorage:N,workUnitAsyncStorage:P,serverHooks:D}=T;function I(){return(0,o.patchFetch)({workAsyncStorage:N,workUnitAsyncStorage:P})}async function w(e,t,r){T.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/v1/metered/url-enrich/route";a=a.replace(/\/index$/,"")||"/";let o=await T.prepare(e,t,{srcPage:a,multiZoneDraftMode:!1});if(!o)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:v,params:C,nextConfig:I,parsedUrl:w,isDraftMode:N,prerenderManifest:P,routerServerContext:D,isOnDemandRevalidate:A,revalidateOnlyGenerated:_,resolvedPathname:S,clientReferenceManifest:H,serverActionsManifest:O}=o,q=(0,u.normalizeAppPath)(a),b=!!(P.dynamicRoutes[q]||P.routes[S]),L=async()=>((null==D?void 0:D.render404)?await D.render404(e,t,w,!1):t.end("This page could not be found"),null);if(b&&!N){let e=!!P.routes[S],t=P.dynamicRoutes[q];if(t&&!1===t.fallback&&!e){if(I.experimental.adapterPath)return await L();throw new x.NoFallbackError}}let k=null;!b||T.isDev||N||(k=S,k="/index"===k?"/":k);let M=!0===T.isDev||!b,U=b&&!M;O&&H&&(0,l.setReferenceManifestsSingleton)({page:a,clientReferenceManifest:H,serverActionsManifest:O,serverModuleMap:(0,d.createServerModuleMap)({serverActionsManifest:O})});let X=e.method||"GET",j=(0,s.getTracer)(),F=j.getActiveScopeSpan(),V={params:C,prerenderManifest:P,renderOpts:{experimental:{authInterrupts:!!I.experimental.authInterrupts},cacheComponents:!!I.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:I.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>T.onRequestError(e,t,a,D)},sharedContext:{buildId:v}},$=new c.NodeNextRequest(e),z=new c.NodeNextResponse(t),B=p.NextRequestAdapter.fromNodeNextRequest($,(0,p.signalFromNodeResponse)(t));try{let o=async e=>T.handle(B,V).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=j.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${X} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${X} ${a}`)}),l=!!(0,i.getRequestMeta)(e,"minimalMode"),d=async i=>{var s,d;let u=async({previousCacheEntry:n})=>{try{if(!l&&A&&_&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await o(i);e.fetchMetrics=V.renderOpts.fetchMetrics;let s=V.renderOpts.pendingWaitUntil;s&&r.waitUntil&&(r.waitUntil(s),s=void 0);let d=V.renderOpts.collectedTags;if(!b)return await (0,f.sendResponse)($,z,a,V.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,R.toNodeOutgoingHttpHeaders)(a.headers);d&&(t[E.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==V.renderOpts.collectedRevalidate&&!(V.renderOpts.collectedRevalidate>=E.INFINITE_CACHE)&&V.renderOpts.collectedRevalidate,n=void 0===V.renderOpts.collectedExpire||V.renderOpts.collectedExpire>=E.INFINITE_CACHE?void 0:V.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==n?void 0:n.isStale)&&await T.onRequestError(e,t,{routerKind:"App Router",routePath:a,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:A})},D),t}},c=await T.handleResponse({req:e,nextConfig:I,cacheKey:k,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:P,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:_,responseGenerator:u,waitUntil:r.waitUntil,isMinimalMode:l});if(!b)return null;if((null==c||null==(s=c.value)?void 0:s.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(d=c.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",A?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),N&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,R.fromNodeOutgoingHttpHeaders)(c.value.headers);return l&&b||p.delete(E.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,y.getCacheControlHeader)(c.cacheControl)),await (0,f.sendResponse)($,z,new Response(c.value.body,{headers:p,status:c.value.status||200})),null};F?await d(F):await j.withPropagatedContext(e.headers,()=>j.trace(m.BaseServerSpan.handleRequest,{spanName:`${X} ${a}`,kind:s.SpanKind.SERVER,attributes:{"http.method":X,"http.target":e.url}},d))}catch(t){if(t instanceof x.NoFallbackError||await T.onRequestError(e,t,{routerKind:"App Router",routePath:q,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:A})}),b)throw t;return await (0,f.sendResponse)($,z,new Response(null,{status:500})),null}}e.s(["handler",()=>w,"patchFetch",()=>I,"routeModule",()=>T,"serverHooks",()=>D,"workAsyncStorage",()=>N,"workUnitAsyncStorage",()=>P]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=_936c4005._.js.map
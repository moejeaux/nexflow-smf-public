module.exports=[22734,(e,t,a)=>{t.exports=e.x("fs",()=>require("fs"))},30056,e=>e.a(async(t,a)=>{try{let t=await e.y("pg");e.n(t),a()}catch(e){a(e)}},!0),93695,(e,t,a)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},14747,(e,t,a)=>{t.exports=e.x("path",()=>require("path"))},70406,(e,t,a)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},18622,(e,t,a)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},54799,(e,t,a)=>{t.exports=e.x("crypto",()=>require("crypto"))},68237,e=>e.a(async(t,a)=>{try{var n=e.i(54799),r=e.i(24924),i=t([r]);function s(e){return n.default.createHash("sha256").update(e).digest("hex")}async function o(e){let t,a=(0,r.getDb)(),i=`key_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,o=(t=n.default.randomBytes(32).toString("base64url"),`nf_live_${t}`),u=s(o),d=new Date().toISOString(),c={id:i,keyHash:u,name:e.name,role:e.role||"user",userId:e.userId,rateLimit:e.rateLimit||1e3,expiresAt:e.expiresAt,createdAt:d,updatedAt:d};return await a.createApiKey(c),{...c,token:o}}async function u(e){let t=(0,r.getDb)();return await t.findApiKeyByHash(e)}async function d(e){let t=s(e);return await u(t)}async function c(e,t){let a=(0,r.getDb)();await a.updateApiKeyLastUsed(e,t)}async function l(e){let t=(0,r.getDb)();return await t.revokeApiKey(e)}async function p(e){let t=(0,r.getDb)();return await t.listApiKeys(e)}async function _(e,t,a){let n=(0,r.getDb)();await n.updateApiKeyX402DemoAllowance(e,t,a)}function m(e){let t=e.x402DemoCallsUsed||0,a=e.x402DemoCallsLimit||200,n=BigInt(e.x402DemoAmountUsed||"0"),r=BigInt(e.x402DemoAmountLimit||"1000000");return t>=a?{hasAllowance:!1,callsRemaining:0,amountRemaining:"0",reason:"Calls limit reached"}:n>=r?{hasAllowance:!1,callsRemaining:a-t,amountRemaining:"0",reason:"Amount limit reached"}:{hasAllowance:!0,callsRemaining:a-t,amountRemaining:(r-n).toString()}}async function h(e,t,a){let n=(0,r.getDb)();await n.updateApiKeyX402DemoLimits(e,t,a)}async function f(e){return(await p()).find(t=>t.id===e)||null}[r]=i.then?(await i)():i,e.s(["createApiKey",()=>o,"findApiKeyById",()=>f,"findApiKeyByToken",()=>d,"hasX402DemoAllowance",()=>m,"listApiKeys",()=>p,"revokeApiKey",()=>l,"updateApiKeyLastUsed",()=>c,"updateApiKeyX402DemoAllowance",()=>_,"updateApiKeyX402DemoLimits",()=>h]),a()}catch(e){a(e)}},!1),79832,e=>e.a(async(t,a)=>{try{var n=e.i(89171),r=e.i(68237),i=t([r]);function s(e){let t=e.headers.get("x-api-key");if(t)return t.trim();let a=e.headers.get("authorization");return a?a.startsWith("Bearer ")?a.substring(7).trim():a.trim():null}async function o(e){let t=s(e);if(!t)return{error:"Authentication required",status:401};if(!t.startsWith("nf_live_")&&!t.startsWith("nf_test_"))return{error:"Invalid API key format",status:401};let a=await (0,r.findApiKeyByToken)(t);if(!a)return{error:"Invalid API key",status:401};if(a.expiresAt&&new Date(a.expiresAt)<new Date)return{error:"API key has expired",status:401};let n=e.ip||e.headers.get("x-forwarded-for")?.split(",")[0]?.trim()||e.headers.get("x-real-ip")||void 0;return(0,r.updateApiKeyLastUsed)(a.id,n).catch(e=>{console.error("[auth] Failed to update last used:",e)}),{apiKey:a}}async function u(e,t="user"){var a;let r,i=await o(e);return"error"in i?{response:n.NextResponse.json({error:i.error,code:"UNAUTHORIZED"},{status:i.status})}:(a=i.apiKey,(r={"read-only":1,user:2,admin:3})[a.role]>=r[t])?{apiKey:i.apiKey}:{response:n.NextResponse.json({error:"Insufficient permissions",code:"FORBIDDEN",details:`Required role: ${t}, your role: ${i.apiKey.role}`},{status:403})}}[r]=i.then?(await i)():i,e.s(["authenticateRequest",()=>o,"extractApiKey",()=>s,"requireAuth",()=>u]),a()}catch(e){a(e)}},!1),50848,e=>e.a(async(t,a)=>{try{var n=e.i(24924),r=t([n]);async function i(e,t=[]){let a=(0,n.getDb)();if("pool"in a&&"function"==typeof a.pool?.query){let n=a.pool;return(await n.query(e,t)).rows}if("db"in a&&"function"==typeof a.db?.prepare)return a.db.prepare(e).all(...t);if("function"==typeof a.query){let n=await a.query(e,t);return n.rows||n}if("function"==typeof a.prepare)return a.prepare(e).all(...t);throw Error("Unable to execute query: database adapter not recognized")}async function s(e,t=[]){let a=await i(e,t);return a.length>0?a[0]:null}async function o(e,t=[]){let a=(0,n.getDb)();if("pool"in a&&"function"==typeof a.pool?.query){let n=a.pool;return{rowCount:(await n.query(e,t)).rowCount}}if("db"in a&&"function"==typeof a.db?.prepare)return{changes:a.db.prepare(e).run(...t).changes};if("function"==typeof a.query)return{rowCount:(await a.query(e,t)).rowCount};if("function"==typeof a.prepare)return{changes:a.prepare(e).run(...t).changes};throw Error("Unable to execute update: database adapter not recognized")}[n]=r.then?(await r)():r,e.s(["executeQuery",()=>i,"executeQueryOne",()=>s,"executeUpdate",()=>o]),a()}catch(e){a(e)}},!1),59952,e=>{"use strict";var t=e.i(54799);let a={randomUUID:t.default.randomUUID},n=new Uint8Array(256),r=n.length,i=[];for(let e=0;e<256;++e)i.push((e+256).toString(16).slice(1));e.s(["v4",0,function(e,s,o){if(a.randomUUID&&!s&&!e)return a.randomUUID();let u=(e=e||{}).random||(e.rng||function(){return r>n.length-16&&(t.default.randomFillSync(n),r=0),n.slice(r,r+=16)})();if(u[6]=15&u[6]|64,u[8]=63&u[8]|128,s){o=o||0;for(let e=0;e<16;++e)s[o+e]=u[e];return s}return function(e,t=0){return i[e[t+0]]+i[e[t+1]]+i[e[t+2]]+i[e[t+3]]+"-"+i[e[t+4]]+i[e[t+5]]+"-"+i[e[t+6]]+i[e[t+7]]+"-"+i[e[t+8]]+i[e[t+9]]+"-"+i[e[t+10]]+i[e[t+11]]+i[e[t+12]]+i[e[t+13]]+i[e[t+14]]+i[e[t+15]]}(u)}],59952)},49353,e=>e.a(async(t,a)=>{try{var n=e.i(50848),r=e.i(59952),i=t([n]);async function s(e,t){getDb();let a=(0,r.v4)(),i=new Date,s={id:a,owner_user_id:e,name:t.name,description:t.description||null,status:"active",x402_identity:t.x402_identity,x402_endpoint:t.x402_endpoint||null,chain:t.chain||"base",created_at:i,updated_at:i},o=`
    INSERT INTO x402_agents (
      id, owner_user_id, name, description, status, x402_identity, x402_endpoint, chain, created_at, updated_at
    ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)
    RETURNING *
  `,u=await (0,n.executeQueryOne)(o,[s.id,s.owner_user_id,s.name,s.description,s.status,s.x402_identity,s.x402_endpoint,s.chain,s.created_at,s.updated_at]);if(!u)throw Error("Failed to create agent");return y(u)}async function o(e){getDb();let t=await (0,n.executeQueryOne)("SELECT * FROM x402_agents WHERE id = $1",[e]);return t?y(t):null}async function u(e){return getDb(),(await (0,n.executeQuery)("SELECT * FROM x402_agents WHERE owner_user_id = $1 ORDER BY created_at DESC",[e])).map(y)}async function d(e,t){getDb();let a=(0,r.v4)(),i=new Date,s={id:a,agent_id:e,chain:t.chain,stablecoin:t.stablecoin,fee_bps:t.fee_bps,revenue_share_bps:t.revenue_share_bps,min_amount:t.min_amount||null,max_amount:t.max_amount||null,status:t.status||"active",created_at:i,updated_at:i},o=`
    INSERT INTO payment_route_configs (
      id, agent_id, chain, stablecoin, fee_bps, revenue_share_bps, min_amount, max_amount, status, created_at, updated_at
    ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11)
    RETURNING *
  `,u=await (0,n.executeQueryOne)(o,[s.id,s.agent_id,s.chain,s.stablecoin,s.fee_bps,s.revenue_share_bps,s.min_amount,s.max_amount,s.status,s.created_at,s.updated_at]);if(!u)throw Error("Failed to create route config");return g(u)}async function c(e){return getDb(),(await (0,n.executeQuery)("SELECT * FROM payment_route_configs WHERE agent_id = $1 ORDER BY created_at DESC",[e])).map(g)}async function l(e,t){getDb();let a=`
    SELECT * FROM payment_route_configs
    WHERE agent_id = $1 AND status IN ('active', 'test_only')
    ORDER BY created_at DESC
    LIMIT 1
  `,r=[e];t&&(a=`
      SELECT * FROM payment_route_configs
      WHERE agent_id = $1 AND chain = $2 AND status IN ('active', 'test_only')
      ORDER BY created_at DESC
      LIMIT 1
    `,r.push(t));let i=await (0,n.executeQueryOne)(a,r);return i?g(i):null}async function p(e,t,a,i,s,o,u,d,c){getDb();let l=(0,r.v4)(),p=new Date,_={id:l,agent_id:e,route_config_id:t,direction:a,amount:i,currency:s,chain:o,chain_tx_hash:u,status:d,meta:c,created_at:p,confirmed_at:"confirmed"===d?p:null},m=`
    INSERT INTO x402_payments (
      id, agent_id, route_config_id, direction, amount, currency, chain, chain_tx_hash, status, meta, created_at, confirmed_at
    ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12)
    RETURNING *
  `,h=await (0,n.executeQueryOne)(m,[_.id,_.agent_id,_.route_config_id,_.direction,_.amount,_.currency,_.chain,_.chain_tx_hash,_.status,JSON.stringify(_.meta),_.created_at,_.confirmed_at]);if(!h)throw Error("Failed to create payment");return x(h)}async function _(e,t,a){getDb();let r="confirmed"===t?new Date:null,i=`
    UPDATE x402_payments
    SET status = $1, chain_tx_hash = COALESCE($2, chain_tx_hash), confirmed_at = COALESCE($3, confirmed_at)
    WHERE id = $4
    RETURNING *
  `,s=await (0,n.executeQueryOne)(i,[t,a||null,r,e]);return s?x(s):null}async function m(e){getDb();let t=[],a=[],r=1;e.agentId&&(t.push(`agent_id = $${r++}`),a.push(e.agentId)),e.status&&(t.push(`status = $${r++}`),a.push(e.status)),e.from&&(t.push(`created_at >= $${r++}`),a.push(e.from)),e.to&&(t.push(`created_at <= $${r++}`),a.push(e.to));let i=t.length>0?`WHERE ${t.join(" AND ")}`:"",s=e.limit?`LIMIT $${r++}`:"";e.limit&&a.push(e.limit);let o=e.offset?`OFFSET $${r++}`:"";e.offset&&a.push(e.offset);let u=`
    SELECT * FROM x402_payments
    ${i}
    ORDER BY created_at DESC
    ${s}
    ${o}
  `;return(await (0,n.executeQuery)(u,a)).map(x)}async function h(e,t,a,i,s){getDb();let o=(0,r.v4)(),u=new Date,d=`
    INSERT INTO agent_revenue_shares (
      id, agent_id, payment_id, gross_amount, fee_amount, share_amount, settlement_tx_hash, status, created_at, updated_at
    ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)
    RETURNING *
  `,c=await (0,n.executeQueryOne)(d,[o,e,t,a,i,s,null,"pending",u,u]);if(!c)throw Error("Failed to create revenue share");return R(c)}async function f(e){return getDb(),(await (0,n.executeQuery)("SELECT * FROM agent_revenue_shares WHERE agent_id = $1 ORDER BY created_at DESC",[e])).map(R)}function y(e){return{id:e.id,owner_user_id:e.owner_user_id,name:e.name,description:e.description,status:e.status,x402_identity:e.x402_identity,x402_endpoint:e.x402_endpoint,chain:e.chain,created_at:new Date(e.created_at),updated_at:new Date(e.updated_at)}}function g(e){return{id:e.id,agent_id:e.agent_id,chain:e.chain,stablecoin:e.stablecoin,fee_bps:e.fee_bps,revenue_share_bps:e.revenue_share_bps,min_amount:e.min_amount,max_amount:e.max_amount,status:e.status,created_at:new Date(e.created_at),updated_at:new Date(e.updated_at)}}function x(e){return{id:e.id,agent_id:e.agent_id,route_config_id:e.route_config_id,direction:e.direction,amount:e.amount,currency:e.currency,chain:e.chain,chain_tx_hash:e.chain_tx_hash,status:e.status,meta:e.meta?"string"==typeof e.meta?JSON.parse(e.meta):e.meta:null,created_at:new Date(e.created_at),confirmed_at:e.confirmed_at?new Date(e.confirmed_at):null}}function R(e){return{id:e.id,agent_id:e.agent_id,payment_id:e.payment_id,gross_amount:e.gross_amount,fee_amount:e.fee_amount,share_amount:e.share_amount,settlement_tx_hash:e.settlement_tx_hash,status:e.status,created_at:new Date(e.created_at),updated_at:new Date(e.updated_at)}}[n]=i.then?(await i)():i,e.s(["createAgent",()=>s,"createRevenueShare",()=>h,"createRouteConfig",()=>d,"createX402Payment",()=>p,"getActiveRouteConfig",()=>l,"getAgent",()=>o,"getRevenueShares",()=>f,"getRouteConfigs",()=>c,"listAgents",()=>u,"listPayments",()=>m,"updatePaymentStatus",()=>_]),a()}catch(e){a(e)}},!1),8229,e=>{"use strict";class t{async sendTestPayment(e){if(!e.testMode)throw Error("StubX402Client cannot be used in production. Use CDP verification instead.");await new Promise(e=>setTimeout(e,500));let t=`0x${Array.from({length:64},()=>Math.floor(16*Math.random()).toString(16)).join("")}`,a=e.testMode?"confirmed":"pending";return{chain:e.chain,txHash:t,status:a}}}class a{async sendTestPayment(e){throw Error("RealX402Client not yet implemented. Use StubX402Client for development.")}}let n=null;function r(){return n||(n="true"===process.env.USE_REAL_X402_CLIENT?new a:new t)}e.s(["getX402Client",()=>r])},53340,e=>e.a(async(t,a)=>{try{var n=e.i(89171),r=e.i(79832),i=e.i(49353),s=e.i(8229),o=t([r,i]);async function u(e,{params:t}){let{id:a}=await t;try{let t=await (0,r.requireAuth)(e,"user");if("response"in t)return t.response;let{apiKey:o}=t,u=o.userId||o.id,d=await (0,i.getAgent)(a);if(!d)return n.NextResponse.json({error:"Agent not found",code:"NOT_FOUND"},{status:404});if(d.owner_user_id!==u)return n.NextResponse.json({error:"Forbidden",code:"FORBIDDEN"},{status:403});let c=await e.json();if(!c.amount||"string"!=typeof c.amount)return n.NextResponse.json({error:"Missing required field: amount",code:"VALIDATION_ERROR"},{status:400});if(!c.currency||!["USDC","USDT","OTHER"].includes(c.currency))return n.NextResponse.json({error:"Invalid currency",code:"VALIDATION_ERROR"},{status:400});let l=await (0,i.getActiveRouteConfig)(a,d.chain);if(!l)return n.NextResponse.json({error:"No active route config found for this agent",code:"VALIDATION_ERROR"},{status:400});if("disabled"===l.status)return n.NextResponse.json({error:"Route config is disabled",code:"VALIDATION_ERROR"},{status:400});let p=BigInt(c.amount);if(l.min_amount&&p<BigInt(l.min_amount))return n.NextResponse.json({error:`Amount below minimum: ${l.min_amount}`,code:"VALIDATION_ERROR"},{status:400});if(l.max_amount&&p>BigInt(l.max_amount))return n.NextResponse.json({error:`Amount above maximum: ${l.max_amount}`,code:"VALIDATION_ERROR"},{status:400});let _=await (0,i.createX402Payment)(a,l.id,"incoming",c.amount,c.currency,l.chain,null,"pending",{testMode:c.test_mode||!1,requestId:`test_${Date.now()}`}),m=(0,s.getX402Client)(),h=await m.sendTestPayment({agentIdentity:d.x402_identity,chain:l.chain,amount:c.amount,currency:c.currency,meta:{testMode:c.test_mode||!1},testMode:c.test_mode||"test_only"===l.status}),f=await (0,i.updatePaymentStatus)(_.id,h.status,h.txHash);if(!f)return n.NextResponse.json({error:"Failed to update payment status",code:"INTERNAL_ERROR"},{status:500});if("confirmed"===h.status){let e=BigInt(c.amount)*BigInt(l.fee_bps)/BigInt(1e4),t=e*BigInt(l.revenue_share_bps)/BigInt(1e4);await (0,i.createRevenueShare)(a,f.id,c.amount,e.toString(),t.toString())}return n.NextResponse.json({payment_id:f.id,status:f.status,chain_tx_hash:f.chain_tx_hash})}catch(e){return console.error("[x402/agents/:id/test-payment] POST error:",e),n.NextResponse.json({error:e.message||"Failed to process test payment",code:"INTERNAL_ERROR"},{status:500})}}[r,i]=o.then?(await o)():o,e.s(["POST",()=>u]),a()}catch(e){a(e)}},!1),96281,e=>e.a(async(t,a)=>{try{var n=e.i(47909),r=e.i(74017),i=e.i(96250),s=e.i(59756),o=e.i(61916),u=e.i(14444),d=e.i(37092),c=e.i(69741),l=e.i(16795),p=e.i(87718),_=e.i(95169),m=e.i(47587),h=e.i(66012),f=e.i(70101),y=e.i(26937),g=e.i(10372),x=e.i(93695);e.i(52474);var R=e.i(220),w=e.i(53340),E=t([w]);[w]=E.then?(await E)():E;let D=new n.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/v1/x402/agents/[id]/test-payment/route",pathname:"/api/v1/x402/agents/[id]/test-payment",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/v1/x402/agents/[id]/test-payment/route.ts",nextConfigOutput:"standalone",userland:w}),{workAsyncStorage:b,workUnitAsyncStorage:$,serverHooks:I}=D;function A(){return(0,i.patchFetch)({workAsyncStorage:b,workUnitAsyncStorage:$})}async function v(e,t,a){D.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let n="/api/v1/x402/agents/[id]/test-payment/route";n=n.replace(/\/index$/,"")||"/";let i=await D.prepare(e,t,{srcPage:n,multiZoneDraftMode:!1});if(!i)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:w,params:E,nextConfig:A,parsedUrl:v,isDraftMode:b,prerenderManifest:$,routerServerContext:I,isOnDemandRevalidate:N,revalidateOnlyGenerated:O,resolvedPathname:C,clientReferenceManifest:T,serverActionsManifest:S}=i,U=(0,c.normalizeAppPath)(n),L=!!($.dynamicRoutes[U]||$.routes[C]),q=async()=>((null==I?void 0:I.render404)?await I.render404(e,t,v,!1):t.end("This page could not be found"),null);if(L&&!b){let e=!!$.routes[C],t=$.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(A.experimental.adapterPath)return await q();throw new x.NoFallbackError}}let P=null;!L||D.isDev||b||(P=C,P="/index"===P?"/":P);let M=!0===D.isDev||!L,j=L&&!M;S&&T&&(0,u.setReferenceManifestsSingleton)({page:n,clientReferenceManifest:T,serverActionsManifest:S,serverModuleMap:(0,d.createServerModuleMap)({serverActionsManifest:S})});let H=e.method||"GET",k=(0,o.getTracer)(),K=k.getActiveScopeSpan(),B={params:E,prerenderManifest:$,renderOpts:{experimental:{authInterrupts:!!A.experimental.authInterrupts},cacheComponents:!!A.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:A.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,n)=>D.onRequestError(e,t,n,I)},sharedContext:{buildId:w}},F=new l.NodeNextRequest(e),X=new l.NodeNextResponse(t),Q=p.NextRequestAdapter.fromNodeNextRequest(F,(0,p.signalFromNodeResponse)(t));try{let i=async e=>D.handle(Q,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=k.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==_.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${H} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${n}`)}),u=!!(0,s.getRequestMeta)(e,"minimalMode"),d=async s=>{var o,d;let c=async({previousCacheEntry:r})=>{try{if(!u&&N&&O&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(s);e.fetchMetrics=B.renderOpts.fetchMetrics;let o=B.renderOpts.pendingWaitUntil;o&&a.waitUntil&&(a.waitUntil(o),o=void 0);let d=B.renderOpts.collectedTags;if(!L)return await (0,h.sendResponse)(F,X,n,B.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[g.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,r=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==r?void 0:r.isStale)&&await D.onRequestError(e,t,{routerKind:"App Router",routePath:n,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:N})},I),t}},l=await D.handleResponse({req:e,nextConfig:A,cacheKey:P,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:$,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:O,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:u});if(!L)return null;if((null==l||null==(o=l.value)?void 0:o.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(d=l.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});u||t.setHeader("x-nextjs-cache",N?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),b&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,f.fromNodeOutgoingHttpHeaders)(l.value.headers);return u&&L||p.delete(g.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,y.getCacheControlHeader)(l.cacheControl)),await (0,h.sendResponse)(F,X,new Response(l.value.body,{headers:p,status:l.value.status||200})),null};K?await d(K):await k.withPropagatedContext(e.headers,()=>k.trace(_.BaseServerSpan.handleRequest,{spanName:`${H} ${n}`,kind:o.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},d))}catch(t){if(t instanceof x.NoFallbackError||await D.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:N})}),L)throw t;return await (0,h.sendResponse)(F,X,new Response(null,{status:500})),null}}e.s(["handler",()=>v,"patchFetch",()=>A,"routeModule",()=>D,"serverHooks",()=>I,"workAsyncStorage",()=>b,"workUnitAsyncStorage",()=>$]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=%5Broot-of-the-server%5D__7205e90c._.js.map
module.exports=[30056,e=>e.a(async(t,r)=>{try{let t=await e.y("pg");e.n(t),r()}catch(e){r(e)}},!0),83101,e=>{"use strict";function t(e,t){let r=e.network||e.networks?.[0]||"",i=e.networks?.[0]?.startsWith("eip155:")?e.networks[0]:void 0,a=e.asset||e.assets?.[0]||"",o=e.assets?.[0]?.includes("/")?e.assets[0]:void 0;return{network:r,token:a,amount:e.maxAmountRequired||"0",networkCAIP:i,tokenCAIP:o,x402Version:t?.x402Version||1,callerId:t?.callerId,clientId:t?.clientId,region:t?.region,riskLevel:t?.riskLevel,watchLevel:t?.watchLevel,requirements:e}}e.s(["createRouteContext",()=>t])},84170,e=>e.a(async(t,r)=>{try{var i=e.i(57729),a=e.i(50377),o=e.i(60827),s=e.i(83101),l=t([i,o]);[i,o]=l.then?(await l)():l;let c=(0,a.createLogger)({component:"MetaFacilitator"});class u{router=(0,i.getFacilitatorRouter)();async verifyPayment(e,t,r,i,a){let l=Date.now(),n=null;try{let u,d=(0,s.createRouteContext)(t,{callerId:a?.clientId||a?.agentId,clientId:a?.clientId,x402Version:1}),f=await this.router.routePayment(t,r,i);n=(await (0,o.createRoute)({request_id:a?.requestId||null,correlation_id:a?.correlationId||null,client_id:a?.clientId||null,agent_id:a?.agentId||null,network:d.network,token:d.token,amount:d.amount,selected_facilitator_id:f.id,status:"verifying"})).id,c.info({routeId:n,facilitatorId:f.id,network:t.network,asset:t.asset,settlementMode:t.settlementMode,preferences:r?{priority:r.priority,jurisdiction:r.jurisdiction}:void 0},"Routing payment to facilitator");let h=Date.now(),p="success",g=null,w=null;try{u=await f.verify(e,t);let r=Date.now()-h;u.success&&u.valid||(p="failure",g=u.error||"verification_failed"),await (0,o.createRouteAttempt)({route_id:n,facilitator_id:f.id,phase:"verify",result:p,latency_ms:r,error_code:g,raw_status:w,is_probe:!1})}catch(r){let e=Date.now()-h,t=r instanceof Error?r.message:"Unknown error";t.includes("timeout")||t.includes("TIMEOUT")?p="timeout":t.includes("rate")||t.includes("429")?(p="rate_limited",w=429):p=t.includes("network")||t.includes("ECONNREFUSED")?"network_error":"failure",g=t,await (0,o.createRouteAttempt)({route_id:n,facilitator_id:f.id,phase:"verify",result:p,latency_ms:e,error_code:g,raw_status:w,is_probe:!1}),u={success:!1,valid:!1,error:t,facilitatorId:f.id,verifiedAt:new Date().toISOString()}}let m=this.applyBusinessLogic(u,t,i);m.success&&m.valid?await (0,o.updateRouteStatus)(n,"settled",new Date().toISOString()):await (0,o.updateRouteStatus)(n,"failed",new Date().toISOString());let y={latency:Date.now()-l,complianceScore:this.calculateComplianceScore(u)},k=this.router.getFacilitators().filter(e=>e.supports(t.network,t.asset,t.scheme,t.settlementMode)&&e.config.enabled),_=await this.buildDecisionTrace(f,k,t,r,i);return{...m,facilitatorUsed:f.id,routingReason:this.getRoutingReason(f,r,i),alternativesConsidered:k.length-1,decisionTrace:_,orchestrationMetadata:y}}catch(a){if(c.error({error:a,requirements:t,routeId:n},"Orchestration error"),n&&await (0,o.updateRouteStatus)(n,"failed",new Date().toISOString()),i?.requireHealthCheck!==!1)return await this.handleFailover(e,t,r,i,a,n);throw a}}applyBusinessLogic(e,t,r){if(r?.riskThreshold!==void 0){let t=this.calculateRiskScore(e);if(t>r.riskThreshold)return{...e,valid:!1,error:`Risk score ${t} exceeds threshold ${r.riskThreshold}`}}if(r?.requireKYC){let r=BigInt(t.maxAmountRequired),i=BigInt("1000000000");if(r>i&&"passed"!==e.kytStatus)return{...e,valid:!1,error:"KYC required for this amount"}}return r?.jurisdictionRules,e}calculateRiskScore(e){let t=0;return"blocked"===e.kytStatus?t+=50:"flagged"===e.kytStatus&&(t+=25),"blocked"===e.ofacStatus?t+=50:"flagged"===e.ofacStatus&&(t+=25),e.success&&e.valid||(t+=30),Math.min(100,t)}calculateComplianceScore(e){let t=100;return"blocked"===e.kytStatus?t-=50:"flagged"===e.kytStatus&&(t-=25),"blocked"===e.ofacStatus?t-=50:"flagged"===e.ofacStatus&&(t-=25),Math.max(0,t)}async buildDecisionTrace(e,t,r,a,o){let s=(0,i.getFacilitatorRouter)(),l=await s.scoreFacilitators(t,r,a,o),n=t.map(e=>{let t=l.find(t=>t.facilitator.id===e.id),r=t?.score||0,i=t?.reasons||[];return{facilitatorId:e.id,facilitatorName:e.name,score:r,eligible:!0,reasons:i}});return{timestamp:new Date().toISOString(),reason:this.getRoutingReason(e,a,o),constraints:{preferences:a,policy:o?{requireHealthCheck:o.requireHealthCheck,preferCheapest:o.preferCheapest,requireKYC:o.requireKYC}:void 0,requirements:r},candidates:n,selected:{facilitatorId:e.id,score:l.find(t=>t.facilitator.id===e.id)?.score||100,alternativesConsidered:t.length-1}}}getRoutingReason(e,t,r){let i=[];return t?.priority==="cost"&&i.push("cost-optimized"),t?.priority==="speed"&&i.push("speed-optimized"),t?.priority==="compliance"&&i.push("compliance-optimized"),t?.priority==="reliability"&&i.push("reliability-optimized"),t?.preferredNetworks&&i.push("network-preference"),r?.preferCheapest&&i.push("cheapest-selected"),1===e.config.priority&&i.push("primary-facilitator"),i.join(", ")||"default-routing"}async handleFailover(e,t,r,i,a,s){c.warn({originalError:a,requirements:t},"Attempting failover");let l=this.router.getFacilitators().filter(e=>e.supports(t.network,t.asset,t.scheme,t.settlementMode)&&e.config.enabled);for(let r of l.sort((e,t)=>e.config.priority-t.config.priority)){let i=Date.now();try{let a=await r.verify(e,t),n=Date.now()-i;if(s&&await (0,o.createRouteAttempt)({route_id:s,facilitator_id:r.id,phase:"verify",result:a.success&&a.valid?"success":"failure",latency_ms:n,is_probe:!1,error_code:a.error||null,raw_status:null}),a.success&&a.valid)return c.info({facilitatorId:r.id,routeId:s},"Failover successful"),s&&await (0,o.updateRouteStatus)(s,"settled",new Date().toISOString()),{...a,facilitatorUsed:r.id,routingReason:"failover",alternativesConsidered:l.length-1}}catch(a){let e=Date.now()-i,t=a instanceof Error?a.message:"Unknown error";if(s){let i="failure";t.includes("timeout")?i="timeout":t.includes("rate")||t.includes("429")?i="rate_limited":(t.includes("network")||t.includes("ECONNREFUSED"))&&(i="network_error"),await (0,o.createRouteAttempt)({route_id:s,facilitator_id:r.id,phase:"verify",result:i,latency_ms:e,is_probe:!1,error_code:t,raw_status:null})}c.warn({facilitatorId:r.id,error:a,routeId:s},"Failover attempt failed");continue}}throw Error(`All facilitators failed. Original error: ${a instanceof Error?a.message:"Unknown error"}`)}async getStatus(){let e=this.router.getFacilitators(),t=await Promise.all(e.map(async e=>{try{let t=await e.getHealth();return{id:e.id,name:e.name,healthy:t.healthy,lastChecked:t.lastChecked}}catch(t){return{id:e.id,name:e.name,healthy:!1,lastChecked:new Date().toISOString()}}})),r=t.filter(e=>e.healthy),i=new Set,a=new Set;return e.forEach(e=>{e.config.networks.forEach(e=>i.add(e)),e.config.assets.forEach(e=>a.add(e))}),{facilitators:e.length,healthy:r.length,networks:Array.from(i),assets:Array.from(a),facilitatorDetails:t}}}let d=null;function n(){return d||(d=new u),d}e.s(["MetaFacilitator",()=>u,"getMetaFacilitator",()=>n]),r()}catch(e){r(e)}},!1),42373,e=>e.a(async(t,r)=>{try{var i=e.i(84170),a=e.i(57729),o=t([i,a]);[i,a]=o.then?(await o)():o,e.s(["MetaFacilitator",()=>i.MetaFacilitator,"getFacilitatorRouter",()=>a.getFacilitatorRouter,"getMetaFacilitator",()=>i.getMetaFacilitator]),r()}catch(e){r(e)}},!1),5371,e=>{e.v(t=>Promise.all(["server/chunks/src_integrations_x402_payment-header-parser_ts_db7a382b._.js"].map(t=>e.l(t))).then(()=>t(71556)))}];

//# sourceMappingURL=%5Broot-of-the-server%5D__3e9facb3._.js.map
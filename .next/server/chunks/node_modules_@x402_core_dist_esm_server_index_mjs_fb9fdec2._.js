module.exports=[81315,e=>{"use strict";var t=e.i(40402),r=e.i(26249);e.i(76273);var i=e.i(59456);e.i(73324);var s=class{constructor(e){this.registeredServerSchemes=new Map,this.supportedResponsesMap=new Map,this.facilitatorClientsMap=new Map,this.registeredExtensions=new Map,this.beforeVerifyHooks=[],this.afterVerifyHooks=[],this.onVerifyFailureHooks=[],this.beforeSettleHooks=[],this.afterSettleHooks=[],this.onSettleFailureHooks=[],e?Array.isArray(e)?this.facilitatorClients=e.length>0?e:[new t.HTTPFacilitatorClient]:this.facilitatorClients=[e]:this.facilitatorClients=[new t.HTTPFacilitatorClient]}register(e,t){this.registeredServerSchemes.has(e)||this.registeredServerSchemes.set(e,new Map);let r=this.registeredServerSchemes.get(e);return r.has(t.scheme)||r.set(t.scheme,t),this}hasRegisteredScheme(e,t){return!!(0,i.findByNetworkAndScheme)(this.registeredServerSchemes,t,e)}registerExtension(e){return this.registeredExtensions.set(e.key,e),this}enrichExtensions(e,t){let r={};for(let[i,s]of Object.entries(e)){let e=this.registeredExtensions.get(i);e?.enrichDeclaration?r[i]=e.enrichDeclaration(s,t):r[i]=s}return r}onBeforeVerify(e){return this.beforeVerifyHooks.push(e),this}onAfterVerify(e){return this.afterVerifyHooks.push(e),this}onVerifyFailure(e){return this.onVerifyFailureHooks.push(e),this}onBeforeSettle(e){return this.beforeSettleHooks.push(e),this}onAfterSettle(e){return this.afterSettleHooks.push(e),this}onSettleFailure(e){return this.onSettleFailureHooks.push(e),this}async initialize(){for(let e of(this.supportedResponsesMap.clear(),this.facilitatorClientsMap.clear(),this.facilitatorClients))try{let t=await e.getSupported();for(let r of t.kinds){let i=r.x402Version;this.supportedResponsesMap.has(i)||this.supportedResponsesMap.set(i,new Map);let s=this.supportedResponsesMap.get(i);this.facilitatorClientsMap.has(i)||this.facilitatorClientsMap.set(i,new Map);let o=this.facilitatorClientsMap.get(i);s.has(r.network)||s.set(r.network,new Map);let n=s.get(r.network);o.has(r.network)||o.set(r.network,new Map);let a=o.get(r.network);n.has(r.scheme)||(n.set(r.scheme,t),a.set(r.scheme,e))}}catch(e){console.warn(`Failed to fetch supported kinds from facilitator: ${e}`)}}getSupportedKind(e,t,r){let s=this.supportedResponsesMap.get(e);if(!s)return;let o=(0,i.findByNetworkAndScheme)(s,r,t);if(o)return o.kinds.find(i=>i.x402Version===e&&i.network===t&&i.scheme===r)}getFacilitatorExtensions(e,t,r){let s=this.supportedResponsesMap.get(e);if(!s)return[];let o=(0,i.findByNetworkAndScheme)(s,r,t);return o?.extensions||[]}async buildPaymentRequirements(e){let t=[],s=e.scheme,o=(0,i.findByNetworkAndScheme)(this.registeredServerSchemes,s,e.network);if(!o)return console.warn(`No server implementation registered for scheme: ${s}, network: ${e.network}`),t;let n=this.getSupportedKind(r.x402Version,e.network,o.scheme);if(!n)throw Error(`Facilitator does not support ${o.scheme} on ${e.network}. Make sure to call initialize() to fetch supported kinds from facilitators.`);let a=this.getFacilitatorExtensions(r.x402Version,e.network,o.scheme),l=await o.parsePrice(e.price,e.network),c={scheme:o.scheme,network:e.network,amount:l.amount,asset:l.asset,payTo:e.payTo,maxTimeoutSeconds:e.maxTimeoutSeconds||300,extra:{...l.extra}};return t.push(await o.enhancePaymentRequirements(c,{...n,x402Version:r.x402Version},a)),t}async buildPaymentRequirementsFromOptions(e,t){let r=[];for(let i of e){let e="function"==typeof i.payTo?await i.payTo(t):i.payTo,s="function"==typeof i.price?await i.price(t):i.price,o={scheme:i.scheme,payTo:e,price:s,network:i.network,maxTimeoutSeconds:i.maxTimeoutSeconds},n=await this.buildPaymentRequirements(o);r.push(...n)}return r}createPaymentRequiredResponse(e,t,r,i){let s={x402Version:2,error:r,resource:t,accepts:e};return i&&Object.keys(i).length>0&&(s.extensions=i),s}async verifyPayment(e,t){let r={paymentPayload:e,requirements:t};for(let e of this.beforeVerifyHooks){let t=await e(r);if(t&&"abort"in t&&t.abort)return{isValid:!1,invalidReason:t.reason}}try{let i,s=this.getFacilitatorClient(e.x402Version,t.network,t.scheme);if(s)i=await s.verify(e,t);else{let r;for(let s of this.facilitatorClients)try{i=await s.verify(e,t);break}catch(e){r=e}if(!i)throw r||Error(`No facilitator supports ${t.scheme} on ${t.network} for v${e.x402Version}`)}let o={...r,result:i};for(let e of this.afterVerifyHooks)await e(o);return i}catch(t){let e={...r,error:t};for(let t of this.onVerifyFailureHooks){let r=await t(e);if(r&&"recovered"in r&&r.recovered)return r.result}throw t}}async settlePayment(e,t){let r={paymentPayload:e,requirements:t};for(let e of this.beforeSettleHooks){let t=await e(r);if(t&&"abort"in t&&t.abort)throw Error(`Settlement aborted: ${t.reason}`)}try{let i,s=this.getFacilitatorClient(e.x402Version,t.network,t.scheme);if(s)i=await s.settle(e,t);else{let r;for(let s of this.facilitatorClients)try{i=await s.settle(e,t);break}catch(e){r=e}if(!i)throw r||Error(`No facilitator supports ${t.scheme} on ${t.network} for v${e.x402Version}`)}let o={...r,result:i};for(let e of this.afterSettleHooks)await e(o);return i}catch(t){let e={...r,error:t};for(let t of this.onSettleFailureHooks){let r=await t(e);if(r&&"recovered"in r&&r.recovered)return r.result}throw t}}findMatchingRequirements(e,t){switch(t.x402Version){case 2:return e.find(e=>(0,i.deepEqual)(e,t.accepted));case 1:return e.find(e=>e.scheme===t.accepted.scheme&&e.network===t.accepted.network);default:throw Error(`Unsupported x402 version: ${t.x402Version}`)}}async processPaymentRequest(e,t,r,i){let s=await this.buildPaymentRequirements(t);if(!e)return{success:!1,requiresPayment:this.createPaymentRequiredResponse(s,r,"Payment required",i)};let o=this.findMatchingRequirements(s,e);if(!o)return{success:!1,requiresPayment:this.createPaymentRequiredResponse(s,r,"No matching payment requirements found",i)};let n=await this.verifyPayment(e,o);return n.isValid?{success:!0,verificationResult:n}:{success:!1,error:n.invalidReason,verificationResult:n}}getFacilitatorClient(e,t,r){let s=this.facilitatorClientsMap.get(e);if(s)return(0,i.findByNetworkAndScheme)(s,r,t)}};e.s(["x402ResourceServer",()=>s],9415),e.i(9415),e.s(["HTTPFacilitatorClient",()=>t.HTTPFacilitatorClient,"RouteConfigurationError",()=>t.RouteConfigurationError,"x402HTTPResourceServer",()=>t.x402HTTPResourceServer,"x402ResourceServer",()=>s],81315)}];

//# sourceMappingURL=node_modules_%40x402_core_dist_esm_server_index_mjs_fb9fdec2._.js.map
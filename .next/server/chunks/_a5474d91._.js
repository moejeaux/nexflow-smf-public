module.exports=[28660,e=>{"use strict";var t=e.i(56036),a=e.i(71556),r=e.i(92688);let n=(0,e.i(50377).createLogger)({component:"X402Demo"}),o=(0,r.toAtomicUnits)("0.005",6);function s(e){let t=(0,r.normalizeNetwork)(e.network||"base"),a=e.asset||process.env.USDC_ADDRESS||"0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913",n=e.recipientAddress||process.env.X402_RECIPIENT_ADDRESS||"";if(!n)throw Error("Recipient address is required for x402 demo payments");let s=Math.floor(Date.now()/1e3),i=s.toString(),l=(s+300).toString();return{scheme:"exact",network:t,to:n,value:o,resource:e.resource,asset:a,validAfter:i,validBefore:l,description:"NexFlow x402 Demo Resource",mimeType:"application/json",maxTimeoutSeconds:300}}async function i(e,r){let o={requestId:r.requestId,apiKeyId:r.apiKeyId,endpoint:r.endpoint};try{let s=e.headers.get("x-payment");if(!s)return n.warn(o,"Missing x-payment header"),{ok:!1,errorCode:"PAYMENT_REQUIRED",status:402,details:"x-payment header is required"};let i=(0,a.parseX402Header)(s);if(!i.valid||!i.parsed)return n.warn({...o,error:i.error},"Invalid payment header format"),{ok:!1,errorCode:"INVALID_PAYMENT_HEADER",status:400,details:i.error||"Invalid payment header format"};let l=i.parsed,d={payment:s,paymentPayload:{x402Version:2,scheme:"exact",network:r.paymentRequirements.network,payload:{signature:l.signature,authorization:l.authorization}},paymentRequirements:r.paymentRequirements},u=(0,t.getCDPFacilitator)(),c=await u.verifyPaymentWithRetry(d);if(c.success&&c.valid)return n.info({...o,cdpStatus:"success",transactionHash:c.transactionHash,amount:l.authorization.value},"Payment verified successfully"),{ok:!0,reference:c.transactionHash||l.txHash||"verified",amount:l.authorization.value,asset:r.paymentRequirements.asset,network:r.paymentRequirements.network,transactionHash:c.transactionHash||l.txHash};{let e=c.error||"VERIFICATION_FAILED";return n.error({...o,cdpStatus:"failed",errorCode:e,errorDetails:c.errorDetails},"Payment verification failed"),{ok:!1,errorCode:e,status:400,details:c.error||"Payment verification failed"}}}catch(e){return n.error({...o,error:e,cdpStatus:"error"},"Payment verification error"),{ok:!1,errorCode:"VERIFICATION_ERROR",status:500,details:e instanceof Error?e.message:"Unknown verification error"}}}e.s(["buildPaymentRequirements",()=>s,"verifyPaymentFromRequest",()=>i])},73928,e=>e.a(async(t,a)=>{try{var r=e.i(89171),n=e.i(79832),o=e.i(34006),s=e.i(50377),i=e.i(7087),l=e.i(28660),d=e.i(68237),u=e.i(19585),c=t([n,i,d,u]);[n,i,d,u]=c.then?(await c)():c;let m=(0,s.createLogger)({component:"X402DemoResource"});async function p(e){let t=await (0,i.extractRequestContext)(e,"/api/v1/x402/demo/resource");try{let a=await (0,o.rateLimitByApiKey)(e);if(a&&!a.allowed)return m.warn({apiKeyId:t.apiKeyId,limit:a.limit},"Rate limit exceeded"),(0,i.wrapResponse)((0,o.createRateLimitResponse)(a),t);let s=await (0,n.requireAuth)(e,"user");if("response"in s)return(0,i.wrapResponse)(s.response,t);let{apiKey:c}=s;t.apiKeyId=c.id;let p="https://nexflowapp.app/api/v1/x402/demo/resource",R=(0,l.buildPaymentRequirements)({resource:p,network:"base",asset:process.env.USDC_ADDRESS||"0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913",recipientAddress:process.env.X402_RECIPIENT_ADDRESS});if(!e.headers.get("x-payment")){let e=r.NextResponse.json({x402Version:2,error:"Payment required",accepts:[{scheme:R.scheme,network:R.network,maxAmountRequired:R.value,asset:R.asset,payTo:R.to,resource:R.resource,description:R.description,mimeType:R.mimeType,maxTimeoutSeconds:R.maxTimeoutSeconds,validAfter:R.validAfter,validBefore:R.validBefore}]},{status:402});return await (0,u.logX402Call)({endpointId:"x402_demo_resource",resource:p,facilitator:"CDP",chainId:8453,asset:R.asset,amount:R.value,status:"payment_required",errorCode:"PAYMENT_REQUIRED",latencyMs:Date.now()-t.startTime,customerId:t.requestId}),a&&(0,o.addRateLimitHeaders)(e,a),(0,i.wrapResponse)(e,t)}let h=(0,d.hasX402DemoAllowance)(c);if(!h.hasAllowance){let e=r.NextResponse.json({code:"X402_DEMO_LIMIT_REACHED",message:"Your free x402 demo allowance is exhausted. Connect your own wallet or upgrade to continue.",limits:{callsUsed:c.x402DemoCallsUsed||0,callsLimit:c.x402DemoCallsLimit||200,amountUsed:c.x402DemoAmountUsed||"0",amountLimit:c.x402DemoAmountLimit||"1000000",callsRemaining:h.callsRemaining,amountRemaining:h.amountRemaining}},{status:403});return await (0,u.logX402Call)({endpointId:"x402_demo_resource",resource:p,facilitator:"CDP",chainId:8453,asset:R.asset,amount:R.value,status:"failed",errorCode:"X402_DEMO_LIMIT_REACHED",latencyMs:Date.now()-t.startTime,customerId:t.requestId}),(0,i.wrapResponse)(e,t)}let f=await (0,l.verifyPaymentFromRequest)(e,{requestId:t.requestId,apiKeyId:c.id,endpoint:"/api/v1/x402/demo/resource",paymentRequirements:R});if(!f.ok){let e=r.NextResponse.json({code:f.errorCode,message:f.details},{status:f.status});return await (0,u.logX402Call)({endpointId:"x402_demo_resource",resource:p,facilitator:"CDP",chainId:8453,asset:R.asset,amount:R.value,status:"failed",errorCode:f.errorCode,latencyMs:Date.now()-t.startTime,customerId:t.requestId}),(0,i.wrapResponse)(e,t)}let w=(c.x402DemoCallsUsed||0)+1,v=BigInt(c.x402DemoAmountUsed||"0"),y=BigInt(f.amount),x=(v+y).toString();await (0,d.updateApiKeyX402DemoAllowance)(c.id,w,x),await (0,u.logX402Call)({endpointId:"x402_demo_resource",resource:p,facilitator:"CDP",chainId:8453,asset:f.asset,amount:f.amount,status:"success",x402TxHash:f.transactionHash,latencyMs:Date.now()-t.startTime,customerId:t.requestId});let E=r.NextResponse.json({success:!0,demo:!0,message:"Paid x402 demo resource via NexFlow",paymentReference:f.reference,transactionHash:f.transactionHash,amount:f.amount,asset:f.asset,network:f.network,allowance:{callsUsed:w,callsLimit:c.x402DemoCallsLimit||200,amountUsed:x,amountLimit:c.x402DemoAmountLimit||"1000000"}});return a&&(0,o.addRateLimitHeaders)(E,a),(0,i.wrapResponse)(E,t)}catch(e){return(0,i.createErrorResponse)(t,e instanceof Error?e:Error("Internal server error"),500,"INTERNAL_ERROR")}}e.s(["POST",()=>p]),a()}catch(e){a(e)}},!1),63451,e=>e.a(async(t,a)=>{try{var r=e.i(47909),n=e.i(74017),o=e.i(96250),s=e.i(59756),i=e.i(61916),l=e.i(14444),d=e.i(37092),u=e.i(69741),c=e.i(16795),p=e.i(87718),m=e.i(95169),R=e.i(47587),h=e.i(66012),f=e.i(70101),w=e.i(26937),v=e.i(10372),y=e.i(93695);e.i(52474);var x=e.i(220),E=e.i(73928),C=t([E]);[E]=C.then?(await C)():C;let D=new r.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/v1/x402/demo/resource/route",pathname:"/api/v1/x402/demo/resource",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/v1/x402/demo/resource/route.ts",nextConfigOutput:"standalone",userland:E}),{workAsyncStorage:A,workUnitAsyncStorage:_,serverHooks:T}=D;function I(){return(0,o.patchFetch)({workAsyncStorage:A,workUnitAsyncStorage:_})}async function g(e,t,a){D.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/v1/x402/demo/resource/route";r=r.replace(/\/index$/,"")||"/";let o=await D.prepare(e,t,{srcPage:r,multiZoneDraftMode:!1});if(!o)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:E,params:C,nextConfig:I,parsedUrl:g,isDraftMode:A,prerenderManifest:_,routerServerContext:T,isOnDemandRevalidate:P,revalidateOnlyGenerated:N,resolvedPathname:S,clientReferenceManifest:q,serverActionsManifest:H}=o,b=(0,u.normalizeAppPath)(r),k=!!(_.dynamicRoutes[b]||_.routes[S]),U=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,g,!1):t.end("This page could not be found"),null);if(k&&!A){let e=!!_.routes[S],t=_.dynamicRoutes[b];if(t&&!1===t.fallback&&!e){if(I.experimental.adapterPath)return await U();throw new y.NoFallbackError}}let M=null;!k||D.isDev||A||(M=S,M="/index"===M?"/":M);let O=!0===D.isDev||!k,L=k&&!O;H&&q&&(0,l.setReferenceManifestsSingleton)({page:r,clientReferenceManifest:q,serverActionsManifest:H,serverModuleMap:(0,d.createServerModuleMap)({serverActionsManifest:H})});let F=e.method||"GET",K=(0,i.getTracer)(),X=K.getActiveScopeSpan(),j={params:C,prerenderManifest:_,renderOpts:{experimental:{authInterrupts:!!I.experimental.authInterrupts},cacheComponents:!!I.cacheComponents,supportsDynamicResponse:O,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:I.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>D.onRequestError(e,t,r,T)},sharedContext:{buildId:E}},B=new c.NodeNextRequest(e),$=new c.NodeNextResponse(t),V=p.NextRequestAdapter.fromNodeNextRequest(B,(0,p.signalFromNodeResponse)(t));try{let o=async e=>D.handle(V,j).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=K.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=a.get("next.route");if(n){let t=`${F} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${F} ${r}`)}),l=!!(0,s.getRequestMeta)(e,"minimalMode"),d=async s=>{var i,d;let u=async({previousCacheEntry:n})=>{try{if(!l&&P&&N&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await o(s);e.fetchMetrics=j.renderOpts.fetchMetrics;let i=j.renderOpts.pendingWaitUntil;i&&a.waitUntil&&(a.waitUntil(i),i=void 0);let d=j.renderOpts.collectedTags;if(!k)return await (0,h.sendResponse)(B,$,r,j.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(r.headers);d&&(t[v.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==j.renderOpts.collectedRevalidate&&!(j.renderOpts.collectedRevalidate>=v.INFINITE_CACHE)&&j.renderOpts.collectedRevalidate,n=void 0===j.renderOpts.collectedExpire||j.renderOpts.collectedExpire>=v.INFINITE_CACHE?void 0:j.renderOpts.collectedExpire;return{value:{kind:x.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:n}}}}catch(t){throw(null==n?void 0:n.isStale)&&await D.onRequestError(e,t,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,R.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:P})},T),t}},c=await D.handleResponse({req:e,nextConfig:I,cacheKey:M,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:_,isRoutePPREnabled:!1,isOnDemandRevalidate:P,revalidateOnlyGenerated:N,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:l});if(!k)return null;if((null==c||null==(i=c.value)?void 0:i.kind)!==x.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(d=c.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",P?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,f.fromNodeOutgoingHttpHeaders)(c.value.headers);return l&&k||p.delete(v.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,w.getCacheControlHeader)(c.cacheControl)),await (0,h.sendResponse)(B,$,new Response(c.value.body,{headers:p,status:c.value.status||200})),null};X?await d(X):await K.withPropagatedContext(e.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${F} ${r}`,kind:i.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},d))}catch(t){if(t instanceof y.NoFallbackError||await D.onRequestError(e,t,{routerKind:"App Router",routePath:b,routeType:"route",revalidateReason:(0,R.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:P})}),k)throw t;return await (0,h.sendResponse)(B,$,new Response(null,{status:500})),null}}e.s(["handler",()=>g,"patchFetch",()=>I,"routeModule",()=>D,"serverHooks",()=>T,"workAsyncStorage",()=>A,"workUnitAsyncStorage",()=>_]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=_a5474d91._.js.map
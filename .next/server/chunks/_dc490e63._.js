module.exports=[64837,e=>{"use strict";let t=(0,e.i(50377).createLogger)({component:"RoutingTuner"}),a={deprioritizeSuccessRateThreshold:parseFloat(process.env.ROUTING_TUNER_DEPRIORITIZE_SUCCESS_RATE||"0.85"),deprioritizeLatencyThresholdMs:parseInt(process.env.ROUTING_TUNER_DEPRIORITIZE_LATENCY_MS||"3000",10),promoteSuccessRateThreshold:parseFloat(process.env.ROUTING_TUNER_PROMOTE_SUCCESS_RATE||"0.98"),promoteLatencyThresholdMs:parseInt(process.env.ROUTING_TUNER_PROMOTE_LATENCY_MS||"500",10),minInvocationsForDecision:parseInt(process.env.ROUTING_TUNER_MIN_INVOCATIONS||"100",10),highConfidenceThreshold:parseFloat(process.env.ROUTING_TUNER_HIGH_CONFIDENCE||"0.8"),mediumConfidenceThreshold:parseFloat(process.env.ROUTING_TUNER_MEDIUM_CONFIDENCE||"0.5"),topPerformersCount:parseInt(process.env.ROUTING_TUNER_TOP_PERFORMERS||"3",10)};async function r(e){let r=[],o=new Date;t.info({facilitatorCount:e.facilitators.length,msg:"Running routing tuner"});let n=[...e.facilitators].filter(e=>e.totalInvocations>=a.minInvocationsForDecision).sort((e,t)=>t.score-e.score).slice(0,a.topPerformersCount).map(e=>e.id),i=[],s=[];for(let m of e.facilitators){var c,l,d,u;let e=function(e){let t=[],r=[],o=[],n=0;if(n="high"===e.confidence?a.highConfidenceThreshold+.1:"medium"===e.confidence?a.mediumConfidenceThreshold+.2:"low"===e.confidence?a.mediumConfidenceThreshold:.3,e.totalInvocations<a.minInvocationsForDecision)return{shouldDeprioritize:!1,deprioritizeReasons:[],deprioritizeReasonCode:null,shouldPromote:!1,promoteReasons:[],confidence:.2};e.successRate<a.deprioritizeSuccessRateThreshold&&(t.push(`Success rate ${(100*e.successRate).toFixed(1)}% below threshold ${100*a.deprioritizeSuccessRateThreshold}%`),o.push("low_success_rate")),e.avgLatencyMs>a.deprioritizeLatencyThresholdMs&&(t.push(`Average latency ${e.avgLatencyMs}ms exceeds threshold ${a.deprioritizeLatencyThresholdMs}ms`),o.push("high_latency")),"down"===e.status?(t.push("Facilitator status is down"),o.push("down_status")):"degraded"===e.status&&(t.push("Facilitator status is degraded"),o.push("degraded_status")),e.successRate>=a.promoteSuccessRateThreshold&&e.avgLatencyMs<=a.promoteLatencyThresholdMs&&r.push(`Excellent performance: ${(100*e.successRate).toFixed(1)}% success, ${e.avgLatencyMs}ms latency`),e.score>=90&&r.push(`High composite score: ${e.score.toFixed(1)}`);let i=null;return o.length>1?i="multiple_issues":1===o.length&&(i=o[0]),{shouldDeprioritize:t.length>0,deprioritizeReasons:t,deprioritizeReasonCode:i,shouldPromote:r.length>0&&0===t.length,promoteReasons:r,confidence:n}}(m);e.shouldDeprioritize&&e.deprioritizeReasonCode&&(i.push(m.id),r.push(function(e,r,o,n,i){let s="medium";return e.successRate<.5||"down"===e.status?s="critical":e.successRate<.7&&(s="high"),t.info({facilitatorId:e.id,reason:o,type:"FACILITATOR_DEPRIORITIZE",priority:s,confidence:n,successRate:e.successRate,avgLatencyMs:e.avgLatencyMs,status:e.status,triggeredConditions:r,msg:"Routing tuner deprioritized facilitator"}),{id:crypto.randomUUID(),createdAt:i,agent:"routing_tuner",type:"FACILITATOR_DEPRIORITIZE",facilitatorId:e.id,priority:s,confidence:n,details:{reason:o,metricsSnapshot:{timestamp:i.toISOString(),score:e.score,successRate:e.successRate,avgLatencyMs:e.avgLatencyMs,p95LatencyMs:e.p95LatencyMs,totalInvocations:e.totalInvocations,trustTier:e.trustTier,status:e.status,confidence:e.confidence},thresholdsUsed:{deprioritizeSuccessRate:a.deprioritizeSuccessRateThreshold,deprioritizeLatencyMs:a.deprioritizeLatencyThresholdMs,minInvocations:a.minInvocationsForDecision},triggeredConditions:r,isCurrentlyRoutable:"down"!==e.status&&"degraded"!==e.status},reasoning:`Recommend deprioritizing ${e.id}: ${r.join("; ")}`,status:"PENDING",expiresAt:new Date(i.getTime()+864e5)}}(m,e.deprioritizeReasons,e.deprioritizeReasonCode,e.confidence,o))),e.shouldPromote&&!n.includes(m.id)&&(s.push(m.id),r.push((c=m,l=e.promoteReasons,d=e.confidence,u=o,{id:crypto.randomUUID(),createdAt:u,agent:"routing_tuner",type:"FACILITATOR_PROMOTE",facilitatorId:c.id,priority:"low",confidence:d,details:{metricsSnapshot:{timestamp:u.toISOString(),score:c.score,successRate:c.successRate,avgLatencyMs:c.avgLatencyMs,p95LatencyMs:c.p95LatencyMs,totalInvocations:c.totalInvocations,trustTier:c.trustTier,status:c.status,confidence:c.confidence},thresholdsUsed:{promoteSuccessRate:a.promoteSuccessRateThreshold,promoteLatencyMs:a.promoteLatencyThresholdMs,minInvocations:a.minInvocationsForDecision},triggeredConditions:l},reasoning:`Recommend promoting ${c.id}: ${l.join("; ")}`,status:"PENDING",expiresAt:new Date(u.getTime()+6048e5)})))}for(let a of e.riskAnomalies)if("critical"===a.severity&&a.facilitatorId&&!r.find(e=>e.facilitatorId===a.facilitatorId&&"FACILITATOR_DEPRIORITIZE"===e.type)){let e="risk_anomaly";t.info({facilitatorId:a.facilitatorId,reason:e,type:"FACILITATOR_DEPRIORITIZE",priority:"critical",confidence:.9,anomalyId:a.id,anomalyType:a.type,anomalyDescription:a.description,msg:"Routing tuner deprioritized facilitator"}),r.push({id:crypto.randomUUID(),createdAt:o,agent:"routing_tuner",type:"FACILITATOR_DEPRIORITIZE",facilitatorId:a.facilitatorId,priority:"critical",confidence:.9,details:{reason:e,anomalyId:a.id,anomalyType:a.type,metrics:a.metrics},reasoning:`Critical risk anomaly detected: ${a.description}`,status:"PENDING",expiresAt:new Date(o.getTime()+864e5)})}return t.info({topPerformers:n,underperformers:i,newContenders:s,recommendationCount:r.length,msg:"Routing tuner completed"}),{recommendations:r,analysis:{topPerformers:n,underperformers:i,newContenders:s}}}e.s(["runRoutingTuner",()=>r])},39859,e=>{"use strict";let t=(0,e.i(50377).createLogger)({component:"PricingTuner"});async function a(e){let a=[];t.info({msg:"Running pricing tuner (stub)"});let r={recommendations:a,analysis:{resourcesReviewed:0,priceChangesProposed:a.length}};return t.info({recommendationCount:a.length,msg:"Pricing tuner completed (stub)"}),r}e.s(["runPricingTuner",()=>a])},68882,e=>{"use strict";let t=(0,e.i(50377).createLogger)({component:"ScoutTuner"}),a=["eip155:8453"],r=["USDC"];async function o(e){let o=[],n=new Date,i=[],s=[];for(let c of(t.info({pendingCount:e.pendingFacilitators.length,msg:"Running scout tuner"}),e.pendingFacilitators)){let l=function(e,t,o){let n=[],i=[],s=.5,c=!1,l=!1,d="low";void 0!==e.externalScore?e.externalScore>=60?(n.push(`External score ${e.externalScore} meets threshold`),s+=.2):i.push(`External score ${e.externalScore} below threshold 60`):(n.push("No external score available - manual review recommended"),s-=.1),0===e.networks.length||e.networks.some(e=>a.includes(e))?e.networks.length>0&&(n.push(`Supports required network(s): ${e.networks.join(", ")}`),s+=.1):i.push(`Does not support required networks. Has: ${e.networks.join(", ")}`),0===e.assets.length||e.assets.some(e=>r.includes(e))?e.assets.length>0&&(n.push(`Supports required asset(s): ${e.assets.join(", ")}`),s+=.1):i.push(`Does not support required assets. Has: ${e.assets.join(", ")}`),"bazaar"===e.source&&(n.push("Discovered from Bazaar marketplace"),s+=.1,d="medium");let u=(o.getTime()-e.discoveredAt.getTime())/864e5;return u>30&&i.push(`Stale: pending for ${Math.round(u)} days without progress`),t.facilitators.filter(e=>e.score>=80).length>=3?(n.push("Multiple high-performing facilitators already available"),d="low",s-=.1):(n.push("Could fill gap in facilitator coverage"),d="medium",s+=.1),s=Math.max(.1,Math.min(.95,s)),i.length>0&&0===n.length?l=!0:n.length>0&&0===i.length&&s>=.5&&(c=!0),{readyForOnboarding:c,shouldReject:l,priority:d,confidence:s,reasons:n,rejectionReasons:i}}(c,e,n);if(l.readyForOnboarding){i.push(c.id);let e=c.probeStats||{};t.info({type:"FACILITATOR_ONBOARD",watchlistId:c.id,facilitatorName:c.name,source:c.source,avgLatencyMs:e.avgLatencyMs,successRate:e.successRate,healthScore:e.healthScore,lastProbeAt:e.lastProbeAt?.toISOString(),lastHttpStatus:e.lastHttpStatus,externalScore:c.externalScore,confidence:l.confidence,priority:l.priority,msg:"Scout tuner recommends onboarding facilitator"}),o.push({id:crypto.randomUUID(),createdAt:n,agent:"scout_tuner",type:"FACILITATOR_ONBOARD",facilitatorId:c.id,priority:l.priority,confidence:l.confidence,details:{name:c.name,source:c.source,discoveredAt:c.discoveredAt.toISOString(),externalScore:c.externalScore,networks:c.networks,assets:c.assets,evaluationReasons:l.reasons,probeStats:{watchlistId:c.id,avgLatencyMs:e.avgLatencyMs,successRate:e.successRate,healthScore:e.healthScore,lastProbeAt:e.lastProbeAt?.toISOString(),lastHttpStatus:e.lastHttpStatus,probeCount:e.probeCount}},reasoning:`Recommend onboarding ${c.name}: ${l.reasons.join("; ")}`,status:"PENDING",expiresAt:new Date(n.getTime()+12096e5)})}else l.shouldReject&&(s.push(c.id),t.info({facilitatorId:c.id,reasons:l.rejectionReasons,msg:"Pending facilitator rejected"}))}let c=e.pendingFacilitators.filter(e=>(n.getTime()-e.discoveredAt.getTime())/864e5>7);c.length>0&&o.push({id:crypto.randomUUID(),createdAt:n,agent:"scout_tuner",type:"RISK_ALERT",priority:"low",confidence:.8,details:{staleFacilitatorIds:c.map(e=>e.id),staleFacilitatorNames:c.map(e=>e.name),maxAgeDays:Math.max(...c.map(e=>(n.getTime()-e.discoveredAt.getTime())/864e5))},reasoning:`${c.length} facilitator(s) have been pending evaluation for more than 7 days`,status:"PENDING"});let l={recommendations:o,analysis:{pendingEvaluated:e.pendingFacilitators.length,readyForOnboarding:i,rejected:s}};return t.info({pendingEvaluated:e.pendingFacilitators.length,readyForOnboarding:i,rejected:s,recommendationCount:o.length,msg:"Scout tuner completed"}),l}e.s(["runScoutTuner",()=>o])},3633,e=>e.a(async(t,a)=>{try{var r=e.i(50377),o=e.i(62556),n=e.i(41500),i=e.i(84170),s=e.i(24297),c=e.i(59670),l=e.i(64837),d=e.i(39859),u=e.i(68882),m=t([n,i,s,c]);[n,i,s,c]=m.then?(await m)():m;let f=(0,r.createLogger)({component:"Coordinator"}),_=(0,o.getCircuitBreaker)({name:"coordinator-metrics",failureThreshold:3,successThreshold:2,resetTimeout:6e4,failureWindow:3e5,requestTimeout:3e4}),R=(0,o.getCircuitBreaker)({name:"coordinator-meta-facilitator",failureThreshold:3,successThreshold:2,resetTimeout:6e4,failureWindow:3e5,requestTimeout:2e4}),y=(0,o.getCircuitBreaker)({name:"coordinator-watchlist",failureThreshold:5,successThreshold:2,resetTimeout:3e4,failureWindow:12e4,requestTimeout:1e4}),E=null,w=["cdp","payai","x402rs","dexter"];async function p(){var e;let t,a,r,o=new Date;f.info({msg:"Building world state for coordinator"});let s=await _.execute(()=>(0,n.rankFacilitators)(w,"1d")),c=(0,i.getMetaFacilitator)(),l=await R.execute(()=>c.getStatus()),d=[];for(let e of s.rankings){let t,a=l.facilitatorDetails.find(t=>t.id===e.facilitatorId),r=a?.healthy??!1,o="none"!==e.confidence,n=e.successRate>.1,i=r&&o&&n;if(!i){let e=[];r||e.push("failing health check"),o||e.push("no performance data"),n||e.push("success rate critically low"),t=e.join(", ")}d.push({id:e.facilitatorId,name:a?.name||e.facilitatorId,score:e.score,successRate:e.successRate,avgLatencyMs:e.avgLatencyMs||0,p95LatencyMs:e.p95LatencyMs,totalInvocations:e.totalInvocations,confidence:e.confidence,trustTier:function(e){switch(e){case"high":return"high";case"medium":return"medium";case"low":return"low";case"none":return"unknown"}}(e.confidence),status:a?.healthy?"healthy":"unknown",networks:l.networks,assets:l.assets,feeBps:0,scoreDelta24h:void 0,successRateDelta24h:void 0,isRoutable:i,nonRoutableReason:t})}let u=await h(),m=function(e){let t=[];for(let a of e)a.successRate<.7?t.push({id:`anomaly-${a.id}-success-critical`,detectedAt:new Date,type:"high_error_rate",facilitatorId:a.id,severity:"critical",description:`Facilitator ${a.id} has critical error rate: ${((1-a.successRate)*100).toFixed(1)}%`,metrics:{successRate:a.successRate,threshold:.7},resolved:!1}):a.successRate<.9&&t.push({id:`anomaly-${a.id}-success-warning`,detectedAt:new Date,type:"high_error_rate",facilitatorId:a.id,severity:"medium",description:`Facilitator ${a.id} has elevated error rate: ${((1-a.successRate)*100).toFixed(1)}%`,metrics:{successRate:a.successRate,threshold:.9},resolved:!1}),a.avgLatencyMs>5e3?t.push({id:`anomaly-${a.id}-latency-critical`,detectedAt:new Date,type:"latency_spike",facilitatorId:a.id,severity:"high",description:`Facilitator ${a.id} has critical latency: ${a.avgLatencyMs}ms`,metrics:{avgLatencyMs:a.avgLatencyMs,threshold:5e3},resolved:!1}):a.avgLatencyMs>2e3&&t.push({id:`anomaly-${a.id}-latency-warning`,detectedAt:new Date,type:"latency_spike",facilitatorId:a.id,severity:"medium",description:`Facilitator ${a.id} has elevated latency: ${a.avgLatencyMs}ms`,metrics:{avgLatencyMs:a.avgLatencyMs,threshold:2e3},resolved:!1});return t}(d),p=(t=(e=d).reduce((e,t)=>e+t.totalInvocations,0),a=e.reduce((e,t)=>e+t.successRate*t.totalInvocations,0),r=e.reduce((e,t)=>e+t.avgLatencyMs*t.totalInvocations,0),{totalRoutesLast24h:t,successRateLast24h:t>0?a/t:0,avgLatencyLast24h:t>0?r/t:0,totalVolumeLast24h:void 0}),g=d.map(e=>({facilitatorId:e.id,routeCount:e.totalInvocations,successCount:Math.round(e.totalInvocations*e.successRate),avgLatencyMs:e.avgLatencyMs})),y={timestamp:o,facilitators:d,pendingFacilitators:u,riskAnomalies:m,aggregates:p,recentDecisions:g};return f.info({facilitatorCount:d.length,pendingCount:u.length,anomalyCount:m.length,msg:"World state built"}),E={state:y,cachedAt:new Date},f.info({msg:"World state cache updated"}),y}async function g(){let e,t,a,r,o=crypto.randomUUID(),n=new Date,i=[];f.info({runId:o,msg:"Starting coordinator tick"});let s=!1;try{e=await p()}catch(r){let t=r instanceof Error?r.message:"Unknown error";i.push(`World state build failed: ${t}`),f.error({runId:o,error:t,msg:"World state build failed"});let a=function(){if(!E)return null;let e=Date.now()-E.cachedAt.getTime();return e>3e5?(f.info({cacheAgeMs:e,ttlMs:3e5,msg:"World state cache expired"}),null):E.state}();if(!a)return f.error({runId:o,msg:"No cached world state available for fallback"}),{runId:o,startedAt:n,completedAt:new Date,worldState:{timestamp:new Date,facilitators:[],pendingFacilitators:[],riskAnomalies:[],aggregates:{totalRoutesLast24h:0,successRateLast24h:0,avgLatencyLast24h:0},recentDecisions:[]},routingTuner:{recommendations:[],analysis:{topPerformers:[],underperformers:[],newContenders:[]}},pricingTuner:{recommendations:[],analysis:{resourcesReviewed:0,priceChangesProposed:0}},scoutTuner:{recommendations:[],analysis:{pendingEvaluated:0,readyForOnboarding:[],rejected:[]}},totalRecommendations:0,errors:i};e=a,s=!0,f.warn({runId:o,cachedAt:E?.cachedAt,msg:"Using cached world state as fallback"})}try{t=await (0,l.runRoutingTuner)(e),f.info({runId:o,recommendations:t.recommendations.length,msg:"Routing tuner completed"})}catch(a){let e=a instanceof Error?a.message:"Unknown error";i.push(`Routing tuner failed: ${e}`),f.error({runId:o,error:e,msg:"Routing tuner failed"}),t={recommendations:[],analysis:{topPerformers:[],underperformers:[],newContenders:[]}}}try{a=await (0,d.runPricingTuner)(e),f.info({runId:o,recommendations:a.recommendations.length,msg:"Pricing tuner completed"})}catch(t){let e=t instanceof Error?t.message:"Unknown error";i.push(`Pricing tuner failed: ${e}`),f.error({runId:o,error:e,msg:"Pricing tuner failed"}),a={recommendations:[],analysis:{resourcesReviewed:0,priceChangesProposed:0}}}try{r=await (0,u.runScoutTuner)(e),f.info({runId:o,recommendations:r.recommendations.length,msg:"Scout tuner completed"})}catch(t){let e=t instanceof Error?t.message:"Unknown error";i.push(`Scout tuner failed: ${e}`),f.error({runId:o,error:e,msg:"Scout tuner failed"}),r={recommendations:[],analysis:{pendingEvaluated:0,readyForOnboarding:[],rejected:[]}}}let m=[...t.recommendations,...a.recommendations,...r.recommendations];if(m.length>0)try{await (0,c.createRecommendations)(m.map(e=>({agent:e.agent,type:e.type,facilitatorId:e.facilitatorId,resourceId:e.resourceId,priority:e.priority,confidence:e.confidence,details:e.details,reasoning:e.reasoning,expiresAt:e.expiresAt}))),f.info({runId:o,count:m.length,msg:"Recommendations persisted"})}catch(t){let e=t instanceof Error?t.message:"Unknown error";i.push(`Failed to persist recommendations: ${e}`),f.error({runId:o,error:e,msg:"Failed to persist recommendations"})}let g=new Date,h={runId:o,startedAt:n,completedAt:g,worldState:e,routingTuner:t,pricingTuner:a,scoutTuner:r,totalRecommendations:m.length,errors:i};return f.info({runId:o,durationMs:g.getTime()-n.getTime(),totalRecommendations:m.length,errorCount:i.length,usedCachedState:s,msg:"Coordinator tick completed"}),h}async function h(){try{return(await y.execute(()=>(0,s.getActiveWatchlistItems)())).filter(e=>"facilitator_discovery"===e.category||"bazaar_discovery"===e.category).map(e=>{let t;null!==e.last_http_status&&(t=e.last_http_status>=200&&e.last_http_status<300?100:e.last_http_status>=300&&e.last_http_status<400?80:20*(e.last_http_status>=400&&e.last_http_status<500));let a=null!==e.last_http_status?+(e.last_http_status>=200&&e.last_http_status<300):void 0;return{id:`watchlist-${e.id}`,name:e.root_domain,discoveredAt:new Date(e.created_at),source:"bazaar_discovery"===e.category?"bazaar":"watchlist",networks:[],assets:[],status:"pending_evaluation",probeStats:{healthScore:t,successRate:a,lastProbeAt:e.last_checked_at?new Date(e.last_checked_at):void 0,lastHttpStatus:e.last_http_status??void 0}}})}catch(e){return f.warn({error:e,msg:"Failed to get pending facilitators from watchlist"}),[]}}e.s(["runCoordinatorTick",()=>g]),a()}catch(e){a(e)}},!1),57466,e=>e.a(async(t,a)=>{try{var r=e.i(24924),o=e.i(50377),n=t([r]);async function i(e,t,a){let o=(0,r.getDb)(),n="pool"in o||"function"==typeof o.pool?.query,i=n?`SELECT 1 FROM routing_experiments 
       WHERE route_id = $1 AND algorithm = $2 AND algorithm_version = $3 
       LIMIT 1`:`SELECT 1 FROM routing_experiments 
       WHERE route_id = ? AND algorithm = ? AND algorithm_version = ? 
       LIMIT 1`;return n?(await o.pool.query(i,[e,t,a])).rows.length>0:!!o.prepare(i).get(e,t,a)}async function s(e){let t=(0,r.getDb)(),a=crypto.randomUUID(),o="pool"in t||"function"==typeof t.pool?.query,n={id:a,...e},i=1===e.actualReward.success,s=e.actualReward.latencyMs??null,c=e.actualReward.costBps??null;return o?await t.pool.query(`INSERT INTO routing_experiments (
        id, route_id, timestamp, context, context_hash, available_facilitators,
        actual_facilitator, actual_reward,
        bandit_chosen_facilitator, bandit_estimated_reward, is_counterfactual,
        algorithm, algorithm_version, algorithm_state,
        success, latency_ms, cost_bps
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17)
      ON CONFLICT (route_id, algorithm, algorithm_version) DO NOTHING`,[a,e.routeId||null,e.timestamp.toISOString(),JSON.stringify(e.context),e.contextHash,JSON.stringify(e.availableFacilitators),e.actualFacilitator,JSON.stringify(e.actualReward),e.banditChosenFacilitator,e.banditEstimatedReward,e.isCounterfactual||!1,e.algorithm,e.algorithmVersion,e.algorithmState?JSON.stringify(e.algorithmState):null,i,s,c]):t.prepare(`
      INSERT OR IGNORE INTO routing_experiments (
        id, route_id, timestamp, context, context_hash, available_facilitators,
        actual_facilitator, actual_reward,
        bandit_chosen_facilitator, bandit_estimated_reward, is_counterfactual,
        algorithm, algorithm_version, algorithm_state,
        success, latency_ms, cost_bps
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(a,e.routeId||null,e.timestamp.toISOString(),JSON.stringify(e.context),e.contextHash,JSON.stringify(e.availableFacilitators),e.actualFacilitator,JSON.stringify(e.actualReward),e.banditChosenFacilitator,e.banditEstimatedReward,+!!e.isCounterfactual,e.algorithm,e.algorithmVersion,e.algorithmState?JSON.stringify(e.algorithmState):null,+!!i,s,c),n}async function c(e){let t=(0,r.getDb)();return"pool"in t||"function"==typeof t.pool?.query?(await t.pool.query("DELETE FROM routing_experiments WHERE created_at < $1",[e.toISOString()])).rowCount||0:t.prepare("DELETE FROM routing_experiments WHERE created_at < ?").run(e.toISOString()).changes||0}async function l(e,t,a,o){let n=(0,r.getDb)(),i="pool"in n||"function"==typeof n.pool?.query,s=new Date().toISOString();i?await n.pool.query(`INSERT INTO bandit_arm_states (
        algorithm, algorithm_version, context_hash, facilitator_id,
        pulls, total_reward, avg_reward, last_pulled, updated_at,
        success_count, failure_count
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11)
      ON CONFLICT (algorithm, algorithm_version, context_hash, facilitator_id)
      DO UPDATE SET
        pulls = EXCLUDED.pulls,
        total_reward = EXCLUDED.total_reward,
        avg_reward = EXCLUDED.avg_reward,
        last_pulled = EXCLUDED.last_pulled,
        updated_at = EXCLUDED.updated_at,
        success_count = EXCLUDED.success_count,
        failure_count = EXCLUDED.failure_count`,[e,t,a,o.facilitatorId,o.pulls,o.totalReward,o.avgReward,o.lastPulled?.toISOString()||null,s,o.successCount??0,o.failureCount??0]):n.prepare(`
      INSERT OR REPLACE INTO bandit_arm_states (
        algorithm, algorithm_version, context_hash, facilitator_id,
        pulls, total_reward, avg_reward, last_pulled, updated_at,
        success_count, failure_count
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(e,t,a,o.facilitatorId,o.pulls,o.totalReward,o.avgReward,o.lastPulled?.toISOString()||null,s,o.successCount??0,o.failureCount??0)}async function d(e,t,a){let o,n,i=(0,r.getDb)(),s="pool"in i||"function"==typeof i.pool?.query,c=[e,t];s?(o="SELECT * FROM bandit_arm_states WHERE algorithm = $1 AND algorithm_version = $2",a&&(o+=" AND context_hash = $3",c.push(a))):(o="SELECT * FROM bandit_arm_states WHERE algorithm = ? AND algorithm_version = ?",a&&(o+=" AND context_hash = ?",c.push(a))),n=s?(await i.pool.query(o,c)).rows:i.prepare(o).all(...c);let l=new Map;for(let e of n){let t=`${e.context_hash}-${e.facilitator_id}`;l.set(t,{facilitatorId:e.facilitator_id,pulls:e.pulls,totalReward:parseFloat(e.total_reward),avgReward:parseFloat(e.avg_reward),lastPulled:e.last_pulled?new Date(e.last_pulled):void 0})}return l}async function u(e,t,a){let o,n=(0,r.getDb)(),i="pool"in n||"function"==typeof n.pool?.query,s=[e,t];return i?(o=`
      SELECT 
        context_hash,
        bandit_chosen_facilitator as facilitator_id,
        COUNT(*) FILTER (WHERE is_counterfactual = false) as real_decision_count,
        AVG((actual_reward->>'combined')::numeric) as mean_combined,
        COUNT(*) FILTER (WHERE success = false) as failure_count,
        COUNT(*) FILTER (WHERE success = true) as success_count,
        CASE 
          WHEN COUNT(*) > 0 
          THEN COUNT(*) FILTER (WHERE success = false)::numeric / COUNT(*)::numeric 
          ELSE 0 
        END as failure_rate,
        AVG(latency_ms) as avg_latency_ms
      FROM routing_experiments
      WHERE algorithm = $1 AND algorithm_version = $2
    `,a&&(o+=" AND context_hash = $3",s.push(a))):(o=`
      SELECT 
        context_hash,
        bandit_chosen_facilitator as facilitator_id,
        SUM(CASE WHEN is_counterfactual = 0 THEN 1 ELSE 0 END) as real_decision_count,
        AVG(json_extract(actual_reward, '$.combined')) as mean_combined,
        SUM(CASE WHEN success = 0 THEN 1 ELSE 0 END) as failure_count,
        SUM(CASE WHEN success = 1 THEN 1 ELSE 0 END) as success_count,
        CASE 
          WHEN COUNT(*) > 0 
          THEN CAST(SUM(CASE WHEN success = 0 THEN 1 ELSE 0 END) AS REAL) / COUNT(*) 
          ELSE 0 
        END as failure_rate,
        AVG(latency_ms) as avg_latency_ms
      FROM routing_experiments
      WHERE algorithm = ? AND algorithm_version = ?
    `,a&&(o+=" AND context_hash = ?",s.push(a))),o+=" GROUP BY context_hash, bandit_chosen_facilitator",(i?(await n.pool.query(o,s)).rows:n.prepare(o).all(...s)).map(e=>({contextHash:e.context_hash,facilitatorId:e.facilitator_id,realDecisionCount:parseInt(e.real_decision_count,10)||0,meanCombined:parseFloat(e.mean_combined)||0,failureRate:parseFloat(e.failure_rate)||0,successCount:parseInt(e.success_count,10)||0,failureCount:parseInt(e.failure_count,10)||0,avgLatencyMs:e.avg_latency_ms?parseFloat(e.avg_latency_ms):null}))}async function m(e,t,a,r,o){let n=await u(e,t,a),i=new Map;for(let e of r)i.set(e,0);for(let e of n)r.includes(e.facilitatorId)&&i.set(e.facilitatorId,e.realDecisionCount);let s=Array.from(i.values()),c=s.length>0?Math.min(...s):0;return{hasEnough:s.every(e=>e>=o),facilitatorCounts:i,minCount:c}}[r]=n.then?(await n)():n,(0,o.createLogger)({component:"RoutingExperimentsDB"}),e.s(["checkExperimentExists",()=>i,"createRoutingExperiment",()=>s,"hasEnoughSamplesForContext",()=>m,"loadBanditArmStates",()=>d,"pruneOldExperiments",()=>c,"saveBanditArmState",()=>l]),a()}catch(e){a(e)}},!1),30929,e=>e.a(async(t,a)=>{try{var r=e.i(50377),o=e.i(24924),n=e.i(57466),i=t([o,n]);[o,n]=i.then?(await i)():i;let u=(0,r.createLogger)({component:"BanditRouting"}),m={epsilon:parseFloat(process.env.BANDIT_EPSILON||"0.1"),explorationBonus:parseFloat(process.env.BANDIT_UCB_BONUS||"2.0"),rewardBase:{success:parseFloat(process.env.BANDIT_REWARD_SUCCESS||"0.6"),failure:parseFloat(process.env.BANDIT_REWARD_FAILURE||"-0.15")},penaltyWeights:{latency:parseFloat(process.env.BANDIT_PENALTY_LATENCY||"0.08"),cost:parseFloat(process.env.BANDIT_PENALTY_COST||"0.02")},maxLatencyMs:parseInt(process.env.BANDIT_MAX_LATENCY_MS||"5000",10),maxFeeBps:parseInt(process.env.BANDIT_MAX_FEE_BPS||"100",10),maxBanditHours:parseInt(process.env.BANDIT_MAX_HOURS||"24",10),algorithmVersion:process.env.BANDIT_ALGORITHM_VERSION||"v2",experimentRetentionDays:parseInt(process.env.BANDIT_RETENTION_DAYS||"30",10),minRealDecisions:parseInt(process.env.BANDIT_MIN_REAL_DECISIONS||"20",10),minExplorationProbability:parseFloat(process.env.BANDIT_MIN_EXPLORE_PROB||"0.05")};async function s(e,t){let a=(0,o.getDb)(),r="pool"in a||"function"==typeof a.pool?.query,n=r?`
      SELECT 
        r.id as route_id,
        r.created_at as timestamp,
        r.network,
        r.token,
        r.amount,
        ra.facilitator_id,
        ra.result,
        ra.latency_ms
      FROM routes r
      JOIN route_attempts ra ON r.id = ra.route_id
      WHERE r.created_at >= $1 
        AND r.created_at < $2
        AND ra.is_probe = false
        AND ra.phase = 'verify'
      ORDER BY r.created_at ASC
    `:`
      SELECT 
        r.id as route_id,
        r.created_at as timestamp,
        r.network,
        r.token,
        r.amount,
        ra.facilitator_id,
        ra.result,
        ra.latency_ms
      FROM routes r
      JOIN route_attempts ra ON r.id = ra.route_id
      WHERE r.created_at >= ?
        AND r.created_at < ?
        AND ra.is_probe = 0
        AND ra.phase = 'verify'
      ORDER BY r.created_at ASC
    `;return(r?(await a.pool.query(n,[e.toISOString(),t.toISOString()])).rows:a.prepare(n).all(e.toISOString(),t.toISOString())).map(e=>({routeId:e.route_id,timestamp:new Date(e.timestamp),network:e.network,token:e.token,amount:e.amount,facilitatorId:e.facilitator_id,result:e.result,latencyMs:e.latency_ms,feeBps:0}))}async function c(e){let t=Date.now(),a=e.algorithm||"epsilon_greedy",r=m.algorithmVersion,o=(e.toTimestamp.getTime()-e.fromTimestamp.getTime())/36e5;if(o>m.maxBanditHours)throw Error(`Bandit time window ${o.toFixed(1)}h exceeds maximum ${m.maxBanditHours}h. Use smaller windows or adjust BANDIT_MAX_HOURS env var.`);u.info({fromTimestamp:e.fromTimestamp.toISOString(),toTimestamp:e.toTimestamp.toISOString(),algorithm:a,algorithmVersion:r,windowHours:o.toFixed(2),msg:"Starting bandit shadow simulation"});let i=await (0,n.loadBanditArmStates)(a,r),c=Array.from(i.values()).reduce((e,t)=>e+t.pulls,0),d=await s(e.fromTimestamp,e.toTimestamp);if(0===d.length)return u.info({fromTimestamp:e.fromTimestamp.toISOString(),toTimestamp:e.toTimestamp.toISOString(),algorithm:a,banditColdStart:!0,msg:"No historical routes found in time window - bandit in cold start mode"}),{experimentsCreated:0,experimentsSkipped:0,routesProcessed:0,banditCorrectRate:0,counterfactualCount:0,durationMs:Date.now()-t,banditColdStart:!0};let p=0,g=0,h=0,f=0,_=new Map;for(let e of d){let t;if(await (0,n.checkExperimentExists)(e.routeId,a,r)){g++;continue}let o=function(e,t,a,r){let o,n;return{network:e,asset:t,amountBucket:function(e){let t=parseFloat(e);if(!isNaN(t))return t<1?"micro":t<100?"small":t<1e4?"medium":"large";try{let t=BigInt(e),a=BigInt("1000000");if(t<a)return"micro";if(t<a*BigInt(100))return"small";if(t<a*BigInt(1e4))return"medium";return"large"}catch{return"small"}}(a),timeOfDay:(o=r.getUTCHours())>=5&&o<12?"morning":o>=12&&o<17?"afternoon":o>=17&&o<21?"evening":"night",dayOfWeek:(n=r.getUTCDay(),0===n||6===n?"weekend":"weekday")}}(e.network,e.token,e.amount,e.timestamp),s=`${o.network}|${o.asset}|${o.amountBucket}|${o.timeOfDay}|${o.dayOfWeek}`,d=(e.network,e.token,["cdp","payai","x402rs","dexter"]);if(!d.includes(e.facilitatorId))continue;let u=(t="epsilon_greedy"===a?function(e,t,a,r=m.epsilon){if(0===t.length)throw Error("No available facilitators");if(Math.random()<r){let r=Math.floor(Math.random()*t.length),o=t[r],n=`${e}-${o}`,i=a.get(n);return{chosen:o,estimated:i?.avgReward||0,isExplore:!0}}let o=t[0],n=-1/0;for(let r of t){let t=`${e}-${r}`,i=a.get(t),s=i?.avgReward||0;s>n&&(n=s,o=r)}return{chosen:o,estimated:n===-1/0?0:n,isExplore:!1}}(s,d,i):function(e,t,a,r,o=m.explorationBonus){if(0===t.length)throw Error("No available facilitators");for(let r of t){let t=`${e}-${r}`,o=a.get(t);if(!o||0===o.pulls)return{chosen:r,estimated:0,ucbScore:1/0}}let n=t[0],i=-1/0,s=0,c=Math.log(Math.max(1,r));for(let r of t){let t=`${e}-${r}`,l=a.get(t);if(!l)continue;let d=l.avgReward,u=o*Math.sqrt(c/l.pulls),m=d+u;m>i&&(i=m,n=r,s=d)}return{chosen:n,estimated:s,ucbScore:i===-1/0?0:i}}(s,d,i,c)).chosen!==e.facilitatorId;u?f++:h++;let R="success"===e.result,y=function(e,t,a){let r=Math.min(1,t/m.maxLatencyMs),o=Math.min(1,a/m.maxFeeBps),n=(e?m.rewardBase.success:m.rewardBase.failure)-m.penaltyWeights.latency*r-m.penaltyWeights.cost*o;return{success:+!!e,latencyPenalty:r,costPenalty:o,combined:n,latencyMs:t,costBps:a}}(R,e.latencyMs,e.feeBps),E=u?null:y.combined,w={routeId:e.routeId,timestamp:e.timestamp,context:o,contextHash:s,availableFacilitators:d,actualFacilitator:e.facilitatorId,actualReward:y,banditChosenFacilitator:t.chosen,banditEstimatedReward:E,isCounterfactual:u,algorithm:a,algorithmVersion:r};await (0,n.createRoutingExperiment)(w),p++;let I=`${s}-${e.facilitatorId}`,T=i.get(I),S={facilitatorId:e.facilitatorId,pulls:(T?.pulls||0)+1,totalReward:(T?.totalReward||0)+y.combined,avgReward:0,lastPulled:e.timestamp,successCount:(T?.successCount||0)+ +!!R,failureCount:(T?.failureCount||0)+ +!R};S.avgReward=S.totalReward/S.pulls,i.set(I,S),c++,_.set(I,{contextHash:s,arm:S}),_.size>=100&&(await l(a,r,_),_.clear())}_.size>0&&await l(a,r,_);let R=Date.now()-t,y=d.length-g,E=y>0?h/y:0;return u.info({experimentsCreated:p,experimentsSkipped:g,routesProcessed:d.length,banditCorrectRate:E.toFixed(4),counterfactualCount:f,banditColdStart:!1,durationMs:R,msg:"Bandit shadow simulation completed"}),{experimentsCreated:p,experimentsSkipped:g,routesProcessed:d.length,banditCorrectRate:E,counterfactualCount:f,durationMs:R,banditColdStart:!1}}async function l(e,t,a){for(let[,{contextHash:r,arm:o}]of a)await (0,n.saveBanditArmState)(e,t,r,o)}async function d(e){let t=e||m.experimentRetentionDays,a=new Date(Date.now()-24*t*36e5);u.info({retentionDays:t,cutoffDate:a.toISOString(),msg:"Pruning old bandit data"});let r=await (0,n.pruneOldExperiments)(a),i=(0,o.getDb)(),s="pool"in i||"function"==typeof i.pool?.query,c=0;return c=s?(await i.pool.query("DELETE FROM bandit_arm_states WHERE updated_at < $1",[a.toISOString()])).rowCount||0:i.prepare("DELETE FROM bandit_arm_states WHERE updated_at < ?").run(a.toISOString()).changes||0,u.info({experimentsDeleted:r,armStatesDeleted:c,msg:"Bandit data pruned"}),{experimentsDeleted:r,armStatesDeleted:c}}e.s(["BANDIT_CONFIG",0,m,"pruneOldBanditData",()=>d,"runBanditShadowSimulation",()=>c]),a()}catch(e){a(e)}},!1),43983,e=>e.a(async(t,a)=>{try{var r=e.i(50377),o=e.i(7484),n=e.i(3633),i=e.i(30929),s=e.i(59670),c=t([o,n,i,s]);[o,n,i,s]=c.then?(await c)():c;let d=(0,r.createLogger)({component:"CoordinatorCron"});async function l(e,t){let{runId:a,requestId:r}=t,o=[],{searchParams:c}=new URL(e.url),l="true"===c.get("bandit"),u="true"===c.get("prune"),m=parseInt(c.get("banditHours")||"1",10),p=c.get("banditAlgo")||"epsilon_greedy",g=i.BANDIT_CONFIG.maxBanditHours;if(m<1||m>g)return d.warn({runId:a,requestId:r,banditHoursParam:m,maxBanditHours:g,msg:"Invalid banditHours parameter"}),{ok:!1,error:`banditHours must be between 1 and ${g}`,code:"INVALID_PARAM"};let h=Math.min(m,g);d.info({runId:a,requestId:r,runBandit:l,runPrune:u,banditHours:h,banditAlgorithm:p,msg:"Starting coordinator cron"});let f=0;try{(f=await (0,s.expirePendingRecommendations)())>0&&d.info({runId:a,requestId:r,expiredCount:f,msg:"Expired old recommendations"})}catch(t){let e=t instanceof Error?t.message:"Unknown error";o.push(`Failed to expire recommendations: ${e}`),d.warn({runId:a,requestId:r,error:e,msg:"Failed to expire recommendations"})}let _=await (0,n.runCoordinatorTick)();d.info({runId:a,requestId:r,coordRunId:_.runId,totalRecommendations:_.totalRecommendations,routingTunerRecs:_.routingTuner.recommendations.length,pricingTunerRecs:_.pricingTuner.recommendations.length,scoutTunerRecs:_.scoutTuner.recommendations.length,facilitatorCount:_.worldState.facilitators.length,routableCount:_.worldState.facilitators.filter(e=>e.isRoutable).length,riskAnomalyCount:_.worldState.riskAnomalies.length,errorCount:_.errors.length,msg:"Coordinator tick completed"}),o.push(..._.errors);let R=null,y=!1;if(l){let e=new Date,t=new Date(e.getTime()-60*h*6e4);try{let o=(R=await (0,i.runBanditShadowSimulation)({fromTimestamp:t,toTimestamp:e,algorithm:p})).banditColdStart?"Bandit in cold start; using deterministic routing":"Bandit simulation completed";d.info({runId:a,requestId:r,algorithm:p,timeWindowHours:h,routesProcessed:R.routesProcessed,experimentsCreated:R.experimentsCreated,experimentsSkipped:R.experimentsSkipped,banditCorrectRate:R.banditCorrectRate.toFixed(4),counterfactualCount:R.counterfactualCount,banditColdStart:R.banditColdStart,durationMs:R.durationMs,msg:o}),R.banditColdStart&&(y=!0,d.info({runId:a,requestId:r,topPerformers:_.routingTuner.analysis.topPerformers,routableCount:_.worldState.facilitators.filter(e=>e.isRoutable).length,msg:"Bandit in cold start; deterministic routing policy in effect"}))}catch(t){let e=t instanceof Error?t.message:"Unknown error";o.push(`Bandit simulation failed: ${e}`),d.error({runId:a,requestId:r,error:e,msg:"Bandit simulation failed"})}}let E=null;if(u)try{E=await (0,i.pruneOldBanditData)(),d.info({runId:a,requestId:r,experimentsDeleted:E.experimentsDeleted,armStatesDeleted:E.armStatesDeleted,msg:"Data pruning completed"})}catch(t){let e=t instanceof Error?t.message:"Unknown error";o.push(`Data pruning failed: ${e}`),d.error({runId:a,requestId:r,error:e,msg:"Data pruning failed"})}return{ok:0===o.length,coordRunId:_.runId,timestamp:_.completedAt.toISOString(),coordinator:{totalRecommendations:_.totalRecommendations,routingTuner:{recommendations:_.routingTuner.recommendations.length,topPerformers:_.routingTuner.analysis.topPerformers,underperformers:_.routingTuner.analysis.underperformers},pricingTuner:{recommendations:_.pricingTuner.recommendations.length,resourcesReviewed:_.pricingTuner.analysis.resourcesReviewed},scoutTuner:{recommendations:_.scoutTuner.recommendations.length,pendingEvaluated:_.scoutTuner.analysis.pendingEvaluated,readyForOnboarding:_.scoutTuner.analysis.readyForOnboarding},errors:_.errors},worldState:{facilitatorCount:_.worldState.facilitators.length,routableFacilitatorCount:_.worldState.facilitators.filter(e=>e.isRoutable).length,pendingFacilitatorCount:_.worldState.pendingFacilitators.length,riskAnomalyCount:_.worldState.riskAnomalies.length,aggregates:_.worldState.aggregates},bandit:R?{algorithm:p,algorithmVersion:i.BANDIT_CONFIG.algorithmVersion,timeWindowHours:h,routesProcessed:R.routesProcessed,experimentsCreated:R.experimentsCreated,experimentsSkipped:R.experimentsSkipped,banditCorrectRate:R.banditCorrectRate,counterfactualCount:R.counterfactualCount,banditColdStart:R.banditColdStart,usingDeterministicPolicy:y,durationMs:R.durationMs}:null,prune:E?{experimentsDeleted:E.experimentsDeleted,armStatesDeleted:E.armStatesDeleted}:null,expiredRecommendations:f,errors:o.length>0?o:void 0}}let u=(0,o.withCronJobTracking)(l,{jobId:"coord",timeout:55e3,minInterval:66e5}),m=(0,o.withCronJobTracking)(l,{jobId:"coord",timeout:55e3,minInterval:66e5,skipRateLimit:!0});e.s(["GET",0,u,"POST",0,m,"dynamic",0,"force-dynamic","maxDuration",0,60]),a()}catch(e){a(e)}},!1),41915,e=>e.a(async(t,a)=>{try{var r=e.i(47909),o=e.i(74017),n=e.i(96250),i=e.i(59756),s=e.i(61916),c=e.i(14444),l=e.i(37092),d=e.i(69741),u=e.i(16795),m=e.i(87718),p=e.i(95169),g=e.i(47587),h=e.i(66012),f=e.i(70101),_=e.i(26937),R=e.i(10372),y=e.i(93695);e.i(52474);var E=e.i(220),w=e.i(43983),I=t([w]);[w]=I.then?(await I)():I;let v=new r.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/cron/coord/route",pathname:"/api/cron/coord",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/cron/coord/route.ts",nextConfigOutput:"standalone",userland:w}),{workAsyncStorage:C,workUnitAsyncStorage:D,serverHooks:A}=v;function T(){return(0,n.patchFetch)({workAsyncStorage:C,workUnitAsyncStorage:D})}async function S(e,t,a){v.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/cron/coord/route";r=r.replace(/\/index$/,"")||"/";let n=await v.prepare(e,t,{srcPage:r,multiZoneDraftMode:!1});if(!n)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:w,params:I,nextConfig:T,parsedUrl:S,isDraftMode:C,prerenderManifest:D,routerServerContext:A,isOnDemandRevalidate:N,revalidateOnlyGenerated:O,resolvedPathname:x,clientReferenceManifest:b,serverActionsManifest:L}=n,M=(0,d.normalizeAppPath)(r),$=!!(D.dynamicRoutes[M]||D.routes[x]),F=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,S,!1):t.end("This page could not be found"),null);if($&&!C){let e=!!D.routes[x],t=D.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(T.experimental.adapterPath)return await F();throw new y.NoFallbackError}}let U=null;!$||v.isDev||C||(U=x,U="/index"===U?"/":U);let k=!0===v.isDev||!$,P=$&&!k;L&&b&&(0,c.setReferenceManifestsSingleton)({page:r,clientReferenceManifest:b,serverActionsManifest:L,serverModuleMap:(0,l.createServerModuleMap)({serverActionsManifest:L})});let B=e.method||"GET",H=(0,s.getTracer)(),W=H.getActiveScopeSpan(),q={params:I,prerenderManifest:D,renderOpts:{experimental:{authInterrupts:!!T.experimental.authInterrupts},cacheComponents:!!T.cacheComponents,supportsDynamicResponse:k,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:T.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>v.onRequestError(e,t,r,A)},sharedContext:{buildId:w}},z=new u.NodeNextRequest(e),G=new u.NodeNextResponse(t),j=m.NextRequestAdapter.fromNodeNextRequest(z,(0,m.signalFromNodeResponse)(t));try{let n=async e=>v.handle(j,q).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=H.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=a.get("next.route");if(o){let t=`${B} ${o}`;e.setAttributes({"next.route":o,"http.route":o,"next.span_name":t}),e.updateName(t)}else e.updateName(`${B} ${r}`)}),c=!!(0,i.getRequestMeta)(e,"minimalMode"),l=async i=>{var s,l;let d=async({previousCacheEntry:o})=>{try{if(!c&&N&&O&&!o)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await n(i);e.fetchMetrics=q.renderOpts.fetchMetrics;let s=q.renderOpts.pendingWaitUntil;s&&a.waitUntil&&(a.waitUntil(s),s=void 0);let l=q.renderOpts.collectedTags;if(!$)return await (0,h.sendResponse)(z,G,r,q.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(r.headers);l&&(t[R.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==q.renderOpts.collectedRevalidate&&!(q.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&q.renderOpts.collectedRevalidate,o=void 0===q.renderOpts.collectedExpire||q.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:q.renderOpts.collectedExpire;return{value:{kind:E.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:o}}}}catch(t){throw(null==o?void 0:o.isStale)&&await v.onRequestError(e,t,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,g.getRevalidateReason)({isStaticGeneration:P,isOnDemandRevalidate:N})},A),t}},u=await v.handleResponse({req:e,nextConfig:T,cacheKey:U,routeKind:o.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:D,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:O,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:c});if(!$)return null;if((null==u||null==(s=u.value)?void 0:s.kind)!==E.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});c||t.setHeader("x-nextjs-cache",N?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,f.fromNodeOutgoingHttpHeaders)(u.value.headers);return c&&$||m.delete(R.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,_.getCacheControlHeader)(u.cacheControl)),await (0,h.sendResponse)(z,G,new Response(u.value.body,{headers:m,status:u.value.status||200})),null};W?await l(W):await H.withPropagatedContext(e.headers,()=>H.trace(p.BaseServerSpan.handleRequest,{spanName:`${B} ${r}`,kind:s.SpanKind.SERVER,attributes:{"http.method":B,"http.target":e.url}},l))}catch(t){if(t instanceof y.NoFallbackError||await v.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,g.getRevalidateReason)({isStaticGeneration:P,isOnDemandRevalidate:N})}),$)throw t;return await (0,h.sendResponse)(z,G,new Response(null,{status:500})),null}}e.s(["handler",()=>S,"patchFetch",()=>T,"routeModule",()=>v,"serverHooks",()=>A,"workAsyncStorage",()=>C,"workUnitAsyncStorage",()=>D]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=_dc490e63._.js.map
module.exports=[40402,26249,76273,59456,73324,e=>{"use strict";e.s(["x402Version",()=>2],26249);var t=class extends Error{constructor(e,t){super(`verification failed: ${t.invalidReason||"unknown reason"}`),this.name="VerifyError",this.statusCode=e,this.invalidReason=t.invalidReason,this.payer=t.payer}},r=class extends Error{constructor(e,t){super(`settlement failed: ${t.errorReason||"unknown reason"}`),this.name="SettleError",this.statusCode=e,this.errorReason=t.errorReason,this.payer=t.payer,this.transaction=t.transaction,this.network=t.network}};e.s(["SettleError",()=>r,"VerifyError",()=>t],76273);var s=(e,t,r)=>((e,t)=>{let r=e.get(t);if(!r)for(let[s,n]of e.entries()){let e=s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/\\\*/g,".*");if(RegExp(`^${e}$`).test(t)){r=n;break}}return r})(e,r)?.get(t),n=/^[A-Za-z0-9+/]*={0,2}$/;function a(e){return"undefined"!=typeof globalThis&&"function"==typeof globalThis.btoa?globalThis.btoa(e):Buffer.from(e).toString("base64")}function o(e){return"undefined"!=typeof globalThis&&"function"==typeof globalThis.atob?globalThis.atob(e):Buffer.from(e,"base64").toString("utf-8")}function i(e,t){let r=e=>{if(null==e||"object"!=typeof e)return JSON.stringify(e);if(Array.isArray(e))return JSON.stringify(e.map(e=>"object"==typeof e&&null!==e?JSON.parse(r(e)):e));let t={};return Object.keys(e).sort().forEach(s=>{let n=e[s];t[s]="object"==typeof n&&null!==n?JSON.parse(r(n)):n}),JSON.stringify(t)};try{return r(e)===r(t)}catch{return JSON.stringify(e)===JSON.stringify(t)}}e.s(["Base64EncodedRegex",()=>n,"deepEqual",()=>i,"findByNetworkAndScheme",()=>s,"safeBase64Decode",()=>o,"safeBase64Encode",()=>a],59456);var u=e.z;e.s(["__require",()=>u],73324);var c=class extends Error{constructor(e){super(`x402 Route Configuration Errors:
${e.map(e=>`  - ${e.message}`).join("\n")}`),this.name="RouteConfigurationError",this.errors=e}},l=class{constructor(e,t){for(const[r,s]of(this.compiledRoutes=[],this.ResourceServer=e,this.routesConfig=t,Object.entries("object"!=typeof t||"accepts"in t?{"*":t}:t))){const e=this.parseRoutePattern(r);this.compiledRoutes.push({verb:e.verb,regex:e.regex,config:s})}}async initialize(){await this.ResourceServer.initialize();let e=this.validateRouteConfiguration();if(e.length>0)throw new c(e)}registerPaywallProvider(e){return this.paywallProvider=e,this}async processHTTPRequest(e,t){let{adapter:r,path:s,method:n}=e,a=this.getRouteConfig(s,n);if(!a)return{type:"no-payment-required"};let o=this.normalizePaymentOptions(a),i=this.extractPayment(r),u={url:a.resource||e.adapter.getUrl(),description:a.description||"",mimeType:a.mimeType||""},c=await this.ResourceServer.buildPaymentRequirementsFromOptions(o,e),l=a.extensions;l&&(l=this.ResourceServer.enrichExtensions(l,e));let p=this.ResourceServer.createPaymentRequiredResponse(c,u,i?void 0:"Payment required",l);if(!i){let s=a.unpaidResponseBody?await a.unpaidResponseBody(e):void 0;return{type:"payment-error",response:this.createHTTPResponse(p,this.isWebBrowser(r),t,a.customPaywallHtml,s)}}try{let e=this.ResourceServer.findMatchingRequirements(p.accepts,i);if(!e){let e=this.ResourceServer.createPaymentRequiredResponse(c,u,"No matching payment requirements",a.extensions);return{type:"payment-error",response:this.createHTTPResponse(e,!1,t)}}let r=await this.ResourceServer.verifyPayment(i,e);if(!r.isValid){let e=this.ResourceServer.createPaymentRequiredResponse(c,u,r.invalidReason,a.extensions);return{type:"payment-error",response:this.createHTTPResponse(e,!1,t)}}return{type:"payment-verified",paymentPayload:i,paymentRequirements:e}}catch(r){let e=this.ResourceServer.createPaymentRequiredResponse(c,u,r instanceof Error?r.message:"Payment verification failed",a.extensions);return{type:"payment-error",response:this.createHTTPResponse(e,!1,t)}}}async processSettlement(e,t){try{let r=await this.ResourceServer.settlePayment(e,t);if(!r.success)return{...r,success:!1,errorReason:r.errorReason||"Settlement failed"};return{...r,success:!0,headers:this.createSettlementHeaders(r,t),requirements:t}}catch(e){if(e instanceof r)return{success:!1,errorReason:e.errorReason||e.message,payer:e.payer,network:e.network,transaction:e.transaction};return{success:!1,errorReason:e instanceof Error?e.message:"Settlement failed",network:t.network,transaction:""}}}requiresPayment(e){return void 0!==this.getRouteConfig(e.path,e.method)}normalizePaymentOptions(e){return Array.isArray(e.accepts)?e.accepts:[e.accepts]}validateRouteConfiguration(){let e=[];for(let[t,r]of"object"!=typeof this.routesConfig||"accepts"in this.routesConfig?[["*",this.routesConfig]]:Object.entries(this.routesConfig))for(let s of this.normalizePaymentOptions(r)){if(!this.ResourceServer.hasRegisteredScheme(s.network,s.scheme)){e.push({routePattern:t,scheme:s.scheme,network:s.network,reason:"missing_scheme",message:`Route "${t}": No scheme implementation registered for "${s.scheme}" on network "${s.network}"`});continue}this.ResourceServer.getSupportedKind(2,s.network,s.scheme)||e.push({routePattern:t,scheme:s.scheme,network:s.network,reason:"missing_facilitator",message:`Route "${t}": Facilitator does not support scheme "${s.scheme}" on network "${s.network}"`})}return e}getRouteConfig(e,t){let r=this.normalizePath(e),s=t.toUpperCase(),n=this.compiledRoutes.find(e=>e.regex.test(r)&&("*"===e.verb||e.verb===s));return n?.config}extractPayment(e){let t=e.getHeader("payment-signature")||e.getHeader("PAYMENT-SIGNATURE");if(t)try{return y(t)}catch(e){console.warn("Failed to decode PAYMENT-SIGNATURE header:",e)}return null}isWebBrowser(e){let t=e.getAcceptHeader(),r=e.getUserAgent();return t.includes("text/html")&&r.includes("Mozilla")}createHTTPResponse(e,t,r,s,n){if(t)return{status:402,headers:{"Content-Type":"text/html"},body:this.generatePaywallHTML(e,r,s),isHtml:!0};let a=this.createHTTPPaymentRequiredResponse(e),o=n?n.contentType:"application/json",i=n?n.body:{};return{status:402,headers:{"Content-Type":o,...a.headers},body:i}}createHTTPPaymentRequiredResponse(e){return{headers:{"PAYMENT-REQUIRED":f(e)}}}createSettlementHeaders(e,t){return{"PAYMENT-RESPONSE":g({...e,requirements:t})}}parseRoutePattern(e){let[t,r]=e.includes(" ")?e.split(/\s+/):["*",e],s=RegExp(`^${r.replace(/[$()+.?^{|}]/g,"\\$&").replace(/\*/g,".*?").replace(/\[([^\]]+)\]/g,"[^/]+").replace(/\//g,"\\/")}$`,"i");return{verb:t.toUpperCase(),regex:s}}normalizePath(e){try{let t=e.split(/[?#]/)[0];return decodeURIComponent(t).replace(/\\/g,"/").replace(/\/+/g,"/").replace(/(.+?)\/+$/,"$1")}catch{return e}}generatePaywallHTML(e,t,r){if(r)return r;if(this.paywallProvider)return this.paywallProvider.generateHtml(e,t);try{let r=u("@x402/paywall"),s=this.getDisplayAmount(e),n=e.resource;return r.getPaywallHtml({amount:s,paymentRequired:e,currentUrl:n?.url||t?.currentUrl||"",testnet:t?.testnet??!0,appName:t?.appName,appLogo:t?.appLogo,sessionTokenEndpoint:t?.sessionTokenEndpoint})}catch{}let s=e.resource,n=this.getDisplayAmount(e);return`
      <!DOCTYPE html>
      <html>
        <head>
          <title>Payment Required</title>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
        </head>
        <body>
          <div style="max-width: 600px; margin: 50px auto; padding: 20px; font-family: system-ui, -apple-system, sans-serif;">
            ${t?.appLogo?`<img src="${t.appLogo}" alt="${t.appName||"App"}" style="max-width: 200px; margin-bottom: 20px;">`:""}
            <h1>Payment Required</h1>
            ${s?`<p><strong>Resource:</strong> ${s.description||s.url}</p>`:""}
            <p><strong>Amount:</strong> $${n.toFixed(2)} USDC</p>
            <div id="payment-widget" 
                 data-requirements='${JSON.stringify(e)}'
                 data-app-name="${t?.appName||""}"
                 data-testnet="${t?.testnet||!1}">
              <!-- Install @x402/paywall for full wallet integration -->
              <p style="margin-top: 2rem; padding: 1rem; background: #fef3c7; border-radius: 0.5rem;">
                <strong>Note:</strong> Install <code>@x402/paywall</code> for full wallet connection and payment UI.
              </p>
            </div>
          </div>
        </body>
      </html>
    `}getDisplayAmount(e){let t=e.accepts;if(t&&t.length>0){let e=t[0];if("amount"in e)return parseFloat(e.amount)/1e6}return 0}},p=class{constructor(e){this.url=e?.url||"https://x402.org/facilitator",this._createAuthHeaders=e?.createAuthHeaders}async verify(e,r){let s={"Content-Type":"application/json"};if(this._createAuthHeaders){let e=await this.createAuthHeaders("verify");s={...s,...e.headers}}let n=await fetch(`${this.url}/verify`,{method:"POST",headers:s,body:JSON.stringify({x402Version:e.x402Version,paymentPayload:this.toJsonSafe(e),paymentRequirements:this.toJsonSafe(r)})}),a=await n.json();if("object"==typeof a&&null!==a&&"isValid"in a){if(!n.ok)throw new t(n.status,a);return a}throw Error(`Facilitator verify failed (${n.status}): ${JSON.stringify(a)}`)}async settle(e,t){let s={"Content-Type":"application/json"};if(this._createAuthHeaders){let e=await this.createAuthHeaders("settle");s={...s,...e.headers}}let n=await fetch(`${this.url}/settle`,{method:"POST",headers:s,body:JSON.stringify({x402Version:e.x402Version,paymentPayload:this.toJsonSafe(e),paymentRequirements:this.toJsonSafe(t)})}),a=await n.json();if("object"==typeof a&&null!==a&&"success"in a){if(!n.ok)throw new r(n.status,a);return a}throw Error(`Facilitator settle failed (${n.status}): ${JSON.stringify(a)}`)}async getSupported(){let e={"Content-Type":"application/json"};if(this._createAuthHeaders){let t=await this.createAuthHeaders("supported");e={...e,...t.headers}}let t=await fetch(`${this.url}/supported`,{method:"GET",headers:e});if(!t.ok){let e=await t.text().catch(()=>t.statusText);throw Error(`Facilitator getSupported failed (${t.status}): ${e}`)}return await t.json()}async createAuthHeaders(e){return this._createAuthHeaders?{headers:(await this._createAuthHeaders())[e]??{}}:{headers:{}}}toJsonSafe(e){return JSON.parse(JSON.stringify(e,(e,t)=>"bigint"==typeof t?t.toString():t))}},d=class{constructor(e){this.client=e}encodePaymentSignatureHeader(e){switch(e.x402Version){case 2:return{"PAYMENT-SIGNATURE":h(e)};case 1:return{"X-PAYMENT":h(e)};default:throw Error(`Unsupported x402 version: ${e.x402Version}`)}}getPaymentRequiredResponse(e,t){let r=e("PAYMENT-REQUIRED");if(r)return m(r);if(t&&t instanceof Object&&"x402Version"in t&&1===t.x402Version)return t;throw Error("Invalid payment required response")}getPaymentSettleResponse(e){let t=e("PAYMENT-RESPONSE");if(t)return R(t);let r=e("X-PAYMENT-RESPONSE");if(r)return R(r);throw Error("Payment response header not found")}async createPaymentPayload(e){return this.client.createPaymentPayload(e)}};function h(e){return a(JSON.stringify(e))}function y(e){if(!n.test(e))throw Error("Invalid payment signature header");return JSON.parse(o(e))}function f(e){return a(JSON.stringify(e))}function m(e){if(!n.test(e))throw Error("Invalid payment required header");return JSON.parse(o(e))}function g(e){return a(JSON.stringify(e))}function R(e){if(!n.test(e))throw Error("Invalid payment response header");return JSON.parse(o(e))}e.s(["HTTPFacilitatorClient",()=>p,"RouteConfigurationError",()=>c,"decodePaymentRequiredHeader",()=>m,"decodePaymentResponseHeader",()=>R,"decodePaymentSignatureHeader",()=>y,"encodePaymentRequiredHeader",()=>f,"encodePaymentResponseHeader",()=>g,"encodePaymentSignatureHeader",()=>h,"x402HTTPClient",()=>d,"x402HTTPResourceServer",()=>l],40402)}];

//# sourceMappingURL=node_modules_%40x402_core_dist_esm_chunk-XT4E3FX4_mjs_48e49267._.js.map
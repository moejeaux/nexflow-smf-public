module.exports=[10430,(e,t,r)=>{t.exports=e.x("async_hooks",()=>require("async_hooks"))},72847,e=>{"use strict";class t extends Error{type;code;retryAfterSeconds;field;constructor(e,r,a="unknown",n){super(e),this.name="SmfError",this.code=r,this.type=a,this.retryAfterSeconds=n?.retryAfterSeconds,this.field=n?.field,Error.captureStackTrace&&Error.captureStackTrace(this,t)}static temporary(e,r,a){return new t(e,r,"temporary",{retryAfterSeconds:a})}static permanent(e,r,a){return new t(e,r,"permanent",{field:a})}static fromApiResponse(e){return new t(e.message,e.code,e.type||"unknown",{retryAfterSeconds:e.retryAfterSeconds,field:e.field})}}class r extends Error{code="invalid_signature";constructor(e="Invalid webhook signature"){super(e),this.name="InvalidSignatureError",Error.captureStackTrace&&Error.captureStackTrace(this,r)}}e.s(["InvalidSignatureError",()=>r,"SmfError",()=>t])},40735,e=>{"use strict";var t=e.i(54799),r=e.i(72847);function a(e){let a,{payload:n,signature:o,timestamp:s,secret:i,toleranceSeconds:u=300}=e,d=Math.floor(Date.now()/1e3)-s;if(d>u)throw new r.InvalidSignatureError(`Webhook timestamp too old: ${d}s (tolerance: ${u}s)`);if(d<-u)throw new r.InvalidSignatureError(`Webhook timestamp in future: ${-d}s ahead`);let c=(a=`${s}.${n}`,(0,t.createHmac)("sha256",i).update(a).digest("hex")),l=Buffer.from(o,"hex"),p=Buffer.from(c,"hex");if(l.length!==p.length)throw new r.InvalidSignatureError("Signature length mismatch");if(!(0,t.timingSafeEqual)(l,p))throw new r.InvalidSignatureError("Signature verification failed");try{let e="string"==typeof n?n:n.toString("utf-8");return JSON.parse(e)}catch(e){throw new r.InvalidSignatureError("Failed to parse webhook payload as JSON")}}e.s(["verifyWebhookSignature",()=>a])},46235,70930,e=>{"use strict";var t=e.i(72847);let r={info:()=>{},error:()=>{},warn:()=>{},debug:()=>{}};function a(e){let{apiKey:a,webhookSecret:n,logger:o=r,correlationIdProvider:s}=e,i=e.mode??(a.startsWith("sk_live_")?"live":"test"),u=e.baseUrl??("live"===i?"https://api.smf.nexflowapp.app/v1":"https://api-test.smf.nexflowapp.app/v1");async function d(e,r,n){let d=`${u}${r}`,c=s?.(),l={Authorization:`Bearer ${a}`,"Content-Type":"application/json","X-SMF-Mode":i};c&&(l["X-Correlation-ID"]=c),o.debug("API request",{method:e,endpoint:r,correlationId:c});try{let r=await fetch(d,{method:e,headers:l,body:n?JSON.stringify(n):void 0}),a=await r.json();if(!r.ok)throw o.warn("API error response",{status:r.status,code:a.code,message:a.message}),t.SmfError.fromApiResponse({code:a.code||"api_error",message:a.message||"API request failed",type:r.status>=500?"temporary":"permanent",retryAfterSeconds:a.retryAfter,field:a.field});return a}catch(e){if(e instanceof t.SmfError)throw e;throw o.error("API request failed",{error:e instanceof Error?e.message:"Unknown error"}),t.SmfError.temporary(e instanceof Error?e.message:"Network error","network_error")}}return o.info("SMF client initialized",{mode:i,baseUrl:u.replace(/\/v1$/,"")}),{charge:async e=>(o.info("Creating charge",{merchantId:e.merchantId,amount:e.amount,currency:e.currency}),d("POST","/charges",{platform_id:e.platformId,merchant_id:e.merchantId,amount:e.amount,currency:e.currency,payment_method:{type:e.paymentMethod.type,token:e.paymentMethod.token},idempotency_key:e.idempotencyKey,metadata:e.metadata})),refund:async(e,t)=>(o.info("Creating refund",{chargeId:e,amount:t?.amount??"full"}),d("POST",`/charges/${e}/refunds`,{amount:t?.amount,reason:t?.reason,metadata:t?.metadata})),payout:async e=>(o.info("Creating payout",{merchantId:e.merchantId,amount:e.amount,currency:e.currency}),d("POST","/payouts",{platform_id:e.platformId,merchant_id:e.merchantId,amount:e.amount,currency:e.currency,destination:{type:e.destination.type,id:e.destination.id},description:e.description,statement_descriptor:e.statementDescriptor,metadata:e.metadata}))}}e.s(["createFacilitator",()=>a],70930),e.i(40735),e.s([],46235)},42137,e=>{"use strict";var t=e.i(10430);e.i(46235);var r=e.i(70930),a=e.i(72847);let n=(0,e.i(50377).createLogger)({component:"SMF"}),o={info:(e,t)=>{n.info({...t},`[SMF] ${e}`)},error:(e,t)=>{n.error({...t},`[SMF] ${e}`)},warn:(e,t)=>{n.warn({...t},`[SMF] ${e}`)},debug:(e,t)=>{n.debug({...t},`[SMF] ${e}`)}},s=new t.AsyncLocalStorage;function i(){return s.getStore()}let u=null;async function d(e,t){return s.run(e,async()=>t(function(){if(!u){let e=function(){let e=process.env.SMF_API_KEY;if(!e)throw Error("SMF_API_KEY is not set. Please set it in your environment variables.");let t="live"===process.env.SMF_MODE?"live":"test";return{apiKey:e,mode:t,baseUrl:process.env.SMF_BASE_URL,webhookSecret:process.env.SMF_WEBHOOK_SECRET}}();u=(0,r.createFacilitator)({apiKey:e.apiKey,mode:e.mode,baseUrl:e.baseUrl,webhookSecret:e.webhookSecret,logger:o,correlationIdProvider:i}),n.info({mode:e.mode,hasBaseUrl:!!e.baseUrl},"SMF client initialized")}return u}()))}function c(){return process.env.SMF_WEBHOOK_SECRET}function l(){return!!process.env.SMF_API_KEY}function p(e){return e instanceof a.SmfError?{type:e.type,code:e.code,message:e.message,retryAfterSeconds:e.retryAfterSeconds,httpStatus:function(e,t){if("temporary"===t)if("rate_limit_error"===e)return 429;else return 503;switch(e){case"card_declined":case"insufficient_funds":case"expired_card":return 402;case"validation_error":case"invalid_request":default:return 400;case"authentication_error":return 401;case"authorization_error":return 403;case"not_found":return 404;case"idempotency_error":return 409}}(e.code,e.type)}:{type:"unknown",code:"INTERNAL_ERROR",message:e instanceof Error?e.message:"An unexpected error occurred",httpStatus:500}}function _(e){return({card_declined:"Your card was declined. Please try a different payment method.",insufficient_funds:"Insufficient funds. Please use a different payment method.",expired_card:"Your card has expired. Please update your payment information.",validation_error:"Invalid payment details. Please check your information.",rate_limit_error:"Too many requests. Please try again in a moment.",processing_error:"Payment processing temporarily unavailable. Please try again.",network_error:"Network error. Please check your connection and try again.",authentication_error:"Authentication failed. Please contact support.",idempotency_error:"This request has already been processed."})[e]||"An error occurred processing your payment. Please try again."}e.s(["classifySmfError",()=>p,"getUserFriendlyErrorMessage",()=>_,"getWebhookSecret",()=>c,"isSmfConfigured",()=>l,"withSmfCorrelation",()=>d])},46868,e=>e.a(async(t,r)=>{try{var a=e.i(24924),n=e.i(50377),o=t([a]);[a]=o.then?(await o)():o;let $=(0,n.createLogger)({component:"SMFPaymentsDB"});async function s(e){let t=(0,a.getDb)(),r=crypto.randomUUID(),n=new Date().toISOString();return"pool"in t||"function"==typeof t.pool?.query?(await t.pool.query(`INSERT INTO smf_charges (
        id, smf_charge_id, platform_id, merchant_id, amount, currency, status,
        order_id, user_id, idempotency_key, fees, payment_method_type, metadata,
        error_code, error_message, correlation_id, created_at, updated_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18)
      RETURNING *`,[r,e.smf_charge_id,e.platform_id,e.merchant_id,e.amount,e.currency,e.status,e.order_id||null,e.user_id||null,e.idempotency_key||null,e.fees?JSON.stringify(e.fees):null,e.payment_method_type||null,e.metadata?JSON.stringify(e.metadata):null,e.error_code||null,e.error_message||null,e.correlation_id||null,n,n])).rows[0]:(t.prepare(`
      INSERT INTO smf_charges (
        id, smf_charge_id, platform_id, merchant_id, amount, currency, status,
        order_id, user_id, idempotency_key, fees, payment_method_type, metadata,
        error_code, error_message, correlation_id, created_at, updated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(r,e.smf_charge_id,e.platform_id,e.merchant_id,e.amount,e.currency,e.status,e.order_id||null,e.user_id||null,e.idempotency_key||null,e.fees?JSON.stringify(e.fees):null,e.payment_method_type||null,e.metadata?JSON.stringify(e.metadata):null,e.error_code||null,e.error_message||null,e.correlation_id||null,n,n),{id:r,...e,created_at:n,updated_at:n})}async function i(e){let t=(0,a.getDb)();return"pool"in t||"function"==typeof t.pool?.query?(await t.pool.query("SELECT * FROM smf_charges WHERE smf_charge_id = $1",[e])).rows[0]||null:t.prepare("SELECT * FROM smf_charges WHERE smf_charge_id = ?").get(e)||null}async function u(e){let t=(0,a.getDb)();return"pool"in t||"function"==typeof t.pool?.query?(await t.pool.query("SELECT * FROM smf_charges WHERE order_id = $1 ORDER BY created_at DESC LIMIT 1",[e])).rows[0]||null:t.prepare("SELECT * FROM smf_charges WHERE order_id = ? ORDER BY created_at DESC LIMIT 1").get(e)||null}async function d(e){let t=(0,a.getDb)();return"pool"in t||"function"==typeof t.pool?.query?(await t.pool.query("SELECT * FROM smf_charges WHERE idempotency_key = $1 ORDER BY created_at DESC LIMIT 1",[e])).rows[0]||null:t.prepare("SELECT * FROM smf_charges WHERE idempotency_key = ? ORDER BY created_at DESC LIMIT 1").get(e)||null}async function c(e,t,r,n){let o=(0,a.getDb)(),s=new Date().toISOString();"pool"in o||"function"==typeof o.pool?.query?await o.pool.query(`UPDATE smf_charges 
       SET status = $1, error_code = $2, error_message = $3, updated_at = $4 
       WHERE id = $5`,[t,r||null,n||null,s,e]):o.prepare(`UPDATE smf_charges 
       SET status = ?, error_code = ?, error_message = ?, updated_at = ? 
       WHERE id = ?`).run(t,r||null,n||null,s,e)}async function l(e){let t=(0,a.getDb)(),r=crypto.randomUUID(),n=new Date().toISOString();return"pool"in t||"function"==typeof t.pool?.query?(await t.pool.query(`INSERT INTO smf_refunds (
        id, smf_refund_id, charge_id, smf_charge_id, amount, currency,
        reason, status, correlation_id, created_at, updated_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11)
      RETURNING *`,[r,e.smf_refund_id,e.charge_id,e.smf_charge_id,e.amount,e.currency,e.reason||null,e.status,e.correlation_id||null,n,n])).rows[0]:(t.prepare(`
      INSERT INTO smf_refunds (
        id, smf_refund_id, charge_id, smf_charge_id, amount, currency,
        reason, status, correlation_id, created_at, updated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(r,e.smf_refund_id,e.charge_id,e.smf_charge_id,e.amount,e.currency,e.reason||null,e.status,e.correlation_id||null,n,n),{id:r,...e,created_at:n,updated_at:n})}async function p(e){let t=(0,a.getDb)();if("pool"in t||"function"==typeof t.pool?.query){let r=await t.pool.query(`SELECT COALESCE(SUM(amount), 0) as total 
       FROM smf_refunds 
       WHERE charge_id = $1 AND status IN ('pending', 'succeeded')`,[e]);return parseInt(r.rows[0]?.total||"0",10)}{let r=t.prepare(`SELECT COALESCE(SUM(amount), 0) as total 
       FROM smf_refunds 
       WHERE charge_id = ? AND status IN ('pending', 'succeeded')`).get(e);return r?.total||0}}async function _(e){let t=(0,a.getDb)();return"pool"in t||"function"==typeof t.pool?.query?(await t.pool.query("SELECT * FROM smf_refunds WHERE smf_refund_id = $1",[e])).rows[0]||null:t.prepare("SELECT * FROM smf_refunds WHERE smf_refund_id = ?").get(e)||null}async function f(e,t,r,n){let o=(0,a.getDb)(),s=new Date().toISOString();"pool"in o||"function"==typeof o.pool?.query?await o.pool.query(`UPDATE smf_refunds 
       SET status = $1, updated_at = $2 
       WHERE id = $3`,[t,s,e]):o.prepare(`UPDATE smf_refunds 
       SET status = ?, updated_at = ? 
       WHERE id = ?`).run(t,s,e),$.info({refundId:e,status:t},"Refund status updated")}async function m(e){let t=(0,a.getDb)(),r=crypto.randomUUID(),n=new Date().toISOString();return"pool"in t||"function"==typeof t.pool?.query?(await t.pool.query(`INSERT INTO smf_payouts (
        id, smf_payout_id, platform_id, merchant_id, amount, currency,
        destination_type, destination_id, status, estimated_arrival,
        correlation_id, created_at, updated_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13)
      RETURNING *`,[r,e.smf_payout_id,e.platform_id,e.merchant_id,e.amount,e.currency,e.destination_type||null,e.destination_id||null,e.status,e.estimated_arrival||null,e.correlation_id||null,n,n])).rows[0]:(t.prepare(`
      INSERT INTO smf_payouts (
        id, smf_payout_id, platform_id, merchant_id, amount, currency,
        destination_type, destination_id, status, estimated_arrival,
        correlation_id, created_at, updated_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(r,e.smf_payout_id,e.platform_id,e.merchant_id,e.amount,e.currency,e.destination_type||null,e.destination_id||null,e.status,e.estimated_arrival||null,e.correlation_id||null,n,n),{id:r,...e,created_at:n,updated_at:n})}async function y(e){let t=(0,a.getDb)();return"pool"in t||"function"==typeof t.pool?.query?(await t.pool.query("SELECT * FROM smf_payouts WHERE smf_payout_id = $1",[e])).rows[0]||null:t.prepare("SELECT * FROM smf_payouts WHERE smf_payout_id = ?").get(e)||null}async function E(e,t,r,n){let o=(0,a.getDb)(),s=new Date().toISOString();"pool"in o||"function"==typeof o.pool?.query?await o.pool.query(`UPDATE smf_payouts 
       SET status = $1, updated_at = $2 
       WHERE id = $3`,[t,s,e]):o.prepare(`UPDATE smf_payouts 
       SET status = ?, updated_at = ? 
       WHERE id = ?`).run(t,s,e),$.info({payoutId:e,status:t},"Payout status updated")}async function g(e){let t=(0,a.getDb)();return"pool"in t||"function"==typeof t.pool?.query?(await t.pool.query(`SELECT 1 FROM smf_webhook_events 
       WHERE smf_event_id = $1 AND status IN ('processed', 'processing')`,[e])).rows.length>0:!!t.prepare(`SELECT 1 FROM smf_webhook_events 
       WHERE smf_event_id = ? AND status IN ('processed', 'processing')`).get(e)}async function S(e){let t=(0,a.getDb)(),r=crypto.randomUUID(),n=new Date().toISOString();return"pool"in t||"function"==typeof t.pool?.query?(await t.pool.query(`INSERT INTO smf_webhook_events (
        id, smf_event_id, event_type, payload, status, error_message, attempts, received_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8)
      ON CONFLICT (smf_event_id) DO NOTHING
      RETURNING *`,[r,e.smf_event_id,e.event_type,JSON.stringify(e.payload),e.status,e.error_message||null,0,n])).rows[0]:(t.prepare(`
      INSERT OR IGNORE INTO smf_webhook_events (
        id, smf_event_id, event_type, payload, status, error_message, attempts, received_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)
    `).run(r,e.smf_event_id,e.event_type,JSON.stringify(e.payload),e.status,e.error_message||null,0,n),{id:r,...e,attempts:0,received_at:n,processed_at:void 0})}async function h(e,t){let r=(0,a.getDb)(),n=new Date().toISOString(),o=t?"failed":"processed";"pool"in r||"function"==typeof r.pool?.query?await r.pool.query(`UPDATE smf_webhook_events 
       SET status = $1, error_message = $2, processed_at = $3, attempts = attempts + 1
       WHERE smf_event_id = $4`,[o,t||null,n,e]):r.prepare(`UPDATE smf_webhook_events 
       SET status = ?, error_message = ?, processed_at = ?, attempts = attempts + 1
       WHERE smf_event_id = ?`).run(o,t||null,n,e)}e.s(["createCharge",()=>s,"createPayout",()=>m,"createRefund",()=>l,"createWebhookEvent",()=>S,"getChargeByIdempotencyKey",()=>d,"getChargeByOrderId",()=>u,"getChargeBySmfId",()=>i,"getPayoutBySmfId",()=>y,"getRefundBySmfId",()=>_,"getTotalRefundedAmount",()=>p,"isWebhookEventProcessed",()=>g,"markWebhookEventProcessed",()=>h,"updateChargeStatus",()=>c,"updatePayoutStatus",()=>E,"updateRefundStatus",()=>f]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=%5Broot-of-the-server%5D__ee8f3ec3._.js.map
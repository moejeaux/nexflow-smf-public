{"version":3,"sources":["turbopack:///[project]/node_modules/thread-stream/package.json","../../../src/db/x402-watchlist.ts"],"sourcesContent":["{\"name\":\"thread-stream\",\"version\":\"3.1.0\",\"description\":\"A streaming way to send data to a Node.js Worker Thread\",\"main\":\"index.js\",\"types\":\"index.d.ts\",\"dependencies\":{\"real-require\":\"^0.2.0\"},\"devDependencies\":{\"@types/node\":\"^20.1.0\",\"@types/tap\":\"^15.0.0\",\"@yao-pkg/pkg\":\"^5.11.5\",\"desm\":\"^1.3.0\",\"fastbench\":\"^1.0.1\",\"husky\":\"^9.0.6\",\"pino-elasticsearch\":\"^8.0.0\",\"sonic-boom\":\"^4.0.1\",\"standard\":\"^17.0.0\",\"tap\":\"^16.2.0\",\"ts-node\":\"^10.8.0\",\"typescript\":\"^5.3.2\",\"why-is-node-running\":\"^2.2.2\"},\"scripts\":{\"build\":\"tsc --noEmit\",\"test\":\"standard && npm run build && npm run transpile && tap \\\"test/**/*.test.*js\\\" && tap --ts test/*.test.*ts\",\"test:ci\":\"standard && npm run transpile && npm run test:ci:js && npm run test:ci:ts\",\"test:ci:js\":\"tap --no-check-coverage --timeout=120 --coverage-report=lcovonly \\\"test/**/*.test.*js\\\"\",\"test:ci:ts\":\"tap --ts --no-check-coverage --coverage-report=lcovonly \\\"test/**/*.test.*ts\\\"\",\"test:yarn\":\"npm run transpile && tap \\\"test/**/*.test.js\\\" --no-check-coverage\",\"transpile\":\"sh ./test/ts/transpile.sh\",\"prepare\":\"husky install\"},\"standard\":{\"ignore\":[\"test/ts/**/*\",\"test/syntax-error.mjs\"]},\"repository\":{\"type\":\"git\",\"url\":\"git+https://github.com/mcollina/thread-stream.git\"},\"keywords\":[\"worker\",\"thread\",\"threads\",\"stream\"],\"author\":\"Matteo Collina <hello@matteocollina.com>\",\"license\":\"MIT\",\"bugs\":{\"url\":\"https://github.com/mcollina/thread-stream/issues\"},\"homepage\":\"https://github.com/mcollina/thread-stream#readme\"}","// =============================================================================\n// x402 WATCHLIST DATABASE OPERATIONS\n// =============================================================================\n// Database operations for x402 ecosystem watchlist tracking\n\nimport { getDb } from './client';\nimport { createLogger } from '@/lib/logger';\n\nconst logger = createLogger({ component: 'X402WatchlistDB' });\n\n// Shared type for x402 watchlist items\nexport type X402WatchCategory = \n  | 'spec' \n  | 'index' \n  | 'facilitator_docs' \n  | 'gateway_docs' \n  | 'example_api' \n  | 'ecosystem_blog'\n  | 'bazaar_discovery'\n  | 'facilitator_discovery';\nexport type X402WatchStatus = 'active' | 'paused';\n\nexport interface X402WatchItem {\n  id: string;\n  root_domain: string;\n  path_prefix: string | null;\n  category: X402WatchCategory;\n  priority: number;\n  status: X402WatchStatus;\n  last_checked_at: string | null;\n  last_change_at: string | null;\n  last_etag: string | null;\n  last_http_status: number | null;\n  notes: string | null;\n  created_at: string;\n  updated_at: string;\n}\n\nexport type X402WatchItemInsert = Omit<X402WatchItem, 'id' | 'created_at' | 'updated_at' | 'last_checked_at' | 'last_change_at' | 'last_etag' | 'last_http_status'>;\n\n/**\n * Get all active watchlist items, optionally filtered by minimum priority\n */\nexport async function getActiveWatchlistItems(minPriority?: number): Promise<X402WatchItem[]> {\n  const db = getDb();\n  const isPostgres = 'pool' in db || typeof (db as any).pool?.query === 'function';\n\n  let query = `SELECT * FROM x402_watchlist WHERE status = 'active'`;\n  const params: any[] = [];\n\n  if (minPriority !== undefined) {\n    if (isPostgres) {\n      query += ` AND priority >= $1`;\n      params.push(minPriority);\n    } else {\n      query += ` AND priority >= ?`;\n      params.push(minPriority);\n    }\n  }\n\n  query += ` ORDER BY priority DESC, last_checked_at ASC NULLS FIRST`;\n\n  if (isPostgres) {\n    const result = await (db as any).pool.query(query, params);\n    return result.rows;\n  } else {\n    // SQLite\n    const stmt = (db as any).prepare(query);\n    return params.length > 0 ? stmt.all(...params) : stmt.all();\n  }\n}\n\n/**\n * Upsert a watchlist item (by root_domain + path_prefix)\n */\nexport async function upsertWatchlistItem(item: X402WatchItemInsert): Promise<X402WatchItem> {\n  const db = getDb();\n  const id = crypto.randomUUID();\n  const now = new Date().toISOString();\n  const isPostgres = 'pool' in db || typeof (db as any).pool?.query === 'function';\n\n  if (isPostgres) {\n    const result = await (db as any).pool.query(\n      `INSERT INTO x402_watchlist (\n        id, root_domain, path_prefix, category, priority, status, notes, created_at, updated_at\n      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)\n      ON CONFLICT (root_domain, path_prefix)\n      DO UPDATE SET\n        category = EXCLUDED.category,\n        priority = EXCLUDED.priority,\n        status = EXCLUDED.status,\n        notes = EXCLUDED.notes,\n        updated_at = EXCLUDED.updated_at\n      RETURNING *`,\n      [\n        id,\n        item.root_domain,\n        item.path_prefix,\n        item.category,\n        item.priority,\n        item.status,\n        item.notes,\n        now,\n        now,\n      ]\n    );\n    return result.rows[0];\n  } else {\n    // SQLite - use INSERT OR REPLACE\n    const stmt = (db as any).prepare(`\n      INSERT OR REPLACE INTO x402_watchlist (\n        id, root_domain, path_prefix, category, priority, status, notes, created_at, updated_at\n      ) VALUES (\n        COALESCE((SELECT id FROM x402_watchlist WHERE root_domain = ? AND (path_prefix = ? OR (path_prefix IS NULL AND ? IS NULL))), ?),\n        ?, ?, ?, ?, ?, ?,\n        COALESCE((SELECT created_at FROM x402_watchlist WHERE root_domain = ? AND (path_prefix = ? OR (path_prefix IS NULL AND ? IS NULL))), ?),\n        ?\n      )\n    `);\n    stmt.run(\n      item.root_domain, item.path_prefix, item.path_prefix, id,\n      item.root_domain, item.path_prefix, item.category, item.priority, item.status, item.notes,\n      item.root_domain, item.path_prefix, item.path_prefix, now,\n      now\n    );\n\n    // Fetch the inserted/updated row\n    const selectStmt = (db as any).prepare(\n      `SELECT * FROM x402_watchlist WHERE root_domain = ? AND (path_prefix = ? OR (path_prefix IS NULL AND ? IS NULL))`\n    );\n    return selectStmt.get(item.root_domain, item.path_prefix, item.path_prefix);\n  }\n}\n\n/**\n * Update watchlist item after a crawl check\n */\nexport async function updateWatchlistItemAfterCheck(\n  id: string,\n  httpStatus: number,\n  etag: string | null,\n  changed: boolean\n): Promise<void> {\n  const db = getDb();\n  const now = new Date().toISOString();\n  const isPostgres = 'pool' in db || typeof (db as any).pool?.query === 'function';\n\n  if (isPostgres) {\n    if (changed) {\n      await (db as any).pool.query(\n        `UPDATE x402_watchlist \n         SET last_checked_at = $1, last_http_status = $2, last_etag = $3, last_change_at = $4, updated_at = $5\n         WHERE id = $6`,\n        [now, httpStatus, etag, now, now, id]\n      );\n    } else {\n      await (db as any).pool.query(\n        `UPDATE x402_watchlist \n         SET last_checked_at = $1, last_http_status = $2, last_etag = $3, updated_at = $4\n         WHERE id = $5`,\n        [now, httpStatus, etag, now, id]\n      );\n    }\n  } else {\n    // SQLite\n    if (changed) {\n      const stmt = (db as any).prepare(\n        `UPDATE x402_watchlist \n         SET last_checked_at = ?, last_http_status = ?, last_etag = ?, last_change_at = ?, updated_at = ?\n         WHERE id = ?`\n      );\n      stmt.run(now, httpStatus, etag, now, now, id);\n    } else {\n      const stmt = (db as any).prepare(\n        `UPDATE x402_watchlist \n         SET last_checked_at = ?, last_http_status = ?, last_etag = ?, updated_at = ?\n         WHERE id = ?`\n      );\n      stmt.run(now, httpStatus, etag, now, id);\n    }\n  }\n}\n\n/**\n * Get watchlist item by ID\n */\nexport async function getWatchlistItemById(id: string): Promise<X402WatchItem | null> {\n  const db = getDb();\n  const isPostgres = 'pool' in db || typeof (db as any).pool?.query === 'function';\n\n  if (isPostgres) {\n    const result = await (db as any).pool.query(\n      `SELECT * FROM x402_watchlist WHERE id = $1`,\n      [id]\n    );\n    return result.rows[0] || null;\n  } else {\n    const stmt = (db as any).prepare(`SELECT * FROM x402_watchlist WHERE id = ?`);\n    return stmt.get(id) || null;\n  }\n}\n\n/**\n * Get all watchlist items (for admin/debugging)\n */\nexport async function getAllWatchlistItems(): Promise<X402WatchItem[]> {\n  const db = getDb();\n  const isPostgres = 'pool' in db || typeof (db as any).pool?.query === 'function';\n\n  if (isPostgres) {\n    const result = await (db as any).pool.query(\n      `SELECT * FROM x402_watchlist ORDER BY priority DESC, root_domain`\n    );\n    return result.rows;\n  } else {\n    const stmt = (db as any).prepare(\n      `SELECT * FROM x402_watchlist ORDER BY priority DESC, root_domain`\n    );\n    return stmt.all();\n  }\n}\n\n/**\n * Map root domain to facilitator identifier\n */\nfunction deriveFacilitator(rootDomain: string): 'cdp' | 'payai' | 'cronos' | 'altlayer' | 'unknown' {\n  if (rootDomain.includes('cdp.coinbase.com') || rootDomain.includes('coinbase.com')) {\n    return 'cdp';\n  }\n  if (rootDomain.includes('payai.network')) {\n    return 'payai';\n  }\n  if (rootDomain.includes('cronos') || rootDomain.includes('cronoslabs.org')) {\n    return 'cronos';\n  }\n  if (rootDomain.includes('altlayer.io')) {\n    return 'altlayer';\n  }\n  return 'unknown';\n}\n\n/**\n * Map category to kind\n */\nfunction categoryToKind(category: X402WatchCategory): 'bazaar' | 'facilitator' | 'gateway_docs' | 'spec' | 'index' {\n  if (category === 'bazaar_discovery') {\n    return 'bazaar';\n  }\n  if (category === 'facilitator_discovery') {\n    return 'facilitator';\n  }\n  if (category === 'gateway_docs') {\n    return 'gateway_docs';\n  }\n  if (category === 'spec') {\n    return 'spec';\n  }\n  return 'index';\n}\n\n/**\n * Discovery resource for SMF routing logic\n */\nexport type X402DiscoveryResource = {\n  facilitator: 'cdp' | 'payai' | 'cronos' | 'altlayer' | 'unknown';\n  kind: 'bazaar' | 'facilitator' | 'gateway_docs' | 'spec' | 'index';\n  url: string;\n  lastHttpStatus: number | null;\n  lastSeenAt: string | null;\n  category: X402WatchCategory;\n  priority: number;\n};\n\n/**\n * Get x402 discovery resources for SMF\n * Returns normalized discovery endpoints that can be used by SMF routing logic\n */\nexport async function getX402DiscoveryResources(): Promise<X402DiscoveryResource[]> {\n  const items = await getAllWatchlistItems();\n  \n  return items\n    .filter(item => item.status === 'active')\n    .map(item => {\n      const url = `https://${item.root_domain}${item.path_prefix || ''}`;\n      return {\n        facilitator: deriveFacilitator(item.root_domain),\n        kind: categoryToKind(item.category),\n        url,\n        lastHttpStatus: item.last_http_status,\n        lastSeenAt: item.last_checked_at,\n        category: item.category,\n        priority: item.priority,\n      };\n    })\n    .sort((a, b) => {\n      // Sort by priority (desc) then by facilitator\n      if (b.priority !== a.priority) {\n        return b.priority - a.priority;\n      }\n      return a.facilitator.localeCompare(b.facilitator);\n    });\n}\n\n"],"names":[],"mappings":"uqDAAA,EAAA,CAAA,CAAA,CAAA,KAAA,gBAAA,QAAA,QAAA,YAAA,0DAAA,KAAA,WAAA,MAAA,aAAA,aAAA,CAAA,eAAA,QAAA,EAAA,gBAAA,CAAA,cAAA,UAAA,aAAA,UAAA,eAAA,UAAA,KAAA,SAAA,UAAA,SAAA,MAAA,SAAA,qBAAA,SAAA,aAAA,SAAA,SAAA,UAAA,IAAA,UAAA,UAAA,UAAA,WAAA,SAAA,sBAAA,QAAA,EAAA,QAAA,CAAA,MAAA,eAAA,KAAA,yGAAA,UAAA,4EAAA,aAAA,wFAAA,aAAA,+EAAA,YAAA,mEAAA,UAAA,4BAAA,QAAA,eAAA,EAAA,SAAA,CAAA,OAAA,CAAA,eAAA,wBAAA,EAAA,WAAA,CAAA,KAAA,MAAA,IAAA,mDAAA,EAAA,SAAA,CAAA,SAAA,SAAA,UAAA,SAAA,CAAA,OAAA,2CAAA,QAAA,MAAA,KAAA,CAAA,IAAA,kDAAA,EAAA,SAAA,kDAAA,E,kVCKA,IAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,gBAqCO,eAAe,EAAwB,CAAoB,EAChE,IAAM,EAAK,CAAA,EAAA,EAAA,KAAA,AAAK,IACV,EAAa,SAAU,GAAM,AAAmC,mBAA3B,EAAW,IAAI,EAAE,MAExD,EAAQ,CAAC,oDAAoD,CAAC,CAC5D,EAAgB,EAAE,CAcxB,QAZoB,IAAhB,IACE,EACF,CAF2B,EAElB,CAAC,MADI,aACe,CAAC,CAG9B,GAAS,CAAC,kBAAkB,CAAC,CAC7B,EAAO,IAAI,CAAC,IAIhB,GAAS,CAAC,wDAAwD,CAAC,CAE/D,EAEF,MAAO,CADQ,GADD,GACQ,EAAW,IAAI,CAAC,KAAK,CAAC,EAAO,EAAA,EACrC,IACT,AADa,EAGlB,IAAM,EAAQ,EAAW,OAAO,CAAC,GACjC,OAAO,EAAO,MAAM,CAAG,EAAI,EAAK,GAAG,IAAI,GAAU,EAAK,GAAG,EAC3D,CACF,CAmEO,eAAe,EACpB,CAAU,CACV,CAAkB,CAClB,CAAmB,CACnB,CAAgB,EAEhB,IAAM,EAAK,CAAA,EAAA,EAAA,KAAA,AAAK,IACV,EAAM,IAAI,OAAO,WAAW,GACf,SAAU,GAAyC,YAAnC,OAAQ,EAAW,IAAI,EAAE,MAGtD,EACF,MAAO,CADI,CACO,IAAI,CAAC,KAAK,CAC1B,CAAC;;sBAEa,CAAC,CACf,CAAC,EAAK,EAAY,EAAM,EAAK,EAAK,EAAG,EAGvC,MAAO,EAAW,IAAI,CAAC,KAAK,CAC1B,CAAC;;sBAEa,CAAC,CACf,CAAC,EAAK,EAAY,EAAM,EAAK,EAAG,EAKhC,EACY,AAKd,EALyB,KADd,EACqB,CAC9B,CAAC;;qBAEY,CAAC,EAEX,GAAG,CAAC,EAAK,EAAY,EAAM,EAAK,EAAK,GAO1C,AALc,EAAW,OAAO,CAC9B,CAAC;;qBAEY,CAAC,EAEX,GAAG,CAAC,EAAK,EAAY,EAAM,EAAK,EAG3C,0BA7Ke,CAAA,EAAA,EAAA,YAAA,AAAY,EAAC,CAAE,UAAW,iBAAkB"}
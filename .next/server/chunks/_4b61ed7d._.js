module.exports=[28619,e=>e.a(async(t,a)=>{try{var r=e.i(89171),n=e.i(50377),i=e.i(57729),o=e.i(49565),s=e.i(42665),l=e.i(33785),d=t([i]);[i]=d.then?(await d)():d;let f=(0,n.createLogger)({component:"SMFRouteAPI"}),R=new Map,_=new Map;function u(e){let t=Date.now(),a=_.get(e);return!a||t-a.windowStart>36e5?(_.set(e,{count:1,windowStart:t}),{limit:1e3,remaining:999,resetAt:new Date(t+36e5)}):(a.count++,_.set(e,a),{limit:1e3,remaining:Math.max(0,1e3-a.count),resetAt:new Date(a.windowStart+36e5)})}function c(e,t,a,n,i){let o=u(a),s={"X-RateLimit-Limit":o.limit.toString(),"X-RateLimit-Remaining":o.remaining.toString(),"X-RateLimit-Reset":Math.floor(o.resetAt.getTime()/1e3).toString(),"X-Cache":n?"HIT":"MISS","Content-Type":"application/json"};if(i)for(let[e,t]of Object.entries(i))void 0!==t&&(s[e]=t);return r.NextResponse.json(e,{status:t,headers:s})}function p(e,t,a,n){let i={error:e,message:t};return n?c(i,a,n,!1):r.NextResponse.json(i,{status:a})}async function h(e){let t="anonymous";try{var a;let n,d=e.headers.get("authorization");if(!d)return p("MISSING_API_KEY","Authorization header required",401);let h=d.replace(/^Bearer\s+/i,"");if(!h)return p("MISSING_API_KEY","API key required",401);let _=null;try{_=await (0,o.validateApiKey)(h)}catch{(h.startsWith("nf_live_")||h.startsWith("nf_test_"))&&(_={id:h.substring(0,20)})}if(!_)return p("INVALID_API_KEY","Invalid API key",401);if(a=t=_.id,u(a).remaining<=0)return p("RATE_LIMITED","Rate limit exceeded",429,t);try{n=await e.json()}catch{return p("INVALID_REQUEST","Invalid JSON body",400,t)}if(!(0,l.isValidRouteRequest)(n))return p("INVALID_REQUEST","Invalid request: amount_wei, token_address, and chain_id required",400,t);let g=n,m=e.headers.get("idempotency-key")||g.payment_id||crypto.randomUUID(),v=`${t}:${m}`,w=R.get(v);if(w&&w.expiresAt>Date.now())return f.debug({idempotencyKey:m,apiKeyId:t},"Returning cached route response"),c(w.response,200,t,!0);let E=(0,i.getFacilitatorRouter)(),y=E.getFacilitators(),A=y[0],S=.95,I=200,x=await E.scoreFacilitators(y,{network:g.chain_id.includes(":")?g.chain_id.split(":")[1]:g.chain_id,asset:"USDC",amount:g.amount_wei,scheme:"exact"});x.length>0&&(A=x[0].facilitator,S=Math.min(.99,x[0].score/200),I=150+100*Math.random());let C=(0,s.getLoadMonitor)(),T=await C.getLoadMetrics(A.id),{accepted:N,reason:M}=C.shouldAcceptRoute(T.load_level),P=await C.generateBackpressureHeaders(A.id,m);if(!N)return f.warn({apiKeyId:t,facilitator_id:A.id,load_level:T.load_level,load_percentage:T.load_percentage},"Route rejected due to facilitator overload"),r.NextResponse.json({error:"SYSTEM_OVERLOADED",message:M||"Facilitator at capacity. Please retry after the suggested delay.",retry_after_seconds:60},{status:503,headers:{"Content-Type":"application/json","Retry-After":"60",...C.headersToRecord(P)}});let D=BigInt(g.amount_wei),O=25n*D/10000n,b={platform_fee_wei:O.toString(),total_fee_wei:O.toString()},q={level:"automatic",circuit_breaker_state:"CLOSED",facilitator_health:"HIGH"===T.load_level?"suspect":"normal",success_rate_7d:.9987,anomaly_detection_active:!0},k=new Date(Date.now()+3e5),H={facilitator_id:A.id,path:x.length>1?"scored":"direct",expected_fee_wei:O.toString(),fee_breakdown:b,estimated_latency_ms:Math.round(I),confidence:Math.round(100*S)/100,quote_expires_at:k.toISOString(),quote_id:m,protection:q};if(R.set(v,{response:H,expiresAt:Date.now()+3e5}),.1>Math.random()){let e=Date.now();for(let[t,a]of R.entries())a.expiresAt<e&&R.delete(t)}return f.info({apiKeyId:t,idempotencyKey:m,facilitator:H.facilitator_id,confidence:H.confidence,chain_id:g.chain_id,load_level:T.load_level,load_percentage:T.load_percentage},"Route request processed"),c(H,200,t,!1,P)}catch(e){return f.error({error:e,apiKeyId:t},"Route request failed"),p("INTERNAL_ERROR",e instanceof Error?e.message:"Internal server error",500,"anonymous"!==t?t:void 0)}}e.s(["POST",()=>h]),a()}catch(e){a(e)}},!1),30634,e=>e.a(async(t,a)=>{try{var r=e.i(47909),n=e.i(74017),i=e.i(96250),o=e.i(59756),s=e.i(61916),l=e.i(14444),d=e.i(37092),u=e.i(69741),c=e.i(16795),p=e.i(87718),h=e.i(95169),f=e.i(47587),R=e.i(66012),_=e.i(70101),g=e.i(26937),m=e.i(10372),v=e.i(93695);e.i(52474);var w=e.i(220),E=e.i(28619),y=t([E]);[E]=y.then?(await y)():y;let I=new r.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/v1/smf/route/route",pathname:"/api/v1/smf/route",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/v1/smf/route/route.ts",nextConfigOutput:"standalone",userland:E}),{workAsyncStorage:x,workUnitAsyncStorage:C,serverHooks:T}=I;function A(){return(0,i.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:C})}async function S(e,t,a){I.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/v1/smf/route/route";r=r.replace(/\/index$/,"")||"/";let i=await I.prepare(e,t,{srcPage:r,multiZoneDraftMode:!1});if(!i)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:E,params:y,nextConfig:A,parsedUrl:S,isDraftMode:x,prerenderManifest:C,routerServerContext:T,isOnDemandRevalidate:N,revalidateOnlyGenerated:M,resolvedPathname:P,clientReferenceManifest:D,serverActionsManifest:O}=i,b=(0,u.normalizeAppPath)(r),q=!!(C.dynamicRoutes[b]||C.routes[P]),k=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,S,!1):t.end("This page could not be found"),null);if(q&&!x){let e=!!C.routes[P],t=C.dynamicRoutes[b];if(t&&!1===t.fallback&&!e){if(A.experimental.adapterPath)return await k();throw new v.NoFallbackError}}let H=null;!q||I.isDev||x||(H=P,H="/index"===H?"/":H);let U=!0===I.isDev||!q,L=q&&!U;O&&D&&(0,l.setReferenceManifestsSingleton)({page:r,clientReferenceManifest:D,serverActionsManifest:O,serverModuleMap:(0,d.createServerModuleMap)({serverActionsManifest:O})});let j=e.method||"GET",F=(0,s.getTracer)(),K=F.getActiveScopeSpan(),$={params:y,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!A.experimental.authInterrupts},cacheComponents:!!A.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:A.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>I.onRequestError(e,t,r,T)},sharedContext:{buildId:E}},B=new c.NodeNextRequest(e),V=new c.NodeNextResponse(t),X=p.NextRequestAdapter.fromNodeNextRequest(B,(0,p.signalFromNodeResponse)(t));try{let i=async e=>I.handle(X,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=F.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==h.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=a.get("next.route");if(n){let t=`${j} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${r}`)}),l=!!(0,o.getRequestMeta)(e,"minimalMode"),d=async o=>{var s,d;let u=async({previousCacheEntry:n})=>{try{if(!l&&N&&M&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await i(o);e.fetchMetrics=$.renderOpts.fetchMetrics;let s=$.renderOpts.pendingWaitUntil;s&&a.waitUntil&&(a.waitUntil(s),s=void 0);let d=$.renderOpts.collectedTags;if(!q)return await (0,R.sendResponse)(B,V,r,$.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,_.toNodeOutgoingHttpHeaders)(r.headers);d&&(t[m.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,n=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:n}}}}catch(t){throw(null==n?void 0:n.isStale)&&await I.onRequestError(e,t,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,f.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:N})},T),t}},c=await I.handleResponse({req:e,nextConfig:A,cacheKey:H,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:M,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:l});if(!q)return null;if((null==c||null==(s=c.value)?void 0:s.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(d=c.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",N?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,_.fromNodeOutgoingHttpHeaders)(c.value.headers);return l&&q||p.delete(m.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,g.getCacheControlHeader)(c.cacheControl)),await (0,R.sendResponse)(B,V,new Response(c.value.body,{headers:p,status:c.value.status||200})),null};K?await d(K):await F.withPropagatedContext(e.headers,()=>F.trace(h.BaseServerSpan.handleRequest,{spanName:`${j} ${r}`,kind:s.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},d))}catch(t){if(t instanceof v.NoFallbackError||await I.onRequestError(e,t,{routerKind:"App Router",routePath:b,routeType:"route",revalidateReason:(0,f.getRevalidateReason)({isStaticGeneration:L,isOnDemandRevalidate:N})}),q)throw t;return await (0,R.sendResponse)(B,V,new Response(null,{status:500})),null}}e.s(["handler",()=>S,"patchFetch",()=>A,"routeModule",()=>I,"serverHooks",()=>T,"workAsyncStorage",()=>x,"workUnitAsyncStorage",()=>C]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=_4b61ed7d._.js.map
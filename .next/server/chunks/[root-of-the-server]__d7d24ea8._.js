module.exports=[93695,(e,t,a)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},22734,(e,t,a)=>{t.exports=e.x("fs",()=>require("fs"))},30056,e=>e.a(async(t,a)=>{try{let t=await e.y("pg");e.n(t),a()}catch(e){a(e)}},!0),14747,(e,t,a)=>{t.exports=e.x("path",()=>require("path"))},70406,(e,t,a)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},18622,(e,t,a)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,a)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},24361,(e,t,a)=>{t.exports=e.x("util",()=>require("util"))},87769,(e,t,a)=>{t.exports=e.x("node:events",()=>require("node:events"))},49719,(e,t,a)=>{t.exports=e.x("assert",()=>require("assert"))},27699,(e,t,a)=>{t.exports=e.x("events",()=>require("events"))},92509,(e,t,a)=>{t.exports=e.x("url",()=>require("url"))},874,(e,t,a)=>{t.exports=e.x("buffer",()=>require("buffer"))},62562,(e,t,a)=>{t.exports=e.x("module",()=>require("module"))},50227,(e,t,a)=>{t.exports=e.x("node:path",()=>require("node:path"))},94346,e=>{e.v({name:"thread-stream",version:"3.1.0",description:"A streaming way to send data to a Node.js Worker Thread",main:"index.js",types:"index.d.ts",dependencies:{"real-require":"^0.2.0"},devDependencies:{"@types/node":"^20.1.0","@types/tap":"^15.0.0","@yao-pkg/pkg":"^5.11.5",desm:"^1.3.0",fastbench:"^1.0.1",husky:"^9.0.6","pino-elasticsearch":"^8.0.0","sonic-boom":"^4.0.1",standard:"^17.0.0",tap:"^16.2.0","ts-node":"^10.8.0",typescript:"^5.3.2","why-is-node-running":"^2.2.2"},scripts:{build:"tsc --noEmit",test:'standard && npm run build && npm run transpile && tap "test/**/*.test.*js" && tap --ts test/*.test.*ts',"test:ci":"standard && npm run transpile && npm run test:ci:js && npm run test:ci:ts","test:ci:js":'tap --no-check-coverage --timeout=120 --coverage-report=lcovonly "test/**/*.test.*js"',"test:ci:ts":'tap --ts --no-check-coverage --coverage-report=lcovonly "test/**/*.test.*ts"',"test:yarn":'npm run transpile && tap "test/**/*.test.js" --no-check-coverage',transpile:"sh ./test/ts/transpile.sh",prepare:"husky install"},standard:{ignore:["test/ts/**/*","test/syntax-error.mjs"]},repository:{type:"git",url:"git+https://github.com/mcollina/thread-stream.git"},keywords:["worker","thread","threads","stream"],author:"Matteo Collina <hello@matteocollina.com>",license:"MIT",bugs:{url:"https://github.com/mcollina/thread-stream/issues"},homepage:"https://github.com/mcollina/thread-stream#readme"})},37702,(e,t,a)=>{t.exports=e.x("worker_threads",()=>require("worker_threads"))},60526,(e,t,a)=>{t.exports=e.x("node:os",()=>require("node:os"))},77652,(e,t,a)=>{t.exports=e.x("node:diagnostics_channel",()=>require("node:diagnostics_channel"))},87768,e=>e.a(async(t,a)=>{try{var r=e.i(50377),s=e.i(30056),n=t([s]);[s]=n.then?(await n)():n;let g=(0,r.createLogger)({component:"FacilitatorMetricsService"}),v=null;function o(){if(v)return v;let e=process.env.DATABASE_URL;return e&&e.startsWith("postgresql://")?v=new s.Pool({connectionString:e,max:5,idleTimeoutMillis:3e4,connectionTimeoutMillis:5e3}):null}async function i(e){let t=o();if(!t||0===e.length)return;let a=await t.connect();try{for(let t of(await a.query("BEGIN"),e))await a.query(`
        INSERT INTO smf_facilitator_metrics (
          kind, facilitator_id, resource_url, server_id, network,
          timeframe, bucket_minutes, time_bucket_start, time_bucket_end,
          invocations, success_count, failure_count,
          count_2xx, count_3xx, count_4xx, count_5xx,
          error_rate, avg_latency_ms, p50_latency_ms, p90_latency_ms, p95_latency_ms, p99_latency_ms,
          methods, fetched_at, updated_at
        ) VALUES (
          $1, $2, $3, $4, $5,
          $6, $7, $8, $9,
          $10, $11, $12,
          $13, $14, $15, $16,
          $17, $18, $19, $20, $21, $22,
          $23, $24, NOW()
        )
        ON CONFLICT (facilitator_id, timeframe, time_bucket_start)
        DO UPDATE SET
          kind = EXCLUDED.kind,
          resource_url = EXCLUDED.resource_url,
          server_id = EXCLUDED.server_id,
          network = EXCLUDED.network,
          bucket_minutes = EXCLUDED.bucket_minutes,
          time_bucket_end = EXCLUDED.time_bucket_end,
          invocations = EXCLUDED.invocations,
          success_count = EXCLUDED.success_count,
          failure_count = EXCLUDED.failure_count,
          count_2xx = EXCLUDED.count_2xx,
          count_3xx = EXCLUDED.count_3xx,
          count_4xx = EXCLUDED.count_4xx,
          count_5xx = EXCLUDED.count_5xx,
          error_rate = EXCLUDED.error_rate,
          avg_latency_ms = EXCLUDED.avg_latency_ms,
          p50_latency_ms = EXCLUDED.p50_latency_ms,
          p90_latency_ms = EXCLUDED.p90_latency_ms,
          p95_latency_ms = EXCLUDED.p95_latency_ms,
          p99_latency_ms = EXCLUDED.p99_latency_ms,
          methods = EXCLUDED.methods,
          fetched_at = EXCLUDED.fetched_at,
          updated_at = NOW()
      `,[t.kind,t.facilitatorId,t.resourceUrl||null,t.serverId||null,t.network||null,t.timeframe,t.bucketMinutes,t.timeBucketStart,t.timeBucketEnd,t.invocations,t.successCount,t.failureCount,t.count2xx,t.count3xx,t.count4xx,t.count5xx,t.errorRate,t.avgLatencyMs||null,t.p50LatencyMs||null,t.p90LatencyMs||null,t.p95LatencyMs||null,t.p99LatencyMs||null,t.methods?JSON.stringify(t.methods):null,t.fetchedAt]);await a.query("COMMIT"),g.info({count:e.length,facilitatorId:e[0]?.facilitatorId,timeframe:e[0]?.timeframe,msg:"Facilitator metrics upserted to database"})}catch(e){throw await a.query("ROLLBACK"),e}finally{a.release()}}async function c(e,t){let a=o();if(!a)return[];let r=`
    SELECT * FROM smf_facilitator_metrics
    WHERE fetched_at > NOW() - INTERVAL '30 days'
  `,s=[],n=1;return e&&(r+=` AND facilitator_id = $${n}`,s.push(e),n++),t&&(r+=` AND timeframe = $${n}`,s.push(t),n++),r+=" ORDER BY time_bucket_start DESC LIMIT 1000",(await a.query(r,s)).rows.map(l)}function l(e){return{kind:e.kind||"facilitator-global",facilitatorId:e.facilitator_id,resourceUrl:e.resource_url||void 0,serverId:e.server_id||void 0,network:e.network||void 0,timeframe:e.timeframe,bucketMinutes:e.bucket_minutes,timeBucketStart:e.time_bucket_start?.toISOString()||e.time_bucket_start,timeBucketEnd:e.time_bucket_end?.toISOString()||e.time_bucket_end,invocations:e.invocations,successCount:e.success_count,failureCount:e.failure_count,count2xx:e.count_2xx,count3xx:e.count_3xx,count4xx:e.count_4xx,count5xx:e.count_5xx,errorRate:parseFloat(e.error_rate)||0,avgLatencyMs:e.avg_latency_ms?parseFloat(e.avg_latency_ms):void 0,p50LatencyMs:e.p50_latency_ms?parseFloat(e.p50_latency_ms):void 0,p90LatencyMs:e.p90_latency_ms?parseFloat(e.p90_latency_ms):void 0,p95LatencyMs:e.p95_latency_ms?parseFloat(e.p95_latency_ms):void 0,p99LatencyMs:e.p99_latency_ms?parseFloat(e.p99_latency_ms):void 0,methods:e.methods||void 0,fetchedAt:e.fetched_at?.toISOString()||e.fetched_at}}async function u(e){let t=o();if(!t)return;let a=e.dataStart&&e.dataStart.length>0?e.dataStart:null,r=e.dataEnd&&e.dataEnd.length>0?e.dataEnd:null;0!==e.totalInvocations||a||r?(await t.query(`
    INSERT INTO smf_facilitator_summaries (
      facilitator_id, timeframe,
      total_invocations, total_successes, total_failures, overall_error_rate,
      avg_p50_latency_ms, avg_p90_latency_ms, avg_p99_latency_ms,
      top_methods, data_start, data_end, fetched_at, updated_at
    ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, NOW())
    ON CONFLICT (facilitator_id, timeframe)
    DO UPDATE SET
      total_invocations = EXCLUDED.total_invocations,
      total_successes = EXCLUDED.total_successes,
      total_failures = EXCLUDED.total_failures,
      overall_error_rate = EXCLUDED.overall_error_rate,
      avg_p50_latency_ms = EXCLUDED.avg_p50_latency_ms,
      avg_p90_latency_ms = EXCLUDED.avg_p90_latency_ms,
      avg_p99_latency_ms = EXCLUDED.avg_p99_latency_ms,
      top_methods = EXCLUDED.top_methods,
      data_start = COALESCE(EXCLUDED.data_start, smf_facilitator_summaries.data_start),
      data_end = COALESCE(EXCLUDED.data_end, smf_facilitator_summaries.data_end),
      fetched_at = EXCLUDED.fetched_at,
      updated_at = NOW()
  `,[e.facilitatorId,e.timeframe,e.totalInvocations,e.totalSuccesses,e.totalFailures,e.overallErrorRate,e.avgP50LatencyMs||null,e.avgP90LatencyMs||null,e.avgP99LatencyMs||null,JSON.stringify(e.topMethods),a,r,e.fetchedAt]),g.info({facilitatorId:e.facilitatorId,timeframe:e.timeframe,totalInvocations:e.totalInvocations,msg:"Facilitator summary upserted to database"})):g.debug({facilitatorId:e.facilitatorId,timeframe:e.timeframe,msg:"Skipping summary with no data"})}async function d(){let e=o();if(!e)return{};let t=await e.query(`
    SELECT * FROM smf_facilitator_summaries
    ORDER BY fetched_at DESC
  `),a={};for(let e of t.rows)a[`${e.facilitator_id}:${e.timeframe}`]={facilitatorId:e.facilitator_id,timeframe:e.timeframe,totalInvocations:parseInt(e.total_invocations)||0,totalSuccesses:parseInt(e.total_successes)||0,totalFailures:parseInt(e.total_failures)||0,overallErrorRate:parseFloat(e.overall_error_rate)||0,avgP50LatencyMs:e.avg_p50_latency_ms?parseFloat(e.avg_p50_latency_ms):void 0,avgP90LatencyMs:e.avg_p90_latency_ms?parseFloat(e.avg_p90_latency_ms):void 0,avgP99LatencyMs:e.avg_p99_latency_ms?parseFloat(e.avg_p99_latency_ms):void 0,topMethods:e.top_methods||[],dataStart:e.data_start?.toISOString()||e.data_start,dataEnd:e.data_end?.toISOString()||e.data_end,fetchedAt:e.fetched_at?.toISOString()||e.fetched_at};return a}async function p(e){if(0===e.length)return void g.debug("No metrics to upsert");if(o())try{await i(e);return}catch(e){throw g.error({error:e,msg:"Failed to upsert metrics to database"}),e}g.warn({count:e.length,msg:"Database not available, metrics not persisted"})}async function m(){if(o())try{return await d()}catch(e){g.error({error:e,msg:"Failed to load summaries from database"})}return{}}async function _(e){if(o())try{await u(e);return}catch(e){throw g.error({error:e,msg:"Failed to upsert summary to database"}),e}g.warn({facilitatorId:e.facilitatorId,msg:"Database not available, summary not persisted"})}async function f(e){for(let t of e)await _(t)}async function h(e,t){if(o())try{return await c(e,t)}catch(e){g.error({error:e,msg:"Failed to get metrics for facilitator"})}return[]}async function y(e,t){return(await m())[`${e}:${t}`]??null}e.s(["getMetricsForFacilitator",()=>h,"getSummary",()=>y,"loadAllSummaries",()=>m,"upsertFacilitatorPathMetrics",()=>p,"upsertFacilitatorSummaries",()=>f]),a()}catch(e){a(e)}},!1),28261,e=>e.a(async(t,a)=>{try{var r=e.i(89171),s=e.i(87768),n=e.i(50377),o=t([s]);[s]=o.then?(await o)():o;let c=(0,n.createLogger)({component:"MetricsStatusDebug"});async function i(){try{let e=await (0,s.loadAllSummaries)(),t=Date.now(),a=Object.entries(e).map(([e,a])=>{let r=new Date(a.fetchedAt),s=(t-r.getTime())/36e5;return{key:e,facilitatorId:a.facilitatorId,timeframe:a.timeframe,fetchedAt:a.fetchedAt,ageHours:Math.round(10*s)/10,isStale:s>4,totalInvocations:a.totalInvocations,dataStart:a.dataStart,dataEnd:a.dataEnd}});a.sort((e,t)=>t.ageHours-e.ageHours);let n=a.every(e=>e.isStale),o=a[0]?.ageHours||0;return c.info({summaryCount:a.length,allStale:n,oldestAgeHours:o,msg:"Metrics status check"}),r.NextResponse.json({ok:!0,timestamp:new Date().toISOString(),summary:{totalFacilitators:a.length,allDataStale:n,oldestDataHours:o,recommendation:n?"Run pull-metrics job to refresh data":"Data is fresh"},facilitators:a})}catch(e){return c.error({error:e.message,msg:"Failed to check metrics status"}),r.NextResponse.json({ok:!1,error:e.message},{status:500})}}e.s(["GET",()=>i,"dynamic",0,"force-dynamic"]),a()}catch(e){a(e)}},!1),80100,e=>e.a(async(t,a)=>{try{var r=e.i(47909),s=e.i(74017),n=e.i(96250),o=e.i(59756),i=e.i(61916),c=e.i(14444),l=e.i(37092),u=e.i(69741),d=e.i(16795),p=e.i(87718),m=e.i(95169),_=e.i(47587),f=e.i(66012),h=e.i(70101),y=e.i(26937),g=e.i(10372),v=e.i(93695);e.i(52474);var x=e.i(220),E=e.i(28261),D=t([E]);[E]=D.then?(await D)():D;let R=new r.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/debug/metrics-status/route",pathname:"/api/debug/metrics-status",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/debug/metrics-status/route.ts",nextConfigOutput:"standalone",userland:E}),{workAsyncStorage:b,workUnitAsyncStorage:k,serverHooks:S}=R;function C(){return(0,n.patchFetch)({workAsyncStorage:b,workUnitAsyncStorage:k})}async function w(e,t,a){R.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/debug/metrics-status/route";r=r.replace(/\/index$/,"")||"/";let n=await R.prepare(e,t,{srcPage:r,multiZoneDraftMode:!1});if(!n)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:E,params:D,nextConfig:C,parsedUrl:w,isDraftMode:b,prerenderManifest:k,routerServerContext:S,isOnDemandRevalidate:L,revalidateOnlyGenerated:I,resolvedPathname:U,clientReferenceManifest:$,serverActionsManifest:A}=n,O=(0,u.normalizeAppPath)(r),M=!!(k.dynamicRoutes[O]||k.routes[U]),N=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,w,!1):t.end("This page could not be found"),null);if(M&&!b){let e=!!k.routes[U],t=k.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(C.experimental.adapterPath)return await N();throw new v.NoFallbackError}}let T=null;!M||R.isDev||b||(T=U,T="/index"===T?"/":T);let q=!0===R.isDev||!M,F=M&&!q;A&&$&&(0,c.setReferenceManifestsSingleton)({page:r,clientReferenceManifest:$,serverActionsManifest:A,serverModuleMap:(0,l.createServerModuleMap)({serverActionsManifest:A})});let X=e.method||"GET",P=(0,i.getTracer)(),j=P.getActiveScopeSpan(),H={params:D,prerenderManifest:k,renderOpts:{experimental:{authInterrupts:!!C.experimental.authInterrupts},cacheComponents:!!C.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:C.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>R.onRequestError(e,t,r,S)},sharedContext:{buildId:E}},B=new d.NodeNextRequest(e),W=new d.NodeNextResponse(t),K=p.NextRequestAdapter.fromNodeNextRequest(B,(0,p.signalFromNodeResponse)(t));try{let n=async e=>R.handle(K,H).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=P.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=a.get("next.route");if(s){let t=`${X} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${X} ${r}`)}),c=!!(0,o.getRequestMeta)(e,"minimalMode"),l=async o=>{var i,l;let u=async({previousCacheEntry:s})=>{try{if(!c&&L&&I&&!s)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await n(o);e.fetchMetrics=H.renderOpts.fetchMetrics;let i=H.renderOpts.pendingWaitUntil;i&&a.waitUntil&&(a.waitUntil(i),i=void 0);let l=H.renderOpts.collectedTags;if(!M)return await (0,f.sendResponse)(B,W,r,H.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(r.headers);l&&(t[g.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,s=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:x.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:s}}}}catch(t){throw(null==s?void 0:s.isStale)&&await R.onRequestError(e,t,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:L})},S),t}},d=await R.handleResponse({req:e,nextConfig:C,cacheKey:T,routeKind:s.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:k,isRoutePPREnabled:!1,isOnDemandRevalidate:L,revalidateOnlyGenerated:I,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:c});if(!M)return null;if((null==d||null==(i=d.value)?void 0:i.kind)!==x.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});c||t.setHeader("x-nextjs-cache",L?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),b&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,h.fromNodeOutgoingHttpHeaders)(d.value.headers);return c&&M||p.delete(g.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,y.getCacheControlHeader)(d.cacheControl)),await (0,f.sendResponse)(B,W,new Response(d.value.body,{headers:p,status:d.value.status||200})),null};j?await l(j):await P.withPropagatedContext(e.headers,()=>P.trace(m.BaseServerSpan.handleRequest,{spanName:`${X} ${r}`,kind:i.SpanKind.SERVER,attributes:{"http.method":X,"http.target":e.url}},l))}catch(t){if(t instanceof v.NoFallbackError||await R.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:L})}),M)throw t;return await (0,f.sendResponse)(B,W,new Response(null,{status:500})),null}}e.s(["handler",()=>w,"patchFetch",()=>C,"routeModule",()=>R,"serverHooks",()=>S,"workAsyncStorage",()=>b,"workUnitAsyncStorage",()=>k]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=%5Broot-of-the-server%5D__d7d24ea8._.js.map
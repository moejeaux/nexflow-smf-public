module.exports=[70553,e=>e.a(async(t,r)=>{try{var a=e.i(50377),o=e.i(57729),s=e.i(60827),n=t([o,s]);[o,s]=n.then?(await n)():n;let f=(0,a.createLogger)({component:"X402Router"});function i(e,t=6){if(!e)return null;try{if(e.includes(".")){let[r,a=""]=e.split("."),o=a.padEnd(t,"0").slice(0,t);return BigInt(r+o)}return BigInt(e)}catch(t){return f.warn({value:e,error:t instanceof Error?t.message:"Unknown",msg:"Failed to convert maxSpend to atomic units"}),null}}function c(e){if(!e)return 0;let t=e.reputationScore??0,r="high"===e.trustTier?.2:.1*("medium"===e.trustTier);return Math.min(1,t+r)}async function l(e){let{agentId:t,walletId:r,resource:a,maxSpend:o}=e;f.debug({agentId:t,walletId:r,resource:a,maxSpend:o,msg:"Checking payment policy"});let s=BigInt("100000000"),n=i(o);return null!==n&&n>s?{allowed:!1,reason:`Max spend exceeds safety limit of ${s.toString()} atomic units`,details:{maxSpend:o,maxSpendAtomic:n.toString(),limit:s.toString()}}:{allowed:!0}}async function u(e){let{preferredNetworks:t,preferredAssets:r,facilitatorHints:a,facilitatorStrategy:s}=e,n=(0,o.getFacilitatorRouter)();n.getFacilitators();let i="eip155:8453",c="0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913";if(a&&a.length>0)for(let e of a){let a=n.getFacilitator(e.toLowerCase());if(a&&a.config.enabled){let e=t?.[0]||i,o=r?.[0]||c;if(a.supports(e,o,"exact"))return f.debug({facilitatorId:a.id,network:e,asset:o,msg:"Selected facilitator from hints"}),{facilitatorId:a.id,scheme:"exact",network:e,asset:o,facilitator:a}}}let l=t?.[0]||i,u=r?.[0]||c,d={scheme:"exact",network:l,asset:u,maxAmountRequired:e.maxSpend||"1000000",resource:e.resource,payTo:"0x0000000000000000000000000000000000000001"};try{let e=await n.routePayment(d,{preferredNetworks:t||[i],preferredAssets:r||["USDC"],priority:"reliability",facilitatorStrategy:s||"auto"});return{facilitatorId:e.id,scheme:"exact",network:l,asset:u,facilitator:e}}catch(o){f.warn({error:o instanceof Error?o.message:"Unknown error",preferredNetworks:t,preferredAssets:r,msg:"Failed to select facilitator via router"});let e=n.getFacilitator("cdp");if(e&&e.config.enabled){let r=t?.find(t=>e.config.networks.includes(t)||e.config.networksCAIP?.includes(t))||"eip155:8453";return{facilitatorId:"cdp",scheme:"exact",network:r,asset:c,facilitator:e}}let a=n.getFacilitator("payai");if(a&&a.config.enabled)return{facilitatorId:"payai",scheme:"exact",network:t?.[0]||"base",asset:c,facilitator:a};return null}}async function d(e,t,r){let a=Date.now(),{resource:o,method:n,headers:c={},body:l}=t;try{let u;f.debug({resource:o,method:n,facilitatorId:e.facilitatorId,msg:"Calling target resource to check payment requirements"});let d=await fetch(o,{method:n,headers:{...c,"Content-Type":"application/json",Accept:"application/json"},body:l?JSON.stringify(l):void 0,signal:AbortSignal.timeout(3e4)});if(402===d.status){let n;f.info({resource:o,status:402,facilitatorId:e.facilitatorId,msg:"Resource requires payment (402), processing x402 flow"});let c=d.headers.get("www-authenticate"),l=d.headers.get("x-payment-requirements");if(!l&&!c)return{status:"error",errorCode:"invalid_request",message:"Resource returned 402 but no payment requirements found",details:{resource:o,headers:Object.fromEntries(d.headers.entries())}};try{n=l?JSON.parse(l):{scheme:"exact",network:e.network,asset:e.asset,maxAmountRequired:t.maxSpend||"1000000",resource:o,payTo:""}}catch(e){return{status:"error",errorCode:"invalid_request",message:"Failed to parse payment requirements from 402 response",details:{paymentRequirementsJson:l,error:e instanceof Error?e.message:"Parse error"}}}let u=BigInt(n.maxAmountRequired||"0"),p=i(t.maxSpend)??BigInt("999999999999");if(u>p)return{status:"error",errorCode:"policy_blocked",message:`Payment amount ${u.toString()} exceeds maxSpend ${p.toString()}`,details:{required:u.toString(),maxSpend:p.toString()}};try{await (0,s.createRouteAttempt)({route_id:r,facilitator_id:e.facilitatorId,phase:"verify",result:"success",latency_ms:Date.now()-a,error_code:null,raw_status:402,is_probe:!1})}catch(e){f.debug({error:e instanceof Error?e.message:"Unknown",msg:"Failed to log route attempt"})}let m=n.maxAmountRequired||"1000000";return{status:"success",routeId:r,facilitatorId:e.facilitatorId,network:e.network,asset:e.asset,amountPaid:m,httpStatus:200,httpHeaders:{"x-payment-processed":"true","x-facilitator":e.facilitatorId},httpBody:{message:"Payment flow initiated - wallet signing required for completion",paymentRequirements:n,note:"Full x402 payment execution requires wallet integration"}}}let p={};d.headers.forEach((e,t)=>{p[t]=e}),u=(d.headers.get("content-type")||"").includes("application/json")?await d.json():await d.text();try{await (0,s.createRouteAttempt)({route_id:r,facilitator_id:e.facilitatorId,phase:"verify",result:d.ok?"success":"failure",latency_ms:Date.now()-a,error_code:d.ok?null:`HTTP_${d.status}`,raw_status:d.status,is_probe:!1})}catch(e){f.debug({error:e instanceof Error?e.message:"Unknown",msg:"Failed to log route attempt"})}if(!d.ok)return{status:"error",errorCode:"network_error",message:`Resource returned HTTP ${d.status}`,details:{httpStatus:d.status,httpHeaders:p,httpBody:u}};return{status:"success",routeId:r,facilitatorId:e.facilitatorId,network:e.network,asset:e.asset,amountPaid:"0",httpStatus:d.status,httpHeaders:p,httpBody:u}}catch(i){let t=Date.now()-a,o=i instanceof Error&&("AbortError"===i.name||i.message.toLowerCase().includes("timeout")),n=i instanceof Error&&(i.message.toLowerCase().includes("network")||i.message.toLowerCase().includes("fetch")||i.message.toLowerCase().includes("econnrefused"));try{await (0,s.createRouteAttempt)({route_id:r,facilitator_id:e.facilitatorId,phase:"verify",result:o?"timeout":n?"network_error":"failure",latency_ms:t,error_code:i instanceof Error?i.message:"Unknown error",raw_status:null,is_probe:!1})}catch(e){f.debug({error:e instanceof Error?e.message:"Unknown",msg:"Failed to log route attempt"})}return{status:"error",errorCode:n||o?"network_error":"facilitator_error",message:i instanceof Error?i.message:"Execution failed",details:{isTimeout:o,isNetworkError:n}}}}async function p(e){var t,r,a;let o,n,i,{agentId:p,walletId:m,resource:g,method:h,preferredNetworks:w,preferredAssets:y,facilitatorHints:R}=e;f.info({component:"X402Router",agentId:p,walletId:m,resource:g,method:h,preferredNetworks:w,preferredAssets:y,facilitatorHints:R,msg:"Routing x402 job"});let x=await l(e);if(!x.allowed)return f.warn({agentId:p,walletId:m,resource:g,reason:x.reason,msg:"Policy blocked x402 job"}),{status:"error",errorCode:"policy_blocked",message:x.reason||"Policy check failed",details:x.details};let v=await u(e);if(!v)return f.error({agentId:p,walletId:m,resource:g,preferredNetworks:w,preferredAssets:y,msg:"No suitable facilitator found"}),{status:"error",errorCode:"routing_failed",message:"No suitable facilitator found for the requested network/asset combination",details:{preferredNetworks:w,preferredAssets:y}};let C=c(e.erc8004),E=(t=e.erc8004,o=c(t),{compositeScore:.9+.1*o,erc8004Score:o,erc8004Weight:.1}),S=e.mode||"live",I=v.facilitator.config.healthCheckUrl;r={facilitatorId:v.facilitatorId,facilitatorUrl:I,network:v.network,asset:v.asset,mode:S,strategy:e.facilitatorStrategy||"auto",agentId:e.agentId,agentType:e.agentType,useCase:e.useCase,resource:e.resource,erc8004Score:C},f.info({component:"X402Router",event:"routing_decision",facilitatorId:r.facilitatorId,facilitatorUrl:r.facilitatorUrl,network:r.network,asset:r.asset,mode:r.mode,strategy:r.strategy,agentId:r.agentId,agentType:r.agentType??"unknown",useCase:r.useCase,resourceUrl:r.resource,serverId:r.serverId,reasons:r.reasons,score:r.score,alternatives:r.alternatives,erc8004Score:r.erc8004Score,msg:`Routing decision: ${r.facilitatorId} for ${r.network}`}),f.info({component:"X402Router",facilitatorId:v.facilitatorId,facilitatorUrl:I,scheme:v.scheme,network:v.network,asset:v.asset,strategy:e.facilitatorStrategy||"auto",mode:S,erc8004:{present:!!e.erc8004,agentId:e.erc8004?.agentId,trustTier:e.erc8004?.trustTier,reputationScore:e.erc8004?.reputationScore,computedTrustScore:C,compositeScore:E.compositeScore,erc8004Weight:E.erc8004Weight},msg:"Selected facilitator for x402 job"});let k=crypto.randomUUID(),b=!1;try{k=(await (0,s.createRoute)({request_id:crypto.randomUUID(),correlation_id:p?`agent:${p}`:null,client_id:m||null,agent_id:p||null,network:v.network,token:v.asset,amount:e.maxSpend||"0",selected_facilitator_id:v.facilitatorId,status:"verifying"})).id,b=!0}catch(e){f.warn({error:e instanceof Error?e.message:"Unknown error",fallbackRouteId:k,msg:"Failed to create route record in DB, continuing with execution"})}let _=await d(v,e,k);if(b)try{"success"===_.status?await (0,s.updateRouteStatus)(k,"settled",new Date().toISOString()):await (0,s.updateRouteStatus)(k,"failed",new Date().toISOString())}catch(e){f.warn({routeId:k,error:e instanceof Error?e.message:"Unknown error",msg:"Failed to update route status"})}return n=(a={facilitatorId:v.facilitatorId,facilitatorUrl:I,network:v.network,asset:v.asset,success:"success"===_.status,errorCode:"error"===_.status?_.errorCode:void 0,errorMessage:"error"===_.status?_.message:void 0,httpStatus:"success"===_.status?_.httpStatus:void 0,amountPaid:"success"===_.status?_.amountPaid:void 0,mode:S,agentType:e.agentType,useCase:e.useCase,resourceUrl:e.resource}).success?f.info.bind(f):f.warn.bind(f),i=a.success?"success":"TIMEOUT"===a.errorCode?"timeout":"failed",n({component:"X402Router",event:"route_complete",facilitatorId:a.facilitatorId,facilitatorUrl:a.facilitatorUrl,network:a.network,asset:a.asset,success:a.success,status:i,errorCode:a.errorCode,errorMessage:a.errorMessage,httpStatus:a.httpStatus,latencyMs:a.latencyMs,amountPaid:a.amountPaid,transactionHash:a.transactionHash,mode:a.mode,agentType:a.agentType??"unknown",useCase:a.useCase,resourceUrl:a.resourceUrl,serverId:a.serverId,reasons:a.reasons,msg:a.success?`Route completed: ${a.facilitatorId} on ${a.network}`:`Route failed: ${a.facilitatorId} - ${a.errorCode}`}),f.info({component:"X402Router",routeId:k,facilitatorId:v.facilitatorId,facilitatorUrl:I,status:_.status,errorCode:"error"===_.status?_.errorCode:null,msg:"x402 job execution completed"}),_}e.s(["routeAndExecuteX402Job",()=>p]),r()}catch(e){r(e)}},!1),71471,e=>e.a(async(t,r)=>{try{var a=e.i(70553),o=t([a]);[a]=o.then?(await o)():o,e.s([]),r()}catch(e){r(e)}},!1),62668,e=>e.a(async(t,r)=>{try{var a=e.i(89171),o=e.i(71471),s=e.i(70553),n=e.i(50377),i=t([o,s]);[o,s]=i.then?(await i)():i;let u=(0,n.createLogger)({component:"RouterExecuteEndpoint"}),d={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"},p=process.env.X402_ROUTER_MODE??"demo";async function c(){return new a.NextResponse(null,{status:200,headers:d})}async function l(e){let t=null;try{t=await e.json()}catch(e){return u.warn({error:e instanceof Error?e.message:"Unknown",msg:"Failed to parse request body"}),a.NextResponse.json({ok:!1,mode:p,error:"Invalid JSON body"},{status:200,headers:d})}if("demo"===p)return a.NextResponse.json({ok:!0,mode:"demo",message:"NexFlow router received your request.",received:t},{status:200,headers:d});try{let e=await (0,s.routeAndExecuteX402Job)(t);return a.NextResponse.json({ok:!0,mode:"smf",result:e},{status:200,headers:d})}catch(o){let e=o instanceof Error?o.message:String(o),r=o instanceof Error?o.stack:void 0;return u.error({error:e,stack:r,body:JSON.stringify(t).substring(0,500),msg:"Router execution failed with uncaught exception"}),a.NextResponse.json({ok:!1,mode:"smf",error:"Router execution failed",details:e},{status:200,headers:d})}}e.s(["OPTIONS",()=>c,"POST",()=>l]),r()}catch(e){r(e)}},!1),41023,e=>e.a(async(t,r)=>{try{var a=e.i(47909),o=e.i(74017),s=e.i(96250),n=e.i(59756),i=e.i(61916),c=e.i(14444),l=e.i(37092),u=e.i(69741),d=e.i(16795),p=e.i(87718),f=e.i(95169),m=e.i(47587),g=e.i(66012),h=e.i(70101),w=e.i(26937),y=e.i(10372),R=e.i(93695);e.i(52474);var x=e.i(220),v=e.i(62668),C=t([v]);[v]=C.then?(await C)():C;let I=new a.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/x402/router/execute/route",pathname:"/api/x402/router/execute",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/x402/router/execute/route.ts",nextConfigOutput:"standalone",userland:v}),{workAsyncStorage:k,workUnitAsyncStorage:b,serverHooks:_}=I;function E(){return(0,s.patchFetch)({workAsyncStorage:k,workUnitAsyncStorage:b})}async function S(e,t,r){I.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/x402/router/execute/route";a=a.replace(/\/index$/,"")||"/";let s=await I.prepare(e,t,{srcPage:a,multiZoneDraftMode:!1});if(!s)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:v,params:C,nextConfig:E,parsedUrl:S,isDraftMode:k,prerenderManifest:b,routerServerContext:_,isOnDemandRevalidate:T,revalidateOnlyGenerated:A,resolvedPathname:P,clientReferenceManifest:U,serverActionsManifest:N}=s,O=(0,u.normalizeAppPath)(a),q=!!(b.dynamicRoutes[O]||b.routes[P]),D=async()=>((null==_?void 0:_.render404)?await _.render404(e,t,S,!1):t.end("This page could not be found"),null);if(q&&!k){let e=!!b.routes[P],t=b.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(E.experimental.adapterPath)return await D();throw new R.NoFallbackError}}let M=null;!q||I.isDev||k||(M=P,M="/index"===M?"/":M);let H=!0===I.isDev||!q,F=q&&!H;N&&U&&(0,c.setReferenceManifestsSingleton)({page:a,clientReferenceManifest:U,serverActionsManifest:N,serverModuleMap:(0,l.createServerModuleMap)({serverActionsManifest:N})});let j=e.method||"GET",$=(0,i.getTracer)(),B=$.getActiveScopeSpan(),L={params:C,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!E.experimental.authInterrupts},cacheComponents:!!E.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:E.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>I.onRequestError(e,t,a,_)},sharedContext:{buildId:v}},X=new d.NodeNextRequest(e),K=new d.NodeNextResponse(t),J=p.NextRequestAdapter.fromNodeNextRequest(X,(0,p.signalFromNodeResponse)(t));try{let s=async e=>I.handle(J,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=$.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==f.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=r.get("next.route");if(o){let t=`${j} ${o}`;e.setAttributes({"next.route":o,"http.route":o,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${a}`)}),c=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var i,l;let u=async({previousCacheEntry:o})=>{try{if(!c&&T&&A&&!o)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await s(n);e.fetchMetrics=L.renderOpts.fetchMetrics;let i=L.renderOpts.pendingWaitUntil;i&&r.waitUntil&&(r.waitUntil(i),i=void 0);let l=L.renderOpts.collectedTags;if(!q)return await (0,g.sendResponse)(X,K,a,L.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(a.headers);l&&(t[y.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=y.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,o=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=y.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:x.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:o}}}}catch(t){throw(null==o?void 0:o.isStale)&&await I.onRequestError(e,t,{routerKind:"App Router",routePath:a,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:T})},_),t}},d=await I.handleResponse({req:e,nextConfig:E,cacheKey:M,routeKind:o.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:A,responseGenerator:u,waitUntil:r.waitUntil,isMinimalMode:c});if(!q)return null;if((null==d||null==(i=d.value)?void 0:i.kind)!==x.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});c||t.setHeader("x-nextjs-cache",T?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),k&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,h.fromNodeOutgoingHttpHeaders)(d.value.headers);return c&&q||p.delete(y.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,w.getCacheControlHeader)(d.cacheControl)),await (0,g.sendResponse)(X,K,new Response(d.value.body,{headers:p,status:d.value.status||200})),null};B?await l(B):await $.withPropagatedContext(e.headers,()=>$.trace(f.BaseServerSpan.handleRequest,{spanName:`${j} ${a}`,kind:i.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},l))}catch(t){if(t instanceof R.NoFallbackError||await I.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:T})}),q)throw t;return await (0,g.sendResponse)(X,K,new Response(null,{status:500})),null}}e.s(["handler",()=>S,"patchFetch",()=>E,"routeModule",()=>I,"serverHooks",()=>_,"workAsyncStorage",()=>k,"workUnitAsyncStorage",()=>b]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=_0a3fd613._.js.map
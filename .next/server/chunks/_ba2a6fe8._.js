module.exports=[1876,e=>{"use strict";let t=(0,e.i(50377).createLogger)({component:"SlackNotifier"});async function r(e){let r=process.env.SLACK_WEBHOOK_URL;if(!r)return t.warn("SLACK_WEBHOOK_URL not configured, skipping notification"),!1;try{let a=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!a.ok)return t.error({status:a.status},"Failed to send Slack message"),!1;return t.info("Slack message sent successfully"),!0}catch(e){return t.error({error:e},"Error sending Slack message"),!1}}async function a(e){if(0===e.changed&&0===e.errors)return t.info("No changes or errors, skipping Slack notification"),!1;let a=e.errors>0?"ðŸš¨":"ðŸ“¢",o=e.errors>0?"#dc3545":"#28a745",n=e.results.filter(e=>e.changed&&!e.error).map(e=>`â€¢ ${e.domain}${e.path||""} (${e.category})`).join("\n"),i=e.results.filter(e=>e.error).map(e=>`â€¢ ${e.domain}${e.path||""}: ${e.error}`).join("\n"),s=[{type:"header",text:{type:"plain_text",text:`${a} x402 Ecosystem Discovery Update`,emoji:!0}},{type:"section",fields:[{type:"mrkdwn",text:`*Checked:* ${e.checked}`},{type:"mrkdwn",text:`*Changed:* ${e.changed}`},{type:"mrkdwn",text:`*Errors:* ${e.errors}`},{type:"mrkdwn",text:`*Time:* ${new Date(e.timestamp).toLocaleString()}`}]}];return n&&s.push({type:"section",text:{type:"mrkdwn",text:`*ðŸ”„ Changed Domains:*
${n}`}}),i&&s.push({type:"section",text:{type:"mrkdwn",text:`*âŒ Errors:*
${i}`}}),r({text:`x402 Discovery: ${e.changed} changes, ${e.errors} errors`,blocks:s,attachments:[{color:o,footer:"NexFlow SMF â€¢ x402 Discovery Crawler",ts:Math.floor(Date.now()/1e3)}]})}e.s(["notifyX402DiscoveryCrawl",()=>a])},14321,e=>e.a(async(t,r)=>{try{var a=e.i(54799),o=e.i(50377),n=e.i(7484),i=e.i(24297),s=e.i(1876),c=t([n,i]);[n,i]=c.then?(await c)():c;let h=(0,o.createLogger)({component:"X402DiscoveryCron"});function l(e){return"bazaar_discovery"===e||"facilitator_discovery"===e}function d(e){return(0,a.createHash)("sha256").update(e.slice(0,65536)).digest("hex").slice(0,32)}async function u(e,t,r){let a=`https://${e.root_domain}${e.path_prefix||""}`,o={id:e.id,root_domain:e.root_domain,path_prefix:e.path_prefix,category:e.category,priority:e.priority,url:a,httpStatus:0,etag:null,changed:!1},n=l(e.category),i=n?"GET":t;try{let t=new AbortController,s=setTimeout(()=>t.abort(),r),c=await fetch(a,{method:i,headers:{"User-Agent":"NexflowSMF/1.0 x402-discovery",Accept:n?"application/json":"text/html,application/json,*/*"},signal:t.signal,redirect:"follow"});if(clearTimeout(s),o.httpStatus=c.status,n)if(c.ok)try{let t,r=await c.text();try{t=JSON.parse(r)}catch(t){return o.error="Invalid JSON response",h.warn({url:a,category:e.category,status:c.status},"Discovery endpoint returned invalid JSON"),o}let n=JSON.stringify(t);o.etag=`json-hash:${d(n)}`}catch(t){o.error=t instanceof Error?t.message:"Failed to process JSON",h.warn({url:a,category:e.category,error:o.error},"Failed to process discovery endpoint response")}else o.error=`HTTP ${c.status}`,h.warn({url:a,category:e.category,status:c.status},"Discovery endpoint returned non-200 status");else{let e=c.headers.get("etag");if(e)o.etag=e;else if("GET"===i){let e=await c.text();o.etag=`hash:${d(e)}`}}e.last_etag&&o.etag?o.changed=e.last_etag!==o.etag:null!==e.last_http_status&&e.last_http_status!==o.httpStatus?o.changed=!0:e.last_checked_at||(o.changed=!0)}catch(t){t instanceof Error?"AbortError"===t.name?(o.error="timeout",o.httpStatus=408):(o.error=t.message,o.httpStatus=0):(o.error="Unknown error",o.httpStatus=0),l(e.category)&&h.warn({url:a,category:e.category,error:o.error},"Discovery endpoint crawl failed (non-fatal)")}return o}async function p(e,t){let{runId:r,requestId:a}=t,{searchParams:o}=new URL(e.url),n=o.get("maxPriority"),c=o.get("method")?.toUpperCase()||"HEAD",d=parseInt(o.get("timeout")||"10000",10),p=n?parseInt(n,10):void 0;h.info({runId:r,requestId:a,minPriority:p,method:c,timeout:d,msg:"Starting x402 discovery crawl"});let g=await (0,i.getActiveWatchlistItems)(p);if(0===g.length)return h.info({runId:r,requestId:a,msg:"No active watchlist items to crawl"}),{ok:!0,checked:0,changed:0,errors:0,message:"No active watchlist items",timestamp:new Date().toISOString()};h.info({runId:r,requestId:a,count:g.length},`Found ${g.length} watchlist items to crawl`);let y=[],f=0,m=0,w={},v={},x={};for(let e of g){let t=await u(e,c,d);y.push(t),w[t.category]=(w[t.category]||0)+1,t.changed&&(v[t.category]=(v[t.category]||0)+1),t.error&&(x[t.category]=(x[t.category]||0)+1,m++),h.info({runId:r,requestId:a,kind:"x402_discovery_check",root_domain:t.root_domain,path_prefix:t.path_prefix,category:t.category,priority:t.priority,httpStatus:t.httpStatus,changed:t.changed,error:t.error,isDiscovery:l(t.category)},`Checked ${t.url}: status=${t.httpStatus}, changed=${t.changed}`);try{await (0,i.updateWatchlistItemAfterCheck)(e.id,t.httpStatus,t.etag,t.changed),t.changed&&!t.error&&f++}catch(t){h.error({runId:r,requestId:a,error:t,itemId:e.id},"Failed to update watchlist item"),m++}}let R={ok:0===m,checked:y.length,changed:f,errors:m,byCategory:{crawled:w,changed:v,errors:x},timestamp:new Date().toISOString(),results:y.map(e=>({domain:e.root_domain,path:e.path_prefix,category:e.category,priority:e.priority,status:e.httpStatus,changed:e.changed,error:e.error}))};return h.info({runId:r,requestId:a,checked:R.checked,changed:R.changed,errors:R.errors,crawled:w,msg:"x402 watchlist crawl completed"}),await (0,s.notifyX402DiscoveryCrawl)(R).catch(e=>{h.error({runId:r,requestId:a,error:e},"Failed to send Slack notification")}),R}let g=(0,n.withCronJobTracking)(p,{jobId:"x402-discovery",timeout:55e3,minInterval:828e5});e.s(["GET",0,g,"dynamic",0,"force-dynamic","maxDuration",0,60]),r()}catch(e){r(e)}},!1),6737,e=>e.a(async(t,r)=>{try{var a=e.i(47909),o=e.i(74017),n=e.i(96250),i=e.i(59756),s=e.i(61916),c=e.i(14444),l=e.i(37092),d=e.i(69741),u=e.i(16795),p=e.i(87718),h=e.i(95169),g=e.i(47587),y=e.i(66012),f=e.i(70101),m=e.i(26937),w=e.i(10372),v=e.i(93695);e.i(52474);var x=e.i(220),R=e.i(14321),E=t([R]);[R]=E.then?(await E)():E;let _=new a.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/cron/x402-discovery/route",pathname:"/api/cron/x402-discovery",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/cron/x402-discovery/route.ts",nextConfigOutput:"standalone",userland:R}),{workAsyncStorage:k,workUnitAsyncStorage:A,serverHooks:N}=_;function S(){return(0,n.patchFetch)({workAsyncStorage:k,workUnitAsyncStorage:A})}async function C(e,t,r){_.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/cron/x402-discovery/route";a=a.replace(/\/index$/,"")||"/";let n=await _.prepare(e,t,{srcPage:a,multiZoneDraftMode:!1});if(!n)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:R,params:E,nextConfig:S,parsedUrl:C,isDraftMode:k,prerenderManifest:A,routerServerContext:N,isOnDemandRevalidate:T,revalidateOnlyGenerated:O,resolvedPathname:$,clientReferenceManifest:b,serverActionsManifest:D}=n,P=(0,d.normalizeAppPath)(a),I=!!(A.dynamicRoutes[P]||A.routes[$]),U=async()=>((null==N?void 0:N.render404)?await N.render404(e,t,C,!1):t.end("This page could not be found"),null);if(I&&!k){let e=!!A.routes[$],t=A.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(S.experimental.adapterPath)return await U();throw new v.NoFallbackError}}let H=null;!I||_.isDev||k||(H=$,H="/index"===H?"/":H);let M=!0===_.isDev||!I,F=I&&!M;D&&b&&(0,c.setReferenceManifestsSingleton)({page:a,clientReferenceManifest:b,serverActionsManifest:D,serverModuleMap:(0,l.createServerModuleMap)({serverActionsManifest:D})});let j=e.method||"GET",q=(0,s.getTracer)(),L=q.getActiveScopeSpan(),K={params:E,prerenderManifest:A,renderOpts:{experimental:{authInterrupts:!!S.experimental.authInterrupts},cacheComponents:!!S.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:S.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>_.onRequestError(e,t,a,N)},sharedContext:{buildId:R}},B=new u.NodeNextRequest(e),J=new u.NodeNextResponse(t),G=p.NextRequestAdapter.fromNodeNextRequest(B,(0,p.signalFromNodeResponse)(t));try{let n=async e=>_.handle(G,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=q.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==h.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=r.get("next.route");if(o){let t=`${j} ${o}`;e.setAttributes({"next.route":o,"http.route":o,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${a}`)}),c=!!(0,i.getRequestMeta)(e,"minimalMode"),l=async i=>{var s,l;let d=async({previousCacheEntry:o})=>{try{if(!c&&T&&O&&!o)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await n(i);e.fetchMetrics=K.renderOpts.fetchMetrics;let s=K.renderOpts.pendingWaitUntil;s&&r.waitUntil&&(r.waitUntil(s),s=void 0);let l=K.renderOpts.collectedTags;if(!I)return await (0,y.sendResponse)(B,J,a,K.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(a.headers);l&&(t[w.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,o=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:x.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:o}}}}catch(t){throw(null==o?void 0:o.isStale)&&await _.onRequestError(e,t,{routerKind:"App Router",routePath:a,routeType:"route",revalidateReason:(0,g.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:T})},N),t}},u=await _.handleResponse({req:e,nextConfig:S,cacheKey:H,routeKind:o.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:O,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:c});if(!I)return null;if((null==u||null==(s=u.value)?void 0:s.kind)!==x.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});c||t.setHeader("x-nextjs-cache",T?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),k&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,f.fromNodeOutgoingHttpHeaders)(u.value.headers);return c&&I||p.delete(w.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,m.getCacheControlHeader)(u.cacheControl)),await (0,y.sendResponse)(B,J,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};L?await l(L):await q.withPropagatedContext(e.headers,()=>q.trace(h.BaseServerSpan.handleRequest,{spanName:`${j} ${a}`,kind:s.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},l))}catch(t){if(t instanceof v.NoFallbackError||await _.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,g.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:T})}),I)throw t;return await (0,y.sendResponse)(B,J,new Response(null,{status:500})),null}}e.s(["handler",()=>C,"patchFetch",()=>S,"routeModule",()=>_,"serverHooks",()=>N,"workAsyncStorage",()=>k,"workUnitAsyncStorage",()=>A]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=_ba2a6fe8._.js.map
module.exports=[27054,e=>e.a(async(t,r)=>{try{var a=e.i(50377),i=e.i(59670),o=t([i]);[i]=o.then?(await o)():o;let l=(0,a.createLogger)({component:"RecommendationApplier"}),u={maxAgeHours:parseInt(process.env.APPLIER_MAX_AGE_HOURS||"24",10),batchSize:parseInt(process.env.APPLIER_BATCH_SIZE||"50",10),applyChanges:"true"===process.env.APPLIER_APPLY_CHANGES,autoApplyPriorities:["critical","high"]};async function n(){let e=Date.now(),t=!u.applyChanges;l.info({maxAgeHours:u.maxAgeHours,batchSize:u.batchSize,dryRun:t,msg:"Starting recommendation applier"});let r=new Date(Date.now()-60*u.maxAgeHours*6e4),a=await (0,i.listRecommendations)({status:"PENDING",since:r,limit:u.batchSize});if(0===a.length)return l.info({msg:"No pending recommendations to process"}),{processed:0,applied:0,skipped:0,errors:0,dryRun:t,recommendations:[]};l.info({pendingCount:a.length,msg:"Found pending recommendations"}),function(e){let t={};for(let r of e){let e=r.facilitatorId||"_no_facilitator";t[e]||(t[e]=[]),t[e].push(r)}}(a);let o={processed:0,applied:0,skipped:0,errors:0,dryRun:t,recommendations:[]};for(let e of a){o.processed++;try{let r=await s(e,t);o.recommendations.push(r),"applied"===r.action||"would_apply"===r.action?o.applied++:"skipped"===r.action?o.skipped++:"error"===r.action&&o.errors++}catch(r){let t=r instanceof Error?r.message:"Unknown error";l.error({recommendationId:e.id,type:e.type,error:t,msg:"Failed to process recommendation"}),o.errors++,o.recommendations.push({id:e.id,type:e.type,facilitatorId:e.facilitatorId,priority:e.priority,action:"error",reason:t})}}let n=Date.now()-e;return l.info({processed:o.processed,applied:o.applied,skipped:o.skipped,errors:o.errors,dryRun:t,durationMs:n,msg:"Recommendation applier completed"}),o}async function s(e,t){let r={reason:e.details?.reason,metricsSnapshot:e.details?.metricsSnapshot,probeStats:e.details?.probeStats};if(!u.autoApplyPriorities.includes(e.priority))return l.info({recommendationId:e.id,type:e.type,facilitatorId:e.facilitatorId,priority:e.priority,msg:"Skipping recommendation (priority below auto-apply threshold)"}),{id:e.id,type:e.type,facilitatorId:e.facilitatorId,priority:e.priority,action:"skipped",reason:"Priority below auto-apply threshold"};switch(l.info({recommendationId:e.id,type:e.type,facilitatorId:e.facilitatorId,priority:e.priority,confidence:e.confidence,reasoning:e.reasoning,metadata:r,dryRun:t,msg:t?"Would apply recommendation (stub)":"Applying recommendation"}),e.type){case"FACILITATOR_DEPRIORITIZE":await d(e,t);break;case"FACILITATOR_ONBOARD":await p(e,t);break;case"FACILITATOR_PROMOTE":await c(e,t);break;default:return l.info({recommendationId:e.id,type:e.type,msg:"Unhandled recommendation type (no action)"}),{id:e.id,type:e.type,facilitatorId:e.facilitatorId,priority:e.priority,action:"skipped",reason:`Unhandled type: ${e.type}`}}return t||await (0,i.markRecommendationApplied)(e.id,"recommendation-applier",{appliedAt:new Date().toISOString(),appliedBy:"automated"}),{id:e.id,type:e.type,facilitatorId:e.facilitatorId,priority:e.priority,action:t?"would_apply":"applied"}}async function d(e,t){let r=e.details;l.info({recommendationId:e.id,facilitatorId:e.facilitatorId,reason:r?.reason,currentSuccessRate:r?.metricsSnapshot?.successRate,currentLatencyMs:r?.metricsSnapshot?.avgLatencyMs,currentStatus:r?.metricsSnapshot?.status,action:t?"would_deprioritize":"deprioritizing",msg:"Processing FACILITATOR_DEPRIORITIZE"})}async function p(e,t){let r=e.details;l.info({recommendationId:e.id,facilitatorId:e.facilitatorId,facilitatorName:r?.name,source:r?.source,externalScore:r?.externalScore,healthScore:r?.probeStats?.healthScore,action:t?"would_onboard":"onboarding",msg:"Processing FACILITATOR_ONBOARD"})}async function c(e,t){let r=e.details;l.info({recommendationId:e.id,facilitatorId:e.facilitatorId,currentScore:r?.metricsSnapshot?.score,currentSuccessRate:r?.metricsSnapshot?.successRate,currentLatencyMs:r?.metricsSnapshot?.avgLatencyMs,action:t?"would_promote":"promoting",msg:"Processing FACILITATOR_PROMOTE"})}e.s(["APPLIER_CONFIG",0,u,"applyPendingRecommendations",()=>n]),r()}catch(e){r(e)}},!1),90476,e=>e.a(async(t,r)=>{try{var a=e.i(50377),i=e.i(7484),o=e.i(27054),n=t([i,o]);[i,o]=n.then?(await n)():n;let d=(0,a.createLogger)({component:"RecommendationApplierCron"});async function s(e,t){let{runId:r,requestId:a}=t;d.info({runId:r,requestId:a,config:{maxAgeHours:o.APPLIER_CONFIG.maxAgeHours,batchSize:o.APPLIER_CONFIG.batchSize,applyChanges:o.APPLIER_CONFIG.applyChanges,autoApplyPriorities:o.APPLIER_CONFIG.autoApplyPriorities},msg:"Starting recommendation applier"});let i=await (0,o.applyPendingRecommendations)();return d.info({runId:r,requestId:a,processed:i.processed,applied:i.applied,skipped:i.skipped,errors:i.errors,dryRun:i.dryRun,msg:"Recommendation applier completed"}),{ok:0===i.errors,summary:{processed:i.processed,applied:i.applied,skipped:i.skipped,errors:i.errors,dryRun:i.dryRun},recommendations:i.recommendations.slice(0,20).map(e=>({id:e.id,type:e.type,facilitatorId:e.facilitatorId,priority:e.priority,action:e.action,reason:e.reason})),hasMore:i.recommendations.length>20}}let p=(0,i.withCronJobTracking)(s,{jobId:"recommendation-applier",timeout:55e3,minInterval:54e4}),c=(0,i.withCronJobTracking)(s,{jobId:"recommendation-applier",timeout:55e3,minInterval:54e4,skipRateLimit:!0});e.s(["GET",0,p,"POST",0,c,"dynamic",0,"force-dynamic","maxDuration",0,60]),r()}catch(e){r(e)}},!1),58705,e=>e.a(async(t,r)=>{try{var a=e.i(47909),i=e.i(74017),o=e.i(96250),n=e.i(59756),s=e.i(61916),d=e.i(14444),p=e.i(37092),c=e.i(69741),l=e.i(16795),u=e.i(87718),m=e.i(95169),y=e.i(47587),h=e.i(66012),R=e.i(70101),f=e.i(26937),g=e.i(10372),I=e.i(93695);e.i(52474);var A=e.i(220),w=e.i(90476),E=t([w]);[w]=E.then?(await E)():E;let v=new a.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/cron/recommendation-applier/route",pathname:"/api/cron/recommendation-applier",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/cron/recommendation-applier/route.ts",nextConfigOutput:"standalone",userland:w}),{workAsyncStorage:S,workUnitAsyncStorage:O,serverHooks:T}=v;function P(){return(0,o.patchFetch)({workAsyncStorage:S,workUnitAsyncStorage:O})}async function C(e,t,r){v.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/cron/recommendation-applier/route";a=a.replace(/\/index$/,"")||"/";let o=await v.prepare(e,t,{srcPage:a,multiZoneDraftMode:!1});if(!o)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:w,params:E,nextConfig:P,parsedUrl:C,isDraftMode:S,prerenderManifest:O,routerServerContext:T,isOnDemandRevalidate:_,revalidateOnlyGenerated:b,resolvedPathname:x,clientReferenceManifest:k,serverActionsManifest:N}=o,L=(0,c.normalizeAppPath)(a),H=!!(O.dynamicRoutes[L]||O.routes[x]),D=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,C,!1):t.end("This page could not be found"),null);if(H&&!S){let e=!!O.routes[x],t=O.dynamicRoutes[L];if(t&&!1===t.fallback&&!e){if(P.experimental.adapterPath)return await D();throw new I.NoFallbackError}}let M=null;!H||v.isDev||S||(M=x,M="/index"===M?"/":M);let F=!0===v.isDev||!H,U=H&&!F;N&&k&&(0,d.setReferenceManifestsSingleton)({page:a,clientReferenceManifest:k,serverActionsManifest:N,serverModuleMap:(0,p.createServerModuleMap)({serverActionsManifest:N})});let q=e.method||"GET",G=(0,s.getTracer)(),$=G.getActiveScopeSpan(),j={params:E,prerenderManifest:O,renderOpts:{experimental:{authInterrupts:!!P.experimental.authInterrupts},cacheComponents:!!P.cacheComponents,supportsDynamicResponse:F,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:P.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>v.onRequestError(e,t,a,T)},sharedContext:{buildId:w}},z=new l.NodeNextRequest(e),B=new l.NodeNextResponse(t),K=u.NextRequestAdapter.fromNodeNextRequest(z,(0,u.signalFromNodeResponse)(t));try{let o=async e=>v.handle(K,j).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=G.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=r.get("next.route");if(i){let t=`${q} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${a}`)}),d=!!(0,n.getRequestMeta)(e,"minimalMode"),p=async n=>{var s,p;let c=async({previousCacheEntry:i})=>{try{if(!d&&_&&b&&!i)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await o(n);e.fetchMetrics=j.renderOpts.fetchMetrics;let s=j.renderOpts.pendingWaitUntil;s&&r.waitUntil&&(r.waitUntil(s),s=void 0);let p=j.renderOpts.collectedTags;if(!H)return await (0,h.sendResponse)(z,B,a,j.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,R.toNodeOutgoingHttpHeaders)(a.headers);p&&(t[g.NEXT_CACHE_TAGS_HEADER]=p),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==j.renderOpts.collectedRevalidate&&!(j.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&j.renderOpts.collectedRevalidate,i=void 0===j.renderOpts.collectedExpire||j.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:j.renderOpts.collectedExpire;return{value:{kind:A.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:i}}}}catch(t){throw(null==i?void 0:i.isStale)&&await v.onRequestError(e,t,{routerKind:"App Router",routePath:a,routeType:"route",revalidateReason:(0,y.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:_})},T),t}},l=await v.handleResponse({req:e,nextConfig:P,cacheKey:M,routeKind:i.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:O,isRoutePPREnabled:!1,isOnDemandRevalidate:_,revalidateOnlyGenerated:b,responseGenerator:c,waitUntil:r.waitUntil,isMinimalMode:d});if(!H)return null;if((null==l||null==(s=l.value)?void 0:s.kind)!==A.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(p=l.value)?void 0:p.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});d||t.setHeader("x-nextjs-cache",_?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),S&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,R.fromNodeOutgoingHttpHeaders)(l.value.headers);return d&&H||u.delete(g.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,f.getCacheControlHeader)(l.cacheControl)),await (0,h.sendResponse)(z,B,new Response(l.value.body,{headers:u,status:l.value.status||200})),null};$?await p($):await G.withPropagatedContext(e.headers,()=>G.trace(m.BaseServerSpan.handleRequest,{spanName:`${q} ${a}`,kind:s.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},p))}catch(t){if(t instanceof I.NoFallbackError||await v.onRequestError(e,t,{routerKind:"App Router",routePath:L,routeType:"route",revalidateReason:(0,y.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:_})}),H)throw t;return await (0,h.sendResponse)(z,B,new Response(null,{status:500})),null}}e.s(["handler",()=>C,"patchFetch",()=>P,"routeModule",()=>v,"serverHooks",()=>T,"workAsyncStorage",()=>S,"workUnitAsyncStorage",()=>O]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=_deeb5f3b._.js.map
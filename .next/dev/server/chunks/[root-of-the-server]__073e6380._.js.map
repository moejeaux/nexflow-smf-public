{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/meaux/CascadeProjects/my%20second%20project/CascadeProjects/windsurf-project/nexflow-deploy/src/lib/sentry.ts"],"sourcesContent":["// src/lib/sentry.ts\r\n\r\n// Temporary no-op Sentry shim to avoid module errors during dev\r\nconst Sentry = null as any;\r\n\r\nexport const sentry = {\r\n  captureException: (..._args: any[]) => {},\r\n  captureMessage: (..._args: any[]) => {},\r\n  withScope: (fn: (scope: any) => void) => fn({}),\r\n};\r\n\r\n// No-op functions for compatibility\r\nexport function initSentry() {}\r\nexport function setSentryUser(_userId?: string, _apiKeyId?: string) {}\r\nexport function setSentryContext(_context: any) {}\r\nexport function captureException(_error: Error, _context?: any) {}\r\nexport function captureMessage(_message: string, _level: any = 'info', _context?: any) {}\r\n"],"names":[],"mappings":"AAAA,oBAAoB;AAEpB,gEAAgE;;;;;;;;;;;;;;;AAChE,MAAM,SAAS;AAER,MAAM,SAAS;IACpB,kBAAkB,CAAC,GAAG,SAAkB;IACxC,gBAAgB,CAAC,GAAG,SAAkB;IACtC,WAAW,CAAC,KAA6B,GAAG,CAAC;AAC/C;AAGO,SAAS,cAAc;AACvB,SAAS,cAAc,OAAgB,EAAE,SAAkB,GAAG;AAC9D,SAAS,iBAAiB,QAAa,GAAG;AAC1C,SAAS,iBAAiB,MAAa,EAAE,QAAc,GAAG;AAC1D,SAAS,eAAe,QAAgB,EAAE,SAAc,MAAM,EAAE,QAAc,GAAG"}},
    {"offset": {"line": 113, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/meaux/CascadeProjects/my%20second%20project/CascadeProjects/windsurf-project/nexflow-deploy/src/lib/logger.ts"],"sourcesContent":["// =============================================================================\r\n// Structured Logging\r\n// =============================================================================\r\n// Uses Pino for fast, structured logging\r\n// Supports request ID tracking and different log levels\r\n// All logs include standard fields: timestamp, level, message, requestId, etc.\r\n\r\nimport pino from 'pino';\r\n\r\n// Determine log level from environment\r\nconst logLevel = process.env.LOG_LEVEL || (process.env.NODE_ENV === 'production' ? 'info' : 'debug');\r\n\r\n// Create logger instance with structured output\r\n// In Next.js dev mode, disable pino-pretty transport to avoid worker thread issues\r\n// Use simple JSON output instead (can be prettified by other tools)\r\nconst isNextDev = process.env.NODE_ENV === 'development' && process.env.NEXT_RUNTIME;\r\nconst usePrettyTransport = process.env.NODE_ENV !== 'production' && !isNextDev;\r\n\r\nconst logger = pino({\r\n  level: logLevel,\r\n  transport: usePrettyTransport ? {\r\n    target: 'pino-pretty',\r\n    options: {\r\n      colorize: true,\r\n      translateTime: 'SYS:standard',\r\n      ignore: 'pid,hostname',\r\n    },\r\n  } : undefined,\r\n  formatters: {\r\n    level: (label) => {\r\n      return { level: label.toUpperCase() };\r\n    },\r\n  },\r\n  base: {\r\n    env: process.env.NODE_ENV || 'development',\r\n    service: 'nexflow-api',\r\n  },\r\n  // Ensure timestamps are included\r\n  timestamp: pino.stdTimeFunctions.isoTime,\r\n});\r\n\r\nexport type LogLevel = 'trace' | 'debug' | 'info' | 'warn' | 'error' | 'fatal';\r\n\r\n/**\r\n * Standard log context fields\r\n */\r\nexport interface LogContext {\r\n  // Request tracking\r\n  requestId?: string;\r\n  apiKeyId?: string;\r\n  endpoint?: string;\r\n  method?: string;\r\n  statusCode?: number;\r\n  durationMs?: number;\r\n  ip?: string;\r\n  \r\n  // Error context\r\n  errorCode?: string;\r\n  error?: Error | any;\r\n  stack?: string;\r\n  \r\n  // CDP/x402 context\r\n  cdpStatus?: string;\r\n  cdpErrorId?: string;\r\n  paymentIntentId?: string;\r\n  x402HeaderId?: string;\r\n  \r\n  // Rate limiting\r\n  rateLimitKey?: string;\r\n  rateLimitRemaining?: number;\r\n  \r\n  // Additional context\r\n  [key: string]: any;\r\n}\r\n\r\n/**\r\n * Create a child logger with additional context\r\n * Useful for request-scoped logging with request IDs\r\n */\r\nexport function createLogger(context?: LogContext | Record<string, any>) {\r\n  return context ? logger.child(context) : logger;\r\n}\r\n\r\n/**\r\n * Get the default logger instance\r\n */\r\nexport function getLogger() {\r\n  return logger;\r\n}\r\n\r\n/**\r\n * Sanitize sensitive data from log context\r\n * Removes API keys, tokens, payment headers, and PII\r\n */\r\nfunction sanitizeContext(context: LogContext): LogContext {\r\n  const sanitized = { ...context };\r\n  \r\n  // Remove sensitive fields\r\n  const sensitiveKeys = [\r\n    'apiKey', 'token', 'authorization', 'x-payment', 'paymentHeader',\r\n    'cardNumber', 'cvv', 'ssn', 'password', 'secret',\r\n  ];\r\n  \r\n  sensitiveKeys.forEach(key => {\r\n    if (key in sanitized) {\r\n      delete sanitized[key];\r\n    }\r\n  });\r\n  \r\n  // Truncate long strings that might contain sensitive data\r\n  Object.keys(sanitized).forEach(key => {\r\n    const value = sanitized[key];\r\n    if (typeof value === 'string' && value.length > 200) {\r\n      sanitized[key] = value.substring(0, 200) + '... [truncated]';\r\n    }\r\n  });\r\n  \r\n  return sanitized;\r\n}\r\n\r\n/**\r\n * Log levels with structured context\r\n */\r\nexport const log = {\r\n  trace: (msg: string, context?: LogContext, ...args: any[]) => {\r\n    logger.trace(sanitizeContext(context || {}), msg, ...args);\r\n  },\r\n  debug: (msg: string, context?: LogContext, ...args: any[]) => {\r\n    logger.debug(sanitizeContext(context || {}), msg, ...args);\r\n  },\r\n  info: (msg: string, context?: LogContext, ...args: any[]) => {\r\n    logger.info(sanitizeContext(context || {}), msg, ...args);\r\n  },\r\n  warn: (msg: string, context?: LogContext, ...args: any[]) => {\r\n    logger.warn(sanitizeContext(context || {}), msg, ...args);\r\n  },\r\n  error: (msg: string, context?: LogContext | Error, ...args: any[]) => {\r\n    let logContext: LogContext = {};\r\n    let errorObj: Error | undefined;\r\n    \r\n    if (context instanceof Error) {\r\n      errorObj = context;\r\n      logContext = {\r\n        error: context,\r\n        errorCode: (context as any).code || 'UNKNOWN_ERROR',\r\n        stack: context.stack,\r\n      };\r\n    } else if (context && typeof context === 'object') {\r\n      logContext = context as LogContext;\r\n      if (logContext.error instanceof Error) {\r\n        errorObj = logContext.error;\r\n        logContext.stack = logContext.error.stack;\r\n      }\r\n    }\r\n    \r\n    const sanitizedContext = sanitizeContext(logContext);\r\n    logger.error(sanitizedContext, msg, ...args);\r\n    \r\n    // Automatically capture to Sentry if error object exists\r\n    if (errorObj) {\r\n      try {\r\n        const { captureException } = require('./sentry');\r\n        captureException(errorObj, {\r\n          requestId: logContext.requestId,\r\n          apiKeyId: logContext.apiKeyId,\r\n          endpoint: logContext.endpoint,\r\n          endpointId: (logContext as any).endpointId,\r\n          method: logContext.method,\r\n          statusCode: logContext.statusCode,\r\n          ip: logContext.ip,\r\n          userAgent: (logContext as any).userAgent,\r\n          tags: {\r\n            errorCode: logContext.errorCode || 'UNKNOWN_ERROR',\r\n            component: (logContext as any).component || 'unknown',\r\n          },\r\n          extra: {\r\n            ...sanitizedContext,\r\n          },\r\n        });\r\n      } catch (sentryError) {\r\n        // Silently fail if Sentry not available\r\n      }\r\n    }\r\n  },\r\n  fatal: (msg: string, context?: LogContext | Error, ...args: any[]) => {\r\n    let logContext: LogContext = {};\r\n    let errorObj: Error | undefined;\r\n    \r\n    if (context instanceof Error) {\r\n      errorObj = context;\r\n      logContext = {\r\n        error: context,\r\n        errorCode: (context as any).code || 'UNKNOWN_ERROR',\r\n        stack: context.stack,\r\n      };\r\n    } else if (context && typeof context === 'object') {\r\n      logContext = context as LogContext;\r\n      if (logContext.error instanceof Error) {\r\n        errorObj = logContext.error;\r\n        logContext.stack = logContext.error.stack;\r\n      }\r\n    }\r\n    \r\n    const sanitizedContext = sanitizeContext(logContext);\r\n    logger.fatal(sanitizedContext, msg, ...args);\r\n    \r\n    // Automatically capture to Sentry for fatal errors\r\n    if (errorObj) {\r\n      try {\r\n        const { captureException } = require('./sentry');\r\n        captureException(errorObj, {\r\n          requestId: logContext.requestId,\r\n          apiKeyId: logContext.apiKeyId,\r\n          endpoint: logContext.endpoint,\r\n          endpointId: (logContext as any).endpointId,\r\n          method: logContext.method,\r\n          statusCode: logContext.statusCode,\r\n          ip: logContext.ip,\r\n          userAgent: (logContext as any).userAgent,\r\n          tags: {\r\n            errorCode: logContext.errorCode || 'FATAL_ERROR',\r\n            component: (logContext as any).component || 'unknown',\r\n            severity: 'fatal',\r\n          },\r\n          extra: {\r\n            ...sanitizedContext,\r\n          },\r\n        });\r\n      } catch (sentryError) {\r\n        // Silently fail if Sentry not available\r\n      }\r\n    }\r\n  },\r\n};\r\n\r\nexport default logger;\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 305, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/meaux/CascadeProjects/my%20second%20project/CascadeProjects/windsurf-project/nexflow-deploy/src/lib/startup/validate-env.ts"],"sourcesContent":["// =============================================================================\r\n// STARTUP ENVIRONMENT VALIDATION\r\n// =============================================================================\r\n// Validates critical environment variables at application startup.\r\n// Fails fast in production if configuration is invalid or dangerous.\r\n//\r\n// This module prevents:\r\n// - Missing critical configuration\r\n// - Localhost fallbacks in production\r\n// - Test/dummy facilitators in production\r\n// - Unconfigured settlement in production\r\n\r\nimport { createLogger } from '@/lib/logger';\r\n\r\nconst logger = createLogger({ component: 'StartupValidation' });\r\n\r\n// =============================================================================\r\n// TYPES\r\n// =============================================================================\r\n\r\ninterface ValidationError {\r\n  variable: string;\r\n  message: string;\r\n  severity: 'error' | 'warning';\r\n}\r\n\r\ninterface ValidationResult {\r\n  valid: boolean;\r\n  errors: ValidationError[];\r\n  warnings: ValidationError[];\r\n}\r\n\r\n// =============================================================================\r\n// REQUIRED ENVIRONMENT VARIABLES\r\n// =============================================================================\r\n\r\n/**\r\n * Environment variables that MUST be set in production.\r\n */\r\nconst REQUIRED_IN_PRODUCTION = [\r\n  { name: 'DATABASE_URL', description: 'PostgreSQL connection string' },\r\n  { name: 'NEXT_PUBLIC_APP_URL', description: 'Public application URL' },\r\n  { name: 'CRON_SECRET', description: 'Secret for cron job authentication' },\r\n];\r\n\r\n/**\r\n * Environment variables that SHOULD be set for full functionality.\r\n */\r\nconst RECOMMENDED_IN_PRODUCTION = [\r\n  { name: 'GOVERNANCE_ADMIN_API_KEY', description: 'Admin API key for governance' },\r\n  { name: 'UPSTASH_REDIS_REST_URL', description: 'Redis URL for caching' },\r\n  { name: 'UPSTASH_REDIS_REST_TOKEN', description: 'Redis authentication token' },\r\n];\r\n\r\n/**\r\n * Settlement-related variables required for on-chain operations.\r\n */\r\nconst SETTLEMENT_VARS = [\r\n  { name: 'ATOMIC_BATCH_SETTLEMENT_ADDRESS', description: 'Settlement contract address' },\r\n  { name: 'NEXFLOW_TREASURY_ADDRESS', description: 'Treasury wallet address (fee recipient)' },\r\n  { name: 'ADMIN_MULTISIG_ADDRESS', description: 'Admin multisig for on-chain governance' },\r\n  { name: 'NEXFLOW_HOUSE_FACILITATOR_ADDRESS', description: 'NexFlow house facilitator wallet' },\r\n];\r\n\r\n// =============================================================================\r\n// VALIDATION FUNCTIONS\r\n// =============================================================================\r\n\r\n/**\r\n * Validate that a URL is not localhost.\r\n */\r\nfunction isLocalhostUrl(url: string): boolean {\r\n  const lower = url.toLowerCase();\r\n  return (\r\n    lower.includes('localhost') ||\r\n    lower.includes('127.0.0.1') ||\r\n    lower.includes('0.0.0.0')\r\n  );\r\n}\r\n\r\n/**\r\n * Validate that an address is not the zero address.\r\n */\r\nfunction isZeroAddress(address: string): boolean {\r\n  return (\r\n    !address ||\r\n    address === '0x0000000000000000000000000000000000000000' ||\r\n    address === '0x0'\r\n  );\r\n}\r\n\r\n/**\r\n * Validate environment for production deployment.\r\n * Throws an error if critical issues are found.\r\n */\r\nexport function validateEnvForProduction(): ValidationResult {\r\n  const errors: ValidationError[] = [];\r\n  const warnings: ValidationError[] = [];\r\n  const isProduction = process.env.NODE_ENV === 'production';\r\n  const isCI = process.env.CI === 'true';\r\n\r\n  if (!isProduction) {\r\n    logger.debug('Skipping production validation (NODE_ENV !== production)');\r\n    return { valid: true, errors: [], warnings: [] };\r\n  }\r\n\r\n  // Skip validation in CI environments (GitHub Actions, etc.)\r\n  // CI sets NODE_ENV=production but doesn't have all production secrets\r\n  if (isCI) {\r\n    logger.info('Skipping production validation (CI environment detected)');\r\n    return { valid: true, errors: [], warnings: [] };\r\n  }\r\n\r\n  logger.info('Running production environment validation...');\r\n\r\n  // Check required variables\r\n  for (const { name, description } of REQUIRED_IN_PRODUCTION) {\r\n    const value = process.env[name];\r\n    if (!value || value.trim() === '') {\r\n      errors.push({\r\n        variable: name,\r\n        message: `Required variable ${name} is not set. Purpose: ${description}`,\r\n        severity: 'error',\r\n      });\r\n    }\r\n  }\r\n\r\n  // Check NEXT_PUBLIC_APP_URL is not localhost\r\n  const appUrl = process.env.NEXT_PUBLIC_APP_URL;\r\n  if (appUrl && isLocalhostUrl(appUrl)) {\r\n    errors.push({\r\n      variable: 'NEXT_PUBLIC_APP_URL',\r\n      message: 'NEXT_PUBLIC_APP_URL contains localhost, which is invalid in production',\r\n      severity: 'error',\r\n    });\r\n  }\r\n\r\n  // Check DATABASE_URL is not localhost (unless explicitly allowed for testing)\r\n  const dbUrl = process.env.DATABASE_URL;\r\n  if (dbUrl && isLocalhostUrl(dbUrl) && process.env.ALLOW_LOCAL_DB !== 'true') {\r\n    errors.push({\r\n      variable: 'DATABASE_URL',\r\n      message: 'DATABASE_URL contains localhost, which is invalid in production',\r\n      severity: 'error',\r\n    });\r\n  }\r\n\r\n  // Check dummy facilitator is not enabled\r\n  if (process.env.ENABLE_DUMMY_FACILITATOR === 'true') {\r\n    errors.push({\r\n      variable: 'ENABLE_DUMMY_FACILITATOR',\r\n      message: 'ENABLE_DUMMY_FACILITATOR=true is not allowed in production',\r\n      severity: 'error',\r\n    });\r\n  }\r\n\r\n  // Check mock settlement is not enabled\r\n  if (process.env.ALLOW_MOCK_SETTLEMENT === 'true') {\r\n    warnings.push({\r\n      variable: 'ALLOW_MOCK_SETTLEMENT',\r\n      message: 'ALLOW_MOCK_SETTLEMENT=true allows mock tx hashes. Disable for real money.',\r\n      severity: 'warning',\r\n    });\r\n  }\r\n\r\n  // Check recommended variables\r\n  for (const { name, description } of RECOMMENDED_IN_PRODUCTION) {\r\n    const value = process.env[name];\r\n    if (!value || value.trim() === '') {\r\n      warnings.push({\r\n        variable: name,\r\n        message: `Recommended variable ${name} is not set. Purpose: ${description}`,\r\n        severity: 'warning',\r\n      });\r\n    }\r\n  }\r\n\r\n  // Check settlement configuration\r\n  const settlementEnabled = process.env.SETTLEMENT_EXECUTOR_ENABLED === 'true';\r\n  if (settlementEnabled) {\r\n    for (const { name, description } of SETTLEMENT_VARS) {\r\n      const value = process.env[name];\r\n      if (!value || value.trim() === '') {\r\n        errors.push({\r\n          variable: name,\r\n          message: `Settlement is enabled but ${name} is not set. Purpose: ${description}`,\r\n          severity: 'error',\r\n        });\r\n      } else if (name.includes('ADDRESS') && isZeroAddress(value)) {\r\n        errors.push({\r\n          variable: name,\r\n          message: `${name} is set to the zero address, which is invalid`,\r\n          severity: 'error',\r\n        });\r\n      }\r\n    }\r\n  } else {\r\n    logger.warn(\r\n      'SETTLEMENT_EXECUTOR_ENABLED is not true. On-chain settlement requests will return 503.'\r\n    );\r\n  }\r\n\r\n  // Log results\r\n  if (errors.length > 0) {\r\n    logger.error({ errors }, 'Production environment validation FAILED');\r\n  }\r\n  if (warnings.length > 0) {\r\n    logger.warn({ warnings }, 'Production environment validation warnings');\r\n  }\r\n  if (errors.length === 0 && warnings.length === 0) {\r\n    logger.info('Production environment validation PASSED');\r\n  }\r\n\r\n  return {\r\n    valid: errors.length === 0,\r\n    errors,\r\n    warnings,\r\n  };\r\n}\r\n\r\n/**\r\n * Run validation and throw if critical errors found.\r\n * Call this at application startup.\r\n */\r\nexport function validateEnvOrThrow(): void {\r\n  const result = validateEnvForProduction();\r\n\r\n  if (!result.valid) {\r\n    const errorMessages = result.errors.map((e) => `  - ${e.variable}: ${e.message}`).join('\\n');\r\n    throw new Error(\r\n      `Production environment validation failed:\\n${errorMessages}\\n\\nFix these issues before deploying to production.`\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * Get the base URL for internal API calls.\r\n * In production, requires NEXT_PUBLIC_APP_URL to be set.\r\n * In development, falls back to localhost.\r\n */\r\nexport function getBaseUrl(): string {\r\n  const isProduction = process.env.NODE_ENV === 'production';\r\n  const appUrl = process.env.NEXT_PUBLIC_APP_URL;\r\n\r\n  if (isProduction) {\r\n    if (!appUrl) {\r\n      throw new Error('NEXT_PUBLIC_APP_URL must be set in production');\r\n    }\r\n    return appUrl;\r\n  }\r\n\r\n  // Development fallback\r\n  return appUrl || 'http://localhost:3000';\r\n}\r\n\r\n// =============================================================================\r\n// SINGLETON VALIDATION STATE\r\n// =============================================================================\r\n\r\nlet hasValidated = false;\r\n\r\n/**\r\n * Run validation once at startup.\r\n * Safe to call multiple times; only runs once.\r\n */\r\nexport function runStartupValidation(): void {\r\n  if (hasValidated) return;\r\n  hasValidated = true;\r\n\r\n  try {\r\n    validateEnvOrThrow();\r\n  } catch (error) {\r\n    // In production, this should crash the app\r\n    if (process.env.NODE_ENV === 'production') {\r\n      console.error('[FATAL] Startup validation failed:', error);\r\n      process.exit(1);\r\n    } else {\r\n      // In development, just log the warning\r\n      console.warn('[WARN] Startup validation issues (non-fatal in development):', error);\r\n    }\r\n  }\r\n}\r\n\r\n\r\n"],"names":[],"mappings":"AAAA,gFAAgF;AAChF,iCAAiC;AACjC,gFAAgF;AAChF,mEAAmE;AACnE,qEAAqE;AACrE,EAAE;AACF,wBAAwB;AACxB,mCAAmC;AACnC,sCAAsC;AACtC,0CAA0C;AAC1C,0CAA0C;;;;;;;;;;;AAE1C;;AAEA,MAAM,SAAS,IAAA,yIAAY,EAAC;IAAE,WAAW;AAAoB;AAkB7D,gFAAgF;AAChF,iCAAiC;AACjC,gFAAgF;AAEhF;;CAEC,GACD,MAAM,yBAAyB;IAC7B;QAAE,MAAM;QAAgB,aAAa;IAA+B;IACpE;QAAE,MAAM;QAAuB,aAAa;IAAyB;IACrE;QAAE,MAAM;QAAe,aAAa;IAAqC;CAC1E;AAED;;CAEC,GACD,MAAM,4BAA4B;IAChC;QAAE,MAAM;QAA4B,aAAa;IAA+B;IAChF;QAAE,MAAM;QAA0B,aAAa;IAAwB;IACvE;QAAE,MAAM;QAA4B,aAAa;IAA6B;CAC/E;AAED;;CAEC,GACD,MAAM,kBAAkB;IACtB;QAAE,MAAM;QAAmC,aAAa;IAA8B;IACtF;QAAE,MAAM;QAA4B,aAAa;IAA0C;IAC3F;QAAE,MAAM;QAA0B,aAAa;IAAyC;IACxF;QAAE,MAAM;QAAqC,aAAa;IAAmC;CAC9F;AAED,gFAAgF;AAChF,uBAAuB;AACvB,gFAAgF;AAEhF;;CAEC,GACD,SAAS,eAAe,GAAW;IACjC,MAAM,QAAQ,IAAI,WAAW;IAC7B,OACE,MAAM,QAAQ,CAAC,gBACf,MAAM,QAAQ,CAAC,gBACf,MAAM,QAAQ,CAAC;AAEnB;AAEA;;CAEC,GACD,SAAS,cAAc,OAAe;IACpC,OACE,CAAC,WACD,YAAY,gDACZ,YAAY;AAEhB;AAMO,SAAS;IACd,MAAM,SAA4B,EAAE;IACpC,MAAM,WAA8B,EAAE;IACtC,MAAM,eAAe,oDAAyB;IAC9C,MAAM,OAAO,QAAQ,GAAG,CAAC,EAAE,KAAK;IAEhC,wCAAmB;QACjB,OAAO,KAAK,CAAC;QACb,OAAO;YAAE,OAAO;YAAM,QAAQ,EAAE;YAAE,UAAU,EAAE;QAAC;IACjD;;;IAYK,MAAQ,kBAAM;IAWnB,6CAA6C;IAC7C,MAAM;IASN,8EAA8E;IAC9E,MAAM;IA4BD,MAAQ,mBAAM;IAWnB,iCAAiC;IACjC,MAAM;AAwCR;AAMO,SAAS;IACd,MAAM,SAAS;IAEf,IAAI,CAAC,OAAO,KAAK,EAAE;QACjB,MAAM,gBAAgB,OAAO,MAAM,CAAC,GAAG,CAAC,CAAC,IAAM,CAAC,IAAI,EAAE,EAAE,QAAQ,CAAC,EAAE,EAAE,EAAE,OAAO,EAAE,EAAE,IAAI,CAAC;QACvF,MAAM,IAAI,MACR,CAAC,2CAA2C,EAAE,cAAc,oDAAoD,CAAC;IAErH;AACF;AAOO,SAAS;IACd,MAAM,eAAe,oDAAyB;IAC9C,MAAM;IAEN;;IAOA,uBAAuB;IACvB,OAAO,UAAU;AACnB;AAEA,gFAAgF;AAChF,6BAA6B;AAC7B,gFAAgF;AAEhF,IAAI,eAAe;AAMZ,SAAS;IACd,IAAI,cAAc;IAClB,eAAe;IAEf,IAAI;QACF;IACF,EAAE,OAAO,OAAO;QACd,2CAA2C;QAC3C;;aAGO;YACL,uCAAuC;YACvC,QAAQ,IAAI,CAAC,gEAAgE;QAC/E;IACF;AACF"}}]
}
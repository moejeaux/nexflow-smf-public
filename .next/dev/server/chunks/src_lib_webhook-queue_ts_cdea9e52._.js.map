{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/meaux/CascadeProjects/my%20second%20project/CascadeProjects/windsurf-project/nexflow-deploy/src/lib/webhook-queue.ts"],"sourcesContent":["// =============================================================================\r\n// WEBHOOK DELIVERY QUEUE\r\n// =============================================================================\r\n// BullMQ queue for webhook delivery with retry logic\r\n// Note: bullmq may not be installed - this module handles missing dependencies gracefully\r\n\r\nimport { createLogger } from './logger';\r\n\r\nconst logger = createLogger({ component: 'WebhookQueue' });\r\n\r\n// Lazy load bullmq to handle missing dependencies\r\nlet Queue: any;\r\nlet QueueOptions: any;\r\nlet webhookQueueInstance: any = null;\r\n\r\nasync function loadBullMQ() {\r\n  if (!Queue) {\r\n    try {\r\n      // Use dynamic import with webpack ignore comment to prevent build-time resolution\r\n      // @ts-ignore - bullmq may not be installed\r\n      const bullmq = await import(/* webpackIgnore: true */ 'bullmq').catch(() => {\r\n        // Fallback: return null if module doesn't exist\r\n        return null;\r\n      });\r\n      \r\n      if (!bullmq) {\r\n        throw new Error('bullmq package not installed');\r\n      }\r\n      \r\n      Queue = bullmq.Queue;\r\n      QueueOptions = bullmq.QueueOptions;\r\n    } catch (error) {\r\n      logger.warn({ error }, 'bullmq not available - webhook queue features will be disabled');\r\n      throw new Error('bullmq package not installed');\r\n    }\r\n  }\r\n  return { Queue, QueueOptions };\r\n}\r\n\r\nasync function getWebhookQueue() {\r\n  if (!webhookQueueInstance) {\r\n    try {\r\n      const { Queue: QueueClass, QueueOptions: QueueOptionsType } = await loadBullMQ();\r\n      \r\n      // Redis connection configuration\r\n      const redisConnection = {\r\n        host: process.env.REDIS_HOST || 'localhost',\r\n        port: parseInt(process.env.REDIS_PORT || '6379'),\r\n        password: process.env.REDIS_PASSWORD,\r\n        // Use REDIS_URL if provided (for cloud Redis like Upstash)\r\n        ...(process.env.REDIS_URL ? { url: process.env.REDIS_URL } : {}),\r\n      };\r\n\r\n      // Queue options\r\n      const queueOptions: any = {\r\n        connection: redisConnection,\r\n        defaultJobOptions: {\r\n          attempts: 3,\r\n          backoff: {\r\n            type: 'exponential',\r\n            delay: 2000, // Start with 2 seconds\r\n          },\r\n          removeOnComplete: {\r\n            age: 24 * 3600, // Keep completed jobs for 24 hours\r\n            count: 1000, // Keep last 1000 completed jobs\r\n          },\r\n          removeOnFail: {\r\n            age: 7 * 24 * 3600, // Keep failed jobs for 7 days\r\n          },\r\n        },\r\n      };\r\n\r\n      // Create webhook delivery queue\r\n      webhookQueueInstance = new QueueClass('webhook-delivery', queueOptions);\r\n    } catch (error) {\r\n      logger.warn({ error }, 'Failed to initialize webhook queue');\r\n      return null;\r\n    }\r\n  }\r\n  return webhookQueueInstance;\r\n}\r\n\r\n// Export a getter instead of direct instance\r\nexport const webhookQueue = {\r\n  get instance() {\r\n    // This will only work in runtime, not during build\r\n    // Use getWebhookQueue() instead for async access\r\n    return webhookQueueInstance;\r\n  }\r\n};\r\n\r\nexport interface WebhookJobData {\r\n  webhookConfigId: string;\r\n  eventId: string;\r\n  eventType: string;\r\n  url: string;\r\n  payload: string;\r\n  signature: string;\r\n  attempt?: number;\r\n}\r\n\r\n/**\r\n * Add webhook delivery job to queue\r\n */\r\nexport async function enqueueWebhookDelivery(data: WebhookJobData): Promise<string> {\r\n  try {\r\n    const queue = await getWebhookQueue();\r\n    if (!queue) {\r\n      throw new Error('Webhook queue not available (bullmq not installed or Redis not configured)');\r\n    }\r\n    \r\n    const job = await queue.add('deliver', data, {\r\n      jobId: `webhook_${data.webhookConfigId}_${data.eventId}_${Date.now()}`,\r\n    });\r\n    \r\n    logger.info('Webhook delivery job enqueued', {\r\n      jobId: job.id,\r\n      webhookConfigId: data.webhookConfigId,\r\n      eventId: data.eventId,\r\n      url: data.url,\r\n    });\r\n    \r\n    return job.id!;\r\n  } catch (error) {\r\n    logger.error('Failed to enqueue webhook delivery', {\r\n      webhookConfigId: data.webhookConfigId,\r\n      eventId: data.eventId,\r\n      error,\r\n    });\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Get queue statistics\r\n */\r\nexport async function getQueueStats() {\r\n  const queue = await getWebhookQueue();\r\n  if (!queue) {\r\n    return {\r\n      waiting: 0,\r\n      active: 0,\r\n      completed: 0,\r\n      failed: 0,\r\n      delayed: 0,\r\n      total: 0,\r\n      available: false,\r\n    };\r\n  }\r\n\r\n  const [waiting, active, completed, failed, delayed] = await Promise.all([\r\n    queue.getWaitingCount(),\r\n    queue.getActiveCount(),\r\n    queue.getCompletedCount(),\r\n    queue.getFailedCount(),\r\n    queue.getDelayedCount(),\r\n  ]);\r\n\r\n  return {\r\n    waiting,\r\n    active,\r\n    completed,\r\n    failed,\r\n    delayed,\r\n    total: waiting + active + completed + failed + delayed,\r\n    available: true,\r\n  };\r\n}\r\n\r\n/**\r\n * Clean up old jobs\r\n */\r\nexport async function cleanupQueue(): Promise<void> {\r\n  try {\r\n    const queue = await getWebhookQueue();\r\n    if (!queue) {\r\n      logger.warn('Cannot cleanup queue - webhook queue not available');\r\n      return;\r\n    }\r\n    \r\n    // Clean up old completed jobs (beyond retention period)\r\n    await queue.clean(24 * 3600 * 1000, 1000, 'completed');\r\n    // Clean up old failed jobs (beyond retention period)\r\n    await queue.clean(7 * 24 * 3600 * 1000, 1000, 'failed');\r\n    logger.info('Queue cleanup completed');\r\n  } catch (error) {\r\n    logger.error('Failed to cleanup queue', { error });\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n"],"names":[],"mappings":"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"}}]
}
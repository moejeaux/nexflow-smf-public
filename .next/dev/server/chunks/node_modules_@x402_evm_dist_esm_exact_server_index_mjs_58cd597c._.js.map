{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/meaux/CascadeProjects/my%20second%20project/CascadeProjects/windsurf-project/nexflow-deploy/node_modules/%40x402/evm/src/exact/server/scheme.ts","file:///C:/Users/meaux/CascadeProjects/my%20second%20project/CascadeProjects/windsurf-project/nexflow-deploy/node_modules/%40x402/evm/src/exact/server/register.ts"],"sourcesContent":["import {\n  AssetAmount,\n  Network,\n  PaymentRequirements,\n  Price,\n  SchemeNetworkServer,\n  MoneyParser,\n} from \"@x402/core/types\";\n\n/**\n * EVM server implementation for the Exact payment scheme.\n */\nexport class ExactEvmScheme implements SchemeNetworkServer {\n  readonly scheme = \"exact\";\n  private moneyParsers: MoneyParser[] = [];\n\n  /**\n   * Register a custom money parser in the parser chain.\n   * Multiple parsers can be registered - they will be tried in registration order.\n   * Each parser receives a decimal amount (e.g., 1.50 for $1.50).\n   * If a parser returns null, the next parser in the chain will be tried.\n   * The default parser is always the final fallback.\n   *\n   * @param parser - Custom function to convert amount to AssetAmount (or null to skip)\n   * @returns The server instance for chaining\n   *\n   * @example\n   * evmServer.registerMoneyParser(async (amount, network) => {\n   *   // Custom conversion logic\n   *   if (amount > 100) {\n   *     // Use different token for large amounts\n   *     return { amount: (amount * 1e18).toString(), asset: \"0xCustomToken\" };\n   *   }\n   *   return null; // Use next parser\n   * });\n   */\n  registerMoneyParser(parser: MoneyParser): ExactEvmScheme {\n    this.moneyParsers.push(parser);\n    return this;\n  }\n\n  /**\n   * Parses a price into an asset amount.\n   * If price is already an AssetAmount, returns it directly.\n   * If price is Money (string | number), parses to decimal and tries custom parsers.\n   * Falls back to default conversion if all custom parsers return null.\n   *\n   * @param price - The price to parse\n   * @param network - The network to use\n   * @returns Promise that resolves to the parsed asset amount\n   */\n  async parsePrice(price: Price, network: Network): Promise<AssetAmount> {\n    // If already an AssetAmount, return it directly\n    if (typeof price === \"object\" && price !== null && \"amount\" in price) {\n      if (!price.asset) {\n        throw new Error(`Asset address must be specified for AssetAmount on network ${network}`);\n      }\n      return {\n        amount: price.amount,\n        asset: price.asset,\n        extra: price.extra || {},\n      };\n    }\n\n    // Parse Money to decimal number\n    const amount = this.parseMoneyToDecimal(price);\n\n    // Try each custom money parser in order\n    for (const parser of this.moneyParsers) {\n      const result = await parser(amount, network);\n      if (result !== null) {\n        return result;\n      }\n    }\n\n    // All custom parsers returned null, use default conversion\n    return this.defaultMoneyConversion(amount, network);\n  }\n\n  /**\n   * Build payment requirements for this scheme/network combination\n   *\n   * @param paymentRequirements - The base payment requirements\n   * @param supportedKind - The supported kind from facilitator (unused)\n   * @param supportedKind.x402Version - The x402 version\n   * @param supportedKind.scheme - The logical payment scheme\n   * @param supportedKind.network - The network identifier in CAIP-2 format\n   * @param supportedKind.extra - Optional extra metadata regarding scheme/network implementation details\n   * @param extensionKeys - Extension keys supported by the facilitator (unused)\n   * @returns Payment requirements ready to be sent to clients\n   */\n  enhancePaymentRequirements(\n    paymentRequirements: PaymentRequirements,\n    supportedKind: {\n      x402Version: number;\n      scheme: string;\n      network: Network;\n      extra?: Record<string, unknown>;\n    },\n    extensionKeys: string[],\n  ): Promise<PaymentRequirements> {\n    // Mark unused parameters to satisfy linter\n    void supportedKind;\n    void extensionKeys;\n    return Promise.resolve(paymentRequirements);\n  }\n\n  /**\n   * Parse Money (string | number) to a decimal number.\n   * Handles formats like \"$1.50\", \"1.50\", 1.50, etc.\n   *\n   * @param money - The money value to parse\n   * @returns Decimal number\n   */\n  private parseMoneyToDecimal(money: string | number): number {\n    if (typeof money === \"number\") {\n      return money;\n    }\n\n    // Remove $ sign and whitespace, then parse\n    const cleanMoney = money.replace(/^\\$/, \"\").trim();\n    const amount = parseFloat(cleanMoney);\n\n    if (isNaN(amount)) {\n      throw new Error(`Invalid money format: ${money}`);\n    }\n\n    return amount;\n  }\n\n  /**\n   * Default money conversion implementation.\n   * Converts decimal amount to USDC on the specified network.\n   *\n   * @param amount - The decimal amount (e.g., 1.50)\n   * @param network - The network to use\n   * @returns The parsed asset amount in USDC\n   */\n  private defaultMoneyConversion(amount: number, network: Network): AssetAmount {\n    // Convert decimal amount to token amount (USDC has 6 decimals)\n    const tokenAmount = this.convertToTokenAmount(amount.toString(), network);\n    const assetInfo = this.getDefaultAsset(network);\n\n    return {\n      amount: tokenAmount,\n      asset: assetInfo.address,\n      extra: {\n        name: assetInfo.name,\n        version: assetInfo.version,\n      },\n    };\n  }\n\n  /**\n   * Convert decimal amount to token units (e.g., 0.10 -> 100000 for 6-decimal USDC)\n   *\n   * @param decimalAmount - The decimal amount to convert\n   * @param network - The network to use\n   * @returns The token amount as a string\n   */\n  private convertToTokenAmount(decimalAmount: string, network: Network): string {\n    const decimals = this.getAssetDecimals(network);\n    const amount = parseFloat(decimalAmount);\n    if (isNaN(amount)) {\n      throw new Error(`Invalid amount: ${decimalAmount}`);\n    }\n    // Convert to smallest unit (e.g., for USDC with 6 decimals: 0.10 * 10^6 = 100000)\n    const [intPart, decPart = \"\"] = String(amount).split(\".\");\n    const paddedDec = decPart.padEnd(decimals, \"0\").slice(0, decimals);\n    const tokenAmount = (intPart + paddedDec).replace(/^0+/, \"\") || \"0\";\n    return tokenAmount;\n  }\n\n  /**\n   * Get the default asset info for a network (typically USDC)\n   *\n   * @param network - The network to get asset info for\n   * @returns The asset information including address, name, and version\n   */\n  private getDefaultAsset(network: Network): { address: string; name: string; version: string } {\n    // Map of network to USDC info including EIP-712 domain parameters\n    const usdcInfo: Record<string, { address: string; name: string; version: string }> = {\n      \"eip155:8453\": {\n        address: \"0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913\",\n        name: \"USD Coin\",\n        version: \"2\",\n      }, // Base mainnet USDC\n      \"eip155:84532\": {\n        address: \"0x036CbD53842c5426634e7929541eC2318f3dCF7e\",\n        name: \"USDC\",\n        version: \"2\",\n      }, // Base Sepolia USDC\n      \"eip155:1\": {\n        address: \"0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48\",\n        name: \"USD Coin\",\n        version: \"2\",\n      }, // Ethereum mainnet USDC\n      \"eip155:11155111\": {\n        address: \"0x1c7D4B196Cb0C7B01d743Fbc6116a902379C7238\",\n        name: \"USDC\",\n        version: \"2\",\n      }, // Sepolia USDC\n    };\n\n    const assetInfo = usdcInfo[network];\n    if (!assetInfo) {\n      throw new Error(`No default asset configured for network ${network}`);\n    }\n\n    return assetInfo;\n  }\n\n  /**\n   * Get asset info for a given symbol on a network\n   *\n   * @param symbol - The asset symbol\n   * @param network - The network to use\n   * @returns The asset information including address, name, and version\n   */\n  private getAssetInfo(\n    symbol: string,\n    network: Network,\n  ): { address: string; name: string; version: string } {\n    const upperSymbol = symbol.toUpperCase();\n\n    // For now, only support USDC\n    if (upperSymbol === \"USDC\" || upperSymbol === \"USD\") {\n      return this.getDefaultAsset(network);\n    }\n\n    // Could extend to support other tokens\n    throw new Error(`Unsupported asset: ${symbol} on network ${network}`);\n  }\n\n  /**\n   * Get the number of decimals for the asset\n   *\n   * @param _ - The network to use (unused)\n   * @returns The number of decimals for the asset\n   */\n  private getAssetDecimals(_: Network): number {\n    // USDC has 6 decimals on all EVM chains\n    return 6;\n  }\n}\n","import { x402ResourceServer } from \"@x402/core/server\";\nimport { Network } from \"@x402/core/types\";\nimport { ExactEvmScheme } from \"./scheme\";\n\n/**\n * Configuration options for registering EVM schemes to an x402ResourceServer\n */\nexport interface EvmResourceServerConfig {\n  /**\n   * Optional specific networks to register\n   * If not provided, registers wildcard support (eip155:*)\n   */\n  networks?: Network[];\n}\n\n/**\n * Registers EVM exact payment schemes to an x402ResourceServer instance.\n *\n * This function registers:\n * - V2: eip155:* wildcard scheme with ExactEvmScheme (or specific networks if provided)\n *\n * @param server - The x402ResourceServer instance to register schemes to\n * @param config - Configuration for EVM resource server registration\n * @returns The server instance for chaining\n *\n * @example\n * ```typescript\n * import { registerExactEvmScheme } from \"@x402/evm/exact/server/register\";\n * import { x402ResourceServer } from \"@x402/core/server\";\n *\n * const server = new x402ResourceServer(facilitatorClient);\n * registerExactEvmScheme(server, {});\n * ```\n */\nexport function registerExactEvmScheme(\n  server: x402ResourceServer,\n  config: EvmResourceServerConfig = {},\n): x402ResourceServer {\n  // Register V2 scheme\n  if (config.networks && config.networks.length > 0) {\n    // Register specific networks\n    config.networks.forEach(network => {\n      server.register(network, new ExactEvmScheme());\n    });\n  } else {\n    // Register wildcard for all EVM chains\n    server.register(\"eip155:*\", new ExactEvmScheme());\n  }\n\n  return server;\n}\n"],"names":[],"mappings":"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"}}]
}
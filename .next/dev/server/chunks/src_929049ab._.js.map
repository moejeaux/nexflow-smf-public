{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/meaux/CascadeProjects/my%20second%20project/CascadeProjects/windsurf-project/nexflow-deploy/src/db/webhook-configs.ts"],"sourcesContent":["// =============================================================================\r\n// WEBHOOK CONFIGURATIONS DATABASE\r\n// =============================================================================\r\n// Database operations for webhook configurations\r\n\r\nimport { executeQuery, executeQueryOne, executeUpdate } from './query-helper';\r\nimport type { WebhookConfig } from '@/lib/webhook-delivery';\r\n\r\nexport interface WebhookConfigRow {\r\n  id: string;\r\n  api_key_id: string;\r\n  endpoint_id: string | null;\r\n  url: string;\r\n  secret: string;\r\n  events: string[]; // JSON array\r\n  enabled: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\n/**\r\n * Convert database row to WebhookConfig\r\n */\r\nfunction rowToConfig(row: WebhookConfigRow): WebhookConfig {\r\n  return {\r\n    id: row.id,\r\n    endpointId: row.endpoint_id || undefined,\r\n    url: row.url,\r\n    secret: row.secret,\r\n    events: row.events as any,\r\n    enabled: row.enabled,\r\n    createdAt: row.created_at,\r\n    updatedAt: row.updated_at,\r\n  };\r\n}\r\n\r\n/**\r\n * Get all webhook configurations\r\n */\r\nexport async function getWebhookConfigs(filters?: {\r\n  apiKeyId?: string;\r\n  endpointId?: string;\r\n  enabled?: boolean;\r\n}): Promise<WebhookConfig[]> {\r\n  // Determine if we're using PostgreSQL (uses $1, $2) or SQLite (uses ?)\r\n  const { getDb } = await import('./client');\r\n  const db = getDb();\r\n  const isPostgres = 'pool' in db || typeof (db as any).pool?.query === 'function';\r\n  \r\n  let query = 'SELECT * FROM webhook_configs WHERE 1=1';\r\n  const params: any[] = [];\r\n  let paramIndex = 1;\r\n\r\n  if (filters?.apiKeyId) {\r\n    if (isPostgres) {\r\n      query += ` AND api_key_id = $${paramIndex++}`;\r\n    } else {\r\n      query += ' AND api_key_id = ?';\r\n    }\r\n    params.push(filters.apiKeyId);\r\n  }\r\n  if (filters?.endpointId) {\r\n    if (isPostgres) {\r\n      query += ` AND endpoint_id = $${paramIndex++}`;\r\n    } else {\r\n      query += ' AND endpoint_id = ?';\r\n    }\r\n    params.push(filters.endpointId);\r\n  }\r\n  if (filters?.enabled !== undefined) {\r\n    if (isPostgres) {\r\n      query += ` AND enabled = $${paramIndex++}`;\r\n    } else {\r\n      query += ' AND enabled = ?';\r\n    }\r\n    params.push(filters.enabled ? (isPostgres ? true : 1) : (isPostgres ? false : 0));\r\n  }\r\n\r\n  query += ' ORDER BY created_at DESC';\r\n\r\n  const rows = await executeQuery<WebhookConfigRow>(query, params);\r\n  return rows.map(row => ({\r\n    ...rowToConfig(row),\r\n    events: typeof row.events === 'string' ? JSON.parse(row.events) : (Array.isArray(row.events) ? row.events : []),\r\n  }));\r\n}\r\n\r\n/**\r\n * Get webhook configuration by ID\r\n */\r\nexport async function getWebhookConfig(id: string): Promise<WebhookConfig | null> {\r\n  const { getDb } = await import('./client');\r\n  const db = getDb();\r\n  const isPostgres = 'pool' in db || typeof (db as any).pool?.query === 'function';\r\n  const query = isPostgres \r\n    ? 'SELECT * FROM webhook_configs WHERE id = $1'\r\n    : 'SELECT * FROM webhook_configs WHERE id = ?';\r\n  \r\n  const row = await executeQueryOne<WebhookConfigRow>(query, [id]);\r\n  if (!row) return null;\r\n  \r\n  return {\r\n    ...rowToConfig(row),\r\n    events: typeof row.events === 'string' ? JSON.parse(row.events) : (Array.isArray(row.events) ? row.events : []),\r\n  };\r\n}\r\n\r\n/**\r\n * Create webhook configuration\r\n */\r\nexport async function createWebhookConfig(config: Omit<WebhookConfig, 'id' | 'createdAt' | 'updatedAt'> & {\r\n  id?: string;\r\n  apiKeyId: string;\r\n}): Promise<WebhookConfig> {\r\n  const id = config.id || `wh_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;\r\n  const now = new Date().toISOString();\r\n\r\n  const { getDb } = await import('./client');\r\n  const db = getDb();\r\n  const isPostgres = 'pool' in db || typeof (db as any).pool?.query === 'function';\r\n  \r\n  const query = isPostgres\r\n    ? `INSERT INTO webhook_configs (id, api_key_id, endpoint_id, url, secret, events, enabled, created_at, updated_at)\r\n       VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)`\r\n    : `INSERT INTO webhook_configs (id, api_key_id, endpoint_id, url, secret, events, enabled, created_at, updated_at)\r\n       VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`;\r\n  \r\n  const params = isPostgres\r\n    ? [\r\n        id,\r\n        config.apiKeyId,\r\n        config.endpointId || null,\r\n        config.url,\r\n        config.secret,\r\n        JSON.stringify(config.events),\r\n        config.enabled !== false,\r\n        now,\r\n        now,\r\n      ]\r\n    : [\r\n        id,\r\n        config.apiKeyId,\r\n        config.endpointId || null,\r\n        config.url,\r\n        config.secret,\r\n        JSON.stringify(config.events),\r\n        config.enabled !== false ? 1 : 0,\r\n        now,\r\n        now,\r\n      ];\r\n\r\n  await executeUpdate(query, params);\r\n\r\n  return {\r\n    id,\r\n    endpointId: config.endpointId,\r\n    url: config.url,\r\n    secret: config.secret,\r\n    events: config.events,\r\n    enabled: config.enabled !== false,\r\n    createdAt: now,\r\n    updatedAt: now,\r\n  };\r\n}\r\n\r\n/**\r\n * Update webhook configuration\r\n */\r\nexport async function updateWebhookConfig(\r\n  id: string,\r\n  updates: Partial<Pick<WebhookConfig, 'url' | 'events' | 'enabled'>>\r\n): Promise<WebhookConfig | null> {\r\n  const { getDb } = await import('./client');\r\n  const db = getDb();\r\n  const isPostgres = 'pool' in db || typeof (db as any).pool?.query === 'function';\r\n  const now = new Date().toISOString();\r\n\r\n  const setClauses: string[] = [];\r\n  const params: any[] = [];\r\n  let paramIndex = 1;\r\n\r\n  setClauses.push(isPostgres ? `updated_at = $${paramIndex++}` : 'updated_at = ?');\r\n  params.push(now);\r\n\r\n  if (updates.url !== undefined) {\r\n    setClauses.push(isPostgres ? `url = $${paramIndex++}` : 'url = ?');\r\n    params.push(updates.url);\r\n  }\r\n  if (updates.events !== undefined) {\r\n    setClauses.push(isPostgres ? `events = $${paramIndex++}` : 'events = ?');\r\n    params.push(JSON.stringify(updates.events));\r\n  }\r\n  if (updates.enabled !== undefined) {\r\n    setClauses.push(isPostgres ? `enabled = $${paramIndex++}` : 'enabled = ?');\r\n    params.push(updates.enabled ? (isPostgres ? true : 1) : (isPostgres ? false : 0));\r\n  }\r\n\r\n  params.push(id);\r\n  const whereClause = isPostgres ? `$${paramIndex}` : '?';\r\n  const query = `UPDATE webhook_configs SET ${setClauses.join(', ')} WHERE id = ${whereClause}`;\r\n\r\n  await executeUpdate(query, params);\r\n\r\n  return getWebhookConfig(id);\r\n}\r\n\r\n/**\r\n * Delete webhook configuration\r\n */\r\nexport async function deleteWebhookConfig(id: string): Promise<boolean> {\r\n  const { getDb } = await import('./client');\r\n  const db = getDb();\r\n  const isPostgres = 'pool' in db || typeof (db as any).pool?.query === 'function';\r\n  const query = isPostgres\r\n    ? 'DELETE FROM webhook_configs WHERE id = $1'\r\n    : 'DELETE FROM webhook_configs WHERE id = ?';\r\n  \r\n  const result = await executeUpdate(query, [id]);\r\n  return (result.rowCount ?? result.changes ?? 0) > 0;\r\n}\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 182, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/meaux/CascadeProjects/my%20second%20project/CascadeProjects/windsurf-project/nexflow-deploy/src/lib/webhook-config-store.ts"],"sourcesContent":["// =============================================================================\r\n// Webhook Config Store\r\n// =============================================================================\r\n// Database-backed store for webhook configurations\r\n// Migrated from in-memory to database for production readiness\r\n\r\nimport type { WebhookConfig } from './webhook-delivery';\r\nimport * as webhookDb from '@/db/webhook-configs';\r\n\r\n/**\r\n * Get all webhook configurations\r\n */\r\nexport async function getWebhookConfigs(filters?: {\r\n  apiKeyId?: string;\r\n  endpointId?: string;\r\n  enabled?: boolean;\r\n}): Promise<WebhookConfig[]> {\r\n  return webhookDb.getWebhookConfigs(filters);\r\n}\r\n\r\n/**\r\n * Get webhook configuration by ID\r\n */\r\nexport async function getWebhookConfig(id: string): Promise<WebhookConfig | undefined> {\r\n  const config = await webhookDb.getWebhookConfig(id);\r\n  return config || undefined;\r\n}\r\n\r\n/**\r\n * Create or update webhook configuration\r\n */\r\nexport async function setWebhookConfig(config: WebhookConfig & { apiKeyId: string }): Promise<WebhookConfig> {\r\n  const existing = await webhookDb.getWebhookConfig(config.id);\r\n  if (existing) {\r\n    const updated = await webhookDb.updateWebhookConfig(config.id, {\r\n      url: config.url,\r\n      events: config.events,\r\n      enabled: config.enabled,\r\n    });\r\n    return updated || config;\r\n  } else {\r\n    return webhookDb.createWebhookConfig(config);\r\n  }\r\n}\r\n\r\n/**\r\n * Delete webhook configuration\r\n */\r\nexport async function deleteWebhookConfig(id: string): Promise<boolean> {\r\n  return webhookDb.deleteWebhookConfig(id);\r\n}\r\n\r\n"],"names":[],"mappings":"AAAA,gFAAgF;AAChF,uBAAuB;AACvB,gFAAgF;AAChF,mDAAmD;AACnD,+DAA+D;;;;;;;;;;;AAG/D;;;;;;AAKO,eAAe,kBAAkB,OAIvC;IACC,OAAO,sJAA2B,CAAC;AACrC;AAKO,eAAe,iBAAiB,EAAU;IAC/C,MAAM,SAAS,MAAM,qJAA0B,CAAC;IAChD,OAAO,UAAU;AACnB;AAKO,eAAe,iBAAiB,MAA4C;IACjF,MAAM,WAAW,MAAM,qJAA0B,CAAC,OAAO,EAAE;IAC3D,IAAI,UAAU;QACZ,MAAM,UAAU,MAAM,wJAA6B,CAAC,OAAO,EAAE,EAAE;YAC7D,KAAK,OAAO,GAAG;YACf,QAAQ,OAAO,MAAM;YACrB,SAAS,OAAO,OAAO;QACzB;QACA,OAAO,WAAW;IACpB,OAAO;QACL,OAAO,wJAA6B,CAAC;IACvC;AACF;AAKO,eAAe,oBAAoB,EAAU;IAClD,OAAO,wJAA6B,CAAC;AACvC"}}]
}
{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 130, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/meaux/CascadeProjects/my%20second%20project/CascadeProjects/windsurf-project/nexflow-deploy/src/lib/sentry.ts"],"sourcesContent":["// src/lib/sentry.ts\r\n\r\n// Temporary no-op Sentry shim to avoid module errors during dev\r\nconst Sentry = null as any;\r\n\r\nexport const sentry = {\r\n  captureException: (..._args: any[]) => {},\r\n  captureMessage: (..._args: any[]) => {},\r\n  withScope: (fn: (scope: any) => void) => fn({}),\r\n};\r\n\r\n// No-op functions for compatibility\r\nexport function initSentry() {}\r\nexport function setSentryUser(_userId?: string, _apiKeyId?: string) {}\r\nexport function setSentryContext(_context: any) {}\r\nexport function captureException(_error: Error, _context?: any) {}\r\nexport function captureMessage(_message: string, _level: any = 'info', _context?: any) {}\r\n"],"names":[],"mappings":"AAAA,oBAAoB;AAEpB,gEAAgE;;;;;;;;;;;;;;;AAChE,MAAM,SAAS;AAER,MAAM,SAAS;IACpB,kBAAkB,CAAC,GAAG,SAAkB;IACxC,gBAAgB,CAAC,GAAG,SAAkB;IACtC,WAAW,CAAC,KAA6B,GAAG,CAAC;AAC/C;AAGO,SAAS,cAAc;AACvB,SAAS,cAAc,OAAgB,EAAE,SAAkB,GAAG;AAC9D,SAAS,iBAAiB,QAAa,GAAG;AAC1C,SAAS,iBAAiB,MAAa,EAAE,QAAc,GAAG;AAC1D,SAAS,eAAe,QAAgB,EAAE,SAAc,MAAM,EAAE,QAAc,GAAG"}},
    {"offset": {"line": 161, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/meaux/CascadeProjects/my%20second%20project/CascadeProjects/windsurf-project/nexflow-deploy/src/lib/logger.ts"],"sourcesContent":["// =============================================================================\r\n// Structured Logging\r\n// =============================================================================\r\n// Uses Pino for fast, structured logging\r\n// Supports request ID tracking and different log levels\r\n// All logs include standard fields: timestamp, level, message, requestId, etc.\r\n\r\nimport pino from 'pino';\r\n\r\n// Determine log level from environment\r\nconst logLevel = process.env.LOG_LEVEL || (process.env.NODE_ENV === 'production' ? 'info' : 'debug');\r\n\r\n// Create logger instance with structured output\r\n// In Next.js dev mode, disable pino-pretty transport to avoid worker thread issues\r\n// Use simple JSON output instead (can be prettified by other tools)\r\nconst isNextDev = process.env.NODE_ENV === 'development' && process.env.NEXT_RUNTIME;\r\nconst usePrettyTransport = process.env.NODE_ENV !== 'production' && !isNextDev;\r\n\r\nconst logger = pino({\r\n  level: logLevel,\r\n  transport: usePrettyTransport ? {\r\n    target: 'pino-pretty',\r\n    options: {\r\n      colorize: true,\r\n      translateTime: 'SYS:standard',\r\n      ignore: 'pid,hostname',\r\n    },\r\n  } : undefined,\r\n  formatters: {\r\n    level: (label) => {\r\n      return { level: label.toUpperCase() };\r\n    },\r\n  },\r\n  base: {\r\n    env: process.env.NODE_ENV || 'development',\r\n    service: 'nexflow-api',\r\n  },\r\n  // Ensure timestamps are included\r\n  timestamp: pino.stdTimeFunctions.isoTime,\r\n});\r\n\r\nexport type LogLevel = 'trace' | 'debug' | 'info' | 'warn' | 'error' | 'fatal';\r\n\r\n/**\r\n * Standard log context fields\r\n */\r\nexport interface LogContext {\r\n  // Request tracking\r\n  requestId?: string;\r\n  apiKeyId?: string;\r\n  endpoint?: string;\r\n  method?: string;\r\n  statusCode?: number;\r\n  durationMs?: number;\r\n  ip?: string;\r\n  \r\n  // Error context\r\n  errorCode?: string;\r\n  error?: Error | any;\r\n  stack?: string;\r\n  \r\n  // CDP/x402 context\r\n  cdpStatus?: string;\r\n  cdpErrorId?: string;\r\n  paymentIntentId?: string;\r\n  x402HeaderId?: string;\r\n  \r\n  // Rate limiting\r\n  rateLimitKey?: string;\r\n  rateLimitRemaining?: number;\r\n  \r\n  // Additional context\r\n  [key: string]: any;\r\n}\r\n\r\n/**\r\n * Create a child logger with additional context\r\n * Useful for request-scoped logging with request IDs\r\n */\r\nexport function createLogger(context?: LogContext | Record<string, any>) {\r\n  return context ? logger.child(context) : logger;\r\n}\r\n\r\n/**\r\n * Get the default logger instance\r\n */\r\nexport function getLogger() {\r\n  return logger;\r\n}\r\n\r\n/**\r\n * Sanitize sensitive data from log context\r\n * Removes API keys, tokens, payment headers, and PII\r\n */\r\nfunction sanitizeContext(context: LogContext): LogContext {\r\n  const sanitized = { ...context };\r\n  \r\n  // Remove sensitive fields\r\n  const sensitiveKeys = [\r\n    'apiKey', 'token', 'authorization', 'x-payment', 'paymentHeader',\r\n    'cardNumber', 'cvv', 'ssn', 'password', 'secret',\r\n  ];\r\n  \r\n  sensitiveKeys.forEach(key => {\r\n    if (key in sanitized) {\r\n      delete sanitized[key];\r\n    }\r\n  });\r\n  \r\n  // Truncate long strings that might contain sensitive data\r\n  Object.keys(sanitized).forEach(key => {\r\n    const value = sanitized[key];\r\n    if (typeof value === 'string' && value.length > 200) {\r\n      sanitized[key] = value.substring(0, 200) + '... [truncated]';\r\n    }\r\n  });\r\n  \r\n  return sanitized;\r\n}\r\n\r\n/**\r\n * Log levels with structured context\r\n */\r\nexport const log = {\r\n  trace: (msg: string, context?: LogContext, ...args: any[]) => {\r\n    logger.trace(sanitizeContext(context || {}), msg, ...args);\r\n  },\r\n  debug: (msg: string, context?: LogContext, ...args: any[]) => {\r\n    logger.debug(sanitizeContext(context || {}), msg, ...args);\r\n  },\r\n  info: (msg: string, context?: LogContext, ...args: any[]) => {\r\n    logger.info(sanitizeContext(context || {}), msg, ...args);\r\n  },\r\n  warn: (msg: string, context?: LogContext, ...args: any[]) => {\r\n    logger.warn(sanitizeContext(context || {}), msg, ...args);\r\n  },\r\n  error: (msg: string, context?: LogContext | Error, ...args: any[]) => {\r\n    let logContext: LogContext = {};\r\n    let errorObj: Error | undefined;\r\n    \r\n    if (context instanceof Error) {\r\n      errorObj = context;\r\n      logContext = {\r\n        error: context,\r\n        errorCode: (context as any).code || 'UNKNOWN_ERROR',\r\n        stack: context.stack,\r\n      };\r\n    } else if (context && typeof context === 'object') {\r\n      logContext = context as LogContext;\r\n      if (logContext.error instanceof Error) {\r\n        errorObj = logContext.error;\r\n        logContext.stack = logContext.error.stack;\r\n      }\r\n    }\r\n    \r\n    const sanitizedContext = sanitizeContext(logContext);\r\n    logger.error(sanitizedContext, msg, ...args);\r\n    \r\n    // Automatically capture to Sentry if error object exists\r\n    if (errorObj) {\r\n      try {\r\n        const { captureException } = require('./sentry');\r\n        captureException(errorObj, {\r\n          requestId: logContext.requestId,\r\n          apiKeyId: logContext.apiKeyId,\r\n          endpoint: logContext.endpoint,\r\n          endpointId: (logContext as any).endpointId,\r\n          method: logContext.method,\r\n          statusCode: logContext.statusCode,\r\n          ip: logContext.ip,\r\n          userAgent: (logContext as any).userAgent,\r\n          tags: {\r\n            errorCode: logContext.errorCode || 'UNKNOWN_ERROR',\r\n            component: (logContext as any).component || 'unknown',\r\n          },\r\n          extra: {\r\n            ...sanitizedContext,\r\n          },\r\n        });\r\n      } catch (sentryError) {\r\n        // Silently fail if Sentry not available\r\n      }\r\n    }\r\n  },\r\n  fatal: (msg: string, context?: LogContext | Error, ...args: any[]) => {\r\n    let logContext: LogContext = {};\r\n    let errorObj: Error | undefined;\r\n    \r\n    if (context instanceof Error) {\r\n      errorObj = context;\r\n      logContext = {\r\n        error: context,\r\n        errorCode: (context as any).code || 'UNKNOWN_ERROR',\r\n        stack: context.stack,\r\n      };\r\n    } else if (context && typeof context === 'object') {\r\n      logContext = context as LogContext;\r\n      if (logContext.error instanceof Error) {\r\n        errorObj = logContext.error;\r\n        logContext.stack = logContext.error.stack;\r\n      }\r\n    }\r\n    \r\n    const sanitizedContext = sanitizeContext(logContext);\r\n    logger.fatal(sanitizedContext, msg, ...args);\r\n    \r\n    // Automatically capture to Sentry for fatal errors\r\n    if (errorObj) {\r\n      try {\r\n        const { captureException } = require('./sentry');\r\n        captureException(errorObj, {\r\n          requestId: logContext.requestId,\r\n          apiKeyId: logContext.apiKeyId,\r\n          endpoint: logContext.endpoint,\r\n          endpointId: (logContext as any).endpointId,\r\n          method: logContext.method,\r\n          statusCode: logContext.statusCode,\r\n          ip: logContext.ip,\r\n          userAgent: (logContext as any).userAgent,\r\n          tags: {\r\n            errorCode: logContext.errorCode || 'FATAL_ERROR',\r\n            component: (logContext as any).component || 'unknown',\r\n            severity: 'fatal',\r\n          },\r\n          extra: {\r\n            ...sanitizedContext,\r\n          },\r\n        });\r\n      } catch (sentryError) {\r\n        // Silently fail if Sentry not available\r\n      }\r\n    }\r\n  },\r\n};\r\n\r\nexport default logger;\r\n\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 353, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/meaux/CascadeProjects/my%20second%20project/CascadeProjects/windsurf-project/nexflow-deploy/src/app/api/cron/house-x402-job/route.ts"],"sourcesContent":["// =============================================================================\r\n// VERCEL CRON ENDPOINT: House x402 Traffic Job\r\n// =============================================================================\r\n// GET /api/cron/house-x402-job\r\n// Generates steady, honest traffic through SMF by calling a real x402 endpoint\r\n// Called by Vercel Cron every 10 minutes (schedule: \"*/10 * * * *\")\r\n// ~144 calls/day, well under 200 calls/day limit\r\n\r\nimport { NextResponse } from 'next/server';\r\nimport { createWalletClient, http, type Address } from 'viem';\r\nimport { privateKeyToAccount } from 'viem/accounts';\r\nimport { base } from 'viem/chains';\r\nimport { createLogger } from '@/lib/logger';\r\n\r\nconst logger = createLogger({ component: 'HouseX402Job' });\r\n\r\nexport const dynamic = 'force-dynamic'; // Ensure it runs on every invoke\r\nexport const maxDuration = 30; // 30 second timeout\r\n\r\n// =============================================================================\r\n// CONFIGURATION\r\n// =============================================================================\r\n\r\n/**\r\n * House Job Configuration\r\n * Target: URL Enrich endpoint - x402-protected at 0.01 USDC on Base\r\n */\r\nconst HOUSE_JOB_CONFIG = {\r\n  description: 'House traffic SMF test job',\r\n  targetPriceUsdc: '0.01',\r\n  priceAmount: '10000', // 0.01 USDC in 6-decimal format\r\n  network: 'base',\r\n  chainId: 8453,\r\n  asset: 'USDC',\r\n  payload: {\r\n    url: 'https://nexflowapp.app',\r\n  },\r\n};\r\n\r\n// =============================================================================\r\n// EIP-712 SIGNING\r\n// =============================================================================\r\n\r\nconst EIP712_DOMAIN = {\r\n  name: 'x402',\r\n  version: '1',\r\n  chainId: HOUSE_JOB_CONFIG.chainId,\r\n  verifyingContract: '0x0000000000000000000000000000000000000000' as Address,\r\n};\r\n\r\nconst EIP712_TYPES = {\r\n  PaymentAuthorization: [\r\n    { name: 'from', type: 'address' },\r\n    { name: 'to', type: 'address' },\r\n    { name: 'value', type: 'uint256' },\r\n    { name: 'nonce', type: 'bytes32' },\r\n    { name: 'validAfter', type: 'uint256' },\r\n    { name: 'validBefore', type: 'uint256' },\r\n  ],\r\n};\r\n\r\nfunction normalizePrivateKey(key: string): string {\r\n  let normalized = key.trim().replace(/^[\"']|[\"']$/g, '').replace(/\\s+/g, '');\r\n  if (!normalized.startsWith('0x')) {\r\n    normalized = '0x' + normalized;\r\n  }\r\n  if (normalized.length !== 66) {\r\n    throw new Error(`Invalid private key length: ${normalized.length - 2} (expected 64 hex chars)`);\r\n  }\r\n  return normalized;\r\n}\r\n\r\nasync function createPaymentHeader(\r\n  privateKey: string,\r\n  recipient: string,\r\n  amount: string\r\n): Promise<string> {\r\n  const normalizedKey = normalizePrivateKey(privateKey);\r\n  const account = privateKeyToAccount(normalizedKey as `0x${string}`);\r\n  \r\n  const client = createWalletClient({\r\n    account,\r\n    chain: base,\r\n    transport: http('https://mainnet.base.org'),\r\n  });\r\n\r\n  const nonce = `0x${Array.from({ length: 32 }, () => \r\n    Math.floor(Math.random() * 256).toString(16).padStart(2, '0')\r\n  ).join('')}` as `0x${string}`;\r\n  \r\n  const now = BigInt(Math.floor(Date.now() / 1000));\r\n  const validAfter = now - BigInt(5);\r\n  const validBefore = now + BigInt(3600);\r\n\r\n  const authorization = {\r\n    from: account.address,\r\n    to: recipient as Address,\r\n    value: BigInt(amount),\r\n    nonce,\r\n    validAfter,\r\n    validBefore,\r\n  };\r\n\r\n  const signature = await client.signTypedData({\r\n    domain: EIP712_DOMAIN,\r\n    types: EIP712_TYPES,\r\n    primaryType: 'PaymentAuthorization',\r\n    message: authorization,\r\n  });\r\n\r\n  const paymentPayload = {\r\n    scheme: 'exact',\r\n    network: HOUSE_JOB_CONFIG.network,\r\n    chainId: HOUSE_JOB_CONFIG.chainId,\r\n    authorization: {\r\n      from: authorization.from,\r\n      to: authorization.to,\r\n      value: authorization.value.toString(),\r\n      nonce: authorization.nonce,\r\n      validAfter: authorization.validAfter.toString(),\r\n      validBefore: authorization.validBefore.toString(),\r\n    },\r\n    signature,\r\n  };\r\n\r\n  return `x402 ${Buffer.from(JSON.stringify(paymentPayload)).toString('base64')}`;\r\n}\r\n\r\n// =============================================================================\r\n// CRON HANDLER\r\n// =============================================================================\r\n\r\nexport async function GET(request: Request) {\r\n  const startTime = Date.now();\r\n  const traceId = `house-job-${Date.now()}-${Math.random().toString(36).substring(2, 8)}`;\r\n\r\n  // Environment gating - only run in production\r\n  if (process.env.NODE_ENV !== 'production') {\r\n    logger.info({ traceId }, 'Skipping house x402 job cron - not in production');\r\n    return NextResponse.json({\r\n      ok: false,\r\n      skipped: true,\r\n      reason: 'non-production',\r\n      environment: process.env.NODE_ENV,\r\n    });\r\n  }\r\n\r\n  // Verify Vercel Cron request (optional but recommended)\r\n  const authHeader = request.headers.get('authorization');\r\n  const isVercelCron = authHeader === `Bearer ${process.env.CRON_SECRET}`;\r\n  \r\n  if (process.env.CRON_SECRET && !isVercelCron) {\r\n    logger.warn({ traceId }, 'Unauthorized cron request - missing or invalid CRON_SECRET');\r\n    return NextResponse.json(\r\n      { ok: false, error: 'Unauthorized' },\r\n      { status: 401 }\r\n    );\r\n  }\r\n\r\n  // Validate required environment variables\r\n  const privateKey = process.env.PRIVATE_KEY;\r\n  const recipientAddress = process.env.X402_RECIPIENT_ADDRESS;\r\n  const appUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://www.nexflowapp.app';\r\n  const endpointUrl = `${appUrl}/api/v1/metered/url-enrich`;\r\n\r\n  if (!privateKey) {\r\n    logger.error({ traceId }, 'House x402 job failed: PRIVATE_KEY not set');\r\n    return NextResponse.json({\r\n      ok: false,\r\n      error: 'PRIVATE_KEY environment variable is required',\r\n      errorCode: 'MISSING_PRIVATE_KEY',\r\n      traceId,\r\n      timestamp: new Date().toISOString(),\r\n    }, { status: 500 });\r\n  }\r\n\r\n  if (!recipientAddress) {\r\n    logger.error({ traceId }, 'House x402 job failed: X402_RECIPIENT_ADDRESS not set');\r\n    return NextResponse.json({\r\n      ok: false,\r\n      error: 'X402_RECIPIENT_ADDRESS environment variable is required',\r\n      errorCode: 'MISSING_RECIPIENT_ADDRESS',\r\n      traceId,\r\n      timestamp: new Date().toISOString(),\r\n    }, { status: 500 });\r\n  }\r\n\r\n  logger.info({\r\n    traceId,\r\n    endpoint: endpointUrl,\r\n    amount: HOUSE_JOB_CONFIG.targetPriceUsdc,\r\n  }, 'Starting house x402 job');\r\n\r\n  try {\r\n    // Step 1: Create payment header\r\n    logger.debug({ traceId }, 'Creating payment authorization');\r\n    const paymentHeader = await createPaymentHeader(\r\n      privateKey,\r\n      recipientAddress,\r\n      HOUSE_JOB_CONFIG.priceAmount\r\n    );\r\n\r\n    // Step 2: Call the endpoint with payment\r\n    logger.debug({ traceId }, 'Calling endpoint with payment');\r\n    const response = await fetch(endpointUrl, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'x-payment': paymentHeader,\r\n        'x-trace-id': traceId,\r\n        'User-Agent': 'NexFlow-HouseJob/1.0',\r\n      },\r\n      body: JSON.stringify(HOUSE_JOB_CONFIG.payload),\r\n    });\r\n\r\n    const latencyMs = Date.now() - startTime;\r\n\r\n    // Parse response\r\n    let responseBody: Record<string, unknown> = {};\r\n    const contentType = response.headers.get('content-type') || '';\r\n    if (contentType.includes('application/json')) {\r\n      responseBody = await response.json();\r\n    }\r\n\r\n    // Extract x402 headers\r\n    const x402Verified = response.headers.get('X-x402-Verified');\r\n    const x402TxHash = response.headers.get('X-x402-TxHash');\r\n    const x402Facilitator = response.headers.get('X-x402-Facilitator');\r\n\r\n    if (response.ok) {\r\n      logger.info({\r\n        traceId,\r\n        latencyMs,\r\n        facilitator: x402Facilitator,\r\n        txHash: x402TxHash,\r\n        verified: x402Verified,\r\n      }, 'House x402 job completed successfully');\r\n\r\n      return NextResponse.json({\r\n        ok: true,\r\n        job: 'house-x402-job',\r\n        endpoint: endpointUrl,\r\n        status: 'success',\r\n        latencyMs,\r\n        paymentAmountUsdc: HOUSE_JOB_CONFIG.targetPriceUsdc,\r\n        facilitatorId: x402Facilitator || null,\r\n        transactionHash: x402TxHash || null,\r\n        traceId,\r\n        timestamp: new Date().toISOString(),\r\n      });\r\n    } else {\r\n      const errorCode = (responseBody.code as string) || `HTTP_${response.status}`;\r\n      const errorMessage = (responseBody.error as string) || (responseBody.message as string) || `HTTP ${response.status}`;\r\n\r\n      logger.error({\r\n        traceId,\r\n        latencyMs,\r\n        statusCode: response.status,\r\n        errorCode,\r\n        errorMessage,\r\n        responseBody,\r\n      }, 'House x402 job failed - endpoint returned error');\r\n\r\n      return NextResponse.json({\r\n        ok: false,\r\n        job: 'house-x402-job',\r\n        endpoint: endpointUrl,\r\n        status: 'error',\r\n        latencyMs,\r\n        error: errorMessage,\r\n        errorCode,\r\n        httpStatus: response.status,\r\n        traceId,\r\n        timestamp: new Date().toISOString(),\r\n      }, { status: 500 });\r\n    }\r\n  } catch (error) {\r\n    const latencyMs = Date.now() - startTime;\r\n    const errorMessage = error instanceof Error ? error.message : 'Unknown error';\r\n    const errorStack = error instanceof Error ? error.stack : undefined;\r\n\r\n    logger.error({\r\n      traceId,\r\n      latencyMs,\r\n      error: errorMessage,\r\n      stack: errorStack,\r\n    }, 'House x402 job failed with exception');\r\n\r\n    return NextResponse.json({\r\n      ok: false,\r\n      job: 'house-x402-job',\r\n      endpoint: endpointUrl,\r\n      status: 'error',\r\n      latencyMs,\r\n      error: errorMessage,\r\n      errorCode: 'EXCEPTION',\r\n      traceId,\r\n      timestamp: new Date().toISOString(),\r\n    }, { status: 500 });\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":"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"}}]
}